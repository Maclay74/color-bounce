;(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    } else if (typeof module === 'object' && module.exports) {
        try {
            var JSDOM = require("jsdom").JSDOM;
            var DOM = new JSDOM();
            var window = DOM.window;
            var navigator = window.navigator;
            module.exports = factory(window, navigator);
        } catch (error) {
            module.exports = factory();
        }
    } else {
        root.pc = factory(root, root.navigator);
    }
}(this, function (_window, _navigator) {
    window = _window || window;
    navigator = _navigator || navigator;

    /*
   PlayCanvas Engine v1.2.0-dev revision 8ffd9d4
   http://playcanvas.com
   Copyright 2011-2018 PlayCanvas Ltd. All rights reserved.
  */
    var _typeLookup=function(){for(var e={},a="Array Object Function Date RegExp Float32Array".split(" "),b=0;b<a.length;b++)e["[object "+a[b]+"]"]=a[b].toLowerCase();return e}(),pc={version:"1.2.0-dev",revision:"8ffd9d4",config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(e){var a,b=[],c=e.length;for(a=0;a<c;++a)b.push(e[a]);return b},type:function(e){if(null===
        e)return"null";var a=typeof e;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(e)]},extend:function(e,a){var b,c;for(b in a)c=a[b],"object"==pc.type(c)?e[b]=pc.extend({},c):"array"==pc.type(c)?e[b]=pc.extend([],c):e[b]=c;return e},isDefined:function(e){return void 0!==e}};"undefined"!==typeof exports&&(exports.pc=pc);(function(){for(var e=0,a=["ms","moz","webkit","o"],b=0;b<a.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[b]+"CancelAnimationFrame"]||window[a[b]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,b){var f=(new Date).getTime(),g=Math.max(0,16-(f-e)),k=window.setTimeout(function(){a(f+g)},g);e=f+g;return k});window.cancelAnimationFrame||(window.cancelAnimationFrame=
        function(a){clearTimeout(a)})})();String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var a=0,b=e.length;a<b;a++)if(this[a]!==e[a])return!1;return!0}});String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,configurable:!0,writable:!0,value:function(e){for(var a=0,b=e.length;a<b;a++)if(this[a+this.length-b]!==e[a])return!1;return!0}});
    String.prototype.includes||(String.prototype.includes=function(e,a){"number"!==typeof a&&(a=0);return a+e.length>this.length?!1:-1!==this.indexOf(e,a)});(function(){if("undefined"!==typeof document){var e=function(a){var c=document.createEvent("CustomEvent");c.initCustomEvent("fullscreenchange",!0,!1,null);a.target.dispatchEvent(c)},a=function(a){var c=document.createEvent("CustomEvent");c.initCustomEvent("fullscreenerror",!0,!1,null);a.target.dispatchEvent(c)};document.addEventListener("webkitfullscreenchange",e,!1);document.addEventListener("mozfullscreenchange",e,!1);document.addEventListener("MSFullscreenChange",e,!1);document.addEventListener("webkitfullscreenerror",
        a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen;document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.hasOwnProperty("fullscreenElement")||
    Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.hasOwnProperty("fullscreenEnabled")||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();pc.extend(pc,function(){var e=function(a,b,c,d){this.buffer=new ArrayBuffer(16);this.data=new Float32Array(this.buffer,0,4);this.data3=new Float32Array(this.buffer,0,3);var f=a&&a.length;3===f||4===f?(this.data[0]=a[0],this.data[1]=a[1],this.data[2]=a[2],this.data[3]=void 0!==a[3]?a[3]:1):(this.data[0]=a||0,this.data[1]=b||0,this.data[2]=c||0,this.data[3]=void 0!==d?d:1)};e.prototype={clone:function(){return new pc.Color(this.data[0],this.data[1],this.data[2],this.data[3])},copy:function(a){var b=
        this.data;a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,c,d){var f=this.data;f[0]=a;f[1]=b;f[2]=c;f[3]=void 0===d?1:d;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"),16);7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);
        !0===a&&(a=Math.round(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(e.prototype,"r",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=
        a}});return{Color:e}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0;return("x"==e?a:a&3|8).toString(16)})}}}();pc.extend(pc,function(){var e=function(){this._isRunning=!1;this._b=this._a=0};e.prototype={start:function(){this._isRunning=!0;this._a=pc.now()},stop:function(){this._isRunning=!1;this._b=pc.now()},getMilliseconds:function(){return this._b-this._a}};return{Timer:e,now:window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now}}());pc.extend(pc,function(){return{hashCode:function(e){var a=0;if(0===e.length)return a;for(var b=0;b<e.length;b++)var c=e.charCodeAt(b),a=(a<<5)-a+c,a=a&a;return a}}}());pc.extend(pc,function(){return{createURI:function(e){var a="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");e.scheme&&(a+=e.scheme+":");e.authority&&(a+="//"+e.authority);e.host&&(a+=e.host);e.path&&(a+=e.path);e.hostpath&&(a+=e.hostpath);e.query&&(a+="?"+e.query);
        e.fragment&&(a+="#"+e.fragment);return a},URI:function(e){e=e.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/);this.scheme=e[2];this.authority=e[4];this.path=e[5];this.query=e[7];this.fragment=e[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,c={};this.query&&(a=decodeURIComponent(this.query).split("&"),
        a.forEach(function(a,f,g){b=a.split("=");c[b[0]]=b[1]},this));return c};this.setQuery=function(a){var b="",c;for(c in a)a.hasOwnProperty(c)&&(""!==b&&(b+="&"),b+=encodeURIComponent(c)+"="+encodeURIComponent(a[c]));this.query=b}}}}());pc.extend(pc,function(){return{log:{write:function(e){console.log(e)},open:function(){pc.log.write("Powered by PlayCanvas "+pc.version+" "+pc.revision)},info:function(e){console.info("INFO:    "+e)},debug:function(e){console.debug("DEBUG:   "+e)},error:function(e){console.error("ERROR:   "+e)},warning:function(e){console.warn("WARNING: "+e)},alert:function(e){pc.log.write("ALERT:   "+e);alert(e)},assert:function(e,a){!1===e&&pc.log.write("ASSERT:  "+a)}}}}());
    var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;pc.extend(pc,function(){return{inherits:function(e,a){var b=function(){},c=function(b,c,g,k,l,m,n,h){a.call(this,b,c,g,k,l,m,n,h);e.call(this,b,c,g,k,l,m,n,h)};c._super=a.prototype;b.prototype=a.prototype;c.prototype=new b;return c}}}());pc.path=function(){return{delimiter:"/",join:function(){var e,a=arguments.length,b=arguments[0];for(e=0;e<a-1;++e){var c=arguments[e],d=arguments[e+1];if(!pc.isDefined(c)||!pc.isDefined(d))throw Error("undefined argument to pc.path.join");b=d[0]===pc.path.delimiter?d:c&&d&&c[c.length-1]!==pc.path.delimiter&&d[0]!==pc.path.delimiter?b+(pc.path.delimiter+d):b+d}return b},split:function(e){e=e.split(pc.path.delimiter);var a=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(pc.path.delimiter),
        a]},getBasename:function(e){return pc.path.split(e)[1]},getDirectory:function(e){e=e.split(pc.path.delimiter);return e.slice(0,e.length-1).join(pc.path.delimiter)},getExtension:function(e){var a=e.split("?")[0].split(".").pop();return a!==e?"."+a:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var a=".",b=e.split("/"),c=0;if(1<b.length)for(!1===pc.path.isRelativePath(e)&&(a=""),c=0;c<b.length-1;++c)a+="/"+b[c];return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(e){var a=0,b,c=pc.makeArray(arguments);c.shift();for(a=0;a<c.length;a++)b=new RegExp("\\{"+a+"\\}","gi"),e=e.replace(b,c[a]);return e},startsWith:function(e,a){console.warn("WARNING: startsWith: Function is deprecated. Use String.startsWith instead.");return e.startsWith(a)},endsWith:function(e,a){console.warn("WARNING: endsWith: Function is deprecated. Use String.endsWith instead.");
        return e.endsWith(a)},toBool:function(e,a){if("true"===e)return!0;if(a){if("false"===e)return!1;throw Error("Not a boolean string");}return!1}}}();pc.debug=function(){var e=null,a=null,b=null,c=null;return{display:function(d){e||(e=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),c=document.createElement("td"),e.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",e.style.top="0px",e.style.left="0px",e.style.border="thin solid #cccccc",document.body.appendChild(e));e.innerHTML="";for(var f in d){var g=a.cloneNode(),k=b.cloneNode(),l=c.cloneNode();k.textContent=f;l.textContent=
        d[f];g.appendChild(k);g.appendChild(l);e.appendChild(g)}}}}();pc.events={attach:function(e){var a=pc.events;e.on=a.on;e.off=a.off;e.fire=a.fire;e.once=a.once;e.hasEvent=a.hasEvent;e._callbackActive={};return e},on:function(e,a,b){if(!e||"string"!==typeof e||!a)return this;this._callbacks||(this._callbacks={});this._callbacks[e]||(this._callbacks[e]=[]);this._callbackActive||(this._callbackActive={});this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());this._callbacks[e].push({callback:a,
        scope:b||this});return this},off:function(e,a,b){if(!this._callbacks)return this;if(this._callbackActive)if(e)this._callbackActive[e]&&this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice());else for(var c in this._callbackActive)this._callbacks[c]&&this._callbacks[c]===this._callbackActive[c]&&(this._callbackActive[c]=this._callbackActive[c].slice());if(e)if(a){e=this._callbacks[e];if(!e)return this;for(c=e.length;c--;)e[c].callback===a&&(b&&e[c].scope!==
        b||e.splice(c,1))}else this._callbacks[e]&&delete this._callbacks[e];else this._callbacks=null;return this},fire:function(e,a,b,c,d,f,g,k,l){if(!e||!this._callbacks||!this._callbacks[e])return this;var m;this._callbackActive||(this._callbackActive={});this._callbackActive[e]?(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),m=this._callbacks[e].slice()):this._callbackActive[e]=this._callbacks[e];for(var n=0;(m||this._callbackActive[e])&&n<(m||
        this._callbackActive[e]).length;n++){var h=(m||this._callbackActive[e])[n];h.callback.call(h.scope,a,b,c,d,f,g,k,l);h.callback.once&&(h=this._callbacks[e].indexOf(h),-1!==h&&(this._callbackActive[e]===this._callbacks[e]&&(this._callbackActive[e]=this._callbackActive[e].slice()),this._callbacks[e].splice(h,1)))}m||(this._callbackActive[e]=null);return this},once:function(e,a,b){a.once=!0;this.on(e,a,b);return this},hasEvent:function(e){return this._callbacks&&this._callbacks[e]&&0!==this._callbacks[e].length||
        !1}};pc.extend(pc,function(){var e=function(a){this._index={};this._key=a||null};e.prototype={addItem:function(a){for(var c=a.tags._list,d=0;d<c.length;d++)this.add(c[d],a)},removeItem:function(a){for(var c=a.tags._list,d=0;d<c.length;d++)this.remove(c[d],a)},add:function(a,c){this._index[a]&&-1!==this._index[a].list.indexOf(c)||(this._index[a]||(this._index[a]={list:[]},this._key&&(this._index[a].keys={})),this._index[a].list.push(c),this._key&&(this._index[a].keys[c[this._key]]=c))},remove:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  c){if(this._index[a]&&(!this._key||this._index[a].keys[c[this._key]])){var d=this._index[a].indexOf(c);-1!==d&&(this._index[a].list.splice(d,1),this._key&&delete this._index[a].keys[c[this._key]],0===this._index[a].list.length&&delete this._index[a])}},find:function(a){var c=this,d={},f=[],g,k,l,m,e,h=function(a,b){return c._index[a].list.length-c._index[b].list.length};for(g=0;g<a.length;g++){m=a[g];if(m instanceof Array){if(0===m.length)continue;if(1===m.length)m=m[0];else{l=!1;for(k=0;k<m.length;k++)if(!this._index[m[k]]){l=
        !0;break}if(l)continue;m=m.slice(0).sort(h);e=m.slice(1);1===e.length&&(e=e[0]);for(k=0;k<this._index[m[0]].list.length;k++)l=this._index[m[0]].list[k],(this._key?!d[l[this._key]]:-1===f.indexOf(l))&&l.tags.has(e)&&(this._key&&(d[l[this._key]]=!0),f.push(l));continue}}if(m&&"string"===typeof m&&this._index[m])for(k=0;k<this._index[m].list.length;k++)l=this._index[m].list[k],this._key?d[l[this._key]]||(d[l[this._key]]=!0,f.push(l)):-1===f.indexOf(l)&&f.push(l)}return f}};var a=function(a){this._index=
        {};this._list=[];this._parent=a;pc.events.attach(this)};a.prototype={add:function(){var a=!1,c=this._processArguments(arguments,!0);if(!c.length)return a;for(var d=0;d<c.length;d++)this._index[c[d]]||(a=!0,this._index[c[d]]=!0,this._list.push(c[d]),this.fire("add",c[d],this._parent));a&&this.fire("change",this._parent);return a},remove:function(){var a=!1;if(!this._list.length)return a;var c=this._processArguments(arguments,!0);if(!c.length)return a;for(var d=0;d<c.length;d++)this._index[c[d]]&&(a=
        !0,delete this._index[c[d]],this._list.splice(this._list.indexOf(c[d]),1),this.fire("remove",c[d],this._parent));a&&this.fire("change",this._parent);return a},clear:function(){if(this._list.length){var a=this._list.slice(0);this._list=[];this._index={};for(var c=0;c<a.length;c++)this.fire("remove",a[c],this._parent);this.fire("change",this._parent)}},has:function(){return this._list.length?this._has(this._processArguments(arguments)):!1},_has:function(a){if(!this._list.length||!a.length)return!1;
        for(var c=0;c<a.length;c++)if(1===a[c].length){if(this._index[a[c][0]])return!0}else{for(var d=!0,f=0;f<a[c].length;f++)if(!this._index[a[c][f]]){d=!1;break}if(d)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(a,c){var d=[],f=[];if(!a||!a.length)return d;for(var g=0;g<a.length;g++)if(a[g]instanceof Array){c||(f=[]);for(var k=0;k<a[g].length;k++)"string"===typeof a[g][k]&&(c?d.push(a[g][k]):f.push(a[g][k]));!c&&f.length&&d.push(f)}else"string"===typeof a[g]&&
    (c?d.push(a[g]):d.push([a[g]]));return d}};Object.defineProperty(a.prototype,"size",{get:function(){return this._list.length}});return{TagsCache:e,Tags:a}}());pc.extend(pc,function(){var e=function(a,b){this._constructor=a;this._pool=[];this._count=0;this._resize(b)};e.prototype={_resize:function(a){if(a>this._pool.length)for(var b=this._pool.length;b<a;b++)this._pool[b]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}};return{AllocatePool:e}}());pc.extend(pc,function(){var e={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,cocoonjs:!1,xbox:!1,gamepads:!1,touch:!1},a=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(a)&&(e.desktop=!0);/xbox/i.test(a)&&(e.xbox=!0);/(windows phone|iemobile|wpdesktop)/i.test(a)?(e.desktop=!1,e.mobile=!0,e.windows=!0):/android/i.test(a)?(e.desktop=!1,e.mobile=!0,e.android=!0):/ip([ao]d|hone)/i.test(a)&&(e.desktop=!1,e.mobile=!0,e.ios=!0);navigator.isCocoonJS&&(e.cocoonjs=!0);e.touch="ontouchstart"in window;
        e.gamepads="getGamepads"in navigator;return{platform:e}}());pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,INV_LOG2:1/Math.log(2),clamp:function(e,a,b){return e>=b?b:e<=a?a:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,e&255]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,e&255]},bytesToInt24:function(e,a,b){e.length&&(b=e[2],a=e[1],e=e[0]);return e<<16|a<<8|b},bytesToInt32:function(e,a,b,c){e.length&&(c=e[3],b=e[2],a=e[1],e=e[0]);return(e<<24|a<<16|b<<8|c)>>>32},lerp:function(e,a,b){return e+(a-e)*pc.math.clamp(b,0,1)},lerpAngle:function(e,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        a,b){180<a-e&&(a-=360);-180>a-e&&(a+=360);return pc.math.lerp(e,a,pc.math.clamp(b,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){e--;e|=e>>1;e|=e>>2;e|=e>>4;e|=e>>8;e|=e>>16;e++;return e},random:function(e,a){return Math.random()*(a-e)+e},smoothstep:function(e,a,b){if(b<=e)return 0;if(b>=a)return 1;b=(b-e)/(a-e);return b*b*(3-2*b)},smootherstep:function(e,a,b){if(b<=e)return 0;if(b>=a)return 1;b=(b-e)/(a-e);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;
    pc.math.bytesToInt=pc.math.bytesToInt32;Math.log2||(Math.log2=function(e){return Math.log(e)*pc.math.INV_LOG2});pc.extend(pc,function(){var e=function(a,b){a&&2===a.length?this.data=new Float32Array(a):(this.data=new Float32Array(2),this.data[0]=a||0,this.data[1]=b||0)};e.prototype={add:function(a){var b=this.data;a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]+d[0];f[1]=c[1]+d[1];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=this.data;a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data;a=a.data;
        return b[0]*a[0]+b[1]*a[1]},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,c){a=a.data;b=b.data;var d=this.data;d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);return this},mul:function(a){var b=this.data;a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]*d[0];
        f[1]=c[1]*d[1];return this},normalize:function(){var a=this.data,b=a[0]*a[0]+a[1]*a[1];0<b&&(b=1/Math.sqrt(b),a[0]*=b,a[1]*=b);return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var c=this.data;c[0]=a;c[1]=b;return this},sub:function(a){var b=this.data;a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]-d[0];f[1]=c[1]-d[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};
        Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1);return function(){return a}}()});Object.defineProperty(e,"RIGHT",{get:function(){var a=new e(1,0);return function(){return a}}()});Object.defineProperty(e,"UP",{get:function(){var a=new e(0,1);return function(){return a}}()});
        Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0);return function(){return a}}()});return{Vec2:e}}());pc.extend(pc,function(){var e=function(a,b,c){a&&3===a.length?this.data=new Float32Array(a):(this.data=new Float32Array(3),this.data[0]=a||0,this.data[1]=b||0,this.data[2]=c||0)};e.prototype={add:function(a){var b=this.data;a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]+d[0];f[1]=c[1]+d[1];f[2]=c[2]+d[2];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=this.data;a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];
        return this},cross:function(a,b){var c,d,f,g,k,l,m;c=a.data;d=b.data;f=this.data;g=c[0];k=c[1];c=c[2];l=d[0];m=d[1];d=d[2];f[0]=k*d-m*c;f[1]=c*l-d*g;f[2]=g*m-l*k;return this},dot:function(a){var b=this.data;a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},
        lerp:function(a,b,c){a=a.data;b=b.data;var d=this.data;d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return this},mul:function(a){var b=this.data;a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]*d[0];f[1]=c[1]*d[1];f[2]=c[2]*d[2];return this},normalize:function(){var a=this.data,b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];0<b&&(b=1/Math.sqrt(b),a[0]*=b,a[1]*=b,a[2]*=b);return this},project:function(a){var b=this.data;
            a=a.data;var c=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*c;b[1]=a[1]*c;b[2]=a[2]*c;return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,c){var d=this.data;d[0]=a;d[1]=b;d[2]=c;return this},sub:function(a){var b=this.data;a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]-d[0];f[1]=c[1]-d[1];f[2]=c[2]-d[2];return this},toString:function(){return"["+this.data[0]+
            ", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e,"BACK",{get:function(){var a=new e(0,0,1);return function(){return a}}()});Object.defineProperty(e,"DOWN",{get:function(){var a=
        new e(0,-1,0);return function(){return a}}()});Object.defineProperty(e,"FORWARD",{get:function(){var a=new e(0,0,-1);return function(){return a}}()});Object.defineProperty(e,"LEFT",{get:function(){var a=new e(-1,0,0);return function(){return a}}()});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1,1);return function(){return a}}()});Object.defineProperty(e,"RIGHT",{get:function(){var a=new e(1,0,0);return function(){return a}}()});Object.defineProperty(e,"UP",{get:function(){var a=new e(0,
        1,0);return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0);return function(){return a}}()});return{Vec3:e}}());pc.extend(pc,function(){var e=function(a,b,c,d){a&&4===a.length?this.data=new Float32Array(a):(this.data=new Float32Array(4),this.data[0]=a||0,this.data[1]=b||0,this.data[2]=c||0,this.data[3]=d||0)};e.prototype={add:function(a){var b=this.data;a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]+d[0];f[1]=c[1]+d[1];f[2]=c[2]+d[2];f[3]=c[3]+d[3];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=
        this.data;a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data;a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,c){a=a.data;b=b.data;var d=this.data;d[0]=
        a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);d[3]=a[3]+c*(b[3]-a[3]);return this},mul:function(a){var b=this.data;a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]*d[0];f[1]=c[1]*d[1];f[2]=c[2]*d[2];f[3]=c[3]*d[3];return this},normalize:function(){var a=this.data,b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3];0<b&&(b=1/Math.sqrt(b),a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return this},scale:function(a){var b=this.data;
        b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,c,d){var f=this.data;f[0]=a;f[1]=b;f[2]=c;f[3]=d;return this},sub:function(a){var b=this.data;a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]-d[0];f[1]=c[1]-d[1];f[2]=c[2]-d[2];f[3]=c[3]-d[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},
        set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1,1,1);return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=
        new e(0,0,0,0);return function(){return a}}()});return{Vec4:e}}());pc.extend(pc,function(){var e=function(a,b,c,d,f,g,k,l,m){a&&9===a.length?this.data=new Float32Array(a):(this.data=new Float32Array(9),"number"===typeof a?(this.data[0]=a,this.data[1]=b,this.data[2]=c,this.data[3]=d,this.data[4]=f,this.data[5]=g,this.data[6]=k,this.data[7]=l,this.data[8]=m):this.setIdentity())};e.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=
        a[8];return this},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=
        9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}};Object.defineProperty(e,"IDENTITY",{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:e}}());pc.extend(pc,function(){var e=function(a,b,c,d,f,g,k,l,m,e,h,r,p,q,t,x){a&&16===a.length?this.data=new Float32Array(a):(this.data=new Float32Array(16),"number"===typeof a?(this.data[0]=a,this.data[1]=b,this.data[2]=c,this.data[3]=d,this.data[4]=f,this.data[5]=g,this.data[6]=k,this.data[7]=l,this.data[8]=m,this.data[9]=e,this.data[10]=h,this.data[11]=r,this.data[12]=p,this.data[13]=q,this.data[14]=t,this.data[15]=x):this.setIdentity())};e.prototype={add2:function(a,b){var c=a.data,d=b.data,f=this.data;
        f[0]=c[0]+d[0];f[1]=c[1]+d[1];f[2]=c[2]+d[2];f[3]=c[3]+d[3];f[4]=c[4]+d[4];f[5]=c[5]+d[5];f[6]=c[6]+d[6];f[7]=c[7]+d[7];f[8]=c[8]+d[8];f[9]=c[9]+d[9];f[10]=c[10]+d[10];f[11]=c[11]+d[11];f[12]=c[12]+d[12];f[13]=c[13]+d[13];f[14]=c[14]+d[14];f[15]=c[15]+d[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){a=a.data;var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];
        b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data;a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&
        1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c,d,f,g,k,l,m,e,h,r,p,q,t,x,y,w,u,v,z,A;w=a.data;var D=b.data,B=this.data;c=w[0];d=w[1];f=w[2];g=w[3];k=w[4];l=w[5];m=w[6];e=w[7];h=w[8];r=w[9];p=w[10];q=w[11];t=w[12];x=w[13];y=w[14];w=w[15];u=D[0];v=D[1];z=D[2];A=D[3];B[0]=c*u+k*v+h*z+t*A;B[1]=d*u+l*v+r*z+x*A;B[2]=f*u+m*v+p*z+y*A;B[3]=g*u+e*v+q*z+w*A;u=D[4];v=D[5];z=D[6];A=D[7];B[4]=c*u+k*v+h*z+t*A;B[5]=d*u+l*v+r*z+x*A;B[6]=f*u+m*v+p*z+y*A;B[7]=g*u+e*v+q*z+
        w*A;u=D[8];v=D[9];z=D[10];A=D[11];B[8]=c*u+k*v+h*z+t*A;B[9]=d*u+l*v+r*z+x*A;B[10]=f*u+m*v+p*z+y*A;B[11]=g*u+e*v+q*z+w*A;u=D[12];v=D[13];z=D[14];A=D[15];B[12]=c*u+k*v+h*z+t*A;B[13]=d*u+l*v+r*z+x*A;B[14]=f*u+m*v+p*z+y*A;B[15]=g*u+e*v+q*z+w*A;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data,d=a.data;b=void 0===b?new pc.Vec3:b;return b.set(d[0]*c[0]+d[1]*c[4]+d[2]*c[8]+c[12],d[0]*c[1]+d[1]*c[5]+d[2]*c[9]+c[13],d[0]*c[2]+d[1]*c[6]+d[2]*c[10]+c[14])},transformVector:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     b){var c=this.data,d=a.data;b=void 0===b?new pc.Vec3:b;return b.set(d[0]*c[0]+d[1]*c[4]+d[2]*c[8],d[0]*c[1]+d[1]*c[5]+d[2]*c[9],d[0]*c[2]+d[1]*c[6]+d[2]*c[10])},transformVec4:function(a,b){var c=this.data,d=a.data;b=void 0===b?new pc.Vec4:b;return b.set(d[0]*c[0]+d[1]*c[4]+d[2]*c[8]+d[3]*c[12],d[0]*c[1]+d[1]*c[5]+d[2]*c[9]+d[3]*c[13],d[0]*c[2]+d[1]*c[6]+d[2]*c[10]+d[3]*c[14],d[0]*c[3]+d[1]*c[7]+d[2]*c[11]+d[3]*c[15])},setLookAt:function(){var a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;return function(d,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    f,g){c.sub2(d,f).normalize();b.copy(g).normalize();a.cross(b,c).normalize();b.cross(c,a);f=this.data;f[0]=a.x;f[1]=a.y;f[2]=a.z;f[3]=0;f[4]=b.x;f[5]=b.y;f[6]=b.z;f[7]=0;f[8]=c.x;f[9]=c.y;f[10]=c.z;f[11]=0;f[12]=d.x;f[13]=d.y;f[14]=d.z;f[15]=1;return this}}(),setFrustum:function(a,b,c,d,f,g){var k,l,m,e,h;k=2*f;l=b-a;m=d-c;e=g-f;h=this.data;h[0]=k/l;h[1]=0;h[2]=0;h[3]=0;h[4]=0;h[5]=k/m;h[6]=0;h[7]=0;h[8]=(b+a)/l;h[9]=(d+c)/m;h[10]=(-g-f)/e;h[11]=-1;h[12]=0;h[13]=0;h[14]=-k*g/e;h[15]=0;return this},
        setPerspective:function(a,b,c,d,f){f?(a=c*Math.tan(a*Math.PI/360),f=a/b):(f=c*Math.tan(a*Math.PI/360),a=f*b);return this.setFrustum(-a,a,-f,f,c,d)},setOrtho:function(a,b,c,d,f,g){var k=this.data;k[0]=2/(b-a);k[1]=0;k[2]=0;k[3]=0;k[4]=0;k[5]=2/(d-c);k[6]=0;k[7]=0;k[8]=0;k[9]=0;k[10]=-2/(g-f);k[11]=0;k[12]=-(b+a)/(b-a);k[13]=-(d+c)/(d-c);k[14]=-(g+f)/(g-f);k[15]=1;return this},setFromAxisAngle:function(a,b){var c,d,f,g,k,l,m,e,h;b*=pc.math.DEG_TO_RAD;c=a.x;d=a.y;f=a.z;g=Math.cos(b);k=Math.sin(b);l=
            1-g;m=l*c;e=l*d;h=this.data;h[0]=m*c+g;h[1]=m*d+k*f;h[2]=m*f-k*d;h[3]=0;h[4]=m*d-k*f;h[5]=e*d+g;h[6]=e*f+k*c;h[7]=0;h[8]=m*f+k*d;h[9]=e*f-c*k;h[10]=l*f*f+g;h[11]=0;h[12]=0;h[13]=0;h[14]=0;h[15]=1;return this},setTranslate:function(a,b,c){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return this},setScale:function(a,b,c){var d=this.data;d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=
            c;d[11]=0;d[12]=0;d[13]=0;d[14]=0;d[15]=1;return this},invert:function(){var a,b,c,d,f,g,k,l,m,e,h,r,p,q,t,x,y,w,u,v,z,A,D,B,F,J,G,I,C,E;E=this.data;a=E[0];b=E[1];c=E[2];d=E[3];f=E[4];g=E[5];k=E[6];l=E[7];m=E[8];e=E[9];h=E[10];r=E[11];p=E[12];q=E[13];t=E[14];x=E[15];y=a*g-b*f;w=a*k-c*f;u=a*l-d*f;v=b*k-c*g;z=b*l-d*g;A=c*l-d*k;D=m*q-e*p;B=m*t-h*p;F=m*x-r*p;J=e*t-h*q;G=e*x-r*q;I=h*x-r*t;C=y*I-w*G+u*J+v*F-z*B+A*D;0===C?this.setIdentity():(C=1/C,E[0]=(g*I-k*G+l*J)*C,E[1]=(-b*I+c*G-d*J)*C,E[2]=(q*A-t*z+
            x*v)*C,E[3]=(-e*A+h*z-r*v)*C,E[4]=(-f*I+k*F-l*B)*C,E[5]=(a*I-c*F+d*B)*C,E[6]=(-p*A+t*u-x*w)*C,E[7]=(m*A-h*u+r*w)*C,E[8]=(f*G-g*F+l*D)*C,E[9]=(-a*G+b*F-d*D)*C,E[10]=(p*z-q*u+x*y)*C,E[11]=(-m*z+e*u-r*y)*C,E[12]=(-f*J+g*B-k*D)*C,E[13]=(a*J-b*B+c*D)*C,E[14]=(-p*v+q*w-t*y)*C,E[15]=(m*v-e*w+h*y)*C);return this},set:function(a){var b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=
            a[15];return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var d,f,g,k,l,m,e,h,r,p,q,t,x;d=a.x;f=a.y;a=a.z;g=b.x;k=b.y;l=b.z;m=b.w;b=c.x;e=c.y;c=c.z;h=g+g;r=k+k;p=l+l;q=g*h;t=g*r;g*=p;x=k*r;k*=p;l*=p;h*=m;r*=m;m*=p;p=this.data;p[0]=(1-(x+l))*b;p[1]=(t+m)*b;p[2]=(g-r)*b;p[3]=0;p[4]=(t-m)*e;p[5]=(1-(q+l))*e;p[6]=(k+h)*e;p[7]=0;p[8]=(g+r)*c;p[9]=(k-
            h)*c;p[10]=(1-(q+x))*c;p[11]=0;p[12]=d;p[13]=f;p[14]=a;p[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},invertTo3x3:function(a){var b,c,d,f;b=this.data;a=a.data;var g=b[0],k=b[1],l=b[2],m=b[4],e=b[5],h=b[6],r=b[8],p=b[9],q=b[10];b=q*e-h*p;c=-q*m+h*r;d=p*m-e*r;f=g*b+k*c+l*d;if(0===f)return this;f=1/f;a[0]=f*b;a[1]=f*(-q*k+l*
            p);a[2]=f*(h*k-l*e);a[3]=f*c;a[4]=f*(q*g-l*r);a[5]=f*(-h*g+l*m);a[6]=f*d;a[7]=f*(-p*g+k*r);a[8]=f*(e*g-k*m);return this},getTranslation:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],
            this.data[10])},getScale:function(){var a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;return function(d){d=void 0===d?new pc.Vec3:d;this.getX(a);this.getY(b);this.getZ(c);d.set(a.length(),b.length(),c.length());return d}}(),setFromEulerAngles:function(a,b,c){var d,f,g,k;a*=pc.math.DEG_TO_RAD;b*=pc.math.DEG_TO_RAD;c*=pc.math.DEG_TO_RAD;d=Math.sin(-a);a=Math.cos(-a);f=Math.sin(-b);b=Math.cos(-b);g=Math.sin(-c);c=Math.cos(-c);k=this.data;k[0]=b*c;k[1]=-b*g;k[2]=f;k[3]=0;k[4]=a*g+c*d*f;k[5]=a*c-d*f*
            g;k[6]=-b*d;k[7]=0;k[8]=d*g-a*c*f;k[9]=c*d+a*f*g;k[10]=a*b;k[11]=0;k[12]=0;k[13]=0;k[14]=0;k[15]=1;return this},getEulerAngles:function(){var a=new pc.Vec3;return function(b){var c,d,f,g,k,l;b=void 0===b?new pc.Vec3:b;this.getScale(a);f=a.x;c=a.y;g=a.z;k=this.data;d=Math.asin(-k[2]/f);l=.5*Math.PI;d<l?d>-l?(c=Math.atan2(k[6]/c,k[10]/g),f=Math.atan2(k[1]/f,k[0]/f)):(f=0,c=-Math.atan2(k[4]/c,k[5]/c)):(f=0,c=Math.atan2(k[4]/c,k[5]/c));return b.set(c,d,f).scale(pc.math.RAD_TO_DEG)}}(),toString:function(){var a,
            b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(e,"IDENTITY",{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:e}}());pc.extend(pc,function(){var e=function(a,b,c,d){a&&4===a.length?(this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3]):(this.x=void 0===a?0:a,this.y=void 0===b?0:b,this.z=void 0===c?0:c,this.w=void 0===d?1:d)};e.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===
        a.w},getAxisAngle:function(a){var b=2*Math.acos(this.w),c=Math.sin(b/2);if(0!==c){if(a.x=this.x/c,a.y=this.y/c,a.z=this.z/c,0>a.x||0>a.y||0>a.z)a.x*=-1,a.y*=-1,a.z*=-1,b*=-1}else a.x=1,a.y=0,a.z=0;return b*pc.math.RAD_TO_DEG},getEulerAngles:function(a){var b,c,d,f,g,k;a=void 0===a?new pc.Vec3:a;d=this.x;f=this.y;g=this.z;k=this.w;c=2*(k*f-d*g);-.99999>=c?(b=2*Math.atan2(d,k),c=-Math.PI/2,d=0):.99999<=c?(b=2*Math.atan2(d,k),c=Math.PI/2,d=0):(b=Math.atan2(2*(k*d+f*g),1-2*(d*d+f*f)),c=Math.asin(c),d=
        Math.atan2(2*(k*g+d*f),1-2*(f*f+g*g)));return a.set(b,c,d).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,c,d;a=this.x;b=this.y;c=this.z;d=this.w;return Math.sqrt(a*a+b*b+c*c+d*d)},lengthSq:function(){return NaN},mul:function(a){var b,c,d,f,g,k,l;b=this.x;c=this.y;d=this.z;f=this.w;g=a.x;k=a.y;l=a.z;a=a.w;this.x=f*g+b*a+c*l-d*k;this.y=f*k+c*a+d*g-b*l;this.z=f*l+d*a+b*k-c*g;this.w=f*a-b*g-c*k-d*l;return this},mul2:function(a,b){var c,d,f,
        g,k,l,m,e;c=a.x;d=a.y;f=a.z;g=a.w;k=b.x;l=b.y;m=b.z;e=b.w;this.x=g*k+c*e+d*m-f*l;this.y=g*l+d*e+f*k-c*m;this.z=g*m+f*e+c*l-d*k;this.w=g*e-c*k-d*l-f*m;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},setFromAxisAngle:function(a,b){var c,d;b=.5*b*pc.math.DEG_TO_RAD;c=Math.sin(b);d=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=
        c*a.z;this.w=d;return this},setFromEulerAngles:function(a,b,c){var d,f,g;d=.5*pc.math.DEG_TO_RAD;a*=d;b*=d;c*=d;d=Math.sin(a);a=Math.cos(a);f=Math.sin(b);b=Math.cos(b);g=Math.sin(c);c=Math.cos(c);this.x=d*b*c-a*f*g;this.y=a*f*c+d*b*g;this.z=a*b*g-d*f*c;this.w=a*b*c+d*f*g;return this},setFromMat4:function(a){var b,c,d,f,g,k,l,m,e,h,r;a=a.data;b=a[0];c=a[1];d=a[2];f=a[4];g=a[5];k=a[6];l=a[8];m=a[9];a=a[10];e=1/Math.sqrt(b*b+c*c+d*d);h=1/Math.sqrt(f*f+g*g+k*k);r=1/Math.sqrt(l*l+m*m+a*a);b*=e;c*=e;d*=
        e;f*=h;g*=h;k*=h;l*=r;m*=r;a*=r;e=b+g+a;0<=e?(b=Math.sqrt(e+1),this.w=.5*b,b=.5/b,this.x=(k-m)*b,this.y=(l-d)*b,this.z=(c-f)*b):b>g?b>a?(b=Math.sqrt(b-(g+a)+1),this.x=.5*b,b=.5/b,this.w=(k-m)*b,this.y=(c+f)*b,this.z=(d+l)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-f)*b,this.x=(l+d)*b,this.y=(m+k)*b):g>a?(b=Math.sqrt(g-(a+b)+1),this.y=.5*b,b=.5/b,this.w=(l-d)*b,this.z=(k+m)*b,this.x=(f+c)*b):(b=Math.sqrt(a-(b+g)+1),this.z=.5*b,b=.5/b,this.w=(c-f)*b,this.x=(l+d)*b,this.y=(m+k)*b);return this},
        slerp:function(a,b,c){var d,f,g,k,l,m;d=a.x;f=a.y;g=a.z;a=a.w;k=b.x;l=b.y;m=b.z;b=b.w;var e=a*b+d*k+f*l+g*m;0>e&&(b=-b,k=-k,l=-l,m=-m,e=-e);if(1<=Math.abs(e))return this.w=a,this.x=d,this.y=f,this.z=g,this;var h=Math.acos(e),r=Math.sqrt(1-e*e);if(.001>Math.abs(r))return this.w=.5*a+.5*b,this.x=.5*d+.5*k,this.y=.5*f+.5*l,this.z=.5*g+.5*m,this;e=Math.sin((1-c)*h)/r;c=Math.sin(c*h)/r;this.w=a*e+b*c;this.x=d*e+k*c;this.y=f*e+l*c;this.z=g*e+m*c;return this},transformVector:function(a,b){void 0===b&&(b=
            new pc.Vec3);var c=a.x,d=a.y,f=a.z,g=this.x,k=this.y,l=this.z,m=this.w,e=m*c+k*f-l*d,h=m*d+l*c-g*f,r=m*f+g*d-k*c,c=-g*c-k*d-l*f;b.x=e*m+c*-g+h*-l-r*-k;b.y=h*m+c*-k+r*-g-e*-l;b.z=r*m+c*-l+e*-k-h*-g;return b},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(e,"IDENTITY",{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0);return function(){return a}}()});return{Quat:e}}());pc.extend(pc,function(){var e=function(a){this.keys=[];this.type=1;this.tension=.5;if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};e.prototype={add:function(a,b){for(var c=this.keys,d=c.length,f=0;f<d&&!(c[f][0]>a);f++);c=[a,b];this.keys.splice(f,0,c);return c},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){var b,c,d=this.keys;if(!d.length)return 0;if(a<d[0][0])return d[0][1];if(a>d[d.length-1][0])return d[d.length-
    1][1];var f=0,g=d.length?d[0][1]:0,k=1,l=0;b=0;for(c=d.length;b<c;b++){if(d[b][0]===a)return d[b][1];l=d[b][1];if(a<d[b][0]){k=d[b][0];break}f=d[b][0];g=d[b][1]}c=k-f;a=0===c?0:(a-f)/c;if(1===this.type)a=a*a*(3-2*a);else if(2===this.type||3===this.type){c=g+(g-l);var m=l+(l-g),e=k=f=k-f;0<b&&--b;0<b&&(c=d[b-1][1],k=d[b][0]-d[b-1][0]);d.length>b+1&&(f=d[b+1][0]-d[b][0]);d.length>b+2&&(e=d[b+2][0]-d[b+1][0],m=d[b+2][1]);c=g+(c-g)*f/k;m=l+(m-l)*f/e;return 2===this.type?this._interpolateCatmullRom(c,
        g,l,m,a):this._interpolateCardinal(c,g,l,m,a,this.tension)}return pc.math.lerp(g,l,a)},_interpolateHermite:function(a,b,c,d,f){var g=f*f,k=f*f*f;return a*(2*k-3*g+1)+b*(-2*k+3*g)+c*(k-2*g+f)+d*(k-g)},_interpolateCardinal:function(a,b,c,d,f,g){return this._interpolateHermite(b,c,g*(c-a),g*(d-b),f)},_interpolateCatmullRom:function(a,b,c,d,f){return this._interpolateCardinal(a,b,c,d,f,.5)},closest:function(a){for(var b=this.keys,c=b.length,d=2,f=null,g=0;g<c;g++){var k=Math.abs(a-b[g][0]);if(d>=k)d=
        k,f=b[g];else break}return f},clone:function(){var a=new pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return a},quantize:function(a){a=Math.max(a,2);for(var b=new Float32Array(a),c=1/(a-1),d=0;d<a;d++){var f=this.value(c*d);b[d]=f}return b}};Object.defineProperty(e.prototype,"length",{get:function(){return this.keys.length}});return{Curve:e,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var e=function(){var a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new pc.Curve(arguments[a]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var b=arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new pc.Curve);else for(a=0;a<b.length;a++)this.curves.push(new pc.Curve(b[a]))}};e.prototype={get:function(a){return this.curves[a]},value:function(a,b){var c=this.curves.length;
        b=b||[];b.length=c;for(var d=0;d<c;d++)b[d]=this.curves[d].value(a);return b},clone:function(){var a=new pc.CurveSet;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){a=Math.max(a,2);for(var b=this.curves.length,c=new Float32Array(a*b),d=1/(a-1),f=[],g=0;g<a;g++){var k=this.value(d*g,f);if(1==b)c[g]=k[0];else for(var l=0;l<b;l++)c[g*b+l]=k[l]}return c}};Object.defineProperty(e.prototype,"length",{get:function(){return this.curves.length}});
        Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});return{CurveSet:e}}());pc.extend(pc,function(){var e=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,c=new pc.Vec3,d=new pc.Vec3,f=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(.5,.5,.5);this._min=new pc.Vec3;this._max=new pc.Vec3};f.prototype={add:function(a){var b=this.center.data,c=b[0],d=b[1],f=b[2],h=this.halfExtents.data,e=h[0],p=h[1],q=h[2],t=c-e,c=c+e,e=d-p,d=d+p,p=f-q,f=f+q,q=a.center.data,x=q[0],y=q[1],q=q[2];a=a.halfExtents.data;var w=a[0],u=a[1],v=a[2];a=x-w;x+=w;w=y-u;y+=u;u=q-v;q+=
        v;a<t&&(t=a);x>c&&(c=x);w<e&&(e=w);y>d&&(d=y);u<p&&(p=u);q>f&&(f=q);b[0]=.5*(t+c);b[1]=.5*(e+d);b[2]=.5*(p+f);h[0]=.5*(c-t);h[1]=.5*(d-e);h[2]=.5*(f-p)},copy:function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type},clone:function(){return new pc.BoundingBox(this.center.clone(),this.halfExtents.clone())},intersects:function(a){var b=this.getMax(),c=this.getMin(),d=a.getMax();a=a.getMin();return c.x<=d.x&&b.x>=a.x&&c.y<=d.y&&b.y>=a.y&&c.z<=d.z&&b.z>=a.z},_intersectsRay:function(d,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              k){for(var f=e.copy(this.getMin()).sub(d.origin).data,m=a.copy(this.getMax()).sub(d.origin).data,n=d.direction.data,h=0;3>h;h++)0===n[h]?(f[h]=0>f[h]?-Number.MAX_VALUE:Number.MAX_VALUE,m[h]=0>m[h]?-Number.MAX_VALUE:Number.MAX_VALUE):(f[h]/=n[h],m[h]/=n[h]);n=b.set(Math.min(f[0],m[0]),Math.min(f[1],m[1]),Math.min(f[2],m[2])).data;f=c.set(Math.max(f[0],m[0]),Math.max(f[1],m[1]),Math.max(f[2],m[2])).data;m=Math.max(Math.max(n[0],n[1]),n[2]);(f=Math.min(Math.min(f[0],f[1]),f[2])>=m&&0<=m)&&k.copy(d.direction).scale(m).add(d.origin);
        return f},_fastIntersectsRay:function(f){var k=f.direction;e.sub2(f.origin,this.center);c.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z));b.mul2(e,k);if(c.x>this.halfExtents.x&&0<=b.x||c.y>this.halfExtents.y&&0<=b.y||c.z>this.halfExtents.z&&0<=b.z)return!1;d.set(Math.abs(k.x),Math.abs(k.y),Math.abs(k.z));a.cross(k,e);a.set(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));return a.x>this.halfExtents.y*d.z+this.halfExtents.z*d.y||a.y>this.halfExtents.x*d.z+this.halfExtents.z*d.x||a.z>this.halfExtents.x*d.y+
    this.halfExtents.y*d.x?!1:!0},intersectsRay:function(a,b){return b?this._intersectsRay(a,b):this._fastIntersectsRay(a)},setMinMax:function(a,b){this.center.add2(b,a).scale(.5);this.halfExtents.sub2(b,a).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(a){var b=this.getMin(),c=this.getMax(),d;for(d=0;3>d;++d)if(a.data[d]<b.data[d]||a.data[d]>c.data[d])return!1;return!0},
        setFromTransformedAabb:function(a,b){var c=this.center,d=this.halfExtents,f=a.center.data,h=a.halfExtents.data;b=b.data;var e=b[0],p=b[4],q=b[8],t=b[1],x=b[5],y=b[9],w=b[2],u=b[6],v=b[10],z=Math.abs(e),A=Math.abs(p),D=Math.abs(q),B=Math.abs(t),F=Math.abs(x),J=Math.abs(y),G=Math.abs(w),I=Math.abs(u),C=Math.abs(v);c.set(b[12]+e*f[0]+p*f[1]+q*f[2],b[13]+t*f[0]+x*f[1]+y*f[2],b[14]+w*f[0]+u*f[1]+v*f[2]);d.set(z*h[0]+A*h[1]+D*h[2],B*h[0]+F*h[1]+J*h[2],G*h[0]+I*h[1]+C*h[2])},compute:function(b){for(var c=
            e.set(b[0],b[1],b[2]),d=a.set(b[0],b[1],b[2]),f=b.length/3,n=1;n<f;n++){var h=b[3*n+0],r=b[3*n+1],p=b[3*n+2];h<c.x&&(c.x=h);r<c.y&&(c.y=r);p<c.z&&(c.z=p);h>d.x&&(d.x=h);r>d.y&&(d.y=r);p>d.z&&(d.z=p)}this.setMinMax(c,d)},intersectsBoundingSphere:function(a){return this._distanceToBoundingSphereSq(a)<=a.radius*a.radius?!0:!1},_distanceToBoundingSphereSq:function(a){for(var b=this.getMin(),c=this.getMax(),d=0,f=0;3>f;++f){var h=0,e=a.center.data[f],p=b.data[f],q=c.data[f],t=0;e<p&&(t=p-e,h+=t*t);e>q&&
        (t=e-q,h+=t*t);d+=h}return d}};return{BoundingBox:f}}());pc.extend(pc,function(){function e(a,b){this.center=a||new pc.Vec3(0,0,0);this.radius=void 0===b?.5:b}var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Vec3,d=new pc.Vec3;e.prototype={containsPoint:function(b){b=a.sub2(b,this.center).lengthSq();var c=this.radius;return b<c*c},compute:function(f){var g,k=f.length/3;for(g=0;g<k;g++)a.set(f[3*g],f[3*g+1],f[3*g+2]),c.addSelf(a),0===g%100&&(c.scale(1/k),b.add(c),c.set(0,0,0));c.scale(1/k);b.add(c);this.center.copy(b);var l=0;for(g=0;g<k;g++)a.set(f[3*g],f[3*g+
    1],f[3*g+2]),d.sub2(a,this.center),l=Math.max(d.lengthSq(),l);this.radius=Math.sqrt(l)},intersectsRay:function(c,d){var k=a.copy(c.origin).sub(this.center),l=k.dot(b.copy(c.direction).normalize()),k=k.dot(k)-this.radius*this.radius;if(0<k&&0<l)return null;k=l*l-k;if(0>k)return!1;l=Math.abs(-l-Math.sqrt(k));d&&d.copy(c.direction).scale(l).add(c.origin);return!0},intersectsBoundingSphere:function(b){a.sub2(b.center,this.center);b=b.radius+this.radius;return a.lengthSq()<=b*b?!0:!1}};return{BoundingSphere:e}}());pc.extend(pc,function(){var e=new pc.Mat4,a=function(a,c){a=a||(new pc.Mat4).setPerspective(90,16/9,.1,1E3);c=c||new pc.Mat4;this.planes=[];for(var d=0;6>d;d++)this.planes[d]=[];this.update(a,c)};a.prototype={update:function(a,c){e.mul2(a,c);var d=e.data;this.planes[0][0]=d[3]-d[0];this.planes[0][1]=d[7]-d[4];this.planes[0][2]=d[11]-d[8];this.planes[0][3]=d[15]-d[12];var f=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=
        f;this.planes[0][1]/=f;this.planes[0][2]/=f;this.planes[0][3]/=f;this.planes[1][0]=d[3]+d[0];this.planes[1][1]=d[7]+d[4];this.planes[1][2]=d[11]+d[8];this.planes[1][3]=d[15]+d[12];f=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=f;this.planes[1][1]/=f;this.planes[1][2]/=f;this.planes[1][3]/=f;this.planes[2][0]=d[3]+d[1];this.planes[2][1]=d[7]+d[5];this.planes[2][2]=d[11]+d[9];this.planes[2][3]=d[15]+d[13];f=
        Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=f;this.planes[2][1]/=f;this.planes[2][2]/=f;this.planes[2][3]/=f;this.planes[3][0]=d[3]-d[1];this.planes[3][1]=d[7]-d[5];this.planes[3][2]=d[11]-d[9];this.planes[3][3]=d[15]-d[13];f=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=f;this.planes[3][1]/=f;this.planes[3][2]/=f;
        this.planes[3][3]/=f;this.planes[4][0]=d[3]-d[2];this.planes[4][1]=d[7]-d[6];this.planes[4][2]=d[11]-d[10];this.planes[4][3]=d[15]-d[14];f=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=f;this.planes[4][1]/=f;this.planes[4][2]/=f;this.planes[4][3]/=f;this.planes[5][0]=d[3]+d[2];this.planes[5][1]=d[7]+d[6];this.planes[5][2]=d[11]+d[10];this.planes[5][3]=d[15]+d[14];f=Math.sqrt(this.planes[5][0]*this.planes[5][0]+
            this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=f;this.planes[5][1]/=f;this.planes[5][2]/=f;this.planes[5][3]/=f},containsPoint:function(a){for(var c=0;6>c;c++)if(0>=this.planes[c][0]*a.x+this.planes[c][1]*a.y+this.planes[c][2]*a.z+this.planes[c][3])return!1;return!0},containsSphere:function(a){var c=0,d,f,g=a.radius;f=a.center.data;a=f[0];var k=f[1],l=f[2],m=this.planes;for(f=0;6>f;f++){d=m[f];d=d[0]*a+d[1]*k+d[2]*l+d[3];if(d<=-g)return 0;d>g&&c++}return 6===
    c?2:1}};return{Frustum:a}}());pc.extend(pc,function(){var e=new pc.Vec3,a=function(a,c){this.normal=c||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0)};a.prototype={intersectsLine:function(a,c,d){var f=-this.normal.dot(this.point),g=this.normal.dot(a)+f,f=this.normal.dot(c)+f,g=g/(g-f);(f=0<=g&&1>=g)&&d&&d.lerp(a,c,g);return f},intersectsRay:function(a,c){var d=e.sub2(this.point,a.origin),d=this.normal.dot(d)/this.normal.dot(a.direction),f=0<=d;f&&c&&c.copy(a.direction).scale(d).add(a.origin);return f}};return{Plane:a}}());pc.extend(pc,function(){return{Ray:function(e,a){this.origin=e||new pc.Vec3(0,0,0);this.direction=a||new pc.Vec3(0,0,-1)}}}());pc.extend(pc,function(){var e=new pc.Ray,a=new pc.Vec3,b=new pc.BoundingSphere,c=new pc.Mat4,d=function(a,b){this.halfExtents=b||new pc.Vec3(.5,.5,.5);a=a||c.setIdentity();this._modelTransform=a.clone().invert();this._aabb=new pc.BoundingBox(new pc.Vec3,this.halfExtents)};d.prototype={intersectsRay:function(a,b){this._modelTransform.transformPoint(a.origin,e.origin);this._modelTransform.transformVector(a.direction,e.direction);if(b){var d=this._aabb._intersectsRay(e,b);c.copy(this._modelTransform).invert().transformPoint(b,
        b);return d}return this._aabb._fastIntersectsRay(e)},containsPoint:function(b){this._modelTransform.transformPoint(b,a);return this._aabb.containsPoint(a)},intersectsBoundingSphere:function(a){this._modelTransform.transformPoint(a.center,b.center);b.radius=a.radius;return this._aabb.intersectsBoundingSphere(b)?!0:!1}};Object.defineProperty(d.prototype,"worldTransform",{set:function(a){this._modelTransform.copy(a).invert()}});return{OrientedBox:d}}());(function(){var e={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BLENDEQUATION_MIN:3,BLENDEQUATION_MAX:4,BUFFER_STATIC:0,
        BUFFER_DYNAMIC:1,BUFFER_STREAM:2,BUFFER_GPUDYNAMIC:3,CLEARFLAG_COLOR:1,CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CUBEFACE_POSX:0,CUBEFACE_NEGX:1,CUBEFACE_POSY:2,CUBEFACE_NEGY:3,CUBEFACE_POSZ:4,CUBEFACE_NEGZ:5,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,TYPE_INT8:0,TYPE_UINT8:1,TYPE_INT16:2,TYPE_UINT16:3,TYPE_INT32:4,TYPE_UINT32:5,TYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,
        FUNC_NEVER:0,FUNC_LESS:1,FUNC_EQUAL:2,FUNC_LESSEQUAL:3,FUNC_GREATER:4,FUNC_NOTEQUAL:5,FUNC_GREATEREQUAL:6,FUNC_ALWAYS:7,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,
        PIXELFORMAT_R32F:15,PIXELFORMAT_DEPTH:16,PIXELFORMAT_DEPTHSTENCIL:17,PIXELFORMAT_111110F:18,PIXELFORMAT_SRGB:19,PIXELFORMAT_SRGBA:20,PIXELFORMAT_ETC1:21,PIXELFORMAT_PVRTC_2BPP_RGB_1:22,PIXELFORMAT_PVRTC_2BPP_RGBA_1:23,PIXELFORMAT_PVRTC_4BPP_RGB_1:24,PIXELFORMAT_PVRTC_4BPP_RGBA_1:25,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",
        SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",
        SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",SHADERTAG_MATERIAL:1,STENCILOP_KEEP:0,STENCILOP_ZERO:1,STENCILOP_REPLACE:2,STENCILOP_INCREMENT:3,STENCILOP_INCREMENTWRAP:4,STENCILOP_DECREMENT:5,STENCILOP_DECREMENTWRAP:6,STENCILOP_INVERT:7,TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,TEXHINT_NONE:0,TEXHINT_SHADOWMAP:1,TEXHINT_ASSET:2,TEXHINT_LIGHTMAP:3,
        UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16,UNIFORMTYPE_FLOATARRAY:17,UNIFORMTYPE_TEXTURE2D_SHADOW:18,UNIFORMTYPE_TEXTURECUBE_SHADOW:19,UNIFORMTYPE_TEXTURE3D:20};pc.extend(pc,e);pc.gfx={};pc.extend(pc.gfx,
        e)})();pc.extend(pc,function(){var e=function(a){this.name=a;this.value=null;this.versionObject=new pc.VersionedObject};e.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(a){return this.value}};return{ScopeId:e}}());pc.extend(pc,function(){var e=function(a){this.name=a;this.variables={};this.namespaces={}};e.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:e}}());pc.extend(pc,function(){var e=function(){this.revision=this.globalId=0};e.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:e}}());pc.extend(pc,function(){var e=0,a=function(){e++;this.version=new pc.Version;this.version.globalId=e};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());pc.extend(pc,function(){function e(f,k){this.index=0;switch(k.dataType){case pc.TYPE_INT8:this.array=new Int8Array(f,k.offset);break;case pc.TYPE_UINT8:this.array=new Uint8Array(f,k.offset);break;case pc.TYPE_INT16:this.array=new Int16Array(f,k.offset);break;case pc.TYPE_UINT16:this.array=new Uint16Array(f,k.offset);break;case pc.TYPE_INT32:this.array=new Int32Array(f,k.offset);break;case pc.TYPE_UINT32:this.array=new Uint32Array(f,k.offset);break;case pc.TYPE_FLOAT32:this.array=new Float32Array(f,
        k.offset)}switch(k.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=c;break;case 4:this.set=d}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function d(a,b,c,d){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c;this.array[this.index+3]=d}function f(a){this.vertexBuffer=a;this.buffer=
        this.vertexBuffer.lock();this.setters=[];this.element={};a=this.vertexBuffer.getFormat();for(var b=0;b<a.elements.length;b++){var c=a.elements[b];this.setters[b]=new e(this.buffer,c);this.element[c.name]=this.setters[b]}}f.prototype={next:function(){for(var a=0,b=this.setters,c=this.setters.length,d=this.vertexBuffer.getFormat();a<c;){var f=b[a++];f.index+=d.size/f.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};return{VertexIterator:f}}());pc.extend(pc,function(){var e=[];e[pc.TYPE_INT8]=1;e[pc.TYPE_UINT8]=1;e[pc.TYPE_INT16]=2;e[pc.TYPE_UINT16]=2;e[pc.TYPE_INT32]=4;e[pc.TYPE_UINT32]=4;e[pc.TYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var c,d,f;this.elements=[];this.hasColor=this.hasUv1=this.hasUv0=!1;c=this.size=0;for(d=b.length;c<d;c++){var g=b[c];f={name:g.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(g.semantic),dataType:g.type,numComponents:g.components,normalize:void 0===g.normalize?!1:g.normalize,size:g.components*
    e[g.type]};this.elements.push(f);this.size+=4*Math.ceil(f.size/4);g.semantic===pc.SEMANTIC_TEXCOORD0?this.hasUv0=!0:g.semantic===pc.SEMANTIC_TEXCOORD1?this.hasUv1=!0:g.semantic===pc.SEMANTIC_COLOR&&(this.hasColor=!0)}c=g=0;for(d=this.elements.length;c<d;c++)f=this.elements[c],f.offset=g,f.stride=this.size,g+=f.size}}}());pc.extend(pc,function(){var e=function(a,b,c,d,f){this.usage=d||pc.BUFFER_STATIC;this.format=b;this.numVertices=c;this.numBytes=b.size*c;a._vram.vb+=this.numBytes;this.device=a;f?this.setData(f):this.storage=new ArrayBuffer(this.numBytes);this.device.buffers.push(this)};e.prototype={destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,1);if(this.bufferId){b=a.gl;b.deleteBuffer(this.bufferId);a._vram.vb-=this.storage.byteLength;this.bufferId=null;a.boundBuffer=
        null;a.vertexBuffers.length=0;a.vbOffsets.length=0;a.attributesInvalidated=!0;for(var c in a.enabledAttributes)b.disableVertexAttribArray(c);a.enabledAttributes={}}},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;this.bufferId||(this.bufferId=a.createBuffer());var b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=
        a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;this.storage=a;this.unlock();return!0}};return{VertexBuffer:e}}());pc.extend(pc,function(){var e=function(a,b,c,d,f){this.usage=d||pc.BUFFER_STATIC;this.format=b;this.numIndices=c;this.device=a;c=this.device.gl;var g;b===pc.INDEXFORMAT_UINT8?(g=1,this.glFormat=c.UNSIGNED_BYTE):b===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=c.UNSIGNED_SHORT):b===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=c.UNSIGNED_INT);this.bytesPerIndex=g;this.numBytes=this.numIndices*g;f?this.setData(f):this.storage=new ArrayBuffer(this.numBytes);a._vram.ib+=this.numBytes;this.device.buffers.push(this)};
        e.prototype={destroy:function(){var a=this.device,b=a.buffers.indexOf(this);-1!==b&&a.buffers.splice(b,1);this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl;this.bufferId||(this.bufferId=a.createBuffer());
            var b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW;break;case pc.BUFFER_GPUDYNAMIC:b=this.device.webgl2?a.DYNAMIC_COPY:a.STATIC_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)},setData:function(a){if(a.byteLength!==this.numBytes)return console.error("IndexBuffer: wrong initial data size: expected "+this.numBytes+", got "+a.byteLength),!1;
            this.storage=a;this.unlock();return!0}};return{IndexBuffer:e}}());pc.extend(pc,function(){var e=function(a,b){b=b||pc.BUFFER_GPUDYNAMIC;this.device=a.device;var c=this.device.gl;this._inputBuffer=a;b===pc.BUFFER_GPUDYNAMIC&&a.usage!==b&&(c.bindBuffer(c.ARRAY_BUFFER,a.bufferId),c.bufferData(c.ARRAY_BUFFER,a.storage,c.DYNAMIC_COPY));this._outputBuffer=new pc.VertexBuffer(a.device,a.format,a.numVertices,b,a.storage)};e.createShader=function(a,b,c){return pc.shaderChunks.createShaderFromCode(a,b,null,c,!0)};e.prototype={destroy:function(){this._outputBuffer.destroy()},
        process:function(a,b){void 0===b&&(b=!0);var c=this.device;c.setRenderTarget(null);c.updateBegin();c.setVertexBuffer(this._inputBuffer,0);c.setRaster(!1);c.setTransformFeedbackBuffer(this._outputBuffer);c.setShader(a);c.draw({type:pc.PRIMITIVE_POINTS,base:0,count:this._inputBuffer.numVertices,indexed:!1});c.setTransformFeedbackBuffer(null);c.setRaster(!0);c.updateEnd();b&&(c=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=c)}};Object.defineProperty(e.prototype,
        "inputBuffer",{get:function(){return this._inputBuffer}});Object.defineProperty(e.prototype,"outputBuffer",{get:function(){return this._outputBuffer}});return{TransformFeedback:e}}());pc.extend(pc,function(){var e=function(a,b){this.device=a;this.name=null;this._height=this._width=4;this._depth=1;this._pot=!0;this._format=pc.PIXELFORMAT_R8_G8_B8_A8;this.fixCubemapSeams=this._volume=this._cubemap=this.rgbm=!1;this._mipmaps=this._flipY=!0;this._minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._addressW=this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._compareOnRead=!1;this._compareFunc=pc.FUNC_LESS;void 0!==b&&(this._width=void 0!==
    b.width?b.width:this._width,this._height=void 0!==b.height?b.height:this._height,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._format=void 0!==b.format?b.format:this._format,this.rgbm=void 0!==b.rgbm?b.rgbm:this.rgbm,this._mipmaps=void 0!==b.mipmaps?b.mipmaps:void 0!==b.autoMipmap?b.autoMipmap:this._mipmaps,this._cubemap=void 0!==b.cubemap?b.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=
        void 0!==b.minFilter?b.minFilter:this._minFilter,this._magFilter=void 0!==b.magFilter?b.magFilter:this._magFilter,this._anisotropy=void 0!==b.anisotropy?b.anisotropy:this._anisotropy,this._addressU=void 0!==b.addressU?b.addressU:this._addressU,this._addressV=void 0!==b.addressV?b.addressV:this._addressV,this._compareOnRead=void 0!==b.compareOnRead?b.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==b._compareFunc?b._compareFunc:this._compareFunc,this._flipY=void 0!==b.flipY?b.flipY:this._flipY,
    a.webgl2&&(this._depth=void 0!==b.depth?b.depth:this._depth,this._volume=void 0!==b.volume?b.volume:this._volume,this._addressW=void 0!==b.addressW?b.addressW:this._addressW));this._compressed=this._format===pc.PIXELFORMAT_DXT1||this._format===pc.PIXELFORMAT_DXT3||this._format===pc.PIXELFORMAT_DXT5||this._format>=pc.PIXELFORMAT_ETC1;this._invalid=!1;this._lockedLevel=-1;this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null];this.dirtyAll();this._gpuSize=0;this.device.textures.push(this)};
        Object.defineProperty(e.prototype,"minFilter",{get:function(){return this._minFilter},set:function(a){this._minFilter!==a&&(this._minFilter=a,this._minFilterDirty=!0)}});Object.defineProperty(e.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){this._magFilter!==a&&(this._magFilter=a,this._magFilterDirty=!0)}});Object.defineProperty(e.prototype,"addressU",{get:function(){return this._addressU},set:function(a){this._addressU!==a&&(this._addressU=a,this._addressUDirty=!0)}});
        Object.defineProperty(e.prototype,"addressV",{get:function(){return this._addressV},set:function(a){this._addressV!==a&&(this._addressV=a,this._addressVDirty=!0)}});Object.defineProperty(e.prototype,"addressW",{get:function(){return this._addressW},set:function(a){this.device.webgl2&&(this._volume?a!==this._addressW&&(this._addressW=a,this._addressWDirty=!0):logWARNING("Can't set W addressing mode for a non-3D texture."))}});Object.defineProperty(e.prototype,"compareOnRead",{get:function(){return this._compareOnRead},
            set:function(a){this._compareOnRead!==a&&(this._compareOnRead=a,this._compareModeDirty=!0)}});Object.defineProperty(e.prototype,"compareFunc",{get:function(){return this._compareFunc},set:function(a){this._compareFunc!==a&&(this._compareFunc=a,this._compareModeDirty=!0)}});Object.defineProperty(e.prototype,"autoMipmap",{get:function(){return this._mipmaps},set:function(a){this._mipmaps=a}});Object.defineProperty(e.prototype,"mipmaps",{get:function(){return this._mipmaps},set:function(a){this._mipmaps!==
        a&&(this._mipmaps=a,this._minFilterDirty=!0,a&&(this._needsMipmapsUpload=!0))}});Object.defineProperty(e.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(a){this._anisotropy!==a&&(this._anisotropy=a,this._anisotropyDirty=!0)}});Object.defineProperty(e.prototype,"width",{get:function(){return this._width}});Object.defineProperty(e.prototype,"height",{get:function(){return this._height}});Object.defineProperty(e.prototype,"depth",{get:function(){return this._depth}});Object.defineProperty(e.prototype,
            "format",{get:function(){return this._format}});Object.defineProperty(e.prototype,"cubemap",{get:function(){return this._cubemap}});Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume}});Object.defineProperty(e.prototype,"flipY",{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._needsUpload=!0)}});pc.extend(e.prototype,{destroy:function(){var a=this.device,b=a.textures.indexOf(this);-1!==b&&a.textures.splice(b,1);this._glTextureId&&
        (this.device.gl.deleteTexture(this._glTextureId),this.device._vram.tex-=this._gpuSize,this._glTextureId=null)},dirtyAll:function(){this._glTextureId=void 0;this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0];this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps;this._mipmapsUploaded=!1;this._addressVDirty=this._addressUDirty=this._magFilterDirty=this._minFilterDirty=!0;this._addressWDirty=this._volume;this._compareModeDirty=this._anisotropyDirty=!0},lock:function(a){a=a||{level:0,face:0,
            mode:pc.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=
            new Uint16Array(this._width*this._height*this._depth);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[a.level]=
            new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case pc.PIXELFORMAT_RGB16F:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new Float32Array(this._width*this._height*this._depth*3);break;case pc.PIXELFORMAT_RGBA16F:this._levels[a.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=new Float32Array(this._width*
            this._height*this._depth*4)}return this._levels[a.level]},setSource:function(a){var b,c=!1,d,f;if(this._cubemap){if(a[0])for(d=a[0].width||0,f=a[0].height||0,b=0;6>b;b++){if(!a[b]||a[b].width!==d||a[b].height!==f||!(a[b]instanceof HTMLImageElement||a[b]instanceof HTMLCanvasElement||a[b]instanceof HTMLVideoElement)){c=!0;break}}else c=!0;if(!c)for(b=0;6>b;b++)this._levels[0][b]!==a[b]&&(this._levelsUpdated[0][b]=!0)}else a instanceof HTMLImageElement||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement||
        (c=!0),c||(a!==this._levels[0]&&(this._levelsUpdated[0]=!0),d=a.width,f=a.height);if(c)if(this._height=this._width=4,this._pot=!0,this._cubemap)for(b=0;6>b;b++)this._levels[0][b]=null,this._levelsUpdated[0][b]=!0;else this._levels[0]=null,this._levelsUpdated[0]=!0;else this._width=d,this._height=f,this._pot=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height),this._levels[0]=a;this._invalid===c&&c||(this._invalid=c,this.upload())},getSource:function(){return this._levels[0]},unlock:function(){logASSERT(-1!==
            this._lockedLevel,"Attempting to unlock a texture that is not locked");this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0;this._needsMipmapsUpload=this._mipmaps},getDds:function(){this.format!==pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");for(var a=128,b=0,c,d;this._levels[b];){if(this.cubemap)for(d=0;6>d;d++){if(!this._levels[b][d]){console.error("No level data for mip "+b+", face "+d);return}c=this._levels[b][d].length;if(!c){console.error("No byte array for mip "+
            b+", face "+d);return}a+=c}else{c=this._levels[b].length;if(!c){console.error("No byte array for mip "+b);return}a+=c}a+=this._levels[b].length;b++}a=new ArrayBuffer(a);d=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);c=4096;1<this._levels.length&&(c|=4194304);if(1<this._levels.length||this.cubemap)c|=8;var f=this.cubemap?65024:0;d[0]=542327876;d[1]=124;d[2]=b;d[3]=this.height;d[4]=this.width;d[5]=this.width*this.height*4;d[6]=0;d[7]=this._levels.length;for(b=0;11>b;b++)d[8+b]=
            0;d[19]=32;d[20]=65;d[21]=0;d[22]=32;d[23]=16711680;d[24]=65280;d[25]=255;d[26]=4278190080;d[27]=c;d[28]=f;d[29]=0;d[30]=0;d[31]=0;var f=128,g,k;if(this.cubemap)for(d=0;6>d;d++)for(b=0;b<this._levels.length;b++){g=this._levels[b][d];k=new Uint8Array(a,f,g.length);for(c=0;c<g.length;c++)k[c]=g[c];f+=g.length}else for(b=0;b<this._levels.length;b++){g=this._levels[b];k=new Uint8Array(a,f,g.length);for(c=0;c<g.length;c++)k[c]=g[c];f+=g.length}return a}});return{Texture:e}}());pc.extend(pc,function(){var e={depth:!0,face:0},a=function(a,c,d){a instanceof pc.GraphicsDevice?(this._colorBuffer=c,a=d):this._colorBuffer=a.colorBuffer;this._glDepthBuffer=this._glFrameBuffer=null;a=void 0!==a?a:e;this._depthBuffer=a.depthBuffer;this._face=void 0!==a.face?a.face:0;this._depthBuffer?(c=this._depthBuffer._format,c===pc.PIXELFORMAT_DEPTH?(this._depth=!0,this._stencil=!1):this._stencil=c===pc.PIXELFORMAT_DEPTHSTENCIL?this._depth=!0:this._depth=!1):(this._depth=void 0!==a.depth?a.depth:
        !0,this._stencil=void 0!==a.stencil?a.stencil:!1);this._samples=void 0!==a.samples?a.samples:1;this.autoResolve=void 0!==a.autoResolve?a.autoResolve:!0;this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};a.prototype={destroy:function(){if(this._device){var a=this._device,c=a.targets.indexOf(this);-1!==c&&a.targets.splice(c,1);a=a.gl;this._glFrameBuffer&&(a.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null);this._glDepthBuffer&&(a.deleteRenderbuffer(this._glDepthBuffer),
        this._glDepthBuffer=null);this._glResolveFrameBuffer&&(a.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null);this._glMsaaColorBuffer&&(a.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null);this._glMsaaDepthBuffer&&(a.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(a,c){if(this._device&&this._device.webgl2){var d=this._device.gl;void 0===a&&(a=!0);void 0===c&&this._depthBuffer&&(c=!0);d.bindFramebuffer(d.READ_FRAMEBUFFER,
        this._glFrameBuffer);d.bindFramebuffer(d.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer);d.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(a?d.COLOR_BUFFER_BIT:0)|(c?d.DEPTH_BUFFER_BIT:0),d.NEAREST);d.bindFramebuffer(d.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(a,c,d){if(!this._device)if(a._device)this._device=a._device;else return!1;return this._device.copyRenderTarget(a,this,c,d)}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});
        Object.defineProperty(a.prototype,"depthBuffer",{get:function(){return this._depthBuffer}});Object.defineProperty(a.prototype,"face",{get:function(){return this._face}});Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});return{RenderTarget:a}}());pc.extend(pc,function(){return{ShaderInput:function(e,a,b,c){this.locationId=c;this.scopeId=e.scope.resolve(a);this.version=new pc.Version;b===pc.UNIFORMTYPE_FLOAT&&"[0]"===a.substr(a.length-3)&&(b=pc.UNIFORMTYPE_FLOATARRAY);this.dataType=b;this.value=[null,null,null,null];this.array=[]}}}());pc.extend(pc,function(){function e(a){a=a.split("\n");for(var b=0,f=a.length;b<f;b++)a[b]=b+1+":\t"+a[b];return a.join("\n")}function a(a,b,f){b=a.createShader(b);a.shaderSource(b,f);a.compileShader(b);return b}var b=function(a,b){this.device=a;this.definition=b;this._refCount=0;this.compile();this.device.shaders.push(this)};b.prototype={compile:function(){this.ready=!1;var b=this.device.gl;this.vshader=a(b,b.VERTEX_SHADER,this.definition.vshader);this.fshader=a(b,b.FRAGMENT_SHADER,this.definition.fshader);
        var d=this.vshader,f=this.fshader,g=b.createProgram();b.attachShader(g,d);b.attachShader(g,f);this.program=g;this.device._shaderStats.vsCompiled++;this.device._shaderStats.fsCompiled++;this.device._shaderStats.linked++;this.definition.tag===pc.SHADERTAG_MATERIAL&&this.device._shaderStats.materialShaders++},link:function(){var a=this.device.gl,b=!0;if(this.device.webgl2&&this.definition.useTransformFeedback){var f=this.definition.attributes,g=[],k;for(k in f)f.hasOwnProperty(k)&&g.push("out_"+k);a.transformFeedbackVaryings(this.program,
        g,a.INTERLEAVED_ATTRIBS)}a.linkProgram(this.program);a.getShaderParameter(this.vshader,a.COMPILE_STATUS)||(logERROR("Failed to compile vertex shader:\n\n"+e(this.definition.vshader)+"\n\n"+a.getShaderInfoLog(this.vshader)),b=!1);a.getShaderParameter(this.fshader,a.COMPILE_STATUS)||(logERROR("Failed to compile fragment shader:\n\n"+e(this.definition.fshader)+"\n\n"+a.getShaderInfoLog(this.fshader)),b=!1);a.getProgramParameter(this.program,a.LINK_STATUS)||(logERROR("Failed to link shader program. Error: "+
        a.getProgramInfoLog(this.program)),b=!1);a.deleteShader(this.vshader);a.deleteShader(this.fshader);this.attributes=[];this.uniforms=[];this.samplers=[];var f=0,l={};l[a.BOOL]=pc.UNIFORMTYPE_BOOL;l[a.INT]=pc.UNIFORMTYPE_INT;l[a.FLOAT]=pc.UNIFORMTYPE_FLOAT;l[a.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;l[a.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;l[a.FLOAT_VEC4]=pc.UNIFORMTYPE_VEC4;l[a.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;l[a.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;l[a.INT_VEC4]=pc.UNIFORMTYPE_IVEC4;l[a.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;
        l[a.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;l[a.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;l[a.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;l[a.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;l[a.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;l[a.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;l[a.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;this.device.webgl2&&(l[a.SAMPLER_2D_SHADOW]=pc.UNIFORMTYPE_TEXTURE2D_SHADOW,l[a.SAMPLER_CUBE_SHADOW]=pc.UNIFORMTYPE_TEXTURECUBE_SHADOW,l[a.SAMPLER_3D]=pc.UNIFORMTYPE_TEXTURE3D);for(var m=a.getProgramParameter(this.program,a.ACTIVE_ATTRIBUTES);f<
        m;)g=a.getActiveAttrib(this.program,f++),k=a.getAttribLocation(this.program,g.name),void 0===this.definition.attributes[g.name]&&console.error('Vertex shader attribute "'+g.name+'" is not mapped to a semantic in shader definition.'),this.attributes.push(new pc.ShaderInput(this.device,this.definition.attributes[g.name],l[g.type],k));f=0;for(m=a.getProgramParameter(this.program,a.ACTIVE_UNIFORMS);f<m;)g=a.getActiveUniform(this.program,f++),k=a.getUniformLocation(this.program,g.name),g.type===a.SAMPLER_2D||
        g.type===a.SAMPLER_CUBE||this.device.webgl2&&(g.type===a.SAMPLER_2D_SHADOW||g.type===a.SAMPLER_CUBE_SHADOW||g.type===a.SAMPLER_3D)?this.samplers.push(new pc.ShaderInput(this.device,g.name,l[g.type],k)):this.uniforms.push(new pc.ShaderInput(this.device,g.name,l[g.type],k));this.ready=!0;return b},destroy:function(){var a=this.device,b=a.shaders.indexOf(this);-1!==b&&a.shaders.splice(b,1);this.program&&(a.gl.deleteProgram(this.program),this.program=null,this.device.removeShaderFromCache(this))}};return{Shader:b}}());pc.extend(pc,function(){var e=function(a){this._device=a;this._cache={};this._generators={};this._isClearingCache=!1};e.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};e.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};e.prototype.isRegistered=function(a){return void 0!==this._generators[a]};e.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return logERROR("No program library functions registered for: "+a),
        null;var d=this._device,f=c.generateKey(d,b),g=this._cache[f];g||(c=c.createShaderDefinition(d,b),g=this._cache[f]=new pc.Shader(d,c));return g};e.prototype.clearCache=function(){var a=this._cache;this._isClearingCache=!0;for(var b in a)a.hasOwnProperty(b)&&a[b].destroy();this._cache={};this._isClearingCache=!1};e.prototype.removeFromCache=function(a){if(!this._isClearingCache){var b=this._cache,c;for(c in b)if(b.hasOwnProperty(c)&&b[c]===a){delete b[c];break}}};return{ProgramLibrary:e}}());pc.extend(pc,function(){function e(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}function b(a,b){var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE);a.texImage2D(a.TEXTURE_2D,
        0,a.RGBA,2,2,0,a.RGBA,b,null);var d=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,d);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0);a.bindTexture(a.TEXTURE_2D,null);if(a.checkFramebufferStatus(a.FRAMEBUFFER)!=a.FRAMEBUFFER_COMPLETE)return a.deleteTexture(c),!1;a.deleteTexture(c);a.bindFramebuffer(a.FRAMEBUFFER,null);return!0}function c(a){var b=new ArrayBuffer(16),c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);a.bufferData(a.ARRAY_BUFFER,b,a.STATIC_DRAW);a.getError();
        a.vertexAttribPointer(0,4,a.UNSIGNED_BYTE,!1,4,0);b=0===a.getError();a.deleteBuffer(c);return b}e.prototype=Error.prototype;a.prototype=Error.prototype;var d=function(a,b){var c=a.width,d=a.height;if(c>b||d>b){var f=b/Math.max(c,d),g=Math.floor(c*f),f=Math.floor(d*f);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+c+", "+d+" to "+g+", "+f+".");var e=document.createElement("canvas");e.width=g;e.height=f;e.getContext("2d").drawImage(a,0,0,c,d,0,0,g,f);
        return e}return a},f=null,g=function(a,d){var f;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.vbOffsets=[];this._enableAutoInstancing=!1;this.autoInstancingMaxObjects=16384;this.attributesInvalidated=!0;this.boundBuffer=null;this.instancedAttribs={};this.enabledAttributes={};this.activeFramebuffer=this.transformFeedbackBuffer=null;this.activeTexture=0;this.textureUnits=[];this._maxPixelRatio=1;this.feedback=this.renderTarget=null;this._height=this._width=0;this.updateClientRect();
        if(!window.WebGLRenderingContext)throw new pc.UnsupportedBrowserError;this.shaders=[];this.buffers=[];this.textures=[];this.targets=[];this.contextLost=!1;a.addEventListener("webglcontextlost",function(a){a.preventDefault();this.contextLost=!0;this.fire("devicelost")}.bind(this),!1);a.addEventListener("webglcontextrestored",function(){this.initializeContext();this.contextLost=!1;this.fire("devicerestored")}.bind(this),!1);var g=d&&void 0!==d.preferWebGl2?d.preferWebGl2:!0,h=g?["webgl2","experimental-webgl2",
            "webgl","experimental-webgl"]:["webgl","experimental-webgl"],e=null;d=d||{};d.stencil=!0;for(f=0;f<h.length;f++){try{e=a.getContext(h[f],d)}catch(p){}if(e){this.webgl2=g&&2>f;break}}if(!e)throw new pc.ContextCreationError;this.gl=e;this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();(function(){this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[e.REPEAT,e.CLAMP_TO_EDGE,e.MIRRORED_REPEAT];this.glBlendEquation=
            [e.FUNC_ADD,e.FUNC_SUBTRACT,e.FUNC_REVERSE_SUBTRACT,this.webgl2?e.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:e.FUNC_ADD,this.webgl2?e.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:e.FUNC_ADD];this.glBlendFunction=[e.ZERO,e.ONE,e.SRC_COLOR,e.ONE_MINUS_SRC_COLOR,e.DST_COLOR,e.ONE_MINUS_DST_COLOR,e.SRC_ALPHA,e.SRC_ALPHA_SATURATE,e.ONE_MINUS_SRC_ALPHA,e.DST_ALPHA,e.ONE_MINUS_DST_ALPHA];this.glComparison=[e.NEVER,e.LESS,e.EQUAL,e.LEQUAL,e.GREATER,e.NOTEQUAL,e.GEQUAL,e.ALWAYS];this.glStencilOp=
            [e.KEEP,e.ZERO,e.REPLACE,e.INCR,e.INCR_WRAP,e.DECR,e.DECR_WRAP,e.INVERT];this.glClearFlag=[0,e.COLOR_BUFFER_BIT,e.DEPTH_BUFFER_BIT,e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT,e.STENCIL_BUFFER_BIT,e.STENCIL_BUFFER_BIT|e.COLOR_BUFFER_BIT,e.STENCIL_BUFFER_BIT|e.DEPTH_BUFFER_BIT,e.STENCIL_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT];this.glCull=[0,e.BACK,e.FRONT,e.FRONT_AND_BACK];this.glFilter=[e.NEAREST,e.LINEAR,e.NEAREST_MIPMAP_NEAREST,e.NEAREST_MIPMAP_LINEAR,e.LINEAR_MIPMAP_NEAREST,e.LINEAR_MIPMAP_LINEAR];
            this.glPrimitive=[e.POINTS,e.LINES,e.LINE_LOOP,e.LINE_STRIP,e.TRIANGLES,e.TRIANGLE_STRIP,e.TRIANGLE_FAN];this.glType=[e.BYTE,e.UNSIGNED_BYTE,e.SHORT,e.UNSIGNED_SHORT,e.INT,e.UNSIGNED_INT,e.FLOAT];var a,d,k,g,l;this.commitFunction=[];this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){a.value!==b&&(e.uniform1i(a.locationId,b),a.value=b)};this.commitFunction[pc.UNIFORMTYPE_INT]=this.commitFunction[pc.UNIFORMTYPE_BOOL];this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(a,b){a.value!==b&&(e.uniform1f(a.locationId,
                b),a.value=b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(b,c){l=b.value;a=c[0];d=c[1];if(l[0]!==a||l[1]!==d)e.uniform2fv(b.locationId,c),l[0]=a,l[1]=d};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(b,c){l=b.value;a=c[0];d=c[1];k=c[2];if(l[0]!==a||l[1]!==d||l[2]!==k)e.uniform3fv(b.locationId,c),l[0]=a,l[1]=d,l[2]=k};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(b,c){l=b.value;a=c[0];d=c[1];k=c[2];g=c[3];if(l[0]!==a||l[1]!==d||l[2]!==k||l[3]!==g)e.uniform4fv(b.locationId,c),l[0]=a,l[1]=
                d,l[2]=k,l[3]=g};this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(b,c){l=b.value;a=c[0];d=c[1];if(l[0]!==a||l[1]!==d)e.uniform2iv(b.locationId,c),l[0]=a,l[1]=d};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=this.commitFunction[pc.UNIFORMTYPE_IVEC2];this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(b,c){l=b.value;a=c[0];d=c[1];k=c[2];if(l[0]!==a||l[1]!==d||l[2]!==k)e.uniform3iv(b.locationId,c),l[0]=a,l[1]=d,l[2]=k};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=this.commitFunction[pc.UNIFORMTYPE_IVEC3];
            this.commitFunction[pc.UNIFORMTYPE_IVEC4]=function(b,c){l=b.value;a=c[0];d=c[1];k=c[2];g=c[3];if(l[0]!==a||l[1]!==d||l[2]!==k||l[3]!==g)e.uniform4iv(b.locationId,c),l[0]=a,l[1]=d,l[2]=k,l[3]=g};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=this.commitFunction[pc.UNIFORMTYPE_IVEC4];this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,b){e.uniformMatrix2fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(a,b){e.uniformMatrix3fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=
                function(a,b){e.uniformMatrix4fv(a.locationId,!1,b)};this.commitFunction[pc.UNIFORMTYPE_FLOATARRAY]=function(a,b){e.uniform1fv(a.locationId,b)};this.scope=new pc.ScopeSpace("Device");this.programLib=new pc.ProgramLibrary(this);for(var h in pc.programlib)this.programLib.register(h,pc.programlib[h]);pc.events.attach(this);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.useTexCubeLod=this.extTextureLod&&16>this.samplerCount;h=this.vertexUniformsCount;h=h-16-8;--h;h-=16;
            this.boneLimit=Math.floor(h/4);this.boneLimit=Math.min(this.boneLimit,128);"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34);"Apple A8 GPU"===this.unmaskedRenderer&&(this.forceCpuParticles=!0);this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0;this._primsPerFrame=[];for(f=pc.PRIMITIVE_POINTS;f<=pc.PRIMITIVE_TRIFAN;f++)this._primsPerFrame[f]=0;this._renderTargetCreationTime=0;this._vram={tex:0,vb:0,ib:0};this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0};
            this.supportsUnsignedByte=c(e);this.constantTexSource=this.scope.resolve("source");if(pc._benchmarked)this.extTextureFloatRenderable=pc.extTextureFloatRenderable,this.extTextureHalfFloatRenderable=pc.extTextureHalfFloatRenderable,this.extTextureFloatHighPrecision=pc.extTextureFloatHighPrecision;else{this.extTextureFloat&&(this.extTextureFloatRenderable=this.webgl2?this.extColorBufferFloat:b(e,e.FLOAT));this.extTextureHalfFloat&&(this.extTextureHalfFloatRenderable=this.webgl2?this.extColorBufferFloat:
                b(e,this.extTextureHalfFloat.HALF_FLOAT_OES));if(this.extTextureFloatRenderable){h=pc.shaderChunks;var n=h.createShaderFromCode(this,h.fullscreenQuadVS,h.precisionTestPS,"ptest1"),v=h.createShaderFromCode(this,h.fullscreenQuadVS,h.precisionTest2PS,"ptest2");h=new pc.Texture(this,{format:pc.PIXELFORMAT_RGBA32F,width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST});var z=new pc.RenderTarget(this,h,{depth:!1});pc.drawQuadWithShader(this,z,n);var n=new pc.Texture(this,{format:pc.PIXELFORMAT_R8_G8_B8_A8,
                width:1,height:1,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),A=new pc.RenderTarget(this,n,{depth:!1});this.constantTexSource.setValue(h);pc.drawQuadWithShader(this,A,v);v=new Uint8Array(4);e.bindFramebuffer(e.FRAMEBUFFER,A._glFrameBuffer);e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,v);this.extTextureFloatHighPrecision=0===v[0]/255/16777216+v[1]/255/65536+v[2]/255/256+v[3]/255;h.destroy();z.destroy();n.destroy();A.destroy();pc.destroyPostEffectQuad();e.bindFramebuffer(e.FRAMEBUFFER,
                null)}pc.extTextureFloatRenderable=this.extTextureFloatRenderable;pc.extTextureHalfFloatRenderable=this.extTextureHalfFloatRenderable;pc.extTextureFloatHighPrecision=this.extTextureFloatHighPrecision;pc._benchmarked=!0}}).call(this)};g.prototype={getPrecision:function(){var a=this.gl,b="highp";if(a.getShaderPrecisionFormat){var c=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.HIGH_FLOAT),d=a.getShaderPrecisionFormat(a.VERTEX_SHADER,a.MEDIUM_FLOAT),f=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT),
        a=a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT),d=0<d.precision&&0<a.precision;0<c.precision&&0<f.precision||(b=d?"mediump":"lowp")}return b},initializeExtensions:function(){var a=this.gl;this.webgl2?this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0:(this.extBlendMinmax=a.getExtension("EXT_blend_minmax"),this.extDrawBuffers=a.getExtension("EXT_draw_buffers"),
        this.extInstancing=a.getExtension("ANGLE_instanced_arrays"),this.extStandardDerivatives=a.getExtension("OES_standard_derivatives"),this.extTextureFloat=a.getExtension("OES_texture_float"),this.extTextureHalfFloat=a.getExtension("OES_texture_half_float"),this.extTextureHalfFloatLinear=a.getExtension("OES_texture_half_float_linear"),this.extTextureLod=a.getExtension("EXT_shader_texture_lod"),this.extUintElement=a.getExtension("OES_element_index_uint"));this.extRendererInfo=a.getExtension("WEBGL_debug_renderer_info");
        this.extTextureFloatLinear=a.getExtension("OES_texture_float_linear");this.extColorBufferFloat=a.getExtension("EXT_color_buffer_float");this.extTextureFilterAnisotropic=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic");this.extCompressedTextureETC1=a.getExtension("WEBGL_compressed_texture_etc1");this.extCompressedTexturePVRTC=a.getExtension("WEBGL_compressed_texture_pvrtc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");if(a=this.extCompressedTextureS3TC=
                a.getExtension("WEBGL_compressed_texture_s3tc")||a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"))var a=window.navigator.userAgent.indexOf("MSIE "),b=navigator.userAgent.match(/Trident.*rv:11\./),a=0<a||!!b;a&&(this.extCompressedTextureS3TC=null)},initializeCapabilities:function(){var a=this.gl;this.maxPrecision=this.precision=this.getPrecision();var b=a.getContextAttributes();this.supportsMsaa=b.antialias;this.supportsStencil=b.stencil;this.maxTextureSize=a.getParameter(a.MAX_TEXTURE_SIZE);
        this.maxCubeMapSize=a.getParameter(a.MAX_CUBE_MAP_TEXTURE_SIZE);this.maxRenderBufferSize=a.getParameter(a.MAX_RENDERBUFFER_SIZE);this.samplerCount=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS);this.maxVertexTextures=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.vertexUniformsCount=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS);this.fragmentUniformsCount=a.getParameter(a.MAX_FRAGMENT_UNIFORM_VECTORS);this.unmaskedRenderer=this.extRendererInfo?a.getParameter(this.extRendererInfo.UNMASKED_RENDERER_WEBGL):
            "";this.unmaskedVendor=this.extRendererInfo?a.getParameter(this.extRendererInfo.UNMASKED_VENDOR_WEBGL):"";this.webgl2?(this.maxDrawBuffers=a.getParameter(a.MAX_DRAW_BUFFERS),this.maxColorAttachments=a.getParameter(a.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=a.getParameter(a.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=this.extDrawBuffers?a.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=this.extDrawBuffers?a.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT):
            1,this.maxVolumeSize=1)},initializeRenderState:function(){var a=this.gl;this.blending=!1;a.disable(a.BLEND);this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendSrcAlpha=pc.BLENDMODE_ONE;this.blendDstAlpha=pc.BLENDMODE_ZERO;this.separateAlphaBlend=!1;this.blendAlphaEquation=this.blendEquation=pc.BLENDEQUATION_ADD;this.separateAlphaEquation=!1;a.blendFunc(a.ONE,a.ZERO);a.blendEquation(a.FUNC_ADD);this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0;a.colorMask(!0,!0,
        !0,!0);this.cullMode=pc.CULLFACE_BACK;a.enable(a.CULL_FACE);a.cullFace(a.BACK);this.depthTest=!0;a.enable(a.DEPTH_TEST);this.depthFunc=pc.FUNC_LESSEQUAL;a.depthFunc(a.LEQUAL);this.depthWrite=!0;a.depthMask(!0);this.stencil=!1;a.disable(a.STENCIL_TEST);this.stencilFuncFront=this.stencilFuncBack=pc.FUNC_ALWAYS;this.stencilRefFront=this.stencilRefBack=0;this.stencilMaskFront=this.stencilMaskBack=255;a.stencilFunc(a.ALWAYS,0,255);this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=
        this.stencilFailFront=this.stencilFailBack=pc.STENCILOP_KEEP;this.stencilWriteMaskBack=this.stencilWriteMaskFront=255;a.stencilOp(a.KEEP,a.KEEP,a.KEEP);a.stencilMask(255);this.alphaToCoverage=!1;this.webgl2&&(a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.disable(a.RASTERIZER_DISCARD));this.raster=!0;this.depthBiasEnabled=!1;a.disable(a.POLYGON_OFFSET_FILL);this.clearDepth=1;a.clearDepth(1);this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0;a.clearColor(0,0,0,0);this.clearStencil=0;a.clearStencil(0);
        this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0;this.webgl2?a.hint(a.FRAGMENT_SHADER_DERIVATIVE_HINT,a.NICEST):this.extStandardDerivatives&&a.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,a.NICEST);a.enable(a.SCISSOR_TEST);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.NONE)},initializeContext:function(){this.initializeExtensions();this.initializeCapabilities();this.initializeRenderState();var a,b;a=0;for(b=this.shaders.length;a<b;a++)this.shaders[a].compile();
        this.shader=null;a=0;for(b=this.buffers.length;a<b;a++)this.buffers[a].bufferId=void 0,this.buffers[a].unlock();this.indexBuffer=this.boundBuffer=null;this.attributesInvalidated=!0;this.enabledAttributes={};this.vertexBuffers=[];a=0;for(b=this.textures.length;a<b;a++)this.textures[a].dirtyAll();this.activeTexture=0;this.textureUnits=[];a=0;for(b=this.targets.length;a<b;a++)this.targets[a]._glFrameBuffer=void 0,this.targets[a]._glDepthBuffer=void 0,this.targets[a]._glResolveFrameBuffer=void 0,this.targets[a]._glMsaaColorBuffer=
            void 0,this.targets[a]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(a,b,c,d){if(this.vx!==a||this.vy!==b||this.vw!==c||this.vh!==d)this.gl.viewport(a,b,c,d),this.vx=a,this.vy=b,this.vw=c,this.vh=d},setScissor:function(a,b,c,d){if(this.sx!==a||this.sy!==b||this.sw!==c||this.sh!==d)this.gl.scissor(a,b,c,d),this.sx=a,this.sy=b,this.sw=
        c,this.sh=d},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},setFramebuffer:function(a){this.activeFramebuffer!==a&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,a),this.activeFramebuffer=a)},_checkFbo:function(){var a=this.gl;switch(a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
        break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(a,b,c,d){var f=this.gl;if(!this.webgl2&&d)return!1;if(c)if(!b){if(!a._colorBuffer)return!1}else if(!a._colorBuffer||!b._colorBuffer||a._colorBuffer._format!==b._colorBuffer._format)return!1;if(d&&(!a._depthBuffer||!b._depthBuffer||a._depthBuffer._format!==b._depthBuffer._format))return!1;
        if(this.webgl2&&b){var g=this.renderTarget;this.renderTarget=b;this.updateBegin();f.bindFramebuffer(f.READ_FRAMEBUFFER,a?a._glFrameBuffer:null);f.bindFramebuffer(f.DRAW_FRAMEBUFFER,b._glFrameBuffer);var e=a?a.width:b.width;a=a?a.height:b.height;f.blitFramebuffer(0,0,e,a,0,0,e,a,(c?f.COLOR_BUFFER_BIT:0)|(d?f.DEPTH_BUFFER_BIT:0),f.NEAREST);this.renderTarget=g;f.bindFramebuffer(f.FRAMEBUFFER,g?g._glFrameBuffer:null)}else this._copyShader||(c=pc.shaderChunks,this._copyShader=c.createShaderFromCode(this,
            c.fullscreenQuadVS,c.outputTex2DPS,"outputTex2D")),this.constantTexSource.setValue(a._colorBuffer),pc.drawQuadWithShader(this,b,this._copyShader);return!0},updateBegin:function(){var a=this.gl;this.indexBuffer=this.boundBuffer=null;var b=this.renderTarget;if(b)if(b._glFrameBuffer)this.setFramebuffer(b._glFrameBuffer);else{b._device=this;b._glFrameBuffer=a.createFramebuffer();this.setFramebuffer(b._glFrameBuffer);var c=b._colorBuffer;c&&(c._glTextureId||(c._width=Math.min(c.width,this.maxRenderBufferSize),
        c._height=Math.min(c.height,this.maxRenderBufferSize),this.setTexture(c,0)),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,c._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:a.TEXTURE_2D,c._glTextureId,0));var d=b._depthBuffer;d&&this.webgl2?(d._glTextureId||(d._width=Math.min(d.width,this.maxRenderBufferSize),d._height=Math.min(d.height,this.maxRenderBufferSize),this.setTexture(d,0)),b._stencil?a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,d._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+
        b._face:a.TEXTURE_2D,b._depthBuffer._glTextureId,0):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,d._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:a.TEXTURE_2D,b._depthBuffer._glTextureId,0)):!b._depth||1<b._samples&&this.webgl2||(b._glDepthBuffer||(b._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glDepthBuffer),b._stencil?(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_STENCIL,b.width,b.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,
        a.RENDERBUFFER,b._glDepthBuffer)):(a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glDepthBuffer)),a.bindRenderbuffer(a.RENDERBUFFER,null));this.webgl2&&1<b._samples&&(b._glResolveFrameBuffer=b._glFrameBuffer,b._glFrameBuffer=a.createFramebuffer(),this.setFramebuffer(b._glFrameBuffer),c&&(b._glMsaaColorBuffer||(b._glMsaaColorBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glMsaaColorBuffer),
        a.renderbufferStorageMultisample(a.RENDERBUFFER,b._samples,c._glInternalFormat,b.width,b.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,b._glMsaaColorBuffer)),b._depth&&(b._glMsaaDepthBuffer||(b._glMsaaDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glMsaaDepthBuffer),b._stencil?(a.renderbufferStorageMultisample(a.RENDERBUFFER,b._samples,a.DEPTH24_STENCIL8,b.width,b.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_STENCIL_ATTACHMENT,
        a.RENDERBUFFER,b._glMsaaDepthBuffer)):(a.renderbufferStorageMultisample(a.RENDERBUFFER,b._samples,a.DEPTH_COMPONENT32F,b.width,b.height),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glMsaaDepthBuffer))));this.targets.push(b)}else this.setFramebuffer(null);for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){var a=this.gl,b=this.renderTarget;if(b){var c=b._colorBuffer;c&&c._glTextureId&&c.mipmaps&&c._pot&&(a.bindTexture(c._glTarget,c._glTextureId),a.generateMipmap(c._glTarget));
        this.webgl2&&1<b._samples&&b.autoResolve&&b.resolve()}},initializeTexture:function(a){var b=this.gl,c;a._glTextureId=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:a._volume?b.TEXTURE_3D:b.TEXTURE_2D;switch(a._format){case pc.PIXELFORMAT_A8:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;
        a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=
        this.webgl2?b.RGB8:b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA8:b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:c=this.extCompressedTextureS3TC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:c=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:c=this.extCompressedTextureS3TC;
        a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_ETC1:c=this.extCompressedTextureETC1;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_ETC1_WEBGL;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;
        case pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGB;a._glInternalFormat=c.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1:c=this.extCompressedTexturePVRTC;a._glFormat=b.RGBA;a._glInternalFormat=c.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case pc.PIXELFORMAT_RGB16F:c=this.extTextureHalfFloat;a._glFormat=b.RGB;this.webgl2?(a._glInternalFormat=b.RGB16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGB,a._glPixelType=c.HALF_FLOAT_OES);
            break;case pc.PIXELFORMAT_RGBA16F:c=this.extTextureHalfFloat;a._glFormat=b.RGBA;this.webgl2?(a._glInternalFormat=b.RGBA16F,a._glPixelType=b.HALF_FLOAT):(a._glInternalFormat=b.RGBA,a._glPixelType=c.HALF_FLOAT_OES);break;case pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=this.webgl2?b.RGB32F:b.RGB;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA;a._glInternalFormat=this.webgl2?b.RGBA32F:b.RGBA;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_R32F:a._glFormat=
            b.RED;a._glInternalFormat=b.R32F;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_DEPTH:this.webgl2?(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT32F,a._glPixelType=b.FLOAT):(a._glFormat=b.DEPTH_COMPONENT,a._glInternalFormat=b.DEPTH_COMPONENT,a._glPixelType=b.UNSIGNED_SHORT);break;case pc.PIXELFORMAT_DEPTHSTENCIL:a._glFormat=b.DEPTH_STENCIL;a._glInternalFormat=b.DEPTH24_STENCIL8;a._glPixelType=b.UNSIGNED_INT_24_8;break;case pc.PIXELFORMAT_111110F:a._glFormat=b.RGB;a._glInternalFormat=
            b.R11F_G11F_B10F;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_SRGB:a._glFormat=b.RGB;a._glInternalFormat=b.SRGB8;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_SRGBA:a._glFormat=b.RGBA,a._glInternalFormat=b.SRGB8_ALPHA8,a._glPixelType=b.UNSIGNED_BYTE}},uploadTexture:function(a){var b=this.gl;if(a._needsUpload||!(a._needsMipmapsUpload&&a._mipmapsUploaded||!a._pot)){for(var c=0,g,e;a._levels[c]||0===c;){if(a._needsUpload||0!==c){if(c&&(!a._needsMipmapsUpload||!a._mipmaps))break;g=a._levels[c];
        1!=c||a._compressed||(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);if(a._cubemap){var r;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(g[0]instanceof HTMLCanvasElement||g[0]instanceof HTMLImageElement||g[0]instanceof HTMLVideoElement)for(r=0;6>r;r++)a._levelsUpdated[0][r]&&(e=g[r],e instanceof HTMLImageElement&&(e.width>this.maxCubeMapSize||e.height>this.maxCubeMapSize)&&(e=d(e,this.maxCubeMapSize),0===c&&(a.width=e.width,a.height=e.height)),
            b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+r,c,a._glInternalFormat,a._glFormat,a._glPixelType,e));else for(e=1/Math.pow(2,c),r=0;6>r;r++)if(a._levelsUpdated[0][r]){var p=g[r];a._compressed?b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+r,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,p):b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+r,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,p)}}else a._volume?(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,
            !1),e=1/Math.pow(2,c),a._compressed?b.compressedTexImage3D(b.TEXTURE_3D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,g):b.texImage3D(b.TEXTURE_3D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),Math.max(a._depth*e,1),0,a._glFormat,a._glPixelType,g)):(g instanceof HTMLCanvasElement||g instanceof HTMLImageElement||g instanceof HTMLVideoElement?(g instanceof HTMLImageElement&&(g.width>this.maxTextureSize||g.height>this.maxTextureSize)&&
        (g=d(g,this.maxTextureSize),0===c&&(a.width=g.width,a.height=g.height)),b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,a._flipY),b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._glFormat,a._glPixelType,g)):(b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),e=1/Math.pow(2,c),a._compressed?b.compressedTexImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*e,1),Math.max(a._height*e,1),0,g):b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*e,1),
            Math.max(a._height*e,1),0,a._glFormat,a._glPixelType,g)),a._mipmapsUploaded=0===c?!1:!0)}c++}if(a._needsUpload)if(a._cubemap)for(c=0;6>c;c++)a._levelsUpdated[0][c]=!1;else a._levelsUpdated[0]=!1;!a._compressed&&a._mipmaps&&a._needsMipmapsUpload&&a._pot&&1===a._levels.length&&(b.generateMipmap(a._glTarget),a._mipmapsUploaded=!0);a._gpuSize&&(this._vram.tex-=a._gpuSize);f||(f={},f[pc.PIXELFORMAT_A8]=1,f[pc.PIXELFORMAT_L8]=1,f[pc.PIXELFORMAT_L8_A8]=1,f[pc.PIXELFORMAT_R5_G6_B5]=2,f[pc.PIXELFORMAT_R5_G5_B5_A1]=
        2,f[pc.PIXELFORMAT_R4_G4_B4_A4]=2,f[pc.PIXELFORMAT_R8_G8_B8]=4,f[pc.PIXELFORMAT_R8_G8_B8_A8]=4,f[pc.PIXELFORMAT_RGB16F]=8,f[pc.PIXELFORMAT_RGBA16F]=8,f[pc.PIXELFORMAT_RGB32F]=16,f[pc.PIXELFORMAT_RGBA32F]=16,f[pc.PIXELFORMAT_R32F]=4,f[pc.PIXELFORMAT_DEPTH]=4,f[pc.PIXELFORMAT_DEPTHSTENCIL]=4,f[pc.PIXELFORMAT_111110F]=4,f[pc.PIXELFORMAT_SRGB]=4,f[pc.PIXELFORMAT_SRGBA]=4);b=1;!a._pot||!a._mipmaps&&a._minFilter!==pc.FILTER_NEAREST_MIPMAP_NEAREST&&a._minFilter!==pc.FILTER_NEAREST_MIPMAP_LINEAR&&a._minFilter!==
    pc.FILTER_LINEAR_MIPMAP_NEAREST&&a._minFilter!==pc.FILTER_LINEAR_MIPMAP_LINEAR||a._compressed&&1===a._levels.length||(b=Math.round(Math.log2(Math.max(a._width,a._height))+1));c=a._width;g=a._height;r=a._depth;for(p=e=0;p<b;p++)e=a._compressed?a._format===pc.PIXELFORMAT_ETC1?e+Math.floor((c+3)/4)*Math.floor((g+3)/4)*8*r:a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGB_1||a._format===pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1?e+Math.max(c,16)*Math.max(g,8)/4*r:a._format===pc.PIXELFORMAT_PVRTC_4BPP_RGB_1||a._format===
    pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1?e+Math.max(c,8)*Math.max(g,8)/2*r:e+Math.floor((c+4-1)/4)*Math.floor((g+4-1)/4)*(a._format===pc.PIXELFORMAT_DXT1?8:16)*r:e+c*g*r*f[a._format],c=Math.max(.5*c,1),g=Math.max(.5*g,1),r=Math.max(.5*r,1);a._cubemap&&(e*=6);a._gpuSize=e;this._vram.tex+=a._gpuSize}},setTexture:function(a,b){var c=this.gl;a._glTextureId||this.initializeTexture(a);var d=a._minFilterDirty||a._magFilterDirty||a._addressUDirty||a._addressVDirty||a._addressWDirty||a._anisotropyDirty||a._compareModeDirty;
        if(this.textureUnits[b]!==a||d)this.activeTexture!==b&&(c.activeTexture(c.TEXTURE0+b),this.activeTexture=b),c.bindTexture(a._glTarget,a._glTextureId),this.textureUnits[b]=a;if(d){if(a._minFilterDirty){d=a._minFilter;if(!a._pot||!a._mipmaps||a._compressed&&1===a._levels.length)if(d===pc.FILTER_NEAREST_MIPMAP_NEAREST||d===pc.FILTER_NEAREST_MIPMAP_LINEAR)d=pc.FILTER_NEAREST;else if(d===pc.FILTER_LINEAR_MIPMAP_NEAREST||d===pc.FILTER_LINEAR_MIPMAP_LINEAR)d=pc.FILTER_LINEAR;c.texParameteri(a._glTarget,
            c.TEXTURE_MIN_FILTER,this.glFilter[d]);a._minFilterDirty=!1}a._magFilterDirty&&(c.texParameteri(a._glTarget,c.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]),a._magFilterDirty=!1);a._addressUDirty&&(this.webgl2?c.texParameteri(a._glTarget,c.TEXTURE_WRAP_S,this.glAddress[a._addressU]):c.texParameteri(a._glTarget,c.TEXTURE_WRAP_S,this.glAddress[a._pot?a._addressU:pc.ADDRESS_CLAMP_TO_EDGE]),a._addressUDirty=!1);a._addressVDirty&&(this.webgl2?c.texParameteri(a._glTarget,c.TEXTURE_WRAP_T,this.glAddress[a._addressV]):
            c.texParameteri(a._glTarget,c.TEXTURE_WRAP_T,this.glAddress[a._pot?a._addressV:pc.ADDRESS_CLAMP_TO_EDGE]),a._addressVDirty=!1);this.webgl2&&(a._addressWDirty&&(c.texParameteri(a._glTarget,c.TEXTURE_WRAP_R,this.glAddress[a._addressW]),a._addressWDirty=!1),a._compareModeDirty&&(c.texParameteri(a._glTarget,c.TEXTURE_COMPARE_MODE,a._compareOnRead?c.COMPARE_REF_TO_TEXTURE:c.NONE),c.texParameteri(a._glTarget,c.TEXTURE_COMPARE_FUNC,this.glComparison[a._compareFunc]),a._compareModeDirty=!1));a._anisotropyDirty&&
        ((d=this.extTextureFilterAnisotropic)&&c.texParameterf(a._glTarget,d.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(a._anisotropy),this.maxAnisotropy))),a._anisotropyDirty=!1)}if(a._needsUpload||a._needsMipmapsUpload)this.uploadTexture(a),a._needsUpload=!1,a._needsMipmapsUpload=!1},draw:function(a,b){var c=this.gl,d,f,g,e,q,t,x,y;d=this.shader;y=d.samplers;var w=d.uniforms;1<b&&(this.boundBuffer=null,this.attributesInvalidated=!0);if(this.attributesInvalidated){q=d.attributes;d=0;for(g=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                q.length;d<g;d++)t=q[d],f=t.scopeId.value,null!==f&&(x=this.vertexBuffers[f.stream],e=this.vbOffsets[f.stream]||0,x=x.bufferId,this.boundBuffer!==x&&(c.bindBuffer(c.ARRAY_BUFFER,x),this.boundBuffer=x),t=t.locationId,this.enabledAttributes[t]||(c.enableVertexAttribArray(t),this.enabledAttributes[t]=!0),c.vertexAttribPointer(t,f.numComponents,this.glType[f.dataType],f.normalize,f.stride,f.offset+e),1===f.stream&&1<b?this.instancedAttribs[t]||(this.extInstancing.vertexAttribDivisorANGLE(t,1),this.instancedAttribs[t]=
        !0):this.instancedAttribs[t]&&(this.extInstancing.vertexAttribDivisorANGLE(t,0),this.instancedAttribs[t]=!1));this.attributesInvalidated=!1}var u=0;d=0;for(g=y.length;d<g;d++)if(e=y[d],q=e.scopeId.value)if(q instanceof pc.Texture)t=q,this.setTexture(t,u),e.slot!==u&&(c.uniform1i(e.locationId,u),e.slot=u),u++;else{e.array.length=0;x=q.length;for(f=0;f<x;f++)t=q[f],this.setTexture(t,u),e.array[f]=u,u++;c.uniform1iv(e.locationId,e.array)}d=0;for(g=w.length;d<g;d++)if(y=w[d],f=y.scopeId,e=y.version,q=
            f.versionObject.version,e.globalId!==q.globalId||e.revision!==q.revision)if(e.globalId=q.globalId,e.revision=q.revision,null!==f.value)this.commitFunction[y.dataType](y,f.value);this._drawCallsPerFrame++;this._primsPerFrame[a.type]+=a.count*(1<b?b:1);this.webgl2&&this.transformFeedbackBuffer&&(c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),c.beginTransformFeedback(c.POINTS));a.indexed?1<b?(this.extInstancing.drawElementsInstancedANGLE(this.glPrimitive[a.type],
        a.count,this.indexBuffer.glFormat,2*a.base,b),this.boundBuffer=null,this.attributesInvalidated=!0):c.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,a.base*this.indexBuffer.bytesPerIndex):1<b?(this.extInstancing.drawArraysInstancedANGLE(this.glPrimitive[a.type],a.base,a.count,b),this.boundBuffer=null,this.attributesInvalidated=!0):c.drawArrays(this.glPrimitive[a.type],a.base,a.count);this.webgl2&&this.transformFeedbackBuffer&&(c.endTransformFeedback(),c.bindBufferBase(c.TRANSFORM_FEEDBACK_BUFFER,
        0,null))},clear:function(a){var b=this.defaultClearOptions;a=a||b;var c=void 0==a.flags?b.flags:a.flags;if(0!==c){var d=this.gl;if(c&pc.CLEARFLAG_COLOR){var f=void 0==a.color?b.color:a.color;this.setClearColor(f[0],f[1],f[2],f[3])}c&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void 0==a.depth?b.depth:a.depth),this.depthWrite||d.depthMask(!0));c&pc.CLEARFLAG_STENCIL&&this.setClearStencil(void 0==a.stencil?b.stencil:a.stencil);d.clear(this.glClearFlag[c]);c&pc.CLEARFLAG_DEPTH&&(this.depthWrite||d.depthMask(!1))}},
        readPixels:function(a,b,c,d,f){var g=this.gl;g.readPixels(a,b,c,d,g.RGBA,g.UNSIGNED_BYTE,f)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,c,d){if(a!==this.clearRed||b!==this.clearGreen||c!==this.clearBlue||d!==this.clearAlpha)this.gl.clearColor(a,b,c,d),this.clearRed=a,this.clearGreen=b,this.clearBlue=c,this.clearAlpha=d},setClearStencil:function(a){a!==this.clearStencil&&(this.gl.clearStencil(a),this.clearStencil=a)},setRenderTarget:function(a){this.renderTarget=
            a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},setDepthFunc:function(a){this.depthFunc!==a&&(this.gl.depthFunc(this.glComparison[a]),this.depthFunc=a)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               b,c,d){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==d)this.gl.colorMask(a,b,c,d),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=d},setAlphaToCoverage:function(a){this.webgl2&&this.alphaToCoverage!==a&&((this.alphaToCoverage=a)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(a){if(this.transformFeedbackBuffer!==a&&(this.transformFeedbackBuffer=a,this.webgl2)){var b=
            this.gl;a?(this.feedback||(this.feedback=b.createTransformFeedback()),b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,this.feedback)):b.bindTransformFeedback(b.TRANSFORM_FEEDBACK,null)}},setRaster:function(a){this.raster!==a&&(this.raster=a,this.webgl2&&(a?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(a){this.depthBiasEnabled!==a&&((this.depthBiasEnabled=a)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},
        setDepthBiasValues:function(a,b){this.gl.polygonOffset(b,a)},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setStencilTest:function(a){if(this.stencil!==a){var b=this.gl;a?b.enable(b.STENCIL_TEST):b.disable(b.STENCIL_TEST);this.stencil=a}},setStencilFunc:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==c||this.stencilFuncBack!==a||this.stencilRefBack!==
            b||this.stencilMaskBack!==c)this.gl.stencilFunc(this.glComparison[a],b,c),this.stencilFuncFront=this.stencilFuncBack=a,this.stencilRefFront=this.stencilRefBack=b,this.stencilMaskFront=this.stencilMaskBack=c},setStencilFuncFront:function(a,b,c){if(this.stencilFuncFront!==a||this.stencilRefFront!==b||this.stencilMaskFront!==c){var d=this.gl;d.stencilFuncSeparate(d.FRONT,this.glComparison[a],b,c);this.stencilFuncFront=a;this.stencilRefFront=b;this.stencilMaskFront=c}},setStencilFuncBack:function(a,b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              c){if(this.stencilFuncBack!==a||this.stencilRefBack!==b||this.stencilMaskBack!==c){var d=this.gl;d.stencilFuncSeparate(d.BACK,this.glComparison[a],b,c);this.stencilFuncBack=a;this.stencilRefBack=b;this.stencilMaskBack=c}},setStencilOperation:function(a,b,c,d){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==c||this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOp(this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),
            this.stencilFailFront=this.stencilFailBack=a,this.stencilZfailFront=this.stencilZfailBack=b,this.stencilZpassFront=this.stencilZpassBack=c;if(this.stencilWriteMaskFront!==d||this.stencilWriteMaskBack!==d)this.gl.stencilMask(d),this.stencilWriteMaskBack=this.stencilWriteMaskFront=d},setStencilOperationFront:function(a,b,c,d){if(this.stencilFailFront!==a||this.stencilZfailFront!==b||this.stencilZpassFront!==c)this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),
            this.stencilFailFront=a,this.stencilZfailFront=b,this.stencilZpassFront=c;this.stencilWriteMaskFront!==d&&(this.gl.stencilMaskSeparate(this.gl.FRONT,d),this.stencilWriteMaskFront=d)},setStencilOperationBack:function(a,b,c,d){if(this.stencilFailBack!==a||this.stencilZfailBack!==b||this.stencilZpassBack!==c)this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[a],this.glStencilOp[b],this.glStencilOp[c]),this.stencilFailBack=a,this.stencilZfailBack=b,this.stencilZpassBack=c;this.stencilWriteMaskBack!==
        d&&(this.gl.stencilMaskSeparate(this.gl.BACK,d),this.stencilWriteMaskBack=d)},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b||this.separateAlphaBlend)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b,this.separateAlphaBlend=!1},setBlendFunctionSeparate:function(a,b,c,d){this.blendSrc===a&&this.blendDst===b&&this.blendSrcAlpha===c&&this.blendDstAlpha===d&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[a],
            this.glBlendFunction[b],this.glBlendFunction[c],this.glBlendFunction[d]),this.blendSrc=a,this.blendDst=b,this.blendSrcAlpha=c,this.blendDstAlpha=d,this.separateAlphaBlend=!0)},setBlendEquation:function(a){if(this.blendEquation!==a||this.separateAlphaEquation)this.gl.blendEquation(this.glBlendEquation[a]),this.blendEquation=a,this.separateAlphaEquation=!1},setBlendEquationSeparate:function(a,b){this.blendEquation===a&&this.blendAlphaEquation===b&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[a],
            this.glBlendEquation[b]),this.blendEquation=a,this.blendAlphaEquation=b,this.separateAlphaEquation=!0)},setCullMode:function(a){if(this.cullMode!==a){if(a===pc.CULLFACE_NONE)this.gl.disable(this.gl.CULL_FACE);else{this.cullMode===pc.CULLFACE_NONE&&this.gl.enable(this.gl.CULL_FACE);var b=this.glCull[a];this.cullFace!==b&&(this.gl.cullFace(b),this.cullFace=b)}this.cullMode=a}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var b=this.gl;
            b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,a?a.bufferId:null)}},setVertexBuffer:function(a,b,c){if(this.vertexBuffers[b]!==a||this.vbOffsets[b]!==c){this.vertexBuffers[b]=a;this.vbOffsets[b]=c;c=0;a=a.getFormat().elements;for(var d=a.length;c<d;){var f=a[c++];f.stream=b;f.scopeId.setValue(f)}this.attributesInvalidated=!0}},setShader:function(a){if(a!==this.shader){this.shader=a;if(!a.ready&&!a.link())return!1;this._shaderSwitchesPerFrame++;this.gl.useProgram(a.program);this.attributesInvalidated=!0}return!0},
        getHdrFormat:function(){return this.extTextureHalfFloatRenderable?pc.PIXELFORMAT_RGB16F:this.extTextureFloatRenderable?pc.PIXELFORMAT_RGB32F:pc.PIXELFORMAT_R8_G8_B8_A8},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},enableValidation:function(a){console.warn("enableValidation: This function is deprecated and will be removed shortly.")},validate:function(){console.warn("validate: This function is deprecated and will be removed shortly.")},resizeCanvas:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  b){this._width=a;this._height=b;var c=Math.min(this._maxPixelRatio,window.devicePixelRatio);a*=c;b*=c;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)},setResolution:function(a,b){this._width=a;this._height=b;this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)},clearShaderCache:function(){this.programLib.clearCache()},removeShaderFromCache:function(a){this.programLib.removeFromCache(a)},destroy:function(){this.webgl2&&this.feedback&&this.gl.deleteTransformFeedback(this.feedback)}};
        Object.defineProperty(g.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(g.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(g.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(g.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},
            set:function(a){this._enableAutoInstancing=a&&this.extInstancing}});Object.defineProperty(g.prototype,"maxAnisotropy",{get:function(){var a;return function(){if(void 0===a){a=1;var b=this.gl,c=this.extTextureFilterAnisotropic;c&&(a=b.getParameter(c.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}return a}}()});Object.defineProperty(g.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(a){this._maxPixelRatio=a;this.resizeCanvas(this._width,this._height)}});return{UnsupportedBrowserError:e,
            ContextCreationError:a,GraphicsDevice:g,precalculatedTangents:!0}}());pc.extend(pc,function(){var e={},a={vertex_position:pc.SEMANTIC_POSITION,vertex_normal:pc.SEMANTIC_NORMAL,vertex_tangent:pc.SEMANTIC_TANGENT,vertex_texCoord0:pc.SEMANTIC_TEXCOORD0,vertex_texCoord1:pc.SEMANTIC_TEXCOORD1,vertex_texCoord2:pc.SEMANTIC_TEXCOORD2,vertex_texCoord3:pc.SEMANTIC_TEXCOORD3,vertex_texCoord4:pc.SEMANTIC_TEXCOORD4,vertex_texCoord5:pc.SEMANTIC_TEXCOORD5,vertex_texCoord6:pc.SEMANTIC_TEXCOORD6,vertex_texCoord7:pc.SEMANTIC_TEXCOORD7,vertex_color:pc.SEMANTIC_COLOR,vertex_boneIndices:pc.SEMANTIC_BLENDINDICES,
        vertex_boneWeights:pc.SEMANTIC_BLENDWEIGHT};e.collectAttribs=function(b){for(var c={},d=0,f=b.indexOf("attribute");0<=f&&!(0<f&&"/"===b[f-1]);){var g=b.indexOf(";",f),k=b.lastIndexOf(" ",g),g=b.substr(k+1,g-(k+1)),k=a[g];void 0!==k?c[g]=k:(c[g]="ATTR"+d,d++);f=b.indexOf("attribute",f+1)}return c};e.createShader=function(a,c,d,f){c=e[c];d=pc.programlib.precisionCode(a)+"\n"+e[d];var g=this.collectAttribs(c);a.webgl2&&(c=pc.programlib.versionCode(a)+this.gles3VS+c,d=pc.programlib.versionCode(a)+this.gles3PS+
        d);return new pc.Shader(a,{attributes:g,vshader:c,fshader:d,useTransformFeedback:f})};e.createShaderFromCode=function(a,c,d,f,g){var k=a.programLib._cache,e=k[f];if(void 0!==e)return e;d=pc.programlib.precisionCode(a)+"\n"+(d||pc.programlib.dummyFragmentCode());e=this.collectAttribs(c);a.webgl2&&(c=pc.programlib.versionCode(a)+this.gles3VS+c,d=pc.programlib.versionCode(a)+this.gles3PS+d);k[f]=new pc.Shader(a,{attributes:e,vshader:c,fshader:d,useTransformFeedback:g});return k[f]};return{shaderChunks:e}}());pc.extend(pc,function(){var e=null,a={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1};return{drawQuadWithShader:function(b,c,d,f,g,k){if(null===e){var l=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);e=new pc.VertexBuffer(b,l,4);l=new pc.VertexIterator(e);l.element[pc.SEMANTIC_POSITION].set(-1,-1);l.next();l.element[pc.SEMANTIC_POSITION].set(1,-1);l.next();l.element[pc.SEMANTIC_POSITION].set(-1,1);l.next();l.element[pc.SEMANTIC_POSITION].set(1,1);
        l.end()}l=b.renderTarget;b.setRenderTarget(c);b.updateBegin();var m,n,h,r,p;f?(c=f.x,m=f.y,n=f.z,f=f.w):(n=c?c.width:b.width,f=c?c.height:b.height,m=c=0);g?(h=g.x,r=g.y,p=g.z,g=g.w):(h=c,r=m,p=n,g=f);b.setViewport(c,m,n,f);b.setScissor(h,r,p,g);g=b.getDepthTest();n=b.getDepthWrite();c=b.getCullMode();b.setDepthTest(!1);b.setDepthWrite(!1);b.setCullMode(pc.CULLFACE_NONE);k||b.setBlending(!1);b.setVertexBuffer(e,0);b.setShader(d);b.draw(a);b.setDepthTest(g);b.setDepthWrite(n);b.setCullMode(c);b.updateEnd();
        b.setRenderTarget(l);b.updateBegin()},destroyPostEffectQuad:function(){e=null}}}());pc.extend(pc,function(){function e(a,c,d){var f=c._colorBuffer;if(f.format==pc.PIXELFORMAT_R8_G8_B8_A8){var g=new Uint8Array(f.width*f.height*4),k=a.gl;a.setFramebuffer(c._glFrameBuffer);k.readPixels(0,0,f.width,f.height,k.RGBA,k.UNSIGNED_BYTE,g);f._levels||(f._levels=[]);f._levels[0]||(f._levels[0]=[]);f._levels[0][d]=g}}function a(a,c){return Math.atan2(a*c,Math.sqrt(a*a+c*c+1))}return{prefilterCubemap:function(a){var c=a.device,d=a.sourceCubemap,f=a.method,g=a.samples,k=a.cpuSync;if(k&&!d._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");
    else{var l=pc.shaderChunks,m=d.rgbm,g=l.createShaderFromCode(c,l.fullscreenQuadVS,l.rgbmPS+l.prefilterCubemapPS.replace(/\$METHOD/g,0===f?"cos":"phong").replace(/\$NUMSAMPLES/g,g).replace(/\$textureCube/g,m?"textureCubeRGBM":"textureCube"),"prefilter"+f+""+g+""+m),n=l.createShaderFromCode(c,l.fullscreenQuadVS,l.outputCubemapPS,"outputCubemap"),h=c.scope.resolve("source"),r=c.scope.resolve("params"),p=new pc.Vec4,q=d.width,l=d.format,t=[[],a.filteredFixed,a.filteredRgbm,a.filteredFixedRgbm],x=0===
    f?[.9,.85,.7,.4,.25]:[512,128,32,8,2],y=[64,32,16,8,4],w,u,v;u=l===pc.PIXELFORMAT_R8_G8_B8;w=!1;var z;k&&(w=d._levels[0][0]instanceof HTMLImageElement);if((u||w)&&k){l=pc.PIXELFORMAT_R8_G8_B8_A8;z=new pc.gfx.Texture(c,{cubemap:!0,rgbm:m,format:l,width:q,height:q,mipmaps:!1});for(v=0;6>v;v++)w=new pc.RenderTarget(c,z,{face:v,depth:!1}),p.x=v,p.y=0,h.setValue(d),r.setValue(p.data),pc.drawQuadWithShader(c,w,n),e(c,w,v);d=z}if(128<q){var A=Math.round(Math.log2(q))-Math.round(Math.log2(128));for(u=0;u<
    A;u++){var q=.5*d.width,D=0===f?1:Math.pow(2,Math.round(Math.log2(x[0])+2*(A-u)));z=new pc.gfx.Texture(c,{cubemap:!0,rgbm:m,format:l,width:q,height:q,mipmaps:!1});for(v=0;6>v;v++)w=new pc.RenderTarget(c,z,{face:v,depth:!1}),p.x=v,p.y=D,p.z=q,p.w=m?3:0,h.setValue(d),r.setValue(p.data),pc.drawQuadWithShader(c,w,n),u===A-1&&k&&e(c,w,v);d=z}}a.sourceCubemap=d;z=null;if(!m&&a.filteredFixedRgbm)for(z=new pc.gfx.Texture(c,{cubemap:!0,rgbm:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:q,height:q,mipmaps:!1}),
                                                                                                                                                                                                                                                                                                                                                                                                                    v=0;6>v;v++)w=new pc.RenderTarget(c,z,{face:v,depth:!1}),p.x=v,p.w=2,h.setValue(d),r.setValue(p.data),pc.drawQuadWithShader(c,w,n),e(c,w,v);q=0===f?1:2048;w=0===f?0:-1;t[w]=[];for(u=0;5>u;u++)for(n=w;n<t.length;n++)null!=t[n]&&(t[n][u]=new pc.gfx.Texture(c,{cubemap:!0,rgbm:2>n?m:!0,format:2>n?l:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===n||3===n,width:y[u],height:y[u],mipmaps:!1}));for(n=w;n<t.length;n++)if(null!=t[n])if(1<n&&m)t[n]=t[n-2];else for(u=0;5>u;u++)for(v=0;6>v;v++)w=new pc.RenderTarget(c,
        t[n][u],{face:v,depth:!1}),p.x=v,p.y=0>n?q:x[u],p.z=y[u],p.w=m?3:n,h.setValue(0===u?d:0===f?t[0][u-1]:t[-1][u-1]),r.setValue(p.data),pc.drawQuadWithShader(c,w,g),k&&e(c,w,v);a.filtered=t[0];if(k&&a.singleFilteredFixed){d=[d,a.filteredFixed[0],a.filteredFixed[1],a.filteredFixed[2],a.filteredFixed[3],a.filteredFixed[4],a.filteredFixed[5]];m=new pc.gfx.Texture(c,{cubemap:!0,rgbm:m,fixCubemapSeams:!0,format:l,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});for(u=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    0;6>u;u++)m._levels[u]=d[u]._levels[0];m.upload();m._prefilteredMips=!0;a.singleFilteredFixed=m}if(k&&a.singleFilteredFixedRgbm&&a.filteredFixedRgbm){d=[z,a.filteredFixedRgbm[0],a.filteredFixedRgbm[1],a.filteredFixedRgbm[2],a.filteredFixedRgbm[3],a.filteredFixedRgbm[4],a.filteredFixedRgbm[5]];m=new pc.gfx.Texture(c,{cubemap:!0,rgbm:!0,fixCubemapSeams:!0,format:pc.PIXELFORMAT_R8_G8_B8_A8,width:128,height:128,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});for(u=0;6>u;u++)m._levels[u]=
        d[u]._levels[0];m.upload();m._prefilteredMips=!0;a.singleFilteredFixedRgbm=m}}},shFromCubemap:function(b,c){var d,f=b.width,g,k;if(b.format!=pc.PIXELFORMAT_R8_G8_B8_A8)console.error("ERROR: SH: cubemap must be RGBA8");else{if(b._levels[0]){if(!b._levels[0][0].length)if(b._levels[0][0]instanceof HTMLImageElement){g=pc.Application.getApplication().graphicsDevice;k=g.gl;d=pc.shaderChunks;var e=d.createShaderFromCode(g,d.fullscreenQuadVS,d.fullscreenQuadPS,"fsQuadSimple"),m=g.scope.resolve("source");
        for(d=0;6>d;d++){var n=b._levels[0][d],h=new pc.Texture(g,{cubemap:!1,rgbm:!1,format:b.format,width:f,height:f,mipmaps:!1});h._levels[0]=n;h.upload();n=new pc.Texture(g,{cubemap:!1,rgbm:!1,format:b.format,width:f,height:f,mipmaps:!1});n=new pc.RenderTarget(g,n,{depth:!1});m.setValue(h);pc.drawQuadWithShader(g,n,e);var r=new Uint8Array(f*f*4);k.bindFramebuffer(k.FRAMEBUFFER,n._glFrameBuffer);k.readPixels(0,0,h.width,h.height,k.RGBA,k.UNSIGNED_BYTE,r);b._levels[0][d]=r}}else{console.error("ERROR: SH: cubemap must be composed of arrays or images");
        return}e=[];for(k=0;k<f;k++)for(g=0;g<f;g++)e[k*f+g]=(new pc.Vec3(g/(f-1)*2-1,k/(f-1)*2-1,1)).normalize();var m=new Float32Array(27),p,q,t,x,y,w,u,v,z,A,D;for(d=n=0;6>d;d++)for(k=0;k<f;k++)for(g=0;g<f;g++){h=k*f+g;r=g;u=k;v=f;q=2*(r+.5)/v-1;D=2*(u+.5)/v-1;q*=1-1/v;D*=1-1/v;p=1/v;z=q-p;A=D-p;q+=p;D+=p;z=a(z,A)-a(z,D)-a(q,A)+a(q,D);if(0===r&&0===u||r===v-1&&0===u||0===r&&u===v-1||r===v-1&&u===v-1)z/=3;else if(0===r||0===u||r===v-1||u===v-1)z*=.5;r=z;u=4*r/17;v=8*r/17;z=15*r/17;A=5*r/68;D=15*r/68;p=
        e[h];0==d?(x=p.z,y=-p.y,w=-p.x):1==d?(x=-p.z,y=-p.y,w=p.x):2==d?(x=p.x,y=p.z,w=p.y):3==d?(x=p.x,y=-p.z,w=-p.y):4==d?(x=p.x,y=-p.y,w=p.z):5==d&&(x=-p.x,y=-p.y,w=-p.z);c||(x=-x);q=b._levels[0][d][4*h+3]/255;for(p=0;3>p;p++)t=b._levels[0][d][4*h+p]/255,b.rgbm?(t=8*t*q,t*=t):t=Math.pow(t,2.2),m[0+p]+=t*u,m[3+p]+=t*v*x,m[6+p]+=t*v*y,m[9+p]+=t*v*w,m[12+p]+=t*z*x*w,m[15+p]+=t*z*w*y,m[18+p]+=t*z*y*x,m[21+p]+=t*A*(3*w*w-1),m[24+p]+=t*D*(x*x-y*y),n+=r}for(p=0;p<m.length;p++)m[p]*=4*Math.PI/n;return m}console.error("ERROR: SH: cubemap must be synced to CPU")}}}}());pc.extend(pc,function(){return{paraboloidFromCubemap:function(e,a,b,c){var d=pc.shaderChunks,d=d.createShaderFromCode(e,d.fullscreenQuadVS,(a.fixCubemapSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS)+d.genParaboloidPS,"genParaboloid"),f=e.scope.resolve("source"),g=e.scope.resolve("params"),k=new pc.Vec4,l=a.width,m=a.rgbm,n=a.format,l=2*Math.max(l,8),l=new pc.gfx.Texture(e,{rgbm:m,format:n,width:2*l,height:l,mipmaps:!1}),m=new pc.RenderTarget(e,l,{depth:!1});k.x=b;k.y=c?-1:1;f.setValue(a);
        g.setValue(k.data);pc.drawQuadWithShader(e,m,d);return l},generateDpAtlas:function(e,a,b){var c,d;d=new pc.Vec4;for(var f=new pc.Vec4,g=4*a[0].width,k=pc.shaderChunks,k=k.createShaderFromCode(e,k.fullscreenQuadVS,k.dpAtlasQuadPS,"dpAtlasQuad"),l=e.scope.resolve("source"),m=e.scope.resolve("params"),n=new pc.gfx.Texture(e,{rgbm:a[0].rgbm,format:a[0].format,width:g,height:g,mipmaps:!1}),h=new pc.RenderTarget(e,n,{depth:!1}),r=(g+2)/g-1,p=0;6>p;p++){c=pc.paraboloidFromCubemap(e,a[p],p,b);l.setValue(c);
        c=d;var q=p;c.x=.5*pc.math.clamp(q-2,0,1);var q=q-6*c.x,t=1-c.x;c.y=Math.min(.5*q,.75)*t+c.x;c.z=(1-.5*pc.math.clamp(q,0,1))*t;c.w=.5*c.z;c=1/c.z;f.x=c*r;f.y=2*f.x;f.x+=1;f.y+=1;m.setValue(f.data);d.x*=g;d.y*=g;d.z*=g;d.w*=g;pc.drawQuadWithShader(e,h,k,d)}return n}}}());pc.shaderChunks.TBNPS="void getTBN() {\n    dTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n";pc.shaderChunks.TBNfastPS="void getTBN() {\n    dTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n";pc.shaderChunks.alphaTestPS="uniform float alpha_ref;\nvoid alphaTest(float a) {\n    if (a < alpha_ref) discard;\n}\n";pc.shaderChunks.ambientConstantPS="\nvoid addAmbient() {\n    dDiffuseLight += light_globalAmbient;\n}\n";
    pc.shaderChunks.ambientPrefilteredCubePS="#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n";pc.shaderChunks.ambientPrefilteredCubeLodPS="#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n    vec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n    fixedReflDir.x *= -1.0;\n    dDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n";
    pc.shaderChunks.ambientSHPS="uniform vec3 ambientSH[9];\nvoid addAmbient() {\n    vec3 n = dNormalW;\n    vec3 color =\n                        ambientSH[0] +\n                        ambientSH[1] * n.x +\n                        ambientSH[2] * n.y +\n                        ambientSH[3] * n.z +\n                        ambientSH[4] * n.x * n.z +\n                        ambientSH[5] * n.z * n.y +\n                        ambientSH[6] * n.y * n.x +\n                        ambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n                        ambientSH[8] * (n.x * n.x - n.y * n.y);\n    dDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n";
    pc.shaderChunks.aoPS="#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n    dAo = 1.0;\n    #ifdef MAPTEXTURE\n        dAo *= texture2D(texture_aoMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAo *= saturate(vVertexColor.$VC);\n    #endif\n    dDiffuseLight *= dAo;\n}\n";pc.shaderChunks.aoSpecOccPS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    specOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
    pc.shaderChunks.aoSpecOccConstPS="void occludeSpecular() {\n    // approximated specular occlusion from AO\n    float specPow = exp2(dGlossiness * 11.0);\n    // http://research.tri-ace.com/Data/cedec2011_RealtimePBR_Implementation_e.pptx\n    float specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";pc.shaderChunks.aoSpecOccConstSimplePS="void occludeSpecular() {\n    float specOcc = dAo;\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";
    pc.shaderChunks.aoSpecOccSimplePS="uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n    float specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n    dSpecularLight *= specOcc;\n    dReflection *= specOcc;\n}\n";pc.shaderChunks.bakeDirLmEndPS="\n    vec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n    if (bakeDir > 0.5) {\n        if (dAtten > 0.00001) {\n            dirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n            dAtten = saturate(dAtten);\n            gl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n            gl_FragColor.a = dirLm.w + dAtten;\n            gl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n        } else {\n            gl_FragColor = dirLm;\n        }\n    } else {\n        gl_FragColor.rgb = dirLm.xyz;\n        gl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n    }\n";
    pc.shaderChunks.bakeLmEndPS="\ngl_FragColor.rgb = dDiffuseLight;\ngl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\ngl_FragColor.rgb /= 8.0;\ngl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\ngl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\ngl_FragColor.rgb /= gl_FragColor.a;\n";pc.shaderChunks.basePS="\nuniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n    return x*x;\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n    return clamp(x, vec3(0.0), vec3(1.0));\n}\n";
    pc.shaderChunks.baseVS="\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n";pc.shaderChunks.biasConstPS="#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n    return maxBias;\n}\n";
    pc.shaderChunks.blurVSMPS="\nvarying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\n#endif\nvoid main(void) {\n    vec3 moments = vec3(0.0);\n    vec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n    for(int i=0; i<SAMPLES; i++) {\n        vec4 c = texture2D(source, uv + pixelOffset * float(i));\n        #ifdef PACKED\n        c.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n        #endif\n        #ifdef GAUSS\n        moments += c.xyz * weight[i];\n        #else\n        moments += c.xyz;\n        #endif\n    }\n    #ifndef GAUSS\n    moments /= float(SAMPLES);\n    #endif\n    #ifdef PACKED\n    gl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n    #else\n    gl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n    #endif\n}\n";
    pc.shaderChunks.combineDiffusePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight;\n}\n";pc.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n";pc.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n";
    pc.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor() {\n    return dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n";pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor() {\n    return (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n";pc.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor() {\n    return mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n";
    pc.shaderChunks.cookiePS="vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    return mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n    vec4 projPos = transform * vec4(vPositionW, 1.0);\n    projPos.xy /= projPos.w;\n    projPos.xy += cookieOffset;\n    if (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n    vec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n    return mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n    return mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n";
    pc.shaderChunks.cubeMapProjectBoxPS="uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n    vec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n    vec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n    vec3 rbminmax;\n    rbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n    rbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n    rbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n    float fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n    vec3 posonbox = vPositionW + nrdir * fa;\n    vec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n    return posonbox - envBoxPos;\n}\n";
    pc.shaderChunks.cubeMapProjectNonePS="vec3 cubeMapProject(vec3 dir) {\n    return dir;\n}\n";pc.shaderChunks.diffusePS="#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n    dAlbedo = vec3(1.0);\n    #ifdef MAPCOLOR\n        dAlbedo *= material_diffuse.rgb;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlbedo *= texture2DSRGB(texture_diffuseMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n}\n";
    pc.shaderChunks.dilatePS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n    vec4 c = texture2D(source, vUv0);\n    c = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n    c = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n    gl_FragColor = c;\n}\n";
    pc.shaderChunks.dpAtlasQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n    vec2 uv = vUv0;\n    uv = uv * 2.0 - vec2(1.0);\n    uv *= params.xy;\n    uv = uv * 0.5 + 0.5;\n    gl_FragColor = texture2D(source, uv);\n}\n";pc.shaderChunks.emissivePS="#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n    vec3 emission = vec3(1.0);\n    #ifdef MAPFLOAT\n        emission *= material_emissiveIntensity;\n    #endif\n    #ifdef MAPCOLOR\n        emission *= material_emissive;\n    #endif\n    #ifdef MAPTEXTURE\n        emission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        emission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n    #endif\n    return emission;\n}\n";
    pc.shaderChunks.endPS="   gl_FragColor.rgb = combineColor();\n   gl_FragColor.rgb += getEmission();\n   gl_FragColor.rgb = addFog(gl_FragColor.rgb);\n   #ifndef HDR\n    gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n    gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   #endif\n";pc.shaderChunks.envConstPS="vec3 processEnvironment(vec3 color) {\n    return color;\n}\n";pc.shaderChunks.envMultiplyPS="uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n    return color * skyboxIntensity;\n}\n";
    pc.shaderChunks.extensionPS="";pc.shaderChunks.extensionVS="\n";pc.shaderChunks.falloffInvSquaredPS="float getFalloffInvSquared(float lightRadius) {\n    float sqrDist = dot(dLightDirW, dLightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n    return falloff;\n}\n";pc.shaderChunks.falloffLinearPS="float getFalloffLinear(float lightRadius) {\n    float d = length(dLightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n";
    pc.shaderChunks.fixCubemapSeamsNonePS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n";pc.shaderChunks.fixCubemapSeamsStretchPS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / 128.0;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n";
    pc.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";
    pc.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.fogNonePS="vec3 addFog(vec3 color) {\n    return color;\n}\n";
    pc.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel() {\n    float fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= dGlossiness * dGlossiness;\n    dSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n}\n";pc.shaderChunks.fullscreenQuadPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";
    pc.shaderChunks.fullscreenQuadVS="attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n    gl_Position = vec4(vertex_position, 0.5, 1.0);\n    vUv0 = vertex_position.xy*0.5+0.5;\n}\n";pc.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    return texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\nfloat gammaCorrectInput(float color) {\n    return color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n";
    pc.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n    vec4 rgba = texture2D(tex, uv, bias);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n#ifdef HDR\n    return color;\n#else\n    color += vec3(0.0000001);\n    return pow(color, vec3(0.45));\n#endif\n}\n";
    pc.shaderChunks.genParaboloidPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params; // x = mip\nvoid main(void) {\n    vec2 uv = vUv0;\n    float side = uv.x < 0.5? 1.0 : -1.0;\n    vec2 tc;\n    tc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n    tc.y = uv.y * 2.0 - 1.0;\n    // scale projection a bit to have a little overlap for filtering\n    const float scale = 1.1;\n    tc *= scale;\n    vec3 dir;\n    dir.y = (dot(tc, tc) - 1.0) * side; // from 1.0 center to 0.0 borders quadratically\n    dir.xz = tc * -2.0;\n    dir.x *= -side * params.y; // flip original cubemap x instead of doing it at runtime\n    dir = fixSeams(dir, params.x);\n    vec4 color = textureCube(source, dir, -100.0);\n    gl_FragColor = color;\n}\n";
    pc.shaderChunks.gles3PS="#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n";pc.shaderChunks.gles3VS="#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n";
    pc.shaderChunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n    dGlossiness = 1.0;\n    #ifdef MAPFLOAT\n        dGlossiness *= material_shininess;\n    #endif\n    #ifdef MAPTEXTURE\n        dGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dGlossiness *= saturate(vVertexColor.$VC);\n    #endif\n    dGlossiness += 0.0000001;\n}\n";
    pc.shaderChunks.instancingVS="\nattribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n";pc.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse() {\n    return max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n";pc.shaderChunks.lightDirPointPS="void getLightDirPoint(vec3 lightPosW) {\n    dLightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(dLightDirW);\n    dLightPosW = lightPosW;\n}\n";
    pc.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular() {\n    vec3 h = normalize( -dLightDirNormW + dViewDirW );\n    float nh = max( dot( h, dNormalW ), 0.0 );\n    float specPow = exp2(dGlossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n";
    pc.shaderChunks.lightSpecularPhongPS="float getLightSpecular() {\n    float specPow = dGlossiness;\n    specPow = antiAliasGlossiness(specPow);\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(dReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\n";pc.shaderChunks.lightmapDirPS="uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n        dDiffuseLight += color;\n        return;\n    }\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    float vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n    float flight = saturate(dot(dLightDirNormW, -dNormalW));\n    float nlight = (flight / max(vlight,0.01)) * 0.5;\n    dDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n    vec4 dir = texture2D(texture_dirLightMap, $UV);\n    if (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n    vec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    dLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n    dSpecularLight += vec3(getLightSpecular()) * color;\n}\n";
    pc.shaderChunks.lightmapSinglePS="#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n    vec3 lm = vec3(1.0);\n    #ifdef MAPTEXTURE\n        lm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        lm *= saturate(vVertexColor.$VC);\n    #endif\n    \n    dDiffuseLight += lm;\n}\n";pc.shaderChunks.lightmapSingleVertPS="void addLightMap() {\n    dDiffuseLight += saturate(vVertexColor.$CH);\n}\n";pc.shaderChunks.metalnessPS="void processMetalness(float metalness) {\n    const float dielectricF0 = 0.04;\n    dSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n    dAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n    float metalness = 1.0;\n    #ifdef MAPFLOAT\n        metalness *= material_metalness;\n    #endif\n    #ifdef MAPTEXTURE\n        metalness *= texture2D(texture_metalnessMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        metalness *= saturate(vVertexColor.$VC);\n    #endif\n    processMetalness(metalness);\n}\n";
    pc.shaderChunks.msdfPS="uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n    return max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n    return (v - min) / (max - min);\n}\n// msdf way\n// vec4 applyMsdf(vec4 color) {\n//     vec3 tsample = texture(texture_msdfMap, vUv0).rgb;\n   \n//     // separate\n//     vec2 msdfUnit = 4.0 / vec2(512.0, 256.0);\n//     float sigDist = median(tsample.r, tsample.g, tsample.b) - 0.5;\n//     sigDist *= dot(msdfUnit, 0.5/fwidth(vUv0));\n//     float distance = clamp(sigDist + 0.5, 0.0, 1.0);\n//     return mix(vec4(0.0), color, distance);\n// }\nuniform float font_sdfIntensity; // intensity is used to boost the value read from the SDF, 0 is no boost, 1.0 is max boost\nuniform float font_pxrange;      // the number of pixels between inside and outside the font in SDF\nuniform float font_textureWidth; // the width of the texture atlas\nvec4 applyMsdf(vec4 color) {\n    float font_size = 16.0; // TODO fix this\n    // sample the field\n    vec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n    // get the signed distance value\n    float sigDist = median(tsample.r, tsample.g, tsample.b);\n    #ifdef USE_FWIDTH\n        // smoothing depends on size of texture on screen\n        vec2 w = fwidth(vUv0);\n        float smoothing = clamp(map(0.0, 2.0 * font_pxrange / font_textureWidth, w.x), 0.0, 0.5);\n    #else\n        // smoothing gets smaller as the font size gets bigger\n        // don't have fwidth we can approximate from font size, this doesn't account for scaling\n        // so a big font scaled down will be wrong...\n        float smoothing = clamp(2.0 * font_pxrange / font_size, 0.0, 0.5);\n        // for small fonts we remap the distance field to intensify it\n        // float mapMin = 0.05;\n        // float mapMax = clamp(((font_size * 0.4 / 40.0) + 0.52), mapMin, 1.0);\n    #endif\n    float mapMin = 0.05;\n    float mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n    \n    // remap to a smaller range (used on smaller font sizes)\n    sigDist = map(mapMin, mapMax, sigDist);\n    float center = 0.5;\n    // calculate smoothing and use to generate opacity\n    // float smoothing = clamp(font_smoothing * (1.0-roy), 0.0, center);\n    float opacity = smoothstep(center-smoothing, center+smoothing, sigDist);\n    // return final color\n    return mix(vec4(0.0), color, opacity);\n}";
    pc.shaderChunks.normalVS="vec3 getNormal() {\n    #ifdef SKIN\n        dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    #elif defined(INSTANCING)\n        dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    #else\n        dNormalMatrix = matrix_normal;\n    #endif\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";pc.shaderChunks.normalInstancedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
    pc.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    dNormalW = dTBN * normalMap;\n}\n";pc.shaderChunks.normalMapFloatPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n    dNormalW = dTBN * normalMap;\n}\n";
    pc.shaderChunks.normalMapFloatTBNfastPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    dNormalMap = normalMap;\n    normalMap = mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness);\n    dNormalW = normalize(dTBN * normalMap);\n}\n";pc.shaderChunks.normalSkinnedVS="vec3 getNormal() {\n    dNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n    return normalize(dNormalMatrix * vertex_normal);\n}\n";
    pc.shaderChunks.normalVertexPS="void getNormal() {\n    dNormalW = normalize(dVertexNormalW);\n}\n";pc.shaderChunks.normalXYPS="vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n";pc.shaderChunks.normalXYZPS="vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n";pc.shaderChunks.opacityPS="#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n    dAlpha = 1.0;\n    #ifdef MAPFLOAT\n        dAlpha *= material_opacity;\n    #endif\n    #ifdef MAPTEXTURE\n        dAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dAlpha *= saturate(vVertexColor.$VC);\n    #endif\n}\n";
    pc.shaderChunks.outputAlphaPS="gl_FragColor.a = dAlpha;\n";pc.shaderChunks.outputAlphaOpaquePS="gl_FragColor.a = 1.0;\n";pc.shaderChunks.outputAlphaPremulPS="gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n";pc.shaderChunks.outputCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n    color.rgb /= color.a;\n    return color;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    gl_FragColor = textureCube(source, vec);\n    if (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n";
    pc.shaderChunks.outputTex2DPS="varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n    gl_FragColor = texture2D(source, vUv0);\n}\n";pc.shaderChunks.packDepthPS="// Packing a float in GLSL with multiplication and mod\n// http://blog.gradientstudios.com/2012/08/23/shadow-map-improvement\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";
    pc.shaderChunks.packDepthMaskPS="vec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    // combination of mod and multiplication and division works better\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res.x = 0.0;\n    res -= res.xxyz * bit_mask;\n    return res;\n}\n";pc.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n    float parallaxScale = material_heightMapFactor;\n    float height = texture2D(texture_heightMap, $UV).$CH;\n    height = height * parallaxScale - parallaxScale*0.5;\n    vec3 viewDirT = dViewDirW * dTBN;\n    viewDirT.z += 0.42;\n    dUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n";
    pc.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n#endif\nvoid main(void) {\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n    ramp.a += texCoordsAlphaLife.z;\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n";
    pc.shaderChunks.particleVS="\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n    float uv = id / numParticlesPot;\n    readInput(uv);\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    float particleLifetime = lifetime;\n    if (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n    vec3 particlePos = inPos;\n    vec3 particlePosMoved = vec3(0.0);\n    mat2 rotMatrix;\n";
    pc.shaderChunks.particleAnimFrameClampVS="\n    float animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.z), animTexParams.w);\n";pc.shaderChunks.particleAnimFrameLoopVS="\n    float animFrame = floor(texCoordsAlphaLife.w * animTexParams.z);\n";pc.shaderChunks.particleAnimTexVS="\n    float atlasX = animFrame * animTexParams.x;\n    float atlasY = floor(atlasX) * animTexParams.y;\n    atlasX = fract(atlasX);\n    texCoordsAlphaLife.xy *= animTexParams.xy;\n    texCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n    texCoordsAlphaLife.y = 1.0 - texCoordsAlphaLife.y;\n";
    pc.shaderChunks.particleInputFloatPS="void readInput(float uv) {\n    vec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n    inPos = tex.xyz;\n    inVel = tex2.xyz;\n    inAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n    inShow = tex.w >= 0.0;\n    inLife = tex2.w;\n}\n";pc.shaderChunks.particleInputRgba8PS="//RG=X, BA=Y\n//RG=Z, BA=A\n//RGB=V, A=visMode\n//RGBA=life\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n    vec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n    vec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n    vec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n    vec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n    inPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n    inPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n    inVel = tex2.xyz;\n    inVel = (inVel - vec3(0.5)) * maxVel;\n    inAngle = decodeFloatRG(tex1.ba) * PI2;\n    inShow = tex2.a > 0.5;\n    inLife = decodeFloatRGBA(tex3);\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    inLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n";
    pc.shaderChunks.particleOutputFloatPS="void writeOutput() {\n    if (gl_FragCoord.y<1.0) {\n        gl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n    } else {\n        gl_FragColor = vec4(outVel, outLife);\n    }\n}\n";pc.shaderChunks.particleOutputRgba8PS="uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n  vec2 enc = vec2(1.0, 255.0) * v;\n  enc = fract(enc);\n  enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n  return enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}\nvoid writeOutput() {\n    //outPos = (outPos - outBoundsCenter) / outBoundsSize + vec3(0.5);\n    outPos = outPos * outBoundsMul + outBoundsAdd;\n    outAngle = fract(outAngle / PI2);\n    outVel = (outVel / maxVel) + vec3(0.5); // TODO: mul\n    float maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n    float maxPosLife = lifetime+1.0;\n    outLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n    if (gl_FragCoord.y < 1.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n    } else if (gl_FragCoord.y < 2.0) {\n        gl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n    } else if (gl_FragCoord.y < 3.0) {\n        gl_FragColor = vec4(outVel, visMode*0.5+0.5);\n    } else {\n        gl_FragColor = encodeFloatRGBA(outLife);\n    }\n}\n";
    pc.shaderChunks.particleUpdaterAABBPS="uniform mat3 spawnBounds;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    return emitterPos + spawnBounds * (inBounds - vec3(0.5));\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n";pc.shaderChunks.particleUpdaterEndPS="\n    writeOutput();\n}\n";pc.shaderChunks.particleUpdaterInitPS="varying vec2 vUv0;\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform mat3 emitterMatrix;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n";
    pc.shaderChunks.particleUpdaterNoRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = -1.0;\n    }\n";pc.shaderChunks.particleUpdaterOnStopPS="    visMode = outLife < 0.0? -1.0: visMode;\n";pc.shaderChunks.particleUpdaterRespawnPS="    if (outLife >= lifetime) {\n        outLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n        visMode = 1.0;\n    }\n    visMode = outLife < 0.0? 1.0: visMode;\n";
    pc.shaderChunks.particleUpdaterSpherePS="uniform float spawnBoundsSphere;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    return emitterPos + normalize(inBounds.xyz - vec3(0.5)) * rnd4 * spawnBoundsSphere;\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n";pc.shaderChunks.particleUpdaterStartPS="float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n    return mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n    vec4 p4 = fract(vec4(p) * HASHSCALE4);\n    p4 += dot(p4, p4.wzxy+19.19);\n    return fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    readInput(vUv0.x);\n    visMode = inShow? 1.0 : -1.0;\n    vec4 rndFactor = hash41(gl_FragCoord.x + seed);\n    float particleRate = rate + rateDiv * rndFactor.x;\n    outLife = inLife + delta;\n    float nlife = clamp(outLife / lifetime, 0.0, 1.0);\n    vec3 localVelocityDiv;\n    vec3 velocityDiv;\n    vec3 paramDiv;\n    vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n    vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n    vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float rotSpeed = params.x;\n    float rotSpeedDiv = paramDiv.y;\n    localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n    velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n    rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n    addInitialVelocity(localVelocity, rndFactor.xyz);\n    outVel = emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale;\n    outPos = inPos + outVel * delta;\n    outAngle = inAngle + rotSpeed * delta;\n    bool respawn = outLife <= 0.0 || outLife >= lifetime;\n    outPos = respawn? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : outPos;\n    outAngle = respawn? mix(startAngle, startAngle2, rndFactor.x) : outAngle;\n    outVel = respawn? vec3(0.0) : outVel;\n";
    pc.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    ParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n";pc.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, inAngle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY);\n";pc.shaderChunks.particle_blendAddPS="\n    rgb *= saturate(gammaCorrectInput(a));\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n";
    pc.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n";pc.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute vec2 particle_vertexData4;     // X = velocity.z, W = particle ID\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n    return m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n    vec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n    return pos;\n}\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 inPos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n    vec2 velocityV = normalize((mat3(matrix_view) * inVel).xy); // should be removed by compiler if align/stretch is not used\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n    mat2 rotMatrix;\n    float inAngle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n";
    pc.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n";pc.shaderChunks.particle_endPS="    rgb = addFog(rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";pc.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n";
    pc.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n";pc.shaderChunks.particle_initVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n";
    pc.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n";pc.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n    rgb *= light;\n";pc.shaderChunks.particle_localShiftVS="    particlePos += emitterPos;\n";
    pc.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n    billboard(particlePos, quadXY);\n";pc.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos + matrix_viewInverse[2].xyz);\n";pc.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n";
    pc.shaderChunks.particle_pointAlongVS="    inAngle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n";pc.shaderChunks.particle_softPS="\n    float depth = getLinearScreenDepth();\n    float particleDepth = vDepth;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n";pc.shaderChunks.particle_softVS="\n    vDepth = getLinearDepth(localPos);\n";pc.shaderChunks.particle_stretchVS="    vec3 moveDir = inVel * stretch;\n    vec3 posPrev = inPos - moveDir;\n    posPrev += particlePosMoved;\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n    particlePos = mix(particlePos, posPrev, interpolation);\n";
    pc.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n";pc.shaderChunks.precisionTestPS="void main(void) {\n    gl_FragColor = vec4(2147483648.0);\n}\n";pc.shaderChunks.precisionTest2PS="uniform sampler2D source;\nvec4 packFloat(float depth) {\n    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n    res -= res.xxyz * bit_mask;\n    return res;\n}\nvoid main(void) {\n    float c = texture2D(source, vec2(0.0)).r;\n    float diff = abs(c - 2147483648.0) / 2147483648.0;\n    gl_FragColor = packFloat(diff);\n}\n";
    pc.shaderChunks.prefilterCubemapPS="varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) { // modified RGBM\n    vec4 encoded;\n    encoded.rgb = pow(color.rgb, vec3(0.5));\n    encoded.rgb *= 1.0 / 8.0;\n    encoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n    encoded.a = ceil(encoded.a * 255.0) / 255.0;\n    encoded.rgb /= encoded.a;\n    return encoded;\n}\nvoid main(void) {\n    vec2 st = vUv0 * 2.0 - 1.0;\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n    float face = params.x;\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n    vec3 color = vec3(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n        color += $textureCube(source, vect).rgb;\n    }\n    color /= float(samples);\n    gl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n";
    pc.shaderChunks.reflDirPS="void getReflDir() {\n    dReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n";pc.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 lookupVec = fixSeams(cubeMapProject(dReflDirW));\n    lookupVec.x *= -1.0;\n    dReflection += vec4($textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb, material_reflectivity);\n}\n";pc.shaderChunks.reflectionDpAtlasPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n    vec4 rect;\n    float sx = saturate(mip - 2.0);\n    rect.x = sx * 0.5;\n    float t = mip - rect.x * 6.0;\n    float i = 1.0 - rect.x;\n    rect.y = min(t * 0.5, 0.75) * i + rect.x;\n    float st = saturate(t);\n    rect.z = (1.0 - st * 0.5) * i;\n    rect.w = rect.z * 0.5;\n    float rcRectZ = 1.0 / rect.z;\n    float scaleFactor = 0.00390625 * rcRectZ; // 0.0078125 = (256 + 2) / 256 - 1, 0.00390625 same for 512\n    vec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n    uv = uv * (vec2(1.0) - scale) + scale * 0.5;\n    uv = uv * rect.zw + rect.xy;\n    return uv;\n}\nvoid addReflection() {\n    vec3 reflDir = normalize(cubeMapProject(dReflDirW));\n    // Convert vector to DP coords\n    bool up = reflDir.y > 0.0;\n    float scale = 0.90909090909090909090909090909091;// 1.0 / 1.1;\n    vec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n    float reflDirVer = abs(reflDir.y) + 1.0;\n    reflDirWarp /= reflDirVer;\n    reflDirWarp *= scale;\n    reflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n    vec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    float mip = floor(bias);\n    vec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    mip = min(mip + 1.0, 5.0);\n    vec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n    tex1 = mix(tex1, tex2, fract(bias));\n    tex1 = processEnvironment(tex1);\n    dReflection += vec4(tex1, material_reflectivity);\n}\n";
    pc.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvoid addReflection() {\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n";
    pc.shaderChunks.reflectionPrefilteredCubeLodPS="\n#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvoid addReflection() {\n    float bias = saturate(1.0 - dGlossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(cubeMapProject(dReflDirW), bias);\n    fixedReflDir.x *= -1.0;\n    vec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n    dReflection += vec4(refl, material_reflectivity);\n}\n";
    pc.shaderChunks.reflectionSpherePS="#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = (mat3(matrix_view) * dReflDirW).xyz;\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n";
    pc.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvoid addReflection() {\n    vec3 reflDirV = vNormalV;\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    dReflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectivity);\n}\n";pc.shaderChunks.refractionPS="uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n    float vn = dot(viewVec, Normal);\n    float k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n    vec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n    return refrVec;\n}\nvoid addRefraction() {\n    // use same reflection code with refraction vector\n    vec3 tmp = dReflDirW;\n    vec4 tmp2 = dReflection;\n    dReflection = vec4(0.0);\n    dReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n    addReflection();\n    dDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n    dReflDirW = tmp;\n    dReflection = tmp2;\n}\n";
    pc.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n";pc.shaderChunks.screenDepthPS="uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params; // 1 / camera_far,      camera_far,     (1 - f / n) / 2,        (1 + f / n) / 2\n#endif\n#ifdef GL2\n    float linearizeDepth(float z) {\n        z = z * 2.0 - 1.0;\n        return 1.0 / (camera_params.z * z + camera_params.w);\n    }\n#else\n    #ifndef UNPACKFLOAT\n    #define UNPACKFLOAT\n    float unpackFloat(vec4 rgbaDepth) {\n        const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n        return dot(rgbaDepth, bitShift);\n    }\n    #endif\n#endif\n// Retrieves rendered linear camera depth by UV\nfloat getLinearScreenDepth(vec2 uv) {\n    #ifdef GL2\n        return linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n    #else\n        return unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n    #endif\n}\n#ifndef VERTEXSHADER\n// Retrieves rendered linear camera depth under the current pixel\nfloat getLinearScreenDepth() {\n    vec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n    return getLinearScreenDepth(uv);\n}\n#endif\n// Generates linear camera depth for the given world position\nfloat getLinearDepth(vec3 pos) {\n    return -(matrix_view * vec4(pos, 1.0)).z;\n}\n";
    pc.shaderChunks.shadowCommonPS="void normalOffsetPointShadow(vec4 shadowParams) {\n    float distScale = length(dLightDirW);\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - dLightPosW;\n    dLightDirW = dir;\n}\n";pc.shaderChunks.shadowCoordPS="void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    dShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xy /= projPos.w;\n    dShadowCoord.xy = projPos.xy;\n    dShadowCoord.z = length(dLightDirW) * shadowParams.w;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
    pc.shaderChunks.shadowCoordVS="void getLightDirPoint(vec3 lightPosW) {\n    vec3 lightDirW = vPositionW - lightPosW;\n    dLightDirNormW = normalize(lightDirW);\n    dLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    vMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0); //0.08\n    _getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n";
    pc.shaderChunks.shadowCoordPerspZbufferPS="void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    dShadowCoord = projPos.xyz;\n    // depth bias is already applied on render\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n    float distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW)); // fov?\n    vec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n    _getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n";
    pc.shaderChunks.shadowEVSMPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec3 moments = texture2D(tex, texCoords).xyz;\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
    pc.shaderChunks.shadowEVSMnPS="float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    float pixelSize = 1.0 / resolution;\n    texCoords -= vec2(pixelSize);\n    vec3 s00 = texture2D(tex, texCoords).xyz;\n    vec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n    vec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n    vec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n    vec2 fr = fract(texCoords * resolution);\n    vec3 h0 = mix(s00, s10, fr.x);\n    vec3 h1 = mix(s01, s11, fr.x);\n    vec3 moments = mix(h0, h1, fr.y);\n    return calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n";
    pc.shaderChunks.shadowStandardPS="vec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n#endif\n// ----- Direct/Spot Sampling -----\n#ifdef GL2\n    float _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        float z = dShadowCoord.z;\n        vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n        float shadowMapSizeInv = 1.0 / shadowParams.x;\n        vec2 base_uv = floor(uv + 0.5);\n        float s = (uv.x + 0.5 - base_uv.x);\n        float t = (uv.y + 0.5 - base_uv.y);\n        base_uv -= vec2(0.5);\n        base_uv *= shadowMapSizeInv;\n        float sum = 0.0;\n        float uw0 = (3.0 - 2.0 * s);\n        float uw1 = (1.0 + 2.0 * s);\n        float u0 = (2.0 - s) / uw0 - 1.0;\n        float u1 = s / uw1 + 1.0;\n        float vw0 = (3.0 - 2.0 * t);\n        float vw1 = (1.0 + 2.0 * t);\n        float v0 = (2.0 - t) / vw0 - 1.0;\n        float v1 = t / vw1 + 1.0;\n        u0 = u0 * shadowMapSizeInv + base_uv.x;\n        v0 = v0 * shadowMapSizeInv + base_uv.y;\n        u1 = u1 * shadowMapSizeInv + base_uv.x;\n        v1 = v1 * shadowMapSizeInv + base_uv.y;\n        sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n        sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n        sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n        sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n        sum *= 1.0f / 16.0;\n        return sum;\n    }\n    float getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#else\n    float _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n        mat3 shadowKernel;\n        vec3 shadowCoord = dShadowCoord;\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n        return dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n    }\n    float _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        vec3 shadowCoord = dShadowCoord;\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n        mat3 depthKernel;\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n        return _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n    }\n    float getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams);\n    }\n    float getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n        return _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n    }\n#endif\n// ----- Point Sampling -----\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n    mat3 shadowKernel;\n    mat3 depthKernel;\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n    vec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n";
    pc.shaderChunks.shadowStandardGL2PS="float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    // http://the-witness.net/news/2013/09/shadow-mapping-summary-part-1/\n    float z = dShadowCoord.z;\n    vec2 uv = dShadowCoord.xy * shadowParams.x; // 1 unit - 1 texel\n    float shadowMapSizeInv = 1.0 / shadowParams.x;\n    vec2 base_uv = floor(uv + 0.5);\n    float s = (uv.x + 0.5 - base_uv.x);\n    float t = (uv.y + 0.5 - base_uv.y);\n    base_uv -= vec2(0.5);\n    base_uv *= shadowMapSizeInv;\n    float uw0 = (4.0 - 3.0 * s);\n    float uw1 = 7.0;\n    float uw2 = (1.0 + 3.0 * s);\n    float u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n    float u1 = (3.0 + s) / uw1;\n    float u2 = s / uw2 + 2.0;\n    float vw0 = (4.0 - 3.0 * t);\n    float vw1 = 7.0;\n    float vw2 = (1.0 + 3.0 * t);\n    float v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n    float v1 = (3.0 + t) / vw1;\n    float v2 = t / vw2 + 2.0;\n    float sum = 0.0;\n    u0 = u0 * shadowMapSizeInv + base_uv.x;\n    v0 = v0 * shadowMapSizeInv + base_uv.y;\n    u1 = u1 * shadowMapSizeInv + base_uv.x;\n    v1 = v1 * shadowMapSizeInv + base_uv.y;\n    u2 = u2 * shadowMapSizeInv + base_uv.x;\n    v2 = v2 * shadowMapSizeInv + base_uv.y;\n    sum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n    sum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n    sum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n    sum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n    sum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n    sum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n    sum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n    sum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n    sum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n    sum *= 1.0f / 144.0;\n    sum = gammaCorrectInput(sum); // gives softer gradient\n    sum = saturate(sum);\n    return sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n    return _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n";
    pc.shaderChunks.shadowStandardGL2VSPS="float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001; // prevent going to dark after the far plane\n    return _getShadowPCF5x5(shadowMap, shadowParams);\n}\n";pc.shaderChunks.shadowStandardVSPS="#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n    #ifdef SHADOWBIAS\n        dShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n    #endif\n    return _getShadowPCF3x3(shadowMap, shadowParams);\n}\n";
    pc.shaderChunks.shadowVSM8PS="float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * Z;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n    return rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n    vec4 c = texture2D(tex, texCoords);\n    vec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n    return calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n    return VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n";
    pc.shaderChunks.shadowVSMVSPS="float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n    dShadowCoord = vMainShadowUv.xyz;\n    dShadowCoord.z += shadowParams.z;\n    dShadowCoord.xyz /= vMainShadowUv.w;\n    dShadowCoord.z = min(dShadowCoord.z, 1.0);\n    return $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n";pc.shaderChunks.shadowVSM_commonPS="float linstep(float a, float b, float v) {\n    return saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n  // Remove the [0, amount] tail and linearly rescale (amount, 1].\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n    // Compute variance\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, minVariance);\n    // Compute probabilistic upper bound\n    float d = mean - moments.x;\n    float pMax = variance / (variance + (d * d));\n    pMax = reduceLightBleeding(pMax, lightBleedingReduction);\n    // One-tailed Chebyshev\n    return (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n    Z = 2.0 * Z - 1.0;\n    float warpedDepth = exp(exponent * Z);\n    moments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n    float VSMBias = vsmBias;//0.01 * 0.25;\n    float depthScale = VSMBias * exponent * warpedDepth;\n    float minVariance1 = depthScale * depthScale;\n    return chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n";
    pc.shaderChunks.skinBatchConstVS="attribute float vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i) {\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";pc.shaderChunks.skinBatchTexVS="attribute float vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
    pc.shaderChunks.skinConstVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform mat4 matrix_pose[BONE_LIMIT];\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n    return bone;\n}\n";pc.shaderChunks.skinTexVS="attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n    y = dy * (y + 0.5);\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n    mat4 bone = mat4(v1, v2, v3, v4);\n    return bone;\n}\n";
    pc.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n";pc.shaderChunks.skyboxVS="attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projection;\nvarying vec3 vViewDir;\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    // Force skybox to far Z, regardless of the clip planes on the camera\n    // Subtract a tiny fudge factor to ensure floating point errors don't\n    // still push pixels beyond far Z. See:\n    // http://www.opengl.org/discussion_boards/showthread.php/171867-skybox-problem\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n    vViewDir.x *= -1.0;\n}\n";
    pc.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n    vec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";pc.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n";
    pc.shaderChunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n    dSpecularity = vec3(1.0);\n    #ifdef MAPCOLOR\n        dSpecularity *= material_specular;\n    #endif\n    #ifdef MAPTEXTURE\n        dSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n    #endif\n    #ifdef MAPVERTEX\n        dSpecularity *= saturate(vVertexColor.$VC);\n    #endif\n}\n";
    pc.shaderChunks.specularAaNonePS="float antiAliasGlossiness(float power) {\n    return power;\n}\n";pc.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n";pc.shaderChunks.specularAaToksvigFloatPS="float antiAliasGlossiness(float power) {\n    float rlen = 1.0 / saturate(length(dNormalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * mix(1.0, toksvig, material_bumpiness);\n}\n";
    pc.shaderChunks.spotPS="float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(dLightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n";pc.shaderChunks.startPS="\nvoid main(void) {\n    dDiffuseLight = vec3(0);\n    dSpecularLight = vec3(0);\n    dReflection = vec4(0);\n    dSpecularity = vec3(0);\n";pc.shaderChunks.startVS="\nvoid main(void) {\n    gl_Position = getPosition();\n";
    pc.shaderChunks.storeEVSMPS="float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n";pc.shaderChunks.tangentBinormalVS="\nvec3 getTangent() {\n    return normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n";pc.shaderChunks.tonemappingAcesPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    float tA = 2.51;\n    float tB = 0.03;\n    float tC = 2.43;\n    float tD = 0.59;\n    float tE = 0.14;\n    vec3 x = color * exposure;\n    return (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n";
    pc.shaderChunks.tonemappingAces2PS="uniform float exposure;\n// ACES approximation by Stephen Hill\n// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\nconst mat3 ACESInputMat = mat3(\n    0.59719, 0.35458, 0.04823,\n    0.07600, 0.90834, 0.01566,\n    0.02840, 0.13383, 0.83777\n);\n// ODT_SAT => XYZ => D60_2_D65 => sRGB\nconst mat3 ACESOutputMat = mat3(\n     1.60475, -0.53108, -0.07367,\n    -0.10208,  1.10813, -0.00605,\n    -0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n    vec3 a = v * (v + 0.0245786) - 0.000090537;\n    vec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n    return a / b;\n}\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    color = color * ACESInputMat;\n    // Apply RRT and ODT\n    color = RRTAndODTFit(color);\n    color = color * ACESOutputMat;\n    // Clamp to [0, 1]\n    color = clamp(color, 0.0, 1.0);\n    return color;\n}\n";
    pc.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n    return color;\n}\n";
    pc.shaderChunks.tonemappingHejlPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    color *= exposure;\n    const float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n    const float Scl = 1.25;\n    vec3 h = max( vec3(0.0), color - vec3(0.004) );\n    return (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n";pc.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n";
    pc.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n";pc.shaderChunks.transformVS="#ifdef PIXELSNAP\n    uniform vec4 uScreenSize;\n#endif\n#ifdef NINESLICED\n    #ifndef NINESLICE\n    #define NINESLICE\n    uniform vec4 innerOffset;\n    uniform vec2 outerScale;\n    uniform vec4 atlasRect;\n    varying vec2 vTiledUv;\n    #endif\n#endif\nmat4 getModelMatrix() {\n    #ifdef DYNAMICBATCH\n        return getBoneMatrix(vertex_boneIndices);\n    #elif defined(SKIN)\n        return matrix_model * (getBoneMatrix(vertex_boneIndices.x) * vertex_boneWeights.x +\n               getBoneMatrix(vertex_boneIndices.y) * vertex_boneWeights.y +\n               getBoneMatrix(vertex_boneIndices.z) * vertex_boneWeights.z +\n               getBoneMatrix(vertex_boneIndices.w) * vertex_boneWeights.w);\n    #elif defined(INSTANCING)\n        return mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n    #else\n        return matrix_model;\n    #endif\n}\nvec4 getPosition() {\n    dModelMatrix = getModelMatrix();\n    vec3 localPos = vertex_position;\n    #ifdef NINESLICED\n        // outer and inner vertices are at the same position, scale both\n        localPos.xz *= outerScale;\n        // offset inner vertices inside\n        // (original vertices must be in [-1;1] range)\n        vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n        vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n        localPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n        vTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0; // uv = local pos - inner corner\n        localPos.xz *= -0.5; // move from -1;1 to -0.5;0.5\n        localPos = localPos.xzy;\n    #endif\n    vec4 posW = dModelMatrix * vec4(localPos, 1.0);\n    #ifdef SCREENSPACE\n        posW.zw = vec2(0.0, 1.0);\n    #endif\n    dPositionW = posW.xyz;\n    vec4 screenPos;\n    #ifdef UV1LAYOUT\n        screenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n    #else\n        #ifdef SCREENSPACE\n            screenPos = posW;\n        #else\n            screenPos = matrix_viewProjection * posW;\n        #endif\n        #ifdef PIXELSNAP\n            // snap vertex to a pixel boundary\n            screenPos.xy = (screenPos.xy * 0.5) + 0.5;\n            screenPos.xy *= uScreenSize.xy;\n            screenPos.xy = floor(screenPos.xy);\n            screenPos.xy *= uScreenSize.zw;\n            screenPos.xy = (screenPos.xy * 2.0) - 1.0;\n        #endif\n    #endif\n    return screenPos;\n}\nvec3 getWorldPosition() {\n    return dPositionW;\n}\n";
    pc.shaderChunks.transformDeclVS="attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n";pc.shaderChunks.uv0VS="\nvec2 getUv0() {\n    return vertex_texCoord0;\n}\n";pc.shaderChunks.uv1VS="\nvec2 getUv1() {\n    return vertex_texCoord1;\n}\n";pc.shaderChunks.uv9SliceVS="#ifndef NINESLICE\n#define NINESLICE\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvarying vec2 vTiledUv;\n#endif\nvarying vec2 vMask;\nvec2 getUv0() {\n    vec2 uv = vertex_position.xz;\n    // offset inner vertices inside\n    // (original vertices must be in [-1;1] range)\n    vec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n    vec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n    uv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n    uv = uv * -0.5 + 0.5;\n    uv = uv * atlasRect.zw + atlasRect.xy;\n    vMask = vertex_texCoord0.xy;\n    return uv;\n}\n";
    pc.shaderChunks.viewDirPS="void getViewDir() {\n    dViewDirW = normalize(view_position - vPositionW);\n}\n";pc.shaderChunks.viewNormalVS="\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.programlib={gammaCode:function(e){return e===pc.GAMMA_SRGB||e===pc.GAMMA_SRGBFAST?pc.shaderChunks.gamma2_2PS:e===pc.GAMMA_SRGBHDR?"#define HDR\n"+pc.shaderChunks.gamma2_2PS:pc.shaderChunks.gamma1_0PS},tonemapCode:function(e){return e===pc.TONEMAP_FILMIC?pc.shaderChunks.tonemappingFilmicPS:e===pc.TONEMAP_LINEAR?pc.shaderChunks.tonemappingLinearPS:e===pc.TONEMAP_HEJL?pc.shaderChunks.tonemappingHejlPS:e===pc.TONEMAP_ACES?pc.shaderChunks.tonemappingAcesPS:e===pc.TONEMAP_ACES2?pc.shaderChunks.tonemappingAces2PS:
        pc.shaderChunks.tonemappingNonePS},fogCode:function(e){return"linear"===e?pc.shaderChunks.fogLinearPS:"exp"===e?pc.shaderChunks.fogExpPS:"exp2"===e?pc.shaderChunks.fogExp2PS:pc.shaderChunks.fogNonePS},skinCode:function(e,a){a||(a=pc.shaderChunks);return e.supportsBoneTextures?a.skinTexVS:"#define BONE_LIMIT "+e.getBoneLimit()+"\n"+a.skinConstVS},precisionCode:function(e){var a="precision "+e.precision+" float;\n";e.webgl2&&(a+="#ifdef GL2\nprecision "+e.precision+" sampler2DShadow;\n#endif\n");return a},
        versionCode:function(e){return e.webgl2?"#version 300 es\n":""},dummyFragmentCode:function(){return"void main(void) {gl_FragColor = vec4(0.0);}"},begin:function(){return"void main(void)\n{\n"},end:function(){return"}\n"}};pc.programlib.basic={generateKey:function(e,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b+="_"+a.pass},createShaderDefinition:function(e,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.shaderChunks,d;d=
        ""+c.transformDeclVS;a.skin?(d+=pc.programlib.skinCode(e),d+=c.transformSkinnedVS):d+=c.transformVS;a.vertexColors&&(d+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(d+="attribute vec2 vertex_texCoord0;\n",d+="varying vec2 vUv0;\n");a.pass===pc.SHADER_DEPTH&&(d+="varying float vDepth;\n",d+="#ifndef VIEWMATRIX\n",d+="#define VIEWMATRIX\n",d+="uniform mat4 matrix_view;\n",d+="#endif\n",d+="#ifndef CAMERAPLANES\n",d+="#define CAMERAPLANES\n",d+="uniform vec4 camera_params;\n\n",
        d+="#endif\n");d+=pc.programlib.begin();d+="   gl_Position = getPosition();\n";a.pass===pc.SHADER_DEPTH&&(d+="    vDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n");a.vertexColors&&(d+="    vColor = vertex_color;\n");a.diffuseMap&&(d+="    vUv0 = vertex_texCoord0;\n");var f=d+=pc.programlib.end();d=pc.programlib.precisionCode(e);d=a.vertexColors?d+"varying vec4 vColor;\n":d+"uniform vec4 uColor;\n";a.diffuseMap&&(d+="varying vec2 vUv0;\n",d+="uniform sampler2D texture_diffuseMap;\n");
        a.fog&&(d+=pc.programlib.fogCode(a.fog));a.alphatest&&(d+=c.alphaTestPS);a.pass===pc.SHADER_DEPTH&&(d+="varying float vDepth;\n",d+=c.packDepthPS);d+=pc.programlib.begin();d=a.vertexColors?d+"    gl_FragColor = vColor;\n":d+"    gl_FragColor = uColor;\n";a.diffuseMap&&(d+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(d+="   alphaTest(gl_FragColor.a);\n");a.pass!==pc.SHADER_PICK&&(a.pass===pc.SHADER_DEPTH?d+="    gl_FragColor = packFloat(vDepth);\n":a.fog&&(d+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n"));
        d+=pc.programlib.end();return{attributes:b,vshader:f,fshader:d}}};pc.programlib.particle={generateKey:function(e,a){var b="particle",c;for(c in a)a.hasOwnProperty(c)&&(b+=a[c]);return b},_animTex:function(e,a){var b;b=""+(e.animTexLoop?a.particleAnimFrameLoopVS:a.particleAnimFrameClampVS);return b+=a.particleAnimTexVS},createShaderDefinition:function(e,a){var b=pc.shaderChunks,c="",d=pc.programlib.precisionCode(e)+"\n";e.webgl2&&(c+="#define GL2\n",d+="#define GL2\n");c+="#define VERTEXSHADER\n";a.animTex&&(c+="\nuniform vec4 animTexParams;\n");2==a.normal&&(c+=
        "\nvarying mat3 ParticleMat;\n");1==a.normal&&(c+="\nvarying vec3 Normal;\n");a.soft&&(c+="\nvarying float vDepth;\n");a.useCpu?(0<a.soft&&(c+=b.screenDepthPS),c+=b.particle_cpuVS,a.localSpace&&(c+=b.particle_localShiftVS),a.animTex&&(c+=this._animTex(a,b)),a.alignToMotion&&(c+=b.particle_pointAlongVS),c+=a.mesh?b.particle_meshVS:b.particle_billboardVS,1==a.normal&&(c+=b.particle_normalVS),2==a.normal&&(c+=b.particle_TBNVS),0<a.stretch&&(c+=b.particle_stretchVS),c+=b.particle_cpu_endVS):(c+=b.particle_initVS,
        c+=a.pack8?b.particleInputRgba8PS:b.particleInputFloatPS,0<a.soft&&(c+=b.screenDepthPS),c+=b.particleVS,a.localSpace&&(c+=b.particle_localShiftVS),a.animTex&&(c+=this._animTex(a,b)),a.wrap&&(c+=b.particle_wrapVS),a.alignToMotion&&(c+=b.particle_pointAlongVS),c+=a.mesh?b.particle_meshVS:b.particle_billboardVS,1==a.normal&&(c+=b.particle_normalVS),2==a.normal&&(c+=b.particle_TBNVS),0<a.stretch&&(c+=b.particle_stretchVS),c+=b.particle_endVS);0<a.soft&&(c+=b.particle_softVS);c+="}\n";0<a.normal&&(1==
    a.normal?d+="\nvarying vec3 Normal;\n":2==a.normal&&(d+="\nvarying mat3 ParticleMat;\n"),d+="\nuniform vec3 lightCube[6];\n");a.soft&&(d+="\nvarying float vDepth;\n");0===a.normal&&"none"===a.fog&&(a.srgb=!1);d+=pc.programlib.gammaCode(a.gamma);d+=pc.programlib.tonemapCode(a.toneMap);d="linear"===a.fog?d+b.fogLinearPS:"exp"===a.fog?d+b.fogExpPS:"exp2"===a.fog?d+b.fogExp2PS:d+b.fogNonePS;2==a.normal&&(d+="\nuniform sampler2D normalMap;\n");0<a.soft&&(d+=b.screenDepthPS);d+=b.particlePS;0<a.soft&&(d+=
        b.particle_softPS);1==a.normal&&(d+="\nvec3 normal = Normal;\n");2==a.normal&&(d+=b.particle_normalMapPS);0<a.normal&&(d+=a.halflambert?b.particle_halflambertPS:b.particle_lambertPS);0<a.normal&&(d+=b.particle_lightingPS);a.blend==pc.BLEND_NORMAL?d+=b.particle_blendNormalPS:a.blend==pc.BLEND_ADDITIVE?d+=b.particle_blendAddPS:a.blend==pc.BLEND_MULTIPLICATIVE&&(d+=b.particle_blendMultiplyPS);d+=b.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(c),vshader:c,fshader:d}}};var _oldChunkWarn=function(e,a){},_oldChunkFloat=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef MAPFLOAT\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkColor=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef MAPCOLOR\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTex=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef MAPTEXTURE\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTexColor=function(e,a,b){_oldChunkWarn(b,a);return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+
        e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTexFloat=function(e,a,b){_oldChunkWarn(b,a);return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkVert=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef MAPVERTEX\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkVertColor=function(e,a,b){_oldChunkWarn(b,a);return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+
        e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkVertFloat=function(e,a,b){_oldChunkWarn(b,a);return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformSkin=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef SKIN\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformDynbatch=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef DYNAMICBATCH\n"+
        e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformInstanced=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef INSTANCING\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformPixelSnap=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef PIXELSNAP\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformScreenSpace=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef SCREENSPACE\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformScreenSpaceBatch=
        function(e,a,b){_oldChunkWarn(b,a);return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"},_oldChunkTransformUv1=function(e,a,b){_oldChunkWarn(b,a);return"\n#ifdef UV1LAYOUT\n"+e+"\n#else\n"+pc.shaderChunks[a]+"\n#endif\n"};
    pc.programlib.standard={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:_oldChunkTex},aoVertPS:{n:"aoPS",f:_oldChunkVert},diffuseConstPS:{n:"diffusePS",f:_oldChunkColor},diffuseTexPS:{n:"diffusePS",f:_oldChunkTex},diffuseTexConstPS:{n:"diffusePS",f:_oldChunkTexColor},diffuseVertPS:{n:"diffusePS",f:_oldChunkVert},diffuseVertConstPS:{n:"diffusePS",f:_oldChunkVertColor},emissiveConstPS:{n:"emissivePS",f:_oldChunkColor},emissiveTexPS:{n:"emissivePS",f:_oldChunkTex},emissiveTexConstPS:{n:"emissivePS",f:_oldChunkTexColor},
        emissiveTexConstFloatPS:{n:"emissivePS",f:_oldChunkTexFloat},emissiveVertPS:{n:"emissivePS",f:_oldChunkVert},emissiveVertConstPS:{n:"emissivePS",f:_oldChunkVertColor},emissiveVertConstFloatPS:{n:"emissivePS",f:_oldChunkVertFloat},glossConstPS:{n:"glossPS",f:_oldChunkFloat},glossTexPS:{n:"glossPS",f:_oldChunkTex},glossTexConstPS:{n:"glossPS",f:_oldChunkTexFloat},glossVertPS:{n:"glossPS",f:_oldChunkVert},glossVertConstPS:{n:"glossPS",f:_oldChunkVertFloat},metalnessConstPS:{n:"metalnessPS",f:_oldChunkFloat},
        metalnessTexPS:{n:"metalnessPS",f:_oldChunkTex},metalnessTexConstPS:{n:"metalnessPS",f:_oldChunkTexFloat},metalnessVertPS:{n:"metalnessPS",f:_oldChunkVert},metalnessVertConstPS:{n:"metalnessPS",f:_oldChunkVertFloat},opacityConstPS:{n:"opacityPS",f:_oldChunkFloat},opacityTexPS:{n:"opacityPS",f:_oldChunkTex},opacityTexConstPS:{n:"opacityPS",f:_oldChunkTexFloat},opacityVertPS:{n:"opacityPS",f:_oldChunkVert},opacityVertConstPS:{n:"opacityPS",f:_oldChunkVertFloat},specularConstPS:{n:"specularPS",f:_oldChunkColor},
        specularTexPS:{n:"specularPS",f:_oldChunkTex},specularTexConstPS:{n:"specularPS",f:_oldChunkTexColor},specularVertPS:{n:"specularPS",f:_oldChunkVert},specularVertConstPS:{n:"specularPS",f:_oldChunkVertColor},transformBatchSkinnedVS:{n:"transformVS",f:_oldChunkTransformDynbatch},transformInstancedVS:{n:"transformVS",f:_oldChunkTransformInstanced},transformPixelSnapVS:{n:"transformVS",f:_oldChunkTransformPixelSnap},transformScreenSpaceVS:{n:"transformVS",f:_oldChunkTransformScreenSpace},transformScreenSpaceBatchSkinned:{n:"transformVS",
            f:_oldChunkTransformScreenSpaceBatch},transformSkinned:{n:"transformVS",f:_oldChunkTransformSkin},transformUv1:{n:"transformVS",f:_oldChunkTransformUv1}},generateKey:function(e,a){var b,c=[],d="standard";for(b in a)if(a.hasOwnProperty(b))if("chunks"===b)for(var f in a[b])a[b].hasOwnProperty(f)&&c.push(f+a.chunks[f]);else a[b]&&c.push(b);c.sort();for(b in c)c.hasOwnProperty(b)&&(d+=c[b]+a[c[b]]);if(a.lights)for(c=0;c<a.lights.length;c++)b=a.lights[c],d+=b.key;return pc.hashCode(d)},_correctChannel:function(e,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           a){if(0<pc._matTex2D[e]){if(pc._matTex2D[e]<a.length)return a.substring(0,pc._matTex2D[e]);if(pc._matTex2D[e]>a.length){for(var b=a,c=b.charAt(b.length-1),d=pc._matTex2D[e]-b.length,f=0;f<d;f++)b+=c;return b}return a}},_setMapTransform:function(e,a,b,c){e[0]+="uniform vec4 texture_"+a+"MapTransform;\n";var d=b+100*c;e[3][d]||(e[1]+="varying vec2 vUV"+c+"_"+b+";\n",e[2]+="   vUV"+c+"_"+b+" = uv"+c+" * texture_"+a+"MapTransform.xy + texture_"+a+"MapTransform.zw;\n",e[3][d]=!0);return e},_uvSource:function(e,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        a){return 0===e?"vUv"+a:"vUV"+a+"_"+e},_addMapDef:function(e,a){var b="\n#undef "+e+"\n";a&&(b+=" #define "+e+"\n");return b},_addMapDefs:function(e,a,b,c){e=""+this._addMapDef("MAPFLOAT",e);e+=this._addMapDef("MAPCOLOR",a);e+=this._addMapDef("MAPVERTEX",b);return e+=this._addMapDef("MAPTEXTURE",c)},_addMap:function(e,a,b,c,d,f){var g=e+"Map",k=a[e+"Tint"],l=a[e+"VertexColor"],m=a[g];d||(d=b[e+"PS"]);m&&(b=g+"Channel",c=this._uvSource(a[g+"Transform"],a[g+"Uv"])+c,d=d.replace(/\$UV/g,c).replace(/\$CH/g,
        a[b]),void 0!==f&&(d=d.replace(/\$texture2DSAMPLE/g,0===f?"texture2DSRGB":1===f?"texture2DRGBM":"texture2D")));l&&(d=d.replace(/\$VC/g,a[e+"VertexColorChannel"]));d=this._addMapDefs(1===k,3===k,l,m)+d;return d.replace(/\$/g,"")},_nonPointShadowMapProjection:function(e,a,b){return!a._normalOffsetBias||a._isVsm?a._type===pc.LIGHTTYPE_SPOT?a._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbuffer"+b:"       getShadowCoordPersp"+b:"       getShadowCoordOrtho"+b:a._type===pc.LIGHTTYPE_SPOT?
        a._isPcf&&(e.webgl2||e.extStandardDerivatives)?"       getShadowCoordPerspZbufferNormalOffset"+b:"       getShadowCoordPerspNormalOffset"+b:"       getShadowCoordOrthoNormalOffset"+b},_addVaryingIfNeeded:function(e,a,b){return 0<=e.indexOf(b)?"varying "+a+" "+b+";\n":""},createShaderDefinition:function(e,a){var b,c,d=0<a.lights.length;a.dirLightMap&&(d=!0,a.useSpecular=!0);a.shadingModel===pc.SPECULAR_PHONG?(a.fresnelModel=0,a.specularAntialias=!1,a.prefilteredCubemap=!1,a.dpAtlas=!1,a.ambientSH=
        !1):a.fresnelModel=0===a.fresnelModel?pc.FRESNEL_SCHLICK:a.fresnelModel;var f=(a.cubeMap||a.prefilteredCubemap&&a.useSpecular)&&!a.sphereMap&&!a.dpAtlas,g=a.sphereMap||f||a.dpAtlas,k=pc.precalculatedTangents,l=a.useTexCubeLod;a.cubeMap&&(a.sphereMap=null);a.dpAtlas&&(a.prefilteredCubemap=null);a.useSpecular||(a.specularMap=a.glossMap=null);var m=d||g||a.ambientSH||a.prefilteredCubemap||a.heightMap,n=a.pass>=pc.SHADER_SHADOW&&17>=a.pass;this.options=a;var h="",r="",p="",q=pc.shaderChunks,t,x={vertex_position:pc.SEMANTIC_POSITION};
        if(a.chunks){var y={};for(c in q)q.hasOwnProperty(c)&&(a.chunks[c]?(t=a.chunks[c],0<=t.indexOf("vertex_normal")&&(x.vertex_normal=pc.SEMANTIC_NORMAL),0<=t.indexOf("vertex_tangent")&&(x.vertex_tangent=pc.SEMANTIC_TANGENT),0<=t.indexOf("vertex_texCoord0")&&(x.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0),0<=t.indexOf("vertex_texCoord1")&&(x.vertex_texCoord1=pc.SEMANTIC_TEXCOORD1),0<=t.indexOf("vertex_color")&&(x.vertex_color=pc.SEMANTIC_COLOR),0<=t.indexOf("vertex_boneWeights")&&(x.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT),
        0<=t.indexOf("vertex_boneIndices")&&(x.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES),y[c]=t):y[c]=q[c]);for(c in a.chunks)(q=this._oldChunkToNew[c])&&(y[q.n]=q.f(a.chunks[c],q.n,c));q=y}h+=q.baseVS;y=-1;if(!a.noShadow&&!a.twoSidedLighting){for(b=0;b<a.lights.length;b++)if(t=a.lights[b]._type,a.lights[b].castShadows&&t===pc.LIGHTTYPE_DIRECTIONAL){h+="uniform mat4 light"+b+"_shadowMatrixVS;\n";h+="uniform vec3 light"+b+"_shadowParamsVS;\n";h+="uniform vec3 light"+b+(t===pc.LIGHTTYPE_DIRECTIONAL?"_directionVS":
            "_positionVS")+";\n";y=b;break}0<=y&&(h+=q.shadowCoordVS)}r+="   vPositionW    = getWorldPosition();\n";a.pass===pc.SHADER_DEPTH&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n",h+="#define VIEWMATRIX\n",h+="uniform mat4 matrix_view;\n",h+="#endif\n",h+="#ifndef CAMERAPLANES\n",h+="#define CAMERAPLANES\n",h+="uniform vec4 camera_params;\n\n",h+="#endif\n",r+="    vDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n");a.useInstancing&&(x.instance_line1=pc.SEMANTIC_TEXCOORD2,x.instance_line2=
            pc.SEMANTIC_TEXCOORD3,x.instance_line3=pc.SEMANTIC_TEXCOORD4,x.instance_line4=pc.SEMANTIC_TEXCOORD5,h+=q.instancingVS);m&&(x.vertex_normal=pc.SEMANTIC_NORMAL,r+="   vNormalW    = dNormalW = getNormal();\n",a.sphereMap&&16>=e.fragmentUniformsCount&&(h+=q.viewNormalVS,r+="   vNormalV    = getViewNormal();\n"),(a.heightMap||a.normalMap)&&k&&(x.vertex_tangent=pc.SEMANTIC_TANGENT,h+=q.tangentBinormalVS,r+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"),0<=y&&(t=a.lights[y]._type,r=
            t===pc.LIGHTTYPE_DIRECTIONAL?r+("   dLightDirNormW = light"+y+"_directionVS;\n"):r+("   getLightDirPoint(light"+y+"_positionVS);\n"),r+=this._nonPointShadowMapProjection(e,a.lights[y],"(light"+y+"_shadowMatrixVS, light"+y+"_shadowParamsVS);\n")));t=[];var w=[],u,v,z;for(c in pc._matTex2D)b=c+"Map",a[c+"VertexColor"]&&(u=c+"VertexColorChannel",a[u]=this._correctChannel(c,a[u])),a[b]&&(u=b+"Channel",v=b+"Transform",z=b+"Uv",a[z]=Math.min(a[z],1),a[u]=this._correctChannel(c,a[u]),z=a[z],t[z]=!0,w[z]=
            w[z]||a[b]&&!a[v]);a.forceUv1&&(t[1]=!0);for(b=0;2>b;b++)t[b]&&(x["vertex_texCoord"+b]=pc["SEMANTIC_TEXCOORD"+b],h+=q["uv"+b+"VS"],r+="   vec2 uv"+b+" = getUv"+b+"();\n"),w[b]&&(r+="   vUv"+b+" = uv"+b+";\n");t=[h,p,r,[]];for(c in pc._matTex2D)b=c+"Map",a[b]&&(v=b+"Transform",a[v]&&(z=b+"Uv",this._setMapTransform(t,c,a[v],a[z])));h=t[0];p=t[1];r=t[2];a.vertexColors&&(x.vertex_color=pc.SEMANTIC_COLOR,r+="   vVertexColor = vertex_color;\n");a.skin?(x.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,x.vertex_boneIndices=
            pc.SEMANTIC_BLENDINDICES,h+=pc.programlib.skinCode(e,q),h+="#define SKIN\n"):a.useInstancing&&(h+="#define INSTANCING\n");a.screenSpace&&(h+="#define SCREENSPACE\n");a.pixelSnap&&(h+="#define PIXELSNAP\n");h+=q.transformVS;m&&(h+=q.normalVS);h+="\n";h+=q.startVS;h+=r;c=h+="}";t=p;p=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv");p+=this._addVaryingIfNeeded(h,"vec4","vVertexColor");p+=this._addVaryingIfNeeded(h,"vec3","vPositionW");p+=this._addVaryingIfNeeded(h,"vec3","vNormalV");p+=this._addVaryingIfNeeded(h,
            "vec3","vNormalW");p+=this._addVaryingIfNeeded(h,"vec3","vTangentW");p+=this._addVaryingIfNeeded(h,"vec3","vBinormalW");p+=this._addVaryingIfNeeded(h,"vec2","vUv0");p+=this._addVaryingIfNeeded(h,"vec2","vUv1");p+=t;c=p+c;h="";e.webgl2?(h=pc.programlib.versionCode(e),q.extensionVS&&(h+=q.extensionVS+"\n"),c=h+q.gles3VS+c):(q.extensionVS&&(h=q.extensionVS+"\n"),c=h+c);a.forceFragmentPrecision&&"highp"!=a.forceFragmentPrecision&&"mediump"!==a.forceFragmentPrecision&&"lowp"!==a.forceFragmentPrecision&&
        (a.forceFragmentPrecision=null);a.forceFragmentPrecision&&("highp"===a.forceFragmentPrecision&&"highp"!==e.maxPrecision&&(a.forceFragmentPrecision="mediump"),"mediump"===a.forceFragmentPrecision&&"lowp"===e.maxPrecision&&(a.forceFragmentPrecision="lowp"));h="";e.webgl2&&(h+=pc.programlib.versionCode(e));e.extStandardDerivatives&&!e.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n");q.extensionPS&&(h+=q.extensionPS+"\n");e.webgl2&&(h+=q.gles3PS);h+=a.forceFragmentPrecision?"precision "+
            a.forceFragmentPrecision+" float;\n\n":pc.programlib.precisionCode(e);if(a.pass===pc.SHADER_PICK)return h+="uniform vec4 uColor;",h+=p,a.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity",a,q,""),h+=q.alphaTestPS),h+=pc.programlib.begin(),a.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h+="    gl_FragColor = uColor;\n",h+=pc.programlib.end(),{attributes:x,vshader:c,fshader:h};if(a.pass===pc.SHADER_DEPTH)return h+="varying float vDepth;\n",h+=p,h+=q.packDepthPS,a.alphaTest&&
        (h+="float dAlpha;\n",h+=this._addMap("opacity",a,q,""),h+=q.alphaTestPS),h+=pc.programlib.begin(),a.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h+="    gl_FragColor = packFloat(vDepth);\n",h+=pc.programlib.end(),{attributes:x,vshader:c,fshader:h};if(n){f=a.pass-pc.SHADER_SHADOW;t=Math.floor(f/5);f-=5*t;e.extStandardDerivatives&&!e.webgl2&&(h+="uniform vec2 polygonOffset;\n");f===pc.SHADOW_VSM32?h=e.extTextureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":
            f===pc.SHADOW_VSM16&&(h+="#define VSM_EXPONENT 5.54\n\n");t!==pc.LIGHTTYPE_DIRECTIONAL&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n");h+=p;a.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity",a,q,""),h+=q.alphaTestPS);f!==pc.SHADOW_PCF3||e.webgl2&&t!==pc.LIGHTTYPE_POINT?f===pc.SHADOW_VSM8&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="    vec2 enc = vec2(1.0, 255.0) * v;\n",h+="    enc = fract(enc);\n",h+="    enc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="    return enc;\n",
            h+="}\n\n"):h+=q.packDepthPS;h+=pc.programlib.begin();a.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n");var A=f===pc.SHADOW_VSM8||f===pc.SHADOW_VSM16||f===pc.SHADOW_VSM32,h=t===pc.LIGHTTYPE_POINT||A&&t!==pc.LIGHTTYPE_DIRECTIONAL?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n";f!==pc.SHADOW_PCF3||e.webgl2&&t!==pc.LIGHTTYPE_POINT?h=f===pc.SHADOW_PCF3||f===pc.SHADOW_PCF5?h+"   gl_FragColor = vec4(1.0);\n":
            f===pc.SHADOW_VSM8?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+q.storeEVSMPS:(e.extStandardDerivatives&&!e.webgl2&&(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="   gl_FragColor = packFloat(depth);\n");h+=pc.programlib.end();return{attributes:x,vshader:c,fshader:h}}if(a.customFragmentShader)return h+=a.customFragmentShader,
            {attributes:x,vshader:c,fshader:h,tag:pc.SHADERTAG_MATERIAL};h+=p;p=h+=q.basePS;h="";r=0;w=[];z=v=!1;for(b=0;b<a.lights.length;b++)if(n=a.lights[b],t=n._type,h+="uniform vec3 light"+b+"_color;\n",t===pc.LIGHTTYPE_DIRECTIONAL?h+="uniform vec3 light"+b+"_direction;\n":(h+="uniform vec3 light"+b+"_position;\n",h+="uniform float light"+b+"_radius;\n",t===pc.LIGHTTYPE_SPOT&&(h+="uniform vec3 light"+b+"_direction;\n",h+="uniform float light"+b+"_innerConeAngle;\n",h+="uniform float light"+b+"_outerConeAngle;\n")),
            n.castShadows&&!a.noShadow&&(h+="uniform mat4 light"+b+"_shadowMatrix;\n",h=t!==pc.LIGHTTYPE_DIRECTIONAL?h+("uniform vec4 light"+b+"_shadowParams;\n"):h+("uniform vec3 light"+b+"_shadowParams;\n"),h=t===pc.LIGHTTYPE_POINT?h+("uniform samplerCube light"+b+"_shadowMap;\n"):n._isPcf&&e.webgl2?h+("uniform sampler2DShadow light"+b+"_shadowMap;\n"):h+("uniform sampler2D light"+b+"_shadowMap;\n"),r++,w[n._shadowType]=!0,n._isVsm&&(v=!0),n._isPcf&&(e.webgl2||e.extStandardDerivatives)&&t===pc.LIGHTTYPE_SPOT&&
            (z=!0)),n._cookie)if(n._cookie._cubemap)t===pc.LIGHTTYPE_POINT&&(h+="uniform samplerCube light"+b+"_cookie;\n",h+="uniform float light"+b+"_cookieIntensity;\n",!n.castShadows||a.noShadow)&&(h+="uniform mat4 light"+b+"_shadowMatrix;\n");else if(t===pc.LIGHTTYPE_SPOT){h+="uniform sampler2D light"+b+"_cookie;\n";h+="uniform float light"+b+"_cookieIntensity;\n";if(!n.castShadows||a.noShadow)h+="uniform mat4 light"+b+"_shadowMatrix;\n";n._cookieTransform&&(h+="uniform vec4 light"+b+"_cookieMatrix;\n",
            h+="uniform vec2 light"+b+"_cookieOffset;\n")}h+="\n";t=a.heightMap?" + dUvOffset":"";b=a.fastTbn?q.TBNfastPS:q.TBNPS;m&&(a.normalMap&&k?(h+=a.packedNormal?q.normalXYPS:q.normalXYZPS,k=this._uvSource(a.normalMapTransform,a.normalMapUv)+t,h=a.needsNormalFloat?h+(a.fastTbn?q.normalMapFloatTBNfastPS:q.normalMapFloatPS).replace(/\$UV/g,k):h+q.normalMapPS.replace(/\$UV/g,k),h+=b):h+=q.normalVertexPS);h+=pc.programlib.gammaCode(a.gamma);h+=pc.programlib.tonemapCode(a.toneMap);h+=pc.programlib.fogCode(a.fog);
        a.useRgbm&&(h+=q.rgbmPS);if(f||a.prefilteredCubemap)h+=a.fixSeams?q.fixCubemapSeamsStretchPS:q.fixCubemapSeamsNonePS;m&&(h+=0<a.cubeMapProjection?q.cubeMapProjectBoxPS:q.cubeMapProjectNonePS,h+=a.skyboxIntensity?q.envMultiplyPS:q.envConstPS);h+=this._addMap("diffuse",a,q,t);if(a.blendType!==pc.BLEND_NONE||a.alphaTest||a.alphaToCoverage)h+=this._addMap("opacity",a,q,t);h+=this._addMap("emissive",a,q,t,null,a.emissiveFormat);a.useSpecular&&(d||g)&&(h=a.specularAntialias&&a.normalMap?a.needsNormalFloat&&
        m?h+q.specularAaToksvigFloatPS:h+q.specularAaToksvigPS:h+q.specularAaNonePS,h+=this._addMap(a.useMetalness?"metalness":"specular",a,q,t),h+=this._addMap("gloss",a,q,t),0<a.fresnelModel&&(a.fresnelModel===pc.FRESNEL_SIMPLE?h+=q.fresnelSimplePS:a.fresnelModel===pc.FRESNEL_SCHLICK?h+=q.fresnelSchlickPS:a.fresnelModel===pc.FRESNEL_COMPLEX&&(h+=q.fresnelComplexPS)));a.heightMap&&(a.normalMap||(h+=b),h+=this._addMap("height",a,q,"",q.parallaxPS));if(k=a.aoMap||a.aoVertexColor)h+=this._addMap("ao",a,q,t,
            a.aoVertexColor?q.aoVertPS:q.aoTexPS),a.occludeSpecular&&(h=a.occludeSpecular===pc.SPECOCC_AO?h+(a.occludeSpecularFloat?q.aoSpecOccSimplePS:q.aoSpecOccConstSimplePS):h+(a.occludeSpecularFloat?q.aoSpecOccPS:q.aoSpecOccConstPS));b=a.rgbmReflection?"decodeRGBM":a.hdrReflection?"":"gammaCorrectInput";f&&(h=a.prefilteredCubemap?l?h+q.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,b):h+q.reflectionPrefilteredCubePS.replace(/\$DECODE/g,b):h+q.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,a.rgbmReflection?
            "textureCubeRGBM":a.hdrReflection?"textureCube":"textureCubeSRGB"));a.sphereMap&&(b=16<e.fragmentUniformsCount?q.reflectionSpherePS:q.reflectionSphereLowPS,b=b.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?"texture2DRGBM":a.hdrReflection?"texture2D":"texture2DSRGB"),h+=b);a.dpAtlas&&(h+=q.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?"texture2DRGBM":a.hdrReflection?"texture2D":"texture2DSRGB"));(f||a.sphereMap||a.dpAtlas)&&a.refraction&&(h+=q.refractionPS);0<r&&(w[pc.SHADOW_PCF3]&&
        (h+=q.shadowStandardPS),w[pc.SHADOW_PCF5]&&(h+=q.shadowStandardGL2PS),v&&(h+=q.shadowVSM_commonPS,w[pc.SHADOW_VSM8]&&(h+=q.shadowVSM8PS),w[pc.SHADOW_VSM16]&&(h+=e.extTextureHalfFloatLinear?q.shadowEVSMPS.replace(/\$/g,"16"):q.shadowEVSMnPS.replace(/\$/g,"16")),w[pc.SHADOW_VSM32]&&(h+=e.extTextureFloatLinear?q.shadowEVSMPS.replace(/\$/g,"32"):q.shadowEVSMnPS.replace(/\$/g,"32"))),e.webgl2||e.extStandardDerivatives||(h+=q.biasConstPS),h+=q.shadowCoordPS+q.shadowCommonPS,z&&(h+=q.shadowCoordPerspZbufferPS),
        0<=y&&(w[pc.SHADOW_PCF3]&&(h+=q.shadowStandardVSPS),w[pc.SHADOW_PCF5]&&(h+=q.shadowStandardGL2VSPS),v&&(w[pc.SHADOW_VSM8]&&(h+=q.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),w[pc.SHADOW_VSM16]&&(h+=q.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),w[pc.SHADOW_VSM32]&&(h+=q.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32")))));d&&(h+=q.lightDiffuseLambertPS);b=!1;a.useSpecular?(d&&(h+=a.shadingModel===pc.SPECULAR_PHONG?q.lightSpecularPhongPS:q.lightSpecularBlinnPS),
            a.sphereMap||f||a.dpAtlas||0<a.fresnelModel?h=0<a.fresnelModel?a.conserveEnergy?h+q.combineDiffuseSpecularPS:h+q.combineDiffuseSpecularNoConservePS:h+q.combineDiffuseSpecularOldPS:a.diffuseMap?h+=q.combineDiffuseSpecularNoReflPS:(h+=q.combineDiffuseSpecularNoReflSeparateAmbientPS,b=!0)):h+=q.combineDiffusePS;n=!0;if(a.lightMap||a.lightVertexColor)h+=this._addMap("light",a,q,t,a.dirLightMap?q.lightmapDirPS:q.lightmapSinglePS,a.lightMapFormat),n=a.lightMapWithoutAmbient;n&&(t=a.rgbmAmbient?"decodeRGBM":
            a.hdrAmbient?"":"gammaCorrectInput",h=a.ambientSH?h+q.ambientSHPS:a.prefilteredCubemap?l?h+q.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,t):h+q.ambientPrefilteredCubePS.replace(/\$DECODE/g,t):h+q.ambientConstantPS);a.ambientTint&&!b&&(h+="uniform vec3 material_ambient;\n");a.alphaTest&&(h+=q.alphaTestPS);a.msdf&&(h+=q.msdfPS);m&&(h+=q.viewDirPS,a.useSpecular&&(h+=q.reflDirPS));z=v=w=r=l=!1;h+=q.startPS;m&&(h=a.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":h+
            "   dVertexNormalW = vNormalW;\n",a.heightMap||a.normalMap)&&(a.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",h+="   dBinormalW = vBinormalW;\n"));t=!1;a.blendType!==pc.BLEND_NONE||a.alphaTest||a.alphaToCoverage?a.heightMap&&a.opacityMap?t=!0:(h+="   getOpacity();\n",a.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";if(m){h+="   getViewDir();\n";
            if(a.heightMap||a.normalMap)h+="   getTBN();\n";a.heightMap&&(h+="   getParallax();\n");t&&(h+="   getOpacity();\n",a.alphaTest&&(h+="   alphaTest(dAlpha);\n"));h+="   getNormal();\n";a.useSpecular&&(h+="   getReflDir();\n")}h+="   getAlbedo();\n";if(d&&a.useSpecular||g)h+="   getSpecularity();\n",h+="   getGlossiness();\n",0<a.fresnelModel&&(h+="   getFresnel();\n");n&&(h+="   addAmbient();\n");a.ambientTint&&!b&&(h+="   dDiffuseLight *= material_ambient;\n");k&&!a.occludeDirect&&(h+="    applyAO();\n");
        if(a.lightMap||a.lightVertexColor)h+="   addLightMap();\n";if(d||g){if(f||a.sphereMap||a.dpAtlas)h+="   addReflection();\n";a.dirLightMap&&(h+="   addDirLightMap();\n");for(b=0;b<a.lights.length;b++)n=a.lights[b],t=n._type,g=!1,t===pc.LIGHTTYPE_DIRECTIONAL?(h+="   dLightDirNormW = light"+b+"_direction;\n",h+="   dAtten = 1.0;\n"):(n._cookie&&(t!==pc.LIGHTTYPE_SPOT||n._cookie._cubemap?t===pc.LIGHTTYPE_POINT&&n._cookie._cubemap&&(g=z=!0):g=z=!0),h+="   getLightDirPoint(light"+b+"_position);\n",l=!0,
        g&&(h=t===pc.LIGHTTYPE_SPOT?h+("   dAtten3 = getCookie2D"+(n._cookieFalloff?"":"Clip")+(n._cookieTransform?"Xform":"")+"(light"+b+"_cookie, light"+b+"_shadowMatrix, light"+b+"_cookieIntensity"+(n._cookieTransform?", light"+b+"_cookieMatrix, light"+b+"_cookieOffset":"")+")."+n._cookieChannel+";\n"):h+("   dAtten3 = getCookieCube(light"+b+"_cookie, light"+b+"_shadowMatrix, light"+b+"_cookieIntensity)."+n._cookieChannel+";\n")),n._falloffMode===pc.LIGHTFALLOFF_LINEAR?(h+="   dAtten = getFalloffLinear(light"+
            b+"_radius);\n",r=!0):(h+="   dAtten = getFalloffInvSquared(light"+b+"_radius);\n",w=!0),h+="   if (dAtten > 0.00001) {\n",t!==pc.LIGHTTYPE_SPOT||g&&!n._cookieFalloff||(h+="       dAtten *= getSpotEffect(light"+b+"_direction, light"+b+"_innerConeAngle, light"+b+"_outerConeAngle);\n",v=!0)),h+="       dAtten *= getLightDiffuse();\n",n.castShadows&&!a.noShadow&&(m=null,n._shadowType===pc.SHADOW_VSM8?(m="VSM8",A="0.0"):n._shadowType===pc.SHADOW_VSM16?(m="VSM16",A="5.54"):n._shadowType===pc.SHADOW_VSM32?
            (m="VSM32",A=e.extTextureFloatHighPrecision?"15.0":"5.54"):m=n._shadowType===pc.SHADOW_PCF5?"PCF5x5":"PCF3x3",null!==m&&(t===pc.LIGHTTYPE_POINT?(d="(light"+b+"_shadowMap, light"+b+"_shadowParams);\n",n._normalOffsetBias&&(h+="       normalOffsetPointShadow(light"+b+"_shadowParams);\n"),h+="       dAtten *= getShadowPoint"+m+d):(y===b?m+="VS":(d="(light"+b+"_shadowMatrix, light"+b+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(e,a.lights[b],d)),t===pc.LIGHTTYPE_SPOT&&(m="Spot"+m),h+="       dAtten *= getShadow"+
            m+"(light"+b+"_shadowMap, light"+b+"_shadowParams"+(n._isVsm?", "+A:"")+");\n"))),h+="       dDiffuseLight += dAtten * light"+b+"_color"+(g?" * dAtten3":"")+";\n",a.useSpecular&&(h+="       dAtten *= getLightSpecular();\n",h+="       dSpecularLight += dAtten * light"+b+"_color"+(g?" * dAtten3":"")+";\n"),t!==pc.LIGHTTYPE_DIRECTIONAL&&(h+="   }\n"),h+="\n";(f||a.sphereMap||a.dpAtlas)&&a.refraction&&(h+="   addRefraction();\n")}h+="\n";k&&(a.occludeDirect&&(h+="    applyAO();\n"),a.occludeSpecular&&
        (h+="    occludeSpecular();\n"));h+=q.endPS;h=a.blendType===pc.BLEND_NORMAL||a.blendType===pc.BLEND_ADDITIVEALPHA||a.alphaToCoverage?h+q.outputAlphaPS:a.blendType===pc.BLEND_PREMULTIPLIED?h+q.outputAlphaPremulPS:h+q.outputAlphaOpaquePS;a.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n");h+="\n";h+=pc.programlib.end();l&&(h=q.lightDirPointPS+h);r&&(h=q.falloffLinearPS+h);w&&(h=q.falloffInvSquaredPS+h);v&&(h=q.spotPS+h);z&&(h=q.cookiePS+h);q="";h.includes("dReflection")&&(q+="vec4 dReflection;\n");
        h.includes("dTBN")&&(q+="mat3 dTBN;\n");h.includes("dAlbedo")&&(q+="vec3 dAlbedo;\n");h.includes("dEmission")&&(q+="vec3 dEmission;\n");h.includes("dNormalW")&&(q+="vec3 dNormalW;\n");h.includes("dVertexNormalW")&&(q+="vec3 dVertexNormalW;\n");h.includes("dTangentW")&&(q+="vec3 dTangentW;\n");h.includes("dBinormalW")&&(q+="vec3 dBinormalW;\n");h.includes("dViewDirW")&&(q+="vec3 dViewDirW;\n");h.includes("dReflDirW")&&(q+="vec3 dReflDirW;\n");h.includes("dDiffuseLight")&&(q+="vec3 dDiffuseLight;\n");
        h.includes("dSpecularLight")&&(q+="vec3 dSpecularLight;\n");h.includes("dLightDirNormW")&&(q+="vec3 dLightDirNormW;\n");h.includes("dLightDirW")&&(q+="vec3 dLightDirW;\n");h.includes("dLightPosW")&&(q+="vec3 dLightPosW;\n");h.includes("dShadowCoord")&&(q+="vec3 dShadowCoord;\n");h.includes("dNormalMap")&&(q+="vec3 dNormalMap;\n");h.includes("dSpecularity")&&(q+="vec3 dSpecularity;\n");h.includes("dUvOffset")&&(q+="vec2 dUvOffset;\n");h.includes("dGlossiness")&&(q+="float dGlossiness;\n");h.includes("dAlpha")&&
        (q+="float dAlpha;\n");h.includes("dAtten")&&(q+="float dAtten;\n");h.includes("dAtten3")&&(q+="vec3 dAtten3;\n");h.includes("dAo")&&(q+="float dAo;\n");h.includes("dMsdf")&&(q+="vec4 dMsdf;\n");h=p+q+h;return{attributes:x,vshader:c,fshader:h,tag:pc.SHADERTAG_MATERIAL}}};pc.programlib.skybox={generateKey:function(e,a){return"skybox"+a.rgbm+" "+a.hdr+" "+a.fixSeams+""+a.toneMapping+""+a.gamma+""+a.useIntensity+""+a.mip},createShaderDefinition:function(e,a){var b=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:b.skyboxVS,fshader:pc.programlib.precisionCode(e)+(a.mip?b.fixCubemapSeamsStretchPS:b.fixCubemapSeamsNonePS)+(a.useIntensity?b.envMultiplyPS:b.envConstPS)+pc.programlib.gammaCode(a.gamma)+pc.programlib.tonemapCode(a.toneMapping)+b.rgbmPS+
    b.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,a.rgbm?"textureCubeRGBM":a.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,16,8,4,2][a.mip]+"")}}};pc.extend(pc,function(){var e={type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1},a=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.createFullscreenQuad(a);this.needsDepthBuffer=!1};a.prototype={render:function(a,c,d){}};return{PostEffect:a,createFullscreenQuad:function(a){var c=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.TYPE_FLOAT32}]);a=new pc.VertexBuffer(a,c,4);c=new pc.VertexIterator(a);c.element[pc.SEMANTIC_POSITION].set(-1,-1);
        c.next();c.element[pc.SEMANTIC_POSITION].set(1,-1);c.next();c.element[pc.SEMANTIC_POSITION].set(-1,1);c.next();c.element[pc.SEMANTIC_POSITION].set(1,1);c.end();return a},drawFullscreenQuad:function(a,c,d,f,g){a.setRenderTarget(c);a.updateBegin();var k=null!==c?c.width:a.width;c=null!==c?c.height:a.height;var l=0,m=0;g&&(l=g.x*k,m=g.y*c,k*=g.z,c*=g.w);a.setViewport(l,m,k,c);a.setScissor(l,m,k,c);g=a.getBlending();k=a.getDepthTest();c=a.getDepthWrite();var l=a.getCullMode(),m=a.writeRed,n=a.writeGreen,
        h=a.writeBlue,r=a.writeAlpha;a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);a.setCullMode(pc.CULLFACE_BACK);a.setColorWrite(!0,!0,!0,!0);a.setVertexBuffer(d,0);a.setShader(f);a.draw(e);a.setBlending(g);a.setDepthTest(k);a.setDepthWrite(c);a.setCullMode(l);a.setColorWrite(m,n,h,r);a.updateEnd()}}}());(function(){var e={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,BLEND_ADDITIVEALPHA:6,BLEND_MULTIPLICATIVE2X:7,BLEND_SCREEN:8,BLEND_MIN:9,BLEND_MAX:10,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SCHLICK:2,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:15,LAYERID_WORLD:0,LAYERID_DEPTH:1,LAYERID_SKYBOX:2,LAYERID_IMMEDIATE:3,LAYERID_UI:4,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,
        LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,SHADOW_PCF3:0,SHADOW_DEPTH:0,SHADOW_VSM8:1,SHADOW_VSM16:2,SHADOW_VSM32:3,SHADOW_PCF5:4,BLUR_BOX:0,BLUR_GAUSSIAN:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,CUBEPROJ_NONE:0,CUBEPROJ_BOX:1,SPECULAR_PHONG:0,
        SPECULAR_BLINN:1,GAMMA_NONE:0,GAMMA_SRGB:1,GAMMA_SRGBFAST:2,GAMMA_SRGBHDR:3,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1,TONEMAP_HEJL:2,TONEMAP_ACES:3,TONEMAP_ACES2:4,SPECOCC_NONE:0,SPECOCC_AO:1,SPECOCC_GLOSSDEPENDENT:2,SHADERDEF_NOSHADOW:1,SHADERDEF_SKIN:2,SHADERDEF_UV0:4,SHADERDEF_UV1:8,SHADERDEF_VCOLOR:16,SHADERDEF_INSTANCING:32,SHADERDEF_LM:64,SHADERDEF_DIRLM:128,SHADERDEF_SCREENSPACE:256,LINEBATCH_WORLD:0,LINEBATCH_OVERLAY:1,LINEBATCH_GIZMO:2,SHADOWUPDATE_NONE:0,SHADOWUPDATE_THISFRAME:1,SHADOWUPDATE_REALTIME:2,
        SORTKEY_FORWARD:0,SORTKEY_DEPTH:1,MASK_DYNAMIC:1,MASK_BAKED:2,MASK_LIGHTMAP:4,SHADER_FORWARD:0,SHADER_FORWARDHDR:1,SHADER_DEPTH:2,SHADER_SHADOW:3,SHADER_PICK:18,BAKE_COLOR:0,BAKE_COLORDIR:1,VIEW_CENTER:0,VIEW_LEFT:1,VIEW_RIGHT:2,SORTMODE_NONE:0,SORTMODE_MANUAL:1,SORTMODE_MATERIALMESH:2,SORTMODE_BACK2FRONT:3,SORTMODE_FRONT2BACK:4,COMPUPDATED_INSTANCES:1,COMPUPDATED_LIGHTS:2,COMPUPDATED_CAMERAS:4,COMPUPDATED_BLEND:8,ASPECT_AUTO:0,ASPECT_MANUAL:1};pc.extend(pc,e);pc.scene={};pc.extend(pc.scene,e)})();
    pc.extend(pc,function(){var e=function(){this.root=null;this._gravity=new pc.Vec3(0,-9.8,0);this._layers=null;this._fog=pc.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._gammaCorrection=pc.GAMMA_NONE;this._toneMapping=0;this.exposure=1;this._skyboxPrefiltered=[null,null,null,null,null,null];this.skyboxModel=this._skyboxCubeMap=null;this._skyboxIntensity=1;this._skyboxMip=0;this.lightmapSizeMultiplier=1;this.lightmapMaxResolution=
        2048;this.lightmapMode=pc.BAKE_COLORDIR;this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0};this.updateSkybox=this.updateShaders=!0;this._shaderVersion=0;this._statsUpdated=!1;this._models=[];pc.events.attach(this)};Object.defineProperty(e.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&
    (this._fog=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(a){this._skyboxCubeMap=
        a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(e.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(a){this._skyboxIntensity=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(e.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(a){this._skyboxMip=a;this._resetSkyboxModel();this.updateShaders=!0}});Object.defineProperty(e.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},
        set:function(a){this._skyboxPrefiltered[0]!==a&&(this._skyboxPrefiltered[0]=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(a){this._skyboxPrefiltered[1]!==a&&(this._skyboxPrefiltered[1]=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(a){this._skyboxPrefiltered[2]!==a&&(this._skyboxPrefiltered[2]=a,this.updateShaders=
        !0)}});Object.defineProperty(e.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(a){this._skyboxPrefiltered[3]!==a&&(this._skyboxPrefiltered[3]=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(a){this._skyboxPrefiltered[4]!==a&&(this._skyboxPrefiltered[4]=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},
        set:function(a){this._skyboxPrefiltered[5]!==a&&(this._skyboxPrefiltered[5]=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"drawCalls",{get:function(){var a=this.layers._meshInstances;a.length||(this.layers._update(),a=this.layers._meshInstances);return a},set:function(a){}});Object.defineProperty(e.prototype,"layers",{get:function(){return this._layers},set:function(a){var b=this._layers;this._layers=a;this.fire("set:layers",b,a)}});e.prototype.applySettings=function(a){this._gravity.set(a.physics.gravity[0],
        a.physics.gravity[1],a.physics.gravity[2]);this.ambientLight.set(a.render.global_ambient[0],a.render.global_ambient[1],a.render.global_ambient[2]);this._fog=a.render.fog;this.fogColor.set(a.render.fog_color[0],a.render.fog_color[1],a.render.fog_color[2]);this.fogStart=a.render.fog_start;this.fogEnd=a.render.fog_end;this.fogDensity=a.render.fog_density;this._gammaCorrection=a.render.gamma_correction;this._toneMapping=a.render.tonemapping;this.lightmapSizeMultiplier=a.render.lightmapSizeMultiplier;
        this.lightmapMaxResolution=a.render.lightmapMaxResolution;this.lightmapMode=a.render.lightmapMode;this.exposure=a.render.exposure;this._skyboxIntensity=void 0===a.render.skyboxIntensity?1:a.render.skyboxIntensity;this._skyboxMip=void 0===a.render.skyboxMip?0:a.render.skyboxMip;this._resetSkyboxModel();this.updateShaders=!0};e.prototype._updateSkybox=function(a){if(this._skyboxCubeMap&&!this.skyboxModel){var b=new pc.Material,c=this;b.updateShader=function(b,d,f,g,k){b=a.getProgramLibrary().getProgram("skybox",
        {rgbm:c._skyboxCubeMap.rgbm,hdr:c._skyboxCubeMap.rgbm||c._skyboxCubeMap.format===pc.PIXELFORMAT_RGBA32F,useIntensity:1!==c.skyboxIntensity,mip:c._skyboxCubeMap.fixCubemapSeams?c.skyboxMip:0,fixSeams:c._skyboxCubeMap.fixCubemapSeams,gamma:k===pc.SHADER_FORWARDHDR?c.gammaCorrection?pc.GAMMA_SRGBHDR:pc.GAMMA_NONE:c.gammaCorrection,toneMapping:k===pc.SHADER_FORWARDHDR?pc.TONEMAP_LINEAR:c.toneMapping});this.setShader(b)};b.updateShader();var d;if(this._skyboxCubeMap.fixCubemapSeams&&c._skyboxMip){var f=
        this["skyboxPrefiltered"+[null,"64","16","8","4"][c._skyboxMip]];f&&(d=f)}else d=this._skyboxCubeMap;b.setParameter("texture_cubeMap",d);b.cull=pc.CULLFACE_NONE;if(f=this.layers.getLayerById(pc.LAYERID_SKYBOX)){var g=new pc.GraphNode,k=pc.createBox(a),b=new pc.MeshInstance(g,k,b);b.cull=!1;b._noDepthDrawGl1=!0;k=new pc.Model;k.graph=g;k.meshInstances=[b];this.skyboxModel=k;f.addMeshInstances(k.meshInstances);f.enabled=!0;this.skyLayer=f;this.fire("set:skybox",d)}}};e.prototype._resetSkyboxModel=function(){this.skyboxModel&&
    (this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyLayer.enabled=!1);this.skyboxModel=null;this.updateSkybox=!0};e.prototype.setSkybox=function(a){var b;a||(a=[null,null,null,null,null,null,null]);var c=!1;this._skyboxCubeMap!==a[0]&&(c=!0);if(!c)for(b=0;6>b&&!c;b++)this._skyboxPrefiltered[b]!==a[b+1]&&(c=!0);if(c){for(b=0;6>b;b++)this._skyboxPrefiltered[b]=a[b+1];this.skybox=a[0]}};e.prototype.destroy=function(){this.skybox=null};e.prototype.addModel=function(a){if(!this.containsModel(a)){var b=
        this.layers.getLayerById(pc.LAYERID_WORLD);b&&(b.addMeshInstances(a.meshInstances),this._models.push(a))}};e.prototype.addShadowCaster=function(a){var b=this.layers.getLayerById(pc.LAYERID_WORLD);b&&b.addShadowCasters(a.meshInstances)};e.prototype.removeModel=function(a){var b=this._models.indexOf(a);if(-1!==b){var c=this.layers.getLayerById(pc.LAYERID_WORLD);c&&(c.removeMeshInstances(a.meshInstances),this._models.splice(b,1))}};e.prototype.removeShadowCasters=function(a){var b=this.layers.getLayerById(pc.LAYERID_WORLD);
        b&&b.removeShadowCasters(a.meshInstances)};e.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};e.prototype.getModels=function(a){return this._models};return{Scene:e}}());pc.extend(pc,function(){function e(a,b){if(b!==pc.SHADOW_PCF3||a.webgl2){if(b===pc.SHADOW_VSM32)return a.extTextureFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST;if(b===pc.SHADOW_VSM16)return a.extTextureHalfFloatLinear?pc.FILTER_LINEAR:pc.FILTER_NEAREST}else return pc.FILTER_NEAREST;return pc.FILTER_LINEAR}function a(a,b,c,d){var f=d===pc.SHADOW_VSM32?pc.PIXELFORMAT_RGBA32F:d===pc.SHADOW_VSM16?pc.PIXELFORMAT_RGBA16F:d===pc.SHADOW_PCF5||d===pc.SHADOW_PCF3&&a.webgl2?pc.PIXELFORMAT_DEPTH:pc.PIXELFORMAT_R8_G8_B8_A8,
        g=e(a,d);b=new pc.Texture(a,{format:f,width:b,height:c,mipmaps:!1,minFilter:g,magFilter:g,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});return d===pc.SHADOW_PCF5||d===pc.SHADOW_PCF3&&a.webgl2?(b.compareOnRead=!0,b.compareFunc=pc.FUNC_LESS,new pc.RenderTarget({depthBuffer:b})):new pc.RenderTarget({colorBuffer:b,depth:!0})}function b(a,b){for(var c=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b,height:b,cubemap:!0,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST,
        addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE}),d=[],f,g=0;6>g;g++)f=new pc.RenderTarget({colorBuffer:c,face:g,depth:!0}),d.push(f);return d}function c(a){25<a&&(a=25);var b=(a-1)/6,c,d,f,g;g=.5*(a-1);d=Array(a);for(c=f=0;c<a;++c){var k=c-g;d[c]=Math.exp(-(k*k)/(2*b*b));f+=d[c]}for(c=0;c<a;++c)d[c]/=f;return d}function d(b,c,d,f){f||(f=0);f=1E4*f+c;var g=h[d][f];g||(g=a(b,c,c,d?d:pc.SHADOW_PCF3),h[d][f]=g);return g}function f(c,f){var g;f._type===pc.LIGHTTYPE_POINT?(f._shadowType>
    pc.SHADOW_PCF3&&(f._shadowType=pc.SHADOW_PCF3),f._cacheShadowMap?(g=O[f._shadowResolution],g||(g=b(c,f._shadowResolution),O[f._shadowResolution]=g)):g=b(c,f._shadowResolution),f._shadowCamera.renderTarget=g[0],f._shadowCubeMap=g):(g=f._cacheShadowMap?d(c,f._shadowResolution,f._shadowType):a(c,f._shadowResolution,f._shadowResolution,f._shadowType),f._shadowCamera.renderTarget=g);f._isCachedShadowMap=f._cacheShadowMap}function g(a){a=this.device=a;this._instancingTime=this._morphTime=this._skinTime=
        this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0;this.library=a.getProgramLibrary();this.frontToBack=!1;a=a.scope;this.projId=a.resolve("matrix_projection");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");
        this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.cameraParamsId=a.resolve("camera_params");this.shadowMapLightRadiusId=a.resolve("light_radius");this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");
        this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.alphaTestId=a.resolve("alpha_ref");this.opacityMapId=a.resolve("texture_opacityMap");this.ambientId=a.resolve("light_globalAmbient");this.exposureId=a.resolve("exposure");this.skyboxIntensityId=a.resolve("skyboxIntensity");this.lightColorId=[];this.lightDirId=[];this.lightShadowMapId=[];this.lightShadowMatrixId=[];this.lightShadowParamsId=[];this.lightShadowMatrixVsId=[];this.lightShadowParamsVsId=
            [];this.lightDirVsId=[];this.lightRadiusId=[];this.lightPosId=[];this.lightInAngleId=[];this.lightOutAngleId=[];this.lightPosVsId=[];this.lightCookieId=[];this.lightCookieIntId=[];this.lightCookieMatrixId=[];this.lightCookieOffsetId=[];this.depthMapId=a.resolve("uDepthMap");this.screenSizeId=a.resolve("uScreenSize");this._screenSize=new pc.Vec4;this.sourceId=a.resolve("source");this.pixelOffsetId=a.resolve("pixelOffset");this.weightId=a.resolve("weight[0]");var b=pc.shaderChunks;this.blurVsmShaderCode=
            [b.blurVSMPS,"#define GAUSS\n"+b.blurVSMPS];this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]];this.blurVsmShader=[{},{}];this.blurPackedVsmShader=[{},{}];this.blurVsmWeights={};this.polygonOffsetId=a.resolve("polygonOffset");this.polygonOffset=new Float32Array(2);this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}function k(a,b){a.data[0]=b.data[0];a.data[1]=b.data[1];a.data[2]=b.data[2];a.data[3]=b.data[4];
        a.data[4]=b.data[5];a.data[5]=b.data[6];a.data[6]=b.data[8];a.data[7]=b.data[9];a.data[8]=b.data[10]}for(var l=(new pc.Mat4).mul2((new pc.Mat4).setTranslate(.5,.5,.5),(new pc.Mat4).setScale(.5,.5,.5)),m={r:1,g:2,b:3,a:4},n=[(new pc.Quat).setFromEulerAngles(0,90,180),(new pc.Quat).setFromEulerAngles(0,-90,180),(new pc.Quat).setFromEulerAngles(90,0,0),(new pc.Quat).setFromEulerAngles(-90,0,0),(new pc.Quat).setFromEulerAngles(0,180,180),(new pc.Quat).setFromEulerAngles(0,0,180)],h=[{},{},{},{},{}],r=
        new pc.Vec2,p={x:1,y:1,z:0,w:0},q=new pc.Mat4,t=new pc.Mat4,x=new pc.Mat4,y=new pc.Mat4,w=new pc.Mat4,u=new pc.Mat3,v=new pc.Mat4,z,A=new pc.Mat4,D=new pc.Mat4,B=new pc.Mat4,F=new pc.Mat4,J=new pc.Vec3,G=new pc.Vec3,I,C,E=new pc.Mat4,H=new pc.Mat4,W=new pc.Mat4,R=new pc.Mat4,Z=new pc.Vec3,T={center:null,radius:0},U,ea=new pc.BoundingBox,S=[0,0],X,aa,K,M,O={},P,ba,L=[],V=0;8>V;V++)L.push(new pc.Vec3);var N=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];
        pc.extend(g.prototype,{sortCompare:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist;if(a.zdist2&&b.zdist2)return a.zdist2-b.zdist2}return b._key[pc.SORTKEY_FORWARD]-a._key[pc.SORTKEY_FORWARD]},sortCompareMesh:function(a,b){if(a.layer===b.layer){if(a.drawOrder&&b.drawOrder)return a.drawOrder-b.drawOrder;if(a.zdist&&b.zdist)return b.zdist-a.zdist}P=a._key[pc.SORTKEY_FORWARD];ba=b._key[pc.SORTKEY_FORWARD];return P===
        ba&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:ba-P},depthSortCompare:function(a,b){P=a._key[pc.SORTKEY_DEPTH];ba=b._key[pc.SORTKEY_DEPTH];return P===ba&&a.mesh&&b.mesh?b.mesh.id-a.mesh.id:ba-P},lightCompare:function(a,b){return a.key-b.key},_isVisible:function(a,b){if(!b.visible)return!1;U=b.aabb.center;b._aabb._radiusVer!==b._aabbVer&&(b._aabb._radius=b._aabb.halfExtents.length(),b._aabb._radiusVer=b._aabbVer);T.radius=b._aabb._radius;T.center=U;return a.frustum.containsSphere(T)},getShadowCamera:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 b){var c=b._shadowCamera,d;if(null===c){c=b._shadowType;d=pc.CLEARFLAG_DEPTH;var g=c===pc.SHADOW_PCF5||c===pc.SHADOW_PCF3&&a.webgl2;b._type===pc.LIGHTTYPE_POINT&&(g=!1);g||(d|=pc.CLEARFLAG_COLOR);g=new pc.Camera;c>=pc.SHADOW_VSM8&&c<=pc.SHADOW_VSM32?(g.clearColor[0]=0,g.clearColor[1]=0,g.clearColor[2]=0,g.clearColor[3]=0):(g.clearColor[0]=1,g.clearColor[1]=1,g.clearColor[2]=1,g.clearColor[3]=1);g.clearDepth=1;g.clearFlags=d;g.clearStencil=null;g._node=new pc.GraphNode;c=b._shadowCamera=g;f(a,b)}else d=
            c.renderTarget,d.width===b._shadowResolution&&d.height===b._shadowResolution||f(a,b);return c},updateCameraFrustum:function(a){if(a.vrDisplay&&a.vrDisplay.presenting){z=a.vrDisplay.combinedProj;var b=a._node.getParent();b?w.copy(b.getWorldTransform()).mul(a.vrDisplay.combinedViewInv).invert():w.copy(a.vrDisplay.combinedView);y.copy(w).invert();this.viewInvId.setValue(y.data)}else{z=a.getProjectionMatrix();a.overrideCalculateProjection&&a.calculateProjection(z,pc.VIEW_CENTER);if(a.overrideCalculateTransform)a.calculateTransform(y,
            pc.VIEW_CENTER);else{var b=a._node.getPosition(),c=a._node.getRotation();y.setTRS(b,c,pc.Vec3.ONE);this.viewInvId.setValue(y.data)}w.copy(y).invert()}a.frustum.update(z,w)},setCamera:function(a,b,c,d){var f=a.vrDisplay;if(f&&f.presenting){I=f.leftProj;C=f.rightProj;z=f.combinedProj;a.overrideCalculateProjection&&(a.calculateProjection(I,pc.VIEW_LEFT),a.calculateProjection(C,pc.VIEW_RIGHT),a.calculateProjection(z,pc.VIEW_CENTER));if(a.overrideCalculateTransform)a.calculateTransform(A,pc.VIEW_LEFT),
            a.calculateTransform(D,pc.VIEW_RIGHT),a.calculateTransform(y,pc.VIEW_CENTER),B.copy(A).invert(),F.copy(D).invert(),w.copy(y).invert();else{var g=a._node.getParent();if(g){var e=g.getWorldTransform();A.mul2(e,f.leftViewInv);D.mul2(e,f.rightViewInv);B.copy(A).invert();F.copy(D).invert();w.copy(g.getWorldTransform()).mul(f.combinedViewInv).invert()}else A.copy(f.leftViewInv),D.copy(f.rightViewInv),B.copy(f.leftView),F.copy(f.rightView),w.copy(f.combinedView)}k(E,B);k(H,F);W.mul2(I,B);R.mul2(C,F);J.data[0]=
            A.data[12];J.data[1]=A.data[13];J.data[2]=A.data[14];G.data[0]=D.data[12];G.data[1]=D.data[13];G.data[2]=D.data[14]}else z=a.getProjectionMatrix(),a.overrideCalculateProjection&&a.calculateProjection(z,pc.VIEW_CENTER),this.projId.setValue(z.data),a.overrideCalculateTransform?a.calculateTransform(y,pc.VIEW_CENTER):(f=a._node.getPosition(),g=a._node.getRotation(),y.setTRS(f,g,pc.Vec3.ONE)),this.viewInvId.setValue(y.data),w.copy(y).invert(),this.viewId.setValue(w.data),k(u,w),this.viewId3.setValue(u.data),
            v.mul2(z,w),this.viewProjId.setValue(v.data),this.viewPosId.setValue(a._node.getPosition().data);a.frustum.update(z,w);this.nearClipId.setValue(a._nearClip);this.farClipId.setValue(a._farClip);this.cameraParamsId.setValue(a._shaderParams.data);f=this.device;f.setRenderTarget(b);f.updateBegin();e=a.getRect();g=b?b.width:f.width;b=b?b.height:f.height;var h=Math.floor(e.x*g),m=Math.floor(e.y*b),l=Math.floor(e.width*g),e=Math.floor(e.height*b);f.setViewport(h,m,l,e);f.setScissor(h,m,l,e);c&&f.clear(a._clearOptions);
            e=a._scissorRect;h=Math.floor(e.x*g);m=Math.floor(e.y*b);l=Math.floor(e.width*g);e=Math.floor(e.height*b);f.setScissor(h,m,l,e);d&&f.setScissor(1,1,g-2,b-2)},dispatchGlobalLights:function(a){var b;this.mainLight=-1;this.ambientColor[0]=a.ambientLight.data[0];this.ambientColor[1]=a.ambientLight.data[1];this.ambientColor[2]=a.ambientLight.data[2];if(a.gammaCorrection)for(b=0;3>b;b++)this.ambientColor[b]=Math.pow(this.ambientColor[b],2.2);this.ambientId.setValue(this.ambientColor);this.exposureId.setValue(a.exposure);
            a.skyboxModel&&this.skyboxIntensityId.setValue(a.skyboxIntensity)},_resolveLight:function(a,b){var c="light"+b;this.lightColorId[b]=a.resolve(c+"_color");this.lightDirId[b]=a.resolve(c+"_direction");this.lightShadowMapId[b]=a.resolve(c+"_shadowMap");this.lightShadowMatrixId[b]=a.resolve(c+"_shadowMatrix");this.lightShadowParamsId[b]=a.resolve(c+"_shadowParams");this.lightShadowMatrixVsId[b]=a.resolve(c+"_shadowMatrixVS");this.lightShadowParamsVsId[b]=a.resolve(c+"_shadowParamsVS");this.lightDirVsId[b]=
            a.resolve(c+"_directionVS");this.lightRadiusId[b]=a.resolve(c+"_radius");this.lightPosId[b]=a.resolve(c+"_position");this.lightInAngleId[b]=a.resolve(c+"_innerConeAngle");this.lightOutAngleId[b]=a.resolve(c+"_outerConeAngle");this.lightPosVsId[b]=a.resolve(c+"_positionVS");this.lightCookieId[b]=a.resolve(c+"_cookie");this.lightCookieIntId[b]=a.resolve(c+"_cookieIntensity");this.lightCookieMatrixId[b]=a.resolve(c+"_cookieMatrix");this.lightCookieOffsetId[b]=a.resolve(c+"_cookieOffset")},dispatchDirectLights:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     b,c){var d=a.length,f,g,k,e=0;this.mainLight=-1;var h=this.device.scope;for(f=0;f<d;f++)if(a[f]._mask&c){g=a[f];k=g._node.getWorldTransform();this.lightColorId[e]||this._resolveLight(h,e);this.lightColorId[e].setValue(b.gammaCorrection?g._linearFinalColor.data:g._finalColor.data);k.getY(g._direction).scale(-1);this.lightDirId[e].setValue(g._direction.normalize().data);if(g.castShadows){var m=g._isPcf&&this.device.webgl2?g._shadowCamera.renderTarget.depthBuffer:g._shadowCamera.renderTarget.colorBuffer;
            g._isVsm?k=-2E-4:(k=g.shadowBias/g._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(k*=-100));var l=g._isVsm?g.vsmBias/(g._shadowCamera._farClip/7):g._normalOffsetBias;this.lightShadowMapId[e].setValue(m);this.lightShadowMatrixId[e].setValue(g._shadowMatrix.data);m=g._rendererParams;3!==m.length&&(m.length=3);m[0]=g._shadowResolution;m[1]=l;m[2]=k;this.lightShadowParamsId[e].setValue(m);0>this.mainLight&&(this.lightShadowMatrixVsId[e].setValue(g._shadowMatrix.data),
                this.lightShadowParamsVsId[e].setValue(m),this.lightDirVsId[e].setValue(g._direction.normalize().data),this.mainLight=f)}e++}return e},dispatchPointLight:function(a,b,c,d){var f=c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightRadiusId[d].setValue(c.attenuationEnd);this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor.data:c._finalColor.data);f.getTranslation(c._position);this.lightPosId[d].setValue(c._position.data);c.castShadows&&(this.lightShadowMapId[d].setValue(c._shadowCamera.renderTarget.colorBuffer),
            a=c._rendererParams,4!==a.length&&(a.length=4),a[0]=c._shadowResolution,a[1]=c._normalOffsetBias,a[2]=c.shadowBias,a[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(a));c._cookie&&(this.lightCookieId[d].setValue(c._cookie),this.lightShadowMatrixId[d].setValue(f.data),this.lightCookieIntId[d].setValue(c.cookieIntensity))},dispatchSpotLight:function(a,b,c,d){var f=c._node.getWorldTransform();this.lightColorId[d]||this._resolveLight(b,d);this.lightInAngleId[d].setValue(c._innerConeAngleCos);
            this.lightOutAngleId[d].setValue(c._outerConeAngleCos);this.lightRadiusId[d].setValue(c.attenuationEnd);this.lightColorId[d].setValue(a.gammaCorrection?c._linearFinalColor.data:c._finalColor.data);f.getTranslation(c._position);this.lightPosId[d].setValue(c._position.data);f.getY(c._direction).scale(-1);this.lightDirId[d].setValue(c._direction.normalize().data);c.castShadows&&(c._isVsm?a=-2E-4:(a=20*c.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(a*=-100)),b=c._isVsm?c.vsmBias/
                (c.attenuationEnd/7):c._normalOffsetBias,this.lightShadowMapId[d].setValue(c._isPcf&&this.device.webgl2?c._shadowCamera.renderTarget.depthBuffer:c._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),f=c._rendererParams,4!==f.length&&(f.length=4),f[0]=c._shadowResolution,f[1]=b,f[2]=a,f[3]=1/c.attenuationEnd,this.lightShadowParamsId[d].setValue(f));c._cookie&&(this.lightCookieId[d].setValue(c._cookie),c.castShadows||(a=this.getShadowCamera(this.device,
                c),b=a._node,b.setPosition(c._node.getPosition()),b.setRotation(c._node.getRotation()),b.rotateLocal(-90,0,0),a.projection=pc.PROJECTION_PERSPECTIVE,a.aspectRatio=1,a.fov=2*c._outerConeAngle,q.setTRS(b.getPosition(),b.getRotation(),pc.Vec3.ONE).invert(),t.mul2(a.getProjectionMatrix(),q),c._shadowMatrix.mul2(l,t)),this.lightShadowMatrixId[d].setValue(c._shadowMatrix.data),this.lightCookieIntId[d].setValue(c.cookieIntensity),c._cookieTransform&&(this.lightCookieMatrixId[d].setValue(c._cookieTransform.data),
                this.lightCookieOffsetId[d].setValue(c._cookieOffset.data)))},dispatchLocalLights:function(a,b,c,d,f){var g,k=a[pc.LIGHTTYPE_POINT];a=a[pc.LIGHTTYPE_SPOT];var e=k.length,h=a.length,m=d,l=this.device.scope;for(d=0;d<e;d++)g=k[d],g._mask&c&&!g.isStatic&&(this.dispatchPointLight(b,l,g,m),m++);k=0;if(f)for(g=f[k];g&&g._type===pc.LIGHTTYPE_POINT;)this.dispatchPointLight(b,l,g,m),m++,k++,g=f[k];for(d=0;d<h;d++)g=a[d],g._mask&c&&!g.isStatic&&(this.dispatchSpotLight(b,l,g,m),m++);if(f)for(g=f[k];g&&g._type===
        pc.LIGHTTYPE_SPOT;)this.dispatchSpotLight(b,l,g,m),m++,k++,g=f[k]},cull:function(a,b,c){var d=0,f,g,k,e=b.length,h=a.cullingMask||4294967295;if(!a.frustumCulling){for(f=0;f<e;f++)if(g=b[f],g.visible||g.command)g.mask&&0===(g.mask&h)||(c[d]=g,d++,g.visibleThisFrame=!0);return d}for(f=0;f<e;f++)g=b[f],g.command?(c[d]=g,d++,g.visibleThisFrame=!0):g.visible&&(k=!0,g.mask&&0===(g.mask&h)||(g.cull&&(k=this._isVisible(a,g)),k&&(c[d]=g,d++,g.visibleThisFrame=!0)));return d},cullLights:function(a,b){var c,
            d,f;for(c=0;c<b.length;c++)d=b[c],f=d._type,d.castShadows&&d._enabled&&d.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&f!==pc.LIGHTTYPE_DIRECTIONAL&&(d.getBoundingSphere(T),a.frustum.containsSphere(T)&&(d.visibleThisFrame=!0))},updateCpuSkinMatrices:function(a){var b=a.length;if(0!==b){var c,d;for(c=0;c<b;c++)if(d=a[c].skinInstance)d.updateMatrices(a[c].node),d._dirty=!0}},updateGpuSkinMatrices:function(a){var b,c,d=a.length;for(b=0;b<d;b++)a[b].visibleThisFrame&&(c=a[b].skinInstance)&&c._dirty&&(c.updateMatrixPalette(),
            c._dirty=!1)},updateMorphedBounds:function(a){var b,c,d=a.length;for(b=0;b<d;b++)(c=a[b].morphInstance)&&c._dirty&&c.updateBounds(a[b].mesh)},updateMorphing:function(a){var b,c,d=a.length;for(b=0;b<d;b++)a[b].visibleThisFrame&&(c=a[b].morphInstance)&&c._dirty&&(c.update(a[b].mesh),c._dirty=!1)},setBaseConstants:function(a,b){a.setCullMode(b.cull);b.opacityMap&&(this.opacityMapId.setValue(b.opacityMap),this.alphaTestId.setValue(b.alphaTest))},setSkinning:function(a,b,c){b.skinInstance&&(this._skinDrawCalls++,
            a.supportsBoneTextures?(X=b.skinInstance.boneTexture,this.boneTextureId.setValue(X),S[0]=X.width,S[1]=X.height,this.boneTextureSizeId.setValue(S)):this.poseMatrixId.setValue(b.skinInstance.matrixPalette))},drawInstance:function(a,b,c,d,f){if(aa=b.instancingData){if(this._instancedDrawCalls++,this._removedByInstancing+=aa.count,a.setVertexBuffer(aa._buffer,1,aa.offset),a.draw(c.primitive[d],aa.count),aa._buffer===pc._autoInstanceBuffer)return b.instancingData=null,aa.count-1}else return K=b.node.worldTransform,
            this.modelMatrixId.setValue(K.data),f&&(M=b.node.normalMatrix,b.node._dirtyNormal&&(K.invertTo3x3(M),M.transpose(),b.node._dirtyNormal=!1),this.normalMatrixId.setValue(M.data)),a.draw(c.primitive[d]),0},drawInstance2:function(a,b,c,d){if(aa=b.instancingData){if(this._instancedDrawCalls++,this._removedByInstancing+=aa.count,a.setVertexBuffer(aa._buffer,1,aa.offset),a.draw(c.primitive[d],aa.count),aa._buffer===pc._autoInstanceBuffer)return b.instancingData=null,aa.count-1}else return a.draw(c.primitive[d]),
            0},renderShadows:function(a,b){var f=this.device,g,k,e,h,x,y,w,C,u,v,J,G,I,B,A=1<<pc.SHADER_SHADOW,z,E;for(g=0;g<a.length;g++)if(e=a[g],x=e._type,e.castShadows&&e._enabled&&(e._shadowCamera||this.getShadowCamera(f,e),e.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&e.visibleThisFrame)){y=this.getShadowCamera(f,e);w=y._node;C=0;u=1;if(x===pc.LIGHTTYPE_DIRECTIONAL){if(0>e._visibleLength[b])continue;C=e._visibleCameraSettings[b];w.setPosition(C.x,C.y,C.z);y.orthoHeight=C.orthoHeight;y.farClip=C.farClip;C=
            b}else x===pc.LIGHTTYPE_SPOT?(this.viewPosId.setValue(w.getPosition().data),this.shadowMapLightRadiusId.setValue(e.attenuationEnd)):x===pc.LIGHTTYPE_POINT&&(this.viewPosId.setValue(w.getPosition().data),this.shadowMapLightRadiusId.setValue(e.attenuationEnd),u=6);x!==pc.LIGHTTYPE_POINT&&(q.setTRS(w.getPosition(),w.getRotation(),pc.Vec3.ONE).invert(),t.mul2(y.getProjectionMatrix(),q),e._shadowMatrix.mul2(l,t));f.webgl2?x===pc.LIGHTTYPE_POINT?f.setDepthBias(!1):(f.setDepthBias(!0),f.setDepthBiasValues(-1E3*
            e.shadowBias,-1E3*e.shadowBias)):f.extStandardDerivatives&&(x===pc.LIGHTTYPE_POINT?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1E3*e.shadowBias,this.polygonOffset[1]=-1E3*e.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset));e.shadowUpdateMode===pc.SHADOWUPDATE_THISFRAME&&(e.shadowUpdateMode=pc.SHADOWUPDATE_NONE);this._shadowMapUpdates+=u;f.setBlending(!1);f.setDepthWrite(!0);f.setDepthTest(!0);e._isPcf&&f.webgl2&&x!==pc.LIGHTTYPE_POINT?f.setColorWrite(!1,
            !1,!1,!1):f.setColorWrite(!0,!0,!0,!0);for(C?u=C+1:C=0;C<u;){x===pc.LIGHTTYPE_POINT&&(w.setRotation(n[C]),y.renderTarget=e._shadowCubeMap[C]);this.setCamera(y,y.renderTarget,!0,x!==pc.LIGHTTYPE_POINT);B=e._visibleList[C];J=e._visibleLength[C];k=e._shadowType;v=k+5*x;for(k=0;k<J;k++){G=B[k];I=G.mesh;h=G.material;this.setBaseConstants(f,h);this.setSkinning(f,G,h);if(h.chunks){E=h.parameters;for(z in E)h=E[z],h.passFlags&A&&(h.scopeId||(h.scopeId=f.scope.resolve(z)),h.scopeId.setValue(h.data));E=G.parameters;
            for(z in E)h=E[z],h.passFlags&A&&(h.scopeId||(h.scopeId=f.scope.resolve(z)),h.scopeId.setValue(h.data))}h=G._shader[pc.SHADER_SHADOW+v];if(!h){this.updateShader(G,G._shaderDefs,null,pc.SHADER_SHADOW+v);h=G._shader[pc.SHADER_SHADOW+v];E=G._key;var D=pc.SORTKEY_DEPTH,F=G.material,U=G.skinInstance?10:0,S=0;F.opacityMap&&(F=F.opacityMapChannel)&&(S=m[F]);E[D]=U+S}f.setShader(h);h=G.renderStyle;f.setVertexBuffer(G.morphInstance&&G.morphInstance._vertexBuffer?G.morphInstance._vertexBuffer:I.vertexBuffer,
            0);f.setIndexBuffer(I.indexBuffer[h]);k+=this.drawInstance(f,G,I,h);this._shadowDrawCalls++}C++;x===pc.LIGHTTYPE_DIRECTIONAL&&(e._visibleLength[b]=-1)}e._isVsm&&(x=e._vsmBlurSize,1<x&&(y=y.renderTarget,w=d(f,e._shadowResolution,e._shadowType,1),u=e.vsmBlurMode,C=(e._shadowType===pc.SHADOW_VSM8?this.blurPackedVsmShader:this.blurVsmShader)[u][x],C||(this.blurVsmWeights[x]=c(x),C=pc.shaderChunks,(e._shadowType===pc.SHADOW_VSM8?this.blurPackedVsmShader:this.blurVsmShader)[u][x]=C=C.createShaderFromCode(this.device,
            C.fullscreenQuadVS,"#define SAMPLES "+x+"\n"+(e._shadowType===pc.SHADOW_VSM8?this.blurPackedVsmShaderCode:this.blurVsmShaderCode)[u],"blurVsm"+u+""+x+""+(e._shadowType===pc.SHADOW_VSM8))),p.z=e._shadowResolution-2,p.w=p.z,this.sourceId.setValue(y.colorBuffer),r.x=1/e._shadowResolution,r.y=0,this.pixelOffsetId.setValue(r.data),u===pc.BLUR_GAUSSIAN&&this.weightId.setValue(this.blurVsmWeights[x]),pc.drawQuadWithShader(f,w,C,null,p),this.sourceId.setValue(w.colorBuffer),r.y=r.x,r.x=0,this.pixelOffsetId.setValue(r.data),
            pc.drawQuadWithShader(f,y,C,null,p)))}f.webgl2?f.setDepthBias(!1):f.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(a,b,c,d,f){a.material._scene=this.scene;a.material.updateShader(this.device,this.scene,b,c,d,f);a._shader[d]=a.material.shader},renderForward:function(a,b,c,d,f,g,k,e){var h=this.device,m=this.scene,l=a.vrDisplay,n=1<<f;e=e?e._lightHash:0;var p,q,r,t,x,y,w,u,v=null,z,U,S=.5*h.width;for(p=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      0;p<c;p++)if(q=b[p],!g||!q.mask||g&q.mask)if(q.command)q.command();else{r=q.mesh;t=q.material;x=q._shaderDefs;w=q.mask;this.setSkinning(h,q,t);t&&t===v&&x!==y&&(v=null);if(q.isStatic||z)v=null;if(t!==v){this._materialSwitches++;q._shader[f]&&q._shaderDefs===x&&q._lightHash===e||(q.isStatic?this.updateShader(q,x,q._staticLightList,f,d):(y=f+"_"+x+"_"+e,q._shader[f]=t.variants[y],q._shader[f]||(this.updateShader(q,x,null,f,d),t.variants[y]=q._shader[f])),q._shaderDefs=x,q._lightHash=e);h.setShader(q._shader[f]);
            y=t.parameters;for(U in y)z=y[U],z.passFlags&n&&(z.scopeId||(z.scopeId=h.scope.resolve(U)),z.scopeId.setValue(z.data));v&&w===u||(u=this.dispatchDirectLights(d[pc.LIGHTTYPE_DIRECTIONAL],m,w),this.dispatchLocalLights(d,m,w,u,q._staticLightList));this.alphaTestId.setValue(t.alphaTest);h.setBlending(t.blend);t.blend&&(t.separateAlphaBlend?(h.setBlendFunctionSeparate(t.blendSrc,t.blendDst,t.blendSrcAlpha,t.blendDstAlpha),h.setBlendEquationSeparate(t.blendEquation,t.blendAlphaEquation)):(h.setBlendFunction(t.blendSrc,
                t.blendDst),h.setBlendEquation(t.blendEquation)));h.setColorWrite(t.redWrite,t.greenWrite,t.blueWrite,t.alphaWrite);a._cullFaces?a._flipFaces?h.setCullMode(0<t.cull?t.cull===pc.CULLFACE_FRONT?pc.CULLFACE_BACK:pc.CULLFACE_FRONT:0):h.setCullMode(t.cull):h.setCullMode(pc.CULLFACE_NONE);h.setDepthWrite(t.depthWrite);h.setDepthTest(t.depthTest);h.setAlphaToCoverage(t.alphaToCoverage);t.depthBias||t.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(t.depthBias,t.slopeDepthBias)):h.setDepthBias(!1)}u=
            q.stencilFront||t.stencilFront;v=q.stencilBack||t.stencilBack;u||v?(h.setStencilTest(!0),u===v?(h.setStencilFunc(u.func,u.ref,u.readMask),h.setStencilOperation(u.fail,u.zfail,u.zpass,u.writeMask)):(u?(h.setStencilFuncFront(u.func,u.ref,u.readMask),h.setStencilOperationFront(u.fail,u.zfail,u.zpass,u.writeMask)):(h.setStencilFuncFront(pc.FUNC_ALWAYS,0,255),h.setStencilOperationFront(pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,pc.STENCILOP_KEEPP,255)),v?(h.setStencilFuncBack(v.func,v.ref,v.readMask),h.setStencilOperationBack(v.fail,
            v.zfail,v.zpass,v.writeMask)):(h.setStencilFuncBack(pc.FUNC_ALWAYS,0,255),h.setStencilOperationBack(pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,pc.STENCILOP_KEEP,255)))):h.setStencilTest(!1);y=q.parameters;for(U in y)z=y[U],z.passFlags&n&&(z.scopeId||(z.scopeId=h.scope.resolve(U)),z.scopeId.setValue(z.data));h.setVertexBuffer(q.morphInstance&&q.morphInstance._vertexBuffer?q.morphInstance._vertexBuffer:r.vertexBuffer,0);u=q.renderStyle;h.setIndexBuffer(r.indexBuffer[u]);k&&k(q,p);l&&l.presenting?(h.setViewport(0,
            0,S,h.height),this.projId.setValue(I.data),this.viewInvId.setValue(A.data),this.viewId.setValue(B.data),this.viewId3.setValue(E.data),this.viewProjId.setValue(W.data),this.viewPosId.setValue(J.data),p+=this.drawInstance(h,q,r,u,!0),this._forwardDrawCalls++,h.setViewport(S,0,S,h.height),this.projId.setValue(C.data),this.viewInvId.setValue(D.data),this.viewId.setValue(F.data),this.viewId3.setValue(H.data),this.viewProjId.setValue(R.data),this.viewPosId.setValue(G.data),p+=this.drawInstance2(h,q,r,u)):
            p+=this.drawInstance(h,q,r,u,!0);this._forwardDrawCalls++;if(p<c-1&&b[p+1].material===t)for(U in y)if(z=t.parameters[U])z.scopeId||(z.scopeId=h.scope.resolve(U)),z.scopeId.setValue(z.data);v=t;y=x;u=w;z=q.isStatic}h.updateEnd()},setupInstancing:function(a){pc._instanceVertexFormat||(pc._instanceVertexFormat=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_TEXCOORD2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD3,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD4,components:4,
            type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_TEXCOORD5,components:4,type:pc.TYPE_FLOAT32}]));a.enableAutoInstancing&&!pc._autoInstanceBuffer&&(pc._autoInstanceBuffer=new pc.VertexBuffer(a,pc._instanceVertexFormat,a.autoInstancingMaxObjects,pc.BUFFER_DYNAMIC),pc._autoInstanceBufferData=new Float32Array(pc._autoInstanceBuffer.lock()))},revertStaticMeshes:function(a){var b,c=a.length,d,f=[],g;for(b=0;b<c;b++)d=a[b],d._staticSource?d._staticSource!==g&&(f.push(d._staticSource),g=d._staticSource):f.push(d);
            a.length=f.length;for(b=0;b<f.length;b++)a[b]=f[b]},prepareStaticMeshes:function(a,b){var c,d,f,g,k,e=this.device,h=a.length,m,l,n=[],p,q,r,t,x,y,w,C,u,v,G,J,I,z,B=new pc.Vec3,A=new pc.Vec3,E=new pc.BoundingBox,D=new pc.Mat4,F=[],U,S,X=[],H=[],K=[];for(c=0;c<h;c++)if(m=a[c],m.isStatic){p=m.aabb;K.length=0;for(U=pc.LIGHTTYPE_POINT;U<=pc.LIGHTTYPE_SPOT;U++)for(d=0;d<b.length;d++)l=b[d],l._type===U&&l._enabled&&l._mask&m.mask&&l.isStatic&&(X[d]||(X[d]=new pc.BoundingBox,l._node.getWorldTransform(),l.getBoundingSphere(T),
            X[d].center.copy(T.center),X[d].halfExtents.x=T.radius,X[d].halfExtents.y=T.radius,X[d].halfExtents.z=T.radius),X[d].intersects(p)&&K.push(d));if(0===K.length)n.push(m);else{p=m.mesh;U=p.vertexBuffer;l=p.indexBuffer[m.renderStyle];q=2===l.bytesPerIndex?new Uint16Array(l.lock()):new Uint32Array(l.lock());r=p.primitive[m.renderStyle].count/3;w=p.primitive[m.renderStyle].base;t=U.format.elements;x=U.format.size/4;p=new Float32Array(U.storage);for(f=0;f<t.length;f++)t[f].name===pc.SEMANTIC_POSITION&&
        (y=t[f].offset/4);F.length=r;for(f=0;f<r;f++)F[f]=0;t=!1;H.length=6*r;for(f=0;f<r;f++){G=v=u=Number.MAX_VALUE;J=-Number.MAX_VALUE;I=-Number.MAX_VALUE;z=-Number.MAX_VALUE;for(g=0;3>g;g++)d=q[3*f+g+w],d=d*x+y,k=p[d],C=p[d+1],d=p[d+2],k<u&&(u=k),C<v&&(v=C),d<G&&(G=d),k>J&&(J=k),C>I&&(I=C),d>z&&(z=d);d=6*f;H[d]=u;H[d+1]=v;H[d+2]=G;H[d+3]=J;H[d+4]=I;H[d+5]=z}for(k=0;k<K.length;k++)for(d=K[k],D.copy(m.node.worldTransform).invert(),E.setFromTransformedAabb(X[d],D),C=E.getMin().data,u=E.getMax().data,g=1<<
            k,f=0;f<r;f++)d=6*f,H[d]<=u[0]&&H[d+3]>=C[0]&&H[d+1]<=u[1]&&H[d+4]>=C[1]&&H[d+2]<=u[2]&&H[d+5]>=C[2]&&(F[f]|=g,t=!0);if(t){t={};for(f=0;f<r;f++)d=3*f+w,S=F[f],t[S]||(t[S]=[]),g=t[S],g.push(q[d]),g.push(q[d+1]),g.push(q[d+2]);for(S in t){g=t[S];q=new pc.IndexBuffer(e,l.format,g.length,l.usage);(2===q.bytesPerIndex?new Uint16Array(q.lock()):new Uint32Array(q.lock())).set(g);q.unlock();G=v=u=Number.MAX_VALUE;J=-Number.MAX_VALUE;I=-Number.MAX_VALUE;z=-Number.MAX_VALUE;for(f=0;f<g.length;f++)d=g[f],k=
            p[d*x+y],C=p[d*x+y+1],d=p[d*x+y+2],k<u&&(u=k),C<v&&(v=C),d<G&&(G=d),k>J&&(J=k),C>I&&(I=C),d>z&&(z=d);B.set(u,v,G);A.set(J,I,z);f=new pc.BoundingBox;f.setMinMax(B,A);r=new pc.Mesh;r.vertexBuffer=U;r.indexBuffer[0]=q;r.primitive[0].type=pc.PRIMITIVE_TRIANGLES;r.primitive[0].base=0;r.primitive[0].count=g.length;r.primitive[0].indexed=!0;r.aabb=f;q=new pc.MeshInstance(m.node,r,m.material);q.isStatic=m.isStatic;q.visible=m.visible;q.layer=m.layer;q.castShadow=m.castShadow;q._receiveShadow=m._receiveShadow;
            q.cull=m.cull;q.pick=m.pick;q.mask=m.mask;q.parameters=m.parameters;q._shaderDefs=m._shaderDefs;q._staticSource=m;q._staticLightList=m._staticLightList?m._staticLightList:[];for(f=0;f<K.length;f++)g=1<<f,S&g&&(r=b[K[f]],0>q._staticLightList.indexOf(r)&&q._staticLightList.push(r));q._staticLightList.sort(this.lightCompare);n.push(q)}}else n.push(m)}}else n.push(m);a.length=n.length;for(c=0;c<n.length;c++)a[c]=n[c]},updateShaders:function(a){var b,c=[];for(b=0;b<a.length;b++){var d=a[b];void 0!==d.material&&
        -1===c.indexOf(d.material)&&c.push(d.material)}for(b=0;b<c.length;b++)a=c[b],a.updateShader!==pc.Material.prototype.updateShader&&(a.clearVariants(),a.shader=null)},beginFrame:function(a){var b=this.device,c=this.scene,d=a._meshInstances;a=a._lights;c.updateSkybox&&(c._updateSkybox(b),c.updateSkybox=!1);c.updateShaders&&(this.updateShaders(d),c.updateShaders=!1,c._shaderVersion++);this.updateCpuSkinMatrices(d);this.updateMorphedBounds(d);c=d.length;for(b=0;b<c;b++)d[b].visibleThisFrame=!1;c=a.length;
            for(b=0;b<c;b++)a[b].visibleThisFrame=a[b]._type===pc.LIGHTTYPE_DIRECTIONAL},beginLayers:function(a){var b=this.scene,c=a.layerList.length,d,f,g,k=this.scene._shaderVersion;for(f=0;f<c;f++)a.layerList[f]._postRenderCounter=0;for(f=0;f<c;f++){d=a.layerList[f];d._shaderVersion=k;d._preRenderCalledForCameras=0;d._postRenderCalledForCameras=0;g=a.subLayerList[f];d._postRenderCounter=g?d._postRenderCounter|2:d._postRenderCounter|1;d._postRenderCounterMax=d._postRenderCounter;for(g=0;g<d.cameras.length;g++)d.instances.visibleOpaque[g]||
        (d.instances.visibleOpaque[g]=new pc.VisibleInstanceList),d.instances.visibleTransparent[g]||(d.instances.visibleTransparent[g]=new pc.VisibleInstanceList),d.instances.visibleOpaque[g].done=!1,d.instances.visibleTransparent[g].done=!1;d._needsStaticPrepare&&d._staticLightHash&&(d._staticPrepareDone&&(this.revertStaticMeshes(d.opaqueMeshInstances),this.revertStaticMeshes(d.transparentMeshInstances)),this.prepareStaticMeshes(d.opaqueMeshInstances,d._lights),this.prepareStaticMeshes(d.transparentMeshInstances,
            d._lights),a._dirty=!0,b.updateShaders=!0,d._needsStaticPrepare=!1,d._staticPrepareDone=!0)}},cullLocalShadowmap:function(a,b){var c,d,f,g,k,e,h,m,l,p,q;d=a._type;if(d!==pc.LIGHTTYPE_DIRECTIONAL)for(a.visibleThisFrame=!0,f=this.getShadowCamera(this.device,a),f.projection=pc.PROJECTION_PERSPECTIVE,f.nearClip=a.attenuationEnd/1E3,f.farClip=a.attenuationEnd,f.aspectRatio=1,d===pc.LIGHTTYPE_SPOT?(f.fov=2*a._outerConeAngle,k=1):(f.fov=90,k=6),g=f._node,c=a._node,g.setPosition(c.getPosition()),d===pc.LIGHTTYPE_SPOT&&
        (g.setRotation(c.getRotation()),g.rotateLocal(-90,0,0)),e=0;e<k;e++){d===pc.LIGHTTYPE_POINT&&(g.setRotation(n[e]),f.renderTarget=a._shadowCubeMap[e]);this.updateCameraFrustum(f);(l=a._visibleList[e])||(l=a._visibleList[e]=[]);c=p=a._visibleLength[e]=0;for(h=b.length;c<h;c++)m=b[c],q=!0,m.cull&&(q=this._isVisible(f,m)),q&&(l[p]=m,p++,m.visibleThisFrame=!0);a._visibleLength[e]=p;l.length!==p&&(l.length=p);l.sort(this.depthSortCompare)}},cullDirectionalShadowmap:function(a,b,c,d){var f,g,k,e,h,m,l,n,
            p,r,t,y;g=this.device;a.visibleThisFrame=!0;g=this.getShadowCamera(g,a);k=g._node;e=a._node;k.setPosition(e.getPosition());k.setRotation(e.getRotation());k.rotateLocal(-90,0,0);n=a.shadowDistance||c._farClip;p=c._nearClip;f=c._fov*Math.PI/180;h=c._aspect;m=c._projection;t=m===pc.PROJECTION_PERSPECTIVE?Math.tan(f/2)*p:c._orthoHeight;r=t*h;L[0].x=r;L[0].y=-t;L[0].z=-p;L[1].x=r;L[1].y=t;L[1].z=-p;L[2].x=-r;L[2].y=t;L[2].z=-p;L[3].x=-r;L[3].y=-t;L[3].z=-p;m===pc.PROJECTION_PERSPECTIVE&&(t=Math.tan(f/
            2)*n,r=t*h);L[4].x=r;L[4].y=-t;L[4].z=-n;L[5].x=r;L[5].y=t;L[5].z=-n;L[6].x=-r;L[6].y=t;L[6].z=-n;L[7].x=-r;L[7].y=-t;L[7].z=-n;h=Z.sub2(L[0],L[6]).length();h=Math.max(h,Z.sub2(L[4],L[6]).length());q.copy(k.getWorldTransform()).invert();x.copy(q).mul(c._node.worldTransform);for(f=0;8>f;f++)x.transformPoint(L[f],L[f]);n=p=c=1E6;r=t=m=-1E6;for(f=0;8>f;f++)l=L[f],l.x<n&&(n=l.x),l.x>r&&(r=l.x),l.y<p&&(p=l.y),l.y>t&&(t=l.y),l.z<c&&(c=l.z),l.z>m&&(m=l.z);f=h/a._shadowResolution;n=Math.floor((n-.5*(h-(r-
            n)))/f)*f;p=Math.floor((p-.5*(h-(t-p)))/f)*f;n=.5*(n+h+n);p=.5*(p+h+p);k.translateLocal(n,p,1E5);g.projection=pc.PROJECTION_ORTHOGRAPHIC;g.nearClip=0;g.farClip=2E5;g.aspectRatio=1;g.orthoHeight=.5*h;this.updateCameraFrustum(g);t=!0;(m=a._visibleList[d])||(m=a._visibleList[d]=[]);f=h=a._visibleLength[d]=0;for(r=b.length;f<r;f++)y=b[f],l=!0,y.cull&&(l=this._isVisible(g,y)),l&&(m[h]=y,h++,y.visibleThisFrame=!0,l=y.aabb,t?(ea.copy(l),t=!1):ea.add(l));a._visibleLength[d]=h;m.length!==h&&(m.length=h);m.sort(this.depthSortCompare);
            b=ea.getMin();f=ea.getMax();N[0].x=N[1].x=N[2].x=N[3].x=b.x;N[1].y=N[3].y=N[7].y=N[5].y=b.y;N[2].z=N[3].z=N[6].z=N[7].z=b.z;N[4].x=N[5].x=N[6].x=N[7].x=f.x;N[0].y=N[2].y=N[4].y=N[6].y=f.y;N[0].z=N[1].z=N[4].z=N[5].z=f.z;f=9999999999;b=-9999999999;for(m=0;8>m;++m)q.transformPoint(N[m],N[m]),h=N[m].z,h<f&&(f=h),h>b&&(b=h);m=b;f>c&&(c=f);k.setPosition(e.getPosition());k.translateLocal(n,p,m+.01);g.farClip=m-c;(e=a._visibleCameraSettings[d])||(e=a._visibleCameraSettings[d]={});a=k.getPosition().data;
            e.x=a[0];e.y=a[1];e.z=a[2];e.orthoHeight=g.orthoHeight;e.farClip=g.farClip},gpuUpdate:function(a){this.updateGpuSkinMatrices(a);this.updateMorphing(a)},clearView:function(a,b,c){a=a.camera;var d=this.device;d.setRenderTarget(b);d.updateBegin();d.setColorWrite(!0,!0,!0,!0);d.setDepthWrite(!0);var f=a.getRect(),g=b?b.width:d.width,k=b?b.height:d.height;b=Math.floor(f.x*g);var e=Math.floor(f.y*k),g=Math.floor(f.width*g),f=Math.floor(f.height*k);d.setViewport(b,e,g,f);d.setScissor(b,e,g,f);d.clear(c?
            c:a._clearOptions)},setSceneConstants:function(){var a,b=this.device,c=this.scene;this.dispatchGlobalLights(c);if(c.fog!==pc.FOG_NONE){this.fogColor[0]=c.fogColor.data[0];this.fogColor[1]=c.fogColor.data[1];this.fogColor[2]=c.fogColor.data[2];if(c.gammaCorrection)for(a=0;3>a;a++)this.fogColor[a]=Math.pow(this.fogColor[a],2.2);this.fogColorId.setValue(this.fogColor);c.fog===pc.FOG_LINEAR?(this.fogStartId.setValue(c.fogStart),this.fogEndId.setValue(c.fogEnd)):this.fogDensityId.setValue(c.fogDensity)}this._screenSize.x=
            b.width;this._screenSize.y=b.height;this._screenSize.z=1/b.width;this._screenSize.w=1/b.height;this.screenSizeId.setValue(this._screenSize.data)},renderComposition:function(a){var b=this.device,c,d=a._renderedRt,f=a._renderedByCam,g=a._renderedLayer,k,e,h,m,l,n,p,q;this.beginLayers(a);a._update()&pc.COMPUPDATED_LIGHTS&&(this.scene.updateShaders=!0);this.beginFrame(a);this.setSceneConstants();var r=0,t,x;for(k=0;k<a.layerList.length;k++)if(e=a.layerList[k],e.enabled&&a.subLayerEnabled[k])for(h=a.subLayerList[k],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                t=e.instances,m=e.cameras,l=0;l<m.length;l++)if(c=m[l]){c.frameBegin(e.renderTarget);x=h?e.transparentMeshInstances:e.opaqueMeshInstances;q=p=!1;for(n=0;n<r;n++)if(f[n]===c&&(p=!0,g[n]===e)){q=!0;break}p||(this.updateCameraFrustum(c.camera),this._camerasRendered++);q||this.cullLights(c.camera,e._lights);p&&q||(f[r]=c,g[r]=e,r++);n=h?t.visibleTransparent[l]:t.visibleOpaque[l];if(!n.done){if(e.onPreCull)e.onPreCull(l);n.length=this.cull(c.camera,x,n.list);n.done=!0;if(e.onPostCull)e.onPostCull(l)}c.frameEnd()}for(k=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         0;k<a._lights.length;k++)c=a._lights[k],c.visibleThisFrame&&c._type!==pc.LIGHTTYPE_DIRECTIONAL&&c.castShadows&&c._enabled&&c.shadowUpdateMode!==pc.SHADOWUPDATE_NONE&&(e=a._lightShadowCasters[k],this.cullLocalShadowmap(c,e));h=-1;for(k=0;k<a._lights.length;k++)if(c=a._lights[k],c._type===pc.LIGHTTYPE_DIRECTIONAL&&(h++,c.castShadows&&c._enabled&&c.shadowUpdateMode!==pc.SHADOWUPDATE_NONE))for(e=a._lightShadowCasters[k],m=a._globalLightCameras[h],l=0;l<m.length;l++)this.cullDirectionalShadowmap(c,e,m[l].camera,
            a._globalLightCameraIds[h][l]);this.gpuUpdate(a._meshInstances);this.renderShadows(a._sortedLights[pc.LIGHTTYPE_SPOT]);this.renderShadows(a._sortedLights[pc.LIGHTTYPE_POINT]);for(k=r=0;k<a._renderList.length;k++)if(e=a.layerList[a._renderList[k]],e.enabled&&a.subLayerEnabled[a._renderList[k]]){t=e.instances;h=a.subLayerList[a._renderList[k]];m=a._renderListCamera[k];(c=e.cameras[m])&&c.frameBegin(e.renderTarget);if(!h&&e.onPreRenderOpaque)e.onPreRenderOpaque(m);else if(h&&e.onPreRenderTransparent)e.onPreRenderTransparent(m);
            if(!(e._preRenderCalledForCameras&1<<m)){if(e.onPreRender)e.onPreRender(m);e._preRenderCalledForCameras|=1<<m;e.overrideClear&&this.clearView(c,e.renderTarget,e._clearOptions)}if(c){l=e.renderTarget;g=!1;for(n=0;n<r;n++)if(d[n]===l&&f[n]===c){g=!0;break}g||(e.overrideClear||this.clearView(c,e.renderTarget),d[r]=l,f[r]=c,r++);this.renderShadows(e._sortedLights[pc.LIGHTTYPE_DIRECTIONAL],m);e._sortVisible(h,c.node,m);n=h?t.visibleTransparent[m]:t.visibleOpaque[m];this.scene._activeCamera=c.camera;this.setCamera(c.camera,
                e.renderTarget);this.renderForward(c.camera,n.list,n.length,e._sortedLights,e.shaderPass,e.cullingMask,e.onDrawCall,e);b.setColorWrite(!0,!0,!0,!0);b.setStencilTest(!1);b.setAlphaToCoverage(!1);b.setDepthBias(!1);c.frameEnd()}if(!h&&e.onPostRenderOpaque)e.onPostRenderOpaque(m);else if(h&&e.onPostRenderTransparent)e.onPostRenderTransparent(m);!e.onPostRender||e._postRenderCalledForCameras&1<<m||(e._postRenderCounter&=~(h?2:1),0===e._postRenderCounter&&(e.onPostRender(m),e._postRenderCalledForCameras|=
                1<<m,e._postRenderCounter=e._postRenderCounterMax))}}});return{ForwardRenderer:g,gaussWeights:c}}());pc.extend(pc,function(){var e=new pc.Mat4,a=new pc.Vec3,b=new pc.Quat,c=new pc.Quat,d=new pc.Vec3,f=new pc.Vec3,g=function(a){this.name="string"===typeof a?a:"Untitled";this.tags=new pc.Tags(this);this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;
        this._dirtyLocal=!1;this._aabbVer=0;this.worldTransform=new pc.Mat4;this._dirtyWorld=!1;this.normalMatrix=new pc.Mat3;this._dirtyNormal=!0;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=new pc.Vec3;this._parent=null;this._children=[];this._graphDepth=0;this._enabled=!0;this.scaleCompensation=this._enabledInHierarchy=!1};Object.defineProperty(g.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(g.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});
        Object.defineProperty(g.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(g.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,a))}});Object.defineProperty(g.prototype,"parent",{get:function(){return this._parent}});Object.defineProperty(g.prototype,"root",
            {get:function(){var a=this._parent;if(!a)return this;for(;a._parent;)a=a._parent;return a}});Object.defineProperty(g.prototype,"children",{get:function(){return this._children}});Object.defineProperty(g.prototype,"graphDepth",{get:function(){return this._graphDepth}});pc.extend(g.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var c=a._children,d=0,f=c.length;d<f;d++)c[d]._enabled&&this._notifyHierarchyStateChanged(c[d],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=
            a},_cloneInternal:function(a){a.name=this.name;for(var b=this.tags._list,c=0;c<b.length;c++)a.tags.add(b[c]);a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);a._dirtyLocal=this._dirtyLocal;a.worldTransform.copy(this.worldTransform);
            a._dirtyWorld=this._dirtyWorld;a._dirtyNormal=this._dirtyNormal;a._aabbVer=this._aabbVer+1;a._enabled=this._enabled;a.scaleCompensation=this.scaleCompensation;a._enabledInHierarchy=!1},clone:function(){var a=new pc.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c=[],d=this._children.length,f,g;if(a instanceof Function)for(f=0;f<d;f++)a(this._children[f])&&c.push(this._children[f]),g=this._children[f].find(a),g.length&&(c=c.concat(g));else for(this[a]&&(f=this[a]instanceof Function?
            this[a]():this[a],f===b&&c.push(this)),f=0;f<d;++f)g=this._children[f].find(a,b),g.length&&(c=c.concat(g));return c},findOne:function(a,b){var c,d=this._children.length,f=null;if(a instanceof Function){if(f=a(this))return this;for(c=0;c<d;c++)if(f=this._children[c].findOne(a))return this._children[c]}else{if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<d;c++)if(f=this._children[c].findOne(a,b),null!==f)return f}return null},findByTag:function(){var a=this.tags._processArguments(arguments);
            return this._findByTag(a)},_findByTag:function(a){var b=[],c,d=this._children.length,f;for(c=0;c<d;c++)this._children[c].tags._has(a)&&b.push(this._children[c]),f=this._children[c]._findByTag(a),f.length&&(b=b.concat(f));return b},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){a=a.split("/");for(var b=this,c=null,d=0,f=a.length;d<f&&b;d++){for(var g=a[d],c=null,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       b=b._children,e=0,q=b.length;e<q;e++)if(b[e].name==g){c=b[e];break}b=c}return c},getPath:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""},getRoot:function(){var a=this._parent;if(!a)return this;for(;a._parent;)a=a._parent;return a},getParent:function(){return this._parent},isDescendantOf:function(a){for(var b=this._parent;b;){if(b===a)return!0;b=b._parent}return!1},isAncestorOf:function(a){return a.isDescendantOf(this)},
            getChildren:function(){return this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,
                this.localRotation,this.localScale),this._dirtyLocal=!1);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){if(!this._dirtyLocal&&!this._dirtyWorld)return this.worldTransform;this._parent&&this._parent.getWorldTransform();this._sync();return this.worldTransform},
            reparent:function(a,b){var c=this._parent;c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(a,b,c){a instanceof pc.Vec3?this.localRotation.setFromEulerAngles(a.data[0],a.data[1],a.data[2]):this.localRotation.setFromEulerAngles(a,b,c);this._dirtyLocal||this._dirtify(!0)},setLocalPosition:function(a,b,c){a instanceof pc.Vec3?this.localPosition.copy(a):this.localPosition.set(a,b,c);this._dirtyLocal||this._dirtify(!0)},setLocalRotation:function(a,b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             c,d){a instanceof pc.Quat?this.localRotation.copy(a):this.localRotation.set(a,b,c,d);this._dirtyLocal||this._dirtify(!0)},setLocalScale:function(a,b,c){a instanceof pc.Vec3?this.localScale.copy(a):this.localScale.set(a,b,c);this._dirtyLocal||this._dirtify(!0)},setName:function(a){this.name=a},_dirtify:function(a){if(!(!a||a&&this._dirtyLocal)||!this._dirtyWorld){a&&(this._dirtyLocal=!0);if(!this._dirtyWorld)for(this._dirtyWorld=!0,a=this._children.length;a--;)this._children[a]._dirtyWorld||this._children[a]._dirtify();
                this._dirtyNormal=!0;this._aabbVer++}},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(c,d,f){c instanceof pc.Vec3?a.copy(c):a.set(c,d,f);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this._dirtyLocal||this._dirtify(!0)}}(),setRotation:function(){var a=new pc.Quat,b=new pc.Quat;return function(c,d,f,g){c instanceof pc.Quat?a.copy(c):a.set(c,d,f,g);null===this._parent?this.localRotation.copy(a):
                (c=this._parent.getRotation(),b.copy(c).invert(),this.localRotation.copy(b).mul(a));this._dirtyLocal||this._dirtify(!0)}}(),setEulerAngles:function(){var a=new pc.Quat;return function(b,c,d){b instanceof pc.Vec3?this.localRotation.setFromEulerAngles(b.data[0],b.data[1],b.data[2]):this.localRotation.setFromEulerAngles(b,c,d);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this._dirtyLocal||this._dirtify(!0)}}(),addChild:function(a){if(null!==
                a._parent)throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),d=a._parent;d&&d.removeChild(a);void 0===this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=new pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        b){if(null!==a._parent)throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,b));a._updateGraphDepth();a._dirtify();a.fire&&a.fire("insert",this);this.fire&&this.fire("childinsert",a)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var a=0,b=this._children.length;a<
            b;a++)this._children[a]._updateGraphDepth()},removeChild:function(a){var b,c=this._children.length;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);a._parent=null;this.fire&&this.fire("childremove",a);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var c,d=this._children.length;b=b||[];this.hasLabel(a)&&
            b.push(this);for(c=0;c<d;++c)b=this._children[c].findByLabel(a,b);return b},_sync:function(){this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1);if(this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var g,l=this._parent,m=this.localScale,n=l;if(n){for(;n&&n.scaleCompensation;)n=n._parent;n&&(n=n._parent)&&(g=n.worldTransform.getScale(),d.mul2(g,this.localScale),
                m=d)}c.setFromMat4(l.worldTransform);b.mul2(c,this.localRotation);n=l.worldTransform;l.scaleCompensation&&(f.mul2(g,l.getLocalScale()),e.setTRS(l.worldTransform.getTranslation(a),c,f),n=e);n.transformPoint(this.localPosition,a);this.worldTransform.setTRS(a,b,m)}else this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled){(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var a=0;a<this._children.length;a++)this._children[a].syncHierarchy()}},
            lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,d=new pc.Quat;return function(f,g,e,q,t,x){if(f instanceof pc.Vec3)b.copy(f),g instanceof pc.Vec3?c.copy(g):c.copy(pc.Vec3.UP);else{if(void 0===e)return;b.set(f,g,e);void 0!==q?c.set(q,t,x):c.copy(pc.Vec3.UP)}a.setLookAt(this.getPosition(),b,c);d.setFromMat4(a);this.setRotation(d)}}(),translate:function(){var a=new pc.Vec3;return function(b,c,d){b instanceof pc.Vec3?a.copy(b):a.set(b,c,d);a.add(this.getPosition());this.setPosition(a)}}(),
            translateLocal:function(){var a=new pc.Vec3;return function(b,c,d){b instanceof pc.Vec3?a.copy(b):a.set(b,c,d);this.localRotation.transformVector(a,a);this.localPosition.add(a);this._dirtyLocal||this._dirtify(!0)}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(c,d,f){c instanceof pc.Vec3?a.setFromEulerAngles(c.data[0],c.data[1],c.data[2]):a.setFromEulerAngles(c,d,f);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),d=this._parent.getRotation(),
                b.copy(d).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this._dirtyLocal||this._dirtify(!0)}}(),rotateLocal:function(){var a=new pc.Quat;return function(b,c,d){b instanceof pc.Vec3?a.setFromEulerAngles(b.data[0],b.data[1],b.data[2]):a.setFromEulerAngles(b,c,d);this.localRotation.mul(a);this._dirtyLocal||this._dirtify(!0)}}()});return{GraphNode:g}}());pc.extend(pc,function(){var e=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,d=function(){this._projection=pc.PROJECTION_PERSPECTIVE;this._nearClip=.1;this._farClip=1E4;this._shaderParams=new pc.Vec4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._aspectRatioMode=pc.ASPECT_AUTO;this.frustumCulling=this._horizontalFov=!1;this.cullingMask=4294967295;this._renderDepthRequests=0;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this.vrDisplay=
        null;this._rect={x:0,y:0,width:1,height:1};this._scissorRect={x:0,y:0,width:1,height:1};this.frustum=new pc.Frustum(this._projMat,this._viewMat);this._depthTarget=this.renderTarget=null;this._clearOptions={color:[.5,.5,.5,1],depth:1,stencil:0,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH|pc.CLEARFLAG_STENCIL};this.calculateTransform=this._node=null;this.overrideCalculateTransform=!1;this.calculateProjection=null;this.overrideCalculateProjection=!1;this._cullFaces=!0;this._flipFaces=!1;this._component=
        null};d.prototype={clone:function(){var a=new pc.Camera;a.projection=this._projection;a.nearClip=this._nearClip;a.farClip=this._farClip;a._shaderParams=this._shaderParams.clone();a.fov=this._fov;a.aspectRatio=this._aspect;a._aspectRatioMode=this._aspectRatioMode;a.renderTarget=this.renderTarget;a.setClearOptions(this.getClearOptions());a.frustumCulling=this.frustumCulling;a.cullingMask=this.cullingMask;return a},worldToScreen:function(a,b,c,d){void 0===d&&(d=new pc.Vec3);var e=this.getProjectionMatrix(),
        n=this._node.getWorldTransform();this._viewMat.copy(n).invert();this._viewProjMat.mul2(e,this._viewMat);this._viewProjMat.transformPoint(a,d);a=a.data;e=this._viewProjMat.data;a=a[0]*e[3]+a[1]*e[7]+a[2]*e[11]+1*e[15];d.x=.5*(d.x/a+1)*b;d.y=.5*(1-d.y/a)*c;return d},screenToWorld:function(d,g,k,l,m,n){void 0===n&&(n=new pc.Vec3);var h=this.getProjectionMatrix(),r=this._node.getWorldTransform();this._viewMat.copy(r).invert();this._viewProjMat.mul2(h,this._viewMat);c.copy(this._viewProjMat).invert();
        this._projection===pc.PROJECTION_PERSPECTIVE?(a.set(d/l*2-1,(m-g)/m*2-1,1),c.transformPoint(a,b),b.scale(1/(a.x*c.data[3]+a.y*c.data[7]+a.z*c.data[11]+c.data[15])),d=k/this._farClip,n.lerp(this._node.getPosition(),b,d)):(e.set(d/l,(m-g)/m,k/(this._farClip-this._nearClip)),e.scale(2),e.sub(pc.Vec3.ONE),c.transformPoint(e,n));return n},getClearOptions:function(){return this._clearOptions},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,
        this._aspect,this._nearClip,this._farClip,this._horizontalFov);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip)}a=this._nearClip;b=this._farClip;this._shaderParams.x=1/b;this._shaderParams.y=b;this._shaderParams.z=(1-b/a)/2;this._shaderParams.w=(1+b/a)/2;this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},setClearOptions:function(a){this._clearOptions.color[0]=a.color[0];this._clearOptions.color[1]=a.color[1];
        this._clearOptions.color[2]=a.color[2];this._clearOptions.color[3]=a.color[3];this._clearOptions.depth=a.depth;this._clearOptions.stencil=a.stencil;this._clearOptions.flags=a.flags},setRect:function(a,b,c,d){this._rect.x=a;this._rect.y=b;this._rect.width=c;this._rect.height=d},setScissorRect:function(a,b,c,d){this._scissorRect.x=a;this._scissorRect.y=b;this._scissorRect.width=c;this._scissorRect.height=d},requestDepthMap:function(){this._renderDepthRequests++},releaseDepthMap:function(){this._renderDepthRequests--}};
        Object.defineProperty(d.prototype,"aspectRatio",{get:function(){return this._aspect},set:function(a){this._aspect!==a&&(this._aspect=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"projection",{get:function(){return this._projection},set:function(a){this._projection!==a&&(this._projection=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"nearClip",{get:function(){return this._nearClip},set:function(a){this._nearClip!==a&&(this._nearClip=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,
            "farClip",{get:function(){return this._farClip},set:function(a){this._farClip!==a&&(this._farClip=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"fov",{get:function(){return this._fov},set:function(a){this._fov!==a&&(this._fov=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(a){this._horizontalFov!==a&&(this._horizontalFov=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"orthoHeight",
            {get:function(){return this._orthoHeight},set:function(a){this._orthoHeight!==a&&(this._orthoHeight=a,this._projMatDirty=!0)}});Object.defineProperty(d.prototype,"clearColor",{get:function(){return this._clearOptions.color},set:function(a){this._clearOptions.color[0]=a[0];this._clearOptions.color[1]=a[1];this._clearOptions.color[2]=a[2];this._clearOptions.color[3]=a[3]}});Object.defineProperty(d.prototype,"clearDepth",{get:function(){return this._clearOptions.depth},set:function(a){this._clearOptions.depth=
            a}});Object.defineProperty(d.prototype,"clearStencil",{get:function(){return this._clearOptions.stencil},set:function(a){this._clearOptions.stencil=a}});Object.defineProperty(d.prototype,"clearFlags",{get:function(){return this._clearOptions.flags},set:function(a){this._clearOptions.flags=a}});return{Camera:d}}());pc.extend(pc,function(){var e=new pc.Vec3,a=new pc.Vec3,b=new pc.Vec3,c={r:0,g:1,b:2,a:3},d=function(){this._type=pc.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(.8,.8,.8);this._intensity=1;this._enabled=this._castShadows=!1;this._mask=1;this.isStatic=!1;this.key=0;this.bakeDir=!0;this.attenuationEnd=this.attenuationStart=10;this._falloffMode=0;this._shadowType=pc.SHADOW_PCF3;this._vsmBlurSize=11;this.vsmBlurMode=pc.BLUR_GAUSSIAN;this.vsmBias=.0025;this._cookie=null;this.cookieIntensity=1;this._cookieFalloff=
        !0;this._cookieChannel="rgb";this._cookieOffset=this._cookieTransform=null;this._cookieOffsetSet=this._cookieTransformSet=!1;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(.8,.8,.8);var a=Math.pow(this._finalColor.data[0],2.2);this._linearFinalColor=new pc.Vec3(a,a,a);this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180);
        this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this.shadowDistance=40;this._shadowResolution=1024;this.shadowBias=-5E-4;this._normalOffsetBias=0;this.shadowUpdateMode=pc.SHADOWUPDATE_REALTIME;this._node=this._scene=null;this._rendererParams=[];this._isVsm=!1;this._isPcf=!0;this._isCachedShadowMap=this._cacheShadowMap=!1;this._visibleLength=[0];this._visibleList=[[]];this._visibleCameraSettings=[]};d.prototype={destroy:function(){this._destroyShadowMap()},clone:function(){var a=new pc.Light;
        a.type=this._type;a.setColor(this._color);a.intensity=this._intensity;a.castShadows=this.castShadows;a.enabled=this._enabled;a.attenuationStart=this.attenuationStart;a.attenuationEnd=this.attenuationEnd;a.falloffMode=this._falloffMode;a.shadowType=this._shadowType;a.vsmBlurSize=this._vsmBlurSize;a.vsmBlurMode=this.vsmBlurMode;a.vsmBias=this.vsmBias;a.shadowUpdateMode=this.shadowUpdateMode;a.mask=this._mask;a.innerConeAngle=this._innerConeAngle;a.outerConeAngle=this._outerConeAngle;a.shadowBias=this.shadowBias;
        a.normalOffsetBias=this._normalOffsetBias;a.shadowResolution=this._shadowResolution;a.shadowDistance=this.shadowDistance;return a},getColor:function(){return this._color},getBoundingSphere:function(c){if(this._type===pc.LIGHTTYPE_SPOT){var d=this.attenuationEnd,k=this._outerConeAngle,l=Math.cos(k*pc.math.DEG_TO_RAD),m=this._node;e.copy(m.up);e.scale(.5*-d*l);e.add(m.getPosition());c.center=e;a.copy(m.up);a.scale(-d);b.copy(m.right);b.scale(Math.sin(k*pc.math.DEG_TO_RAD)*d);a.add(b);c.radius=.5*a.length()}else this._type===
    pc.LIGHTTYPE_POINT&&(c.center=this._node.getPosition(),c.radius=this.attenuationEnd)},getBoundingBox:function(a){if(this._type===pc.LIGHTTYPE_SPOT){var b=this.attenuationEnd,c=this._node,d=Math.abs(Math.sin(this._outerConeAngle*pc.math.DEG_TO_RAD)*b);a.center.set(0,.5*-b,0);a.halfExtents.set(d,.5*b,d);a.setFromTransformedAabb(a,c.getWorldTransform())}else this._type===pc.LIGHTTYPE_POINT&&(a.center.copy(this._node.getPosition()),a.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},
        setColor:function(){var a,b,c;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,c=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,b,c);var d=this._intensity;this._finalColor.set(a*d,b*d,c*d);for(a=0;3>a;a++)this._linearFinalColor.data[a]=1<=d?Math.pow(this._finalColor.data[a]/d,2.2)*d:Math.pow(this._finalColor.data[a],2.2)},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var a=this._shadowCamera.renderTarget,
            b;if(a)if(a.length)for(b=0;b<a.length;b++)a[b].colorBuffer&&a[b].colorBuffer.destroy(),a[b].destroy();else a.colorBuffer&&a.colorBuffer.destroy(),a.depthBuffer&&a.depthBuffer.destroy(),a.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null;this.shadowUpdateMode===pc.SHADOWUPDATE_NONE&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)}},updateShadow:function(){this.shadowUpdateMode!==pc.SHADOWUPDATE_REALTIME&&(this.shadowUpdateMode=pc.SHADOWUPDATE_THISFRAME)},updateKey:function(){var a=
            this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|c[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(a|=c[this._cookieChannel.charAt(1)]<<16,a|=c[this._cookieChannel.charAt(2)]<<14);this.key=a}};Object.defineProperty(d.prototype,"enabled",{get:function(){return this._type},set:function(a){this._type!==a&&(this._enabled=a,null!==
    this._scene&&(this._scene.updateShaders=!0))}});Object.defineProperty(d.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,this._destroyShadowMap(),null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey(),a=this._shadowType,this._shadowType=null,this.shadowType=a,null!==this._scene&&(this._scene.layers._dirtyLights=!0))}});Object.defineProperty(d.prototype,"mask",{get:function(){return this._mask},set:function(a){this._mask!==a&&(this._mask=
        a,null!==this._scene&&(this._scene.updateShaders=!0))}});Object.defineProperty(d.prototype,"shadowType",{get:function(){return this._shadowType},set:function(a){if(this._shadowType!==a){var b=pc.Application.getApplication().graphicsDevice;this._type===pc.LIGHTTYPE_POINT&&(a=pc.SHADOW_PCF3);a!==pc.SHADOW_PCF5||b.webgl2||(a=pc.SHADOW_PCF3);a!==pc.SHADOW_VSM32||b.extTextureFloatRenderable||(a=pc.SHADOW_VSM16);a!==pc.SHADOW_VSM16||b.extTextureHalfFloatRenderable||(a=pc.SHADOW_VSM8);this._isVsm=a>=pc.SHADOW_VSM8&&
        a<=pc.SHADOW_VSM32;this._isPcf=a===pc.SHADOW_PCF5||a===pc.SHADOW_PCF3;this._shadowType=a;this._destroyShadowMap();null!==this._scene&&(this._scene.updateShaders=!0);this.updateKey()}}});Object.defineProperty(d.prototype,"castShadows",{get:function(){return this._castShadows&&this._mask!==pc.MASK_LIGHTMAP&&0!==this._mask},set:function(a){this._castShadows!==a&&(this._castShadows=a,null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey())}});Object.defineProperty(d.prototype,"shadowResolution",
        {get:function(){return this._shadowResolution},set:function(a){if(this._shadowResolution!==a){var b=pc.Application.getApplication().graphicsDevice;this._shadowResolution=a=this._type===pc.LIGHTTYPE_POINT?Math.min(a,b.maxCubeMapSize):Math.min(a,b.maxTextureSize)}}});Object.defineProperty(d.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(a){this._vsmBlurSize!==a&&(0===a%2&&a++,this._vsmBlurSize=a)}});Object.defineProperty(d.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},
        set:function(a){if(this._normalOffsetBias!==a){if(!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey();this._normalOffsetBias=a}}});Object.defineProperty(d.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(a){this._falloffMode!==a&&(this._falloffMode=a,null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey())}});Object.defineProperty(d.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},
        set:function(a){this._innerConeAngle!==a&&(this._innerConeAngle=a,this._innerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(d.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(a){this._outerConeAngle!==a&&(this._outerConeAngle=a,this._outerConeAngleCos=Math.cos(a*Math.PI/180))}});Object.defineProperty(d.prototype,"intensity",{get:function(){return this._intensity},set:function(a){if(this._intensity!==a){this._intensity=a;var b=this._color.data;a=
        this._intensity;this._finalColor.set(b[0]*a,b[1]*a,b[2]*a);for(b=0;3>b;b++)this._linearFinalColor.data[b]=1<=a?Math.pow(this._finalColor.data[b]/a,2.2)*a:Math.pow(this._finalColor.data[b],2.2)}}});Object.defineProperty(d.prototype,"cookie",{get:function(){return this._cookie},set:function(a){this._cookie!==a&&(this._cookie=a,null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey())}});Object.defineProperty(d.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(a){this._cookieFalloff!==
    a&&(this._cookieFalloff=a,null!==this._scene&&(this._scene.updateShaders=!0),this.updateKey())}});Object.defineProperty(d.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(a){if(this._cookieChannel!==a){if(3>a.length)for(var b=a.charAt(a.length-1),c=3-a.length,d=0;d<c;d++)a+=b;this._cookieChannel=a;null!==this._scene&&(this._scene.updateShaders=!0);this.updateKey()}}});Object.defineProperty(d.prototype,"cookieTransform",{get:function(){return this._cookieTransform},
        set:function(a){this._cookieTransform!==a&&(!(!this._cookieTransformSet&&!this._cookieOffsetSet)!==!(!a&&!this._cookieOffsetSet)&&null!==this._scene&&(this._scene.updateShaders=!0),this._cookieTransform=a,this._cookieTransformSet=!!a,a&&!this._cookieOffset&&(this.cookieOffset=new pc.Vec2,this._cookieOffsetSet=!1),this.updateKey())}});Object.defineProperty(d.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(a){if(this._cookieOffset!==a){var b=!(!this._cookieTransformSet&&
        !a);!(!this._cookieTransformSet&&!this._cookieOffsetSet)!==b&&null!==this._scene&&(this._scene.updateShaders=!0);b&&!a&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=a;this._cookieOffsetSet=!!a;a&&!this._cookieTransform&&(this.cookieTransform=new pc.Vec4(1,1,0,0),this._cookieTransformSet=!1);this.updateKey()}}});return{Light:d}}());pc.extend(pc,function(){var e=0,a=function(){this.name="Untitled";this.id=e++;this._shader=null;this.variants={};this.parameters={};this.alphaTest=0;this.blend=this.alphaToCoverage=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.separateAlphaBlend=!1;this.blendSrcAlpha=pc.BLENDMODE_ONE;this.blendDstAlpha=pc.BLENDMODE_ZERO;this.blendAlphaEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.depthWrite=this.depthTest=!0;this.stencilBack=
        this.stencilFront=null;this.slopeDepthBias=this.depthBias=0;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0;this.meshInstances=[];this._shaderVersion=0;this._scene=null;this._dirtyBlend=!1};Object.defineProperty(a.prototype,"shader",{get:function(){return this._shader},set:function(a){this.setShader(a)}});Object.defineProperty(a.prototype,"blendType",{get:function(){if(!this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_NONE;
        if(!this.blend||this.blendSrc!==pc.BLENDMODE_SRC_ALPHA||this.blendDst!==pc.BLENDMODE_ONE_MINUS_SRC_ALPHA||this.blendEquation!==pc.BLENDEQUATION_ADD){if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_ADDITIVE;if(this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_ADDITIVEALPHA;if(this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&
            this.blendDst===pc.BLENDMODE_SRC_COLOR&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_MULTIPLICATIVE2X;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE_MINUS_DST_COLOR&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_SCREEN;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_MIN)return pc.BLEND_MIN;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&
            this.blendEquation===pc.BLENDEQUATION_MAX)return pc.BLEND_MAX;if(this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_MULTIPLICATIVE;if(this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD)return pc.BLEND_PREMULTIPLIED}return pc.BLEND_NORMAL},set:function(a){var c=this.blend!==pc.BLEND_NONE;switch(a){case pc.BLEND_NONE:this.blend=
        !1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=
        pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVEALPHA:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE2X:this.blend=!0;this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_SRC_COLOR;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_SCREEN:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE_MINUS_DST_COLOR;this.blendDst=pc.BLENDMODE_ONE;this.blendEquation=
        pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE:this.blend=!0;this.blendSrc=pc.BLENDMODE_DST_COLOR;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MIN:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_MIN;break;case pc.BLEND_MAX:this.blend=!0,this.blendDst=this.blendSrc=pc.BLENDMODE_ONE,this.blendEquation=pc.BLENDEQUATION_MAX}c!==(this.blend!==pc.BLEND_NONE)&&(this._scene?this._scene.layers._dirtyBlend=
        !0:this._dirtyBlend=!0);this._updateMeshInstanceKeys()}});a.prototype._cloneInternal=function(a){a.name=this.name;a.id=e++;a.variants={};a.shader=this.shader;a.parameters={};for(var c in this.parameters)this.parameters.hasOwnProperty(c)&&(a.parameters[c]={scopeId:null,data:this.parameters[c].data,passFlags:this.parameters[c].passFlags});a.alphaTest=this.alphaTest;a.alphaToCoverage=this.alphaToCoverage;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;
        a.separateAlphaBlend=this.separateAlphaBlend;a.blendSrcAlpha=this.blendSrcAlpha;a.blendDstAlpha=this.blendDstAlpha;a.blendAlphaEquation=this.blendAlphaEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.depthBias=this.depthBias;a.slopeDepthBias=this.slopeDepthBias;this.stencilFront&&(a.stencilFront=this.stencilFront.clone());this.stencilBack&&(a.stencilBack=this.stencilFront===this.stencilBack?a.stencilFront:this.stencilBack.clone());a.redWrite=this.redWrite;a.greenWrite=
            this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var a=new pc.Material;this._cloneInternal(a);return a};a.prototype._updateMeshInstanceKeys=function(){var a,c=this.meshInstances;for(a=0;a<c.length;a++)c[a].updateKey()};a.prototype.updateShader=function(a,c,d){};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return this.parameters};a.prototype.clearVariants=function(){for(var a in this.variants)this.variants.hasOwnProperty(a)&&
    this.variants[a]._refCount--;this.variants={};for(var c,d=0;d<this.meshInstances.length;d++)for(a=this.meshInstances[d],c=0;c<a._shader.length;c++)a._shader[c]=null};a.prototype.getParameter=function(a){return this.parameters[a]};a.prototype.setParameter=function(a,c,d){void 0===d&&(d=-524285);if(void 0===c&&"object"===typeof a){c=a;if(c.length){for(a=0;a<c.length;a++)this.setParameter(c[a]);return}a=c.name;c=c.value}var f=this.parameters[a];f?(f.data=c,f.passFlags=d):this.parameters[a]={scopeId:null,
        data:c,passFlags:d}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var c=this.parameters[a];c.scopeId.setValue(c.data)}};a.prototype.update=function(){throw Error("Not Implemented in base class");};a.prototype.init=function(a){throw Error("Not Implemented in base class");};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.getShader=function(){return this.shader};
        a.prototype.setShader=function(a){this._shader&&this._shader._refCount--;(this._shader=a)&&a._refCount++};a.prototype.destroy=function(){this.shader&&(this.shader._refCount--,1>this.shader._refCount&&this.shader.destroy());var a,c;for(c in this.variants)this.variants.hasOwnProperty(c)&&(a=this.variants[c],a!==this.shader&&(a._refCount--,1>a._refCount&&a.destroy()));this.variants={};this.shader=null;for(var d=0;d<this.meshInstances.length;d++){a=this.meshInstances[d];for(c=0;c<a._shader.length;c++)a._shader[c]=
            null;a._material=null;this!==pc.Scene.defaultMaterial&&(a.material=pc.Scene.defaultMaterial)}};return{Material:a}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.vertexColors=!1;this.update()},pc.Material);pc.extend(e.prototype,{clone:function(){var a=new pc.BasicMaterial;pc.Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.vertexColors=this.vertexColors;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",
        this.colorMap)},updateShader:function(a,b,c,d,f,g){b={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:this.colorMap,pass:f};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){},pc.Material);pc.extend(e.prototype,{clone:function(){var a=new pc.DepthMaterial;pc.Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:e}}());pc.extend(pc,function(){var e=function(){this.reset();this.update()},a=[],b=[],c=[],d=[],f={},g=function(b,d,g,k,h){var m="_"+d+"Map",l=m+"Tiling",n=m+"Offset",p=m.substring(1)+"Transform",q=m+"Uv",r=m+"Channel",J="_"+d+"VertexColor",G="_"+d+"VertexColorChannel";b[m]=null;b[l]=new pc.Vec2(1,1);b[n]=new pc.Vec2(0,0);b[p]=null;b[q]=g;0<k&&(g=h?h:1<k?"rgb":"g",b[r]=g,b[G]=g);b[J]=!1;pc._matTex2D||(pc._matTex2D=[]);pc._matTex2D[d]=k;Object.defineProperty(e.prototype,m.substring(1),{get:function(){return this[m]},
        set:function(a){var b=this[m];!!b^!!a&&(this.dirtyShader=!0);b&&a&&(b.rgbm!==a.rgbm||b.fixCubemapSeams!==a.fixCubemapSeams||b.format!==a.format)&&(this.dirtyShader=!0);this[m]=a}});b=l.substring(1);d=n.substring(1);Object.defineProperty(e.prototype,b,{get:function(){return this[l]},set:function(a){this.dirtyShader=!0;this[l]=a}});f[b]=function(a,b,c){a=a._updateMapTransform(c?a[p]:null,b,a[n]);return{name:"texture_"+p,value:a.data}};Object.defineProperty(e.prototype,d,{get:function(){return this[n]},
        set:function(a){this.dirtyShader=!0;this[n]=a}});f[d]=function(a,b,c){a=a._updateMapTransform(c?a[p]:null,a[l],b);return{name:"texture_"+p,value:a.data}};Object.defineProperty(e.prototype,q.substring(1),{get:function(){return this[q]},set:function(a){this[q]!==a&&(this.dirtyShader=!0);this[q]=a}});Object.defineProperty(e.prototype,r.substring(1),{get:function(){return this[r]},set:function(a){this[r]!==a&&(this.dirtyShader=!0);this[r]=a}});Object.defineProperty(e.prototype,J.substring(1),{get:function(){return this[J]},
        set:function(a){this.dirtyShader=!0;this[J]=a}});Object.defineProperty(e.prototype,G.substring(1),{get:function(){return this[G]},set:function(a){this[G]!==a&&(this.dirtyShader=!0);this[G]=a}});a.push(m.substring(1));a.push(l.substring(1));a.push(n.substring(1));a.push(q.substring(1));a.push(r.substring(1));a.push(J.substring(1));a.push(G.substring(1));c.push(p)},k=[],l=function(b,c,g,h){var m="_"+c,l=c+"Uniform",n=c+"Intensity",p="_"+n;b[m]=g;b[l]=new Float32Array(3);Object.defineProperty(e.prototype,
        c,{get:function(){this.dirtyShader=this.dirtyColor=!0;return this[m]},set:function(a){var b=this[m];(0===b.data[0]&&0===b.data[1]&&0===b.data[2]||1===b.data[0]&&1===b.data[1]&&1===b.data[2])^(0===a.data[0]&&0===a.data[1]&&0===a.data[2]||1===a.data[0]&&1===a.data[1]&&1===a.data[2])&&(this.dirtyShader=!0);this.dirtyColor=!0;this[m]=a}});a.push(c);d.push(l);k.push(c);f[c]=function(a,b,d){d=d?a[l]:new Float32Array(3);var f=!1;a.useGammaTonemap&&(f=(a._scene||pc.Application.getApplication().scene).gammaCorrection);
        for(var g=0;3>g;g++)d[g]=f?Math.pow(b.data[g],2.2):b.data[g],h&&(d[g]*=a[p]);return{name:"material_"+c,value:d}};h&&(b[p]=1,Object.defineProperty(e.prototype,n,{get:function(){return this[p]},set:function(a){var b=this[p];(0===b||1===b)^(0===a||1===a)&&(this.dirtyShader=!0);this.dirtyColor=!0;this[p]=a}}),a.push(n),f[n]=function(a,b,d){b=d?a[l]:new Float32Array(3);d=!1;a.useGammaTonemap&&(d=(a._scene||pc.Application.getApplication().scene).gammaCorrection);for(var f=0;3>f;f++)b[f]=d?Math.pow(a[m].data[f],
        2.2):a[m].data[f],b[f]*=a[p];return{name:"material_"+c,value:b}})},m=function(b,c,d,g){var k="_"+c;b[k]=d;Object.defineProperty(e.prototype,c,{get:function(){return this[k]},set:function(a){var b=this[k];(0===b||1===b)^(0===a||1===a)&&(this.dirtyShader=!0);this[k]=a}});a.push(c);f[c]=void 0!==g?g:function(a,b,d){return{name:"material_"+c,value:b}}},n=function(b,c,d){var g="_"+c;b[g]=null;Object.defineProperty(e.prototype,c,{get:function(){return this[g]},set:function(a){!!this[g]^!!a&&(this.dirtyShader=
        !0);this[g]=a}});a.push(c);f[c]=d},h=function(a,b,c){Object.defineProperty(e.prototype,c,{get:function(){return this[b]},set:function(a){this[b]=a}})},r=function(b){this._chunks=null;Object.defineProperty(e.prototype,"chunks",{get:function(){this.dirtyShader=!0;return this._chunks},set:function(a){this.dirtyShader=!0;this._chunks=a}});a.push("chunks")},p=function(b,c,d){var f="_"+c;b[f]=d;Object.defineProperty(e.prototype,c,{get:function(){return this[f]},set:function(a){this[f]!==a&&(this.dirtyShader=
        !0);this[f]=a}});a.push(c)},q=function(){};q.prototype.copy=function(a){for(var b in a)a.hasOwnProperty(b)&&"copy"!==b&&(this[b]=a[b])};e=pc.inherits(e,pc.Material);pc.extend(e.prototype,{reset:function(){this.blendType=pc.BLEND_NONE;var f;for(f=0;f<a.length;f++){var g=b[f];this[a[f]]=g?g.clone?g.clone():g:g}for(f=0;f<c.length;f++)this[c[f]]=null;for(f=0;f<d.length;f++)this[d[f]]=new Float32Array(3);this._chunks=new q;this.cubeMapMinUniform=new Float32Array(3);this.cubeMapMaxUniform=new Float32Array(3)},
        clone:function(){var b=new pc.StandardMaterial;pc.Material.prototype._cloneInternal.call(this,b);for(var c,d=0;d<a.length;d++)c=a[d],void 0!==this[c]&&(this[c]&&this[c].copy?b[c]?b[c].copy(this[c]):b[c]=this[c].clone():b[c]=this[c]);b.shader||b.update();return b},init:function(a){this.reset();this.name=a.name;a.chunks&&this.chunks.copy(a.chunks);for(var b=0;b<a.parameters.length;b++){var c=a.parameters[b];if("vec3"===c.type)this[c.name]=new pc.Color(c.data[0],c.data[1],c.data[2]);else if("vec2"===
            c.type)this[c.name]=new pc.Vec2(c.data[0],c.data[1]);else if("texture"===c.type)this[c.name]=c.data instanceof pc.Texture?c.data:null;else if("cubemap"===c.type)this[c.name]=c.data instanceof pc.Texture?c.data:null;else if("bumpMapFactor"===c.name)this.bumpiness=c.data;else if("boundingbox"===c.type){var d=c.name,f=void 0,g=void 0,f=c.data&&c.data.center?new pc.Vec3(c.data.center[0],c.data.center[1],c.data.center[2]):new pc.Vec3(0,0,0),g=c.data&&c.data.halfExtents?new pc.Vec3(c.data.halfExtents[0],
            c.data.halfExtents[1],c.data.halfExtents[2]):new pc.Vec3(.5,.5,.5),c=new pc.BoundingBox(f,g);this[d]=c}else this[c.name]=c.data}this.update()},_updateMapTransform:function(a,b,c){a=a||new pc.Vec4;a.set(b.x,b.y,c.x,c.y);return 1===a.x&&1===a.y&&0===a.z&&0===a.w?null:a},_collectLights:function(a,b,c,d,f){var g,e;for(e=0;e<b.length;e++)g=b[e],g._enabled&&g._mask&d&&(a===pc.LIGHTTYPE_DIRECTIONAL||!g.isStatic)&&c.push(g);if(f)for(e=0;e<f.length;e++)g=f[e],g._type===a&&c.push(g)},_setParameter:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  b){this.setParameter(a,b);this._propsSet.push(a)},_clearParameters:function(){for(var a=this._propsSet,b=0;b<a.length;b++)delete this.parameters[a[b]];this._propsSet=[]},_updateMap:function(a){a+="Map";if(this[a]){this._setParameter("texture_"+a,this[a]);var b=a+"Transform";this[b]=this._updateMapTransform(this[b],this[a+"Tiling"],this[a+"Offset"]);this[b]&&this._setParameter("texture_"+b,this[b].data)}},getUniform:function(a,b,c){return(a=f[a])?a(this,b,c):null},update:function(){this._clearParameters();
            this._setParameter("material_ambient",this.ambientUniform);this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform);this.useMetalness?(!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform);this._setParameter(this.getUniform("shininess",this.shininess,!0));this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",
                this.emissiveUniform);this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity);0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex));this._setParameter("material_opacity",this.opacity);this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity);this.cubeMapProjection===pc.CUBEPROJ_BOX&&this._setParameter(this.getUniform("cubeMapProjectionBox",
                this.cubeMapProjectionBox,!0));for(var a in pc._matTex2D)this._updateMap(a);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH);this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness);this.heightMap&&this._setParameter(this.getUniform("heightMapFactor",this.heightMapFactor,!0));this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap);this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&
                this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]);this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]);this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",
                this._scene._skyboxPrefiltered[2]);this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]);this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]);
            this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]);this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap);this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas);this._setParameter("material_reflectivity",this.reflectivity);if(this.dirtyShader||!this._scene)this.shader=null,this.clearVariants();
            this._processColor()},_processColor:function(){var a,b;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var c=!1;this.useGammaTonemap&&(c=this._scene.gammaCorrection);for(b=0;b<k.length;b++){var d=this["_"+k[b]],f=this[k[b]+"Uniform"];for(a=0;3>a;a++)f[a]=c?Math.pow(d.data[a],2.2):d.data[a]}for(a=0;3>a;a++)this.emissiveUniform[a]*=this.emissiveIntensity;this.dirtyColor=!1}},_getMapTransformID:function(a,b){if(!a)return 0;this._mapXForms[b]||(this._mapXForms[b]=[]);var c,d,f;for(c=0;c<this._mapXForms[b].length;c++){f=
            !0;for(d=0;d<a.data.length;d++)if(this._mapXForms[b][c][d]!=a.data[d]){f=!1;break}if(f)return c+1}c=this._mapXForms[b].length;this._mapXForms[b][c]=[];for(d=0;d<a.data.length;d++)this._mapXForms[b][c][d]=a.data[d];return c+1},updateShader:function(a,b,c,d,f,g){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());this._mapXForms=[];var e=a.useTexCubeLod,k=!a.extTextureLod,h,m,l,n,p,q;this.useSkybox&&(h=b._skyboxPrefiltered[0],m=b._skyboxPrefiltered[1],l=b._skyboxPrefiltered[2],
            n=b._skyboxPrefiltered[3],p=b._skyboxPrefiltered[4],q=b._skyboxPrefiltered[5]);var r=this.prefilteredCubeMap128||h;m=this.prefilteredCubeMap64||m;l=this.prefilteredCubeMap32||l;n=this.prefilteredCubeMap16||n;p=this.prefilteredCubeMap8||p;q=this.prefilteredCubeMap4||q;if(r){var E=r&&m&&l&&n&&p&&q;k&&E?(r.dpAtlas||(r.dpAtlas=pc.generateDpAtlas(a,[r,m,l,n,p,q]),r.sh=pc.shFromCubemap(n)),this.dpAtlas=r.dpAtlas,this.ambientSH=r.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",
            this.dpAtlas)):e?6>r._levels.length?E?this._setParameter("texture_prefilteredCubeMap128",r):console.log("Can't use prefiltered cubemap: "+E+", "+e+", "+r._levels):this._setParameter("texture_prefilteredCubeMap128",r):E?(this._setParameter("texture_prefilteredCubeMap128",r),this._setParameter("texture_prefilteredCubeMap64",m),this._setParameter("texture_prefilteredCubeMap32",l),this._setParameter("texture_prefilteredCubeMap16",n),this._setParameter("texture_prefilteredCubeMap8",p),this._setParameter("texture_prefilteredCubeMap4",
            q)):console.log("Can't use prefiltered cubemap: "+E+", "+e+", "+r._levels)}m=1===this.diffuse.data[0]&&1===this.diffuse.data[1]&&1===this.diffuse.data[2]||!this.diffuseTint&&(this.diffuseMap||this.diffuseVertexColor)?0:3;q=!1;(l=(l=(this.useMetalness?!0:!!this.specularMap)||!!this.sphereMap||!!this.cubeMap||!!this.dpAtlas)||(this.useMetalness?!0:!(0===this.specular.data[0]&&0===this.specular.data[1]&&0===this.specular.data[2])))&&(!this.specularTint&&(this.specularMap||this.specularVertexColor)||
            this.useMetalness||(q=1!==this.specular.data[0]||1!==this.specular.data[1]||1!==this.specular.data[2]));p=(r?r.rgbm:!1)||(this.cubeMap?this.cubeMap.rgbm:!1)||(this.dpAtlas?this.dpAtlas.rgbm:!1);n=(r?r.rgbm||r.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.cubeMap?this.cubeMap.rgbm||this.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.dpAtlas?this.dpAtlas.rgbm||this.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:!1);var E=(!r||this.cubeMap||this.sphereMap||this.dpAtlas?!1:r.rgbm)||(this.cubeMap?this.cubeMap.rgbm:
            !1)||(this.sphereMap?this.sphereMap.rgbm:!1)||(this.dpAtlas?this.dpAtlas.rgbm:!1),H=(!r||this.cubeMap||this.sphereMap||this.dpAtlas?!1:r.rgbm||r.format===pc.PIXELFORMAT_RGBA32F)||(this.cubeMap?this.cubeMap.rgbm||this.cubeMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.sphereMap?this.sphereMap.rgbm||this.sphereMap.format===pc.PIXELFORMAT_RGBA32F:!1)||(this.dpAtlas?this.dpAtlas.rgbm||this.dpAtlas.format===pc.PIXELFORMAT_RGBA32F:!1),W=this.emissiveMap?0:3;W||(W=(W=(1!==this.emissive.data[0]||1!==this.emissive.data[1]||
            1!==this.emissive.data[2]||1!==this.emissiveIntensity)&&this.emissiveTint)?3:1!==this.emissiveIntensity?1:0);(k=f>pc.SHADER_FORWARDHDR&&f<=pc.SHADER_PICK)?b={opacityTint:1!==this.opacity&&this.blendType!==pc.BLEND_NONE,alphaTest:0<this.alphaTest,forceFragmentPrecision:this.forceFragmentPrecision,chunks:this.chunks,blendType:this.blendType,forceUv1:this.forceUv1,pass:f}:(b={fog:this.useFog?b.fog:"none",gamma:this.useGammaTonemap?b.gammaCorrection:pc.GAMMA_NONE,toneMap:this.useGammaTonemap?b.toneMapping:
            -1,blendMapsWithColors:!0,ambientTint:this.ambientTint,diffuseTint:m,specularTint:q?3:0,metalnessTint:this.useMetalness&&1>this.metalness?1:0,glossTint:1,emissiveTint:W,opacityTint:1!==this.opacity&&this.blendType!==pc.BLEND_NONE?1:0,alphaTest:0<this.alphaTest,alphaToCoverage:this.alphaToCoverage,needsNormalFloat:this.normalizeNormalMap,sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap,dpAtlas:!!this.dpAtlas,ambientSH:!!this.ambientSH,useSpecular:l,rgbmAmbient:p,rgbmReflection:E,hdrAmbient:n,hdrReflection:H,
            fixSeams:r?r.fixCubemapSeams:this.cubeMap?this.cubeMap.fixCubemapSeams:!1,prefilteredCubemap:!!r,emissiveFormat:this.emissiveMap?this.emissiveMap.rgbm?1:this.emissiveMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,lightMapFormat:this.lightMap?this.lightMap.rgbm?1:this.lightMap.format===pc.PIXELFORMAT_RGBA32F?2:0:null,useRgbm:E||p||(this.emissiveMap?this.emissiveMap.rgbm:0)||(this.lightMap?this.lightMap.rgbm:0),specularAntialias:this.specularAntialias,conserveEnergy:this.conserveEnergy,occludeSpecular:this.occludeSpecular,
            occludeSpecularFloat:1!==this.occludeSpecularIntensity,occludeDirect:this.occludeDirect,shadingModel:this.shadingModel,fresnelModel:this.fresnelModel,packedNormal:this.normalMap?this.normalMap.format===pc.PIXELFORMAT_DXT5:!1,forceFragmentPrecision:this.forceFragmentPrecision,fastTbn:this.fastTbn,cubeMapProjection:this.cubeMapProjection,chunks:this.chunks,customFragmentShader:this.customFragmentShader,refraction:!!this.refraction,useMetalness:this.useMetalness,blendType:this.blendType,skyboxIntensity:r===
            h&&r&&1!==b.skyboxIntensity,forceUv1:this.forceUv1,useTexCubeLod:e,msdf:!!this.msdfMap,twoSidedLighting:this.twoSidedLighting,pixelSnap:this.pixelSnap,pass:f},f===pc.SHADER_FORWARDHDR&&(b.gamma&&(b.gamma=pc.GAMMA_SRGBHDR),b.toneMap=pc.TONEMAP_LINEAR));h=e=f=!1;c&&(k||(b.noShadow=0!==(c&pc.SHADERDEF_NOSHADOW),0!==(c&pc.SHADERDEF_LM)&&(b.lightMapFormat=1,b.lightMap=!0,b.lightMapChannel="rgb",b.lightMapUv=1,b.lightMapTransform=0,b.lightMapWithoutAmbient=!this.lightMap,b.useRgbm=!0,0!==(c&pc.SHADERDEF_DIRLM)&&
        (b.dirLightMap=!0))),b.screenSpace=0!==(c&pc.SHADERDEF_SCREENSPACE),b.skin=0!==(c&pc.SHADERDEF_SKIN),b.useInstancing=0!==(c&pc.SHADERDEF_INSTANCING),f=0!==(c&pc.SHADERDEF_UV0),e=0!==(c&pc.SHADERDEF_UV1),h=0!==(c&pc.SHADERDEF_VCOLOR));for(var R in pc._matTex2D)if(r="opacity"===R,!r||this.blendType!==pc.BLEND_NONE||0!==this.alphaTest||this.alphaToCoverage)if(!k||r)r=R+"Map",q=R+"VertexColor","height"!==R&&this[q]&&h&&(m=R+"VertexColorChannel",b[q]=this[q],b[m]=this[m],b.vertexColors=!0),this[r]&&(q=
            r+"Uv",m=!0,0!==this[q]||f||(m=!1),1!==this[q]||e||(m=!1),m&&(b[r]=!!this[r],l=r+"Transform",m=r+"Channel",b[l]=this._getMapTransformID(this[l],this[q]),b[m]=this[m],b[q]=this[q]));this._mapXForms=null;this.useLighting&&!k?(R=[],f=c?c>>16:1,g&&(this._collectLights(pc.LIGHTTYPE_DIRECTIONAL,g[pc.LIGHTTYPE_DIRECTIONAL],R,f),this._collectLights(pc.LIGHTTYPE_POINT,g[pc.LIGHTTYPE_POINT],R,f,d),this._collectLights(pc.LIGHTTYPE_SPOT,g[pc.LIGHTTYPE_SPOT],R,f,d)),b.lights=R):b.lights=[];k||(b.aoMapUv=b.aoMapUv||
            this.aoUvSet,0===b.lights.length&&(b.noShadow=!1));this.onUpdateShader&&(b=this.onUpdateShader(b));this.shader=a.getProgramLibrary().getProgram("standard",b);c||(this.clearVariants(),this.variants[0]=this.shader);this.dirtyShader=!1}});(function(c){c.dirtyShader=!0;c.dirtyColor=!0;c._scene=null;c._colorProcessed=!1;l(c,"ambient",new pc.Color(.7,.7,.7));l(c,"diffuse",new pc.Color(1,1,1));l(c,"specular",new pc.Color(0,0,0));l(c,"emissive",new pc.Color(0,0,0),!0);m(c,"shininess",25,function(a,b){return{name:"material_shininess",
        value:a.shadingModel===pc.SPECULAR_PHONG?Math.pow(2,.11*b):.01*b}});m(c,"heightMapFactor",1,function(a,b){return{name:"material_heightMapFactor",value:.025*b}});m(c,"opacity",1);m(c,"alphaTest",0);m(c,"bumpiness",1);m(c,"reflectivity",1);m(c,"occludeSpecularIntensity",1);m(c,"refraction",0);m(c,"refractionIndex",1/1.5);m(c,"metalness",1);m(c,"aoUvSet",0,null);n(c,"ambientSH",function(a,b,c){return{name:"ambientSH[0]",value:b}});n(c,"cubeMapProjectionBox",function(a,b,c){var d=c?a.cubeMapMinUniform:
        new Float32Array(3);a=c?a.cubeMapMaxUniform:new Float32Array(3);d[0]=b.center.x-b.halfExtents.x;d[1]=b.center.y-b.halfExtents.y;d[2]=b.center.z-b.halfExtents.z;a[0]=b.center.x+b.halfExtents.x;a[1]=b.center.y+b.halfExtents.y;a[2]=b.center.z+b.halfExtents.z;return[{name:"envBoxMin",value:d},{name:"envBoxMax",value:a}]});r(c);p(c,"ambientTint",!1);p(c,"diffuseTint",!1);p(c,"specularTint",!1);p(c,"emissiveTint",!1);p(c,"fastTbn",!1);p(c,"specularAntialias",!1);p(c,"useMetalness",!1);p(c,"occludeDirect",
        !1);p(c,"normalizeNormalMap",!0);p(c,"conserveEnergy",!0);p(c,"occludeSpecular",pc.SPECOCC_AO);p(c,"shadingModel",pc.SPECULAR_BLINN);p(c,"fresnelModel",pc.FRESNEL_NONE);p(c,"cubeMapProjection",pc.CUBEPROJ_NONE);p(c,"customFragmentShader",null);p(c,"forceFragmentPrecision",null);p(c,"useFog",!0);p(c,"useLighting",!0);p(c,"useGammaTonemap",!0);p(c,"useSkybox",!0);p(c,"forceUv1",!1);p(c,"pixelSnap",!1);p(c,"twoSidedLighting",!1);g(c,"diffuse",0,3);g(c,"specular",0,3);g(c,"emissive",0,3);g(c,"normal",
        0,-1);g(c,"metalness",0,1);g(c,"gloss",0,1);g(c,"opacity",0,1,"a");g(c,"height",0,1);g(c,"ao",0,1);g(c,"light",1,3);g(c,"msdf",0,3);n(c,"cubeMap");n(c,"sphereMap");n(c,"dpAtlas");n(c,"prefilteredCubeMap128");n(c,"prefilteredCubeMap64");n(c,"prefilteredCubeMap32");n(c,"prefilteredCubeMap16");n(c,"prefilteredCubeMap8");n(c,"prefilteredCubeMap4");h(c,"diffuseTint","diffuseMapTint");h(c,"specularTint","specularMapTint");h(c,"emissiveTint","emissiveMapTint");h(c,"aoVertexColor","aoMapVertexColor");h(c,
        "diffuseVertexColor","diffuseMapVertexColor");h(c,"specularVertexColor","specularMapVertexColor");h(c,"emissiveVertexColor","emissiveMapVertexColor");h(c,"metalnessVertexColor","metalnessMapVertexColor");h(c,"glossVertexColor","glossMapVertexColor");h(c,"opacityVertexColor","opacityMapVertexColor");h(c,"lightVertexColor","lightMapVertexColor");for(var d=0;d<a.length;d++)b[d]=c[a[d]];c._propsSet=[]})(e.prototype);return{StandardMaterial:e}}());pc.extend(pc,function(){function e(a,b,c,d){return(a&15)<<27|(b===pc.BLEND_NONE?1:0)<<26|(c?1:0)<<25|(d&33554431)<<0}var a=0,b=new pc.BoundingBox,c=function(){this._refCount=0;this.id=a++;this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.morph=this.skin=null;this._aabb=new pc.BoundingBox;this.boneAabb=null};Object.defineProperty(c.prototype,"aabb",{get:function(){return this.morph?this.morph.aabb:this._aabb},set:function(a){this.morph?(this._aabb=this.morph._baseAabb=
        a,this.morph._calculateAabb()):this._aabb=a}});var d=function(a,b,c){this._key=[0,0];this._shader=[null,null,null];this.isStatic=!1;this._staticSource=this._staticLightList=null;this.node=a;this._mesh=b;b._refCount++;this.material=c;this._shaderDefs=pc.MASK_DYNAMIC<<16;this._shaderDefs|=b.vertexBuffer.format.hasUv0?pc.SHADERDEF_UV0:0;this._shaderDefs|=b.vertexBuffer.format.hasUv1?pc.SHADERDEF_UV1:0;this._shaderDefs|=b.vertexBuffer.format.hasColor?pc.SHADERDEF_VCOLOR:0;this._lightHash=0;this.visible=
        !0;this.layer=pc.LAYER_WORLD;this.renderStyle=pc.RENDERSTYLE_SOLID;this.castShadow=!1;this._receiveShadow=!0;this._noDepthDrawGl1=this._screenSpace=!1;this._updateAabb=this.pick=this.cull=!0;this._updateAabbFunc=null;this.updateKey();this.instancingData=this.morphInstance=this._skinInstance=null;this.aabb=new pc.BoundingBox;this._boneAabb=null;this._aabbVer=-1;this.visibleThisFrame=this.drawOrder=0;this.parameters={};this.stencilBack=this.stencilFront=null};Object.defineProperty(d.prototype,"mesh",
        {get:function(){return this._mesh},set:function(a){this._mesh&&this._mesh._refCount--;(this._mesh=a)&&a._refCount++}});Object.defineProperty(d.prototype,"aabb",{get:function(){var a;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){var c=this.mesh.skin.boneNames.length,d,f;if(!this.mesh.boneAabb){this.mesh.boneAabb=[];this.mesh.boneUsed=[];var g=this.mesh.vertexBuffer.format.elements,e=this.mesh.vertexBuffer.numVertices;a=
        this.mesh.vertexBuffer.format.size;var p,q,t,x,y;for(f=0;f<g.length;f++)g[f].name===pc.SEMANTIC_POSITION?q=g[f].offset:g[f].name===pc.SEMANTIC_BLENDINDICES?t=g[f].offset:g[f].name===pc.SEMANTIC_BLENDWEIGHT&&(x=g[f].offset);var g=new Uint8Array(this.mesh.vertexBuffer.storage),w=new Float32Array(this.mesh.vertexBuffer.storage),u=q/4,v=x/4,z=a/4,A,D,B,F,J;x=[];q=[];d=this.mesh.boneUsed;for(f=0;f<c;f++)x[f]=new pc.Vec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),q[f]=new pc.Vec3(-Number.MAX_VALUE,
        -Number.MAX_VALUE,-Number.MAX_VALUE);for(y=0;y<e;y++)for(f=0;4>f;f++)0<w[y*z+v+f]&&(p=g[y*a+t+f],B=w[y*z+u],F=w[y*z+u+1],J=w[y*z+u+2],A=q[p],D=x[p],D.x>B&&(D.x=B),D.y>F&&(D.y=F),D.z>J&&(D.z=J),A.x<B&&(A.x=B),A.y<F&&(A.y=F),A.z<J&&(A.z=J),d[p]=!0);if(this.morphInstance){var G;d=this.morphInstance.morph._targets;var I=new Float32Array(3*e),C=new Float32Array(3*e),E;for(y=0;y<e;y++)I[3*y]=C[3*y]=w[y*z+u],I[3*y+1]=C[3*y+1]=w[y*z+u+1],I[3*y+2]=C[3*y+2]=w[y*z+u+2];for(e=0;e<d.length;e++)for(f=d[e],u=f.indices,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      y=u.length,B=f.deltaPositions,f=0;f<y;f++)G=u[f],p=B[3*f],A=B[3*f+1],D=B[3*f+2],0>p?I[3*G]+=p:C[3*G]+=p,0>A?I[3*G+1]+=A:C[3*G+1]+=A,0>D?I[3*G+2]+=D:C[3*G+2]+=D;for(e=0;e<d.length;e++)for(f=d[e],u=f.indices,y=u.length,f=0;f<y;f++)for(G=u[f],E=0;4>E;E++)0<w[G*z+v+E]&&(p=g[G*a+t+E],A=q[p],D=x[p],B=I[3*G],F=I[3*G+1],J=I[3*G+2],D.x>B&&(D.x=B),D.y>F&&(D.y=F),D.z>J&&(D.z=J),B=C[3*G],F=C[3*G+1],J=C[3*G+2],A.x<B&&(A.x=B),A.y<F&&(A.y=F),A.z<J&&(A.z=J))}for(f=0;f<c;f++)a=new pc.BoundingBox,a.setMinMax(x[f],
        q[f]),this.mesh.boneAabb.push(a)}if(!this._boneAabb)for(this._boneAabb=[],f=0;f<this.mesh.boneAabb.length;f++)this._boneAabb[f]=new pc.BoundingBox;d=this.mesh.boneUsed;for(f=0;f<this.mesh.boneAabb.length;f++)d[f]&&this._boneAabb[f].setFromTransformedAabb(this.mesh.boneAabb[f],this.skinInstance.matrices[f]);c=this.node.getWorldTransform();a=!0;for(f=0;f<this.mesh.boneAabb.length;f++)d[f]&&(a?(b.center.copy(this._boneAabb[f].center),b.halfExtents.copy(this._boneAabb[f].halfExtents),a=!1):b.add(this._boneAabb[f]));
        this._aabb.setFromTransformedAabb(b,c)}else this.node._aabbVer!==this._aabbVer&&(a=this.mesh?this.mesh.aabb:this._aabb,this.mesh||(a.center.set(0,0,0),a.halfExtents.set(0,0,0)),this._aabb.setFromTransformedAabb(a,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(a){this._aabb=a}});Object.defineProperty(d.prototype,"material",{get:function(){return this._material},set:function(a){var b;for(b=0;b<this._shader.length;b++)this._shader[b]=null;if(this._material){var c=
        this._material.meshInstances;b=c.indexOf(this);-1!==b&&c.splice(b,1)}c=this._material?this._material.blendType!==pc.BLEND_NONE:!1;b=this._material;if(this._material=a)this._material.meshInstances.push(this),this.updateKey();a&&a.blendType!==pc.BLEND_NONE!==c&&(c=a._scene,!c&&b&&b._scene&&(c=b._scene),c?c.layers._dirtyBlend=!0:a._dirtyBlend=!0)}});Object.defineProperty(d.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});Object.defineProperty(d.prototype,
        "receiveShadow",{get:function(){return this._receiveShadow},set:function(a){this._shaderDefs=(this._receiveShadow=a)?this._shaderDefs&~pc.SHADERDEF_NOSHADOW:this._shaderDefs|pc.SHADERDEF_NOSHADOW;this._shader[pc.SHADER_FORWARD]=null;this._shader[pc.SHADER_FORWARDHDR]=null}});Object.defineProperty(d.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(a){this._shaderDefs=(this._skinInstance=a)?this._shaderDefs|pc.SHADERDEF_SKIN:this._shaderDefs&~pc.SHADERDEF_SKIN;for(a=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0;a<this._shader.length;a++)this._shader[a]=null}});Object.defineProperty(d.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(a){this._shaderDefs=(this._screenSpace=a)?this._shaderDefs|pc.SHADERDEF_SCREENSPACE:this._shaderDefs&~pc.SHADERDEF_SCREENSPACE;this._shader[pc.SHADER_FORWARD]=null}});Object.defineProperty(d.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(a){this._key[pc.SORTKEY_FORWARD]=a}});Object.defineProperty(d.prototype,
        "mask",{get:function(){return this._shaderDefs>>16},set:function(a){this._shaderDefs=this._shaderDefs&65535|a<<16;this._shader[pc.SHADER_FORWARD]=null;this._shader[pc.SHADER_FORWARDHDR]=null}});pc.extend(d.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this._key[pc.SORTKEY_FORWARD]=e(this.layer,a.alphaToCoverage||a.alphaTest?pc.BLEND_NORMAL:a.blendType,!1,a.id)},setParameter:pc.Material.prototype.setParameter,setParameters:pc.Material.prototype.setParameters,deleteParameter:pc.Material.prototype.deleteParameter,
        getParameter:pc.Material.prototype.getParameter,getParameters:pc.Material.prototype.getParameters,clearParameters:pc.Material.prototype.clearParameters});var f=function(a,b,c){this._key=[];this._key[pc.SORTKEY_FORWARD]=e(a,b,!0,0);this.command=c};Object.defineProperty(f.prototype,"key",{get:function(){return this._key[pc.SORTKEY_FORWARD]},set:function(a){this._key[pc.SORTKEY_FORWARD]=a}});var g=function(a,b,c){this.buffer=new Float32Array(a*(c||16));this.count=a;this.offset=0;this.usage=b?pc.BUFFER_DYNAMIC:
        pc.BUFFER_STATIC;this._buffer=null};g.prototype={update:function(){this._buffer&&this._buffer.setData(this.buffer)}};return{Command:f,Mesh:c,MeshInstance:d,InstancingData:g,_getDrawcallSortKey:e}}());pc.extend(pc,function(){var e=new pc.Mat4,a=function(a){this.skin=a;this._dirty=!0;this.bones=[];var c=a.inverseBindPose.length;a=a.device;if(a.supportsBoneTextures){var d;d=256<c?64:64<c?32:16<c?16:8;this.boneTexture=new pc.Texture(a,{width:d,height:d,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST});this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(16*c);this.matrices=[];for(a=0;a<c;a++)this.matrices[a]=new pc.Mat4};
        a.prototype={updateMatrices:function(a){e.copy(a.getWorldTransform()).invert();for(a=this.bones.length-1;0<=a;a--)this.matrices[a].mul2(e,this.bones[a].getWorldTransform()),this.matrices[a].mul2(this.matrices[a],this.skin.inverseBindPose[a])},updateMatrixPalette:function(){for(var a,c=this.matrixPalette,d,f=this.bones.length-1;0<=f;f--)a=this.matrices[f].data,d=16*f,c[d]=a[0],c[d+1]=a[1],c[d+2]=a[2],c[d+3]=a[3],c[d+4]=a[4],c[d+5]=a[5],c[d+6]=a[6],c[d+7]=a[7],c[d+8]=a[8],c[d+9]=a[9],c[d+10]=a[10],
            c[d+11]=a[11],c[d+12]=a[12],c[d+13]=a[13],c[d+14]=a[14],c[d+15]=a[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,c,d){this.device=a;this.inverseBindPose=c;this.boneNames=d},SkinInstance:a}}());pc.extend(pc,function(){function e(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}function b(a){var b=a.vertices,c=a.skins,e=a.meshes,l=a.meshInstances;for(a=0;a<e.length;a++)e[a].vertices=b[e[a].vertices],void 0!==e[a].skin&&(e[a].skin=c[e[a].skin]);for(a=0;a<l.length;a++)l[a].mesh=e[l[a].mesh]}function c(a){var b=a.vertices,c=a.skins,e=
        a.meshes,l=a.meshInstances;for(a=0;a<e.length;a++)e[a].vertices=b.indexOf(e[a].vertices),void 0!==e[a].skin&&(e[a].skin=c.indexOf(e[a].skin));for(a=0;a<l.length;a++)l[a].mesh=e.indexOf(l[a].mesh)}a.prototype={addVertex:function(a,b,c){var e=-1;if(void 0!==this.indexMap[b])e=this.indexMap[b],this.indices.push(e);else{for(e=0;4>e;e++)0!==c.blendWeight.data[4*b+e]&&(a.boneIndices[e]=this.getBoneRemap(c.blendIndices.data[4*a.index+e]));e=this.vertices.length;this.indices.push(e);this.vertices.push(a);
        this.indexMap[b]=e}},addPrimitive:function(a,b,c,e){var l,m,n=[],h=0,r=a.length;for(l=0;l<r;l++)for(var p=a[l].index,q=0;4>q;q++)if(0<c.blendWeight.data[4*p+q]){var t=c.blendIndices.data[4*p+q],x=!0;for(m=0;m<h;m++)if(n[m]==t){x=!1;break}x&&(n[h]=t,m=this.getBoneRemap(t),h+=-1===m?1:0)}if(this.boneIndices.length+h>e)return!1;for(l=0;l<h;l++)this.boneIndices.push(n[l]);for(l=0;l<r;l++)this.addVertex(a[l],b[l],c);return!0},getBoneRemap:function(a){for(var b=0;b<this.boneIndices.length;b++)if(this.boneIndices[b]===
        a)return b;return-1}};return{partitionSkin:function(d,f,g){var k,l,m,n;b(d);var h=d.vertices,r=d.skins,p,q=d.meshes,t=d.meshInstances,x=function(a){var b=new e;b.index=a;return b};for(k=r.length-1;0<=k;k--)if(r[k].boneNames.length>g){var y=r.splice(k,1)[0],w=[];for(l=0;l<q.length;l++)q[l].skin===y&&w.push(q[l]);for(l=0;l<w.length;l++)n=q.indexOf(w[l]),-1!==n&&q.splice(n,1);if(0===w.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var u=w[0].vertices;for(l=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   1;l<w.length;l++)if(w[l].vertices!==u)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var v=[],z=[];m=[];var A=0;for(l=0;l<w.length;l++){p=w[l];for(var D=p.indices,B=p.base;B<p.base+p.count;){n=D[B++];z[0]=x(n);m[0]=n;n=D[B++];z[1]=x(n);m[1]=n;n=D[B++];z[2]=x(n);m[2]=n;for(var F=!1,J=A;J<v.length;J++)if(n=v[J],n.addPrimitive(z,m,u,g)){F=!0;break}F||(n=new a,n.originalMesh=p,n.addPrimitive(z,m,u,g),v.push(n))}A=v.length}p=[];w=[];for(l=0;l<v.length;l++)if(n=
            v[l],n.vertices.length&&n.indices.length){z=p.length;m=n.vertices.length;A=w.length;D=n.indices.length;n.partition=l;n.vertexStart=z;n.vertexCount=m;n.indexStart=A;n.indexCount=D;B=0;for(F=z;B<m;)p[F++]=n.vertices[B++];B=0;for(F=A;B<D;)w[F++]=n.indices[B++]+z}z=[];for(l=0;l<v.length;l++){n=v[l];A=[];D=[];for(m=0;m<n.boneIndices.length;m++)A.push(y.inverseBindMatrices[n.boneIndices[m]]),D.push(y.boneNames[n.boneIndices[m]]);n={inverseBindMatrices:A,boneNames:D};z.push(n);r.push(n)}var G,y={};for(G in u)y[G]=
        {components:u[G].components,data:[],type:u[G].type};for(G in u)if("blendIndices"===G)for(n=y[G].data,l=0;l<p.length;l++)m=p[l].boneIndices,n.push(m[0],m[1],m[2],m[3]);else for(l=u[G],A=l.data,D=l.components,l=0;l<p.length;l++)for(n=p[l].index,m=0;m<D;m++)y[G].data.push(A[n*D+m]);h[h.indexOf(u)]=y;for(l=0;l<v.length;l++)for(n=v[l],p={aabb:{min:[0,0,0],max:[0,0,0]},vertices:y,skin:z[l],indices:w.splice(0,n.indexCount),type:"triangles",base:0,count:n.indexCount},q.push(p),m=t.length-1;0<=m;m--)t[m].mesh===
    n.originalMesh&&(t.push({mesh:p,node:t[m].node}),f&&f.push({material:f[m].material,path:f[m].path}));for(l=0;l<v.length;l++)for(n=v[l],m=t.length-1;0<=m;m--)t[m].mesh===n.originalMesh&&(t.splice(m,1),f&&f.splice(m,1))}c(d)}}}());pc.extend(pc,function(){var e=new pc.Vec3,a=new pc.Vec3,b=function(a){this.aabb=new pc.BoundingBox;this._baseAabb=this._baseBuffer=null;this._targets=a;this._aabbDirty=this._dirty=!0;this._baseData=null;this._vertSizeF=this._offsetTF=this._offsetNF=this._offsetPF=0};pc.extend(b.prototype,{_setBaseMesh:function(a){this._baseBuffer=a.vertexBuffer;this._baseAabb=a._aabb;this._baseData=new Float32Array(this._baseBuffer.storage);for(var b=a=-1,c=-1,e=this._baseBuffer.format.elements,l=this._baseBuffer.format.size,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             m=0;m<e.length;m++)e[m].name===pc.SEMANTIC_POSITION?a=e[m].offset:e[m].name===pc.SEMANTIC_NORMAL?b=e[m].offset:e[m].name===pc.SEMANTIC_TANGENT&&(c=e[m].offset);this._offsetPF=a/4;this._offsetNF=b/4;this._offsetTF=c/4;this._vertSizeF=l/4;this._dirty=!0},_calculateAabb:function(){if(this._baseBuffer){this.aabb.copy(this._baseAabb);var b,c,g,k,l,m,n,h=this._vertSizeF,r=this._offsetPF,p=this._baseData;for(c=0;c<this._targets.length;c++){k=this._targets[c];if(!k.aabb&&0<k.indices.length){k.aabb=this.aabb.clone();
        e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);a.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);b=k.indices.length;for(g=0;g<b;g++)l=k.indices[g],m=l*h+r,l=p[m]+k.deltaPositions[3*g],n=p[m+1]+k.deltaPositions[3*g+1],m=p[m+2]+k.deltaPositions[3*g+2],e.x>l&&(e.x=l),e.y>n&&(e.y=n),e.z>m&&(e.z=m),a.x<l&&(a.x=l),a.y<n&&(a.y=n),a.z<m&&(a.z=m);k.aabb.setMinMax(e,a)}k.aabb&&this.aabb.add(k.aabb)}this._aabbDirty=!1}},addTarget:function(a){this._targets.push(a);this._aabbDirty=!0},removeTarget:function(a){a=
        this._targets.indexOf(a);-1!==a&&(this._targets.splice(a,1),this._aabbDirty=!0)},getTarget:function(a){return this._targets[a]}});var c=function(a){this.morph=a;this._vertexData=this._vertexBuffer=null;this._weights=[];this._dirty=!0};c.prototype={_setBaseMesh:function(a){this.destroy();this._vertexBuffer=new pc.VertexBuffer(this.morph._baseBuffer.device,this.morph._baseBuffer.format,this.morph._baseBuffer.numVertices,pc.BUFFER_DYNAMIC,this.morph._baseBuffer.storage.slice(0));this._vertexData=new Float32Array(this._vertexBuffer.storage);
        this._weights=[];this._weights.length=this.morph._targets.length;for(a=0;a<this.morph._targets.length;a++)this._weights[a]=0;this._dirty=!0},destroy:function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null)},getWeight:function(a){return this._weights[a]},setWeight:function(a,b){this._weights[a]=b;this._dirty=!0},updateBounds:function(a){this.morph._baseBuffer!==a.vertexBuffer&&this.morph._setBaseMesh(a);this._vertexData||this._setBaseMesh(a);this.morph._aabbDirty&&this.morph._calculateAabb()},
        update:function(a){this.morph._baseBuffer!==a.vertexBuffer&&this.morph._setBaseMesh(a);this._vertexData||this._setBaseMesh(a);var b,c=this.morph._targets,e=this._weights,l,m,n,h,r,p=this.morph._vertSizeF,q=this.morph._offsetPF,t=this.morph._offsetNF,x=this.morph._offsetTF,y=this._vertexData;y.set(this.morph._baseData);for(var w=0;w<c.length;w++)if(m=e[w],0!==m)for(l=c[w],a=l.indices.length,n=0;n<a;n++)r=3*n,b=l.indices[n],h=b*p+q,y[h]+=l.deltaPositions[r]*m,y[h+1]+=l.deltaPositions[r+1]*m,y[h+2]+=
            l.deltaPositions[r+2]*m,l.deltaNormals&&(h=b*p+t,y[h]+=l.deltaNormals[r]*m,y[h+1]+=l.deltaNormals[r+1]*m,y[h+2]+=l.deltaNormals[r+2]*m,l.deltaTangents&&(r=4*n,h=b*p+x,y[h]+=l.deltaTangents[r]*m,y[h+1]+=l.deltaTangents[r+1]*m,y[h+2]+=l.deltaTangents[r+2]*m,y[h+3]+=l.deltaTangents[r+3]*m,y[h+3]=0<y[h+3]?1:-1));this._vertexBuffer.unlock()}};return{MorphTarget:function(a){if(a.indices)this.indices=a.indices;else{var b=a.deltaPositions;this.indices=[];this.indices.length=b.length;for(var c=0;c<b.length;c++)this.indices[c]=
        c}this.deltaPositions=a.deltaPositions;this.deltaNormals=a.deltaNormals;this.deltaTangents=a.deltaTangents;this.name=a.name;this.aabb=a.aabb},Morph:b,MorphInstance:c}}());pc.extend(pc,function(){var e=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.morphInstances=[];this.cameras=[];this.lights=[];this._shadersVersion=0};e.prototype={getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=
        this.meshInstances[a];-1===b.indexOf(c.material)&&b.push(c.material)}return b},clone:function(){var a,b,c=[],d=[],f=function(a){var b=a.clone();c.push(a);d.push(b);for(var g=0;g<a._children.length;g++)b.addChild(f(a._children[g]));return b},g=f(this.graph),e=[],l=[],m=[];for(a=0;a<this.skinInstances.length;a++){var n=this.skinInstances[a].skin,h=new pc.SkinInstance(n),r=[];for(b=0;b<n.boneNames.length;b++){var p=g.findByName(n.boneNames[b]);r.push(p)}h.bones=r;l.push(h)}for(a=0;a<this.morphInstances.length;a++)b=
        new pc.MorphInstance(this.morphInstances[a].morph),m.push(b);for(a=0;a<this.meshInstances.length;a++)b=this.meshInstances[a],n=c.indexOf(b.node),n=new pc.MeshInstance(d[n],b.mesh,b.material),b.skinInstance&&(h=this.skinInstances.indexOf(b.skinInstance),n.skinInstance=l[h]),b.morphInstance&&(b=this.morphInstances.indexOf(b.morphInstance),n.morphInstance=m[b]),e.push(n);a=new pc.Model;a.graph=g;a.meshInstances=e;a.skinInstances=l;a.morphInstances=m;a.getGraph().syncHierarchy();return a},destroy:function(){for(var a=
        this.meshInstances,b,c,d,f,g=0;g<a.length;g++){b=a[g];if(c=b.mesh)if(c._refCount--,1>c._refCount){c.vertexBuffer&&(c.vertexBuffer.destroy(),c.vertexBuffer=null);for(f=0;f<c.indexBuffer.length;f++)(d=c.indexBuffer[f])&&d.destroy();c.indexBuffer.length=0}(c=b.skinInstance)&&(c=c.boneTexture)&&c.destroy();b.skinInstance=null;(c=b.morphInstance)&&c.destroy();b.morphInstance=null;b.material=null}},generateWireframe:function(){var a,b,c,d,f,g,e,l,m,n,h=[];for(a=0;a<this.meshInstances.length;a++)g=this.meshInstances[a].mesh,
    -1===h.indexOf(g)&&h.push(g);var r=[[0,1],[1,2],[2,0]];for(a=0;a<h.length;a++){g=h[a];e=g.primitive[pc.RENDERSTYLE_SOLID].base;l=g.primitive[pc.RENDERSTYLE_SOLID].count;m=g.indexBuffer[pc.RENDERSTYLE_SOLID];n=new Uint16Array(m.lock());var p={},q=[];for(b=e;b<e+l;b+=3)for(c=0;3>c;c++){d=n[b+r[c][0]];f=n[b+r[c][1]];var t=d>f?f<<16|d:d<<16|f;void 0===p[t]&&(p[t]=0,q.push(d,f))}m.unlock();b=new pc.IndexBuffer(m.device,pc.INDEXFORMAT_UINT16,q.length);c=new Uint16Array(b.lock());c.set(q);b.unlock();g.primitive[pc.RENDERSTYLE_WIREFRAME]=
        {type:pc.PRIMITIVE_LINES,base:0,count:q.length,indexed:!0};g.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=b}}};return{Model:e}}());pc.extend(pc,function(){function e(a,b){return a-b*Math.floor(a/b)}function a(a,b){R[a]=void 0!==Z[a]&&null!==Z[a]?Z[a]:b}function b(a,b){for(var c=a.length/3,d=Array(4*c),f=0;f<c;f++)d[4*f]=a[3*f],d[4*f+1]=a[3*f+1],d[4*f+2]=a[3*f+2],d[4*f+3]=(255*b[3*f]<<16|255*b[3*f+1]<<8|255*b[3*f+2])/16777216;return d}function c(a,b){var c,d,f=b.length,g=a.length/f;for(c=0;c<g;c++)for(d=0;d<f;d++)b[d]=Math.max(b[d],Math.abs(a[c*f+d]))}function d(a,b,d){for(var f=new Float32Array(b.length),g=0;g<b.length;g++)f[g]=
        b[g]-a[g];c(f,d);a=d.length;var e=f.length/a;for(b=0;b<e;b++)for(g=0;g<a;g++)f[b*a+g]/=d[g],f[b*a+g]*=.5,f[b*a+g]+=.5;return f}function f(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var g=[[-1,-1],[1,-1],[1,1],[-1,1]],k=function(a,b,c,d,f,g,e){f||(f=pc.PIXELFORMAT_RGBA32F);var k=pc.FILTER_NEAREST;e&&f===pc.PIXELFORMAT_R8_G8_B8_A8&&(k=pc.FILTER_LINEAR);a=new pc.Texture(a,
        {width:b,height:c,format:f,cubemap:!1,mipmaps:!1,minFilter:k,magFilter:k,addressU:pc.ADDRESS_CLAMP_TO_EDGE,addressV:pc.ADDRESS_CLAMP_TO_EDGE});b=a.lock();if(f===pc.PIXELFORMAT_R8_G8_B8_A8){f=new Uint8Array(d.length);for(c=0;c<d.length;c++)f[c]=d[c]*g*255;d=f}b.set(d);a.unlock();return a},l=new pc.Curve([0,0,1,0]),m=new pc.Curve([0,1,1,1]),n=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),h=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),r=2,p=new pc.Vec3,q=new pc.Vec3,t=new pc.Vec3,x=new pc.Vec3,y=
        new pc.Vec3,w=new pc.Vec3,u=new pc.Vec3,v=new pc.Vec3,z=new pc.Vec3,A=new pc.Mat4,D=new pc.Mat3,B=new pc.Mat3,F=1,J,G=new pc.Mat4,I=new pc.Vec3,C=new pc.Vec3,E=new pc.Vec3,H=new pc.Vec3,W=new pc.Vec3,R,Z,T=function(b,c){this.graphicsDevice=b;this.precision=32;this._addTimeTime=0;if(!T.DEFAULT_PARAM_TEXTURE){var d=new Float32Array(1024),f,g,e,p;for(g=0;16>g;g++)for(f=0;16>f;f++)e=f+1-8.5,p=g+1-8.5,p=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(e*e+p*p)/16,1),0)-.5,1),0),e=16*g+f,d[4*e]=1,d[4*e+
    1]=1,d[4*e+2]=1,d[4*e+3]=p;T.DEFAULT_PARAM_TEXTURE=k(b,16,16,d,pc.PIXELFORMAT_R8_G8_B8_A8,1,!0);T.DEFAULT_PARAM_TEXTURE.minFilter=pc.FILTER_LINEAR;T.DEFAULT_PARAM_TEXTURE.magFilter=pc.FILTER_LINEAR}R=this;Z=c;a("numParticles",1);this.numParticles>b.maxTextureSize&&(console.warn("WARNING: can't create more than "+b.maxTextureSize+" particles on this device."),this.numParticles=b.maxTextureSize);a("rate",1);a("rate2",this.rate);a("lifetime",50);a("emitterExtents",new pc.Vec3(0,0,0));a("emitterRadius",
        0);a("emitterShape",pc.EMITTERSHAPE_BOX);a("initialVelocity",1);a("wrap",!1);a("localSpace",!1);a("wrapBounds",null);a("colorMap",T.DEFAULT_PARAM_TEXTURE);a("normalMap",null);a("loop",!0);a("preWarm",!1);a("sort",pc.PARTICLESORT_NONE);a("mode",pc.PARTICLEMODE_GPU);a("scene",null);a("lighting",!1);a("halfLambert",!1);a("intensity",1);a("stretch",0);a("alignToMotion",!1);a("depthSoftening",0);a("mesh",null);a("depthWrite",!1);a("noFog",!1);a("blendType",pc.BLEND_NORMAL);a("node",null);a("startAngle",
        0);a("startAngle2",this.startAngle);a("animTilesX",1);a("animTilesY",1);a("animNumFrames",1);a("animSpeed",1);a("animLoop",!0);this.frameRandom=new pc.Vec3(0,0,0);a("colorGraph",h);a("colorGraph2",this.colorGraph);a("scaleGraph",m);a("scaleGraph2",this.scaleGraph);a("alphaGraph",m);a("alphaGraph2",this.alphaGraph);a("localVelocityGraph",n);a("localVelocityGraph2",this.localVelocityGraph);a("velocityGraph",n);a("velocityGraph2",this.velocityGraph);a("rotationSpeedGraph",l);a("rotationSpeedGraph2",
        this.rotationSpeedGraph);this.constantParticleTexIN=b.scope.resolve("particleTexIN");this.constantParticleTexOUT=b.scope.resolve("particleTexOUT");this.constantEmitterPos=b.scope.resolve("emitterPos");this.constantEmitterScale=b.scope.resolve("emitterScale");this.constantSpawnBounds=b.scope.resolve("spawnBounds");this.constantSpawnBoundsSphere=b.scope.resolve("spawnBoundsSphere");this.constantInitialVelocity=b.scope.resolve("initialVelocity");this.constantFrameRandom=b.scope.resolve("frameRandom");
        this.constantDelta=b.scope.resolve("delta");this.constantRate=b.scope.resolve("rate");this.constantRateDiv=b.scope.resolve("rateDiv");this.constantLifetime=b.scope.resolve("lifetime");this.constantLightCube=b.scope.resolve("lightCube[0]");this.constantGraphSampleSize=b.scope.resolve("graphSampleSize");this.constantGraphNumSamples=b.scope.resolve("graphNumSamples");this.constantInternalTex0=b.scope.resolve("internalTex0");this.constantInternalTex1=b.scope.resolve("internalTex1");this.constantInternalTex2=
            b.scope.resolve("internalTex2");this.constantEmitterMatrix=b.scope.resolve("emitterMatrix");this.constantNumParticles=b.scope.resolve("numParticles");this.constantNumParticlesPot=b.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=b.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=b.scope.resolve("velocityDivMult");this.constantRotSpeedDivMult=b.scope.resolve("rotSpeedDivMult");this.constantSeed=b.scope.resolve("seed");this.constantStartAngle=b.scope.resolve("startAngle");
        this.constantStartAngle2=b.scope.resolve("startAngle2");this.constantOutBoundsMul=b.scope.resolve("outBoundsMul");this.constantOutBoundsAdd=b.scope.resolve("outBoundsAdd");this.constantInBoundsSize=b.scope.resolve("inBoundsSize");this.constantInBoundsCenter=b.scope.resolve("inBoundsCenter");this.constantMaxVel=b.scope.resolve("maxVel");this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=
            new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=new pc.Vec3(0,0,1);this.animParams=new pc.Vec4;this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.pack8=!0;this.localBounds=new pc.BoundingBox;this.worldBoundsNoTrail=new pc.BoundingBox;this.worldBoundsTrail=[new pc.BoundingBox,new pc.BoundingBox];
        this.worldBounds=new pc.BoundingBox;this.worldBoundsSize=new pc.Vec3;this.prevWorldBoundsSize=new pc.Vec3;this.prevWorldBoundsCenter=new pc.Vec3;this.worldBoundsMul=new pc.Vec3;this.worldBoundsAdd=new pc.Vec3;this.timeToSwitchBounds=0;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=0;this.fixedTimeStep=1/60;this.maxSubSteps=10;this.simTimeTotal=this.simTime=
            0;this.beenReset=!1;this._layer=null;this.rebuild()};T.prototype={onChangeCamera:function(){this.regenShader();this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x;this.worldBoundsMul.y=1/this.worldBoundsSize.y;this.worldBoundsMul.z=1/this.worldBoundsSize.z;this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1);this.worldBoundsAdd.x+=.5;this.worldBoundsAdd.y+=.5;this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize);
        this.prevWorldBoundsCenter.copy(this.worldBounds.center);this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.node.getWorldTransform());this.worldBoundsTrail[0].add(this.worldBoundsNoTrail);var a=this.simTimeTotal;if(a>this.timeToSwitchBounds){var b=this.worldBoundsTrail[0];this.worldBoundsTrail[0]=this.worldBoundsTrail[1];this.worldBoundsTrail[1]=b;this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail);this.timeToSwitchBounds=a+this.lifetime}this.worldBounds.copy(this.worldBoundsTrail[0]);
        this.worldBounds.add(this.worldBoundsTrail[1]);this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2);this.meshInstance.mesh.aabb=this.worldBounds;this.meshInstance._aabbVer=1-this.meshInstance._aabbVer;this.pack8&&this.calculateBoundsMad()}},calculateLocalBounds:function(){var a=Number.MAX_VALUE,b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=-Number.MAX_VALUE,f=-Number.MAX_VALUE,g=-Number.MAX_VALUE,e=0,k=this.lifetime/this.precision,h=[this.qVelocity,this.qVelocity2,this.qLocalVelocity,this.qLocalVelocity2],
        m=[0,0,0,0],l=[0,0,0,0],n=[0,0,0,0],p,q,r,t,x,C;for(p=0;p<this.precision+1;p++){r=Math.min(p,this.precision-1);for(q=0;4>q;q++)t=h[q][3*r]*k+m[q],x=h[q][3*r+1]*k+l[q],C=h[q][3*r+2]*k+n[q],a>t&&(a=t),b>x&&(b=x),c>C&&(c=C),d<t&&(d=t),f<x&&(f=x),g<C&&(g=C),m[q]=t,l[q]=x,n[q]=C;e=Math.max(e,this.qScale[r])}this.emitterShape===pc.EMITTERSHAPE_BOX?(t=.5*this.emitterExtents.x,x=.5*this.emitterExtents.y,C=.5*this.emitterExtents.z):C=x=t=this.emitterRadius;d<t&&(d=t);f<x&&(f=x);g<C&&(g=C);t=-t;x=-x;C=-C;a>
    t&&(a=t);b>x&&(b=x);c>C&&(c=C);H.x=a-e;H.y=b-e;H.z=c-e;W.x=d+e;W.y=f+e;W.z=g+e;this.localBounds.setMinMax(H,W)},rebuild:function(){var a,b=this.graphicsDevice;null===this.colorMap&&(this.colorMap=T.DEFAULT_PARAM_TEXTURE);this.spawnBounds=this.emitterShape===pc.EMITTERSHAPE_BOX?this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu||this.sort>pc.PARTICLESORT_NONE||1>=b.maxVertexTextures||64>b.fragmentUniformsCount||b.forceCpuParticles||!b.extTextureFloat;this.vertexBuffer=void 0;this.pack8=
        (this.pack8||!b.extTextureFloatRenderable)&&!this.useCpu;r=this.useCpu||this.pack8?4:2;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.calculateLocalBounds();this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,
        this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad());this.vbToSort=Array(this.numParticles);this.particleDistance=new Float32Array(this.numParticles);this.frameRandom.x=Math.random();this.frameRandom.y=Math.random();
        this.frameRandom.z=Math.random();this.particleTex=new Float32Array(this.numParticlesPot*r*4);var c=null===this.node||this.localSpace?pc.Vec3.ZERO:this.node.getPosition();this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.node?G.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):G.setTRS(pc.Vec3.ZERO,this.node.getRotation(),E.copy(this.spawnBounds).mul(this.node.localScale)));for(a=0;a<this.numParticles;a++)this.calcSpawnPosition(c,a),this.useCpu&&(this.particleTex[4*a+3+8*this.numParticlesPot]=
            1);this.particleTexStart=new Float32Array(this.numParticlesPot*r*4);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.pack8?(this.particleTexIN=k(b,this.numParticlesPot,r,this.particleTex,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexOUT=k(b,this.numParticlesPot,r,this.particleTex,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1),this.particleTexStart=k(b,this.numParticlesPot,r,this.particleTexStart,pc.PIXELFORMAT_R8_G8_B8_A8,1,!1)):(this.particleTexIN=k(b,
            this.numParticlesPot,r,this.particleTex),this.particleTexOUT=k(b,this.numParticlesPot,r,this.particleTex),this.particleTexStart=k(b,this.numParticlesPot,r,this.particleTexStart)),this.rtParticleTexIN=new pc.RenderTarget(b,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;var c=a.particleUpdaterInitPS+(this.pack8?a.particleInputRgba8PS+a.particleOutputRgba8PS:a.particleInputFloatPS+a.particleOutputFloatPS)+
            (this.emitterShape===pc.EMITTERSHAPE_BOX?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS,d=c+a.particleUpdaterNoRespawnPS+a.particleUpdaterEndPS,f=c+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c+a.particleUpdaterRespawnPS+a.particleUpdaterEndPS,"fsQuad0"+this.emitterShape+""+this.pack8);this.shaderParticleUpdateNoRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,d,"fsQuad1"+this.emitterShape+
            ""+this.pack8);this.shaderParticleUpdateOnStop=a.createShaderFromCode(b,a.fullscreenQuadVS,f,"fsQuad2"+this.emitterShape+""+this.pack8);this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new pc.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*
            this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new pc.Material;this.material.cullMode=pc.CULLFACE_NONE;this.material.alphaWrite=!1;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();this.meshInstance=new pc.MeshInstance(this.node,b,this.material);this.meshInstance.pick=!1;this.meshInstance.updateKey();this.meshInstance.cull=!0;this.meshInstance._noDepthDrawGl1=!0;
        this.meshInstance.aabb=this.worldBounds;this.meshInstance._updateAabb=!1;this._initializeTextures();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime);this.resetTime()},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==T.DEFAULT_PARAM_TEXTURE||this.normalMap)},calcSpawnPosition:function(a,b){var c=Math.random(),d=Math.random(),f=Math.random(),g=Math.random();this.useCpu&&(this.particleTex[4*b+0+8*this.numParticlesPot]=
        c,this.particleTex[4*b+1+8*this.numParticlesPot]=d,this.particleTex[4*b+2+8*this.numParticlesPot]=f);I.data[0]=c-.5;I.data[1]=d-.5;I.data[2]=f-.5;this.emitterShape===pc.EMITTERSHAPE_BOX?C.copy(a).add(G.transformPoint(I)):(I.normalize(),C.copy(a).add(I.scale(g*this.spawnBounds)));if(this.pack8){var e=(C.data[0]-this.worldBounds.center.data[0])/this.worldBoundsSize.data[0]+.5,g=(C.data[1]-this.worldBounds.center.data[1])/this.worldBoundsSize.data[1]+.5,f=(C.data[2]-this.worldBounds.center.data[2])/
        this.worldBoundsSize.data[2]+.5,d=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,c),d=d%(2*Math.PI)/(2*Math.PI),e=encodeFloatRG(e);this.particleTex[4*b]=e[0];this.particleTex[4*b+1]=e[1];g=encodeFloatRG(g);this.particleTex[4*b+2]=g[0];this.particleTex[4*b+3]=g[1];f=encodeFloatRG(f);this.particleTex[4*b+0+4*this.numParticlesPot]=f[0];this.particleTex[4*b+1+4*this.numParticlesPot]=f[1];d=encodeFloatRG(d);this.particleTex[4*b+2+4*this.numParticlesPot]=d[0];this.particleTex[4*
    b+3+4*this.numParticlesPot]=d[1];this.particleTex[4*b+3+8*this.numParticlesPot]=1;c=pc.math.lerp(this.rate,this.rate2,c);d=Math.max(this.lifetime,(this.numParticles-1)*Math.max(this.rate,this.rate2));c=(-c*b+d)/(d+(this.lifetime+1));c=encodeFloatRGBA(c);this.particleTex[4*b+0+12*this.numParticlesPot]=c[0];this.particleTex[4*b+1+12*this.numParticlesPot]=c[1];this.particleTex[4*b+2+12*this.numParticlesPot]=c[2];this.particleTex[4*b+3+12*this.numParticlesPot]=c[3]}else this.particleTex[4*b]=C.data[0],
        this.particleTex[4*b+1]=C.data[1],this.particleTex[4*b+2]=C.data[2],this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,c),c=pc.math.lerp(this.rate,this.rate2,c),this.particleTex[4*b+3+4*this.numParticlesPot]=-c*b},rebuildGraphs:function(){var a=this.precision,f=this.graphicsDevice,g;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);
        this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(g=0;g<a;g++)this.qRotSpeed[g]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[g]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new pc.Vec3(0,0,0);this.velocityUMax=
            new pc.Vec3(0,0,0);this.colorUMax=new pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=d(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=d(this.qVelocity,this.qVelocity2,this.velocityUMax.data);this.qColorDiv=d(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=d(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=d(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=d(this.qAlpha,
            this.qAlpha2,this.alphaUMax);if(this.pack8){var e=[0,0,0];c(this.qVelocity,e);var h=[0,0,0];c(this.qVelocity2,h);g=[0,0,0];c(this.qLocalVelocity,g);var m=[0,0,0];c(this.qLocalVelocity2,m);var l=Math.max(e[0],h[0]),l=Math.max(l,e[1]),l=Math.max(l,h[1]),l=Math.max(l,e[2]),l=Math.max(l,h[2]),e=Math.max(g[0],m[0]),e=Math.max(e,g[1]),e=Math.max(e,m[1]),e=Math.max(e,g[2]),e=Math.max(e,m[2]);this.maxVel=l+e}if(!this.useCpu){this.internalTex0=k(f,a,1,b(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=
            k(f,a,1,b(this.qVelocity,this.qVelocityDiv));g=this.qRotSpeed;for(var m=this.qScale,l=this.qScaleDiv,e=this.qRotSpeedDiv,h=this.qAlphaDiv,n=Array(4*g.length),p=0;p<g.length;p++)n[4*p]=g[p],n[4*p+1]=m[p],n[4*p+2]=0,n[4*p+3]=(255*l[p]<<16|255*e[p]<<8|255*h[p])/16777216;this.internalTex2=k(f,a,1,n)}g=this.qColor;m=this.qAlpha;l=Array(4*m.length);for(e=0;e<m.length;e++)l[4*e]=g[3*e],l[4*e+1]=g[3*e+1],l[4*e+2]=g[3*e+2],l[4*e+3]=m[e];this.internalTex3=k(f,a,1,l,pc.PIXELFORMAT_R8_G8_B8_A8,1,!0)},_initializeTextures:function(){this.colorMap&&
    (this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!==this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera());var b=a.getProgram("particle",
        {useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,
            blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8});this.setShader(b)};this.material.updateShader()},resetMaterial:function(){var a=this.material;a.setParameter("stretch",this.stretch);this._isAnimated()&&a.setParameter("animTexParams",this.animParams.data);a.setParameter("colorMult",this.intensity);this.useCpu||(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",
        this.internalTex2));a.setParameter("internalTex3",this.internalTex3);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",
        1/this.precision);a.setParameter("emitterScale",pc.Vec3.ONE.data);this.pack8&&(a.setParameter("inBoundsSize",this.worldBoundsSize.data),a.setParameter("inBoundsCenter",this.worldBounds.center.data),a.setParameter("maxVel",this.maxVel));this.wrap&&this.wrapBounds&&a.setParameter("wrapBounds",this.wrapBounds.data);this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&a.setParameter("softening",1/(this.depthSoftening*
        this.depthSoftening*100));0<this.stretch&&(a.cull=pc.CULLFACE_NONE)},_allocate:function(a){var b=a*this.numParticleVerts,c=a*this.numParticleIndices,d;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){d=this.useCpu?[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:2,type:pc.TYPE_FLOAT32}]:[{semantic:pc.SEMANTIC_ATTR0,
        components:4,type:pc.TYPE_FLOAT32}];d=new pc.VertexFormat(this.graphicsDevice,d);this.vertexBuffer=new pc.VertexBuffer(this.graphicsDevice,d,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,c);d=new Float32Array(this.vertexBuffer.lock());var f,e;this.useMesh&&(f=new Float32Array(this.mesh.vertexBuffer.lock()),e=f.length/this.mesh.vertexBuffer.numVertices);for(var k,c=0;c<b;c++){k=Math.floor(c/this.numParticleVerts);if(this.useMesh){var h=c%this.numParticleVerts;
        d[4*c]=f[h*e];d[4*c+1]=f[h*e+1];d[4*c+2]=f[h*e+2]}else h=c%4,d[4*c]=g[h][0],d[4*c+1]=g[h][1],d[4*c+2]=0;d[4*c+3]=k}this.useCpu&&(this.vbCPU=new Float32Array(d),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;e=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(f=new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(d=0;d<this.numParticleIndices;d++)e[c*this.numParticleIndices+d]=f[d]+
        c*this.numParticleVerts;else d=4*c,e[b++]=d,e[b++]=d+1,e[b++]=d+2,e[b++]=d,e[b++]=d+2,e[b++]=d+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.beenReset=!0;this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=this.particleTexStart[a];else this._initializeTextures();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},
        prewarm:function(a){var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision);a/=b;for(var c=0;c<b;c++)this.addTime(a)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(a,b){var c,d,g,k,h;k=this.graphicsDevice;this.simTimeTotal+=a;this.calculateWorldBounds();this._isAnimated()&&(h=this.animParams,h.x=1/this.animTilesX,h.y=1/this.animTilesY,
            h.z=this.animNumFrames*this.animSpeed,h.w=this.animNumFrames-1);this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.meshInstance.node?G.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.emitterExtents):G.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),E.copy(this.emitterExtents).mul(this.meshInstance.node.localScale)));var m=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.localScale.data;
            this.material.setParameter("emitterScale",m);this.localSpace&&this.meshInstance.node&&this.material.setParameter("emitterPos",this.meshInstance.node.getPosition().data);if(this.useCpu){m=new Float32Array(this.vertexBuffer.lock());if(this.meshInstance.node){k=this.meshInstance.node.worldTransform;for(h=0;12>h;h++)A.data[h]=k.data[h];J=this.meshInstance.node.localScale;F=Math.max(Math.max(J.x,J.y),J.z)}h=null===this.meshInstance.node||this.localSpace?pc.Vec3.ZERO:this.meshInstance.node.getPosition();
                var l=this.camera?this.camera._node.getPosition():pc.Vec3.ZERO,n,r,C,H,W,R,Z,T=this.precision-1;for(k=0;k<this.numParticles;k++){var Q=Math.floor(this.vbCPU[k*this.numParticleVerts*4+3]),ha=this.particleTex[4*Q+0+8*this.numParticlesPot];y.data[0]=ha;y.data[1]=this.particleTex[4*Q+1+8*this.numParticlesPot];y.data[2]=this.particleTex[4*Q+2+8*this.numParticlesPot];var ia=this.rate+(this.rate2-this.rate)*ha,ja=this.lifetime,Y=this.particleTex[4*Q+3+4*this.numParticlesPot]+a,ma=Math.max(Math.min(Y/ja,
                    1),0),ka=0;c=0;var la=0<Y&&Y<ja;la?(g=ma*T,n=Math.floor(g),r=Math.ceil(g),g%=1,c=this.qRotSpeed[n],d=this.qRotSpeed[r],C=c+(d-c)*g,c=this.qRotSpeed2[n],d=this.qRotSpeed2[r],H=c+(d-c)*g,c=this.qScale[n],d=this.qScale[r],ka=c+(d-c)*g,c=this.qScale2[n],d=this.qScale2[r],W=c+(d-c)*g,c=this.qAlpha[n],d=this.qAlpha[r],R=c+(d-c)*g,c=this.qAlpha2[n],d=this.qAlpha2[r],Z=c+(d-c)*g,n*=3,r*=3,c=this.qLocalVelocity[n],d=this.qLocalVelocity[r],q.data[0]=c+(d-c)*g,c=this.qLocalVelocity[n+1],d=this.qLocalVelocity[r+
                    1],q.data[1]=c+(d-c)*g,c=this.qLocalVelocity[n+2],d=this.qLocalVelocity[r+2],q.data[2]=c+(d-c)*g,c=this.qLocalVelocity2[n],d=this.qLocalVelocity2[r],x.data[0]=c+(d-c)*g,c=this.qLocalVelocity2[n+1],d=this.qLocalVelocity2[r+1],x.data[1]=c+(d-c)*g,c=this.qLocalVelocity2[n+2],d=this.qLocalVelocity2[r+2],x.data[2]=c+(d-c)*g,c=this.qVelocity[n],d=this.qVelocity[r],p.data[0]=c+(d-c)*g,c=this.qVelocity[n+1],d=this.qVelocity[r+1],p.data[1]=c+(d-c)*g,c=this.qVelocity[n+2],d=this.qVelocity[r+2],p.data[2]=c+
                    (d-c)*g,c=this.qVelocity2[n],d=this.qVelocity2[r],t.data[0]=c+(d-c)*g,c=this.qVelocity2[n+1],d=this.qVelocity2[r+1],t.data[1]=c+(d-c)*g,c=this.qVelocity2[n+2],d=this.qVelocity2[r+2],t.data[2]=c+(d-c)*g,q.data[0]+=(x.data[0]-q.data[0])*y.data[0],q.data[1]+=(x.data[1]-q.data[1])*y.data[1],q.data[2]+=(x.data[2]-q.data[2])*y.data[2],0<this.initialVelocity&&(this.emitterShape===pc.EMITTERSHAPE_SPHERE?(I.copy(y).scale(2).sub(pc.Vec3.ONE).normalize(),q.add(I.scale(this.initialVelocity))):q.add(pc.Vec3.FORWARD.scale(this.initialVelocity))),
                        p.data[0]+=(t.data[0]-p.data[0])*y.data[0],p.data[1]+=(t.data[1]-p.data[1])*y.data[1],p.data[2]+=(t.data[2]-p.data[2])*y.data[2],C+=(H-C)*y.data[1],ka=(ka+1E4*ha%1*(W-ka))*F,c=1E3*ha%1*(Z-R),this.meshInstance.node&&A.transformPoint(q,q),q.add(p.mul(J)),z.copy(q),w.data[0]=this.particleTex[4*Q],w.data[1]=this.particleTex[4*Q+1],w.data[2]=this.particleTex[4*Q+2],u.copy(w).add(q.scale(a)),v.copy(u),this.particleTex[4*Q]=v.data[0],this.particleTex[4*Q+1]=v.data[1],this.particleTex[4*Q+2]=v.data[2],this.particleTex[4*
                    Q+3]+=C*a,this.wrap&&this.wrapBounds&&(v.sub(h),v.data[0]=e(v.data[0],this.wrapBounds.data[0])-.5*this.wrapBounds.data[0],v.data[1]=e(v.data[1],this.wrapBounds.data[1])-.5*this.wrapBounds.data[1],v.data[2]=e(v.data[2],this.wrapBounds.data[2])-.5*this.wrapBounds.data[2],v.add(h)),0<this.sort&&(1===this.sort?(E.copy(v).sub(l),this.particleDistance[Q]=-(E.data[0]*E.data[0]+E.data[1]*E.data[1]+E.data[2]*E.data[2])):2===this.sort?this.particleDistance[Q]=Y:3===this.sort&&(this.particleDistance[Q]=-Y))):
                    this.calcSpawnPosition(h,Q);b?0>Y&&(this.particleTex[4*Q+3+8*this.numParticlesPot]=-1):(Y>=ja&&(Y-=Math.max(ja,(this.numParticles-1)*ia),this.particleTex[4*Q+3+8*this.numParticlesPot]=this.loop?1:-1),0>Y&&this.loop&&(this.particleTex[4*Q+3+8*this.numParticlesPot]=1));0>this.particleTex[4*Q+3+8*this.numParticlesPot]&&(la=!1);this.particleTex[4*Q+3+4*this.numParticlesPot]=Y;for(C=0;C<this.numParticleVerts;C++)ha=this.vbCPU[k*this.numParticleVerts*4+4*C],ia=this.vbCPU[k*this.numParticleVerts*4+4*C+1],
                    ja=this.vbCPU[k*this.numParticleVerts*4+4*C+2],la||(ha=ia=ja=0),Y=k*this.numParticleVerts*14+14*C,m[Y]=v.data[0],m[Y+1]=v.data[1],m[Y+2]=v.data[2],m[Y+3]=ma,m[Y+4]=this.alignToMotion?0:this.particleTex[4*Q+3],m[Y+5]=ka,m[Y+6]=c,m[Y+7]=z.data[0],m[Y+8]=ha,m[Y+9]=ia,m[Y+10]=ja,m[Y+11]=z.data[1],m[Y+12]=z.data[2]}if(this.sort>pc.PARTICLESORT_NONE&&this.camera){h=this.particleDistance;for(k=0;k<this.numParticles;k++)this.vbToSort[k]=[k,h[Math.floor(this.vbCPU[k*this.numParticleVerts*4+3])]];this.vbOld.set(this.vbCPU);
                    this.vbToSort.sort(function(a,b){return a[1]-b[1]});for(k=0;k<this.numParticles;k++)for(m=this.vbToSort[k][0]*this.numParticleVerts*4,l=k*this.numParticleVerts*4,h=0;h<4*this.numParticleVerts;h++)this.vbCPU[l+h]=this.vbOld[m+h]}}else k.setBlending(!1),k.setColorWrite(!0,!0,!0,!0),k.setCullMode(pc.CULLFACE_NONE),k.setDepthTest(!1),k.setDepthWrite(!1),this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),
                this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),this.constantInternalTex2.setValue(this.internalTex2),this.pack8&&(this.constantOutBoundsMul.setValue(this.worldBoundsMul.data),this.constantOutBoundsAdd.setValue(this.worldBoundsAdd.data),this.constantInBoundsSize.setValue(this.prevWorldBoundsSize.data),
                this.constantInBoundsCenter.setValue(this.prevWorldBoundsCenter.data),h=this.maxVel*Math.max(Math.max(m[0],m[1]),m[2]),h=Math.max(h,1),this.constantMaxVel.setValue(h)),h=null===this.meshInstance.node||this.localSpace?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,l=null===this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),this.emitterShape===pc.EMITTERSHAPE_BOX?(f(G,D),this.constantSpawnBounds.setValue(D.data)):this.constantSpawnBoundsSphere.setValue(this.emitterRadius),
                this.constantInitialVelocity.setValue(this.initialVelocity),f(l,B),this.constantEmitterPos.setValue(h),this.constantFrameRandom.setValue(this.frameRandom.data),this.constantDelta.setValue(a),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),this.constantLifetime.setValue(this.lifetime),
                this.constantEmitterScale.setValue(m),this.constantEmitterMatrix.setValue(B.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),h=this.swapTex?this.particleTexOUT:this.particleTexIN,h=this.beenReset?this.particleTexStart:h,m=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(h),b?pc.drawQuadWithShader(k,this.swapTex?
                this.rtParticleTexIN:this.rtParticleTexOUT,this.shaderParticleUpdateOnStop):pc.drawQuadWithShader(k,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.loop?this.shaderParticleUpdateRespawn:this.shaderParticleUpdateNoRespawn),this.constantParticleTexOUT.setValue(m),this.material.setParameter("particleTexOUT",h),this.material.setParameter("particleTexIN",m),this.beenReset=!1,this.swapTex=!this.swapTex,k.setDepthTest(!0),k.setDepthWrite(!0);if(!this.loop&&Date.now()>this.endTime){if(this.onFinished)this.onFinished();
                this.meshInstance.visible=!1}},destroy:function(){this.particleTexIN&&this.particleTexIN.destroy();this.particleTexOUT&&this.particleTexOUT.destroy();!this.useCpu&&this.particleTexStart&&this.particleTexStart.destroy();this.rtParticleTexIN&&this.rtParticleTexIN.destroy();this.rtParticleTexOUT&&this.rtParticleTexOUT.destroy();this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=this.rtParticleTexOUT=this.rtParticleTexIN=this.particleTexStart=this.particleTexOUT=
            this.particleTexIN=null}};return{ParticleEmitter:T}}());function frac(e){return e-Math.floor(e)}function encodeFloatRGBA(e){var a=frac(e),b=frac(255*e),c=frac(65025*e);e=frac(160581375*e);a-=b/255;b-=c/255;c-=e/255;return[a,b,c,e-e/255]}function encodeFloatRG(e){var a=frac(e);e=frac(255*e);a-=e/255;return[a,e-e/255]};pc.extend(pc,function(){var e=!1,a=function(a,c,d){a instanceof pc.GraphicsDevice&&(a=pc.Application.getApplication(),e||(e=!0));this.app=a;var f=this.device=a.graphicsDevice;this.library=f.getProgramLibrary();this.pickColor=new Float32Array(4);this.pickColor[3]=1;this.scene=null;this.drawCalls=[];this.layerComp=this.layer=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};var g=this;this._clearDepthOptions={depth:1,flags:pc.CLEARFLAG_DEPTH};this.clearDepthCommand=
        new pc.Command(0,0,function(){f.clear(g._clearDepthOptions)});this.resize(c,d);this._ignoreOpacityFor=null};a.prototype.getSelection=function(a,c,d,f){var g=this.device;"object"===typeof a?(f=a,a=f.x,c=f.y,d=f.width,f=f.height):c=this.layer.renderTarget.height-(c+(f||1));d=d||1;f=f||1;var e=g.renderTarget;g.setRenderTarget(this.layer.renderTarget);g.updateBegin();var l=new Uint8Array(4*d*f);g.readPixels(a,c,d,f,l);g.updateEnd();g.setRenderTarget(e);a=[];c=this.layer.instances.visibleOpaque[0].list;
        for(var m,n,g=0;g<d*f;g++)e=l[4*g+0],m=l[4*g+1],n=l[4*g+2],e=e<<16|m<<8|n,16777215!==e&&(e=c[e],-1===a.indexOf(e)&&a.push(e));return a};a.prototype.prepare=function(a,c,d){var f=this.device,g,e=this;a instanceof pc.Camera&&(a=a._component);this.scene=c;var l=null,m=null;d instanceof pc.Layer?l=d:m=d;if(!this.layer){var n=f.scope.resolve("uColor");this.layer=new pc.Layer({name:"Picker",shaderPass:pc.SHADER_PICK,opaqueSortMode:pc.SORTMODE_NONE,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(f,
        {format:pc.PIXELFORMAT_R8_G8_B8_A8,width:e.width,height:e.height});a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.renderTarget=new pc.RenderTarget(f,a,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(a,b){e.pickColor[0]=(b>>16&255)/255;e.pickColor[1]=(b>>8&255)/255;e.pickColor[2]=(b&255)/255;
        n.setValue(e.pickColor);f.setBlending(!1)},onPreCull:function(){this.oldAspectMode=this.cameras[0].aspectRatioMode;this.oldAspect=this.cameras[0].aspectRatio;this.cameras[0].aspectRatioMode=pc.ASPECT_MANUAL;this.cameras[0].aspectRatio=this.cameras[0].calculateAspectRatio(m?m:l?l.renderTarget:null);e.app.renderer.updateCameraFrustum(this.cameras[0].camera)},onPostCull:function(){this.cameras[0].aspectRatioMode=this.oldAspectMode;this.cameras[0].aspectRatio=this.oldAspect}});this.layerComp=new pc.LayerComposition;
        this.layerComp.pushOpaque(this.layer);this.meshInstances=this.layer.opaqueMeshInstances;this._instancesVersion=-1}var h,r,p;if(!l){this.layer.clearMeshInstances();d=c.layers.layerList;var q=c.layers.subLayerEnabled,t=c.layers.subLayerList;for(c=0;c<d.length;c++)d[c].overrideClear&&d[c]._clearDepthBuffer&&(d[c]._pickerCleared=!1);for(c=0;c<d.length;c++)if(g=d[c],g.renderTarget===m&&g.enabled&&q[c]&&(h=g.cameras.indexOf(a),!(0>h)))for(g.overrideClear&&g._clearDepthBuffer&&!g._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),
        g._pickerCleared=!0),h=(h=t[c])?g.instances.transparentMeshInstances:g.instances.opaqueMeshInstances,r=h.length,g=0;g<r;g++)p=h[g],p.pick&&this.meshInstances.push(p)}else if(this._instancesVersion!==l._version){this.layer.clearMeshInstances();h=l.instances.opaqueMeshInstances;r=h.length;for(g=0;g<r;g++)p=h[g],p.pick&&this.meshInstances.push(p);h=l.instances.transparentMeshInstances;r=h.length;for(g=0;g<r;g++)p=h[g],p.pick&&this.meshInstances.push(p);this._instancesVersion=l._version}this.layer.cameras[0]!==
    a&&(this.layer.clearCameras(),this.layer.addCamera(a));this.onLayerPreRender(this.layer,l,m);this.app.renderer.renderComposition(this.layerComp);this.onLayerPostRender(this.layer)};a.prototype.onLayerPreRender=function(a,c,d){if(this.width!==a.renderTarget.width||this.height!==a.renderTarget.height)a.onDisable(),a.onEnable();a.oldClear=a.cameras[0].camera._clearOptions;a.oldAspectMode=a.cameras[0].aspectRatioMode;a.oldAspect=a.cameras[0].aspectRatio;a.cameras[0].camera._clearOptions=this.clearOptions;
        a.cameras[0].aspectRatioMode=pc.ASPECT_MANUAL;a.cameras[0].aspectRatio=a.cameras[0].calculateAspectRatio(d?d:c?c.renderTarget:null)};a.prototype.onLayerPostRender=function(a){a.cameras[0].camera._clearOptions=a.oldClear;a.cameras[0].aspectRatioMode=a.oldAspectMode;a.cameras[0].aspectRatio=a.oldAspect};a.prototype.resize=function(a,c){this.width=a;this.height=c};Object.defineProperty(a.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}});return{Picker:a}}());var primitiveUv1Padding=.0625,primitiveUv1PaddingScale=1-2*primitiveUv1Padding;
    pc.calculateNormals=function(e,a){var b=a.length/3,c=e.length/3,d,f,g,k,l=new pc.Vec3,m=new pc.Vec3,n=new pc.Vec3,h=new pc.Vec3,r=new pc.Vec3,p=new pc.Vec3,q=[];for(k=0;k<e.length;k++)q[k]=0;for(k=0;k<b;k++)d=a[3*k],f=a[3*k+1],g=a[3*k+2],l.set(e[3*d],e[3*d+1],e[3*d+2]),m.set(e[3*f],e[3*f+1],e[3*f+2]),n.set(e[3*g],e[3*g+1],e[3*g+2]),h.sub2(m,l),r.sub2(n,l),p.cross(h,r).normalize(),q[3*d]+=p.x,q[3*d+1]+=p.y,q[3*d+2]+=p.z,q[3*f]+=p.x,q[3*f+1]+=p.y,q[3*f+2]+=p.z,q[3*g]+=p.x,q[3*g+1]+=p.y,q[3*g+2]+=p.z;
        for(k=0;k<c;k++)b=q[3*k],d=q[3*k+1],f=q[3*k+2],b=1/Math.sqrt(b*b+d*d+f*f),q[3*k]*=b,q[3*k+1]*=b,q[3*k+2]*=b;return q};
    pc.calculateTangents=function(e,a,b,c){var d=c.length/3,f=e.length/3,g,k,l,m,n,h,r,p,q,t,x,y,w,u,v=new pc.Vec3,z=new pc.Vec3,A=new pc.Vec3,D=new pc.Vec3,B=new pc.Vec3,F=new pc.Vec2,J=new pc.Vec2,G=new pc.Vec2,I,C=new Float32Array(3*f),E=new Float32Array(3*f),H=[];for(I=u=0;I<d;I++)g=c[3*I],k=c[3*I+1],l=c[3*I+2],A.set(e[3*g],e[3*g+1],e[3*g+2]),D.set(e[3*k],e[3*k+1],e[3*k+2]),B.set(e[3*l],e[3*l+1],e[3*l+2]),F.set(b[2*g],b[2*g+1]),J.set(b[2*k],b[2*k+1]),G.set(b[2*l],b[2*l+1]),m=D.x-A.x,n=B.x-A.x,h=D.y-
        A.y,r=B.y-A.y,p=D.z-A.z,q=B.z-A.z,t=J.x-F.x,x=G.x-F.x,y=J.y-F.y,w=G.y-F.y,u=t*w-x*y,0==u?(v.set(0,1,0),z.set(1,0,0)):(u=1/u,v.set((w*m-y*n)*u,(w*h-y*r)*u,(w*p-y*q)*u),z.set((t*n-x*m)*u,(t*r-x*h)*u,(t*q-x*p)*u)),C[3*g+0]+=v.x,C[3*g+1]+=v.y,C[3*g+2]+=v.z,C[3*k+0]+=v.x,C[3*k+1]+=v.y,C[3*k+2]+=v.z,C[3*l+0]+=v.x,C[3*l+1]+=v.y,C[3*l+2]+=v.z,E[3*g+0]+=z.x,E[3*g+1]+=z.y,E[3*g+2]+=z.z,E[3*k+0]+=z.x,E[3*k+1]+=z.y,E[3*k+2]+=z.z,E[3*l+0]+=z.x,E[3*l+1]+=z.y,E[3*l+2]+=z.z;y=new pc.Vec3;w=new pc.Vec3;e=new pc.Vec3;
        b=new pc.Vec3;for(I=0;I<f;I++)e.set(a[3*I],a[3*I+1],a[3*I+2]),y.set(C[3*I],C[3*I+1],C[3*I+2]),w.set(E[3*I],E[3*I+1],E[3*I+2]),c=e.dot(y),b.copy(e).scale(c),b.sub2(y,b).normalize(),H[4*I]=b.x,H[4*I+1]=b.y,H[4*I+2]=b.z,b.cross(e,y),H[4*I+3]=0>b.dot(w)?-1:1;return H};
    pc.createMesh=function(e,a,b){var c=b&&void 0!==b.normals?b.normals:null,d=b&&void 0!==b.tangents?b.tangents:null,f=b&&void 0!==b.colors?b.colors:null,g=b&&void 0!==b.uvs?b.uvs:null,k=b&&void 0!==b.uvs1?b.uvs1:null,l=b&&void 0!==b.indices?b.indices:null,m=b&&void 0!==b.blendIndices?b.blendIndices:null,n=b&&void 0!==b.blendWeights?b.blendWeights:null;b=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}];null!==c&&b.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.TYPE_FLOAT32});
        null!==d&&b.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.TYPE_FLOAT32});null!==f&&b.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0});null!==g&&b.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.TYPE_FLOAT32});null!==k&&b.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.TYPE_FLOAT32});null!==m&&b.push({semantic:pc.SEMANTIC_BLENDINDICES,components:2,type:pc.TYPE_UINT8});null!==n&&b.push({semantic:pc.SEMANTIC_BLENDWEIGHT,components:2,type:pc.TYPE_FLOAT32});
        var h=new pc.VertexFormat(e,b);b=a.length/3;for(var h=new pc.VertexBuffer(e,h,b),r=new pc.VertexIterator(h),p=0;p<b;p++)r.element[pc.SEMANTIC_POSITION].set(a[3*p],a[3*p+1],a[3*p+2]),null!==c&&r.element[pc.SEMANTIC_NORMAL].set(c[3*p],c[3*p+1],c[3*p+2]),null!==d&&r.element[pc.SEMANTIC_TANGENT].set(d[4*p],d[4*p+1],d[4*p+2],d[4*p+3]),null!==f&&r.element[pc.SEMANTIC_COLOR].set(f[4*p],f[4*p+1],f[4*p+2],f[4*p+3]),null!==g&&r.element[pc.SEMANTIC_TEXCOORD0].set(g[2*p],g[2*p+1]),null!==k&&r.element[pc.SEMANTIC_TEXCOORD1].set(k[2*
        p],k[2*p+1]),null!==m&&r.element[pc.SEMANTIC_BLENDINDICES].set(m[2*p],m[2*p+1]),null!==n&&r.element[pc.SEMANTIC_BLENDWEIGHT].set(n[2*p],n[2*p+1]),r.next();r.end();c=null;if(d=null!==l)c=new pc.IndexBuffer(e,pc.INDEXFORMAT_UINT16,l.length),(new Uint16Array(c.lock())).set(l),c.unlock();e=new pc.BoundingBox;e.compute(a);a=new pc.Mesh;a.vertexBuffer=h;a.indexBuffer[0]=c;a.primitive[0].type=pc.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=d?l.length:b;a.primitive[0].indexed=d;a.aabb=e;
        return a};
    pc.createTorus=function(e,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:.2,c=a&&void 0!==a.ringRadius?a.ringRadius:.3,d=a&&void 0!==a.segments?a.segments:30,f=a&&void 0!==a.sides?a.sides:20,g,k,l,m,n,h,r,p,q,t,x=[],y=[],w=[],u=[];for(g=0;g<=f;g++)for(k=0;k<=d;k++)l=Math.cos(2*Math.PI*k/d)*(c+b*Math.cos(2*Math.PI*g/f)),m=Math.sin(2*Math.PI*g/f)*b,n=Math.sin(2*Math.PI*k/d)*(c+b*Math.cos(2*Math.PI*g/f)),h=Math.cos(2*Math.PI*k/d)*Math.cos(2*Math.PI*g/f),r=Math.sin(2*Math.PI*g/f),p=Math.sin(2*Math.PI*
        k/d)*Math.cos(2*Math.PI*g/f),q=g/f,t=1-k/d,x.push(l,m,n),y.push(h,r,p),w.push(q,t),g<f&&k<d&&(l=g*(d+1)+k,m=(g+1)*(d+1)+k,n=g*(d+1)+(k+1),h=(g+1)*(d+1)+(k+1),u.push(l,m,n),u.push(m,h,n));b={normals:y,uvs:w,indices:u};pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(x,y,w,u));return pc.createMesh(e,x,b)};
    pc._createConeData=function(e,a,b,c,d,f){var g,k,l,m,n,h=new pc.Vec3,r=new pc.Vec3;l=new pc.Vec3;var p,q=[],t=[],x=[],y=[],w=[],u;if(0<b)for(g=0;g<=c;g++)for(k=0;k<=d;k++)u=k/d*2*Math.PI-Math.PI,p=Math.sin(u),u=Math.cos(u),n=new pc.Vec3(p*e,-b/2,u*e),m=new pc.Vec3(p*a,b/2,u*a),h.lerp(n,m,g/c),r.sub2(m,n).normalize(),p=new pc.Vec3(u,0,-p),l.cross(p,r).normalize(),q.push(h.x,h.y,h.z),t.push(l.x,l.y,l.z),m=k/d,n=g/c,x.push(m,n),p=n,n=m,m=p,m/=3,m=m*primitiveUv1PaddingScale+primitiveUv1Padding,n=n*primitiveUv1PaddingScale+
        primitiveUv1Padding,y.push(m,n),g<c&&k<d&&(p=g*(d+1)+k,u=g*(d+1)+(k+1),m=(g+1)*(d+1)+k,n=(g+1)*(d+1)+(k+1),w.push(p,u,m),w.push(u,n,m));if(f){e=Math.floor(d/2);g=b/2;for(b=0;b<=e;b++)for(u=b*Math.PI*.5/e,p=Math.sin(u),u=Math.cos(u),h=0;h<=d;h++)f=2*h*Math.PI/d-Math.PI/2,m=Math.sin(f),f=Math.cos(f),f*=p,k=u,l=m*p,m=1-h/d,n=1-b/e,q.push(f*a,k*a+g,l*a),t.push(f,k,l),x.push(m,n),m/=3,n/=3,m=m*primitiveUv1PaddingScale+primitiveUv1Padding,n=n*primitiveUv1PaddingScale+primitiveUv1Padding,m+=1/3,y.push(m,
        n);r=(c+1)*(d+1);for(b=0;b<e;++b)for(h=0;h<d;++h)p=b*(d+1)+h,u=p+d+1,w.push(r+p+1,r+u,r+p),w.push(r+p+1,r+u+1,r+u);for(b=0;b<=e;b++)for(u=.5*Math.PI+b*Math.PI*.5/e,p=Math.sin(u),u=Math.cos(u),h=0;h<=d;h++)f=2*h*Math.PI/d-Math.PI/2,m=Math.sin(f),f=Math.cos(f),f*=p,k=u,l=m*p,m=1-h/d,n=1-b/e,q.push(f*a,k*a-g,l*a),t.push(f,k,l),x.push(m,n),m/=3,n/=3,m=m*primitiveUv1PaddingScale+primitiveUv1Padding,n=n*primitiveUv1PaddingScale+primitiveUv1Padding,m+=2/3,y.push(m,n);r=(c+1)*(d+1)+(d+1)*(e+1);for(b=0;b<
    e;++b)for(h=0;h<d;++h)p=b*(d+1)+h,u=p+d+1,w.push(r+p+1,r+u,r+p),w.push(r+p+1,r+u+1,r+u)}else{r=(c+1)*(d+1);if(0<e)for(g=0;g<d;g++)u=g/d*2*Math.PI,f=Math.sin(u),k=-b/2,l=Math.cos(u),m=1-(f+1)/2,n=(l+1)/2,q.push(f*e,k,l*e),t.push(0,-1,0),x.push(m,n),m/=3,n/=3,m=m*primitiveUv1PaddingScale+primitiveUv1Padding,n=n*primitiveUv1PaddingScale+primitiveUv1Padding,m+=1/3,y.push(m,n),1<g&&w.push(r,r+g,r+g-1);r+=d;if(0<a)for(g=0;g<d;g++)u=g/d*2*Math.PI,f=Math.sin(u),k=b/2,l=Math.cos(u),m=1-(f+1)/2,n=(l+1)/2,q.push(f*
        a,k,l*a),t.push(0,1,0),x.push(m,n),m/=3,n/=3,m=m*primitiveUv1PaddingScale+primitiveUv1Padding,n=n*primitiveUv1PaddingScale+primitiveUv1Padding,m+=2/3,y.push(m,n),1<g&&w.push(r,r+g-1,r+g)}return{positions:q,normals:t,uvs:x,uvs1:y,indices:w}};
    pc.createCylinder=function(e,a){var b=a&&(a.radius||a.baseRadius),b=void 0!==b?b:.5,b=pc._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
    pc.createCapsule=function(e,a){var b=a&&void 0!==a.radius?a.radius:.3,b=pc._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
    pc.createCone=function(e,a){var b=pc._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
    pc.createSphere=function(e,a){var b=a&&void 0!==a.radius?a.radius:.5,c=a&&void 0!==a.latitudeBands?a.latitudeBands:16,d=a&&void 0!==a.longitudeBands?a.longitudeBands:16,f,g,k,l,m,n,h,r,p,q=[],t=[],x=[],y=[];for(g=0;g<=c;g++)for(f=g*Math.PI/c,k=Math.sin(f),l=Math.cos(f),f=0;f<=d;f++)m=2*f*Math.PI/d-Math.PI/2,n=Math.sin(m),m=Math.cos(m),m*=k,h=l,n*=k,r=1-f/d,p=1-g/c,q.push(m*b,h*b,n*b),t.push(m,h,n),x.push(r,p);for(g=0;g<c;++g)for(f=0;f<d;++f)b=g*(d+1)+f,k=b+d+1,y.push(b+1,k,b),y.push(b+1,k+1,k);c=
        {normals:t,uvs:x,uvs1:x,indices:y};pc.precalculatedTangents&&(c.tangents=pc.calculateTangents(q,t,x,y));return pc.createMesh(e,q,c)};
    pc.createPlane=function(e,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(.5,.5),c=a&&void 0!==a.widthSegments?a.widthSegments:5,d=a&&void 0!==a.lengthSegments?a.lengthSegments:5,f,g,k,l,m,n,h=[],r=[],p=[],q=[],t=0;for(f=0;f<=c;f++)for(g=0;g<=d;g++)k=-b.x+2*b.x*f/c,l=-(-b.y+2*b.y*g/d),m=f/c,n=g/d,h.push(k,0,l),r.push(0,1,0),p.push(m,n),f<c&&g<d&&(q.push(t+d+1,t+1,t),q.push(t+d+1,t+d+2,t+1)),t++;b={normals:r,uvs:p,uvs1:p,indices:q};pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(h,
        r,p,q));return pc.createMesh(e,h,b)};
    pc.createBox=function(e,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(.5,.5,.5),c=a&&void 0!==a.widthSegments?a.widthSegments:1,d=a&&void 0!==a.lengthSegments?a.lengthSegments:1,f=a&&void 0!==a.heightSegments?a.heightSegments:1,g=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],
        [5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],m=[],n=[],h=[],r=[],p=[],q=0,b=function(a,b,c){var d,f,e,z;for(e=0;e<=b;e++)for(z=0;z<=c;z++){d=new pc.Vec3;f=new pc.Vec3;var A=new pc.Vec3,D=new pc.Vec3;d.lerp(g[k[a][0]],g[k[a][1]],e/b);f.lerp(g[k[a][0]],g[k[a][2]],z/c);A.sub2(f,g[k[a][0]]);D.add2(d,A);d=e/b;f=z/c;m.push(D.x,D.y,D.z);n.push(l[a][0],l[a][1],l[a][2]);h.push(d,f);d/=3;f/=3;d=d*primitiveUv1PaddingScale+primitiveUv1Padding;f=f*primitiveUv1PaddingScale+primitiveUv1Padding;
        d+=a%3/3;f+=Math.floor(a/3)/3;r.push(d,f);e<b&&z<c&&(p.push(q+c+1,q+1,q),p.push(q+c+1,q+c+2,q+1));q++}};b(0,c,f);b(1,c,f);b(2,c,d);b(3,c,d);b(4,d,f);b(5,d,f);c={normals:n,uvs:h,uvs1:r,indices:p};pc.precalculatedTangents&&(c.tangents=pc.calculateTangents(m,n,h,p));return pc.createMesh(e,m,c)};pc.Scene.defaultMaterial=new pc.StandardMaterial;pc.Scene.defaultMaterial.shadingModel=pc.SPECULAR_BLINN;pc.extend(pc,function(){function e(a,b){return a.priority-b.priority}function a(a,b){return b.key-a.key}var b,c,d,f,g=[null,function(a,b){return a.drawOrder-b.drawOrder},function(a,d){b=a._key[pc.SORTKEY_FORWARD];c=d._key[pc.SORTKEY_FORWARD];return b===c&&a.mesh&&d.mesh?d.mesh.id-a.mesh.id:c-b},function(a,b){return b.zdist-a.zdist},function(a,b){return a.zdist-b.zdist}],k=0,l=function(){this.opaqueMeshInstances=[];this.transparentMeshInstances=[];this.shadowCasters=[];this.visibleOpaque=[];this.visibleTransparent=
        []},m=function(a){void 0!==a.id?(this.id=a.id,k=Math.max(this.id+1,k)):this.id=k++;this.name=a.name;this._refCounter=(this._enabled=void 0===a.enabled?!0:a.enabled)?1:0;this.opaqueSortMode=void 0===a.opaqueSortMode?pc.SORTMODE_MATERIALMESH:a.opaqueSortMode;this.transparentSortMode=void 0===a.transparentSortMode?pc.SORTMODE_BACK2FRONT:a.transparentSortMode;this.renderTarget=a.renderTarget;this.shaderPass=void 0===a.shaderPass?pc.SHADER_FORWARD:a.shaderPass;this.passThrough=void 0===a.passThrough?!1:
        a.passThrough;this.overrideClear=void 0===a.overrideClear?!1:a.overrideClear;this._clearColor=new pc.Color(0,0,0,1);a.clearColor&&this._clearColor.copy(a.clearColor);this._clearColorBuffer=void 0===a.clearColorBuffer?!1:a.clearColorBuffer;this._clearDepthBuffer=void 0===a.clearDepthBuffer?!1:a.clearDepthBuffer;this._clearStencilBuffer=void 0===a.clearStencilBuffer?!1:a.clearStencilBuffer;this._clearOptions={color:this._clearColor.data,depth:1,stencil:0,flags:(this._clearColorBuffer?pc.CLEARFLAG_COLOR:
        0)|(this._clearDepthBuffer?pc.CLEARFLAG_DEPTH:0)|(this._clearStencilBuffer?pc.CLEARFLAG_STENCIL:0)};this.onPreCull=a.onPreCull;this.onPreRender=a.onPreRender;this.onPreRenderOpaque=a.onPreRenderOpaque;this.onPreRenderTransparent=a.onPreRenderTransparent;this.onPostCull=a.onPostCull;this.onPostRender=a.onPostRender;this.onPostRenderOpaque=a.onPostRenderOpaque;this.onPostRenderTransparent=a.onPostRenderTransparent;this.onDrawCall=a.onDrawCall;this.onEnable=a.onEnable;this.onDisable=a.onDisable;if(this._enabled&&
        this.onEnable)this.onEnable();this.instances=(this.layerReference=a.layerReference)?a.layerReference.instances:new l;this.cullingMask=a.cullingMask?a.cullingMask:4294967295;this.opaqueMeshInstances=this.instances.opaqueMeshInstances;this.transparentMeshInstances=this.instances.transparentMeshInstances;this.shadowCasters=this.instances.shadowCasters;this._lightComponents=[];this._lights=[];this._sortedLights=[[],[],[]];this.cameras=[];this._dirtyCameras=this._dirtyLights=this._dirty=!1;this._staticLightHash=
        this._lightHash=this._cameraHash=0;this._needsStaticPrepare=!0;this._staticPrepareDone=!1;this._shaderVersion=-1;this._version=0;this._lightCube=null};Object.defineProperty(m.prototype,"enabled",{get:function(){return this._enabled},set:function(a){if(a!==this._enabled)if(this._enabled=a){if(this.incrementCounter(),this.onEnable)this.onEnable()}else if(this.decrementCounter(),this.onDisable)this.onDisable()}});Object.defineProperty(m.prototype,"clearColor",{get:function(){return this._clearColor},
        set:function(a){this._clearColor.copy(a)}});m.prototype._updateClearFlags=function(){var a=0;this._clearColorBuffer&&(a|=pc.CLEARFLAG_COLOR);this._clearDepthBuffer&&(a|=pc.CLEARFLAG_DEPTH);this._clearStencilBuffer&&(a|=pc.CLEARFLAG_STENCIL);this._clearOptions.flags=a};Object.defineProperty(m.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(a){this._clearColorBuffer=a;this._updateClearFlags()}});Object.defineProperty(m.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},
        set:function(a){this._clearDepthBuffer=a;this._updateClearFlags()}});Object.defineProperty(m.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(a){this._clearStencilBuffer=a;this._updateClearFlags()}});m.prototype.incrementCounter=function(){if(0===this._refCounter&&(this._enabled=!0,this.onEnable))this.onEnable();this._refCounter++};m.prototype.decrementCounter=function(){if(1===this._refCounter){if(this._enabled=!1,this.onDisable)this.onDisable()}else if(0===
        this._refCounter)return;this._refCounter--};m.prototype.addMeshInstances=function(a,b){for(var c=this._shaderVersion,d,f,g,e=this.shadowCasters,k=0;k<a.length;k++)d=a[k],g=d.material,f=g.blendType===pc.BLEND_NONE?this.opaqueMeshInstances:this.transparentMeshInstances,0>f.indexOf(d)&&f.push(d),!b&&d.castShadow&&0>e.indexOf(d)&&e.push(d),!this.passThrough&&0<=c&&g._shaderVersion!==c&&(g.updateShader!==pc.Material.prototype.updateShader&&(g.clearVariants(),g.shader=null),g._shaderVersion=c);this.passThrough||
    (this._dirty=!0)};m.prototype.removeMeshInstances=function(a,b){var c,d,f,g,e,k,m,l=this.opaqueMeshInstances,v=this.transparentMeshInstances,z=this.shadowCasters;for(c=0;c<a.length;c++){f=a[c];g=-1;e=0;k=l.length;for(d=0;d<k;d++){m=l[d];if(m===f){g=d;e=1;break}if(m._staticSource===f)0>g&&(g=d),e++;else if(0<=g)break}0<=g&&l.splice(g,e);g=-1;e=0;k=v.length;for(d=0;d<k;d++){m=v[d];if(m===f){g=d;e=1;break}if(m._staticSource===f)0>g&&(g=d),e++;else if(0<=g)break}0<=g&&v.splice(g,e);b||(d=z.indexOf(f),
    0<=d&&z.splice(d,1))}this._dirty=!0};m.prototype.clearMeshInstances=function(a){if(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!a&&0!==this.shadowCasters.length)this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,a||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0)};m.prototype.addLight=function(a){0<=this._lightComponents.indexOf(a)||(this._lightComponents.push(a),this._lights.push(a.light),this._dirtyLights=!0,this._generateLightHash())};
        m.prototype.removeLight=function(a){var b=this._lightComponents.indexOf(a);0>b||(this._lightComponents.splice(b,1),b=this._lights.indexOf(a.light),this._lights.splice(b,1),this._dirtyLights=!0,this._generateLightHash())};m.prototype.clearLights=function(){this._lightComponents.length=0;this._lights.length=0;this._dirtyLights=!0};m.prototype.addShadowCasters=function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=a[d],b.castShadow&&0>c.indexOf(b)&&c.push(b);this._dirtyLights=!0};m.prototype.removeShadowCasters=
            function(a){for(var b,c=this.shadowCasters,d=0;d<a.length;d++)b=c.indexOf(a[d]),0<=b&&c.splice(b,1);this._dirtyLights=!0};m.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(a);for(var b="",c="",d=0;d<this._lights.length;d++)this._lights[d].isStatic?c+=this._lights[d].key:b+=this._lights[d].key;this._lightHash=0===b.length?0:pc.hashCode(b);this._staticLightHash=0===c.length?0:pc.hashCode(c)}else this._staticLightHash=this._lightHash=0};m.prototype._generateCameraHash=
            function(){if(1<this.cameras.length){this.cameras.sort(e);for(var a="",b=0;b<this.cameras.length;b++)a+=this.cameras[b].entity._guid;this._cameraHash=pc.hashCode(a)}else this._cameraHash=0;this._dirtyCameras=!0};m.prototype.addCamera=function(a){0<=this.cameras.indexOf(a)||(this.cameras.push(a),this._generateCameraHash())};m.prototype.removeCamera=function(a){a=this.cameras.indexOf(a);0>a||(this.cameras.splice(a,1),this._generateCameraHash())};m.prototype.clearCameras=function(){this._cameraHash=
            this.cameras.length=0;this._dirtyCameras=!0};m.prototype._sortCameras=function(){this._generateCameraHash()};m.prototype._calculateSortDistances=function(a,b,c,d){var f,g,e,k,m;for(f=0;f<b;f++)g=a[f],g.command||g.layer<=pc.scene.LAYER_FX||(e=g.aabb.center.data,k=e[0]-c[0],m=e[1]-c[1],e=e[2]-c[2],g.zdist=k*d[0]+m*d[1]+e*d[2])};m.prototype._sortVisible=function(a,b,c){var e=this.instances,k=a?this.transparentSortMode:this.opaqueSortMode;if(k!==pc.SORTMODE_NONE){a=a?e.visibleTransparent[c]:e.visibleOpaque[c];
            if(k===pc.SORTMODE_BACK2FRONT||k===pc.SORTMODE_FRONT2BACK)d=b.getPosition().data,f=b.forward.data,this._calculateSortDistances(a.list,a.length,d,f);a.list.length!==a.length&&(a.list.length=a.length);a.list.sort(g[k])}};return{Layer:m,InstanceList:l,VisibleInstanceList:function(){this.list=[];this.length=0;this.done=!1}}}());pc.extend(pc,function(){var e=function(){this.layerList=[];this.subLayerList=[];this.subLayerEnabled=[];this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1;this._meshInstances=[];this._lights=[];this.cameras=[];this._sortedLights=[[],[],[]];this._lightShadowCasters=[];this._globalLightCameras=[];this._globalLightCameraIds=[];this._renderedRt=[];this._renderedByCam=[];this._renderedLayer=[];this._renderList=[];this._renderListCamera=[];pc.events.attach(this)};e.prototype._sortLights=
        function(a){var b,c=a._lights;a._sortedLights[pc.LIGHTTYPE_DIRECTIONAL].length=0;a._sortedLights[pc.LIGHTTYPE_POINT].length=0;for(var d=a._sortedLights[pc.LIGHTTYPE_SPOT].length=0;d<c.length;d++)b=c[d],b._enabled&&a._sortedLights[b._type].push(b)};e.prototype._update=function(){var a,b,c,d,f=this.layerList.length,g=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(a=0;a<f;a++)d=this.layerList[a],d._dirty&&(this._dirty=!0),d._dirtyLights&&(this._dirtyLights=!0),d._dirtyCameras&&(this._dirtyCameras=
        !0);var e;if(this._dirty){g|=pc.COMPUPDATED_INSTANCES;for(a=this._meshInstances.length=0;a<f;a++)if(d=this.layerList[a],!d.passThrough){e=d.opaqueMeshInstances;for(b=0;b<e.length;b++)c=e[b],0>this._meshInstances.indexOf(c)&&(this._meshInstances.push(c),c.material&&c.material._dirtyBlend&&(this._dirtyBlend=!0,c.material._dirtyBlend=!1));e=d.transparentMeshInstances;for(b=0;b<e.length;b++)c=e[b],0>this._meshInstances.indexOf(c)&&(this._meshInstances.push(c),c.material&&c.material._dirtyBlend&&(this._dirtyBlend=
        !0,c.material._dirtyBlend=!1))}for(a=0;a<f;a++)this.layerList[a]._dirty=!1,this.layerList[a]._version++}if(this._dirtyBlend){var g=g|pc.COMPUPDATED_BLEND,l,m;for(a=0;a<f;a++)if(d=this.layerList[a],!d.passThrough){e=d.opaqueMeshInstances;c=d.transparentMeshInstances;l=[];m=[];for(b=0;b<e.length;b++)e[b].material&&e[b].material.blendType!==pc.BLEND_NONE?m.push(e[b]):l.push(e[b]);for(b=0;b<c.length;b++)c[b].material&&c[b].material.blendType!==pc.BLEND_NONE?m.push(c[b]):l.push(c[b]);d.opaqueMeshInstances.length=
        l.length;for(b=0;b<l.length;b++)d.opaqueMeshInstances[b]=l[b];d.transparentMeshInstances.length=m.length;for(b=0;b<m.length;b++)d.transparentMeshInstances[b]=m[b]}this._dirtyBlend=!1}this._dirty=!1;if(this._dirtyLights||g&pc.COMPUPDATED_INSTANCES)for(g|=pc.COMPUPDATED_LIGHTS,this._lights.length=0,a=this._lightShadowCasters.length=0;a<f;a++)for(d=this.layerList[a],e=d._lights,b=0;b<e.length;b++)l=e[b],c=this._lights.indexOf(l),0>c&&(this._lights.push(l),c=this._lights.length-1),(l=this._lightShadowCasters[c])||
    (this._lightShadowCasters[c]=[]);if(this._dirtyLights)for(this._sortLights(this),this._dirtyLights=!1,a=0;a<f;a++)d=this.layerList[a],this._sortLights(d),d._dirtyLights=!1;if(g)for(a=0;a<f;a++)for(d=this.layerList[a],e=d._lights,b=0;b<e.length;b++)for(l=e[b],c=this._lights.indexOf(l),l=this._lightShadowCasters[c],m=d.shadowCasters,c=0;c<m.length;c++)0>l.indexOf(m[c])&&l.push(m[c]);if(g&pc.COMPUPDATED_LIGHTS||this._dirtyCameras)for(this._globalLightCameras.length=0,e=this._sortedLights[pc.LIGHTTYPE_DIRECTIONAL],
                                                                                                                                                                                                                                                                                                                                                                                                                                                           b=0;b<e.length;b++)for(l=e[b],this._globalLightCameras[b]=[],a=0;a<f;a++)if(d=this.layerList[a],!(0>d._sortedLights[pc.LIGHTTYPE_DIRECTIONAL].indexOf(l)))for(c=0;c<d.cameras.length;c++)0<=this._globalLightCameras[b].indexOf(d.cameras[c])||this._globalLightCameras[b].push(d.cameras[c]);if(this._dirtyCameras){g|=pc.COMPUPDATED_CAMERAS;for(a=this.cameras.length=0;a<f;a++)for(d=this.layerList[a],b=0;b<d.cameras.length;b++)e=d.cameras[b],c=this.cameras.indexOf(e),0>c&&this.cameras.push(e);this._renderList.length=
        0;for(a=c=this._renderListCamera.length=0;a<f;a++)if(c)c--;else if(d=this.layerList[a],0!==d.cameras.length||d.isPostEffect)if(l=d._cameraHash,0===l)this._renderList.push(a),this._renderListCamera.push(0);else{e=1;for(b=a+1;b<f;b++)if(m=this.layerList[b]._cameraHash,l!==m){e=b-a-1;break}else b===f-1&&(e=b-a);if(1===e)for(l=0;l<d.cameras.length;l++)this._renderList.push(a),this._renderListCamera.push(l);else{for(l=0;l<d.cameras.length;l++)for(b=0;b<=e;b++)this._renderList.push(a+b),this._renderListCamera.push(l);
        c=e}}this._dirtyCameras=!1;for(a=0;a<f;a++)this.layerList[a]._dirtyCameras=!1}if(g&pc.COMPUPDATED_LIGHTS||g&pc.COMPUPDATED_CAMERAS)for(b=this._globalLightCameraIds.length=0;b<this._globalLightCameras.length;b++){e=[];for(a=0;a<this._globalLightCameras[b].length;a++)c=this.cameras.indexOf(this._globalLightCameras[b][a]),0>c||e.push(c);this._globalLightCameraIds.push(e)}return g};e.prototype._isLayerAdded=function(a){return 0<=this.layerList.indexOf(a)?!0:!1};e.prototype._isSublayerAdded=function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            b){for(var c=0;c<this.layerList.length;c++)if(this.layerList[c]===a&&this.subLayerList[c]===b)return!0;return!1};e.prototype.push=function(a){this._isLayerAdded(a)||(this.layerList.push(a),this.layerList.push(a),this.subLayerList.push(!1),this.subLayerList.push(!0),this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.insert=function(a,b){this._isLayerAdded(a)||(this.layerList.splice(b,0,a,a),this.subLayerList.splice(b,
        0,!1,!0),this.subLayerEnabled.splice(b,0,!0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.remove=function(a){for(var b=this.layerList.indexOf(a);0<=b;)this.layerList.splice(b,1),this.subLayerList.splice(b,1),this.subLayerEnabled.splice(b,1),b=this.layerList.indexOf(a),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",a)};e.prototype.pushOpaque=function(a){this._isSublayerAdded(a,!1)||(this.layerList.push(a),this.subLayerList.push(!1),
        this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.insertOpaque=function(a,b){this._isSublayerAdded(a,!1)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,!1),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.removeOpaque=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b]===a&&!this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,
        1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};e.prototype.pushTransparent=function(a){this._isSublayerAdded(a,!0)||(this.layerList.push(a),this.subLayerList.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.insertTransparent=function(a,b){this._isSublayerAdded(a,!0)||(this.layerList.splice(b,0,a),this.subLayerList.splice(b,0,
        !0),this.subLayerEnabled.splice(b,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",a))};e.prototype.removeTransparent=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b]===a&&this.subLayerList[b]){this.layerList.splice(b,1);this.subLayerList.splice(b,1);this.subLayerEnabled.splice(b,1);this._dirtyCameras=this._dirtyLights=this._dirty=!0;0>this.layerList.indexOf(a)&&this.fire("remove",a);break}};e.prototype._getSublayerIndex=function(a,b){var c=this.layerList.indexOf(a);
        return 0>c||this.subLayerList[c]!==b&&(c=this.layerList.indexOf(a,c+1),0>c||this.subLayerList[c]!==b)?-1:c};e.prototype.getOpaqueIndex=function(a){return this._getSublayerIndex(a,!1)};e.prototype.getTransparentIndex=function(a){return this._getSublayerIndex(a,!0)};e.prototype.getLayerById=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].id===a)return this.layerList[b];return null};e.prototype.getLayerByName=function(a){for(var b=0;b<this.layerList.length;b++)if(this.layerList[b].name===
        a)return this.layerList[b];return null};return{LayerComposition:e}}());pc.extend(pc,function(){pc.SPRITE_RENDERMODE_SIMPLE=0;pc.SPRITE_RENDERMODE_SLICED=1;pc.SPRITE_RENDERMODE_TILED=2;var e=[0,0,1,0,0,1,0,0,1,0,0,1],a=[0,1,3,2,3,1],b=function(a,b){this._device=a;this._pixelsPerUnit=b&&void 0!==b.pixelsPerUnit?b.pixelsPerUnit:1;this._renderMode=b&&void 0!==b.renderMode?b.renderMode:pc.SPRITE_RENDERMODE_SIMPLE;this._atlas=b&&void 0!==b.atlas?b.atlas:null;this._frameKeys=b&&void 0!==b.frameKeys?b.frameKeys:null;this._meshes=[];this._meshesDirty=this._updatingProperties=
        !1;pc.events.attach(this);this._atlas&&this._frameKeys&&this._createMeshes()};b.prototype._createMeshes=function(){var a,b;a=0;for(b=this._meshes.length;a<b;a++){var f=this._meshes[a];if(f){f.vertexBuffer.destroy();for(var g=0,e=f.indexBuffer.length;g<e;g++)f.indexBuffer[g].destroy()}}b=this._frameKeys.length;this._meshes=Array(b);f=this.renderMode===pc.SPRITE_RENDERMODE_SLICED||this._renderMode===pc.SPRITE_RENDERMODE_TILED?this._create9SliceMesh:this._createSimpleMesh;for(a=0;a<b;a++)g=this._atlas.frames[this._frameKeys[a]],
        this._meshes[a]=g?f.call(this,g):null;this.fire("set:meshes")};b.prototype._createSimpleMesh=function(b){var d=b.rect,f=this._atlas.texture.width,g=this._atlas.texture.height,k=d.data[2]/this._pixelsPerUnit,l=d.data[3]/this._pixelsPerUnit,m=b.pivot.x;b=b.pivot.y;var n=d.data[0]/f,h=d.data[1]/g,f=(d.data[0]+d.data[2])/f,d=(d.data[1]+d.data[3])/g;return pc.createMesh(this._device,[-m*k,-b*l,0,(1-m)*k,-b*l,0,(1-m)*k,(1-b)*l,0,-m*k,(1-b)*l,0],{uvs:[n,h,f,h,f,d,n,d],normals:e,indices:a})};b.prototype._create9SliceMesh=
        function(){var a=pc.Vec2.ONE,b,f,g,e,l,m,n=[],h=[],r=[],p=[],q=0;for(b=0;3>=b;b++)for(l=0===b||3===b?0:1,f=0;3>=f;f++)g=-a.x+2*a.x*(1>=b?0:3)/3,e=-(-a.y+2*a.y*(1>=f?0:3)/3),m=0===f||3===f?0:1,n.push(-g,0,e),h.push(0,1,0),r.push(l,m),3>b&&3>f&&(p.push(q+3+1,q+1,q),p.push(q+3+1,q+3+2,q+1)),q++;return pc.createMesh(this._device,n,{normals:h,uvs:r,indices:p})};b.prototype._onSetFrames=function(a){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()};b.prototype._onFrameChanged=function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             b){var f=this._frameKeys.indexOf(a);0>f||(b?this.renderMode===pc.SPRITE_RENDERMODE_SIMPLE&&(this._meshes[f]=this._createSimpleMesh(b)):this._meshes[f]=null,this.fire("set:meshes"))};b.prototype._onFrameRemoved=function(a){a=this._frameKeys.indexOf(a);0>a||(this._meshes[a]=null,this.fire("set:meshes"))};b.prototype.startUpdate=function(){this._updatingProperties=!0;this._meshesDirty=!1};b.prototype.endUpdate=function(){this._updatingProperties=!1;this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes();
        this._meshesDirty=!1};b.prototype.destroy=function(){var a,b;a=0;for(b=this._meshes.length;a<b;a++){var f=this._meshes[a];if(f){f.vertexBuffer.destroy();for(var g=0,e=f.indexBuffer.length;g<e;g++)f.indexBuffer[g].destroy()}}this._meshes.length=0};Object.defineProperty(b.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(a){this._frameKeys=a;this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes());this.fire("set:frameKeys",a)}});Object.defineProperty(b.prototype,
        "atlas",{get:function(){return this._atlas},set:function(a){a!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=a)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:
            this._createMeshes()),this.fire("set:atlas",a))}});Object.defineProperty(b.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==a&&(this._pixelsPerUnit=a,this.fire("set:pixelsPerUnit",a),this._atlas&&this._frameKeys&&this.renderMode===pc.SPRITE_RENDERMODE_SIMPLE&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}});Object.defineProperty(b.prototype,"renderMode",{get:function(){return this._renderMode},set:function(a){if(this._renderMode!==
        a){var b=this._renderMode;this._renderMode=a;this.fire("set:renderMode",a);(b===pc.SPRITE_RENDERMODE_SIMPLE||a===pc.SPRITE_RENDERMODE_SIMPLE)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}});Object.defineProperty(b.prototype,"meshes",{get:function(){return this._meshes}});return{Sprite:b}}());pc.extend(pc,function(){var e=function(){this._frames=this._texture=null;pc.events.attach(this)};e.prototype.setFrame=function(a,b){var c=this._frames[a];c?(c.rect.copy(b.rect),c.pivot.copy(b.pivot),c.border.copy(b.border)):(c={rect:b.rect.clone(),pivot:b.pivot.clone(),border:b.border.clone()},this._frames[a]=c);this.fire("set:frame",a.toString(),c)};e.prototype.removeFrame=function(a){var b=this._frames[a];b&&(delete this._frames[a],this.fire("remove:frame",a.toString(),b))};e.prototype.destroy=
        function(){this._texture&&this._texture.destroy()};Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(a){this._texture=a;this.fire("set:texture",a)}});Object.defineProperty(e.prototype,"frames",{get:function(){return this._frames},set:function(a){this._frames=a;this.fire("set:frames",a)}});return{TextureAtlas:e}}());pc.extend(pc,function(){var e=function(a){this.func=void 0===a.func?pc.FUNC_ALWAYS:a.func;this.ref=a.ref||0;this.readMask=void 0===a.readMask?255:a.readMask;this.writeMask=void 0===a.writeMask?255:a.writeMask;this.fail=a.fail||pc.STENCILOP_KEEP;this.zfail=a.zfail||pc.STENCILOP_KEEP;this.zpass=a.zpass||pc.STENCILOP_KEEP};e.prototype.clone=function(){return new pc.StencilParameters({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})};
        return{StencilParameters:e}}());pc.extend(pc,function(){var e=function(){this.name="";this.duration=0;this._nodes=[];this._nodeDict={}};e.prototype.getDuration=function(){return this.duration};e.prototype.getName=function(){return this.name};e.prototype.getNode=function(a){return this._nodeDict[a]};Object.defineProperty(e.prototype,"nodes",{get:function(){return this._nodes}});e.prototype.getNodes=function(){return this._nodes};e.prototype.setDuration=function(a){this.duration=a};e.prototype.setName=function(a){this.name=a};e.prototype.addNode=
        function(a){this._nodes.push(a);this._nodeDict[a._name]=a};return{Animation:e,Key:function(a,b,c,d){this.time=a;this.position=b;this.rotation=c;this.scale=d},Node:function(){this._name="";this._keys=[]}}}());pc.extend(pc,function(){function e(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}e.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function c(a){var b=new e;b._name=a.name;d._interpolatedKeys.push(b);d._interpolatedKeyDict[a.name]=b;for(b=d._currKeyIndices[a.name]=0;b<a._children.length;b++)c(a._children[b])}this._animation=null;this._time=
        0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var d=this;c(a)};a.prototype.addTime=function(a){if(null!==this._animation){var c,d,f,g,e,l,m,n=this._animation._nodes;c=this._animation.duration;if(this._time!==c||this.looping){this._time+=a;if(this._time>c)for(this._time=this.looping?0:c,c=0;c<n.length;c++)d=n[c],f=d._name,this._currKeyIndices[f]=0;else if(0>this._time)for(this._time=this.looping?c:0,c=0;c<n.length;c++)d=n[c],f=d._name,
        this._currKeyIndices[f]=d._keys.length-2;a=0<=a?1:-1;for(c=0;c<n.length;c++){d=n[c];f=d._name;d=d._keys;g=this._interpolatedKeyDict[f];m=!1;if(1!==d.length)for(var h=this._currKeyIndices[f];h<d.length-1&&0<=h;h+=a)if(e=d[h],l=d[h+1],e.time<=this._time&&l.time>=this._time){m=(this._time-e.time)/(l.time-e.time);g._pos.lerp(e.position,l.position,m);g._quat.slerp(e.rotation,l.rotation,m);g._scale.lerp(e.scale,l.scale,m);g._written=!0;this._currKeyIndices[f]=h;m=!0;break}if(1===d.length||!m&&0===this._time&&
        this.looping)g._pos.copy(d[0].position),g._quat.copy(d[0].rotation),g._scale.copy(d[0].scale),g._written=!0}}}};a.prototype.blend=function(a,c,d){for(var f=this._interpolatedKeys.length,g=0;g<f;g++){var e=a._interpolatedKeys[g],l=c._interpolatedKeys[g],m=this._interpolatedKeys[g];e._written&&l._written?(m._quat.slerp(e._quat,c._interpolatedKeys[g]._quat,d),m._pos.lerp(e._pos,c._interpolatedKeys[g]._pos,d),m._scale.lerp(e._scale,l._scale,d),m._written=!0):e._written?(m._quat.copy(e._quat),m._pos.copy(e._pos),
        m._scale.copy(e._scale),m._written=!0):l._written&&(m._quat.copy(l._quat),m._pos.copy(l._pos),m._scale.copy(l._scale),m._written=!0)}};Object.defineProperty(a.prototype,"animation",{get:function(){return this._animation},set:function(a){this._animation=a;this.currentTime=0}});a.prototype.getAnimation=function(){return this._animation};Object.defineProperty(a.prototype,"currentTime",{get:function(){return this._time},set:function(a){this._time=a;a=this._interpolatedKeys.length;for(var c=0;c<a;c++)this._currKeyIndices[this._interpolatedKeys[c]._name]=
        0;this.addTime(0);this.updateGraph()}});a.prototype.getCurrentTime=function(){return this._time};a.prototype.setCurrentTime=function(a){this.currentTime=a};Object.defineProperty(a.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}});a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this.animation=a};a.prototype.setGraph=function(a){var c;if(this.graph=a)for(c=0;c<this._interpolatedKeys.length;c++){var d=a.findByName(this._interpolatedKeys[c]._name);
        this._interpolatedKeys[c].setTarget(d)}else for(c=0;c<this._interpolatedKeys.length;c++)this._interpolatedKeys[c].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var c=this._interpolatedKeys[a];if(c._written){var d=c.getTarget();d.localPosition.copy(c._pos);d.localRotation.copy(c._quat);d.localScale.copy(c._scale);d._dirtyLocal||d._dirtify(!0);c._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=
        function(){return this.looping};return{Skeleton:a}}());pc.extend(pc,function(){function e(){return"undefined"!==typeof Audio}function a(){return!("undefined"===typeof AudioContext&&"undefined"===typeof webkitAudioContext)}var b=function(b){if(a()||b.forceWebAudioApi){if("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var d=this.context;if(pc.platform.ios){var f=function(){var a=d.createBuffer(1,1,44100),b=d.createBufferSource();b.buffer=a;b.connect(d.destination);
        b.start(0);b.disconnect();window.removeEventListener("touchend",f)};window.addEventListener("touchend",f)}}}else console.warn("No support for 3D audio found");e()||console.warn("No support for 2D audio found");this.listener=new pc.Listener(this);this._volume=1;this.suspended=!1;pc.events.attach(this)};b.hasAudio=e;b.hasAudioContext=a;b.prototype={suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")},destroy:function(){this.fire("destroy");
        this.context&&this.context.close&&(this.context.close(),this.context=null)},getListener:function(){console.warn('DEPRECATED: getListener is deprecated. Get the "listener" field instead.');return this.listener},getVolume:function(){console.warn('DEPRECATED: getVolume is deprecated. Get the "volume" property instead.');return this.volume},setVolume:function(a){console.warn('DEPRECATED: setVolume is deprecated. Set the "volume" property instead.');this.volume=a},playSound:function(a,b){b=b||{};var f=
        null;pc.Channel&&(f=new pc.Channel(this,a,b),f.play());return f},playSound3d:function(a,b,f){f=f||{};var g=null;pc.Channel3d&&(g=new pc.Channel3d(this,a,f),g.setPosition(b),f.volume&&g.setVolume(f.volume),f.loop&&g.setLoop(f.loop),f.maxDistance&&g.setMaxDistance(f.maxDistance),f.minDistance&&g.setMinDistance(f.minDistance),f.rollOffFactor&&g.setRollOffFactor(f.rollOffFactor),f.distanceModel&&g.setDistanceModel(f.distanceModel),g.play());return g}};Object.defineProperty(b.prototype,"volume",{get:function(){return this._volume},
        set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.fire("volumechange",a)}});pc.AudioManager=b;return{SoundManager:b}}());pc.extend(pc,function(){var e=function(a){a instanceof Audio?this.audio=a:this.buffer=a};Object.defineProperty(e.prototype,"duration",{get:function(){var a=0;this.buffer?a=this.buffer.duration:this.audio&&(a=this.audio.duration);return a||0}});return{Sound:e}}());pc.extend(pc,function(){var e=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;pc.AudioManager.hasAudioContext()&&(this.listener=a.context.listener)};e.prototype={getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);
        this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},getOrientation:function(){return this.orientation}};return{Listener:e}}());pc.extend(pc,function(){var e;pc.SoundManager.hasAudioContext()?(e=function(a,b,c){pc.events.attach(this);c=c||{};this._volume=void 0!==c.volume?pc.math.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startedAt=
        0;this._startOffset=null;this._currentOffset=this._currentTime=0;this._playWhenLoaded=!0;this._manager=a;this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null;this._initializeNodes();this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this._endedHandler=this._onEnded.bind(this);this.source=null},e.prototype={_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=
        this._manager.context.createGain();this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop();this.source||this._createSource();var a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._startedAt=this._manager.context.currentTime;this._currentTime=0;this._currentOffset=a;this._state=0;this._playWhenLoaded=!1;this.volume=
        this._volume;this.loop=this._loop;this.pitch=this._pitch;this._manager.on("volumechange",this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(0!==this._state||!this.source)return!1;this._updateCurrentTime();this._state=1;this._suspendEndEvent=
        !0;this.source.stop(0);this.source=null;this._playWhenLoaded=!1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();return!0},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var a=this.currentTime;null!==this._startOffset&&(a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0,this._startOffset=null);this._duration?this.source.start(0,a,this._duration):this.source.start(0,a);this._state=0;this._startedAt=this._manager.context.currentTime;
        this._currentOffset=a;this.volume=this._volume;this.loop=this._loop;this.pitch=this._pitch;this._playWhenLoaded=!1;this._suspendInstanceEvents||this._onResume();return!0},stop:function(){if(2===this._state||!this.source)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._currentOffset=this._currentTime=
        this._startedAt=0;this._startOffset=null;this._playWhenLoaded=!1;this._suspendEndEvent=!0;0===this._state&&this.source.stop(0);this.source=null;this._state=2;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(a,b){if(a){b||(b=a);var c=this._manager.context.destination;this._firstNode!==a&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(c),this._firstNode=a,this._connectorNode.connect(a));this._lastNode!==b&&(this._lastNode&&
    this._lastNode.disconnect(c),this._lastNode=b,this._lastNode.connect(c))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var a=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null);this._lastNode&&(this._lastNode.disconnect(a),this._lastNode=null);this._connectorNode.connect(a)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;
        var a=this._manager.context;this._sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0)));return this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-
        this._startedAt)*this.pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&this.isPlaying&&(this.source.stop(0),this.source=null)}},Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this._manager.volume)}}),Object.defineProperty(e.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._currentOffset=this.currentTime;this._startedAt=
        this._manager.context.currentTime;this._pitch=Math.max(Number(a)||0,.01);this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(e.prototype,"sound",{get:function(){return this._sound},set:function(a){this._sound=a;this.isStopped?this._createSource():this.stop()}}),Object.defineProperty(e.prototype,"currentTime",{get:function(){if(null!==
        this._startOffset)return this._startOffset;if(this.isPaused)return this._currentTime;if(this.isStopped||!this.source)return 0;this._updateCurrentTime();return this._currentTime},set:function(a){if(!(0>a))if(this.isPlaying){this.stop();var b=this._suspendInstanceEvents;this._suspendInstanceEvents=!0;this._startOffset=a;this.play();this._suspendInstanceEvents=b}else this._currentTime=this._startOffset=a}})):pc.SoundManager.hasAudio()?(e=function(a,b,c){pc.events.attach(this);c=c||{};this._volume=void 0!==
    c.volume?pc.math.clamp(Number(c.volume)||0,0,1):1;this._pitch=void 0!==c.pitch?Math.max(.01,Number(c.pitch)||0):1;this._loop=!(void 0===c.loop||!c.loop);this._sound=b;this._state=2;this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1;this._playWhenLoaded=!0;this._startTime=Math.max(0,Number(c.startTime)||0);this._duration=Math.max(0,Number(c.duration)||0);this._startOffset=null;this._isReady=!1;this._manager=a;this._loadedMetadataHandler=this._onLoadedMetadata.bind(this);this._timeUpdateHandler=
        this._onTimeUpdate.bind(this);this._endedHandler=this._onEnded.bind(this);this._onPlayCallback=c.onPlay;this._onPauseCallback=c.onPause;this._onResumeCallback=c.onResume;this._onStopCallback=c.onStop;this._onEndCallback=c.onEnd;this.source=null;this._createSource()},e.prototype={play:function(){2!==this._state&&this.stop();if(!this.source&&!this._createSource())return!1;this.volume=this._volume;this.pitch=this._pitch;this.loop=this._loop;this.source.play();this._state=0;this._playWhenLoaded=!1;this._manager.on("volumechange",
        this._onManagerVolumeChange,this);this._manager.on("suspend",this._onManagerSuspend,this);this._manager.on("resume",this._onManagerResume,this);this._manager.on("destroy",this._onManagerDestroy,this);this._manager.suspended&&this._onManagerSuspend();this._suspendInstanceEvents||this._onPlay();return!0},pause:function(){if(!this.source||0!==this._state)return!1;this._suspendEndEvent=!0;this.source.pause();this._playWhenLoaded=!1;this._state=1;this._startOffset=null;this._suspendInstanceEvents||this._onPause();
        return!0},resume:function(){if(!this.source||1!==this._state)return!1;this._state=0;this._playWhenLoaded=!1;this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume());return!0},stop:function(){if(!this.source||2===this._state)return!1;this._manager.off("volumechange",this._onManagerVolumeChange,this);this._manager.off("suspend",this._onManagerSuspend,this);this._manager.off("resume",this._onManagerResume,this);this._manager.off("destroy",this._onManagerDestroy,this);this._suspendEndEvent=
        !0;this.source.pause();this._playWhenLoaded=!1;this._state=2;this._startOffset=null;this._suspendInstanceEvents||this._onStop();return!0},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler);this._isReady=!0;var a=this._startOffset%this.duration||0,a=(this._startTime+a)%this._sound.duration||0;this._startOffset=null;this.source.currentTime=
        a},_createSource:function(){this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler);return this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||
        0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}},Object.defineProperty(e.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this._manager.volume)}}),Object.defineProperty(e.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);
        this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(e.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(e.prototype,"sound",{get:function(){return this._sound},set:function(a){this.stop();this._sound=a}}),Object.defineProperty(e.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:this.isStopped||!this.source?0:this.source.currentTime-this._startTime},
        set:function(a){0>a||(this._startOffset=a,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(a%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):e=function(){};pc.extend(e.prototype,{_onPlay:function(){this.fire("play");this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause");this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume");this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop");
        this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){this.isPlaying&&!this._suspended&&(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}});Object.defineProperty(e.prototype,"startTime",{get:function(){return this._startTime},
        set:function(a){this._startTime=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(e.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(a){this._duration=Math.max(0,Number(a)||0);a=this.isPlaying;this.stop();a&&this.play()}});Object.defineProperty(e.prototype,"isPlaying",{get:function(){return 0===this._state}});Object.defineProperty(e.prototype,"isPaused",{get:function(){return 1===
        this._state}});Object.defineProperty(e.prototype,"isStopped",{get:function(){return 2===this._state}});Object.defineProperty(e.prototype,"isSuspended",{get:function(){return this._suspended}});return{SoundInstance:e}}());pc.extend(pc,function(){var e;if(pc.SoundManager.hasAudioContext())e=function(a,c,d){d=d||{};this._position=new pc.Vec3;d.position&&(this.position=d.position);this._velocity=new pc.Vec3;d.velocity&&(this.velocity=d.velocity);this.maxDistance=void 0!==d.maxDistance?Number(d.maxDistance):1E4;this.refDistance=void 0!==d.refDistance?Number(d.refDistance):1;this.rollOffFactor=void 0!==d.rollOffFactor?Number(d.rollOffFactor):1;this.distanceModel=void 0!==d.distanceModel?d.distanceModel:pc.DISTANCE_LINEAR},
        e=pc.inherits(e,pc.SoundInstance),e.prototype=pc.extend(e.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain();this.panner=this._manager.context.createPanner();this.panner.connect(this.gain);this._inputNode=this.panner;this._connectorNode=this.gain;this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(a){this._position.copy(a);this.panner.setPosition(a.x,a.y,
        a.z)}}),Object.defineProperty(e.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)}}),Object.defineProperty(e.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(a){this.panner.maxDistance=a}}),Object.defineProperty(e.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(a){this.panner.refDistance=a}}),Object.defineProperty(e.prototype,"rollOffFactor",
        {get:function(){return this.panner.rolloffFactor},set:function(a){this.panner.rolloffFactor=a}}),Object.defineProperty(e.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(a){this.panner.distanceModel=a}});else if(pc.SoundManager.hasAudio()){var a=new pc.Vec3;e=function(a,c,d){d=d||{};this._position=new pc.Vec3;d.position&&(this.position=d.position);this._velocity=new pc.Vec3;d.velocity&&(this.velocity=d.velocity);this._maxDistance=void 0!==d.maxDistance?Number(d.maxDistance):
        1E4;this._refDistance=void 0!==d.refDistance?Number(d.refDistance):1;this._rollOffFactor=void 0!==d.rollOffFactor?Number(d.rollOffFactor):1;this._distanceModel=void 0!==d.distanceModel?d.distanceModel:pc.DISTANCE_LINEAR};e=pc.inherits(e,pc.SoundInstance);Object.defineProperty(e.prototype,"position",{get:function(){return this._position},set:function(b){this._position.copy(b);if(this.source){var c=this._manager.listener.getPosition();b=this.refDistance;var d=this.maxDistance,f=this.rollOffFactor,g=
        this.distanceModel;a=a.sub2(c,this._position);c=a.length();if(c<b)b=1;else if(c>d)b=0;else{var e=0;g===pc.DISTANCE_LINEAR?e=1-f*(c-b)/(d-b):g===pc.DISTANCE_INVERSE?e=b/(b+f*(c-b)):g===pc.DISTANCE_EXPONENTIAL&&(e=Math.pow(c/b,-f));b=pc.math.clamp(e,0,1)}this.source.volume=this.volume*b*this._manager.volume}}});Object.defineProperty(e.prototype,"velocity",{get:function(){return this._velocity},set:function(a){this._velocity.copy(a)}});Object.defineProperty(e.prototype,"maxDistance",{get:function(){return this._maxDistance},
        set:function(a){this._maxDistance=a}});Object.defineProperty(e.prototype,"refDistance",{get:function(){return this._refDistance},set:function(a){this._refDistance=a}});Object.defineProperty(e.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(a){this._rollOffFactor=a}});Object.defineProperty(e.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(a){this._distanceModel=a}})}else e=function(){};return{SoundInstance3d:e}}());pc.extend(pc,function(){var e;pc.AudioManager.hasAudioContext()?(e=function(a,b,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},e.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();if(this.source&&(this.startTime=this.manager.context.currentTime,
            this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended))this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=
        null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",
        this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.gain&&(this.gain.gain.value=a*this.manager.volume)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:
        0},_createSource:function(){var a=this.manager.context;this.sound.buffer&&(this.source=a.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(a.destination),this.loop||(this.source.onended=this.pause.bind(this)))}}):pc.AudioManager.hasAudio()?(e=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;b.audio&&(this.source=b.audio.cloneNode(!1),
        this.source.pause())},e.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this);if(this.manager.suspended)this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=
        !1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=a=pc.math.clamp(a,0,1);this.source&&(this.source.volume=a*this.manager.volume)},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=
        a)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}}):e=function(){};pc.extend(e.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&
    (this.suspended=!1,this.unpause())}});return{Channel:e}}());pc.extend(pc,function(){var e;if(pc.AudioManager.hasAudioContext())e=function(a,c,d){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},e=pc.inherits(e,pc.Channel),e.prototype=pc.extend(e.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
        setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(a){this.panner.distanceModel=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=
            this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination);this.loop||(this.source.onended=this.pause.bind(this))}});else if(pc.AudioManager.hasAudio()){var a=new pc.Vec3;e=function(a,c){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1;this.distanceModel=pc.DISTANCE_INVERSE};e=pc.inherits(e,pc.Channel);e.prototype=pc.extend(e.prototype,{getPosition:function(){return this.position},
        setPosition:function(b){this.position.copy(b);if(this.source){var c=this.manager.listener.getPosition();b=this.minDistance;var d=this.maxDistance,f=this.rollOffFactor,g=this.distanceModel;a=a.sub2(c,this.position);c=a.length();if(c<b)b=1;else if(c>d)b=0;else{var e=0;g===pc.DISTANCE_LINEAR?e=1-f*(c-b)/(d-b):g===pc.DISTANCE_INVERSE?e=b/(b+f*(c-b)):g===pc.DISTANCE_EXPONENTIAL&&(e=Math.pow(c/b,-f));b=pc.math.clamp(e,0,1)}d=this.getVolume();this.source.volume=d*b}},getVelocity:function(){return this.velocity},
        setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(a){this.rollOffFactor=a},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(a){this.distanceModel=a}})}else e=function(){};return{Channel3d:e}}());(function(){var e={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",
        KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:13,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,
        KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,
        KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,
        PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};pc.extend(pc,e);pc.input={};pc.extend(pc.input,e)})();pc.extend(pc,function(){var e=function(a,c){var d={x:0,y:0};if(c){if(c instanceof e)throw Error("Expected MouseEvent");d=a._getTargetCoords(c)}else c={};if(d)this.x=d.x,this.y=d.y;else if(pc.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheel=c.detail?-1*c.detail:c.wheelDelta?c.wheelDelta/120:0;pc.Mouse.isPointerLocked()?(this.dx=c.movementX||c.webkitMovementX||c.mozMovementX||0,this.dy=c.movementY||c.webkitMovementY||c.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);
        this.button="mousedown"===c.type||"mouseup"===c.type?c.button:pc.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=c.target;this.ctrlKey=c.ctrlKey||!1;this.altKey=c.altKey||!1;this.shiftKey=c.shiftKey||!1;this.metaKey=c.metaKey||!1;this.event=c},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=
        this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",
        this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&
    this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,c){if(document.body.requestPointerLock){var d=function(){a();document.removeEventListener("pointerlockchange",d)},f=function(){c();document.removeEventListener("pointerlockerror",f)};a&&document.addEventListener("pointerlockchange",d,!1);c&&document.addEventListener("pointerlockerror",
        f,!1);document.body.requestPointerLock()}else c&&c()},disablePointerLock:function(a){if(document.exitPointerLock){var c=function(){a();document.removeEventListener("pointerlockchange",c)};a&&document.addEventListener("pointerlockchange",c,!1);document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},
        wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},_handleUp:function(a){this._buttons[a.button]=!1;a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new e(this,a);a.event&&(this.fire(pc.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var c=
            this._target.getBoundingClientRect(),d=Math.floor(c.left),c=Math.floor(c.top);return a.clientX<d||a.clientX>=d+this._target.clientWidth||a.clientY<c||a.clientY>=c+this._target.clientHeight?null:{x:a.clientX-d,y:a.clientY-c}}};(function(){if("undefined"!==typeof navigator&&"undefined"!==typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},
        c=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",a,!1);document.addEventListener("webkitpointerlocklost",a,!1);document.addEventListener("mozpointerlockchange",a,!1);document.addEventListener("mozpointerlocklost",a,!1);document.addEventListener("webkitpointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);Element.prototype.requestPointerLock=
        Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,a,c)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||
    (document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}})();return{Mouse:a,MouseEvent:e}}());pc.extend(pc,function(){function e(a){c.key=a.keyCode;c.element=a.target;c.event=a;return c}function a(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var b=function(a,b){b?(this.key=b.keyCode,this.element=b.target,this.event=b):this.event=this.element=this.key=null},c=new b,d={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},f=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);
        this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);pc.events.attach(this);this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};f.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",
        this._keyUpHandler,!1)};f.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};f.prototype.toKeyIdentifier=function(b){b=a(b);var c,f;if(c=d[b.toString()])return c;c=b.toString(16).toUpperCase();f=c.length;for(b=0;b<4-f;b++)c="0"+c;return"U+"+c};f.prototype._handleKeyDown=function(a){var b=a.keyCode||a.charCode;
        void 0!==b&&(b=this.toKeyIdentifier(b),this._keymap[b]=!0,this.fire("keydown",e(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};f.prototype._handleKeyUp=function(a){var b=a.keyCode||a.charCode;void 0!==b&&(b=this.toKeyIdentifier(b),delete this._keymap[b],this.fire("keyup",e(a)),this.preventDefault&&a.preventDefault(),this.stopPropagation&&a.stopPropagation())};f.prototype._handleKeyPress=function(a){this.fire("keypress",e(a));this.preventDefault&&a.preventDefault();
        this.stopPropagation&&a.stopPropagation()};f.prototype.update=function(){for(var a in this._lastmap)delete this._lastmap[a];for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};f.prototype.isPressed=function(b){b=a(b);b=this.toKeyIdentifier(b);return!!this._keymap[b]};f.prototype.wasPressed=function(b){b=a(b);b=this.toKeyIdentifier(b);return!!this._keymap[b]&&!this._lastmap[b]};f.prototype.wasReleased=function(b){b=a(b);b=this.toKeyIdentifier(b);return!this._keymap[b]&&
        !!this._lastmap[b]};return{Keyboard:f,KeyboardEvent:b}}());pc.extend(pc,function(){var e=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
        axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};e.prototype={update:function(){var a,b,f,g,e;a=0;for(f=this.current.length;a<f;a++)for(g=this.current[a].pad.buttons,e=g.length,b=0;b<e;b++)void 0===this.previous[a]&&(this.previous[a]=[]),this.previous[a][b]=g[b].pressed;b=this.poll();a=0;for(f=b.length;a<f;a++)this.current[a]=b[a]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),
        f,g=b.length;for(f=0;f<g;f++)b[f]&&a.push({map:this.getMap(b[f]),pad:b[f]})}return a},getMap:function(c){for(var d in b)if(0<=c.id.indexOf(d))return a[b[d]];return a.DEFAULT},isPressed:function(a,b){return this.current[a]?this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed:!1},wasPressed:function(a,b){if(!this.current[a])return!1;var f=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[f].pressed&&!this.previous[a][f]},getAxis:function(a,b){if(!this.current[a])return!1;
        var f=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(f)<this.deadZone&&(f=0);return f}};return{GamePads:e}}());pc.extend(pc,function(){var e=function(a){var b=pc.getTouchTargetCoords(a);this.id=a.identifier;this.x=b.x;this.y=b.y;this.target=a.target;this.touch=a},a=function(a,b){this.element=b.target;this.event=b;this.touches=[];this.changedTouches=[];if(b){var f,g=b.touches.length;for(f=0;f<g;f++)this.touches.push(new e(b.touches[f]));g=b.changedTouches.length;for(f=0;f<g;f++)this.changedTouches.push(new e(b.changedTouches[f]))}};a.prototype={getTouchById:function(a,b){var f,g=b.length;for(f=0;f<g;f++)if(b[f].id===
        a)return b[f];return null}};var b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,!1);this._element.addEventListener("touchmove",
        this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(b){this.fire("touchstart",new a(this,b))},_handleTouchEnd:function(b){this.fire("touchend",
        new a(this,b))},_handleTouchMove:function(b){b.preventDefault();this.fire("touchmove",new a(this,b))},_handleTouchCancel:function(b){this.fire("touchcancel",new a(this,b))}};return{getTouchTargetCoords:function(a){for(var b=0,f=0,g=a.target;!(g instanceof HTMLElement);)g=g.parentNode;do b+=g.offsetLeft-g.scrollLeft,f+=g.offsetTop-g.scrollTop,g=g.offsetParent;while(g);return{x:a.pageX-b,y:a.pageY-f}},TouchDevice:b,TouchEvent:a}}());pc.extend(pc,function(){var e=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};e.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};e.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};e.prototype.disableContextMenu=
        function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};e.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};e.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};e.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
        a));if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.ACTION_KEYBOARD,keys:b}]};e.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.ACTION_MOUSE,button:-b}]};e.prototype.registerPadButton=function(a,b,c){if(void 0===c)throw Error("Invalid button");
        this._actions[a]?this._actions[a].push({type:pc.ACTION_GAMEPAD,button:c,pad:b}):this._actions[a]=[{type:pc.ACTION_GAMEPAD,button:c,pad:b}]};e.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b);a=a||{};a.pad=a.pad||pc.PAD_1;var d=function(d,g,e,l){switch(g){case "mousex":d._mouse.on(pc.EVENT_MOUSEMOVE,function(a){d._axesValues[b][c]=a.dx/10});break;case "mousey":d._mouse.on(pc.EVENT_MOUSEMOVE,function(a){d._axesValues[b][c]=a.dy/10});break;
        case "key":d._axes[b].push(function(){return d._keyboard.isPressed(l)?e:0});break;case "padrx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_R_STICK_X)});break;case "padry":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_R_STICK_Y)});break;case "padlx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_L_STICK_X)});break;case "padly":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");
    }};d(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&d(this,a.negative,-1,a.negativeKey)};e.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,c=0,d=this._actions[a].length,c=0;c<d;++c)switch(b=this._actions[a][c],b.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var f,g=b.keys.length;for(f=0;f<g;f++)if(this._keyboard.isPressed(b.keys[f]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(b.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&
        this._gamepads.isPressed(b.pad,b.button))return!0}return!1};e.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,c=this._actions[a].length,b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var f,g=d.keys.length;for(f=0;f<g;f++)if(this._keyboard.wasPressed(d.keys[f]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(d.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(d.pad,
            d.button))return!0}}return!1};e.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,d=this._axes[a].length;for(c=0;c<d;c++)if("function"===pc.type(this._axes[a][c])){var f=this._axes[a][c]();Math.abs(f)>Math.abs(b)&&(b=f)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};e.prototype._enableMouse=function(){this._mouse=new pc.Mouse;if(!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)};
        e.prototype._enableKeyboard=function(){this._keyboard=new pc.Keyboard;if(!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};return{Controller:e}}());pc.extend(pc,function(){var e,a,b=new pc.Vec3,c=new pc.Vec3,d=new pc.Vec3,f=new pc.Vec3,g=new pc.Vec3,k=new pc.Vec3,l=new pc.Vec3,m=new pc.Vec3,n=new pc.Vec3,h=new pc.Vec2,r=new pc.Vec3,p=new pc.Vec3,q=new pc.Vec3,t=new pc.Vec3,x=new pc.Vec3,y=new pc.Vec3,w=new pc.Vec3,u=new pc.Vec3,v=new pc.Vec4,z=function(a,b,c){d.sub2(b,a);f.sub2(c[0],a);g.sub2(c[1],a);k.sub2(c[2],a);m.cross(k,d);if(0<=f.dot(m)){if(0>-g.dot(m)||0>n.cross(d,g).dot(f))return!1}else if(l.sub2(c[3],a),0>l.dot(m)||0>n.cross(d,f).dot(l))return!1;
        return 1E-8>d.sub2(c[0],c[2]).lengthSq()||1E-8>d.sub2(c[1],c[3]).lengthSq()?!1:!0},A=function(a,b){this.event=a;this.element=b;this._stopPropagation=!1};A.prototype={stopPropagation:function(){this._stopPropagation=!0;this.event.stopImmediatePropagation();this.event.stopPropagation()}};var D=function(a,b,c,d,f,g){this.x=c;this.y=d;this.ctrlKey=a.ctrlKey||!1;this.altKey=a.altKey||!1;this.shiftKey=a.shiftKey||!1;this.metaKey=a.metaKey||!1;this.button=a.button;pc.Mouse.isPointerLocked()?(this.dx=a.movementX||
        a.webkitMovementX||a.mozMovementX||0,this.dy=a.movementY||a.webkitMovementY||a.mozMovementY||0):(this.dx=c-f,this.dy=d-g);this.wheel=a.detail?-1*a.detail:a.wheelDelta?a.wheelDelta/120:0},D=pc.inherits(D,A),B=function(a,b,c){this.touches=a.touches;this.changedTouches=a.changedTouches},B=pc.inherits(B,A),F=function(a){this._app=null;this._attached=!1;this._target=null;this._lastY=this._lastX=0;this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=
        this._handleMove.bind(this);this._wheelHandler=this._handleWheel.bind(this);this._touchstartHandler=this._handleTouchStart.bind(this);this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this);this._touchmoveHandler=this._handleTouchMove.bind(this);this._elements=[];this._pressedElement=this._hoveredElement=null;this._touchedElements={};this._touchesForWhichTouchLeaveHasFired={};"ontouchstart"in window&&(this._clickedEntities={});this.attach(a)};F.prototype={attach:function(a){this._attached&&
    (this._attached=!1,this.detach());this._target=a;this._attached=!0;window.addEventListener("mouseup",this._upHandler,{passive:!0});window.addEventListener("mousedown",this._downHandler,{passive:!0});window.addEventListener("mousemove",this._moveHandler,{passive:!0});window.addEventListener("mousewheel",this._wheelHandler,{passive:!0});window.addEventListener("DOMMouseScroll",this._wheelHandler,{passive:!0});"ontouchstart"in window&&(this._target.addEventListener("touchstart",this._touchstartHandler,
        {passive:!0}),this._target.addEventListener("touchend",this._touchendHandler,{passive:!0}),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,{passive:!0}))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler,!1),window.removeEventListener("mousedown",this._downHandler,!1),window.removeEventListener("mousemove",this._moveHandler,!1),window.removeEventListener("mousewheel",
        this._wheelHandler,!1),window.removeEventListener("DOMMouseScroll",this._wheelHandler,!1),this._target.removeEventListener("touchstart",this._touchstartHandler,!1),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1),this._target=null)},addElement:function(a){-1===this._elements.indexOf(a)&&this._elements.push(a)},removeElement:function(a){a=
        this._elements.indexOf(a);-1!==a&&this._elements.splice(a,1)},_handleUp:function(a){pc.Mouse.isPointerLocked()||(this._calcMouseCoords(a),null!==e&&this._onElementMouseEvent(a))},_handleDown:function(a){pc.Mouse.isPointerLocked()||(this._calcMouseCoords(a),null!==e&&this._onElementMouseEvent(a))},_handleMove:function(b){this._calcMouseCoords(b);null!==e&&(this._onElementMouseEvent(b),this._lastX=e,this._lastY=a)},_handleWheel:function(a){this._calcMouseCoords(a);null!==e&&this._onElementMouseEvent(a)},
        _determineTouchedElements:function(a){var b={},c=this.app.systems.camera.cameras,d,f,g;for(d=c.length-1;0<=d;d--){var e=c[d],k=0;f=0;for(g=a.changedTouches.length;f<g;f++)if(b[a.changedTouches[f].identifier])k++;else{var h=this._calcTouchCoords(a.changedTouches[f]);if(h=this._getTargetElement(e,h.x,h.y))k++,b[a.changedTouches[f].identifier]=h}if(k===g)break}return b},_handleTouchStart:function(a){for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var f=a.changedTouches[c],
            g=b[f.identifier],e=this._touchedElements[f.identifier];g&&g!==e&&(this._fireEvent(a.type,new B(a,g,this)),this._touchesForWhichTouchLeaveHasFired[f.identifier]=!1)}this._touchedElements=b},_handleTouchEnd:function(a){var b=this.app.systems.camera.cameras,c;for(c in this._clickedEntities)delete this._clickedEntities[c];c=0;for(var d=a.changedTouches.length;c<d;c++){var f=a.changedTouches[c],g=this._touchedElements[f.identifier];if(g&&(delete this._touchedElements[f.identifier],delete this._touchesForWhichTouchLeaveHasFired[f.identifier],
                this._fireEvent(a.type,new B(a,g,this)),0===a.touches.length))for(var f=this._calcTouchCoords(f),e=b.length-1;0<=e;e--)this._getTargetElement(b[e],f.x,f.y)!==g||this._clickedEntities[g.entity.getGuid()]||(this._fireEvent("click",new B(a,g,this)),this._clickedEntities[g.entity.getGuid()]=!0)}},_handleTouchMove:function(a){a.preventDefault();for(var b=this._determineTouchedElements(a),c=0,d=a.changedTouches.length;c<d;c++){var f=a.changedTouches[c],g=b[f.identifier],e=this._touchedElements[f.identifier];
            e&&(g===e||this._touchesForWhichTouchLeaveHasFired[f.identifier]||(this._fireEvent("touchleave",new B(a,e,this)),this._touchesForWhichTouchLeaveHasFired[f.identifier]=!0),this._fireEvent("touchmove",new B(a,e,this)))}},_onElementMouseEvent:function(b){var c,d=this._hoveredElement;this._hoveredElement=null;for(var f=this.app.systems.camera.cameras,g=f.length-1;0<=g&&!(c=this._getTargetElement(f[g],e,a));g--);c&&(this._fireEvent(b.type,new D(b,c,e,a,this._lastX,this._lastY)),this._hoveredElement=c,
        b.type===pc.EVENT_MOUSEDOWN&&(this._pressedElement=c));d!==this._hoveredElement&&(d&&this._fireEvent("mouseleave",new D(b,d,e,a,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new D(b,this._hoveredElement,e,a,this._lastX,this._lastY)));b.type===pc.EVENT_MOUSEUP&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new D(b,
            this._hoveredElement,e,a,this._lastX,this._lastY))):this._pressedElement=null)},_fireEvent:function(a,b){for(var c=b.element;;){c.fire(a,b);if(b._stopPropagation)break;if(!c.entity.parent)break;c=c.entity.parent.element;if(!c)break}},_calcMouseCoords:function(b){var c=this._target.getBoundingClientRect(),d=Math.floor(c.left),c=Math.floor(c.top);b.clientX<d||b.clientX>=d+this._target.clientWidth||b.clientY<c||b.clientY>=c+this._target.clientHeight?a=e=null:(e=b.clientX-d,a=b.clientY-c)},_calcTouchCoords:function(a){for(var b=
            0,c=0,d=a.target;!(d instanceof HTMLElement);)d=d.parentNode;do b+=d.offsetLeft-d.scrollLeft,c+=d.offsetTop-d.scrollTop,d=d.offsetParent;while(d);return{x:a.pageX-b,y:a.pageY-c}},_sortElements:function(a,b){return a.screen&&!b.screen?-1:!a.screen&&b.screen?1:a.screen||b.screen?a.screen.screen.screenSpace&&!b.screen.screen.screenSpace?-1:b.screen.screen.screenSpace&&!a.screen.screen.screenSpace?1:b.drawOrder-a.drawOrder:0},_getTargetElement:function(a,b,c){var d=null;this._elements.sort(this._sortElements);
            for(var f=0,g=this._elements.length;f<g;f++){var e=this._elements[f];if(e.screen&&e.screen.screen.screenSpace){if(this._checkElement2d(b,c,e,a)){d=e;break}}else if(this._checkElement3d(b,c,e,a)){d=e;break}}return d},_buildHitCorners:function(a,b,c,d){if(a.entity&&a.entity.button){var f=a.entity.button.hitPadding||v;r.copy(a.entity.up);p.copy(r).scale(-1);t.copy(a.entity.right);q.copy(t).scale(-1);r.scale(f.data[3]*d);p.scale(f.data[1]*d);t.scale(f.data[2]*c);q.scale(f.data[0]*c);x.copy(b[0]).add(p).add(q);
            y.copy(b[1]).add(p).add(t);w.copy(b[2]).add(r).add(t);u.copy(b[3]).add(r).add(q);b=[x,y,w,u]}return b},_calculateScaleToScreen:function(a){var b=a.entity;a=a.screen.screen.scale;for(h.set(a,a);b&&!b.screen;)h.mul(b.getLocalScale()),b=b.parent;return h},_checkElement2d:function(a,d,f,g){var e=this.app.graphicsDevice.width,k=this.app.graphicsDevice.height,h=g.rect.z*e,m=g.rect.w*k,l=g.rect.x*e;g=(1-g.rect.y)*k;var n=g-m;a=a*e/this._target.clientWidth;d=d*k/this._target.clientHeight;return a>=l&&a<=
        l+h&&d<=g&&d>=n&&(a=e*(a-l)/h,d=k-k*(d-n)/m,e=this._calculateScaleToScreen(f),f=this._buildHitCorners(f,f.screenCorners,e.x,e.y),b.set(a,d,1),c.set(a,d,-1),z(b,c,f))?!0:!1},_checkElement3d:function(a,d,f,g){var e=this._target.clientWidth,k=this._target.clientHeight,h=g.rect.z*e,m=g.rect.w*k,l=g.rect.x*e,n=(1-g.rect.y)*k,p=n-m,q=d;return a>=l&&a<=l+h&&d<=n&&q>=p&&(a=e*(a-l)/h,q=k*(q-p)/m,k=f.entity.getWorldTransform().getScale(),f=this._buildHitCorners(f,f.worldCorners,k.x,k.y),g.screenToWorld(a,q,
            g.nearClip,b),g.screenToWorld(a,q,g.farClip,c),z(b,c,f))?!0:!1}};Object.defineProperty(F.prototype,"app",{get:function(){return this._app||pc.app},set:function(a){this._app=a}});return{ElementInput:F,ElementInputEvent:A,ElementMouseEvent:D,ElementTouchEvent:B}}());pc.extend(pc,function(){var e=function(a){pc.events.attach(this);var b=this;this.isSupported=e.isSupported;this.usesPolyfill=e.usesPolyfill;window.InitializeWebVRPolyfill&&window.InitializeWebVRPolyfill();this._index={};this.displays=[];this.display=null;this._app=a;this._onDisplayConnect=this._onDisplayConnect.bind(this);this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this);b._attach();this._getDisplays(function(a,d){if(a)b.fire("error",a);else{for(var f=0;f<d.length;f++)b._addDisplay(d[f]);
        b.fire("ready",b.displays)}})};e.isSupported=!!navigator.getVRDisplays;e.usesPolyfill=!!window.InitializeWebVRPolyfill;e.prototype={_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect);window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect);window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var a=
        this.displays.length;if(a)for(var b=0;b<a;b++)this.displays[b]._camera&&this.displays[b].poll()},_getDisplays:function(a){navigator.getVRDisplays?navigator.getVRDisplays().then(function(b){a&&a(null,b)}):a&&a(Error("WebVR not supported"))},_addDisplay:function(a){this._index[a.displayId]||(a=new pc.VrDisplay(this._app,a),this._index[a.id]=a,this.displays.push(a),this.display||(this.display=a),this.fire("displayconnect",a))},_onDisplayConnect:function(a){a.detail&&a.detail.display?this._addDisplay(a.detail.display):
        this._addDisplay(a.display)},_onDisplayDisconnect:function(a){if(a=this._index[a.detail&&a.detail.display?a.detail.display.displayId:a.display.displayId]){a.destroy();delete this._index[a.id];var b=this.displays.indexOf(a);this.displays.splice(b,1);this.display===a&&(this.display=this.displays.length?this.displays[0]:null);this.fire("displaydisconnect",a)}}};return{VrManager:e}}());pc.extend(pc,function(){var e=function(a,b){var c=this;this._app=a;this._device=a.graphicsDevice;this.id=b.displayId;this._frameData=null;window.VRFrameData&&(this._frameData=new window.VRFrameData);this.display=b;this._camera=null;this.sitToStandInv=new pc.Mat4;this.leftView=new pc.Mat4;this.leftProj=new pc.Mat4;this.leftViewInv=new pc.Mat4;this.leftPos=new pc.Vec3;this.rightView=new pc.Mat4;this.rightProj=new pc.Mat4;this.rightViewInv=new pc.Mat4;this.rightPos=new pc.Vec3;this.combinedPos=new pc.Vec3;
        this.combinedView=new pc.Mat4;this.combinedProj=new pc.Mat4;this.combinedViewInv=new pc.Mat4;this.combinedAspect=this.combinedFov=0;this.presenting=!1;c._presentChange=function(a){if((a.display?a.display:a.detail&&a.detail.display?a.detail.display:a.detail&&a.detail.vrdisplay?a.detail.vrdisplay:c.display)===c.display){c.presenting=c.display&&c.display.isPresenting;if(c.presenting){a=c.display.getEyeParameters("left");var b=c.display.getEyeParameters("right");c._app.graphicsDevice.setResolution(2*
            Math.max(a.renderWidth,b.renderWidth),Math.max(a.renderHeight,b.renderHeight));c._app._allowResize=!1}else c._app.setCanvasResolution(pc.RESOLUTION_AUTO),c._app._allowResize=!0;c.fire("beforepresentchange",c);c.fire("presentchange",c)}};window.addEventListener("vrdisplaypresentchange",c._presentChange,!1);pc.events.attach(this)};e.prototype={destroy:function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange);this._camera&&(this._camera.vrDisplay=null);this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData);
        this.leftProj.data=this._frameData.leftProjectionMatrix;this.rightProj.data=this._frameData.rightProjectionMatrix;var a=this.display.stageParameters;a?(this.sitToStandInv.set(a.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));
        var b=this.leftProj.data[3]+this.leftProj.data[0],c=this.leftProj.data[11]+this.leftProj.data[8],d=1/Math.sqrt(b*b+c*c),a=-Math.atan2(c*d,b*d),b=this.rightProj.data[3]+this.rightProj.data[0],c=this.rightProj.data[11]+this.rightProj.data[8],d=1/Math.sqrt(b*b+c*c),b=b*d,c=c*d,a=Math.max(a,-Math.atan2(c,b));this.combinedFov=a*=2;this.combinedAspect=b=this.rightProj.data[5]/this.rightProj.data[0];c=this.combinedView;c.copy(this.leftView);c.invert();this.leftViewInv.copy(c);d=this.combinedPos.data;d[0]=
            this.leftPos.data[0]=c.data[12];d[1]=this.leftPos.data[1]=c.data[13];d[2]=this.leftPos.data[2]=c.data[14];c.copy(this.rightView);c.invert();this.rightViewInv.copy(c);var f=d[0]-c.data[12],g=d[1]-c.data[13],e=d[2]-c.data[14],f=Math.sqrt(f*f+g*g+e*e);this.rightPos.data[0]=c.data[12];this.rightPos.data[1]=c.data[13];this.rightPos.data[2]=c.data[14];d[0]+=c.data[12];d[1]+=c.data[13];d[2]+=c.data[14];d[0]*=.5;d[1]*=.5;d[2]*=.5;f=.5*f*Math.sin(Math.PI-(.5*Math.PI+.5*a));g=c.data[9];e=c.data[10];c.data[12]=
            d[0]+c.data[8]*f;c.data[13]=d[1]+g*f;c.data[14]=d[2]+e*f;this.combinedViewInv.copy(c);c.invert();this.combinedProj.setPerspective(a*pc.math.RAD_TO_DEG,b,this.display.depthNear+f,this.display.depthFar+f,!0)}},requestPresent:function(a){this.display?this.presenting?a&&a(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){a&&a()},function(b){a&&a(b)}):a&&a(Error("No VrDisplay to requestPresent"))},exitPresent:function(a){this.display||a&&
    a(Error("No VrDisplay to exitPresent"));this.presenting?this.display.exitPresent().then(function(){a&&a()},function(){a&&a(Error("exitPresent failed"))}):a&&a(Error("VrDisplay not presenting"))},requestAnimationFrame:function(a){this.display&&this.display.requestAnimationFrame(a)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(a,b){this.display&&(this.display.depthNear=a,this.display.depthFar=b)},getFrameData:function(){if(this.display)return this._frameData}};
        Object.defineProperty(e.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}});return{VrDisplay:e}}());pc.extend(pc,function(){var e=function(){};e.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream"};e.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};e.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds".split(" ");
        e.prototype={ContentType:e.ContentType,ResponseType:e.ResponseType,binaryExtensions:e.binaryExtensions,get:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("GET",a,b,c)},post:function(a,b,c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("POST",a,c,d)},put:function(a,b,c,d){"function"===typeof c&&(d=c,c={});c.postdata=b;return this.request("PUT",a,c,d)},del:function(a,b,c){"function"===typeof b&&(c=b,b={});return this.request("DELETE",a,b,c)},request:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   b,c,d){var f,g,k,l=!1;"function"===typeof c&&(d=c,c={});c.callback=d;null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)g=c.postdata;else if(c.postdata instanceof FormData)g=c.postdata;else if(c.postdata instanceof Object)switch(g=c.headers["Content-Type"],void 0===g&&(c.headers["Content-Type"]=e.ContentType.FORM_URLENCODED,g=c.headers["Content-Type"]),g){case e.ContentType.FORM_URLENCODED:g="";d=!0;for(f in c.postdata)c.postdata.hasOwnProperty(f)&&
        (d?d=!1:g+="&",g+=escape(f)+"="+escape(c.postdata[f]));break;default:case e.ContentType.JSON:null==g&&(c.headers["Content-Type"]=e.ContentType.JSON),g=JSON.stringify(c.postdata)}else g=c.postdata;k||(k=new XMLHttpRequest);!1===c.cache&&(d=pc.time.now(),f=new pc.URI(b),f.query=f.query?f.query+"&ts="+d:"ts="+d,b=f.toString());c.query&&(f=new pc.URI(b),d=pc.extend(f.getQuery(),c.query),f.setQuery(d),b=f.toString());k.open(a,b,c.async);k.withCredentials=void 0!==c.withCredentials?c.withCredentials:!1;
            k.responseType=c.responseType||this._guessResponseType(b);for(var m in c.headers)c.headers.hasOwnProperty(m)&&k.setRequestHeader(m,c.headers[m]);k.onreadystatechange=function(){this._onReadyStateChange(a,b,c,k)}.bind(this);k.onerror=function(){this._onError(a,b,c,k);l=!0}.bind(this);try{k.send(g)}catch(n){l||c.error(k.status,k,n)}return k},_guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=e.binaryExtensions.indexOf(a)?e.ResponseType.ARRAY_BUFFER:".xml"===a?e.ResponseType.DOCUMENT:
            e.ResponseType.TEXT},_isBinaryContentType:function(a){return 0<=[e.ContentType.MP4,e.ContentType.WAV,e.ContentType.OGG,e.ContentType.MP3,e.ContentType.BIN,e.ContentType.DDS].indexOf(a)?!0:!1},_onReadyStateChange:function(a,b,c,d){if(4===d.readyState)switch(d.status){case 0:"/"!=b[0]&&this._onSuccess(a,b,c,d);break;case 200:case 201:case 206:case 304:this._onSuccess(a,b,c,d);break;default:this._onError(a,b,c,d)}},_onSuccess:function(a,b,c,d){var f;if(a=d.getResponseHeader("Content-Type"))f=a.split(";"),
            f=f[0].trim();f===this.ContentType.JSON||b.split("?")[0].endsWith(".json")?b=JSON.parse(d.responseText):this._isBinaryContentType(f)?b=d.response:d.responseType===e.ResponseType.ARRAY_BUFFER?(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",e.ResponseType.ARRAY_BUFFER,f)),b=d.response):b=d.responseType===e.ResponseType.DOCUMENT||f===this.ContentType.XML?d.responseXML:d.responseText;c.callback(null,b)},_onError:function(a,b,c,d){c.callback(d.status,null)}};return{Http:e,
            http:new e}}());pc.extend(pc,function(){var e=function(a){pc.events.attach(this);this.app=a;this._scripts={};this._list=[]};e.prototype.add=function(a){var b=this;if(this._scripts.hasOwnProperty(a.__name))return setTimeout(function(){if(a.prototype.swap){var c=b._list.indexOf(b._scripts[a.__name]);b._list[c]=a;b._scripts[a.__name]=a;b.fire("swap",a.__name,a);b.fire("swap:"+a.__name,a)}else console.warn("script registry already has '"+a.__name+"' script, define 'swap' method for new script type to enable code hot swapping")}),
        !1;this._scripts[a.__name]=a;this._list.push(a);this.fire("add",a.__name,a);this.fire("add:"+a.__name,a);setTimeout(function(){if(b._scripts.hasOwnProperty(a.__name)){var c=b.app.systems.script._components,d,f,g,e=[],l=[];for(d=0;d<c.length;d++)c[d]._scriptsIndex[a.__name]&&c[d]._scriptsIndex[a.__name].awaiting&&(c[d]._scriptsData&&c[d]._scriptsData[a.__name]&&(g=c[d]._scriptsData[a.__name].attributes),(f=c[d].create(a.__name,{preloading:!0,ind:c[d]._scriptsIndex[a.__name].ind,attributes:g}))&&e.push(f));
        for(d=0;d<e.length;d++)e[d].__initializeAttributes();for(d=0;d<e.length;d++)e[d].enabled&&(e[d]._initialized=!0,l.push(e[d]),e[d].initialize&&e[d].initialize());for(d=0;d<l.length;d++)l[d].enabled&&!l[d]._postInitialized&&(l[d]._postInitialized=!0,l[d].postInitialize&&l[d].postInitialize())}});return!0};e.prototype.remove=function(a){"function"===typeof a&&(a=a.__name);if(!this._scripts.hasOwnProperty(a))return!1;var b=this._scripts[a];delete this._scripts[a];var c=this._list.indexOf(b);this._list.splice(c,
        1);this.fire("remove",a,b);this.fire("remove:"+a,b);return!0};e.prototype.get=function(a){return this._scripts[a]||null};e.prototype.has=function(a){return this._scripts.hasOwnProperty(a)};e.prototype.list=function(){return this._list};return{ScriptRegistry:e}}());pc.extend(pc,function(){var e=function(a,b,c,d){switch(b.type){case "boolean":return!!c;case "number":if("number"===typeof c)break;else{if("string"===typeof c)return c=parseInt(c,10),isNaN(c)?null:c;if("boolean"===typeof c)return 0+c}return null;case "json":if("object"===typeof c)break;try{return JSON.parse(c)}catch(e){return null}case "asset":if(c instanceof pc.Asset)break;else return"number"===typeof c?a.assets.get(c)||null:"string"===typeof c?a.assets.get(parseInt(c,10))||null:null;case "entity":if(c instanceof
        pc.GraphNode)break;else if("string"===typeof c)return a.root.findByGuid(c);return null;case "rgb":case "rgba":if(c instanceof pc.Color)return d instanceof pc.Color?(d.copy(c),d):c.clone();if(c instanceof Array&&3<=c.length&&4>=c.length){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new pc.Color);for(a=0;4>a;a++)d.data[a]=4===a&&3===c.length?1:c[a];return d}return"string"===typeof c&&/#([0-9abcdef]{2}){3,4}/i.test(c)?(d||(d=new pc.Color),d.fromString(c),d):null;case "vec2":case "vec3":case "vec4":b=
        parseInt(b.type.slice(3),10);if(c instanceof pc["Vec"+b])return d instanceof pc["Vec"+b]?(d.copy(c),d):c.clone();if(c instanceof Array&&c.length===b){for(a=0;a<c.length;a++)if("number"!==typeof c[a])return null;d||(d=new pc["Vec"+b]);for(a=0;a<b;a++)d.data[a]=c[a];return d}return null;case "curve":if(c)return c instanceof pc.Curve||c instanceof pc.CurveSet?d=c.clone():(d=new (c.keys[0]instanceof Array?pc.CurveSet:pc.Curve)(c.keys),d.type=c.type),d}return c},a=function(a){this.scriptType=a;this.index=
        {}};a.prototype.add=function(a,b){this.index[a]||pc.createScript.reservedAttributes[a]||(this.index[a]=b,Object.defineProperty(this.scriptType.prototype,a,{get:function(){return this.__attributes[a]},set:function(c){var d=this.__attributes[a];if(b.array){if(this.__attributes[a]=[],c){var m,n;m=0;for(n=c.length;m<n;m++)this.__attributes[a].push(e(this.app,b,c[m],d?d[m]:null))}}else this.__attributes[a]=e(this.app,b,c,d);this.fire("attr",a,this.__attributes[a],d);this.fire("attr:"+a,this.__attributes[a],
        d)}}))};a.prototype.remove=function(a){if(!this.index[a])return!1;delete this.index[a];delete this.scriptType.prototype[a];return!0};a.prototype.has=function(a){return!!this.index[a]};a.prototype.get=function(a){return this.index[a]||null};var b=function(c,d){if(pc.script.legacy)return null;if(b.reservedScripts[c])throw Error("script name: '"+c+"' is reserved, please change script name");var e=function(a){pc.events.attach(this);this.app=a.app;this.entity=a.entity;this._enabled="boolean"===typeof a.enabled?
        a.enabled:!0;this._enabledOld=this.enabled;this.__destroyed=!1;this.__attributes={};this.__attributesRaw=a.attributes||null;this.__scriptType=e};e.__name=c;e.attributes=new a(e);e.prototype.__initializeAttributes=function(a){if(a||this.__attributesRaw){for(var b in e.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(b)?this[b]=this.__attributesRaw[b]:this.__attributes.hasOwnProperty(b)||(e.attributes.index[b].hasOwnProperty("default")?this[b]=e.attributes.index[b]["default"]:
        this[b]=null);this.__attributesRaw=null}};e.extend=function(a){for(var b in a)a.hasOwnProperty(b)&&(e.prototype[b]=a[b])};Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(a){this._enabled=!!a;this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),
    this.initialize&&this.entity.script._scriptMethod(this,pc.ScriptComponent.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,pc.ScriptComponent.scriptMethods.postInitialize)))}});(d?d.scripts:pc.Application.getApplication().scripts).add(e);pc.ScriptHandler._push(e);return e};b.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has on off fire once hasEvent".split(" ");
        var c={},d;for(d=0;d<b.reservedScripts.length;d++)c[b.reservedScripts[d]]=1;b.reservedScripts=c;b.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType _callbacks has on off fire once hasEvent".split(" ");c={};for(d=0;d<b.reservedAttributes.length;d++)c[b.reservedAttributes[d]]=1;b.reservedAttributes=c;return{createScript:b}}());pc.script=function(){var e=!1,a=!1,b={app:null,create:function(a,b){if(e){var f=b(pc.script.app);f._pcScriptName=a;pc.ScriptHandler._push(f);this.fire("created",a,b)}},attribute:function(a,b,f,g){},createLoadingScreen:function(b){if(!a){a=!0;var d=pc.Application.getApplication();b(d)}}};Object.defineProperty(b,"legacy",{get:function(){return e},set:function(a){e=a}});pc.events.attach(b);return b}();pc.extend(pc,function(){var e=function(a,b){b=b||{};pc.log.open();pc.events.attach(this);e._applications[a.id]=this;e._currentApplication=this;this._time=0;this.timeScale=1;this.maxDeltaTime=.1;this.autoRender=!0;this._librariesLoaded=this.renderNextFrame=!1;this._fillMode=pc.FILLMODE_KEEP_ASPECT;this._resolutionMode=pc.RESOLUTION_FIXED;this._allowResize=!0;this.context=this;this.graphicsDevice=new pc.GraphicsDevice(a,b.graphicsDeviceOptions);this.stats=new pc.ApplicationStats(this.graphicsDevice);
        this.systems=new pc.ComponentSystemRegistry;this._audioManager=new pc.SoundManager(b);this.loader=new pc.ResourceLoader;this.scene=new pc.Scene;this.root=new pc.Entity(this);this.root._enabledInHierarchy=!0;this._enableList=[];this._enableList.size=0;this.assets=new pc.AssetRegistry(this.loader);b.assetPrefix&&(this.assets.prefix=b.assetPrefix);this.scriptsOrder=b.scriptsOrder||[];this.scripts=new pc.ScriptRegistry(this);var g=this;this.defaultLayerWorld=new pc.Layer({name:"World",id:pc.LAYERID_WORLD});
        this.graphicsDevice.webgl2?(this.defaultLayerDepth=new pc.Layer({enabled:!1,name:"Depth",id:pc.LAYERID_DEPTH,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(g.graphicsDevice,{format:pc.PIXELFORMAT_DEPTHSTENCIL,width:g.graphicsDevice.width,height:g.graphicsDevice.height});a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this.renderTarget=new pc.RenderTarget({colorBuffer:null,depthBuffer:a,autoResolve:!1});
            g.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(a){var b=g.graphicsDevice.gl;this.srcFbo=b.getParameter(b.FRAMEBUFFER_BINDING);this.renderTarget&&this.renderTarget.width===g.graphicsDevice.width&&this.renderTarget.height===g.graphicsDevice.height||(this.onDisable(),this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;
            this.cameras[a].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear,a=g.graphicsDevice.gl,g.graphicsDevice.setRenderTarget(this.renderTarget),g.graphicsDevice.updateBegin(),a.bindFramebuffer(a.READ_FRAMEBUFFER,this.srcFbo),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),a.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,
            a.DEPTH_BUFFER_BIT,a.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new pc.Layer({enabled:!1,name:"Depth",id:pc.LAYERID_DEPTH,shaderPass:pc.SHADER_DEPTH,onEnable:function(){if(!this.renderTarget){var a=new pc.Texture(g.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:g.graphicsDevice.width,height:g.graphicsDevice.height});a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;
            this.renderTarget=new pc.RenderTarget(g.graphicsDevice,a,{depth:!0,stencil:g.graphicsDevice.supportsStencil});g.graphicsDevice.scope.resolve("uDepthMap").setValue(a)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(a){var b=this.instances.visibleOpaque[a],c=b.list,d=0,f=g.scene.layers.layerList,e=g.scene.layers.subLayerEnabled,p=g.scene.layers.subLayerList,q=g.defaultLayerWorld.renderTarget;
            a=this.cameras[a];for(var t,x,y,w,u=0;u<f.length;u++){t=f[u];if(t===this)break;if(t.renderTarget===q&&t.enabled&&e[u]&&(x=t.cameras.indexOf(a),!(0>x)))for(x=(y=p[u])?t.instances.visibleTransparent[x]:t.instances.visibleOpaque[x],y=x.length,x=x.list,t=0;t<y;t++)w=x[t],w.material&&w.material.depthWrite&&!w._noDepthDrawGl1&&(c[d]=w,d++)}b.length=d},onPreRenderOpaque:function(a){this.renderTarget&&this.renderTarget.width===g.graphicsDevice.width&&this.renderTarget.height===g.graphicsDevice.height||(this.onDisable(),
            this.onEnable());this.oldClear=this.cameras[a].camera._clearOptions;this.cameras[a].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){g.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(a){this.renderTarget&&(this.cameras[a].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH});this.defaultLayerSkybox=new pc.Layer({enabled:!1,name:"Skybox",
            id:pc.LAYERID_SKYBOX,opaqueSortMode:pc.SORTMODE_NONE});this.defaultLayerUi=new pc.Layer({enabled:!0,name:"UI",id:pc.LAYERID_UI,transparentSortMode:pc.SORTMODE_MANUAL,passThrough:!0});this.defaultLayerImmediate=new pc.Layer({enabled:!0,name:"Immediate",id:pc.LAYERID_IMMEDIATE,opaqueSortMode:pc.SORTMODE_NONE,passThrough:!0});this.defaultLayerComposition=new pc.LayerComposition;this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth);
        this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox);this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld);this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate);this.defaultLayerComposition.pushTransparent(this.defaultLayerUi);this.scene.layers=this.defaultLayerComposition;this._immediateLayer=this.defaultLayerImmediate;this.scene.on("set:layers",function(a,b){for(var c=b.layerList,d,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             f=0;f<c.length;f++)switch(d=c[f],d.id){case pc.LAYERID_DEPTH:d.onEnable=g.defaultLayerDepth.onEnable;d.onDisable=g.defaultLayerDepth.onDisable;d.onPreRenderOpaque=g.defaultLayerDepth.onPreRenderOpaque;d.onPostRenderOpaque=g.defaultLayerDepth.onPostRenderOpaque;d.depthClearOptions=g.defaultLayerDepth.depthClearOptions;d.rgbaDepthClearOptions=g.defaultLayerDepth.rgbaDepthClearOptions;d.shaderPass=g.defaultLayerDepth.shaderPass;d.onPostCull=g.defaultLayerDepth.onPostCull;d.onDrawCall=g.defaultLayerDepth.onDrawCall;
            break;case pc.LAYERID_UI:d.passThrough=g.defaultLayerUi.passThrough;break;case pc.LAYERID_IMMEDIATE:d.passThrough=g.defaultLayerImmediate.passThrough}});this.renderer=new pc.ForwardRenderer(this.graphicsDevice);this.renderer.scene=this.scene;this.lightmapper=new pc.Lightmapper(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets);this.once("prerender",this._firstBake,this);this.batcher=new pc.BatchManager(this.graphicsDevice,this.root,this.scene);this.once("prerender",this._firstBatch,
            this);this.keyboard=b.keyboard||null;this.mouse=b.mouse||null;this.touch=b.touch||null;this.gamepads=b.gamepads||null;if(this.elementInput=b.elementInput||null)this.elementInput.app=this;this.vr=null;b.vr&&this._onVrChange(b.vr);this._inTools=!1;this._skyboxLast=0;this._scriptPrefix=b.scriptPrefix||"";this.loader.addHandler("animation",new pc.AnimationHandler);this.loader.addHandler("model",new pc.ModelHandler(this.graphicsDevice));this.loader.addHandler("material",new pc.MaterialHandler(this));this.loader.addHandler("texture",
            new pc.TextureHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("text",new pc.TextHandler);this.loader.addHandler("json",new pc.JsonHandler);this.loader.addHandler("audio",new pc.AudioHandler(this._audioManager));this.loader.addHandler("script",new pc.ScriptHandler(this));this.loader.addHandler("scene",new pc.SceneHandler(this));this.loader.addHandler("cubemap",new pc.CubemapHandler(this.graphicsDevice,this.assets,this.loader));this.loader.addHandler("html",new pc.HtmlHandler);
        this.loader.addHandler("css",new pc.CssHandler);this.loader.addHandler("shader",new pc.ShaderHandler);this.loader.addHandler("hierarchy",new pc.HierarchyHandler(this));this.loader.addHandler("scenesettings",new pc.SceneSettingsHandler(this));this.loader.addHandler("folder",new pc.FolderHandler);this.loader.addHandler("font",new pc.FontHandler(this.loader));this.loader.addHandler("binary",new pc.BinaryHandler);this.loader.addHandler("textureatlas",new pc.TextureAtlasHandler(this.loader));this.loader.addHandler("sprite",
            new pc.SpriteHandler(this.assets,this.graphicsDevice));new pc.RigidBodyComponentSystem(this);new pc.CollisionComponentSystem(this);new pc.AnimationComponentSystem(this);new pc.ModelComponentSystem(this);new pc.CameraComponentSystem(this);new pc.LightComponentSystem(this);pc.script.legacy?new pc.ScriptLegacyComponentSystem(this):new pc.ScriptComponentSystem(this);new pc.AudioSourceComponentSystem(this,this._audioManager);new pc.SoundComponentSystem(this,this._audioManager);new pc.AudioListenerComponentSystem(this,
            this._audioManager);new pc.ParticleSystemComponentSystem(this);new pc.ScreenComponentSystem(this);new pc.ElementComponentSystem(this);new pc.ButtonComponentSystem(this);new pc.SpriteComponentSystem(this);new pc.LayoutGroupComponentSystem(this);new pc.LayoutChildComponentSystem(this);new pc.ZoneComponentSystem(this);this._visibilityChangeHandler=this.onVisibilityChange.bind(this);void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,
            !1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1));this.tick=c(this)};e._currentApplication=null;e._applications={};e.getApplication=
        function(a){return a?e._applications[a]:e._currentApplication};var a=function(a){this.length=a;this.count=0;this.inc=function(){this.count++};this.done=function(){return this.count===this.length}};e.prototype={configure:function(a,b){var c=this;pc.http.get(a,function(a,d){if(a)b(a);else{var e=d.application_properties,n=d.assets;c._parseApplicationProperties(e,function(a){c._onVrChange(e.vr);c._parseAssets(n);a?b(a):b(null)})}})},preload:function(b){var c=this;c.fire("preload:start");var g=this.assets.list({preload:!0}),
        e=new a(g.length),l=!1,m=function(){c.graphicsDevice&&!l&&e.done()&&(l=!0,c.fire("preload:end"),b())},n=g.length,h;if(e.length){var r=function(a){e.inc();c.fire("preload:progress",e.count/n);e.done()&&m()},p=function(a,b){e.inc();c.fire("preload:progress",e.count/n);e.done()&&m()};for(h=0;h<g.length;h++)g[h].loaded?(e.inc(),c.fire("preload:progress",e.count/n),e.done()&&m()):(g[h].once("load",r),g[h].once("error",p),this.assets.load(g[h]))}else m()},loadSceneHierarchy:function(a,b){var c=this,e=this.loader.getHandler("hierarchy");
        this.assets&&this.assets.prefix&&!pc.ABSOLUTE_URL.test(a)&&(a=pc.path.join(this.assets.prefix,a));e.load(a,function(l,m){l?b&&b(l):c._preloadScripts(m,function(){c.systems.script.preloading=!0;var n=e.open(a,m);c.systems.script.preloading=!1;c.loader.clearCache(a,"hierarchy");c.root.addChild(n);pc.ComponentSystem.initialize(n);pc.ComponentSystem.postInitialize(n);b&&b(l,n)})})},loadSceneSettings:function(a,b){this.assets&&this.assets.prefix&&!pc.ABSOLUTE_URL.test(a)&&(a=pc.path.join(this.assets.prefix,
        a));this.loader.load(a,"scenesettings",function(a,c){a?b&&b(a):(this.applySceneSettings(c),b&&b(null))}.bind(this))},loadScene:function(a,b){var c=this,e=this.loader.getHandler("scene");this.assets&&this.assets.prefix&&!pc.ABSOLUTE_URL.test(a)&&(a=pc.path.join(this.assets.prefix,a));e.load(a,function(l,m){l?b&&b(l):this._preloadScripts(m,function(){c.systems.script.preloading=!0;var l=e.open(a,m);c.systems.script.preloading=!1;c.loader.clearCache(a,"scene");c.loader.patch({resource:l,type:"scene"},
        c.assets);c.root.addChild(l.root);c.systems.rigidbody&&"undefined"!==typeof Ammo&&c.systems.rigidbody.setGravity(l._gravity.x,l._gravity.y,l._gravity.z);b&&b(null,l)})}.bind(this))},_preloadScripts:function(b,c){if(pc.script.legacy){var e=this;e.systems.script.preloading=!0;var k=this._getScriptReferences(b),l=0,m=k.length,n=new a(m),h,r=/^http(s)?:\/\//;if(m)for(var p=function(a,b){a&&console.error(a);n.inc();n.done()&&(e.systems.script.preloading=!1,c())},l=0;l<m;l++)h=k[l],!r.test(h.toLowerCase())&&
    e._scriptPrefix&&(h=pc.path.join(e._scriptPrefix,k[l])),this.loader.load(h,"script",p);else e.systems.script.preloading=!1,c()}else c()},_parseApplicationProperties:function(a,b){var c,e;a.useDevicePixelRatio||(a.useDevicePixelRatio=a.use_device_pixel_ratio);a.resolutionMode||(a.resolutionMode=a.resolution_mode);a.fillMode||(a.fillMode=a.fill_mode);a.vrPolyfillUrl||(a.vrPolyfillUrl=a.vr_polyfill_url);this._width=a.width;this._height=a.height;a.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=
        window.devicePixelRatio);this.setCanvasResolution(a.resolutionMode,this._width,this._height);this.setCanvasFillMode(a.fillMode,this._width,this._height);a.vr&&a.vrPolyfillUrl&&(pc.VrManager.isSupported&&!pc.platform.android||a.libraries.push(a.vrPolyfillUrl));if(a.layers&&a.layerOrder){var l=new pc.LayerComposition,m={};for(c in a.layers)e=a.layers[c],e.id=parseInt(c,10),e.enabled=e.id!==pc.LAYERID_DEPTH,m[c]=new pc.Layer(e);c=0;for(e=a.layerOrder.length;c<e;c++){var n=a.layerOrder[c],h=m[n.layer];
        h&&(n.transparent?l.pushTransparent(h):l.pushOpaque(h),l.subLayerEnabled[c]=n.enabled)}this.scene.layers=l}if(a.batchGroups)for(c=0,e=a.batchGroups.length;c<e;c++)l=a.batchGroups[c],this.batcher.addGroup(l.name,l.dynamic,l.maxAabbSize,l.id,l.layers);this._loadLibraries(a.libraries,b)},_loadLibraries:function(a,b){var c=a.length,e=c,l=this,m=/^http(s)?:\/\//;if(c)for(var n=function(a,c){e--;a?b(a):0===e&&(l.onLibrariesLoaded(),b(null))},h=0;h<c;++h){var r=a[h];!m.test(r.toLowerCase())&&l._scriptPrefix&&
    (r=pc.path.join(l._scriptPrefix,r));this.loader.load(r,"script",n)}else b(null)},_parseAssets:function(a){var b,c,e=[],l={};if(pc.script.legacy)for(c in a)e.push(a[c]);else{for(b=0;b<this.scriptsOrder.length;b++)c=this.scriptsOrder[b],a[c]&&(l[c]=!0,e.push(a[c]));for(c in a)l[c]||e.push(a[c])}for(b=0;b<e.length;b++)a=e[b],c=new pc.Asset(a.name,a.type,a.file,a.data),c.id=parseInt(a.id,10),c.preload=a.preload?a.preload:!1,c.tags.add(a.tags),this.assets.add(c)},_getScriptReferences:function(a){var b,
        c,e=[];a.settings.priority_scripts&&(e=a.settings.priority_scripts);var l=[],m={};for(b=0;b<e.length;b++)l.push(e[b]),m[e[b]]=!0;a=a.entities;for(c in a)if(a[c].components.script)for(e=a[c].components.script.scripts,b=0;b<e.length;b++)m[e[b].url]||(l.push(e[b].url),m[e[b].url]=!0);return l},start:function(){this.fire("start",{timestamp:pc.now(),target:this});if(!this._librariesLoaded)this.onLibrariesLoaded();pc.ComponentSystem.initialize(this.root);this.fire("initialize");pc.ComponentSystem.postInitialize(this.root);
        this.fire("postinitialize");this.tick()},update:function(a){this.graphicsDevice.updateClientRect();this.vr&&this.vr.poll();pc.script.legacy&&pc.ComponentSystem.fixedUpdate(1/60,this._inTools);pc.ComponentSystem.update(a,this._inTools);pc.ComponentSystem.postUpdate(a,this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)},render:function(){this.fire("prerender");this.root.syncHierarchy();
        this.batcher.updateAll();pc._skipRenderCounter=0;this.renderer.renderComposition(this.scene.layers);this.fire("postrender")},_fillFrameStats:function(a,b,c){var e=this.stats.frame;e.dt=b;e.ms=c;a>e._timeToCountFrames?(e.fps=e._fpsAccum,e._fpsAccum=0,e._timeToCountFrames=a+1E3):e._fpsAccum++;e.cameras=this.renderer._camerasRendered;e.materials=this.renderer._materialSwitches;e.shaders=this.graphicsDevice._shaderSwitchesPerFrame;e.shadowMapUpdates=this.renderer._shadowMapUpdates;e.shadowMapTime=this.renderer._shadowMapTime;
        e.depthMapTime=this.renderer._depthMapTime;e.forwardTime=this.renderer._forwardTime;a=this.graphicsDevice._primsPerFrame;e.triangles=a[pc.PRIMITIVE_TRIANGLES]/3+Math.max(a[pc.PRIMITIVE_TRISTRIP]-2,0)+Math.max(a[pc.PRIMITIVE_TRIFAN]-2,0);e.cullTime=this.renderer._cullTime;e.sortTime=this.renderer._sortTime;e.skinTime=this.renderer._skinTime;e.morphTime=this.renderer._morphTime;e.instancingTime=this.renderer._instancingTime;for(b=e.otherPrimitives=0;b<a.length;b++)b<pc.PRIMITIVE_TRIANGLES&&(e.otherPrimitives+=
            a[b]),a[b]=0;this.renderer._camerasRendered=0;this.renderer._materialSwitches=0;this.renderer._shadowMapUpdates=0;this.graphicsDevice._shaderSwitchesPerFrame=0;this.renderer._cullTime=0;this.renderer._sortTime=0;this.renderer._skinTime=0;this.renderer._morphTime=0;this.renderer._instancingTime=0;this.renderer._shadowMapTime=0;this.renderer._depthMapTime=0;this.renderer._forwardTime=0;e=this.stats.drawCalls;e.forward=this.renderer._forwardDrawCalls;e.depth=0;e.shadow=this.renderer._shadowDrawCalls;
        e.skinned=this.renderer._skinDrawCalls;e.immediate=0;e.instanced=0;e.removedByInstancing=0;e.total=this.graphicsDevice._drawCallsPerFrame;e.misc=e.total-(e.forward+e.shadow);this.renderer._depthDrawCalls=0;this.renderer._shadowDrawCalls=0;this.renderer._forwardDrawCalls=0;this.renderer._skinDrawCalls=0;this.renderer._immediateRendered=0;this.renderer._instancedDrawCalls=0;this.renderer._removedByInstancing=0;this.graphicsDevice._drawCallsPerFrame=0;this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime;
        e=this.stats.particles;e.updatesPerFrame=e._updatesPerFrame;e.frameTime=e._frameTime;e._updatesPerFrame=0;e._frameTime=0},setCanvasFillMode:function(a,b,c){this._fillMode=a;this.resizeCanvas(b,c)},setCanvasResolution:function(a,b,c){this._resolutionMode=a;a===pc.RESOLUTION_AUTO&&void 0===b&&(b=this.graphicsDevice.canvas.clientWidth,c=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(b,c)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              b,c){a=a||this.graphicsDevice.canvas;var e=function(){b();document.removeEventListener("fullscreenchange",e)},l=function(){c();document.removeEventListener("fullscreenerror",l)};b&&document.addEventListener("fullscreenchange",e,!1);c&&document.addEventListener("fullscreenerror",l,!1);a.requestFullscreen?a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):c()},disableFullscreen:function(a){var b=function(){a();document.removeEventListener("fullscreenchange",b)};a&&document.addEventListener("fullscreenchange",
        b,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(a,b){if(this._allowResize){var c=window.innerWidth,e=window.innerHeight;if(navigator.isCocoonJS)a=c,b=e,this.graphicsDevice.resizeCanvas(a,b);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var l=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;l>c/e?(a=c,b=a/l):(b=e,
        a=b*l)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(a=c,b=e);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=b+"px";this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:a,height:b}}},onLibrariesLoaded:function(){this._librariesLoaded=!0;this.systems.rigidbody.onLibraryLoaded();this.systems.collision.onLibraryLoaded()},applySceneSettings:function(a){var b;this.systems.rigidbody&&"undefined"!==typeof Ammo&&(b=a.physics.gravity,
        this.systems.rigidbody.setGravity(b[0],b[1],b[2]));this.scene.applySettings(a);if(a.render.hasOwnProperty("skybox"))if(a.render.skybox)if(b=this.assets.get(a.render.skybox))this.setSkybox(b);else this.assets.once("add:"+a.render.skybox,this.setSkybox,this);else this.setSkybox(null)},setSkybox:function(a){a?this._skyboxLast===a.id?0!==this.scene.skyboxMip||a.loadFaces?this._onSkyboxChange(a):this._skyboxLoad(a):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+
        this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=a.id,this.assets.on("load:"+a.id,this._onSkyboxChange,this),this.assets.once("remove:"+a.id,this._skyboxRemove,this),a.resource&&this.scene.setSkybox(a.resources),this._skyboxLoad(a)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},_onVrChange:function(a){a?this.vr||(this.vr=new pc.VrManager(this)):this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(a){this.scene.setSkybox(a.resources)},
        _skyboxLoad:function(a){0===this.scene.skyboxMip&&(a.loadFaces=!0);this.assets.load(a);this._onSkyboxChange(a)},_skyboxRemove:function(a){this._skyboxLast&&(this.assets.off("add:"+a.id,this.setSkybox,this),this.assets.off("load:"+a.id,this._onSkyboxChange,this),this.assets.off("remove:"+a.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,
            this.scene),this.scene._needsStaticPrepare=!1);this.batcher.generate()},destroy:function(){e._applications[this.graphicsDevice.canvas.id]=null;e._currentApplication===this&&(e._currentApplication=null);this.off("librariesloaded");document.removeEventListener("visibilitychange",this._visibilityChangeHandler);document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler);document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler);document.removeEventListener("webkitvisibilitychange",
            this._visibilityChangeHandler);this.root.destroy();this.root=null;this.mouse&&(this.mouse.off("mouseup"),this.mouse.off("mousedown"),this.mouse.off("mousewheel"),this.mouse.off("mousemove"),this.mouse.detach(),this.mouse=null);this.keyboard&&(this.keyboard.off("keydown"),this.keyboard.off("keyup"),this.keyboard.off("keypress"),this.keyboard.detach(),this.keyboard=null);this.touch&&(this.touch.off("touchstart"),this.touch.off("touchend"),this.touch.off("touchmove"),this.touch.off("touchcancel"),this.touch.detach(),
            this.touch=null);this.elementInput&&(this.elementInput.detach(),this.elementInput=null);this.controller&&(this.controller=null);pc.ComponentSystem.destroy();for(var a=this.assets.list(),b=0;b<a.length;b++)a[b].unload();this.loader.destroy();this.scene=this.loader=null;this.systems=[];this.context=null;this.graphicsDevice.clearShaderCache();this.graphicsDevice.destroy();this.graphicsDevice.destroyed=!0;this.tick=this.renderer=this.graphicsDevice=null;this._audioManager&&(this._audioManager.destroy(),
            this._audioManager=null);pc.http=new pc.Http;pc.ParticleEmitter.DEFAULT_PARAM_TEXTURE=null;pc.destroyPostEffectQuad()}};var b={},c=function(a){return function(c){if(a.graphicsDevice){e._currentApplication=a;pc.app=a;c=c||pc.now();var g;g=pc.math.clamp((c-(a._time||c))/1E3,0,a.maxDeltaTime);g*=a.timeScale;a._time=c;a.vr&&a.vr.display?a.vr.display.requestAnimationFrame(a.tick):window.requestAnimationFrame(a.tick);if(!a.graphicsDevice.contextLost){a.update(g);if(a.autoRender||a.renderNextFrame)a.render(),
        a.renderNextFrame=!1;b.timestamp=pc.now();b.target=a;a.fire("frameend",b);a.fire("frameEnd",b);a.vr&&a.vr.display&&a.vr.display.presenting&&a.vr.display.submitFrame()}}}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:e}}());pc.ApplicationStats=function(e){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0};this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0};this.misc={renderTargetCreationTime:0};
        this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0};this.vram=e._vram;this.shaders=e._shaderStats;Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}});Object.defineProperty(this,"scene",{get:function(){return pc.Application._currentApplication.scene._stats}});Object.defineProperty(this,"lightmapper",{get:function(){return pc.Application._currentApplication.lightmapper._stats}});Object.defineProperty(this,"batcher",{get:function(){return pc.Application._currentApplication.batcher._stats}});
        pc.events.attach(this)};pc.extend(pc,function(){var e=function(){};e.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:.5,collisioncircle:.5};a.sort(function(a,d){var f=b[a]||1,e=b[d]||1;return f<e?-1:f>e?1:0});return a.map(function(a){return this[a]},
        this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:e}}());pc.extend(pc,function(){function e(a,c){if(!a)return a;a=a&&a.data?a.data:a;switch(c){case "rgb":return new pc.Color(a[0],a[1],a[2]);case "rgba":return new pc.Color(a[0],a[1],a[2],a[3]);case "vec2":return new pc.Vec2(a[0],a[1]);case "vec3":return new pc.Vec3(a[0],a[1],a[2]);case "vec4":return new pc.Vec4(a[0],a[1],a[2],a[3]);case "boolean":case "number":case "string":return a;case "entity":return a;default:throw Error("Could not convert unhandled type: "+c);}}var a=function(a){this.app=a;this.dataStore=
        {};this.schema=[];pc.events.attach(this)};pc.extend(a,{initialize:function(b){a.fire("initialize",b)},postInitialize:function(b){a.fire("postInitialize",b)},update:function(b,c){c?a.fire("toolsUpdate",b):a.fire("update",b)},fixedUpdate:function(b,c){a.fire("fixedUpdate",b)},postUpdate:function(b,c){a.fire("postUpdate",b)}});a.prototype={get store(){return this.dataStore},addComponent:function(a,c){var d=new this.ComponentType(this,a),f=new this.DataType;c=c||{};this.dataStore[a._guid]={entity:a,data:f};
        a[this.id]=d;a.c[this.id]=d;this.initializeComponentData(d,c,[]);this.fire("add",a,d);return d},removeComponent:function(a){var c=this.dataStore[a._guid];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a._guid];delete a[this.id];delete a.c[this.id];this.fire("remove",a,c.data)},cloneComponent:function(a,c){return this.addComponent(c,this.dataStore[a._guid].data)},initializeComponentData:function(a,c,d){c=c||{};d.forEach(function(d){var g,k;"object"===typeof d?(g=d.name,k=d.type):g=
        d;d=c[g];void 0!==d?(void 0!==k&&(d=e(d,k)),a[g]=d):a[g]=a.data[g]},this);if(a.enabled&&a.entity.enabled)a.onEnable()},getPropertiesOfType:function(a){var c=[];(this.schema||[]).forEach(function(d){d&&"object"===typeof d&&d.type===a&&c.push(d)});return c}};pc.events.attach(a);a.destroy=function(){a.off("initialize");a.off("postInitialize");a.off("toolsUpdate");a.off("update");a.off("fixedUpdate");a.off("postUpdate")};return{ComponentSystem:a}}());pc.extend(pc,function(){var e=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema);this.on("set",function(a,b,f){this.fire("set_"+a,a,b,f)});this.on("set_enabled",this.onSetEnabled,this)};e._buildAccessors=function(a,b){b.forEach(function(b){var d="object"===typeof b?b.name:b;Object.defineProperty(a,d,{get:function(){return this.data[d]},set:function(a){var b=this.data,c=b[d];b[d]=a;this.fire("set",d,c,
        a)},configurable:!0})});a._accessorsBuilt=!0};e.prototype={get data(){var a=this.system.store[this.entity._guid];return a?a.data:null},buildAccessors:function(a){e._buildAccessors(this,a)},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}};return{Component:e}}());pc.extend(pc,function(){return{ComponentData:function(){}}}());pc.extend(pc,function(){var e=function(a,b){this.animationsIndex={};this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{play:function(a,b){if(!this.data.animations[a])console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a));else if(this.enabled&&this.entity.enabled){b=b||0;var c=this.data;c.prevAnim=c.currAnim;c.currAnim=a;c.model&&
    (c.blending=0<b&&c.prevAnim,c.blending?(c.blendTime=b,c.blendTimeRemaining=b,c.fromSkel.animation=c.animations[c.prevAnim],c.fromSkel.addTime(c.skeleton._time),c.toSkel.animation=c.animations[c.currAnim]):c.skeleton.animation=c.animations[c.currAnim]);c.playing=!0}},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var c=a.getGraph();b.fromSkel=new pc.Skeleton(c);b.toSkel=new pc.Skeleton(c);b.skeleton=new pc.Skeleton(c);b.skeleton.looping=b.loop;b.skeleton.setGraph(c)}b.model=
        a;b.animations&&b.currAnim&&b.animations[b.currAnim]&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){var b=this,c=this.system.app.assets,d,f=a.length,e=function(a){b.animations[a.name]=a.resource;b.animationsIndex[a.id]=a.name;b.animations=b.animations},k=function(a){a.off("change",b.onAssetChanged,b);a.on("change",b.onAssetChanged,b);a.off("remove",b.onAssetRemoved,b);a.on("remove",b.onAssetRemoved,b);a.resource?e(a):(a.once("load",e,b),b.enabled&&b.entity.enabled&&c.load(a))};
        for(d=0;d<f;d++){var l=c.get(a[d]);if(l)k(l);else c.on("add:"+a[d],k)}}},onAssetChanged:function(a,b,c,d){"resource"===b&&(c?(this.animations[a.name]=c,this.animationsIndex[a.id]=a.name,this.data.currAnim===a.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&this.play(a.name,0)):(delete this.animations[a.name],delete this.animationsIndex[a.id]))},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.animations&&this.animations[a.name]&&(delete this.animations[a.name],
        delete this.animationsIndex[a.id],this.data.currAnim===a.name&&this._stopCurrentAnimation())},_stopCurrentAnimation:function(){this.data.currAnim=null;this.data.playing=!1;this.data.skeleton&&(this.data.skeleton.currentTime=0,this.data.skeleton.animation=null)},onSetAnimations:function(a,b,c){a=this.data;(b=this.entity.model)&&(b=b.model)&&b!==a.model&&this.entity.animation.setModel(b);if(!a.currAnim&&a.activate&&a.enabled&&this.entity.enabled)for(var d in a.animations){this.play(d,0);break}},onSetAssets:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               b,c){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var d=this.system.app.assets.get(b[a]);if(d){d.off("change",this.onAssetChanged,this);d.off("remove",this.onAssetRemoved,this);var f=this.animationsIndex[d.id];this.data.currAnim===f&&this._stopCurrentAnimation();delete this.animations[f];delete this.animationsIndex[d.id]}}b=c.map(function(a){return a instanceof pc.Asset?a.id:a});this.loadAnimationAssets(b)},onSetLoop:function(a,b,c){this.data.skeleton&&(this.data.skeleton.looping=this.data.loop)},
        onSetCurrentTime:function(a,b,c){this.data.skeleton.currentTime=c;this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){e._super.onEnable.call(this);var a=this.data.assets,b=this.system.app.assets;if(a)for(var c=0,d=a.length;c<d;c++){var f=a[c];f instanceof pc.Asset||(f=b.get(f));f&&!f.resource&&b.load(f)}if(this.data.activate&&!this.data.currAnim)for(var g in this.data.animations){this.play(g,0);break}},onBeforeRemove:function(){for(var a=0;a<this.assets.length;a++){var b=
            this.system.app.assets.get(this.assets[a]);b&&(b.off("change",this.onAssetChanged,this),b.off("remove",this.onAssetRemoved,this))}delete this.data.animation;delete this.data.skeleton;delete this.data.fromSkel;delete this.data.toSkel}});Object.defineProperties(e.prototype,{currentTime:{get:function(){return this.data.skeleton._time},set:function(a){this.data.skeleton.currentTime=a;this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});
        return{AnimationComponent:e}}());pc.extend(pc,function(){var e="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" "),a=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.AnimationComponent;this.DataType=pc.AnimationComponentData;this.schema=e;this.on("beforeremove",this.onBeforeRemove,this);this.on("update",
        this.onUpdate,this);pc.ComponentSystem.on("update",this.onUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.AnimationComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){d=["activate","enabled","loop","speed","assets"];a._super.initializeComponentData.call(this,b,c,d)},cloneComponent:function(a,c){var d;this.addComponent(c,{});c.animation.data.assets=pc.extend([],a.animation.assets);c.animation.data.speed=a.animation.speed;c.animation.data.loop=
        a.animation.loop;c.animation.data.activate=a.animation.activate;c.animation.data.enabled=a.animation.enabled;var f={},e=a.animation.animations;for(d in e)e.hasOwnProperty(d)&&(f[d]=e[d]);c.animation.animations=f;f={};e=a.animation.animationsIndex;for(d in e)e.hasOwnProperty(d)&&(f[d]=e[d]);c.animation.animationsIndex=f},onBeforeRemove:function(a,c){c.onBeforeRemove()},onUpdate:function(a){var c=this.store,d;for(d in c)if(c.hasOwnProperty(d)){var f=c[d],e=f.data;e.enabled&&e.playing&&f.entity.enabled&&
    (f=e.skeleton,null!==f&&null!==e.model&&(e.blending?(e.blendTimeRemaining-=a,0>e.blendTimeRemaining&&(e.blendTimeRemaining=0),f.blend(e.fromSkel,e.toSkel,1-e.blendTimeRemaining/e.blendTime)):(f.addTime(a*e.speed),f._time!==f._animation.duration||e.loop||(e.playing=!1)),e.blending&&0===e.blendTimeRemaining&&(e.blending=!1,f.animation=e.toSkel._animation),f.updateGraph()))}}});return{AnimationComponentSystem:a}}());pc.extend(pc,function(){return{AnimationComponentData:pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.animations={};this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);this.on("set_castShadowsLightmap",this.onSetCastShadowsLightmap,this);this.on("set_lightmapped",this.onSetLightmapped,this);this.on("set_lightmapSizeMultiplier",this.onSetLightmapSizeMultiplier,this);this.on("set_isStatic",this.onSetIsStatic,this);this.on("set_model",
        this.onSetModel,this);this.on("set_material",this.onSetMaterial,this);this.on("set_mapping",this.onSetMapping,this);this.on("set_layers",this.onSetLayers,this);this.on("set_batchGroupId",this.onSetBatchGroupId,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)});this._assetOld=0;this._materialEvents=null;this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");
        this.enabled=a},_onAssetLoad:function(a){a.resource&&(this._onModelLoaded(a.resource.clone()),this._clonedModel=!0)},addModelToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(a){for(var b,c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.removeMeshInstances(a.meshInstances)},_onAssetUnload:function(a){this.model&&
    (this.removeModelFromLayers(this.model),this.model=null)},_onAssetChange:function(a,b,c,d){"data"===b&&(this.mapping=this.data.mapping)},_onAssetRemove:function(a){this.asset===a.id&&(this.asset=null)},_setModelAsset:function(a){if(this._assetOld!==a){var b=this.system.app.assets,c=null!==a?b.get(a):null;this._dirtyModelAsset=!0;this._onModelAsset(c||null);if(!c&&null!==a)b.once("add:"+a,this._onModelAsset,this)}},_onModelAsset:function(a){var b=this.system.app.assets;if(this._assetOld){b.off("add:"+
        this._assetOld,this._onModelAsset,this);var c=b.get(this._assetOld);c&&(c.off("load",this._onAssetLoad,this),c.off("unload",this._onAssetUnload,this),c.off("change",this._onAssetChange,this),c.off("remove",this._onAssetRemove,this))}this._assetOld=a?a.id:0;a?(a.on("load",this._onAssetLoad,this),a.on("unload",this._onAssetUnload,this),a.on("change",this._onAssetChange,this),a.on("remove",this._onAssetRemove,this),a.resource?(this._dirtyModelAsset=!1,this._onModelLoaded(a.resource.clone()),this._clonedModel=
        !0):this.enabled&&this.entity.enabled&&(this._dirtyModelAsset=!1,b.load(a))):this._dirtyModelAsset=!1},remove:function(){this._onModelAsset(null)},_onModelLoaded:function(a){"asset"===this.data.type&&(this.model=a)},onSetType:function(a,b,c){a=this.data;if(c)if(this._area=b=null,"asset"===c)null!==this.data.asset?this._setModelAsset(this.data.asset):this.model=null;else{switch(c){case "box":b=this.system.box;this._area={x:2,y:2,z:2,uv:2/3};break;case "capsule":b=this.system.capsule;this._area={x:2*
    Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case "sphere":b=this.system.sphere;this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;case "cone":b=this.system.cone;this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case "cylinder":b=this.system.cylinder;this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case "plane":b=this.system.plane;this._area={x:0,y:1,z:0,uv:1};break;default:throw Error("Invalid model type: "+c);}c=new pc.GraphNode;var d=new pc.Model;d.graph=c;d.meshInstances=
        [new pc.MeshInstance(c,b,a.material)];this.system._inTools&&d.generateWireframe();this.model=d;this.asset=null}},onSetAsset:function(a,b,c){a=null;"asset"===this.data.type&&(null!==c?(a=c,c instanceof pc.Asset&&(a=this.data.asset=c.id)):this.model=null);null===a&&(this.data.asset=null);this._setModelAsset(a)},onSetCastShadows:function(a,b,c){var d,f=this.data.model;if(f){var e=this.layers,k=this.system.app.scene;if(b&&!c)for(a=0;a<e.length;a++)(d=this.system.app.scene.layers.getLayerById(this.layers[a]))&&
    d.removeShadowCasters(f.meshInstances);d=f.meshInstances;for(a=0;a<d.length;a++)d[a].castShadow=c;if(!b&&c)for(a=0;a<e.length;a++)(d=k.layers.getLayerById(e[a]))&&d.addShadowCasters(f.meshInstances)}},onSetCastShadowsLightmap:function(a,b,c){},onSetLightmapped:function(a,b,c){var d;if(this.data.model)if(a=this.data.model.meshInstances,c)for(c=0;c<a.length;c++)b=a[c],d=b.mask,b.mask=(d|pc.MASK_BAKED)&~(pc.MASK_DYNAMIC|pc.MASK_LIGHTMAP);else for(c=0;c<a.length;c++)b=a[c],b.deleteParameter("texture_lightMap"),
        b.deleteParameter("texture_dirLightMap"),b._shaderDefs&=~pc.SHADERDEF_LM,d=b.mask,b.mask=(d|pc.MASK_DYNAMIC)&~(pc.MASK_BAKED|pc.MASK_LIGHTMAP)},onSetLightmapSizeMultiplier:function(a,b,c){this.data.lightmapSizeMultiplier=c},onSetIsStatic:function(a,b,c){if(this.data.model){var d=this.data.model.meshInstances;for(a=0;a<d.length;a++)b=d[a],b.isStatic=c}},onSetLayers:function(a,b,c){if(this.meshInstances){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&d.removeMeshInstances(this.meshInstances);
        if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addMeshInstances(this.meshInstances)}},onLayersChanged:function(a,b){this.addModelToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||a.addMeshInstances(this.meshInstances)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||
    a.removeMeshInstances(this.meshInstances)},onSetBatchGroupId:function(a,b,c){0<=b&&this.system.app.batcher._markGroupDirty(b);0<=c&&this.system.app.batcher._markGroupDirty(c);0>c&&0<=b&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},onSetModel:function(a,b,c){b&&(this.removeModelFromLayers(b),this.entity.removeChild(b.getGraph()),delete b._entity,this._clonedModel&&(b.destroy(),this._clonedModel=!1));if(c){a=this.data;b=c.meshInstances;for(var d=0;d<b.length;d++)b[d].castShadow=a.castShadows,
        b[d].receiveShadow=a.receiveShadows;this.lightmapped=a.lightmapped;this.isStatic=a.isStatic;this.entity.addChild(c.graph);this.enabled&&this.entity.enabled&&this.addModelToLayers();c._entity=this.entity;this.entity.animation&&this.entity.animation.setModel(c);"asset"===this.data.type?this.mapping=this.data.mapping:this._unsetMaterialEvents()}else this._unsetMaterialEvents()},_onMaterialAssetRemove:function(a){var b=this.system.app.assets,c=isNaN(a)?a.id:a;a&&isNaN(a)&&a.resource===this.material&&
    (this.material=pc.ModelHandler.DEFAULT_MATERIAL);b.off("add:"+c,this._onMaterialAssetAdd,this);b.off("load:"+c,this._onMaterialAssetLoad,this);b.off("unload:"+c,this._onMaterialAssetUnload,this);b.off("remove:"+c,this._onMaterialAssetRemove,this)},_onMaterialAssetAdd:function(a){var b=this.system.app.assets;a.resource?(this.material=a.resource,this._dirtyMaterialAsset=!1):this.enabled&&this.entity.enabled&&(this._dirtyMaterialAsset=!1,b.load(a))},_onMaterialAssetLoad:function(a){var b=this.system.app.assets;
        a.resource?(this.material=a.resource,this._dirtyMaterialAsset=!1):this.enabled&&this.entity.enabled&&(this._dirtyMaterialAsset=!1,b.load(a))},_onMaterialAssetUnload:function(a){a&&isNaN(a)&&a.resource===this.material&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL)},setMaterialAsset:function(a){this._dirtyMaterialAsset=!0;a="number"!==typeof a&&a?a.id:a;var b=this.system.app.assets;this.data.materialAsset!==a&&(this.data.materialAsset&&this._onMaterialAssetRemove(this.data.materialAsset),a&&(b.on("load:"+
        a,this._onMaterialAssetLoad,this),b.on("unload:"+a,this._onMaterialAssetUnload,this),b.on("remove:"+a,this._onMaterialAssetRemove,this)));if(void 0!==a&&null!==a){var c=b.get(a);c&&this._onMaterialAssetLoad(c);b.once("add:"+a,this._onMaterialAssetAdd,this)}else null===a&&(this.material=pc.ModelHandler.DEFAULT_MATERIAL,this._dirtyMaterialAsset=!1);b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.app.assets.get(this.data.materialAsset)},
        onSetMaterial:function(a,b,c){if(c!==b&&(this.data.material=c,this.data.model&&"asset"!==this.data.type))for(a=this.data.model.meshInstances,b=0;b<a.length;b++)a[b].material=c},onSetMapping:function(a,b,c){if("asset"===this.data.type&&this.data.model){this._unsetMaterialEvents();c||(c={});a=this.data.model.meshInstances;b=(b=this.asset?this.system.app.assets.get(this.asset):null)?b.data.mapping:null;for(var d=0,f=a.length;d<f;d++)void 0!==c[d]?c[d]?this._loadAndSetMeshInstanceMaterial(c[d],a[d],d):
            a[d].material=pc.ModelHandler.DEFAULT_MATERIAL:b&&(b[d]&&(b[d].material||b[d].path)?this._loadAndSetMeshInstanceMaterial(b[d].material||b[d].path,a[d],d):a[d].material=pc.ModelHandler.DEFAULT_MATERIAL)}},_setMaterialEvent:function(a,b,c,d){b=b+":"+c;this.system.app.assets.on(b,d,this);this._materialEvents||(this._materialEvents=[]);this._materialEvents[a]||(this._materialEvents[a]={});this._materialEvents[a][b]={id:c,handler:d}},_unsetMaterialEvents:function(){var a=this.system.app.assets,b=this._materialEvents;
            if(b){for(var c=0,d=b.length;c<d;c++)if(b[c]){var f=b[c],e;for(e in f)a.off(e,f[e].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(a){var b=null;isNaN(parseInt(a,10))?this.asset&&(a=this._getMaterialAssetUrl(a))&&(b=this.system.app.assets.getByUrl(a)):b=this.system.app.assets.get(a);return b},_getMaterialAssetUrl:function(a){if(!this.asset)return null;var b=this.system.app.assets.get(this.asset);if(!b)return null;b=b.getFileUrl();b=pc.path.getDirectory(b);return pc.path.join(b,
            a)},_loadAndSetMeshInstanceMaterial:function(a,b,c){var d=this,f=this.system.app.assets,e=this._getAssetByIdOrPath(a);if(e){var k=function(a){a.resource?(b.material=a.resource,d._setMaterialEvent(c,"remove",a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})):(d._setMaterialEvent(c,"load",a.id,function(a){b.material=a.resource;d._setMaterialEvent(c,"remove",a.id,function(){b.material=pc.ModelHandler.DEFAULT_MATERIAL})}),d.enabled&&d.entity.enabled&&f.load(a))};e?k(e):(b.material=pc.ModelHandler.DEFAULT_MATERIAL,
            e=isNaN(parseInt(a,10)),d._setMaterialEvent(c,e?"add:url":"add",a,k))}},onSetReceiveShadows:function(a,b,c){if(void 0!==c&&(a=this.data,a.model))for(a=a.model.meshInstances,b=0;b<a.length;b++)a[b].receiveShadow=c},onEnable:function(){e._super.onEnable.call(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));var a,b="asset"===
            this.data.type;if(this.data.model)this.addModelToLayers();else if(b&&this._dirtyModelAsset){a=this.data.asset;if(!a)return;(a=this.system.app.assets.get(a))&&this._onModelAsset(a)}this._dirtyMaterialAsset&&(a=this.data.materialAsset)&&(a=this.system.app.assets.get(a))&&!a.resource&&this._onMaterialAssetLoad(a);if(b&&(b=this.data.mapping))for(var c in b)b[c]&&(a=this._getAssetByIdOrPath(b[c]))&&!a.resource&&this.system.app.assets.load(a)},onDisable:function(){e._super.onDisable.call(this);this.system.app.scene.off("set:layers",
            this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&this.removeModelFromLayers(this.model)},hide:function(){var a=this.data.model;if(a){var b,c=a.meshInstances,a=0;for(b=c.length;a<b;a++)c[a].visible=!1}},show:function(){var a=this.data.model;if(a){var b,c=a.meshInstances,a=0;for(b=c.length;a<b;a++)c[a].visible=!0}}});Object.defineProperty(e.prototype,
        "meshInstances",{get:function(){return this.model?this.model.meshInstances:null},set:function(a){this.model&&(this.model.meshInstances=a)}});return{ModelComponent:e}}());pc.extend(pc,function(){var e="enabled type asset materialAsset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier isStatic material model layers batchGroupId mapping".split(" "),a=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.ModelComponent;this.DataType=pc.ModelComponentData;this.schema=e;a=a.graphicsDevice;this.box=pc.createBox(a,{halfExtents:new pc.Vec3(.5,.5,.5)});
        this.capsule=pc.createCapsule(a,{radius:.5,height:2});this.sphere=pc.createSphere(a,{radius:.5});this.cone=pc.createCone(a,{baseRadius:.5,peakRadius:0,height:1});this.cylinder=pc.createCylinder(a,{radius:.5,height:1});this.plane=pc.createPlane(a,{halfExtents:new pc.Vec2(.5,.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new pc.StandardMaterial;this.on("beforeremove",this.onRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ModelComponent.prototype,e);pc.extend(a.prototype,
        {initializeComponentData:function(b,c,d){d="enabled material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" ");for(var f={},e,k=0;k<d.length;k++)e=d[k],f[e]=c[e];f.material=this.defaultMaterial;if(null===f.batchGroupId||void 0===f.batchGroupId)f.batchGroupId=-1;f.layers&&"array"===pc.type(f.layers)&&(f.layers=f.layers.slice(0));a._super.initializeComponentData.call(this,b,f,d)},removeComponent:function(b){var c=
            b.model.data;b.model.asset=null;"asset"!==c.type&&c.model&&(b.model.removeModelFromLayers(b.model.model),b.removeChild(c.model.getGraph()),c.model=null);a._super.removeComponent.call(this,b)},cloneComponent:function(a,c){var d={type:a.model.type,asset:a.model.asset,castShadows:a.model.castShadows,receiveShadows:a.model.receiveShadows,castShadowsLightmap:a.model.castShadowsLightmap,lightmapped:a.model.lightmapped,lightmapSizeMultiplier:a.model.lightmapSizeMultiplier,isStatic:a.model.isStatic,enabled:a.model.enabled,
            layers:a.model.layers,batchGroupId:a.model.batchGroupId,mapping:pc.extend({},a.model.mapping)},f=a.model.materialAsset;f instanceof pc.Asset||null==f||(f=this.app.assets.get(f));var e=a.model.material;e&&e!==pc.ModelHandler.DEFAULT_MATERIAL&&f&&e!==f.resource||(d.materialAsset=f);f=this.addComponent(c,d);a.model.model&&"asset"===a.model.type&&!a.model.asset&&(f.model=a.model.model.clone(),f._clonedModel=!0);d.materialAsset||(f.material=e);if(a.model.model)for(d=a.model.model.meshInstances,e=f.model.meshInstances,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                f=0;f<d.length;f++)e[f].mask=d[f].mask,e[f].material=d[f].material,e[f].layer=d[f].layer,e[f].receiveShadow=d[f].receiveShadow},onRemove:function(a,c){a.model.materialAsset=null;c.remove()}});return{ModelComponentSystem:a}}());pc.extend(pc,function(){return{ModelComponentData:pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.receiveShadows=this.castShadows=!0;this.mapping=this.materialAsset=null;this.castShadowsLightmap=!0;this.lightmapped=!1;this.lightmapSizeMultiplier=1;this.isStatic=!1;this.layers=[pc.LAYERID_WORLD];this.batchGroupId=-1;this.model=this.material=null},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_aspectRatioMode",this.onSetAspectRatioMode,this);this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",
        this.onSetPriority,this);this.on("set_clearColorBuffer",this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_clearStencilBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this);this.on("set_scissorRect",this.onSetScissorRect,this);this.on("set_horizontalFov",this.onSetHorizontalFov,this);this.on("set_frustumCulling",this.onSetFrustumCulling,this);this.on("set_calculateTransform",
        this.onSetCalculateTransform,this);this.on("set_calculateProjection",this.onSetCalculateProjection,this);this.on("set_cullFaces",this.onSetCullFaces,this);this.on("set_flipFaces",this.onSetFlipFaces,this);this.on("set_layers",this.onSetLayers,this)},e=pc.inherits(e,pc.Component);Object.defineProperty(e.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(e.prototype,"viewMatrix",{get:function(){return this.data.camera._node.getWorldTransform().clone().invert()}});
        Object.defineProperty(e.prototype,"frustum",{get:function(){return this.data.camera.frustum}});Object.defineProperty(e.prototype,"vrDisplay",{get:function(){return this.data.camera.vrDisplay},set:function(a){if(this.data.camera.vrDisplay=a)a._camera=this.data.camera}});Object.defineProperty(e.prototype,"node",{get:function(){return this.data.camera._node}});pc.extend(e.prototype,{screenToWorld:function(a,b,c,d){var f=this.system.app.graphicsDevice;return this.data.camera.screenToWorld(a,b,c,f.clientRect.width,
            f.clientRect.height,d)},worldToScreen:function(a,b){var c=this.system.app.graphicsDevice;return this.data.camera.worldToScreen(a,c.clientRect.width,c.clientRect.height,b)},onSetAspectRatioMode:function(a,b,c){this.data.camera.aspectRatioMode=c},onSetAspectRatio:function(a,b,c){this.data.camera.aspectRatio=c},onSetCamera:function(a,b,c){b&&(b._node=null);c._node=this.entity},onSetClearColor:function(a,b,c){this.data.camera.clearColor[0]=c.data[0];this.data.camera.clearColor[1]=c.data[1];this.data.camera.clearColor[2]=
            c.data[2];this.data.camera.clearColor[3]=c.data[3]},onSetFov:function(a,b,c){this.data.camera.fov=c},onSetOrthoHeight:function(a,b,c){this.data.camera.orthoHeight=c},onSetNearClip:function(a,b,c){this.data.camera.nearClip=c},onSetFarClip:function(a,b,c){this.data.camera.farClip=c},onSetHorizontalFov:function(a,b,c){this.data.camera.horizontalFov=c},onSetFrustumCulling:function(a,b,c){this.data.camera.frustumCulling=c},onSetCalculateTransform:function(a,b,c){this._calculateTransform=c;this.camera.overrideCalculateTransform=
            !!c},onSetCalculateProjection:function(a,b,c){this._calculateProjection=c;this.camera._projMatDirty=!0;this.camera.overrideCalculateProjection=!!c},onSetCullFaces:function(a,b,c){this.camera._cullFaces=c},onSetFlipFaces:function(a,b,c){this.camera._flipFaces=c},onSetProjection:function(a,b,c){this.data.camera.projection=c},onSetPriority:function(a,b,c){for(b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a._sortCameras()},onSetLayers:function(a,b,c){var d;
            for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&d.removeCamera(this);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addCamera(this)},addCameraToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addCamera(this)},removeCameraFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&
        a.removeCamera(this)},onLayersChanged:function(a,b){this.addCameraToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||a.addCamera(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeCamera(this)},updateClearFlags:function(){var a=0;this.clearColorBuffer&&(a|=pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&(a|=pc.CLEARFLAG_DEPTH);
            this.clearStencilBuffer&&(a|=pc.CLEARFLAG_STENCIL);this.data.camera.clearFlags=a},onSetRenderTarget:function(a,b,c){this.data.camera.renderTarget=c},onSetRect:function(a,b,c){this.data.camera.setRect(c.data[0],c.data[1],c.data[2],c.data[3])},onSetScissorRect:function(a,b,c){this.data.camera.setScissorRect(c.data[0],c.data[1],c.data[2],c.data[3])},onEnable:function(){e._super.onEnable.call(this);this.system.addCamera(this);this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&
        (this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addCameraToLayers();this.postEffects.enable()},onDisable:function(){e._super.onDisable.call(this);this.postEffects.disable();this.removeCameraFromLayers();this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",
            this.onLayerRemoved,this));this.system.removeCamera(this)},calculateAspectRatio:function(a){a=a?a:this.system.app.graphicsDevice;var b=this.rect;return a.width*b.z/(a.height*b.w)},frameBegin:function(a){this.aspectRatioMode===pc.ASPECT_AUTO&&(this.aspectRatio=this.calculateAspectRatio(a));this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1},enterVr:function(a,b){a instanceof Function&&!b&&(b=a,a=null);if(this.system.app.vr)if(a||(a=this.system.app.vr.display),a){var c=this;a.capabilities.canPresent?
            a.requestPresent(function(d){d||(c.vrDisplay=a,c.vrDisplay.once("beforepresentchange",function(a){a.presenting||(c.vrDisplay=null)}));b(d)}):(c.vrDisplay=a,b())}else b("No pc.VrDisplay to present");else b("VrManager not created. Enable VR in project settings.")},exitVr:function(a){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var b=this.vrDisplay;this.vrDisplay=null;b.exitPresent(a)}else this.vrDisplay=null,a();else a("Not presenting VR")}});return{CameraComponent:e}}());pc.extend(pc,function(){var e="enabled clearColorBuffer clearColor clearDepthBuffer clearStencilBuffer frustumCulling projection fov orthoHeight nearClip farClip priority rect scissorRect camera aspectRatio aspectRatioMode horizontalFov model renderTarget calculateTransform calculateProjection cullFaces flipFaces layers".split(" "),a=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.CameraComponent;
        this.DataType=pc.CameraComponentData;this.schema=e;this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.CameraComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){d="postEffects enabled model camera aspectRatio aspectRatioMode horizontalFov renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer clearStencilBuffer frustumCulling rect scissorRect calculateTransform calculateProjection cullFaces flipFaces layers".split(" ");
        var f={};d.forEach(function(a){f[a]=c[a]});f.layers&&"array"===pc.type(f.layers)&&(f.layers=f.layers.slice(0));if(f.clearColor&&"array"===pc.type(f.clearColor)){var e=f.clearColor;f.clearColor=new pc.Color(e[0],e[1],e[2],e[3])}f.rect&&"array"===pc.type(f.rect)&&(e=f.rect,f.rect=new pc.Vec4(e[0],e[1],e[2],e[3]));f.scissorRect&&"array"===pc.type(f.scissorRect)&&(e=f.scissorRect,f.scissorRect=new pc.Vec4(e[0],e[1],e[2],e[3]));f.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),
            f.enabled=f.activate);f.camera=new pc.Camera;f._node=b.entity;f.camera._component=b;f.camera.calculateTransform=function(a,c){return b._calculateTransform?b._calculateTransform(a,c):null};f.camera.calculateProjection=function(a,c){return b._calculateProjection?b._calculateProjection(a,c):null};f.postEffects=new pc.PostEffectQueue(this.app,b);a._super.initializeComponentData.call(this,b,f,d)},onBeforeRemove:function(a,c){this.removeCamera(c)},onRemove:function(a,c){c.camera=null},onUpdate:function(a){a=
        this.store;var c,d,f,e;if(this.app.vr)for(var k in a)c=a[k],d=c.data,f=d.camera,e=f.vrDisplay,d.enabled&&c.entity.enabled&&e&&(e.setClipPlanes(f._nearClip,f._farClip),f._node&&(f._node.localTransform.copy(e.combinedViewInv),f._node._dirtyLocal=!1,f._node._dirtify()))},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority()},removeCamera:function(a){a=this.cameras.indexOf(a);0<=a&&(this.cameras.splice(a,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            c){return a.priority-c.priority})}});return{CameraComponentSystem:a}}());pc.extend(pc,function(){return{CameraComponentData:pc.inherits(function(){this.clearColor=new pc.Color(.722,.722,.722,1);this.clearStencilBuffer=this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.PROJECTION_PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.scissorRect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.frustumCulling=!1;this.cullFaces=!0;this.flipFaces=!1;this.layers=[pc.LAYERID_WORLD,pc.LAYERID_DEPTH,
        pc.LAYERID_SKYBOX,pc.LAYERID_UI,pc.LAYERID_IMMEDIATE];this.camera=null;this.aspectRatio=16/9;this.aspectRatioMode=pc.ASPECT_AUTO;this.postEffects=this.renderTarget=null;this.isRendering=!1;this.calculateProjection=this.calculateTransform=null},pc.ComponentData)}}());pc.extend(pc,function(){function e(a,b){var c=this;this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;this.resizeLast=0;this._resizeTimeoutCallback=function(){c.resizeRenderTargets()};b.on("set_rect",this.onCameraRectChanged,this)}e.prototype={_createOffscreenTarget:function(a,b){var c=this.camera.rect,d=Math.floor(c.z*this.app.graphicsDevice.width*this.renderTargetScale),c=Math.floor(c.w*this.app.graphicsDevice.height*this.renderTargetScale),
        f=this.app.graphicsDevice,e=b?f.getHdrFormat():pc.PIXELFORMAT_R8_G8_B8_A8,d=new pc.Texture(f,{format:e,width:d,height:c});d.minFilter=pc.FILTER_NEAREST;d.magFilter=pc.FILTER_NEAREST;d.addressU=pc.ADDRESS_CLAMP_TO_EDGE;d.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return new pc.RenderTarget(this.app.graphicsDevice,d,{depth:a})},_resizeOffscreenTarget:function(a){var b=this.camera.rect,c=Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale),b=Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale),
        d=this.app.graphicsDevice,f=a.colorBuffer.format;a._colorBuffer.destroy();c=new pc.Texture(d,{format:f,width:c,height:b});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a._colorBuffer=c;a.destroy()},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=this.effects;a={effect:a,inputTarget:this._createOffscreenTarget(0===this.effects.length,a.hdr),outputTarget:null};
        if(!this.layer){this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var a=0;a<this._commandList.length;a++)this._commandList[a]()}});var c=this.app.scene.layers.layerList,d=0,f,e=c.length-1;for(f=e;0<=f;f--)if(c[f].id===pc.LAYERID_UI){e=f-1;c[f].overrideClear=!0;c[f].clearColorBuffer=!1;c[f].clearDepthBuffer=this.camera.clearDepthBuffer;c[f].clearStencilBuffer=
            this.camera.clearStencilBuffer;break}for(f=e;0<=f;f--)0<=c[f].cameras.indexOf(this.camera)&&(0===d&&(d=f+1),c[f].renderTarget=a.inputTarget);this.app.scene.layers.insertOpaque(this.layer,d);this.layer._commandList=[];this.layer.isPostEffect=!0}b.push(a);c=b.length;1<c&&(b[c-2].outputTarget=a.inputTarget);this.enable()},removeEffect:function(a){for(var b=-1,c=0,d=this.effects.length;c<d;c++)if(this.effects[c].effect===a){b=c;break}0<=b&&(0<b?this.effects[b-1].outputTarget=b+1<this.effects.length?this.effects[b+
    1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));this.enabled&&a.needsDepthBuffer&&this.camera.releaseDepthMap();0===this.effects.length&&this.disable()},requestDepthMap:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&
    this.camera.camera.requestDepthMap()},releaseDepthMap:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].effect.needsDepthBuffer&&this.camera.releaseDepthMap()},destroy:function(){for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this;this.requestDepthMap();this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);this.command=
        function(){if(a.enabled){var b=null,c=a.effects.length;if(c){a.layer.renderTarget=a.effects[0].inputTarget;for(var d=0;d<c;d++){var f=a.effects[d];d===c-1&&(b=a.camera.rect);f.effect.render(f.inputTarget,f.outputTarget,b)}}}};this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this.camera.renderTarget=null;this.releaseDepthMap();var a=this.layer._commandList.indexOf(this.command);0<=
    a&&this.layer._commandList.splice(a,1)}},_onCanvasResized:function(a,b){var c=this.camera.rect,d=this.app.graphicsDevice;this.camera.camera.aspectRatio=d.width*c.z/(d.height*c.w);this.resizeTimeout||(100<pc.now()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null);this.resizeLast=pc.now();for(var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*
        this.renderTargetScale),a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale),c=this.effects,d=0,f=c.length;d<f;d++){var e=c[d];e.inputTarget.width===b&&e.inputTarget.height===a||this._resizeOffscreenTarget(e.inputTarget)}},onCameraRectChanged:function(a,b,c){this.enabled&&this.resizeRenderTargets()}};return{PostEffectQueue:e}}());pc.extend(pc,function(){function e(e,h){this.app=e;this.srcRenderTarget=h.srcRenderTarget;this.hdr=h.hdr;this.blending=h.blending;this.shader=h.shader;this.setup=h.setup;var m=this,n=e.graphicsDevice;this.layer=new pc.Layer({opaqueSortMode:pc.SORTMODE_NONE,transparentSortMode:pc.SORTMODE_NONE,passThrough:!0,name:h.name,onPostRender:function(){m.srcRenderTarget?(d.x=m.srcRenderTarget.width,d.y=m.srcRenderTarget.height,d.z=1/m.srcRenderTarget.width,d.w=1/m.srcRenderTarget.height):(d.x=n.width,d.y=n.height,
        d.z=1/n.width,d.w=1/n.height);c.setValue(d.data);if(this._postEffectCombined&&0>this._postEffectCombined)m.setup&&m.setup(n,m,d,null,this.renderTarget);else{var f;f=this._postEffectCombinedSrc?this._postEffectCombinedSrc:m.srcRenderTarget?m.srcRenderTarget:a[this._backbufferRtId];1<f._samples&&f.resolve(!0,!1);var g=f._colorBuffer;g.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?pc.FILTER_LINEAR:pc.FILTER_NEAREST;b.setValue(g);m.setup&&m.setup(n,
        m,d,f,this.renderTarget);(f=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&pc.drawQuadWithShader(n,this.renderTarget,f,null,null,m.blending);if(!m.srcRenderTarget)for(f=e.scene.layers.layerList,g=0;g<f.length&&f[g]!==m.layer;g++)if(f[g].renderTarget===a[0]||f[g].renderTarget===a[1])f[g].renderTarget=null}}});this.layer._generateCameraHash();this.layer.isPostEffect=!0;this.layer.unmodifiedUvs=h.unmodifiedUvs;this.layer.postEffectBilinear=h.bilinear;this.layer.postEffect=
        this;this.layer.shader=h.shader;this.layer.renderTarget=h.destRenderTarget;if(!b){b=n.scope.resolve("uColorBuffer");c=n.scope.resolve("uScreenSize");for(var E=n.supportsMsaa?4:1,H=0;2>H;H++)a[H]=new pc.RenderTarget({depth:!0,stencil:n.supportsStencil,samples:E,autoResolve:!1}),a[H].name="backbuffer"+H;e.on("prerender",function(){var b=e.scene.layers.layerList,c,d,h=0,m=0;l=k=g=!1;var G=pc.PIXELFORMAT_R8_G8_B8_A8;if(e.scene.layers._dirty){var E=0;d=!1;var I,H;for(c=0;c<b.length;c++){d=!1;var K;if((K=
            b[c].isPostEffect)&&!(K=0===E)&&(K=b[c].unmodifiedUvs&&b[c].shader)){a:{K=b;var M=f,O=E,P=F(b[c].shader.definition.fshader);if(0!==P.length)for(var ba=void 0,L=H=I=void 0,V=void 0,ba=0;ba<O;ba++)for(I=0;I<P.length;I++)for(V=P[I],L=F(K[M[ba]].shader.definition.fshader),H=0;H<L.length;H++)if(L[H]===V){K=!0;break a}K=!1}K=!K}K?(f[E]=c,E++,c===b.length-1&&(d=!0)):0<E&&(d=!0);if(d){if(1<E){K="post_";for(d=0;d<E;d++)M=b[f[d]],K+=M.name?M.name:M.id,d<E-1&&(K+="_");M=n.programLib._cache[K];if(!M){O="vec4 shaderOutput;\n";
        P="void main() {\n";ba=[];for(d=0;d<E;d++){M=b[f[d]].shader.definition.fshader+"\n";M=M.replace(x,"//").replace(y,"//").replace(w,"//").replace(u,"shaderOutput");0<d&&(M=M.replace(v,"//").replace(z,"//").replace(A,"shaderOutput;//"));var N=M=M.replace(D,"void main"+d);I=ba;var fa=N.length,V=void 0,ca=0,da=V=0,ga=0,L="",V=H=void 0;for(H=0;H<fa;H++)V=N.charAt(H),"{"===V?(0===da&&(ca=H),da++):"}"===V&&(1===da&&(V=H,L+=N.substr(ga,ca-ga+1),ga=V),da--);L+=N.substr(ga,N.length-ga+1);N=null;da=L.match(r)||
            [];ca=fa=void 0;for(H=0;H<da.length;H++)for(fa=da[H].split(","),V=0;V<fa.length;V++)ca=fa[V].replace(p,"").trim(),0<=I.indexOf(ca)?(N||(N=[]),N.push(ca)):I.push(ca);L=L.match(q)||[];ca=void 0;for(H=0;H<L.length;H++)for(fa=L[H].split(","),V=0;V<fa.length;V++)ca=fa[V].replace(t,"").trim(),ca=I.indexOf(ca),0<=ca&&I.splice(ca,1);if(I=N)for(H=0;H<I.length;H++)M=M.replace(new RegExp("\\b"+I[H]+"\\b","g"),I[H]+"NNNN"+d);O+=M;P+="main"+d+"();\n"}P+="gl_FragColor = shaderOutput;\n}\n";M=pc.shaderChunks.createShaderFromCode(n,
            pc.shaderChunks.fullscreenQuadVS,O+P,K)}for(d=0;d<E;d++)b[f[d]]._postEffectCombined=d===E-1?1:-1;b[f[E-1]]._postEffectCombinedShader=M;b[f[E-1]]._postEffectCombinedBilinear=b[f[0]].postEffectBilinear;b[f[E-1]]._postEffectCombinedSrc=b[f[0]].postEffect.srcRenderTarget}f[0]=c;E=1}}}for(c=0;c<b.length;c++){if(b[c].isPostEffect&&(!b[c].postEffect.srcRenderTarget&&!b[c]._postEffectCombined||!b[c].postEffect._postEffectCombinedSrc&&0<=b[c]._postEffectCombined)){for(d=c-1;d>=h;d--)b[d].renderTarget||(b[d].renderTarget=
        a[m]);b[c]._backbufferRtId=m;h=c;g=!0;1===m&&(k=!0);b[c].postEffect.hdr&&(G=n.webgl2&&n.extTextureFloatRenderable?pc.PIXELFORMAT_111110F:n.extTextureHalfFloatLinear&&n.extTextureHalfFloatRenderable?pc.PIXELFORMAT_RGBA16F:pc.PIXELFORMAT_R8_G8_B8_A8);b[c].postEffect.shader&&!b[c].renderTarget&&(m=1-m)}else b[c].isPostEffect||b[c].renderTarget||!g||(b[c].renderTarget=a[m]);b[c].isPostEffect&&!b[c].renderTarget&&(l=!0)}if(g)if(!a[0].colorBuffer)B(0,n,G);else if(a[0].width!==n.width||a[0].height!==n.height||
        a[0]._colorBuffer._format!==G)a[0].colorBuffer.destroy(),a[0].destroy(),B(0,n,G);if(k)if(!a[1].colorBuffer)B(1,n,G);else if(a[1].width!==n.width||a[1].height!==n.height||a[1]._colorBuffer._format!==G)a[1].colorBuffer.destroy(),a[1].destroy(),B(1,n,G)},this);e.on("postrender",function(){var b=e.graphicsDevice;if(g&&!l){for(var c=e.scene.layers.layerList,d,f=c.length-1;0<=f&&(d=c[f].renderTarget,d!==a[0]&&d!==a[1]);f--);d&&(1<d._samples&&d.resolve(!0,!1),b.copyRenderTarget(d,null,!0,!1))}},this)}}var a=
            [null,null],b=null,c,d=new pc.Vec4,f=[],g=!1,k=!1,l=!1,m=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*\;/g,n=/\S+[ \t\n\r]*\;/,h=/[ \t\n\r]*\;/,r=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,p=/(float|int|bool|vec2|vec3|vec4|struct|\,|\;|\{|\})/g,q=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^\;]+[ \t\n\r]*\,*)+\;/g,t=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|\,|\;|\{|\})/g,x=/#version/g,y=/out highp vec4 pc_fragColor;/g,
        w=/#define gl_FragColor/g,u=/gl_FragColor/g,v=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,z=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,A=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,D=/void[ \t\n\r]+main/g,B=function(b,c,d){c=new pc.Texture(c,{format:d,width:c.width,height:c.height});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a[b]._colorBuffer=c},F=function(a){a=a.match(m)||[];for(var b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            c,d=[],f=0;f<a.length;f++)b=a[f].search(n),c=a[f].search(h),b=a[f].substr(b,c-b),"uColorBuffer"!==b&&d.push(b);return d};e.prototype.addToComposition=function(a){this.app.scene.layers.insertTransparent(this.layer,a)};return{PostEffectPass:e}}());pc.extend(pc,function(){var e=function(a,b){this._cookieAssetId=this._cookieAsset=null;this._cookieAssetAdd=!1;this._cookieMatrix=null},e=pc.inherits(e,pc.Component),a=[],b=[],c=function(c,f,g,k){var l=e.prototype;a.push(c);b.push(f);Object.defineProperty(l,c,{get:function(){return this.data[c]},set:function(a){var b=this.data,f=b[c];if(k||f!==a)b[c]=a,g&&g.call(this,a,f)},configurable:!0})};(function(){c("enabled",!0,function(a,b){this.onSetEnabled(null,b,a)});c("light",null);c("type","directional",
        function(a,b){this.system.changeType(this,b,a);this.refreshProperties()});c("color",new pc.Color(1,1,1),function(a,b){this.light.setColor(a)},!0);c("intensity",1,function(a,b){this.light.intensity=a});c("castShadows",!1,function(a,b){this.light.castShadows=a});c("shadowDistance",40,function(a,b){this.light.shadowDistance=a});c("shadowResolution",1024,function(a,b){this.light.shadowResolution=a});c("shadowBias",.05,function(a,b){this.light.shadowBias=-.01*a});c("normalOffsetBias",0,function(a,b){this.light.normalOffsetBias=
        a});c("range",10,function(a,b){this.light.attenuationEnd=a});c("innerConeAngle",40,function(a,b){this.light.innerConeAngle=a});c("outerConeAngle",45,function(a,b){this.light.outerConeAngle=a});c("falloffMode",pc.LIGHTFALLOFF_LINEAR,function(a,b){this.light.falloffMode=a});c("shadowType",pc.SHADOW_PCF3,function(a,b){this.light.shadowType=a});c("vsmBlurSize",11,function(a,b){this.light.vsmBlurSize=a});c("vsmBlurMode",pc.BLUR_GAUSSIAN,function(a,b){this.light.vsmBlurMode=a});c("vsmBias",.0025,function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                b){this.light.vsmBias=a});c("cookieAsset",null,function(a,b){if(!this._cookieAssetId||!(a instanceof pc.Asset&&a.id===this._cookieAssetId||a===this._cookieAssetId))if(this.onCookieAssetRemove(),this._cookieAssetId=null,a instanceof pc.Asset)this._cookieAssetId=this.data.cookieAsset=a.id,this.onCookieAssetAdd(a);else if("number"===typeof a){this._cookieAssetId=a;var c=this.system.app.assets.get(a);if(c)this.onCookieAssetAdd(c);else this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,
        this.onCookieAssetAdd,this)}});c("cookie",null,function(a,b){this.light.cookie=a});c("cookieIntensity",1,function(a,b){this.light.cookieIntensity=a});c("cookieFalloff",!0,function(a,b){this.light.cookieFalloff=a});c("cookieChannel","rgb",function(a,b){this.light.cookieChannel=a});c("cookieAngle",0,function(a,b){if(0!==a||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);var c=1,e=1;this.cookieScale&&(c=this.cookieScale.x,e=this.cookieScale.y);var l=Math.cos(a*pc.math.DEG_TO_RAD),
        m=Math.sin(a*pc.math.DEG_TO_RAD);this._cookieMatrix.set(l/c,-m/c,m/e,l/e);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null});c("cookieScale",null,function(a,b){if(null!==a||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new pc.Vec4);var c=a.x,e=a.y,l=Math.cos(this.cookieAngle*pc.math.DEG_TO_RAD),m=Math.sin(this.cookieAngle*pc.math.DEG_TO_RAD);this._cookieMatrix.set(l/c,-m/c,m/e,l/e);this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=
        null},!0);c("cookieOffset",null,function(a,b){this.light.cookieOffset=a},!0);c("shadowUpdateMode",pc.SHADOWUPDATE_REALTIME,function(a,b){this.light.shadowUpdateMode=a});c("mask",1,function(a,b){this.light.mask=a});c("affectDynamic",!0,function(a,b){this.light.mask=a?this.light.mask|pc.MASK_DYNAMIC:this.light.mask&~pc.MASK_DYNAMIC;this.light.mask=this.light._mask});c("affectLightmapped",!1,function(a,b){a?(this.light.mask|=pc.MASK_BAKED,this.bake&&(this.light.mask&=~pc.MASK_LIGHTMAP)):(this.light.mask&=
        ~pc.MASK_BAKED,this.bake&&(this.light.mask|=pc.MASK_LIGHTMAP));this.light.mask=this.light._mask});c("bake",!1,function(a,b){a?(this.light.mask|=pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask&=~pc.MASK_BAKED)):(this.light.mask&=~pc.MASK_LIGHTMAP,this.affectLightmapped&&(this.light.mask|=pc.MASK_BAKED));this.light.mask=this.light._mask});c("bakeDir",!0,function(a,b){this.light.bakeDir=a});c("isStatic",!1,function(a,b){this.light.isStatic=a});c("layers",[pc.LAYERID_WORLD],function(a,b){var c,
        e;for(c=0;c<b.length;c++)(e=this.system.app.scene.layers.getLayerById(b[c]))&&e.removeLight(this);for(c=0;c<a.length;c++)(e=this.system.app.scene.layers.getLayerById(a[c]))&&this.enabled&&this.entity.enabled&&e.addLight(this)})})();Object.defineProperty(e.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");
        this.enabled=a}});pc.extend(e.prototype,{addLightToLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.addLight(this)},removeLightFromLayers:function(){for(var a,b=0;b<this.layers.length;b++)(a=this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeLight(this)},onLayersChanged:function(a,b){this.enabled&&this.entity.enabled&&this.addLightToLayers();a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,
        this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this.enabled&&this.entity.enabled&&a.addLight(this)},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||a.removeLight(this)},refreshProperties:function(){for(var b,c=0;c<a.length;c++)b=a[c],this[b]=this[b];if(this.enabled&&this.entity.enabled)this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var a=!1;"cubemap"!==
    this._cookieAsset.type||this._cookieAsset.loadFaces||(a=this._cookieAsset.loadFaces=!0);this._cookieAsset.resource&&!a||this.system.app.assets.load(this._cookieAsset);if(this._cookieAsset.resource)this.onCookieAssetLoad()},onCookieAssetAdd:function(a){if(this._cookieAssetId===a.id){this._cookieAsset=a;if(this.light._enabled)this.onCookieAssetSet();this._cookieAsset.on("load",this.onCookieAssetLoad,this);this._cookieAsset.on("remove",this.onCookieAssetRemove,this)}},onCookieAssetLoad:function(){this._cookieAsset&&
    this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){e._super.onEnable.call(this);this.light.enabled=
        !0;this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&this.addLightToLayers();if(this._cookieAsset&&!this.cookie)this.onCookieAssetSet()},onDisable:function(){e._super.onDisable.call(this);this.light.enabled=!1;this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&
    (this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.removeLightFromLayers()}});return{LightComponent:e,_lightProps:a,_lightPropsDefault:b}}());pc.extend(pc,function(){var e={directional:pc.LIGHTTYPE_DIRECTIONAL,point:pc.LIGHTTYPE_POINT,spot:pc.LIGHTTYPE_SPOT},a=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.LightComponent;this.DataType=pc.LightComponentData},a=pc.inherits(a,pc.ComponentSystem);pc.extend(a.prototype,{initializeComponentData:function(b,c){for(var d={},f=pc._lightProps,g,k=0;k<f.length;k++)g=f[k],d[g]=c[g];d.type||(d.type=b.data.type);b.data.type=
        d.type;d.layers&&"array"===pc.type(d.layers)&&(d.layers=d.layers.slice(0));d.color&&"array"===pc.type(d.color)&&(d.color=new pc.Color(d.color[0],d.color[1],d.color[2]));d.cookieOffset&&d.cookieOffset instanceof Array&&(d.cookieOffset=new pc.Vec2(d.cookieOffset[0],d.cookieOffset[1]));d.cookieScale&&d.cookieScale instanceof Array&&(d.cookieScale=new pc.Vec2(d.cookieScale[0],d.cookieScale[1]));d.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),d.enabled=
        d.enable);g=new pc.Light;g.type=e[d.type];g._node=b.entity;g._scene=this.app.scene;b.data.light=g;a._super.initializeComponentData.call(this,b,d,f)},removeComponent:function(b){b.light.data.light.destroy();a._super.removeComponent.call(this,b)},cloneComponent:function(a,c){for(var d=a.light,f=[],e,k=pc._lightProps,l=0;l<k.length;l++)e=k[l],"light"!==e&&(f[e]=d[e]&&d[e].clone?d[e].clone():d[e]);this.addComponent(c,f)},changeType:function(a,c,d){c!==d&&(a.light.type=e[d])}});return{LightComponentSystem:a}}());pc.extend(pc,function(){return{LightComponentData:pc.inherits(function(){for(var e=pc._lightProps,a=pc._lightPropsDefault,b,c=0;c<e.length;c++)b=a[c],this[e[c]]=b&&b.clone?b.clone():b},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a,b){this._scripts=[];this._scriptsIndex={};this._destroyedScripts=[];this._destroyed=!1;this._scriptsData=null;this._oldState=!0;this._isLoopingThroughScripts=this._beingEnabled=!1;this.on("set_enabled",this._onSetEnabled,this)},e=pc.inherits(e,pc.Component);e.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"};pc.extend(e.prototype,{onEnable:function(){e._super.onEnable.call(this);this._beingEnabled=
        !0;this._checkState();if(!this.entity._beingEnabled)this.onPostStateChange();this._beingEnabled=!1},onDisable:function(){e._super.onDisable.call(this);this._checkState()},onPostStateChange:function(){for(var a,b=this._beginLooping(),c=0,d=this.scripts.length;c<d;c++)a=this.scripts[c],a._initialized&&!a._postInitialized&&a.enabled&&(a._postInitialized=!0,a.postInitialize&&this._scriptMethod(a,e.scriptMethods.postInitialize));this._endLooping(b)},_beginLooping:function(){var a=this._isLoopingThroughScripts;
        this._isLoopingThroughScripts=!0;return a},_endLooping:function(a){(this._isLoopingThroughScripts=a)||this._removeDestroyedScripts()},_onSetEnabled:function(a,b,c){this._beingEnabled=!0;this._checkState();this._beingEnabled=!1},_checkState:function(){var a=this.enabled&&this.entity.enabled;if(a!==this._oldState){this._oldState=a;this.fire(a?"enable":"disable");this.fire("state",a);for(var a=this._beginLooping(),b,c=0,d=this.scripts.length;c<d;c++)b=this.scripts[c],b.enabled=b._enabled;this._endLooping(a)}},
        _onBeforeRemove:function(){this.fire("remove");for(var a=this._beginLooping(),b=0;b<this.scripts.length;b++){var c=this.scripts[b];c&&this.destroy(c.__scriptType.__name)}this._endLooping(a)},_removeDestroyedScripts:function(){var a=this._destroyedScripts.length;if(a){for(var b=0;b<a;b++){var c=this._scripts.indexOf(this._destroyedScripts[b]);0<=c&&this._scripts.splice(c,1)}this._destroyedScripts.length=0}},_onInitializeAttributes:function(){for(var a=0,b=this.scripts.length;a<b;a++)this.scripts[a].__initializeAttributes()},
        _scriptMethod:function(a,b,c){try{a[b](c)}catch(d){a.enabled=!1,a._callbacks&&a._callbacks.error||(console.warn('unhandled exception while calling "'+b+'" for "'+a.__scriptType.__name+'" script: ',d),console.error(d)),a.fire("error",d,b),this.fire("error",a,d,b)}},_onInitialize:function(){for(var a,b=this._scripts,c=this._beginLooping(),d=0,f=b.length;d<f;d++)a=b[d],!a._initialized&&a.enabled&&(a._initialized=!0,a.initialize&&this._scriptMethod(a,e.scriptMethods.initialize));this._endLooping(c)},
        _onPostInitialize:function(){this.onPostStateChange()},_onUpdate:function(a){for(var b,c=this._scripts,d=this._beginLooping(),f=0,g=c.length;f<g;f++)b=c[f],b.update&&b.enabled&&this._scriptMethod(b,e.scriptMethods.update,a);this._endLooping(d)},_onPostUpdate:function(a){var b,c,d=this._beginLooping(),f,g=this._scripts;b=0;for(c=g.length;b<c;b++)f=g[b],f.postUpdate&&f.enabled&&this._scriptMethod(f,e.scriptMethods.postUpdate,a);this._endLooping(d)},has:function(a){"string"===typeof a&&(a=this.system.app.scripts.get(a));
            return!!this._scriptsIndex[a.__name]},create:function(a,b){var c=this;b=b||{};var d=a,f=a;"string"===typeof d?d=this.system.app.scripts.get(d):d&&(f=d.__name);if(d){if(!this._scriptsIndex[d.__name]||!this._scriptsIndex[d.__name].instance){var f=new d({app:this.system.app,entity:this.entity,enabled:b.hasOwnProperty("enabled")?b.enabled:!0,attributes:b.attributes||null}),g=-1;"number"===typeof b.ind&&-1!==b.ind&&this._scripts.length>b.ind&&(g=b.ind);-1===g?this._scripts.push(f):this._scripts.splice(g,
            0,f);this._scriptsIndex[d.__name]={instance:f,onSwap:function(){c.swap(d.__name)}};this[d.__name]=f;b.preloading||f.__initializeAttributes();this.fire("create",d.__name,f);this.fire("create:"+d.__name,f);this.system.app.scripts.on("swap:"+d.__name,this._scriptsIndex[d.__name].onSwap);b.preloading||(f.enabled&&!f._initialized&&(f._initialized=!0,f.initialize&&this._scriptMethod(f,e.scriptMethods.initialize)),f.enabled&&!f._postInitialized&&(f._postInitialized=!0,f.postInitialize&&this._scriptMethod(f,
            e.scriptMethods.postInitialize)));return f}console.warn("script '"+f+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[f]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+f+"' is not found, awaiting it to be added to registry");return null},destroy:function(a){var b=a;"string"===typeof a&&(a=this.system.app.scripts.get(a))&&(b=a.__name);a=this._scriptsIndex[b];delete this._scriptsIndex[b];if(!a)return!1;if(a.instance&&!a.instance._destroyed)if(a.instance.enabled=
                !1,a.instance._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(a.instance);else{var c=this._scripts.indexOf(a.instance);this._scripts.splice(c,1)}this.system.app.scripts.off("swap:"+b,a.onSwap);delete this[b];this.fire("destroy",b,a.instance||null);this.fire("destroy:"+b,a.instance||null);a.instance&&a.instance.fire("destroy");return!0},swap:function(a){"string"===typeof a&&(a=this.system.app.scripts.get(a));var b=this._scriptsIndex[a.__name];if(!b||!b.instance)return!1;var b=
            b.instance,c=this._scripts.indexOf(b),d=new a({app:this.system.app,entity:this.entity,enabled:b.enabled,attributes:b.__attributes});if(!d.swap)return!1;d.__initializeAttributes();this._scripts[c]=d;this._scriptsIndex[a.__name].instance=d;this[a.__name]=d;this._scriptMethod(d,e.scriptMethods.swap,b);this.fire("swap",a.__name,d);this.fire("swap:"+a.__name,d);return!0},move:function(a,b){if(b>=this._scripts.length)return!1;var c=a;"string"!==typeof c&&(c=a.__name);var d=this._scriptsIndex[c];if(!d||
            !d.instance)return!1;var f=this._scripts.indexOf(d.instance);if(-1===f||f===b)return!1;this._scripts.splice(b,0,this._scripts.splice(f,1)[0]);this.fire("move",c,d.instance,b,f);this.fire("move:"+c,d.instance,b,f);return!0}});Object.defineProperty(e.prototype,"scripts",{get:function(){return this._scripts},set:function(a){this._scriptsData=a;for(var b in a)if(a.hasOwnProperty(b)){var c=this._scriptsIndex[b];if(c){if("boolean"===typeof a[b].enabled&&(c.enabled=!!a[b].enabled),"object"===typeof a[b].attributes)for(var d in a[b].attributes)if(!pc.createScript.reservedAttributes[d]){if(!c.__attributes.hasOwnProperty(d)){var f=
        this.system.app.scripts.get(b);f&&f.attributes.add(d,{})}c[d]=a[b].attributes[d]}}else console.log(this.order)}}});return{ScriptComponent:e}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="script";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.ScriptComponent;this.DataType=pc.ScriptComponentData;this.schema=e;this._components=[];this._destroyedComponents=[];this._isLoopingThroughComponents=!1;this.preloading=!0;this.on("beforeremove",this._onBeforeRemove,this);pc.ComponentSystem.on("initialize",this._onInitialize,this);pc.ComponentSystem.on("postInitialize",this._onPostInitialize,this);pc.ComponentSystem.on("update",
        this._onUpdate,this);pc.ComponentSystem.on("postUpdate",this._onPostUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ScriptComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(a,c,d){this._components.push(a);a.enabled=c.hasOwnProperty("enabled")?!!c.enabled:!0;if(c.hasOwnProperty("order")&&c.hasOwnProperty("scripts"))for(a._scriptsData=c.scripts,d=0;d<c.order.length;d++)a.create(c.order[d],{enabled:c.scripts[c.order[d]].enabled,attributes:c.scripts[c.order[d]].attributes,
        preloading:this.preloading})},cloneComponent:function(a,c){var d,f,e=[],k={};for(d=0;d<a.script._scripts.length;d++){var l=a.script._scripts[d],m=l.__scriptType.__name;e.push(m);var n={};for(f in l.__attributes)n[f]=l.__attributes[f];k[m]={enabled:l._enabled,attributes:n}}for(f in a.script._scriptsIndex)f.awayting&&e.splice(f.ind,0,f);return this.addComponent(c,{enabled:a.script.enabled,order:e,scripts:k})},_callComponentMethod:function(a,c){for(var d=this._beginLooping(),f=0;f<this._components.length;f++)if(!this._components[f]._destroyed&&
        this._components[f].entity.enabled&&this._components[f].enabled)this._components[f][a](c);this._endLooping(d)},_beginLooping:function(){var a=this._isLoopingThroughComponents;this._isLoopingThroughComponents=!0;return a},_endLooping:function(a){this._isLoopingThroughComponents=a;if(!this._isLoopingThroughComponents&&(a=this._destroyedComponents.length)){for(var c=0;c<a;c++){var d=this._components.indexOf(this._destroyedComponents[c]);0<=d&&this._components.splice(d,1)}this._destroyedComponents.length=
        0}},_onInitialize:function(){this.preloading=!1;for(var a=0;a<this._components.length;a++)this._components[a]._onInitializeAttributes();this._callComponentMethod("_onInitialize")},_onPostInitialize:function(){this._callComponentMethod("_onPostInitialize")},_onUpdate:function(a){this._callComponentMethod("_onUpdate",a)},_onPostUpdate:function(a){this._callComponentMethod("_onPostUpdate",a)},_onBeforeRemove:function(a,c){var d=this._components.indexOf(c);-1!==d&&(c._onBeforeRemove(),this._isLoopingThroughComponents?
        (c._destroyed=!0,this._destroyedComponents.push(c)):this._components.splice(d,1))}});return{ScriptComponentSystem:a}}());pc.extend(pc,function(){return{ScriptComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_scripts",this.onSetScripts,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{send:function(a,b){console.warn("DEPRECATED: ScriptLegacyComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=pc.makeArray(arguments).slice(2),d=this.entity.script.instances,f;if(d&&d[a]&&(f=d[a].instance[b]))return f.apply(d[a].instance,c)},onEnable:function(){e._super.onEnable.call(this);
        this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){e._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(b,c)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),
        this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a))},_updateScriptAttributes:function(a,b){var c=!0;if(a.length!==b.length)c=!1;else{var d,f=b.length;for(d=0;d<f;d++)if(a[d].url!==b[d].url){c=!1;break}}if(c)for(var e in this.instances)this.instances.hasOwnProperty(e)&&this.system._updateAccessors(this.entity,this.instances[e]);return c},_loadFromCache:function(a){var b,c,d=[],f=this.system.app._scriptPrefix||"",e=/^http(s)?:\/\//i;b=0;for(c=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  a.length;b<c;b++){var k=a[b];e.test(k)||(k=pc.path.join(f,k));k=this.system.app.loader.getFromCache(k,"script");if(!k)return!1;d.push(k)}b=0;for(c=d.length;b<c;b++)f=d[b],!0!==f&&f&&this.entity.script&&!this.entity.script.instances[f._pcScriptName]&&(e=new f(this.entity),this.system._preRegisterInstance(this.entity,a[b],f._pcScriptName,e));this.data&&(this.data.areScriptsLoaded=!0);this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity));return!0},
        _loadScripts:function(a){var b=a.length,c=this.system.app._scriptPrefix||"";a.forEach(function(a){var f=null,e=null;a.toLowerCase().startsWith("http://")||a.toLowerCase().startsWith("https://")?f=e=a:(e=a,f=pc.path.join(c,a));this.system.app.loader.load(f,"script",function(a,c){b--;if(a)console.error(a);else if(c&&this.entity.script&&!this.entity.script.instances[c._pcScriptName]){var d=new c(this.entity);this.system._preRegisterInstance(this.entity,e,c._pcScriptName,d)}0===b&&(this.data.areScriptsLoaded=
            !0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});return{ScriptLegacyComponent:e}}());pc.extend(pc,function(){var e=["enabled","scripts","instances","runInTools"],a=function(a){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.ScriptLegacyComponent;this.DataType=pc.ScriptLegacyComponentData;this.schema=e;this.preloading=!1;this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,
        this);pc.ComponentSystem.on("initialize",this.onInitialize,this);pc.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.ComponentSystem.on("update",this.onUpdate,this);pc.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ScriptLegacyComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    c,d){d=["runInTools","enabled","scripts"];c.scripts&&c.scripts.length&&c.scripts.forEach(function(a){if(a.attributes&&"array"===pc.type(a.attributes)){for(var b={},c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=a.attributes[c];a.attributes=b}});a._super.initializeComponentData.call(this,b,c,d)},cloneComponent:function(a,c){for(var d=this.dataStore[a._guid],f={runInTools:d.data.runInTools,scripts:[],enabled:d.data.enabled},d=d.data.scripts,e=0,k=d.length;e<k;e++){var l=d[e].attributes;l&&delete d[e].attributes;
        f.scripts.push(pc.extend({},d[e]));l&&(f.scripts[e].attributes=this._cloneAttributes(l),d[e].attributes=l)}return this.addComponent(c,f)},onBeforeRemove:function(a,c){c.enabled&&this._disableScriptComponent(c);this._destroyScriptComponent(c)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);a=a._children;var c,d=a.length;for(c=0;c<d;c++)if(a[c]instanceof pc.Entity)this.onInitialize(a[c])}},onPostInitialize:function(a){if(a.enabled){a.script&&
    a.script.enabled&&this._postInitializeScriptComponent(a.script);a=a._children;var c,d=a.length;for(c=0;c<d;c++)if(a[c]instanceof pc.Entity)this.onPostInitialize(a[c])}},_callInstancesMethod:function(a,c){var d=a.data.instances,f;for(f in d)if(d.hasOwnProperty(f)){var e=d[f].instance;e[c]&&e[c].call(e)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,
        "onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var c,d=a.data.instances,f;for(f in d)if(d.hasOwnProperty(f)){var e=d[f].instance;e.destroy&&e.destroy();e.update&&(c=this.instancesWithUpdate.indexOf(e),0<=c&&this.instancesWithUpdate.splice(c,1));e.fixedUpdate&&(c=this.instancesWithFixedUpdate.indexOf(e),0<=c&&this.instancesWithFixedUpdate.splice(c,1));e.postUpdate&&(c=this.instancesWithPostUpdate.indexOf(e),0<=c&&this.instancesWithPostUpdate.splice(c,
        1));e.toolsUpdate&&(c=this.instancesWithToolsUpdate.indexOf(e),0<=c&&this.instancesWithToolsUpdate.splice(c,1));a.instances[f].instance===a[f]&&delete a[f];delete a.instances[f]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,c,d){for(var f,e=0,k=c.length;e<k;e++)(f=c[e])&&f.entity&&f.entity.enabled&&f.entity.script.enabled&&f[a].call(f,d)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,
        a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,c){console.warn("DEPRECATED: ScriptLegacyComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");
        var d=pc.makeArray(arguments).slice(2),f,e,k,l=this.store;for(f in l)l.hasOwnProperty(f)&&(e=l[f].data,e.instances[a]&&(k=e.instances[a].instance[c])&&k.apply(e.instances[a].instance,d))},_preRegisterInstance:function(a,c,d,f){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[d])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",d,c,a.script.data._instances[d].url,a._guid));a.script.data._instances[d]={url:c,
        name:d,instance:f}}},_registerInstances:function(a){var c,d,f;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(f in a.script.instances){c=a.script.instances[f];d=c.instance;pc.events.attach(d);d.update&&this.instancesWithUpdate.push(d);d.fixedUpdate&&this.instancesWithFixedUpdate.push(d);d.postUpdate&&this.instancesWithPostUpdate.push(d);d.toolsUpdate&&this.instancesWithToolsUpdate.push(d);a.script.scripts&&this._createAccessors(a,c);if(a.script[f])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",
        f));a.script[f]=d}delete a.script.data._instances}a=a._children;d=a.length;for(c=0;c<d;c++)a[c]instanceof pc.Entity&&this._registerInstances(a[c])},_cloneAttributes:function(a){var c={},d;for(d in a)if(a.hasOwnProperty(d))if("entity"!==a[d].type)c[d]=pc.extend({},a[d]);else{var f=a[d].value;delete a[d].value;c[d]=pc.extend({},a[d]);c[d].value=f;a[d].value=f}return c},_createAccessors:function(a,c){var d,f=a.script.scripts.length,e=c.url;for(d=0;d<f;d++){var k=a.script.scripts[d];if(k.url===e){d=k.attributes;
        if(k.name&&d){for(var l in d)d.hasOwnProperty(l)&&this._createAccessor(d[l],c);a.script.data.attributes[k.name]=this._cloneAttributes(d)}break}}},_createAccessor:function(a,c){var d=this;a={name:a.name,value:a.value,type:a.type};d._convertAttributeValue(a);Object.defineProperty(c.instance,a.name,{get:function(){return a.value},set:function(f){var e=a.value;a.value=f;d._convertAttributeValue(a);c.instance.fire("set",a.name,e,a.value)},configurable:!0})},_updateAccessors:function(a,c){var d,f=a.script.scripts.length,
        e,k=c.url,l,m;for(d=0;d<f;d++)if(l=a.script,m=l.scripts[d],m.url===k){d=m.name;m=m.attributes;if(d){if(m)for(e in m)m.hasOwnProperty(e)&&this._createAccessor(m[e],c);if(f=l.data.attributes[d])for(e in f)if(k=f[e],!(e in m))delete c.instance[k.name];else if(m[e].value!==k.value&&c.instance.onAttributeChanged)c.instance.onAttributeChanged(k.name,k.value,m[e].value);m?l.data.attributes[d]=this._cloneAttributes(m):delete l.data.attributes[d]}break}},_convertAttributeValue:function(a){if("rgb"===a.type||
        "rgba"===a.type)"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3]));else if("vec2"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec2(a.value[0],a.value[1]));else if("vec3"===a.type||"vector"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],a.value[1],a.value[2]));else if("vec4"===a.type)"array"===pc.type(a.value)&&(a.value=new pc.Vec4(a.value[0],a.value[1],a.value[2],
        a.value[3]));else if("entity"===a.type)null!==a.value&&"string"===typeof a.value&&(a.value=this.app.root.findByGuid(a.value));else if("curve"===a.type||"colorcurve"===a.type)a.value=new (a.value.keys[0]instanceof Array?pc.CurveSet:pc.Curve)(a.value.keys),a.value.type=a.value.type}});return{ScriptLegacyComponentSystem:a}}());pc.extend(pc,function(){return{ScriptLegacyComponentData:pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.ComponentData)}}());pc.extend(pc,{DISTANCE_LINEAR:"linear",DISTANCE_INVERSE:"inverse",DISTANCE_EXPONENTIAL:"exponential"});pc.extend(pc,function(){var e={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new pc.Vec3,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null},a=function(a,c,d){d=d||{};this._component=a;this._assets=a.system.app.assets;this._manager=a.system.manager;this._name=c||"Untitled";this._volume=void 0!==d.volume?pc.math.clamp(Number(d.volume)||0,0,1):1;this._pitch=void 0!==d.pitch?Math.max(.01,Number(d.pitch)||0):1;this._loop=
        !(void 0===d.loop||!d.loop);this._duration=0<d.duration?d.duration:null;this._startTime=Math.max(0,Number(d.startTime)||0);this._overlap=!!d.overlap;this._autoPlay=!!d.autoPlay;this._lastNode=this._firstNode=null;this._asset=d.asset;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this._onInstancePlayHandler=this._onInstancePlay.bind(this);this._onInstancePauseHandler=this._onInstancePause.bind(this);this._onInstanceResumeHandler=this._onInstanceResume.bind(this);this._onInstanceStopHandler=
        this._onInstanceStop.bind(this);this._onInstanceEndHandler=this._onInstanceEnd.bind(this);this.instances=[];pc.events.attach(this)};a.prototype={play:function(){this.overlap||!this.isPlaying&&!this.isPaused||this.stop();var a=this._createInstance();this.instances.push(a);if(this.isLoaded)a.play();else{var c=function(c){var f=a._playWhenLoaded;a.sound=c;f&&a.play()};this.off("load",c);this.once("load",c);this.load()}return a},pause:function(){for(var a=!1,c=this.instances,d=0,f=c.length;d<f;d++)c[d].pause()&&
    (a=!0);return a},resume:function(){for(var a=!1,c=this.instances,d=0,f=c.length;d<f;d++)c[d].resume()&&(a=!0);return a},stop:function(){for(var a=!1,c=this.instances,d=0,f=c.length;d<f;d++)c[d].stop()&&(a=!0);c.length=0;return a},load:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);a?(a.off("remove",this._onAssetRemoved,this),a.on("remove",this._onAssetRemoved,this),a.resource?this.fire("load",a.resource):(a.off("load",this._onAssetLoad,this),a.once("load",this._onAssetLoad,this),
        this._assets.load(a))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(a,c){if(a){if(c||(c=a),this._firstNode=a,this._lastNode=c,!this._overlap)for(var d=this.instances,f=0,e=d.length;f<e;f++)d[f].setExternalNodes(a,c)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){this._lastNode=this._firstNode=null;if(!this._overlap)for(var a=this.instances,c=0,d=a.length;c<
    d;c++)a[c].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var a=null,a=this._component,c=null;if(this._hasAsset()){var d=this._assets.get(this._asset);d&&(c=d.resource)}e.volume=this._volume*a.volume;e.pitch=this._pitch*a.pitch;e.loop=this._loop;e.startTime=this._startTime;e.duration=this._duration;e.onPlay=this._onInstancePlayHandler;e.onPause=this._onInstancePauseHandler;e.onResume=
        this._onInstanceResumeHandler;e.onStop=this._onInstanceStopHandler;e.onEnd=this._onInstanceEndHandler;a.positional?(e.position.copy(a.entity.getPosition()),e.maxDistance=a.maxDistance,e.refDistance=a.refDistance,e.rollOffFactor=a.rollOffFactor,e.distanceModel=a.distanceModel,a=new pc.SoundInstance3d(this._manager,c,e)):a=new pc.SoundInstance(this._manager,c,e);this._firstNode&&a.setExternalNodes(this._firstNode,this._lastNode);return a},_onInstancePlay:function(a){this.fire("play",a);this._component.fire("play",
        this,a)},_onInstancePause:function(a){this.fire("pause",a);this._component.fire("pause",this,a)},_onInstanceResume:function(a){this.fire("resume",a);this._component.fire("resume",this,a)},_onInstanceStop:function(a){this.fire("stop",a);this._component.fire("stop",this,a)},_onInstanceEnd:function(a){var c=this.instances.indexOf(a);-1!==c&&this.instances.splice(c,1);this.fire("end",a);this._component.fire("end",this,a)},_onAssetAdd:function(a){this.load()},_onAssetLoad:function(a){this.load()},_onAssetRemoved:function(a){a.off("remove",
        this._onAssetRemoved,this);this._assets.off("add:"+a.id,this._onAssetAdd,this);this.stop()},updatePosition:function(a){for(var c=this.instances,d=0,f=c.length;d<f;d++)c[d].position=a}};Object.defineProperty(a.prototype,"name",{get:function(){return this._name},set:function(a){this._name=a}});Object.defineProperty(a.prototype,"volume",{get:function(){return this._volume},set:function(a){this._volume=pc.math.clamp(Number(a)||0,0,1);if(!this._overlap){a=this.instances;for(var c=0,d=a.length;c<d;c++)a[c].volume=
        this._volume*this._component.volume}}});Object.defineProperty(a.prototype,"pitch",{get:function(){return this._pitch},set:function(a){this._pitch=Math.max(Number(a)||0,.01);if(!this._overlap){a=this.instances;for(var c=0,d=a.length;c<d;c++)a[c].pitch=this.pitch*this._component.pitch}}});Object.defineProperty(a.prototype,"loop",{get:function(){return this._loop},set:function(a){this._loop=!!a;a=this.instances;for(var c=0,d=a.length;c<d;c++)a[c].loop=this._loop}});Object.defineProperty(a.prototype,
        "autoPlay",{get:function(){return this._autoPlay},set:function(a){this._autoPlay=!!a}});Object.defineProperty(a.prototype,"overlap",{get:function(){return this._overlap},set:function(a){this._overlap=!!a}});Object.defineProperty(a.prototype,"startTime",{get:function(){return this._startTime},set:function(a){this._startTime=Math.max(0,Number(a)||0);if(!this._overlap){a=this.instances;for(var c=0,d=a.length;c<d;c++)a[c].startTime=this._startTime}}});Object.defineProperty(a.prototype,"duration",{get:function(){var a=
        0;this._hasAsset()&&(a=this._assets.get(this._asset),a=a.resource?a.resource.duration:0);return null!=this._duration?this._duration%(a||1):a},set:function(a){this._duration=Math.max(0,Number(a)||0)||null;if(!this._overlap){a=this.instances;for(var c=0,d=a.length;c<d;c++)a[c].duration=this._duration}}});Object.defineProperty(a.prototype,"asset",{get:function(){return this._asset},set:function(a){var c=this._asset;c&&(this._assets.off("add:"+c,this._onAssetAdd,this),(c=this._assets.get(c))&&c.off("remove",
        this._onAssetRemoved,this));this._asset=a;this._asset instanceof pc.Asset&&(this._asset=this._asset.id);this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}});Object.defineProperty(a.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var a=this._assets.get(this._asset);if(a)return!!a.resource}return!1}});Object.defineProperty(a.prototype,"isPlaying",{get:function(){for(var a=this.instances,c=0,d=a.length;c<d;c++)if(a[c].isPlaying)return!0;return!1}});Object.defineProperty(a.prototype,
        "isPaused",{get:function(){var a=this.instances,c=a.length;if(0===c)return!1;for(var d=0;d<c;d++)if(!a[d].isPaused)return!1;return!0}});Object.defineProperty(a.prototype,"isStopped",{get:function(){for(var a=this.instances,c=0,d=a.length;c<d;c++)if(!a[c].isStopped)return!1;return!0}});return{SoundSlot:a}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_slots",this.onSetSlots,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_refDistance",this.onSetRefDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_positional",this.onSetPositional,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,
        {onSetSlots:function(a,b,c){var d;if(b)for(d in b)b[d].stop();a={};for(d in c)c[d]instanceof pc.SoundSlot?a[c[d].name]=c[d]:c[d].name&&(a[c[d].name]=new pc.SoundSlot(this,c[d].name,c[d]));this.data.slots=a;if(this.enabled&&this.entity.enabled)this.onEnable()},onSetVolume:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap)for(var f=b.instances,e=0,k=f.length;e<k;e++)f[e].volume=b.volume*c},onSetPitch:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap)for(var f=
            b.instances,e=0,k=f.length;e<k;e++)f[e].pitch=b.pitch*c},onSetRefDistance:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var f=0,e=b.length;f<e;f++)b[f].refDistance=c}},onSetMaxDistance:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var f=0,e=b.length;f<e;f++)b[f].maxDistance=c}},onSetRollOffFactor:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var f=0,e=b.length;f<e;f++)b[f].rollOffFactor=
            c}},onSetDistanceModel:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){b=b.instances;for(var f=0,e=b.length;f<e;f++)b[f].distanceModel=c}},onSetPositional:function(a,b,c){a=this.data.slots;for(var d in a)if(b=a[d],!b.overlap){c=b.instances;for(var f=0,e=c.length;f<e;f++){var k=c[f].isPlaying||c[f].isSuspended,l=c[f].currentTime;k&&c[f].stop();c[f]=b._createInstance();k&&(c[f].play(),c[f].currentTime=l)}}},onEnable:function(){e._super.onEnable.call(this);if(!this.system._inTools){var a=
            this.data.slots,b=this.data.playingBeforeDisable,c;for(c in a){var d=a[c];d.autoPlay&&d.isStopped?d.play():b[c]?d.resume():d.isLoaded||d.load()}}},onDisable:function(){e._super.onDisable.call(this);var a=this.data.slots,b={},c;for(c in a)!a[c].overlap&&a[c].isPlaying&&(a[c].pause(),b[c]=!0);this.data.playingBeforeDisable=b},addSlot:function(a,b){var c=this.data.slots;if(c[a])return logWARNING("A sound slot with name "+a+" already exists on Entity "+this.entity.getPath()),null;var d=new pc.SoundSlot(this,
            a,b);c[a]=d;d.autoPlay&&this.enabled&&this.entity.enabled&&d.play();return d},removeSlot:function(a){var b=this.data.slots;b[a]&&(b[a].stop(),delete b[a])},slot:function(a){return this.data.slots[a]},play:function(a){if(!this.enabled||!this.entity.enabled)return null;var b=this.slots[a];return b?b.play():(logWARNING("Trying to play sound slot with name "+a+" which does not exist"),null)},pause:function(a){var b;b=this.data.slots;if(a)(b=b[a])?b.pause():logWARNING("Trying to pause sound slot with name "+
            a+" which does not exist");else for(var c in b)b[c].pause()},resume:function(a){var b;b=this.data.slots;if(a)(b=b[a])?b.isPaused&&b.resume():logWARNING("Trying to resume sound slot with name "+a+" which does not exist");else for(var c in b)b[c].resume()},stop:function(a){var b;b=this.data.slots;if(a)(b=b[a])?b.stop():logWARNING("Trying to stop sound slot with name "+a+" which does not exist");else for(var c in b)b[c].stop()}});return{SoundComponent:e}}());pc.extend(pc,function(){var e="enabled volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" "),a=function(a,c){this.id="sound";this.description="Allows an Entity to play sounds";a.systems.add(this.id,this);this.ComponentType=pc.SoundComponent;this.DataType=pc.SoundComponentData;this.schema=e;this.manager=c;pc.ComponentSystem.on("update",this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.SoundComponent.prototype,
        e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){d="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots enabled".split(" ");a._super.initializeComponentData.call(this,b,c,d)},cloneComponent:function(a,c){var d,f=a.sound.data,e={};for(d in f)f.hasOwnProperty(d)&&(e[d]=f[d]);e.slots={};for(d in f.slots){var k=f.slots[d];e.slots[d]=k instanceof pc.SoundSlot?{name:k.name,volume:k.volume,pitch:k.pitch,loop:k.loop,duration:k.duration,startTime:k.startTime,
        overlap:k.overlap,autoPlay:k.autoPlay,asset:k.asset}:k}e.playingBeforeDisable={};return this.addComponent(c,e)},onUpdate:function(a){a=this.store;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c],f=d.entity,d=d.data;if(d.enabled&&f.enabled&&d.positional){var f=f.getPosition(),d=d.slots,e;for(e in d)d[e].updatePosition(f)}}},onBeforeRemove:function(a,c){var d=c.slots,f;for(f in d)d[f].overlap||d[f].stop()}});Object.defineProperty(a.prototype,"volume",{get:function(){return this.manager.volume},set:function(a){this.manager.volume=
        a}});Object.defineProperty(a.prototype,"context",{get:function(){return pc.SoundManager.hasAudioContext()?this.manager.context:(console.warn("WARNING: Audio context is not supported on this browser"),null)}});return{SoundComponentSystem:a}}());pc.SoundComponentData=function(){this.enabled=!0;this.pitch=this.volume=1;this.positional=!0;this.refDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_LINEAR;this.slots={};this.playingBeforeDisable={}};pc.extend(pc,function(){var e=function(a,b){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this);this.on("set_distanceModel",this.onSetDistanceModel,this);this.on("set_3d",this.onSet3d,this)},e=pc.inherits(e,pc.Component);
        pc.extend(e.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var b,c=this.data;c.sources[a]&&(c["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(c.sources[a],b,c)):b=this.system.manager.playSound(c.sources[a],c),c.currentSource=a,c.channel=b)}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=
            null)},onSetAssets:function(a,b,c){a=[];var d,f=c.length;if(b&&b.length)for(d=0;d<b.length;d++)if(b[d]){var e=this.system.app.assets.get(b[d]);e&&(e.off("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this),this.currentSource===e.name&&this.stop())}if(f)for(d=0;d<f;d++)0>b.indexOf(c[d])&&(c[d]instanceof pc.Asset?a.push(c[d].id):a.push(c[d]));!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,c,d){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=
            c,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?(this.play(a.name),this.pause()):this.play(a.name)))},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.sources[a.name]&&(delete this.data.sources[a.name],this.data.currentSource===a.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(c)},onSetDistanceModel:function(a,b,c){b!==c&&this.channel instanceof pc.Channel3d&&this.channel.setDistanceModel(c)},onSet3d:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                b,c){b!==c&&this.system.initialized&&this.currentSource&&(b=a=!1,this.channel&&(a=this.channel.paused,b=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=a,this.channel.suspended=b))},onEnable:function(){e._super.onEnable.call(this);var a=this.data.assets;if(a)for(var b=this.system.app.assets,c=0,d=a.length;c<d;c++){var f=a[c];f instanceof pc.Asset||(f=b.get(f));f&&!f.resource&&b.load(f)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):
            this.unpause())},onDisable:function(){e._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b=this,c=a.map(function(a){return this.system.app.assets.get(a)},this),d={},f=null,e=c.length,k=function(a){e--},l=function(){this.data.sources=d;this.data.currentSource=f;if(this.enabled&&this.activate&&f)this.onEnable()}.bind(this);c.forEach(function(c,n){c?(f=f||c.name,c.off("change",this.onAssetChanged,this),c.on("change",this.onAssetChanged,this),c.off("remove",this.onAssetRemoved,
            this),c.on("remove",this.onAssetRemoved,this),c.off("error",k,this),c.on("error",k,this),c.ready(function(a){d[a.name]=a.resource;e--;0===e&&l()}),!c.resource&&b.enabled&&b.entity.enabled&&this.system.app.assets.load(c)):(e--,0===e&&l(),this.system.app.assets.on("add:"+a[n],function(a){a.ready(function(a){b.data.sources[a.name]=a.resource});a.resource||b.system.app.assets.load(a)}))},this)}});return{AudioSourceComponent:e}}());pc.extend(pc,function(){var e="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" "),a=function(a,c){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.AudioSourceComponent;this.DataType=pc.AudioSourceComponentData;this.schema=e;this.manager=c;this.initialized=!1;pc.ComponentSystem.on("initialize",this.onInitialize,
        this);pc.ComponentSystem.on("update",this.onUpdate,this);this.on("remove",this.onRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.AudioSourceComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){d="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" ");a._super.initializeComponentData.call(this,b,c,d);b.paused=!(b.enabled&&b.activate)},onInitialize:function(a){a.audiosource&&a.enabled&&
    a.audiosource.enabled&&a.audiosource.activate&&a.audiosource.play(a.audiosource.currentSource);a=a._children;var c,d=a.length;for(c=0;c<d;c++)if(a[c]instanceof pc.Entity)this.onInitialize(a[c]);this.initialized=!0},onUpdate:function(a){a=this.store;for(var c in a)if(a.hasOwnProperty(c)){var d=a[c],f=d.entity,d=d.data;d.enabled&&f.enabled&&d.channel instanceof pc.Channel3d&&(f=f.getPosition(),d.channel.setPosition(f))}},onRemove:function(a,c){c.channel&&(c.channel.stop(),c.channel=null)},setVolume:function(a){this.manager.setVolume(a)}});
        return{AudioSourceComponentSystem:a}}());pc.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.distanceModel=pc.DISTANCE_INVERSE;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc,function(){var e=function(a,b){},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){e._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){e._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
        return{AudioListenerComponent:e}}());pc.extend(pc,function(){var e=["enabled"],a=function(a,c){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.AudioListenerComponent;this.DataType=pc.AudioListenerComponentData;this.schema=e;this.manager=c;this.current=null;pc.ComponentSystem.on("update",this.onUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.AudioListenerComponent.prototype,e);pc.extend(a.prototype,
        {initializeComponentData:function(b,c,d){d=["enabled"];a._super.initializeComponentData.call(this,b,c,d)},onUpdate:function(a){this.current&&(a=this.current.getPosition(),this.manager.listener.setPosition(a),a=this.current.getWorldTransform(),this.manager.listener.setOrientation(a))}});return{AudioListenerComponentSystem:a}}());pc.extend(pc,function(){return{AudioListenerComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,
        BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});pc.extend(pc,function(){var e,a,b,c,d,f=function(f,k){"undefined"===typeof Ammo||e||(e=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,c=new Ammo.btQuaternion,d=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",this.onSetFriction,
        this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},f=pc.inherits(f,pc.Component);Object.defineProperty(f.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");
        return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(f.prototype,"linearVelocity",{get:function(){if(!this.isKinematic()&&this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z())}return this._linearVelocity},set:function(b){this.activate();!this.isKinematic()&&this.body&&(a.setValue(b.x,b.y,b.z),this.body.setLinearVelocity(a));this._linearVelocity.copy(b)}});Object.defineProperty(f.prototype,
        "angularVelocity",{get:function(){if(!this.isKinematic()&&this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z())}return this._angularVelocity},set:function(b){this.activate();!this.isKinematic()&&this.body&&(a.setValue(b.x,b.y,b.z),this.body.setAngularVelocity(a));this._angularVelocity.copy(b)}});pc.extend(f.prototype,{createBody:function(){var b=this.entity,d;b.collision&&(d=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete b.trigger));if(d){this.body&&
    (this.system.removeBody(this.body),Ammo.destroy(this.body));var f=this.isStaticOrKinematic(),e=f?0:this.mass,n=new Ammo.btVector3(0,0,0);f||d.calculateLocalInertia(e,n);var f=b.getPosition(),h=b.getRotation();c.setValue(h.x,h.y,h.z,h.w);h=new Ammo.btTransform;h.setIdentity();h.getOrigin().setValue(f.x,f.y,f.z);h.setRotation(c);f=new Ammo.btDefaultMotionState(h);d=new Ammo.btRigidBodyConstructionInfo(e,f,d,n);d=new Ammo.btRigidBody(d);d.setRestitution(this.restitution);d.setFriction(this.friction);
        d.setDamping(this.linearDamping,this.angularDamping);e=this.linearFactor;a.setValue(e.x,e.y,e.z);d.setLinearFactor(a);e=this.angularFactor;a.setValue(e.x,e.y,e.z);d.setAngularFactor(a);d.entity=b;this.isKinematic()&&(d.setCollisionFlags(d.getCollisionFlags()|pc.BODYFLAG_KINEMATIC_OBJECT),d.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));b.rigidbody.body=d;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&
    this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var a=this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),
        a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var c,f,e,m,n,h;switch(arguments.length){case 1:c=arguments[0].x;f=arguments[0].y;e=arguments[0].z;break;case 2:c=arguments[0].x;f=arguments[0].y;e=arguments[0].z;m=arguments[1].x;n=arguments[1].y;h=arguments[1].z;break;case 3:c=arguments[0];f=arguments[1];e=arguments[2];break;case 6:c=arguments[0],f=arguments[1],e=arguments[2],m=arguments[3],n=arguments[4],h=arguments[5]}var r=this.body;
        r&&(r.activate(),a.setValue(c,f,e),void 0!==m?(b.setValue(m,n,h),r.applyForce(a,b)):r.applyForce(a,d))},applyTorque:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),a.setValue(b,c,d),f.applyTorque(a))},applyImpulse:function(){var c,f,e,m,n,h;switch(arguments.length){case 1:c=arguments[0].x;f=arguments[0].y;e=arguments[0].z;break;case 2:c=
        arguments[0].x;f=arguments[0].y;e=arguments[0].z;m=arguments[1].x;n=arguments[1].y;h=arguments[1].z;break;case 3:c=arguments[0];f=arguments[1];e=arguments[2];break;case 6:c=arguments[0];f=arguments[1];e=arguments[2];m=arguments[3];n=arguments[4];h=arguments[5];break;default:return}var r=this.body;r&&(r.activate(),a.setValue(c,f,e),void 0!==m?(b.setValue(m,n,h),r.applyImpulse(a,b)):r.applyImpulse(a,d))},applyTorqueImpulse:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;
        d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:return}var f=this.body;f&&(f.activate(),a.setValue(b,c,d),f.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},isKinematic:function(){return this.type===pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),d=this.entity.getRotation(),
        f=a.getWorldTransform();f.getOrigin().setValue(b.x,b.y,b.z);c.setValue(d.x,d.y,d.z,d.w);f.setRotation(c);this.isKinematic()&&(b=this.body.getMotionState())&&b.setWorldTransform(f);a.activate()}},syncBodyToEntity:function(){var a=this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(e);var a=e.getOrigin(),b=e.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),
    arguments[1]&&(arguments[1]instanceof pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,
        this._displacement.y,this._displacement.z);if(this.body.getMotionState()){a=this.entity.getPosition();var b=this.entity.getRotation();e.getOrigin().setValue(a.x,a.y,a.z);c.setValue(b.x,b.y,b.z,b.w);e.setRotation(c);this.body.getMotionState().setWorldTransform(e)}},onEnable:function(){f._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},onDisable:function(){f._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&
        this.entity.enabled)&&this.disableSimulation();var d=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,d);a.setMassProps(c,d);a.updateInertiaTensor();b&&this.enableSimulation()}},onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setAngularFactor(a)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),c===pc.BODYTYPE_DYNAMIC?(this.data.group=pc.BODYGROUP_DYNAMIC,this.data.mask=pc.BODYMASK_ALL):c===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,
        this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(a,b,c){this.body&&this.data.simulationEnabled&&this.body.activate()}});return{RigidBodyComponent:f}}());pc.extend(pc,function(){var e,a,b={},c={},d=!1,f=function(a,b,c){this.entity=a;this.point=b;this.normal=c},g=function(a,b,c){0===arguments.length?(this.b=this.a=null,this.localPointA=new pc.Vec3,this.localPointB=new pc.Vec3,this.pointA=new pc.Vec3,this.pointB=new pc.Vec3,this.normal=new pc.Vec3):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)},k=function(a,b,c,d,f){0===arguments.length?(this.localPoint=
        new pc.Vec3,this.localPointOther=new pc.Vec3,this.point=new pc.Vec3,this.pointOther=new pc.Vec3,this.normal=new pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=c,this.pointOther=d,this.normal=f)},l=function(a,b){this.other=a;this.contacts=b},m="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" "),n=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,
        this);this._stats=a.stats.frame;this.ComponentType=pc.RigidBodyComponent;this.DataType=pc.RigidBodyComponentData;this.contactPointPool=new pc.AllocatePool(k,1);this.contactResultPool=new pc.AllocatePool(l,1);this.singleContactResultPool=new pc.AllocatePool(g,1);this.schema=m;this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this)},n=pc.inherits(n,pc.ComponentSystem);pc.Component._buildAccessors(pc.RigidBodyComponent.prototype,m);pc.extend(n.prototype,{onLibraryLoaded:function(){if("undefined"!==
        typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,c=new Ammo.btCollisionDispatcher(b),d=new Ammo.btDbvtBroadphase,f=new Ammo.btSequentialImpulseConstraintSolver;this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(c,d,f,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);e=new Ammo.btVector3;a=new Ammo.btVector3;pc.ComponentSystem.on("update",this.onUpdate,this)}else pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         b,c){c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");var d={};c.forEach(function(a){d[a]=b[a]});b.bodyType&&(d.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));d.linearFactor&&"array"===pc.type(d.linearFactor)&&(d.linearFactor=new pc.Vec3(d.linearFactor[0],d.linearFactor[1],d.linearFactor[2]));d.angularFactor&&"array"===pc.type(d.angularFactor)&&(d.angularFactor=new pc.Vec3(d.angularFactor[0],
        d.angularFactor[1],d.angularFactor[2]));n._super.initializeComponentData.call(this,a,d,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,
        type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,b,c):this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,
        b,c;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,c=arguments[0].z):(a=arguments[0],b=arguments[1],c=arguments[2]);this._ammoGravity.setValue(a,b,c);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,c){var g=null;e.setValue(b.x,b.y,b.z);a.setValue(c.x,c.y,c.z);var m=new Ammo.ClosestRayResultCallback(e,a);this.dynamicsWorld.rayTest(e,a,m);if(m.hasHit()){var k=m.get_m_collisionObject();if(k=Ammo.castObject(k,Ammo.btRigidBody)){var g=m.get_m_hitPointWorld(),l=m.get_m_hitNormalWorld(),
        g=new f(k.entity,new pc.Vec3(g.x(),g.y(),g.z()),new pc.Vec3(l.x(),l.y(),l.z()));2<arguments.length&&((0,arguments[2])(g),d||(console.warn("[DEPRECATED]: pc.RigidBodyComponentSystem#rayCastFirst no longer requires a callback. The result of the raycast is returned by the function instead."),d=!0))}}Ammo.destroy(m);return g},_storeCollision:function(a,d){var f=!1,e=a._guid;b[e]=b[e]||{others:[],entity:a};0>b[e].others.indexOf(d)&&(b[e].others.push(d),f=!0);c[e]=c[e]||{others:[],entity:a};c[e].others.push(d);
        return f},_createContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPoint.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPointOther.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.point.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.pointOther.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),
        a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createReverseContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPointOther.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPoint.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.pointOther.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.point.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),
        a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createSingleContactResult:function(a,b,c){var d=this.singleContactResultPool.allocate();d.a=a;d.b=b;d.localPointA=c.localPoint;d.localPointB=c.localPointOther;d.pointA=c.point;d.pointB=c.pointOther;d.normal=c.normal;return d},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var d=
        b[a].entity,f=d.collision,e=b[a].others,g=e.length;g--;){var m=e[g];if(!c[a]||0>c[a].others.indexOf(m))e.splice(g,1),f&&m.collision&&(d.rigidbody&&m.rigidbody?f.fire("collisionend",m):d.trigger&&f.fire("triggerleave",m))}0===e.length&&delete b[a]}},onUpdate:function(a){this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=this.store,d;for(d in b)if(b.hasOwnProperty(d)){var f=b[d].entity,e=b[d].data;e.body&&e.body.isActive()&&e.enabled&&f.enabled&&(e.type===pc.BODYTYPE_DYNAMIC?
        f.rigidbody.syncBodyToEntity():e.type===pc.BODYTYPE_KINEMATIC&&f.rigidbody._updateKinematic(a))}a=this.dynamicsWorld.getDispatcher();var b=a.getNumManifolds(),g;c={};for(d=0;d<b;d++){var m=a.getManifoldByIndexInternal(d),k=m.getBody0(),l=m.getBody1(),f=Ammo.castObject(k,Ammo.btRigidBody),e=Ammo.castObject(l,Ammo.btRigidBody),f=f.entity,e=e.entity;if(f&&e){g=k.getCollisionFlags();var n=l.getCollisionFlags(),z=m.getNumContacts(),A=[],l=[],D;if(0<z)if(g&pc.BODYFLAG_NORESPONSE_OBJECT||n&pc.BODYFLAG_NORESPONSE_OBJECT)D=
        f.collision?f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave"):!1,k=e.collision?e.collision.hasEvent("triggerenter")||e.collision.hasEvent("triggerleave"):!1,D&&(m=this._storeCollision(f,e))&&(!f.collision||n&pc.BODYFLAG_NORESPONSE_OBJECT||f.collision.fire("triggerenter",e)),k&&(m=this._storeCollision(e,f))&&(!e.collision||g&pc.BODYFLAG_NORESPONSE_OBJECT||e.collision.fire("triggerenter",f));else if(D=f.collision?f.collision.hasEvent("collisionstart")||f.collision.hasEvent("collisionend")||
            f.collision.hasEvent("contact"):!1,k=e.collision?e.collision.hasEvent("collisionstart")||e.collision.hasEvent("collisionend")||e.collision.hasEvent("contact"):!1,(n=this.hasEvent("contact"))||D||k){for(g=0;g<z;g++){var B=m.getContactPoint(g),F=this._createContactPointFromAmmo(B),J=null;if(D||k)J=this._createReverseContactPointFromAmmo(B),A.push(F),l.push(J);n&&(B=this._createSingleContactResult(f,e,F),this.fire("contact",B))}D&&(z=this._createContactResult(e,A),f.collision&&f.collision.fire("contact",
        z),(m=this._storeCollision(f,e))&&f.collision&&f.collision.fire("collisionstart",z));k&&(l=this._createContactResult(f,l),e.collision&&e.collision.fire("contact",l),(m=this._storeCollision(e,f))&&e.collision&&e.collision.fire("collisionstart",l))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()}});return{RIGIDBODY_TYPE_STATIC:"static",RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,
        RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:n}}());pc.extend(pc,function(){return{RigidBodyComponentData:pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1},pc.ComponentData)}}());pc.extend(pc,function(){var e,a,b=function(b,d,f){this.entity=d.entity;this.component=d;this.app=b;"undefined"!==typeof Ammo&&(e=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(f)};b.prototype={initialize:function(b){var d=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){d.trigger&&d.trigger.destroy();var f=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,f);var g=d.getPosition(),k=d.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(g.x,
        g.y,g.z);k.setRotation(a);g=new Ammo.btDefaultMotionState(k);b=new Ammo.btRigidBodyConstructionInfo(1,g,b,f);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);e.setValue(0,0,0);b.setLinearFactor(e);b.setAngularFactor(e);b.setCollisionFlags(b.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);b.entity=d;this.component.enabled&&d.enabled&&this.enable()}},destroy:function(){this.body&&this.app.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
        this.body;if(b){var d=this.entity.getPosition(),f=this.entity.getRotation(),e=b.getWorldTransform();e.getOrigin().setValue(d.x,d.y,d.z);a.setValue(f.x,f.y,f.z,f.w);e.setRotation(a);b.activate()}},enable:function(){var a=this.body;a&&(this.app.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER),a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG),a.activate(),this.syncEntityToBody())},disable:function(){var a=this.body;a&&(this.app.systems.rigidbody.removeBody(a),
        a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION))}};return{Trigger:b}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);this.on("set_model",this.onSetModel,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onSetType:function(a,b,c){b!==c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(a,b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          c){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(a,b,c){!this.data.initialized||"sphere"!==this.data.type&&"capsule"!==this.data.type&&"cylinder"!==this.data.type||this.system.recreatePhysicalShapes(this)},onSetHeight:function(a,b,c){!this.data.initialized||"capsule"!==this.data.type&&"cylinder"!==this.data.type||this.system.recreatePhysicalShapes(this)},onSetAxis:function(a,b,c){!this.data.initialized||"capsule"!==this.data.type&&"cylinder"!==
    this.data.type||this.system.recreatePhysicalShapes(this)},onSetAsset:function(a,b,c){a=this.system.app.assets;b&&(b=a.get(b))&&b.off("remove",this.onAssetRemoved,this);c&&(c instanceof pc.Asset&&(this.data.asset=c.id),b=a.get(this.data.asset))&&(b.off("remove",this.onAssetRemoved,this),b.on("remove",this.onAssetRemoved,this));this.data.initialized&&"mesh"===this.data.type&&(c||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(a,b,c){this.data.initialized&&"mesh"===
    this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(a){a.off("remove",this.onAssetRemoved,this);this.data.asset===a.id&&(this.asset=null)},onEnable:function(){e._super.onEnable.call(this);if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var a=this.system.app.assets.get(this.data.asset);if(a&&(!a.resource||!this.data.shape)){this.system.recreatePhysicalShapes(this);return}}this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&
        this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){e._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()}});return{CollisionComponent:e}}());pc.extend(pc,function(){var e="enabled type halfExtents radius axis height asset shape model".split(" "),a=function(a){this.system=a};a.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.Model;b.model.graph=new pc.GraphNode},afterInitialize:function(a,b){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;"undefined"!==
    typeof Ammo&&(c.shape=this.createPhysicalShape(a.entity,c),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody()):b.trigger?b.trigger.initialize(c):b.trigger=new pc.Trigger(this.system.app,a,c))},createPhysicalShape:function(a,b){},updateTransform:function(a,b,c,d){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,b){var c=this.system.app;a.rigidbody&&a.rigidbody.body&&(c.systems.rigidbody.removeBody(a.rigidbody.body),a.rigidbody.disableSimulation());a.trigger&&
    (a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){var c=this.system.dataStore[a._guid];return this.system.addComponent(b,{enabled:c.data.enabled,type:c.data.type,halfExtents:[c.data.halfExtents.x,c.data.halfExtents.y,c.data.halfExtents.z],radius:c.data.radius,axis:c.data.axis,height:c.data.height,asset:c.data.asset,model:c.data.model})}};var b=function(a){},b=pc.inherits(b,a);b.prototype=pc.extend(b.prototype,
        {createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var c=b.halfExtents,c=new Ammo.btVector3(c?c.x:.5,c?c.y:.5,c?c.z:.5);return new Ammo.btBoxShape(c)}}});var c=function(a){},c=pc.inherits(c,a);c.prototype=pc.extend(c.prototype,{createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)}});var d=function(a){},d=pc.inherits(d,a);d.prototype=pc.extend(d.prototype,{createPhysicalShape:function(a,b){var c=null,d=void 0!==b.axis?b.axis:1,f=b.radius||
        .5,e=Math.max((b.height||2)-2*f,0);if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btCapsuleShapeX(f,e);break;case 1:c=new Ammo.btCapsuleShape(f,e);break;case 2:c=new Ammo.btCapsuleShapeZ(f,e)}return c}});var f=function(a){},f=pc.inherits(f,a);f.prototype=pc.extend(f.prototype,{createPhysicalShape:function(a,b){var c=null,c=null,d=void 0!==b.axis?b.axis:1,f=void 0!==b.radius?b.radius:.5,e=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btVector3(.5*e,
        f,f);c=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(f,.5*e,f);c=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(f,f,.5*e),c=new Ammo.btCylinderShapeZ(c)}return c}});var g=function(a){},g=pc.inherits(g,a);g.prototype=pc.extend(g.prototype,{beforeInitialize:function(a,b){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model,d=new Ammo.btCompoundShape,f,e;for(f=0;f<c.meshInstances.length;f++){var g=c.meshInstances[f],k=g.mesh,x=k.indexBuffer[pc.RENDERSTYLE_SOLID],
        y=k.vertexBuffer,w=y.getFormat(),u=w.size/4,v;for(e=0;e<w.elements.length;e++){var z=w.elements[e];z.name===pc.SEMANTIC_POSITION&&(v=new Float32Array(y.lock(),z.offset))}var x=new Uint16Array(x.lock()),y=k.primitive[0].count/3,w=new Ammo.btVector3,z=new Ammo.btVector3,A=new Ammo.btVector3,D,B,F=k.primitive[0].base,J=new Ammo.btTriangleMesh;for(e=0;e<y;e++)k=x[F+3*e]*u,D=x[F+3*e+1]*u,B=x[F+3*e+2]*u,w.setValue(v[k],v[k+1],v[k+2]),z.setValue(v[D],v[D+1],v[D+2]),A.setValue(v[B],v[B+1],v[B+2]),J.addTriangle(w,
        z,A,!0);e=new Ammo.btBvhTriangleMeshShape(J,!0);u=g.node.getWorldTransform().getScale();e.setLocalScaling(new Ammo.btVector3(u.x,u.y,u.z));u=g.node.getPosition();g=g.node.getRotation();x=new Ammo.btTransform;x.setIdentity();x.getOrigin().setValue(u.x,u.y,u.z);u=new Ammo.btQuaternion;u.setValue(g.x,g.y,g.z,g.w);x.setRotation(u);d.addChildShape(x,e)}c=a.getWorldTransform().getScale();f=new Ammo.btVector3;f.setValue(c.x,c.y,c.z);d.setLocalScaling(f);return d}},recreatePhysicalShapes:function(a){null!==
    a.data.asset&&a.enabled&&a.entity.enabled?this.loadModelAsset(a):this.doRecreatePhysicalShape(a)},loadModelAsset:function(a){var b=this,c=a.data.asset,d=a.data,f=this.system.app.assets,e=f.get(c);if(e)e.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)}),f.load(e);else f.once("add:"+c,function(c){c.ready(function(c){d.model=c.resource;b.doRecreatePhysicalShape(a)});f.load(c)})},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(c.shape&&Ammo.destroy(c.shape),c.shape=
        this.createPhysicalShape(b,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):b.trigger=new pc.Trigger(this.system.app,a,c)):this.remove(b,c)},updateTransform:function(a,b,c,d){if(a.shape){var f=a.entity.getWorldTransform().getScale(),e=a.shape.getLocalScaling();f.x===e.x()&&f.y===e.y()&&f.z===e.z()||this.doRecreatePhysicalShape(a)}g._super.updateTransform.call(this,a,b,c,d)}});var k=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,
        this);this.ComponentType=pc.CollisionComponent;this.DataType=pc.CollisionComponentData;this.schema=e;this.implementations={};this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},k=pc.inherits(k,pc.ComponentSystem);pc.Component._buildAccessors(pc.CollisionComponent.prototype,e);k.prototype=pc.extend(k.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){var d,
        f={};c="type halfExtents radius axis height shape model asset enabled".split(" ");c.forEach(function(a){f[a]=b[a]});b.hasOwnProperty("asset")?(d=c.indexOf("model"),-1!==d&&c.splice(d,1)):b.hasOwnProperty("model")&&(d=c.indexOf("asset"),-1!==d&&c.splice(d,1));f.type||(f.type=a.data.type);a.data.type=f.type;f.halfExtents&&"array"===pc.type(f.halfExtents)&&(f.halfExtents=new pc.Vec3(f.halfExtents[0],f.halfExtents[1],f.halfExtents[2]));d=this._createImplementation(f.type);d.beforeInitialize(a,f);k._super.initializeComponentData.call(this.system,
        a,f,c);d.afterInitialize(a,f)},_createImplementation:function(a){if(void 0===this.implementations[a]){var e;switch(a){case "box":e=new b(this);break;case "sphere":e=new c(this);break;case "capsule":e=new d(this);break;case "cylinder":e=new f(this);break;case "mesh":e=new g(this)}this.implementations[a]=e}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,b)},onRemove:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          b){this.implementations[b.type].remove(a,b)},onUpdate:function(a){var b,c,d=this.store;for(b in d)a=d[b].entity,c=d[b].data,c.enabled&&a.enabled&&!a.rigidbody&&a.trigger&&a.trigger.syncEntityToBody()},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});
        return{CollisionComponentSystem:k}}());pc.extend(pc,function(){return{CollisionComponentData:pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(.5,.5,.5);this.radius=.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.ComponentData)}}());pc.extend(pc,function(){var e="emitterExtents emitterRadius loop initialVelocity animSpeed normalMap".split(" "),a="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animFrames animLoop colorMap localSpace".split(" "),b="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2".split(" "),
        c=["colorMapAsset","normalMapAsset","mesh"],d,f=function(c,d){this.on("set_colorMapAsset",this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);this.on("set_depthSoftening",this.onSetDepthSoftening,this);this.on("set_layers",this.onSetLayers,this);e.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+
            a,this.onSetComplexProperty,this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this));this._requestedDepth=!1},f=pc.inherits(f,pc.Component);pc.extend(f.prototype,{addModelToLayers:function(){if(this.data.model)for(var a,b=0;b<this.layers.length;b++)if(a=this.system.app.scene.layers.getLayerById(this.layers[b]))a.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=a},removeModelFromLayers:function(a){if(this.data.model)for(var b=0;b<this.layers.length;b++)(a=
        this.system.app.scene.layers.getLayerById(this.layers[b]))&&a.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(a,b,c){if(this.data.model){var d;for(a=0;a<b.length;a++)(d=this.system.app.scene.layers.getLayerById(b[a]))&&d.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(a=0;a<c.length;a++)(d=this.system.app.scene.layers.getLayerById(c[a]))&&d.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(a,b){this.addModelToLayers();
        a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(a){this.data.model&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances(this.data.model.meshInstances))},onSetColorMapAsset:function(a,b,c){var d=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off("remove",
        this.onColorMapRemoved,this);if(c)if(c instanceof pc.Asset&&(c=this.data.colorMapAsset=c.id),a=f.get(c))a.on("remove",this.onColorMapRemoved,this),a.ready(function(a){d.colorMap=a.resource}),d.enabled&&d.entity.enabled&&f.load(a);else f.once("add:"+c,function(a){a.on("remove",this.onColorMapRemoved,this);a.ready(function(a){d.colorMap=a.resource});d.enabled&&d.entity.enabled&&f.load(a)});else this.colorMap=null},onColorMapRemoved:function(a){a.off("remove",this.onColorMapRemoved,this);this.colorMapAsset=
        null},onSetNormalMapAsset:function(a,b,c){var d=this,f=this.system.app.assets;b&&(a=f.get(b))&&a.off("remove",this.onNormalMapRemoved,this);if(c)if(c instanceof pc.Asset&&(c=this.data.normalMapAsset=c.id),a=f.get(c))a.on("remove",this.onNormalMapRemoved,this),a.ready(function(a){d.normalMap=a.resource}),d.enabled&&d.entity.enabled&&f.load(a);else f.once("add:"+c,function(a){a.on("remove",this.onNormalMapRemoved,this);a.ready(function(a){d.normalMap=a.resource});d.enabled&&d.entity.enabled&&f.load(a)});
    else this.normalMap=null},onNormalMapRemoved:function(a){a.off("remove",this.onNormalMapRemoved,this);this.normalMapAsset=null},onSetMesh:function(a,b,c){var d=this,f=this.system.app.assets;b&&"number"===typeof b&&(a=f.get(b))&&a.off("remove",this.onMeshRemoved,this);if(c)if(c instanceof pc.Asset&&(c=this.data.mesh=c.id),"number"===typeof c)if(a=f.get(c))a.on("remove",this.onMeshRemoved,this),a.ready(function(a){d._onMeshChanged(a.resource)}),d.enabled&&d.entity.enabled&&f.load(a);else f.once("add:"+
        c,function(a){a.on("remove",this.onMeshRemoved,this);a.ready(function(a){d._onMeshChanged(a.resource)});d.enabled&&d.entity.enabled&&f.load(a)});else this._onMeshChanged(c);else this._onMeshChanged(null)},_onMeshChanged:function(a){!a||a instanceof pc.Mesh||(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onMeshRemoved:function(a){a.off("remove",this.onMeshRemoved,this);this.mesh=null},onSetLoop:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(d||(d=this.system.app.scene.layers.getLayerById(pc.LAYERID_DEPTH)),d&&(d.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&d&&(d.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            b,c){b!==c&&(c?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[a]=c),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,c){this.emitter&&
    (this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var a=0,b=c.length;a<b;a++){var d=this.data[c[a]];if(d){if(!(d instanceof pc.Asset))if(0<=parseInt(d,10))d=this.system.app.assets.get(d);else continue;d&&!d.resource&&this.system.app.assets.load(d)}}this.emitter||(a=this.data.mesh,a instanceof pc.Mesh||(a=null),this.emitter=new pc.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:this.data.numParticles,emitterExtents:this.data.emitterExtents,
        emitterRadius:this.data.emitterRadius,emitterShape:this.data.emitterShape,initialVelocity:this.data.initialVelocity,wrap:this.data.wrap,localSpace:this.data.localSpace,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,animTilesX:this.data.animTilesX,animTilesY:this.data.animTilesY,animNumFrames:this.data.animNumFrames,animSpeed:this.data.animSpeed,animLoop:this.data.animLoop,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,scaleGraph:this.data.scaleGraph,
        scaleGraph2:this.data.scaleGraph2,colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,loop:this.data.loop,
        preWarm:this.data.preWarm,sort:this.data.sort,stretch:this.data.stretch,alignToMotion:this.data.alignToMotion,lighting:this.data.lighting,halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,scene:this.system.app.scene,mesh:a,depthWrite:this.data.depthWrite,noFog:this.data.noFog,node:this.entity,blendType:this.data.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new pc.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,
        this.psys.meshInstances=[this.emitter.meshInstance],this.data.model=this.psys,this.emitter.psys=this.psys,this.data.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1));this.data.model&&this.emitter.colorMap&&this.addModelToLayers();this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this));this.enabled&&this.entity.enabled&&
    this._requestDepth();f._super.onEnable.call(this)},onDisable:function(){f._super.onDisable.call(this);this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth())},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&
    (this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),
        this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a}});return{ParticleSystemComponent:f}}());pc.extend(pc,function(){var e="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterRadius initialVelocity wrap wrapBounds localSpace colorMapAsset normalMapAsset mesh localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animNumFrames animSpeed animLoop layers".split(" "),
        a=function(a){this.id="particlesystem";this.description="Updates and renders particle system in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.ParticleSystemComponent;this.DataType=pc.ParticleSystemComponentData;this.schema=e;this.propertyTypes={emitterExtents:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",
            rotationSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"};this.on("beforeremove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ParticleSystemComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){var f={};d=[];var e=this.propertyTypes,k,l;for(l in c)c.hasOwnProperty(l)&&(d.push(l),f[l]=c[l]),"vec3"===e[l]?"array"===pc.type(f[l])&&(f[l]=new pc.Vec3(f[l][0],f[l][1],
        f[l][2])):"curve"===e[l]?f[l]instanceof pc.Curve||(k=f[l].type,f[l]=new pc.Curve(f[l].keys),f[l].type=k):"curveset"!==e[l]||f[l]instanceof pc.CurveSet||(k=f[l].type,f[l]=new pc.CurveSet(f[l].keys),f[l].type=k),f.layers&&"array"===pc.type(f.layers)&&(f.layers=f.layers.slice(0));a._super.initializeComponentData.call(this,b,f,d)},cloneComponent:function(a,c){for(var d=a.particlesystem.data,f=this.schema,e={},k=0,l=f.length;k<l;k++){var m=f[k],n=d[m];n instanceof pc.Vec3||n instanceof pc.Curve||n instanceof
    pc.CurveSet?(n=n.clone(),e[m]=n):"layers"===m?e.layers=d.layers.slice(0):null!==n&&void 0!==n&&(e[m]=n)}return this.addComponent(c,e)},onUpdate:function(a){var c=this.store,d,f,e,k,l=this.app.stats.particles,m;for(m in c)if(c.hasOwnProperty(m)&&(k=c[m],f=k.entity,d=k.data,d.enabled&&f.enabled)){var n=d.model.emitter;if(n.meshInstance.visible){if(n.lighting){var h,r=d.layers;for(f=0;f<r.length;f++)if(k=this.app.scene.layers.getLayerById(r[f])){k._lightCube||(k._lightCube=new Float32Array(18));h=k._lightCube;
        for(f=0;6>f;f++)h[3*f]=this.app.scene.ambientLight.data[0],h[3*f+1]=this.app.scene.ambientLight.data[1],h[3*f+2]=this.app.scene.ambientLight.data[2];var p=k._sortedLights[pc.LIGHTTYPE_DIRECTIONAL];for(e=0;e<p.length;e++)for(k=0;6>k;k++){var q=Math.max(n.lightCubeDir[k].dot(p[e]._direction),0)*p[e]._intensity;h[3*k]+=p[e]._color.data[0]*q;h[3*k+1]+=p[e]._color.data[1]*q;h[3*k+2]+=p[e]._color.data[2]*q}}n.constantLightCube.setValue(h)}if(!d.paused){n.simTime+=a;d=0;n.simTime>n.fixedTimeStep&&(d=Math.floor(n.simTime/
        n.fixedTimeStep),n.simTime-=d*n.fixedTimeStep);if(d){d=Math.min(d,n.maxSubSteps);for(f=0;f<d;f++)n.addTime(n.fixedTimeStep);l._updatesPerFrame+=d;l._frameTime+=n._addTimeTime;n._addTimeTime=0}n.finishFrame()}}}},onRemove:function(a,c){var d=c.data;d.model&&(a.removeChild(d.model.getGraph()),d.model=null);c.emitter&&(c.emitter.destroy(),c.emitter=null)}});return{ParticleSystemComponentSystem:a}}());pc.extend(pc,function(){return{ParticleSystemComponentData:pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new pc.Vec3;this.emitterRadius=0;this.emitterShape=pc.EMITTERSHAPE_BOX;this.initialVelocity=0;this.wrapBounds=new pc.Vec3;this.localSpace=!1;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.sort=0;this.mode=pc.PARTICLEMODE_GPU;this.scene=
        null;this.halfLambert=this.lighting=!1;this.intensity=1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=null;this.noFog=this.depthWrite=!1;this.animSpeed=this.animNumFrames=this.animTilesY=this.animTilesX=1;this.animLoop=!0;this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=
        pc.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=!1;this.autoPlay=!0;this.layers=[pc.LAYERID_WORLD]},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a,b){this._component=a;this._frame=0;this._spriteAsset=this._sprite=null;this.spriteAsset=b.spriteAsset;this.name=b.name;this.fps=b.fps||0;this.loop=b.loop||!1;this._paused=this._playing=!1;this._time=0;pc.events.attach(this)};e.prototype={_onSpriteAssetAdded:function(a){this._component.system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){a.on("load",this._onSpriteAssetLoad,
        this);a.on("remove",this._onSpriteAssetRemove,this);a.resource?this._onSpriteAssetLoad(a):this._component.system.app.assets.load(a)},_onSpriteAssetLoad:function(a){if(a.resource)if(a.resource.atlas)this.sprite=a.resource;else{a=a.data.textureAtlasAsset;var b=this._component.system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof pc.Asset?this._onSpriteAssetLoad(a):
        this._onSpriteAssetLoad(this._component.system.app.assets.get(a))},_onSpriteAssetRemove:function(a){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SIMPLE&&this._component._showFrame(this.frame)},_update:function(a){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var b=this._time+a*this._component.speed*
        (0>this.fps?-1:1);a=this.duration;var c=b>a||0>b;this._setTime(b);b=this.frame;b=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/a):0;b!==this._frame&&this._setFrame(b);c&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(a){this._time=a;a=this.duration;0>this._time?this._time=this.loop?this._time%a+a:0:this._time>a&&(this._time=this.loop?this._time%a:a)},_setFrame:function(a){this._frame=
        this._sprite?pc.math.clamp(a,0,this._sprite.frameKeys.length-1):a;this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this._sprite=null);this._spriteAsset&&(this._spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&
    (this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}};Object.defineProperty(e.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._component.system.app.assets,c=a;a instanceof pc.Asset&&(c=a.id);this._spriteAsset!==c&&(this._spriteAsset&&(a=b.get(this._spriteAsset))&&(a.off("load",this._onSpriteAssetLoad,
        this),a.off("remove",this._onSpriteAssetRemove,this),(a=a.data&&a.data.textureAtlasAsset)&&b.off("load:"+a,this._onTextureAtlasLoad,this)),(this._spriteAsset=c)?(c=b.get(this._spriteAsset))?this._bindSpriteAsset(c):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}});Object.defineProperty(e.prototype,"sprite",{get:function(){return this._sprite},set:function(a){this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",
        this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this));if(this._sprite=a)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this);if(this._component.currentClip===
        this){var b;if(a&&a.atlas){if(a.atlas.texture){if(b=this._component._meshInstance)b.setParameter("texture_emissiveMap",a.atlas.texture),b.setParameter("texture_opacityMap",a.atlas.texture);this._component.enabled&&this._component.entity.enabled&&this._component._showModel()}this.time&&this.fps?this.time=this.time:this.frame=this.frame}else{if(b=this._component._meshInstance)b.deleteParameter("texture_emissiveMap"),b.deleteParameter("texture_opacityMap");this._component._hideModel()}}}});Object.defineProperty(e.prototype,
        "frame",{get:function(){return this._frame},set:function(a){this._setFrame(a);this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}});Object.defineProperty(e.prototype,"isPlaying",{get:function(){return this._playing}});Object.defineProperty(e.prototype,"isPaused",{get:function(){return this._paused}});Object.defineProperty(e.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}});Object.defineProperty(e.prototype,"time",
        {get:function(){return this._time},set:function(a){this._setTime(a);this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):0}});return{SpriteAnimationClip:e}}());pc.extend(pc,function(){pc.SPRITETYPE_SIMPLE="simple";pc.SPRITETYPE_ANIMATED="animated";var e=function(a,b){this._type=pc.SPRITETYPE_SIMPLE;this._material=a.defaultMaterial;this._color=new pc.Color(1,1,1,1);this._speed=1;this._flipY=this._flipX=!1;this._height=this._width=1;this._drawOrder=0;this._layers=[pc.LAYERID_WORLD];this._outerScale=new pc.Vec2(1,1);this._innerOffset=new pc.Vec4;this._atlasRect=new pc.Vec4;this._batchGroupId=-1;this._batchGroup=null;this._node=new pc.GraphNode;this._model=
        new pc.Model;this._model.graph=this._node;this._meshInstance=null;b.addChild(this._model.graph);this._model._entity=b;this._updateAabbFunc=this._updateAabb.bind(this);this._addedModel=!1;this._autoPlayClip=null;this._clips={};this._currentClip=this._defaultClip=new pc.SpriteAnimationClip(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onEnable:function(){e._super.onEnable.call(this);this.system.app.scene.on("set:layers",this._onLayersChanged,
        this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this._onLayerAdded,this),this.system.app.scene.layers.on("remove",this._onLayerRemoved,this));this._showModel();this._autoPlayClip&&this._tryAutoPlay()},onDisable:function(){e._super.onDisable.call(this);this.system.app.scene.off("set:layers",this._onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this._onLayerAdded,this),this.system.app.scene.layers.off("remove",this._onLayerRemoved,
        this));this.stop();this._hideModel()},onDestroy:function(){this._currentClip=null;this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null);for(var a in this._clips)this._clips[a]._destroy();this._clips=null;this._hideModel();this._model=null;this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null);this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var a,
        b,c=[this._meshInstance];a=0;for(b=this._layers.length;a<b;a++){var d=this.system.app.scene.layers.getLayerById(this._layers[a]);d&&d.addMeshInstances(c)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var a,b,c=[this._meshInstance];a=0;for(b=this._layers.length;a<b;a++){var d=this.system.app.scene.layers.getLayerById(this._layers[a]);d&&d.removeMeshInstances(c)}this._addedModel=!1}},_showFrame:function(a){if(this.sprite){var b=this.sprite.meshes[a];if(b){var c=
        this.system.defaultMaterial;this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?c=this.system.default9SlicedMaterialSlicedMode:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED&&(c=this.system.default9SlicedMaterialTiledMode);this._meshInstance||(this._meshInstance=new pc.MeshInstance(this._node,b,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._meshInstance.setParameter("material_emissive",
        this._color.data3),this._meshInstance.setParameter("material_opacity",this._color.data[3]),this.enabled&&this.entity.enabled&&this._showModel());this._meshInstance.material!==c&&(this._meshInstance.material=c);this._meshInstance.mesh!==b&&(this._meshInstance.mesh=b,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1);this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",
        this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"));!this.sprite.atlas||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(a=this.sprite.atlas.frames[this.sprite.frameKeys[a]])?(b=2/a.rect.z,c=2/a.rect.w,this._innerOffset.set(a.border.x*b,a.border.y*c,a.border.z*
        b,a.border.w*c),b=this.sprite.atlas.texture,this._atlasRect.set(a.rect.x/b.width,a.rect.y/b.height,a.rect.z/b.width,a.rect.w/b.height)):this._innerOffset.set(0,0,0,0),this._meshInstance.setParameter("innerOffset",this._innerOffset.data),this._meshInstance.setParameter("atlasRect",this._atlasRect.data));this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var a=this.flipX?-1:1,b=this.flipY?-1:1,c=0,d=0;if(this.sprite&&
        (this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED||this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED)){var f=1,e=1;if(this.sprite.atlas){var k=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];k&&(f=k.rect.z,e=k.rect.w,c=(.5-k.pivot.x)*this._width,d=(.5-k.pivot.y)*this._height)}f/=this.sprite.pixelsPerUnit;e/=this.sprite.pixelsPerUnit;this._outerScale.set(Math.max(this._width,this._innerOffset.x*f),Math.max(this._height,this._innerOffset.y*e));b*=e;this._outerScale.x/=f;this._outerScale.y/=
        e;a=a*f*pc.math.clamp(this._width/(this._innerOffset.x*f),1E-4,1);b*=pc.math.clamp(this._height/(this._innerOffset.y*e),1E-4,1);this._meshInstance&&this._meshInstance.setParameter("outerScale",this._outerScale.data,4294967295)}this._node.setLocalScale(a,b,1);this._node.setLocalPosition(c,d,0)},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._node.getWorldTransform());return a},_tryAutoPlay:function(){if(this._autoPlayClip&&
        this.type===pc.SPRITETYPE_ANIMATED){var a=this._clips[this._autoPlayClip];!a||a.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(a.name)}},_onLayersChanged:function(a,b){a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this);this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(a){0>this.layers.indexOf(a.id)||this._addedModel&&
    this.enabled&&this.entity.enabled&&this._meshInstance&&a.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(a){this._meshInstance&&(0>this.layers.indexOf(a.id)||a.removeMeshInstances([this._meshInstance]))},addClip:function(a){var b=new pc.SpriteAnimationClip(this,{name:a.name,fps:a.fps,loop:a.loop,spriteAsset:a.spriteAsset});this._clips[a.name]=b;b.name&&b.name===this._autoPlayClip&&this._tryAutoPlay();return b},removeClip:function(a){delete this._clips[a]},clip:function(a){return this._clips[a]},
        play:function(a){var b=this._clips[a],c=this._currentClip;c&&c!==b&&(c._playing=!1);(this._currentClip=b)?(this._currentClip=b,this._currentClip.play()):logWARNING("Trying to play sprite animation "+a+" which does not exist.");return b},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&
        this._currentClip.stop()}});Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(a){this._type!==a&&(this._type=a,this._type===pc.SPRITETYPE_SIMPLE?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):this._type===pc.SPRITETYPE_ANIMATED&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&
    this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}});Object.defineProperty(e.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(a){this._currentClip.frame=a}});Object.defineProperty(e.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(a){this._defaultClip.spriteAsset=a}});Object.defineProperty(e.prototype,"sprite",{get:function(){return this._currentClip.sprite},set:function(a){this._currentClip.sprite=a}});
        Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(a){this._material=a;this._meshInstance&&(this._meshInstance.material=a)}});Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(a){this._color.data[0]=a.data[0];this._color.data[1]=a.data[1];this._color.data[2]=a.data[2];this._meshInstance&&this._meshInstance.setParameter("material_emissive",this._color.data3)}});Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},
            set:function(a){this._color.data[3]=a;this._meshInstance&&this._meshInstance.setParameter("material_opacity",a)}});Object.defineProperty(e.prototype,"clips",{get:function(){return this._clips},set:function(a){var b,c;if(a){for(b in this._clips){var d=!1;for(c in a)if(a[c].name===b){d=!0;this._clips[b].fps=a[c].fps;this._clips[b].loop=a[c].loop;a[c].hasOwnProperty("sprite")?this._clips[b].sprite=a[c].sprite:a[c].hasOwnProperty("spriteAsset")&&(this._clips[b].spriteAsset=a[c].spriteAsset);break}d||
        this.removeClip(b)}for(c in a)this._clips[a[c].name]||this.addClip(a[c]);this._autoPlayClip&&this._tryAutoPlay();this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(b in this._clips)this.removeClip(b)}});Object.defineProperty(e.prototype,"currentClip",{get:function(){return this._currentClip}});Object.defineProperty(e.prototype,"speed",{get:function(){return this._speed},set:function(a){this._speed=a}});Object.defineProperty(e.prototype,"flipX",{get:function(){return this._flipX},
            set:function(a){this._flipX!==a&&(this._flipX=a,this._updateTransform())}});Object.defineProperty(e.prototype,"flipY",{get:function(){return this._flipY},set:function(a){this._flipY!==a&&(this._flipY=a,this._updateTransform())}});Object.defineProperty(e.prototype,"width",{get:function(){return this._width},set:function(a){a!==this._width&&(this._width=a,this._outerScale.x=this._width,!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED||
        this._updateTransform())}});Object.defineProperty(e.prototype,"height",{get:function(){return this._height},set:function(a){a!==this._height&&(this._height=a,this._outerScale.y=this.height,!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED||this._updateTransform())}});Object.defineProperty(e.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){if(this._batchGroupId!==a){var b=this._batchGroupId;this._batchGroupId=
            a;0<=b&&this.system.app.batcher._markGroupDirty(b);0<=this._batchGroupId?this.system.app.batcher._markGroupDirty(this._batchGroupId):0<=b&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}});Object.defineProperty(e.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(a){this._autoPlayClip=a instanceof pc.SpriteAnimationClip?a.name:a;this._tryAutoPlay()}});Object.defineProperty(e.prototype,"drawOrder",{get:function(){return this._drawOrder},
            set:function(a){this._drawOrder=a;this._meshInstance&&(this._meshInstance.drawOrder=a)}});Object.defineProperty(e.prototype,"layers",{get:function(){return this._layers},set:function(a){this._addedModel&&this._hideModel();this._layers=a;this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}});return{SpriteComponent:e}}());pc.extend(pc,function(){var e=["enabled"],a=!1,b=function(a){this.id="sprite";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.SpriteComponent;this.DataType=pc.SpriteComponentData;this.schema=e;this._defaultTexture=new pc.Texture(a.graphicsDevice,{width:1,height:1,format:pc.PIXELFORMAT_R8_G8_B8_A8});a=this._defaultTexture.lock();var b=new Uint8Array(4);b[0]=255;b[1]=255;b[2]=255;b[3]=255;a.set(b);this._defaultTexture.unlock();this.defaultMaterial=new pc.StandardMaterial;this.defaultMaterial.diffuse=
        new pc.Color(0,0,0,1);this.defaultMaterial.emissive=new pc.Color(.5,.5,.5,1);this.defaultMaterial.emissiveMap=this._defaultTexture;this.defaultMaterial.emissiveMapTint=!0;this.defaultMaterial.opacityMap=this._defaultTexture;this.defaultMaterial.opacityMapChannel="a";this.defaultMaterial.opacityTint=!0;this.defaultMaterial.opacity=0;this.defaultMaterial.useLighting=!1;this.defaultMaterial.useGammaTonemap=!1;this.defaultMaterial.useFog=!1;this.defaultMaterial.useSkybox=!1;this.defaultMaterial.blendType=
        pc.BLEND_PREMULTIPLIED;this.defaultMaterial.depthWrite=!1;this.defaultMaterial.pixelSnap=!1;this.defaultMaterial.cull=pc.CULLFACE_NONE;this.defaultMaterial.update();this.default9SlicedMaterialSlicedMode=this.defaultMaterial.clone();this.default9SlicedMaterialSlicedMode.chunks.basePS=pc.shaderChunks.basePS+"varying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvec2 nineSlicedUv;";this.default9SlicedMaterialSlicedMode.chunks.startPS=
        pc.shaderChunks.startPS+"nineSlicedUv = vUv0;\n";this.default9SlicedMaterialSlicedMode.chunks.emissivePS=pc.shaderChunks.emissivePS.replace("$UV","nineSlicedUv");this.default9SlicedMaterialSlicedMode.chunks.opacityPS=pc.shaderChunks.opacityPS.replace("$UV","nineSlicedUv");this.default9SlicedMaterialSlicedMode.chunks.transformVS="#define NINESLICED\n"+pc.shaderChunks.transformVS;this.default9SlicedMaterialSlicedMode.chunks.uv0VS=pc.shaderChunks.uv9SliceVS;this.default9SlicedMaterialSlicedMode.update();
        this.default9SlicedMaterialTiledMode=this.defaultMaterial.clone();this.default9SlicedMaterialTiledMode.chunks.basePS=pc.shaderChunks.basePS+"#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvec2 nineSlicedUv;";this.default9SlicedMaterialTiledMode.chunks.startPS=pc.shaderChunks.startPS+"vec2 tileMask = step(vMask, vec2(0.99999));\nvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\nclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\nnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);";
        this.default9SlicedMaterialTiledMode.chunks.emissivePS=pc.shaderChunks.emissivePS.replace("$UV","nineSlicedUv, -1000.0");this.default9SlicedMaterialTiledMode.chunks.opacityPS=pc.shaderChunks.opacityPS.replace("$UV","nineSlicedUv, -1000.0");this.default9SlicedMaterialTiledMode.chunks.transformVS="#define NINESLICED\n"+pc.shaderChunks.transformVS;this.default9SlicedMaterialTiledMode.chunks.uv0VS=pc.shaderChunks.uv9SliceVS;this.default9SlicedMaterialTiledMode.update();pc.ComponentSystem.on("update",
            this.onUpdate,this);this.on("beforeremove",this.onBeforeRemove,this)},b=pc.inherits(b,pc.ComponentSystem);pc.Component._buildAccessors(pc.SpriteComponent.prototype,e);pc.extend(b.prototype,{initializeComponentData:function(c,d,f){void 0!==d.enabled&&(c.enabled=d.enabled);c.type=d.type;d.layers&&"array"===pc.type(d.layers)&&(c.layers=d.layers.slice(0));void 0!==d.drawOrder&&(c.drawOrder=d.drawOrder);void 0!==d.color&&(d.color instanceof pc.Color?c.color.set(d.color.data[0],d.color.data[1],d.color.data[2],
        void 0!==d.opacity?d.opacity:1):c.color.set(d.color[0],d.color[1],d.color[2],void 0!==d.opacity?d.opacity:1),c.color=c.color);void 0!==d.opacity&&(c.opacity=d.opacity);void 0!==d.flipX&&(c.flipX=d.flipX);void 0!==d.flipY&&(c.flipY=d.flipY);void 0!==d.width&&(c.width=d.width);void 0!==d.height&&(c.height=d.height);void 0!==d.spriteAsset&&(c.spriteAsset=d.spriteAsset);d.sprite&&(c.sprite=d.sprite);void 0!==d.frame&&(c.frame=d.frame);if(d.clips)for(var e in d.clips)c.addClip(d.clips[e]);void 0!==d.speed&&
    (c.speed=d.speed);d.autoPlayClip&&(c.autoPlayClip=d.autoPlayClip);c.batchGroupId=void 0===d.batchGroupId||null===d.batchGroupId?-1:d.batchGroupId;b._super.initializeComponentData.call(this,c,d,f);a||(console.warn("The Sprite component is in beta and might change without notice."),a=!0)},cloneComponent:function(a,b){var f=a.sprite;return this.addComponent(b,{enabled:f.enabled,type:f.type,spriteAsset:f.spriteAsset,sprite:f.sprite,frame:f.frame,color:f.color.clone(),opacity:f.opacity,flipX:f.flipX,flipY:f.flipY,
        speed:f.speed,clips:f.clips,batchGroupId:f.batchGroupId})},onUpdate:function(a){var b=this.store,f;for(f in b)if(b.hasOwnProperty(f)){var e=b[f];e.data.enabled&&e.entity.enabled&&(e=e.entity.sprite,e._currentClip&&e._currentClip._update(a))}},onBeforeRemove:function(a,b){b.onDestroy()}});return{SpriteComponentSystem:b}}());pc.extend(pc,function(){return{SpriteComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){pc.SCALEMODE_NONE="none";pc.SCALEMODE_BLEND="blend";var e=function(a,c){this._resolution=new pc.Vec2(640,320);this._referenceResolution=new pc.Vec2(640,320);this._scaleMode=pc.SCALEMODE_NONE;this.scale=1;this._scaleBlend=.5;this._screenSpace=!1;this._screenMatrix=new pc.Mat4;a.app.graphicsDevice.on("resizecanvas",this._onResize,this)},e=pc.inherits(e,pc.Component),a=new pc.Mat4;pc.extend(e.prototype,{syncDrawOrder:function(){var a=1,c=function(d){d.element&&(d.element.drawOrder=
        a++);d=d.getChildren();for(var f=0;f<d.length;f++)c(d[f])};c(this.entity)},_calcProjectionMatrix:function(){var b=this._resolution.x/this.scale,c=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,b,-c,0,1,-1);this._screenSpace||(a.setScale(.5*b,.5*c,1),this._screenMatrix.mul2(a,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(a,c){return Math.pow(2,Math.log2(a.x/c.x)*(1-this._scaleBlend)+Math.log2(a.y/
        c.y)*this._scaleBlend)},_onResize:function(a,c){this._screenSpace&&(this._resolution.set(a,c),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this);this.fire("remove")}});Object.defineProperty(e.prototype,"resolution",{set:function(a){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();
        this.entity._dirtyLocal||this.entity._dirtify(!0);this.fire("set:resolution",this._resolution)},get:function(){return this._resolution}});Object.defineProperty(e.prototype,"referenceResolution",{set:function(a){this._referenceResolution.set(a.x,a.y);this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtify(!0);this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===pc.SCALEMODE_NONE?this._resolution:this._referenceResolution}});
        Object.defineProperty(e.prototype,"screenSpace",{set:function(a){(this._screenSpace=a)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height);this.resolution=this._resolution;this.entity._dirtyLocal||this.entity._dirtify(!0);this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}});Object.defineProperty(e.prototype,"scaleMode",{set:function(a){a!==pc.SCALEMODE_NONE&&a!==pc.SCALEMODE_BLEND&&(a=pc.SCALEMODE_NONE);this._screenSpace||
        a===pc.SCALEMODE_NONE||(a=pc.SCALEMODE_NONE);this._scaleMode=a;this.resolution=this._resolution;this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}});Object.defineProperty(e.prototype,"scaleBlend",{set:function(a){this._scaleBlend=a;this._updateScale();this._calcProjectionMatrix();this.entity._dirtyLocal||this.entity._dirtify(!0);this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}});return{ScreenComponent:e}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="screen";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.ScreenComponent;this.DataType=pc.ScreenComponentData;this.schema=e;this.windowResolution=new pc.Vec2;this.app.graphicsDevice.on("resizecanvas",this._onResize,this);pc.ComponentSystem.on("update",this._onUpdate,this);this.on("beforeremove",this.onRemoveComponent,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ScreenComponent.prototype,e);pc.extend(a.prototype,
        {initializeComponentData:function(b,c,d){void 0!==c.screenSpace&&(b.screenSpace=c.screenSpace);void 0!==c.scaleMode&&(b.scaleMode=c.scaleMode);void 0!==c.scaleBlend&&(b.scaleBlend=c.scaleBlend);void 0!==c.resolution&&(c.resolution instanceof pc.Vec2?b._resolution.copy(c.resolution):b._resolution.set(c.resolution[0],c.resolution[1]),b.resolution=b._resolution);void 0!==c.referenceResolution&&(c.referenceResolution instanceof pc.Vec2?b._referenceResolution.copy(c.referenceResolution):b._referenceResolution.set(c.referenceResolution[0],
            c.referenceResolution[1]),b.referenceResolution=b._referenceResolution);a._super.initializeComponentData.call(this,b,c,d)},_onUpdate:function(a){var c=this.store,d;for(d in c)c[d].entity.screen.update&&c[d].entity.screen.update(a)},_onResize:function(a,c){this.windowResolution.x=a;this.windowResolution.y=c},cloneComponent:function(a,c){var d=a.screen;return this.addComponent(c,{enabled:d.enabled,screenSpace:d.screenSpace,scaleMode:d.scaleMode,resolution:d.resolution.clone(),referenceResolution:d.referenceResolution.clone()})},
            onRemoveComponent:function(a,c){c.onRemove()}});return{ScreenComponentSystem:a}}());pc.extend(pc,function(){return{ScreenComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){var e=[];pc.ELEMENTTYPE_GROUP="group";pc.ELEMENTTYPE_IMAGE="image";pc.ELEMENTTYPE_TEXT="text";var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,d=new pc.Mat4,f=new pc.Mat4,g=new pc.Mat4,k=function(a,b){this._anchor=new pc.Vec4;this._localAnchor=new pc.Vec4;this._pivot=new pc.Vec2;this._height=this._calculatedHeight=this._width=this._calculatedWidth=32;this._margin=new pc.Vec4(0,0,-32,-32);this._modelTransform=new pc.Mat4;this._screenToWorld=new pc.Mat4;this._anchorTransform=new pc.Mat4;
        this._anchorDirty=!0;this._parentWorldTransform=new pc.Mat4;this._screenTransform=new pc.Mat4;this._screenCorners=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];this._canvasCorners=[new pc.Vec2,new pc.Vec2,new pc.Vec2,new pc.Vec2];this._worldCorners=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3];this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0;this.entity.on("insert",this._onInsert,this);this._patch();this.screen=null;this._type=pc.ELEMENTTYPE_GROUP;this._group=this._text=
            this._image=null;this._useInput=!1;this._layers=[pc.LAYERID_UI];this._addedModel=null;this._batchGroupId=-1},k=pc.inherits(k,pc.Component);pc.extend(k.prototype,{_patch:function(){this.entity._sync=this._sync;this.entity.setPosition=this._setPosition;this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=pc.Entity.prototype._sync;this.entity.setPosition=pc.Entity.prototype.setPosition;this.entity.setLocalPosition=pc.Entity.prototype.setLocalPosition},_setPosition:function(){var a=
        new pc.Vec3,b=new pc.Mat4;return function(c,d,f){if(!this.element.screen)return pc.Entity.prototype.setPosition.call(this,c,d,f);c instanceof pc.Vec3?a.copy(c):a.set(c,d,f);this.getWorldTransform();b.copy(this.element._screenToWorld).invert();b.transformPoint(a,this.localPosition);this._dirtyLocal||this._dirtify(!0)}}(),_setLocalPosition:function(a,b,c){a instanceof pc.Vec3?this.localPosition.copy(a):this.localPosition.set(a,b,c);a=this.element;b=this.localPosition.data;c=a._pivot.data;a._margin.data[0]=
        b[0]-a._calculatedWidth*c[0];a._margin.data[2]=a._localAnchor.data[2]-a._localAnchor.data[0]-a._calculatedWidth-a._margin.data[0];a._margin.data[1]=b[1]-a._calculatedHeight*c[1];a._margin.data[3]=a._localAnchor.data[3]-a._localAnchor.data[1]-a._calculatedHeight-a._margin.data[1];this._dirtyLocal||this._dirtify(!0)},_sync:function(){var e=this.element,g=e.screen;if(g){if(e._anchorDirty){var h=0,k=0,l=0,q=1;this._parent&&this._parent.element?(h=this._parent.element.calculatedWidth,k=this._parent.element.calculatedHeight,
        l=this._parent.element.pivot.x,q=this._parent.element.pivot.y):(k=g.screen.resolution,h=k.x/g.screen.scale,k=k.y/g.screen.scale);e._anchorTransform.setTranslate(h*(e.anchor.x-l),-(k*(q-e.anchor.y)),0);e._anchorDirty=!1;e._calculateLocalAnchors()}e._sizeDirty&&e._calculateSize()}this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),h=this.localPosition.data,l=e._pivot.data,e._margin.data[0]=h[0]-e._calculatedWidth*l[0],e._margin.data[2]=e._localAnchor.data[2]-
        e._localAnchor.data[0]-e._calculatedWidth-e._margin.data[0],e._margin.data[1]=h[1]-e._calculatedHeight*l[1],e._margin.data[3]=e._localAnchor.data[3]-e._localAnchor.data[1]-e._calculatedHeight-e._margin.data[1],this._dirtyLocal=!1);if(!g)return this._dirtyWorld&&(e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0),pc.Entity.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?e._screenToWorld.mul2(this._parent.element._modelTransform,
        e._anchorTransform):e._screenToWorld.copy(e._anchorTransform),e._modelTransform.mul2(e._screenToWorld,this.localTransform),g?(e._screenToWorld.mul2(g.screen._screenMatrix,e._screenToWorld),g.screen.screenSpace||e._screenToWorld.mul2(g.worldTransform,e._screenToWorld),this.worldTransform.mul2(e._screenToWorld,this.localTransform),h=e._parentWorldTransform,h.setIdentity(),(l=this._parent)&&l.element&&l!==g&&(c.setTRS(pc.Vec3.ZERO,l.getLocalRotation(),l.getLocalScale()),h.mul2(l.element._parentWorldTransform,
        c)),a.set(0,0,this.localPosition.z),b.set(e._absLeft+e._pivot.x*e.calculatedWidth,e._absBottom+e._pivot.y*e.calculatedHeight,0),c.setTranslate(-b.x,-b.y,-b.z),d.setTRS(a,this.getLocalRotation(),this.getLocalScale()),f.setTranslate(b.x,b.y,b.z),e._screenTransform.mul2(e._parentWorldTransform,f).mul(d).mul(c),e._cornersDirty=!0,e._canvasCornersDirty=!0,e._worldCornersDirty=!0):this.worldTransform.copy(e._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(a){a=this._parseUpToScreen();this.entity._dirtify();
        this._updateScreen(a.screen);this._dirtifyMask()},_dirtifyMask:function(){for(var a=this.entity;a;){var b=a.getParent();if((null===b||b.screen)&&a.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var c=this.system._prerender.indexOf(this.entity);0<=c&&this.system._prerender.splice(c,1);0>this.system._prerender.indexOf(a)&&this.system._prerender.push(a)}a=b}},_onPrerender:function(){for(var a=0,b=0;b<
    this.system._prerender.length;b++)a=this.system._prerender[b].element.syncMask(a)+1;this.system._prerender.length=0},_updateScreen:function(a){this.screen&&this.screen!==a&&(this.screen.screen.off("set:resolution",this._onScreenResize,this),this.screen.screen.off("set:referenceresolution",this._onScreenResize,this),this.screen.screen.off("set:scaleblend",this._onScreenResize,this),this.screen.screen.off("set:screenspace",this._onScreenSpaceChange,this),this.screen.screen.off("remove",this._onScreenRemove,
        this));if(this.screen=a)this.screen.screen.on("set:resolution",this._onScreenResize,this),this.screen.screen.on("set:referenceresolution",this._onScreenResize,this),this.screen.screen.on("set:scaleblend",this._onScreenResize,this),this.screen.screen.on("set:screenspace",this._onScreenSpaceChange,this),this.screen.screen.on("remove",this._onScreenRemove,this);this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("set:screen",this.screen);this._anchorDirty=!0;for(var b=this.entity.getChildren(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     c=0,d=b.length;c<d;c++)b[c].element&&b[c].element._updateScreen(a);this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(a){var b=this._parseUpToScreen();return this._updateMask(b.mask,a)},_setMaskedBy:function(a){var b,c,d,f=this._image||this._text;if(f)if(a){var e=new pc.StencilParameters({ref:a.element._image._maskRef,func:pc.FUNC_EQUAL});b=0;for(d=f._model.meshInstances.length;b<d;b++)c=f._model.meshInstances[b],c.stencilFront=c.stencilBack=e;f._maskedBy=a}else{b=0;for(d=f._model.meshInstances.length;b<
    d;b++)c=f._model.meshInstances[b],c.stencilFront=c.stencilBack=null;f._maskedBy=null}},_getMaskDepth:function(){for(var a=1,b=this.entity;b;)(b=b.getParent())&&b.element&&b.element.mask&&a++;return a},_updateMask:function(a,b){var c,d,f;b||(b=1);a?(this._setMaskedBy(a),this.mask&&(c=new pc.StencilParameters({ref:b++,func:pc.FUNC_EQUAL,zpass:pc.STENCILOP_INCREMENT}),this._image._meshInstance.stencilFront=c,this._image._meshInstance.stencilBack=c,this._image._maskRef=b,a=this.entity)):(this._setMaskedBy(null),
    this.mask&&(c=new pc.StencilParameters({func:pc.FUNC_ALWAYS,zpass:pc.STENCILOP_REPLACE,ref:b}),this._image._meshInstance.stencilFront=c,this._image._meshInstance.stencilBack=c,this._image._maskRef=b,a=this.entity));f=this.entity.getChildren();c=0;for(d=f.length;c<d;c++)f[c].element&&f[c].element._updateMask(a,b);return b},_parseUpToScreen:function(){for(var a={screen:null,mask:null},b=this.entity._parent;b&&!b.screen;)b.element&&b.element.mask&&!a.mask&&(a.mask=b),b=b.parent;b&&b.screen&&(a.screen=
        b);return a},_onScreenResize:function(a){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0;this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY);this.fire("screen:set:resolution",a)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this._updateScreen(null)},_calculateLocalAnchors:function(){var a=1E3,b=1E3,c=this.entity._parent;c&&c.element?(a=c.element.calculatedWidth,b=c.element.calculatedHeight):
        this.screen&&(b=this.screen.screen.resolution,c=this.screen.screen.scale,a=b.x/c,b=b.y/c);this._localAnchor.set(this._anchor.x*a,this._anchor.y*b,this._anchor.z*a,this._anchor.w*b)},getOffsetPosition:function(a,b){var c=this.entity.getLocalPosition().clone();c.x+=a;c.y+=b;this._screenToWorld.transformPoint(c,c);return c},onLayersChanged:function(a,b){this.addModelToLayers(this._image?this._image._model:this._text._model);a.off("add",this.onLayerAdded,this);a.off("remove",this.onLayerRemoved,this);
        b.on("add",this.onLayerAdded,this);b.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(a){0>this.layers.indexOf(a.id)||(this._image?a.addMeshInstances(this._image._model.meshInstances):this._text&&a.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(a){0>this.layers.indexOf(a.id)||(this._image?a.removeMeshInstances(this._image._model.meshInstances):this._text&&a.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){k._super.onEnable.call(this);
        if(this._image)this._image.onEnable();if(this._text)this._text.onEnable();if(this._group)this._group.onEnable();this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this);this.mask&&1===this._getMaskDepth()&&(this._topMask=!0,0>e.indexOf(this)&&e.push(this));this.system.app.scene.on("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,
            this));this.fire("enableelement")},onDisable:function(){k._super.onDisable.call(this);this.system.app.scene.off("set:layers",this.onLayersChanged,this);this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this));if(this._image)this._image.onDisable();if(this._text)this._text.onDisable();if(this._group)this._group.onDisable();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);
        if(this._topMask){var a=e.indexOf(this);0<=a&&e.splice(a,1);this._topMask=!1}this.fire("disableelement")},onRemove:function(){this.entity.off("insert",this._onInsert,this);this._unpatch();this._image&&this._image.destroy();this._text&&this._text.destroy();this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this);if(this._topMask){var a=e.indexOf(this);0<=a&&e.splice(a,1);this._topMask=!1}},_calculateSize:function(a,b){if(this.entity._parent||this.screen){this._calculateLocalAnchors();
        var c=this._absRight-this._absLeft,d=this._absTop-this._absBottom;a?this._setWidth(c):this._setCalculatedWidth(c,!1);b?this._setHeight(d):this._setCalculatedHeight(d,!1);c=this.entity.getLocalPosition();c.x=this._margin.data[0]+this._calculatedWidth*this._pivot.data[0];c.y=this._margin.data[1]+this._calculatedHeight*this._pivot.data[1];this.entity.setLocalPosition(c);this._sizeDirty=!1}},_setWidth:function(a){this._width=a;this._setCalculatedWidth(a,!1);this.fire("set:width",this._width)},_setHeight:function(a){this._height=
        a;this._setCalculatedHeight(a,!1);this.fire("set:height",this._height)},_setCalculatedWidth:function(a,b){var c=1E-4<Math.abs(a-this._calculatedWidth);this._calculatedWidth=a;if(b){var d=this.entity.getLocalPosition().data;this._margin.data[0]=d[0]-this._calculatedWidth*this._pivot.data[0];this._margin.data[2]=this._localAnchor.data[2]-this._localAnchor.data[0]-this._calculatedWidth-this._margin.data[0]}this._flagChildrenAsDirty();this.fire("set:calculatedWidth",this._calculatedWidth);c&&this.fire("resize",
        this._calculatedWidth,this._calculatedHeight)},_setCalculatedHeight:function(a,b){var c=1E-4<Math.abs(a-this._calculatedHeight);this._calculatedHeight=a;if(b){var d=this.entity.getLocalPosition().data;this._margin.data[1]=d[1]-this._calculatedHeight*this._pivot.data[1];this._margin.data[3]=this._localAnchor.data[3]-this._localAnchor.data[1]-this._calculatedHeight-this._margin.data[1]}this._flagChildrenAsDirty();this.fire("set:calculatedHeight",this._calculatedHeight);c&&this.fire("resize",this._calculatedWidth,
        this._calculatedHeight)},_flagChildrenAsDirty:function(){var a,b,c=this.entity._children;a=0;for(b=c.length;a<b;a++)c[a].element&&(c[a].element._anchorDirty=!0,c[a].element._sizeDirty=!0)},addModelToLayers:function(a){var b;this._addedModel=a;for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&b.addMeshInstances(a.meshInstances)},removeModelFromLayers:function(a){var b;this._addedModel=null;for(var c=0;c<this.layers.length;c++)(b=this.system.app.scene.layers.getLayerById(this.layers[c]))&&
    b.removeMeshInstances(a.meshInstances)}});Object.defineProperty(k.prototype,"type",{get:function(){return this._type},set:function(a){a!==this._type&&(this._type=a,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),a===pc.ELEMENTTYPE_IMAGE?this._image=new pc.ImageElement(this):a===pc.ELEMENTTYPE_TEXT&&(this._text=new pc.TextElement(this)))}});Object.defineProperty(k.prototype,"layers",{get:function(){return this._layers},set:function(a){var b,
        c;if(this._addedModel)for(b=0;b<this._layers.length;b++)(c=this.system.app.scene.layers.getLayerById(this._layers[b]))&&c.removeMeshInstances(this._addedModel.meshInstances);this._layers=a;if(this.enabled&&this.entity.enabled&&this._addedModel)for(b=0;b<this._layers.length;b++)(c=this.system.app.scene.layers.getLayerById(this._layers[b]))&&c.addMeshInstances(this._addedModel.meshInstances)}});Object.defineProperty(k.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(a){this._drawOrder=
        a;this.fire("set:draworder",this._drawOrder)}});Object.defineProperty(k.prototype,"_absLeft",{get:function(){return this._localAnchor.data[0]+this._margin.data[0]}});Object.defineProperty(k.prototype,"_absRight",{get:function(){return this._localAnchor.data[2]-this._margin.data[2]}});Object.defineProperty(k.prototype,"_absTop",{get:function(){return this._localAnchor.data[3]-this._margin.data[3]}});Object.defineProperty(k.prototype,"_absBottom",{get:function(){return this._localAnchor.data[1]+this._margin.data[1]}});
        Object.defineProperty(k.prototype,"margin",{get:function(){return this._margin},set:function(a){this._margin.copy(a);this._calculateSize(!0,!0)}});Object.defineProperty(k.prototype,"left",{get:function(){return this._margin.data[0]},set:function(a){this._margin.data[0]=a;var b=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.data[0]+a));b.x=a+this._calculatedWidth*this._pivot.data[0];this.entity.setLocalPosition(b)}});Object.defineProperty(k.prototype,"right",{get:function(){return this._margin.data[2]},
            set:function(a){this._margin.data[2]=a;var b=this.entity.getLocalPosition();this._setWidth(this._localAnchor.data[2]-a-this._absLeft);b.x=this._localAnchor.data[2]-this._localAnchor.data[0]-a-this._calculatedWidth*(1-this._pivot.data[0]);this.entity.setLocalPosition(b)}});Object.defineProperty(k.prototype,"top",{get:function(){return this._margin.data[3]},set:function(a){this._margin.data[3]=a;var b=this.entity.getLocalPosition();this._setHeight(this._localAnchor.data[3]-a-this._absBottom);b.y=this._localAnchor.data[3]-
            this._localAnchor.data[1]-a-this._calculatedHeight*(1-this._pivot.data[1]);this.entity.setLocalPosition(b)}});Object.defineProperty(k.prototype,"bottom",{get:function(){return this._margin.data[1]},set:function(a){this._margin.data[1]=a;var b=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.data[1]+a));b.y=a+this._calculatedHeight*this._pivot.data[1];this.entity.setLocalPosition(b)}});Object.defineProperty(k.prototype,"width",{get:function(){return this._width},set:function(a){this._width=
            a;this._setCalculatedWidth(a,!0);this.fire("set:width",this._width)}});Object.defineProperty(k.prototype,"height",{get:function(){return this._height},set:function(a){this._height=a;this._setCalculatedHeight(a,!0);this.fire("set:height",this._height)}});Object.defineProperty(k.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(a){this._setCalculatedWidth(a,!0)}});Object.defineProperty(k.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},
            set:function(a){this._setCalculatedHeight(a,!0)}});Object.defineProperty(k.prototype,"pivot",{get:function(){return this._pivot},set:function(a){var b=this._pivot.x,c=this._pivot.y;a instanceof pc.Vec2?this._pivot.set(a.x,a.y):this._pivot.set(a[0],a[1]);a=this._margin.data[0]+this._margin.data[2];b=this._pivot.x-b;this._margin.data[0]+=a*b;this._margin.data[2]-=a*b;b=this._margin.data[1]+this._margin.data[3];c=this._pivot.y-c;this._margin.data[1]+=b*c;this._margin.data[3]-=b*c;this._worldCornersDirty=
            this._cornersDirty=this._anchorDirty=!0;this._calculateSize();this.fire("set:pivot",this._pivot)}});Object.defineProperty(k.prototype,"anchor",{get:function(){return this._anchor},set:function(a){a instanceof pc.Vec4?this._anchor.set(a.x,a.y,a.z,a.w):this._anchor.set(a[0],a[1],a[2],a[3]);this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors();this._anchorDirty=!0;this.entity._dirtyLocal||this.entity._dirtify(!0);this.fire("set:anchor",
            this._anchor)}});Object.defineProperty(k.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.data[0]-this._anchor.data[2])}});Object.defineProperty(k.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.data[1]-this._anchor.data[3])}});Object.defineProperty(k.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var a=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];
            this._screenCorners[0].set(this._absLeft,this._absBottom,0);this._screenCorners[1].set(this._absRight,this._absBottom,0);this._screenCorners[2].set(this._absRight,this._absTop,0);this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var b=this.screen.screen.screenSpace,c=0;4>c;c++)this._screenTransform.transformPoint(this._screenCorners[c],this._screenCorners[c]),b&&this._screenCorners[c].scale(this.screen.screen.scale),a&&this._screenCorners[c].add(a);this._cornersDirty=!1;this._worldCornersDirty=
                this._canvasCornersDirty=!0;return this._screenCorners}});Object.defineProperty(k.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var a=this.system.app.graphicsDevice,b=this.screenCorners,c=a.canvas.clientWidth/a.width,d=a.canvas.clientHeight/a.height,f=0;4>f;f++)this._canvasCorners[f].set(b[f].x*c,(a.height-b[f].y)*d);this._canvasCornersDirty=!1;return this._canvasCorners}});Object.defineProperty(k.prototype,
            "worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var b=this.screenCorners;if(!this.screen.screen.screenSpace){c.copy(this.screen.screen._screenMatrix);c.data[13]=-c.data[13];c.mul2(this.screen.getWorldTransform(),c);for(var e=0;4>e;e++)c.transformPoint(b[e],this._worldCorners[e])}}else b=this.entity.getLocalPosition(),c.setTranslate(-b.x,-b.y,-b.z),d.setTRS(pc.Vec3.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),f.setTranslate(b.x,
                b.y,b.z),g.copy(this.entity.parent.getWorldTransform()),g.mul(f).mul(d).mul(c),a.set(b.x-this.pivot.x*this.calculatedWidth,b.y-this.pivot.y*this.calculatedHeight,b.z),g.transformPoint(a,this._worldCorners[0]),a.set(b.x+(1-this.pivot.x)*this.calculatedWidth,b.y-this.pivot.y*this.calculatedHeight,b.z),g.transformPoint(a,this._worldCorners[1]),a.set(b.x+(1-this.pivot.x)*this.calculatedWidth,b.y+(1-this.pivot.y)*this.calculatedHeight,b.z),g.transformPoint(a,this._worldCorners[2]),a.set(b.x-this.pivot.x*
                this.calculatedWidth,b.y+(1-this.pivot.y)*this.calculatedHeight,b.z),g.transformPoint(a,this._worldCorners[3]);this._worldCornersDirty=!1;return this._worldCorners}});Object.defineProperty(k.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}});Object.defineProperty(k.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}});Object.defineProperty(k.prototype,"useInput",{get:function(){return this._useInput},set:function(a){this._useInput!==a&&(this._useInput=
            a,this.system.app.elementInput&&(a?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",a))}});Object.defineProperty(k.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(a){this._batchGroupId!==a&&(0<=this._batchGroupId&&this.system.app.batcher._markGroupDirty(this._batchGroupId),0<=a&&this.system.app.batcher._markGroupDirty(a),0>a&&0<=this._batchGroupId&&this.enabled&&
        this.entity.enabled&&(this._image._model?this.addModelToLayers(this._image._model):this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=a)}});var l=function(a){Object.defineProperty(k.prototype,a,{get:function(){return this._text?this._text[a]:this._image?this._image[a]:null},set:function(b){this._text?this._text[a]=b:this._image&&(this._image[a]=b)}})};l("fontSize");l("color");l("font");l("fontAsset");l("spacing");l("lineHeight");l("wrapLines");l("lines");l("alignment");
        l("autoWidth");l("autoHeight");l("text");l("texture");l("textureAsset");l("material");l("materialAsset");l("sprite");l("spriteAsset");l("spriteFrame");l("pixelsPerUnit");l("opacity");l("rect");l("mask");return{ElementComponent:k}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="element";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.ElementComponent;this.DataType=pc.ElementComponentData;this.schema=e;this._defaultTexture=new pc.Texture(a.graphicsDevice,{width:1,height:1,format:pc.PIXELFORMAT_R8_G8_B8_A8});a=this._defaultTexture.lock();var c=new Uint8Array(4);c[0]=255;c[1]=255;c[2]=255;c[3]=255;a.set(c);this._defaultTexture.unlock();this._maskMaterials={};this.defaultImageMaterial=new pc.StandardMaterial;
        this.defaultImageMaterial.diffuse.set(0,0,0);this.defaultImageMaterial.emissive.set(.5,.5,.5);this.defaultImageMaterial.emissiveMap=this._defaultTexture;this.defaultImageMaterial.emissiveTint=!0;this.defaultImageMaterial.opacityMap=this._defaultTexture;this.defaultImageMaterial.opacityMapChannel="a";this.defaultImageMaterial.opacityTint=!0;this.defaultImageMaterial.opacity=0;this.defaultImageMaterial.useLighting=!1;this.defaultImageMaterial.useGammaTonemap=!1;this.defaultImageMaterial.useFog=!1;this.defaultImageMaterial.useSkybox=
            !1;this.defaultImageMaterial.blendType=pc.BLEND_PREMULTIPLIED;this.defaultImageMaterial.depthWrite=!1;this.defaultImageMaterial.update();this.defaultImageMaskMaterial=this.defaultImageMaterial.clone();this.defaultImageMaskMaterial.alphaTest=1;this.defaultImageMaskMaterial.redWrite=!1;this.defaultImageMaskMaterial.greenWrite=!1;this.defaultImageMaskMaterial.blueWrite=!1;this.defaultImageMaskMaterial.alphaWrite=!1;this.defaultImageMaskMaterial.update();this.defaultImage9SlicedMaterial=this.defaultImageMaterial.clone();
        this.defaultImage9SlicedMaterial.chunks.basePS=pc.shaderChunks.basePS+"varying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvec2 nineSlicedUv;";this.defaultImage9SlicedMaterial.chunks.startPS=pc.shaderChunks.startPS+"nineSlicedUv = vUv0;\n";this.defaultImage9SlicedMaterial.chunks.emissivePS=pc.shaderChunks.emissivePS.replace("$UV","nineSlicedUv");this.defaultImage9SlicedMaterial.chunks.opacityPS=pc.shaderChunks.opacityPS.replace("$UV",
            "nineSlicedUv");this.defaultImage9SlicedMaterial.chunks.transformVS="#define NINESLICED\n"+pc.shaderChunks.transformVS;this.defaultImage9SlicedMaterial.chunks.uv0VS=pc.shaderChunks.uv9SliceVS;this.defaultImage9SlicedMaterial.update();this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial.clone();this.defaultImage9TiledMaterial.chunks.basePS=pc.shaderChunks.basePS+"#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvec2 nineSlicedUv;";
        this.defaultImage9TiledMaterial.chunks.startPS=pc.shaderChunks.startPS+"vec2 tileMask = step(vMask, vec2(0.99999));\nvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\nclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\nnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);";this.defaultImage9TiledMaterial.chunks.emissivePS=pc.shaderChunks.emissivePS.replace("$UV","nineSlicedUv, -1000.0");this.defaultImage9TiledMaterial.chunks.opacityPS=pc.shaderChunks.opacityPS.replace("$UV",
            "nineSlicedUv, -1000.0");this.defaultImage9TiledMaterial.update();this.defaultImage9SlicedMaskMaterial=this.defaultImage9SlicedMaterial.clone();this.defaultImage9SlicedMaskMaterial.alphaTest=1;this.defaultImage9SlicedMaskMaterial.redWrite=!1;this.defaultImage9SlicedMaskMaterial.greenWrite=!1;this.defaultImage9SlicedMaskMaterial.blueWrite=!1;this.defaultImage9SlicedMaskMaterial.alphaWrite=!1;this.defaultImage9SlicedMaskMaterial.update();this.defaultImage9TiledMaskMaterial=this.defaultImage9TiledMaterial.clone();
        this.defaultImage9TiledMaskMaterial.alphaTest=1;this.defaultImage9TiledMaskMaterial.redWrite=!1;this.defaultImage9TiledMaskMaterial.greenWrite=!1;this.defaultImage9TiledMaskMaterial.blueWrite=!1;this.defaultImage9TiledMaskMaterial.alphaWrite=!1;this.defaultImage9TiledMaskMaterial.update();this.defaultScreenSpaceImageMaterial=this.defaultImageMaterial.clone();this.defaultScreenSpaceImageMaterial.depthTest=!1;this.defaultScreenSpaceImageMaterial.update();this.defaultScreenSpaceImage9SlicedMaterial=
            this.defaultImage9SlicedMaterial.clone();this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1;this.defaultScreenSpaceImage9SlicedMaterial.update();this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial.clone();this.defaultScreenSpaceImage9TiledMaterial.chunks.basePS=pc.shaderChunks.basePS+"#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform vec4 innerOffset;\nuniform vec2 outerScale;\nuniform vec4 atlasRect;\nvec2 nineSlicedUv;";this.defaultScreenSpaceImage9TiledMaterial.chunks.startPS=
            pc.shaderChunks.startPS+"vec2 tileMask = step(vMask, vec2(0.99999));\nvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\nclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\nnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);";this.defaultScreenSpaceImage9TiledMaterial.chunks.emissivePS=pc.shaderChunks.emissivePS.replace("$UV","nineSlicedUv, -1000.0");this.defaultScreenSpaceImage9TiledMaterial.chunks.opacityPS=pc.shaderChunks.opacityPS.replace("$UV",
            "nineSlicedUv, -1000.0");this.defaultScreenSpaceImage9TiledMaterial.update();this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9SlicedMaterial.clone();this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1;this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1;this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1;this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1;this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1;this.defaultScreenSpaceImageMask9SlicedMaterial.update();
        this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone();this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1;this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1;this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1;this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1;this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1;this.defaultScreenSpaceImageMask9TiledMaterial.update();this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMaterial.clone();
        this.defaultScreenSpaceImageMaskMaterial.alphaTest=1;this.defaultScreenSpaceImageMaskMaterial.redWrite=!1;this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1;this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1;this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1;this.defaultScreenSpaceImageMaskMaterial.update();this.defaultTextMaterial=new pc.StandardMaterial;this.defaultTextMaterial.msdfMap=this._defaultTexture;this.defaultTextMaterial.useLighting=!1;this.defaultTextMaterial.useGammaTonemap=
            !1;this.defaultTextMaterial.useFog=!1;this.defaultTextMaterial.useSkybox=!1;this.defaultTextMaterial.diffuse.set(0,0,0);this.defaultTextMaterial.emissive.set(1,1,1);this.defaultTextMaterial.opacity=.5;this.defaultTextMaterial.blendType=pc.BLEND_PREMULTIPLIED;this.defaultTextMaterial.depthWrite=!1;this.defaultTextMaterial.update();this.defaultScreenSpaceTextMaterial=this.defaultTextMaterial.clone();this.defaultScreenSpaceTextMaterial.depthTest=!1;this.defaultScreenSpaceTextMaterial.update();this.defaultImageMaterials=
            [this.defaultImageMaterial,this.defaultImageMaskMaterial,this.defaultImage9SlicedMaterial,this.defaultImage9TiledMaterial,this.defaultImage9SlicedMaskMaterial,this.defaultImage9TiledMaskMaterial,this.defaultScreenSpaceImageMaterial,this.defaultScreenSpaceImage9SlicedMaterial,this.defaultScreenSpaceImage9TiledMaterial,this.defaultScreenSpaceImageMask9SlicedMaterial,this.defaultScreenSpaceImageMask9TiledMaterial,this.defaultScreenSpaceImageMaskMaterial];this.on("beforeremove",this.onRemoveComponent,
            this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ElementComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){void 0!==c.anchor&&(c.anchor instanceof pc.Vec4?b.anchor.copy(c.anchor):b.anchor.set(c.anchor[0],c.anchor[1],c.anchor[2],c.anchor[3]));void 0!==c.pivot&&(c.pivot instanceof pc.Vec2?b.pivot.copy(c.pivot):b.pivot.set(c.pivot[0],c.pivot[1]));var f=.001<Math.abs(b.anchor.x-b.anchor.z),e=.001<Math.abs(b.anchor.y-b.anchor.w),k=!1;void 0!==
    c.margin&&(c.margin instanceof pc.Vec4?b.margin.copy(c.margin):b._margin.set(c.margin[0],c.margin[1],c.margin[2],c.margin[3]),k=!0);void 0!==c.left&&(b._margin.x=c.left,k=!0);void 0!==c.bottom&&(b._margin.y=c.bottom,k=!0);void 0!==c.right&&(b._margin.z=c.right,k=!0);void 0!==c.top&&(b._margin.w=c.top,k=!0);k&&(b.margin=b._margin);k=!1;void 0===c.width||f?f&&(k=!0):b.width=c.width;void 0===c.height||e?e&&(k=!0):b.height=c.height;k&&(b.anchor=b.anchor);void 0!==c.enabled&&(b.enabled=c.enabled);void 0!==
    c.useInput&&(b.useInput=c.useInput);b.batchGroupId=void 0===c.batchGroupId||null===c.batchGroupId?-1:c.batchGroupId;c.layers&&"array"===pc.type(c.layers)&&(b.layers=c.layers.slice(0));b.type=c.type;b.type===pc.ELEMENTTYPE_IMAGE?(void 0!==c.rect&&(c.rect instanceof pc.Vec4?b.rect.copy(c.rect):b.rect.set(c.rect[0],c.rect[1],c.rect[2],c.rect[3])),void 0!==c.color?c.color instanceof pc.Color?b.color.set(c.color.data[0],c.color.data[1],c.color.data[2],void 0!==c.opacity?c.opacity:1):b.color.set(c.color[0],
        c.color[1],c.color[2],void 0!==c.opacity?c.opacity:1):b.color.set(1,1,1,c.opacity||1),b.color=b.color,b.opacity=void 0!==c.opacity?c.opacity:1,void 0!==c.textureAsset&&(b.textureAsset=c.textureAsset),c.texture&&(b.texture=c.texture),void 0!==c.spriteAsset&&(b.spriteAsset=c.spriteAsset),c.sprite&&(b.sprite=c.sprite),void 0!==c.spriteFrame&&(b.spriteFrame=c.spriteFrame),void 0!==c.pixelsPerUnit&&null!==c.pixelsPerUnit&&(b.pixelsPerUnit=c.pixelsPerUnit),void 0!==c.materialAsset&&(b.materialAsset=c.materialAsset),
    c.material&&(b.material=c.material),void 0!==c.mask&&(b.mask=c.mask)):b.type===pc.ELEMENTTYPE_TEXT&&(void 0!==c.autoWidth&&(b.autoWidth=c.autoWidth),void 0!==c.autoHeight&&(b.autoHeight=c.autoHeight),void 0!==c.text&&(b.text=c.text),void 0!==c.color&&(c.color instanceof pc.Color?b.color.set(c.color.data[0],c.color.data[1],c.color.data[2],void 0!==c.opacity?c.opacity:1):b.color.set(c.color[0],c.color[1],c.color[2],void 0!==c.opacity?c.opacity:1),b.color=b.color),void 0!==c.opacity&&(b.opacity=c.opacity),
    void 0!==c.spacing&&(b.spacing=c.spacing),void 0!==c.fontSize&&(b.fontSize=c.fontSize,c.lineHeight||(b.lineHeight=c.fontSize)),void 0!==c.lineHeight&&(b.lineHeight=c.lineHeight),void 0!==c.wrapLines&&(b.wrapLines=c.wrapLines),void 0!==c.fontAsset&&(b.fontAsset=c.fontAsset),void 0!==c.font&&(b.font=c.font),void 0!==c.alignment&&(b.alignment=c.alignment));f=b._parseUpToScreen();f.screen&&b._updateScreen(f.screen);a._super.initializeComponentData.call(this,b,c,d)},onRemoveComponent:function(a,c){c.onRemove()},
        cloneComponent:function(a,c){var d=a.element;return this.addComponent(c,{enabled:d.enabled,width:d.width,height:d.height,anchor:d.anchor.clone(),pivot:d.pivot.clone(),margin:d.margin.clone(),alignment:d.alignment&&d.alignment.clone()||d.alignment,autoWidth:d.autoWidth,autoHeight:d.autoHeight,type:d.type,rect:d.rect&&d.rect.clone()||d.rect,materialAsset:d.materialAsset,material:d.material,color:d.color&&d.color.clone()||d.color,opacity:d.opacity,textureAsset:d.textureAsset,texture:d.texture,spriteAsset:d.spriteAsset,
            sprite:d.sprite,spriteFrame:d.spriteFrame,pixelsPerUnit:d.pixelsPerUnit,text:d.text,spacing:d.spacing,lineHeight:d.lineHeight,wrapLines:d.wrapLines,layers:d.layers,fontSize:d.fontSize,fontAsset:d.fontAsset,font:d.font,useInput:d.useInput,batchGroupId:d.batchGroupId,mask:d.mask})}});return{ElementComponentSystem:a}}());pc.extend(pc,function(){return{ElementComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){var e=function(a){this._element=a;this._entity=a.entity;this._system=a.system;this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null;this._spriteFrame=0;this._pixelsPerUnit=null;this._rect=new pc.Vec4(0,0,1,1);this._color=new pc.Color(1,1,1,1);this._mask=!1;this._maskRef=0;this._positions=[];this._normals=[];this._uvs=[];this._indices=[];this._outerScale=new pc.Vec2;this._innerOffset=new pc.Vec4;this._atlasRect=new pc.Vec4;this._mesh=
        this._defaultMesh=this._createMesh();this._node=new pc.GraphNode;this._model=new pc.Model;this._model.graph=this._node;this._meshInstance=new pc.MeshInstance(this._node,this._mesh,this._material);this._meshInstance.castShadow=!1;this._meshInstance.receiveShadow=!1;this._model.meshInstances.push(this._meshInstance);this._drawOrder=0;this._updateAabbFunc=this._updateAabb.bind(this);this._entity.addChild(this._model.graph);this._model._entity=this._entity;this._onScreenChange(this._element.screen);this._element.on("resize",
        this._onParentResizeOrPivotChange,this);this._element.on("set:pivot",this._onParentResizeOrPivotChange,this);this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.on("set:screen",this._onScreenChange,this);this._element.on("set:draworder",this._onDrawOrderChange,this);this._element.on("screen:set:resolution",this._onResolutionChange,this)};pc.extend(e.prototype,{destroy:function(){this._model&&(this._element.removeModelFromLayers(this._model),this._meshInstance.mesh=
        this._defaultMesh,this._model.destroy(),this._model=null);this._element.off("resize",this._onParentResizeOrPivotChange,this);this._element.off("set:pivot",this._onParentResizeOrPivotChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(a){},_onParentResizeOrPivotChange:function(){this._mesh&&
    this._updateMesh(this._mesh)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},_onScreenChange:function(a){a?this._updateMaterial(a.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(a){this._drawOrder=a;this._meshInstance&&(this._meshInstance.drawOrder=a)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED||
        this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED)},_updateMaterial:function(a){a?(this._hasUserMaterial()||(this._material=this._mask?this.sprite?this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?this._system.defaultScreenSpaceImageMask9SlicedMaterial:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED?this._system.defaultScreenSpaceImageMask9TiledMaterial:this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultScreenSpaceImageMaskMaterial:this.sprite?this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?
        this._system.defaultScreenSpaceImage9SlicedMaterial:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED?this._system.defaultScreenSpaceImage9TiledMaterial:this._system.defaultScreenSpaceImageMaterial:this._system.defaultScreenSpaceImageMaterial),this._meshInstance&&(this._meshInstance.cull=!1)):(this._hasUserMaterial()||(this._material=this._mask?this.sprite?this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?this._system.defaultImage9SlicedMaskMaterial:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED?
        this._system.defaultImage9TiledMaskMaterial:this._system.defaultImageMaskMaterial:this._system.defaultImageMaskMaterial:this.sprite?this.sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED?this._system.defaultImage9SlicedMaterial:this.sprite.renderMode===pc.SPRITE_RENDERMODE_TILED?this._system.defaultImage9TiledMaterial:this._system.defaultImageMaterial:this._system.defaultImageMaterial),this._meshInstance&&(this._meshInstance.cull=!0));this._meshInstance&&(this._meshInstance.material=this._material,
        this._meshInstance.screenSpace=a,this._meshInstance.layer=a?pc.scene.LAYER_HUD:pc.scene.LAYER_WORLD)},_createMesh:function(){var a=this._element.calculatedWidth,b=this._element.calculatedHeight;this._positions[0]=0;this._positions[1]=0;this._positions[2]=0;this._positions[3]=a;this._positions[4]=0;this._positions[5]=0;this._positions[6]=a;this._positions[7]=b;this._positions[8]=0;this._positions[9]=0;this._positions[10]=b;for(a=this._positions[11]=0;12>a;a+=3)this._normals[a]=0,this._normals[a+1]=
        0,this._normals[a+2]=1;this._uvs[0]=this._rect.data[0];this._uvs[1]=this._rect.data[1];this._uvs[2]=this._rect.data[0]+this._rect.data[2];this._uvs[3]=this._rect.data[1];this._uvs[4]=this._rect.data[0]+this._rect.data[2];this._uvs[5]=this._rect.data[1]+this._rect.data[3];this._uvs[6]=this._rect.data[0];this._uvs[7]=this._rect.data[1]+this._rect.data[3];this._indices[0]=0;this._indices[1]=1;this._indices[2]=3;this._indices[3]=2;this._indices[4]=3;this._indices[5]=1;a=pc.createMesh(this._system.app.graphicsDevice,
        this._positions,{uvs:this._uvs,normals:this._normals,indices:this._indices});this._updateMesh(a);return a},_updateMesh:function(a){var b,c=this._element.calculatedWidth,d=this._element.calculatedHeight;this._element.screen?this._updateMaterial(this._element.screen.screen.screenSpace):this._updateMaterial();this._meshInstance&&(this._meshInstance._aabbVer=-1);if(!this.sprite||this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this.sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED){this._positions[0]=
        0;this._positions[1]=0;this._positions[2]=0;this._positions[3]=c;this._positions[4]=0;this._positions[5]=0;this._positions[6]=c;this._positions[7]=d;this._positions[8]=0;this._positions[9]=0;this._positions[10]=d;this._positions[11]=0;var f=this._element.pivot.data[0],e=this._element.pivot.data[1];for(b=0;b<this._positions.length;b+=3)this._positions[b]-=f*c,this._positions[b+1]-=e*d;d=c=1;b=this._rect;this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas&&(f=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]])&&
    (b=f.rect,c=this._sprite.atlas.texture.width,d=this._sprite.atlas.texture.height);this._uvs[0]=b.data[0]/c;this._uvs[1]=b.data[1]/d;this._uvs[2]=(b.data[0]+b.data[2])/c;this._uvs[3]=b.data[1]/d;this._uvs[4]=(b.data[0]+b.data[2])/c;this._uvs[5]=(b.data[1]+b.data[3])/d;this._uvs[6]=b.data[0]/c;this._uvs[7]=(b.data[1]+b.data[3])/d;c=new pc.VertexIterator(a.vertexBuffer);for(b=0;4>b;b++)c.element[pc.SEMANTIC_POSITION].set(this._positions[3*b+0],this._positions[3*b+1],this._positions[3*b+2]),c.element[pc.SEMANTIC_NORMAL].set(this._normals[3*
    b+0],this._normals[3*b+1],this._normals[3*b+2]),c.element[pc.SEMANTIC_TEXCOORD0].set(this._uvs[2*b+0],this._uvs[2*b+1]),c.next();c.end();a.aabb.compute(this._positions);this._node&&(this._node.setLocalScale(1,1,1),this._node.setLocalPosition(0,0,0));this._meshInstance&&(this._meshInstance._updateAabbFunc=null)}else a=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]],b=2/a.rect.z,f=2/a.rect.w,this._innerOffset.set(a.border.x*b,a.border.y*f,a.border.z*b,a.border.w*f),b=this.sprite.atlas.texture,
        this._atlasRect.set(a.rect.x/b.width,a.rect.y/b.height,a.rect.z/b.width,a.rect.w/b.height),f=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,b=a.rect.z/f,a=a.rect.w/f,this._outerScale.set(Math.max(c,this._innerOffset.x*b),Math.max(d,this._innerOffset.y*a)),f=a,this._outerScale.x/=b,this._outerScale.y/=a,b*=pc.math.clamp(c/(this._innerOffset.x*b),1E-4,1),f*=pc.math.clamp(d/(this._innerOffset.y*a),1E-4,1),this._meshInstance&&(this._meshInstance.setParameter("innerOffset",this._innerOffset.data),
        this._meshInstance.setParameter("atlasRect",this._atlasRect.data),this._meshInstance.setParameter("outerScale",this._outerScale.data,4294967295),this._meshInstance._updateAabbFunc=this._updateAabbFunc),this._node&&(this._node.setLocalScale(b,f,1),this._node.setLocalPosition((.5-this._element.pivot.x)*c,(.5-this._element.pivot.y)*d,0))},_updateAabb:function(a){a.center.set(0,0,0);a.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001);a.setFromTransformedAabb(a,this._node.getWorldTransform());
        return a},_getHigherMask:function(){for(var a=this._entity;a;)if((a=a.getParent())&&a.element&&a.element.mask)return a;return null},_toggleMask:function(){this._element._dirtifyMask();this._updateMaterial(this._element.screen?this._element.screen.screen.screenSpace:!1)},_onMaterialLoad:function(a){this.material=a.resource},_onMaterialAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onMaterialAdded,this);this._materialAsset===a.id&&this._bindMaterialAsset(a)},_bindMaterialAsset:function(a){a.on("load",
        this._onMaterialLoad,this);a.on("change",this._onMaterialChange,this);a.on("remove",this._onMaterialRemove,this);a.resource?this._onMaterialLoad(a):this._system.app.assets.load(a)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onTextureAdded,this);this._textureAsset===a.id&&this._bindTextureAsset(a)},_bindTextureAsset:function(a){a.on("load",this._onTextureLoad,this);a.on("change",this._onTextureChange,this);
        a.on("remove",this._onTextureRemove,this);a.resource?this._onTextureLoad(a):this._system.app.assets.load(a)},_onTextureLoad:function(a){this.texture=a.resource},_onTextureChange:function(a){},_onTextureRemove:function(a){},_onSpriteAssetAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onSpriteAssetAdded,this);this._spriteAsset===a.id&&this._bindSpriteAsset(a)},_bindSpriteAsset:function(a){a.on("load",this._onSpriteAssetLoad,this);a.on("change",this._onSpriteAssetChange,this);a.on("remove",
        this._onSpriteAssetRemove,this);a.resource?this._onSpriteAssetLoad(a):this._system.app.assets.load(a)},_onSpriteAssetLoad:function(a){if(a.resource)if(a.resource.atlas)this.sprite=a.resource;else{a=a.data.textureAtlasAsset;var b=this._system.app.assets;b.off("load:"+a,this._onTextureAtlasLoad,this);b.once("load:"+a,this._onTextureAtlasLoad,this)}else this.sprite=null},_onSpriteMeshesChange:function(){this.spriteFrame=this.spriteFrame},_onSpritePpuChange:function(){this.sprite.renderMode!==pc.SPRITE_RENDERMODE_SIMPLE&&
    null===this._pixelsPerUnit&&(this.spriteFrame=this.spriteFrame)},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(a){a=this._spriteAsset;a instanceof
    pc.Asset?this._onSpriteAssetLoad(a):this._onSpriteAssetLoad(this._system.app.assets.get(a))},_onSpriteAssetChange:function(a){this._onSpriteAssetLoad(a)},_onSpriteAssetRemove:function(a){},onEnable:function(){this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._model&&this._element.removeModelFromLayers(this._model)}});Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(a){this._color.data[0]=a.data[0];this._color.data[1]=a.data[1];
        this._color.data[2]=a.data[2];this._meshInstance&&this._meshInstance.setParameter("material_emissive",this._color.data3);this._element&&this._element.fire("set:color",this._color)}});Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},set:function(a){this._color.data[3]=a;this._meshInstance.setParameter("material_opacity",a);this._element&&this._element.fire("set:opacity",this._color.data[3])}});Object.defineProperty(e.prototype,"rect",{get:function(){return this._rect},
        set:function(a){a instanceof pc.Vec4?this._rect.set(a.x,a.y,a.z,a.w):this._rect.set(a[0],a[1],a[2],a[3]);this._mesh&&this._updateMesh(this._mesh)}});Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(a){a||(a=this._mask?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial);if(this._material=a)this._meshInstance.material=a,this._hasUserMaterial()?(this._meshInstance.deleteParameter("material_opacity"),this._meshInstance.deleteParameter("material_emissive")):
        (this._meshInstance.setParameter("material_emissive",this._color.data3),this._meshInstance.setParameter("material_opacity",this._color.data[3]))}});Object.defineProperty(e.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof pc.Asset&&(c=a.id);this._materialAsset!==c&&(this._materialAsset&&(a=b.get(this._materialAsset))&&(a.off("load",this._onMaterialLoad,this),a.off("change",this._onMaterialChange,this),a.off("remove",
        this._onMaterialRemove,this)),(this._materialAsset=c)?(c=b.get(this._materialAsset))?this._bindMaterialAsset(c):(this.material=null,b.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}});Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},set:function(a){(this._texture=a)?(this._meshInstance.setParameter("texture_emissiveMap",this._texture),this._meshInstance.setParameter("texture_opacityMap",this._texture),this._meshInstance.setParameter("material_emissive",
        this._color.data3),this._meshInstance.setParameter("material_opacity",this._color.data[3])):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap"))}});Object.defineProperty(e.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof pc.Asset&&(c=a.id);this._textureAsset!==c&&(this._textureAsset&&(a=b.get(this._textureAsset))&&(a.off("load",this._onTextureLoad,this),
        a.off("change",this._onTextureChange,this),a.off("remove",this._onTextureRemove,this)),(this._textureAsset=c)?(c=b.get(this._textureAsset))?this._bindTextureAsset(c):(this.texture=null,b.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}});Object.defineProperty(e.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof pc.Asset&&(c=a.id);this._spriteAsset!==c&&(this._spriteAsset&&(a=b.get(this._spriteAsset))&&
    (a.off("load",this._onSpriteAssetLoad,this),a.off("change",this._onSpriteAssetChange,this),a.off("remove",this._onSpriteAssetRemove,this)),(this._spriteAsset=c)?(a=b.get(this._spriteAsset))?this._bindSpriteAsset(a):(this.sprite=null,b.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",c))}});Object.defineProperty(e.prototype,"sprite",{get:function(){return this._sprite},set:function(a){this._sprite&&(this._sprite.off("set:meshes",
        this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChange,this),this._sprite.off("set:atlas",this._onAtlasTextureChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onAtlasTextureChange,this));if(this._sprite=a)if(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChange,this),this._sprite.on("set:atlas",this._onAtlasTextureChange,this),this._sprite.atlas)this._sprite.atlas.on("set:texture",
        this._onAtlasTextureChange,this);this._meshInstance&&(this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")));this.spriteFrame=this.spriteFrame}});Object.defineProperty(e.prototype,"spriteFrame",{get:function(){return this._spriteFrame},
        set:function(a){this._spriteFrame=this._sprite?pc.math.clamp(a,0,this._sprite.frameKeys.length-1):a;var b=!1,c=null;this._sprite&&this._sprite.atlas&&(c=this._sprite.meshes[this.spriteFrame],b=this._sprite.renderMode===pc.SPRITE_RENDERMODE_SLICED||this._sprite.renderMode===pc.SPRITE_RENDERMODE_TILED);(this.mesh=b?c:this._defaultMesh)&&this._updateMesh(this.mesh);this._element&&this._element.fire("set:spriteFrame",a)}});Object.defineProperty(e.prototype,"mesh",{get:function(){return this._mesh},set:function(a){this._mesh=
        a;this._meshInstance&&(this._meshInstance.mesh=this._mesh,this._meshInstance.visible=!!this._mesh,this._meshInstance._aabbVer=-1,this._meshInstance._updateAabbFunc=this._mesh===this._defaultMesh?null:this._updateAabbFunc)}});Object.defineProperty(e.prototype,"mask",{get:function(){return this._mask},set:function(a){this._mask!==a&&(this._mask=a,this._toggleMask())}});Object.defineProperty(e.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(a){this._pixelsPerUnit!==
    a&&(this._pixelsPerUnit=a,!this._sprite||this._sprite.renderMode!==pc.SPRITE_RENDERMODE_SLICED&&this._sprite.renderMode!==pc.SPRITE_RENDERMODE_TILED||(this.spriteFrame=this.spriteFrame))}});return{ImageElement:e}}());pc.extend(pc,function(){var e=function(a){this._element=a;this._system=a.system;this._entity=a.entity;this._text="";this._font=this._fontAsset=null;this._color=new pc.Color(1,1,1,1);this._spacing=1;this._lineHeight=this._fontSize=32;this._wrapLines=!1;this._drawOrder=0;this._alignment=new pc.Vec2(.5,.5);this._autoHeight=this._autoWidth=!0;this.height=this.width=0;this._node=new pc.GraphNode;this._model=new pc.Model;this._model.graph=this._node;this._entity.addChild(this._node);this._meshInfo=[];this._material=
        null;this._noResize=!1;this._maskedMaterialSrc=this._currentMaterialType=null;this._onScreenChange(this._element.screen);a.on("resize",this._onParentResize,this);this._element.on("set:screen",this._onScreenChange,this);a.on("screen:set:screenspace",this._onScreenSpaceChange,this);a.on("set:draworder",this._onDrawOrderChange,this);a.on("set:pivot",this._onPivotChange,this)},a=/^[\r\n]$/,b=/^[ \t]$/,c=/^[ \t\-]$/;pc.extend(e.prototype,{destroy:function(){this._model&&(this._element.removeModelFromLayers(this._model),
        this._model.destroy(),this._model=null);this._element.off("resize",this._onParentResize,this);this._element.off("set:screen",this._onScreenChange,this);this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this);this._element.off("set:draworder",this._onDrawOrderChange,this);this._element.off("set:pivot",this._onPivotChange,this)},_onParentResize:function(a,b){this._noResize||this._font&&this._updateText(this._text)},_onScreenChange:function(a){a?this._updateMaterial(a.screen.screenSpace):
        this._updateMaterial(!1)},_onScreenSpaceChange:function(a){this._updateMaterial(a)},_onDrawOrderChange:function(a){this._drawOrder=a;if(this._model){var b,c;b=0;for(c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].drawOrder=a}},_onPivotChange:function(a){this._font&&this._updateText()},_updateText:function(a){var b,c;void 0===a&&(a=this._text);c=a.length;0===c&&(c=1,a=" ");var e={};for(b=0;b<c;b++){var l=a.charCodeAt(b);if(l=this._font.data.chars[l])l=l.map,e[l]||(e[l]=0),e[l]++}var l=
        !1,m=this._element.screen&&this._element.screen.screen.screenSpace;b=0;for(c=this._meshInfo.length;b<c;b++){var n=e[b]||0,h=this._meshInfo[b];if(h.count!==n)if(l||(this._element.removeModelFromLayers(this._model),l=!0),h.count=n,h.positions.length=h.normals.length=12*n,h.indices.length=6*n,h.uvs.length=8*n,h.meshInstance&&this._removeMeshInstance(h.meshInstance),0===n)h.meshInstance=null;else{for(var r=0;r<n;r++)h.indices[6*r+0]=4*r,h.indices[6*r+1]=4*r+1,h.indices[6*r+2]=4*r+3,h.indices[6*r+3]=4*
        r+2,h.indices[6*r+4]=4*r+3,h.indices[6*r+5]=4*r+1,h.normals[12*r+0]=0,h.normals[12*r+1]=0,h.normals[12*r+2]=-1,h.normals[12*r+3]=0,h.normals[12*r+4]=0,h.normals[12*r+5]=-1,h.normals[12*r+6]=0,h.normals[12*r+7]=0,h.normals[12*r+8]=-1,h.normals[12*r+9]=0,h.normals[12*r+10]=0,h.normals[12*r+11]=-1;n=pc.createMesh(this._system.app.graphicsDevice,h.positions,{uvs:h.uvs,normals:h.normals,indices:h.indices});n=new pc.MeshInstance(this._node,n,this._material);n.castShadow=!1;n.receiveShadow=!1;n.drawOrder=
        this._drawOrder;m&&(n.cull=!1);n.screenSpace=m;n.setParameter("texture_msdfMap",this._font.textures[b]);n.setParameter("material_emissive",this._color.data3);n.setParameter("material_opacity",this._color.data[3]);n.setParameter("font_sdfIntensity",this._font.intensity);n.setParameter("font_pxrange",this._getPxRange(this._font));n.setParameter("font_textureWidth",this._font.data.info.maps[b].width);h.meshInstance=n;this._model.meshInstances.push(n)}}this._maskedBy&&this._element._setMaskedBy(this._maskedBy);
        l&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model);this._updateMeshes(a)},_removeMeshInstance:function(a){var b,c,e=a.mesh;if(e&&(e.vertexBuffer&&e.vertexBuffer.destroy(),e.indexBuffer))for(b=0,c=e.indexBuffer.length;b<c;b++)e.indexBuffer[b].destroy();a=this._model.meshInstances.indexOf(a);-1!==a&&this._model.meshInstances.splice(a,1)},_setMaterial:function(a){var b,c;this._material=a;if(this._model)for(b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].material=
        a},_updateMaterial:function(a){var b;a?(this._material=this._system.defaultScreenSpaceTextMaterial,b=!1):(this._material=this._system.defaultTextMaterial,b=!0);if(this._model)for(var c=0,e=this._model.meshInstances.length;c<e;c++){var l=this._model.meshInstances[c];l.cull=b;l.material=this._material;l.screenSpace=a}},_updateMeshes:function(d){function f(a,b){k._lineWidths.push(b);k._lineContents.push(d.substring(t,a));m=0;h-=k._lineHeight;r++;p=y=x=0;t=a}var e=this._font.data,k=this;this.height=this.width=
        0;this._lineWidths=[];this._lineContents=[];var l=d.length,m=0,n=0,h=0,r=1,p=0,q=0,t=0,x=0,y=0,w=1E-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),u=this._element.calculatedWidth;if(this.autoWidth&&!w||!this._wrapLines)u=Number.POSITIVE_INFINITY;var v=0,w=0,z=1,A,D,B,F;for(D in e.chars)B=e.chars[D],z=B.height/32*this._fontSize/B.height,B.bounds&&(v=Math.min(v,B.bounds[1]*z),w=Math.max(w,B.bounds[3]*z));for(F=0;F<this._meshInfo.length;F++)this._meshInfo[F].quad=0,this._meshInfo[F].lines=
        {};for(F=0;F<l;F++){A=d.charAt(F);D=d.charCodeAt(F);var J=0,G=0,I=0,C=1,E=z=0;(B=e.chars[D])&&B.scale?(J=(B.width+B.height)/2,z=J/32*this._fontSize/J,C=J/32*this._fontSize/B.scale,I=B.xadvance*z,J=B.xoffset*z,G=B.yoffset*z,B.bounds?(E=(B.bounds[2]-B.bounds[0])*z,z*=B.bounds[0]):(E=J,z=0)):(I=1,G=J=0,C=this._fontSize);var H=a.test(A),W=c.test(A),R=b.test(A);if(H)f(F,n),q=F+1,t=F+1;else{A=this._meshInfo[B&&B.map||0];if(m+E+z>=u&&0<y&&!R)if(0===x)q=F,f(F,n);else{B=Math.max(F-q,0);F-=B+1;A.lines[r-1]-=
        B;A.quad-=B;f(q,p);continue}B=A.quad;A.lines[r-1]=B;A.positions[12*B+0]=m-J;A.positions[12*B+1]=h-G;A.positions[12*B+2]=0;A.positions[12*B+3]=m-J+C;A.positions[12*B+4]=h-G;A.positions[12*B+5]=0;A.positions[12*B+6]=m-J+C;A.positions[12*B+7]=h-G+C;A.positions[12*B+8]=0;A.positions[12*B+9]=m-J;A.positions[12*B+10]=h-G+C;A.positions[12*B+11]=0;this.width=Math.max(this.width,m+E+z);this.height=Math.max(this.height,w-(h+v));m+=this._spacing*I;R||H||(n=m);W&&(x++,p=n,q=F+1);y++;D=this._getUv(D);A.uvs[8*
    B+0]=D[0];A.uvs[8*B+1]=D[1];A.uvs[8*B+2]=D[2];A.uvs[8*B+3]=D[1];A.uvs[8*B+4]=D[2];A.uvs[8*B+5]=D[3];A.uvs[8*B+6]=D[0];A.uvs[8*B+7]=D[3];A.quad++}}t<l&&f(l,m);this._noResize=!0;this.autoWidth=this._autoWidth;this.autoHeight=this._autoHeight;this._noResize=!1;e=this._element.pivot.data[0];l=this._element.pivot.data[1];n=this._alignment.x;q=this._alignment.y;for(F=0;F<this._meshInfo.length;F++)if(0!==this._meshInfo[F].count){B=0;for(var Z in this._meshInfo[F].lines){u=this._meshInfo[F].lines[Z];v=-e*
        this._element.calculatedWidth+n*(this._element.calculatedWidth-this._lineWidths[parseInt(Z,10)]);for(D=(1-l)*this._element.calculatedHeight-w-(1-q)*(this._element.calculatedHeight-this.height);B<=u;B++)this._meshInfo[F].positions[12*B]+=v,this._meshInfo[F].positions[12*B+3]+=v,this._meshInfo[F].positions[12*B+6]+=v,this._meshInfo[F].positions[12*B+9]+=v,this._meshInfo[F].positions[12*B+1]+=D,this._meshInfo[F].positions[12*B+4]+=D,this._meshInfo[F].positions[12*B+7]+=D,this._meshInfo[F].positions[12*
    B+10]+=D;B=u+1}B=4*this._meshInfo[F].quad;u=new pc.VertexIterator(this._meshInfo[F].meshInstance.mesh.vertexBuffer);for(v=0;v<B;v++)u.element[pc.SEMANTIC_POSITION].set(this._meshInfo[F].positions[3*v+0],this._meshInfo[F].positions[3*v+1],this._meshInfo[F].positions[3*v+2]),u.element[pc.SEMANTIC_TEXCOORD0].set(this._meshInfo[F].uvs[2*v+0],this._meshInfo[F].uvs[2*v+1]),u.next();u.end();this._meshInfo[F].meshInstance.mesh.aabb.compute(this._meshInfo[F].positions);this._meshInfo[F].meshInstance._aabbVer=
        -1}},_onFontAdded:function(a){this._system.app.assets.off("add:"+a.id,this._onFontAdded,this);a.id===this._fontAsset&&this._bindFont(a)},_bindFont:function(a){a.on("load",this._onFontLoad,this);a.on("change",this._onFontChange,this);a.on("remove",this._onFontRemove,this);a.resource?this._onFontLoad(a):this._system.app.assets.load(a)},_onFontLoad:function(a){this.font!==a.resource&&(this.font=a.resource)},_onFontChange:function(a,b,c,e){if("data"===b)for(this._font.data=c,a=this._font.data.info.maps.length,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      b=0;b<a;b++)this._meshInfo[b]&&(c=this._meshInfo[b].meshInstance)&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[b].width))},_onFontRemove:function(a){},_getPxRange:function(a){a=Object.keys(this._font.data.chars);for(var b=0;b<a.length;b++){var c=this._font.data.chars[a[b]];if(c.scale&&c.range)return c.scale*c.range}return 2},_getUv:function(a){var b=this._font.data;
        if(!b.chars[a])return b.chars[32]?this._getUv(32):[0,0,1,1];var c=b.chars[a].map,e=b.info.maps[c].width,c=b.info.maps[c].height,l=b.chars[a].x,m=b.chars[a].y,n=1-b.chars[a].height/c;return[l/e,n-m/c,(l+b.chars[a].width)/e,n-(m-b.chars[a].height)/c]},onEnable:function(){this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._model&&this._element.removeModelFromLayers(this._model)}});Object.defineProperty(e.prototype,"text",{get:function(){return this._text},set:function(a){a=
        a.toString();this._text!==a&&(this._font&&this._updateText(a),this._text=a)}});Object.defineProperty(e.prototype,"color",{get:function(){return this._color},set:function(a){this._color.data[0]=a.data[0];this._color.data[1]=a.data[1];this._color.data[2]=a.data[2];if(this._model){a=0;for(var b=this._model.meshInstances.length;a<b;a++)this._model.meshInstances[a].setParameter("material_emissive",this._color.data3)}}});Object.defineProperty(e.prototype,"opacity",{get:function(){return this._color.data[3]},
        set:function(a){this._color.data[3]=a;if(this._model)for(var b=0,c=this._model.meshInstances.length;b<c;b++)this._model.meshInstances[b].setParameter("material_opacity",a)}});Object.defineProperty(e.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(a){var b=this._lineHeight;this._lineHeight=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(e.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(a){var b=this._wrapLines;this._wrapLines=
        a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(e.prototype,"lines",{get:function(){return this._lineContents}});Object.defineProperty(e.prototype,"spacing",{get:function(){return this._spacing},set:function(a){var b=this._spacing;this._spacing=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(e.prototype,"fontSize",{get:function(){return this._fontSize},set:function(a){var b=this._fontSize;this._fontSize=a;b!==a&&this._font&&this._updateText()}});Object.defineProperty(e.prototype,
        "fontAsset",{get function(){return this._fontAsset},set:function(a){var b=this._system.app.assets,c=a;a instanceof pc.Asset&&(c=a.id);if(this._fontAsset!==c&&(this._fontAsset&&(a=b.get(this._fontAsset))&&(a.off("load",this._onFontLoad,this),a.off("change",this._onFontChange,this),a.off("remove",this._onFontRemove,this)),this._fontAsset=c))if(c=b.get(this._fontAsset))this._bindFont(c);else b.on("add:"+this._fontAsset,this._onFontAdded,this)}});Object.defineProperty(e.prototype,"font",{get:function(){return this._font},
        set:function(a){var b;if(this._font=a){a=0;for(b=this._font.textures.length;a<b;a++)if(this._meshInfo[a]){var c=this._meshInfo[a].meshInstance;c&&(c.setParameter("font_sdfIntensity",this._font.intensity),c.setParameter("font_pxrange",this._getPxRange(this._font)),c.setParameter("font_textureWidth",this._font.data.info.maps[a].width),c.setParameter("texture_msdfMap",this._font.textures[a]))}else this._meshInfo[a]={count:0,quad:0,lines:{},positions:[],normals:[],uvs:[],indices:[],meshInstance:null};
            b=!1;for(a=this._font.textures.length;a<this._meshInfo.length;a++)this._meshInfo[a].meshInstance&&(b||(this._element.removeModelFromLayers(this._model),b=!0),this._removeMeshInstance(this._meshInfo[a].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length);this._updateText()}}});Object.defineProperty(e.prototype,"alignment",{get:function(){return this._alignment},set:function(a){a instanceof pc.Vec2?this._alignment.set(a.x,a.y):this._alignment.set(a[0],
        a[1]);this._font&&this._updateText()}});Object.defineProperty(e.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(a){(this._autoWidth=a)&&1E-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width)}});Object.defineProperty(e.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(a){(this._autoHeight=a)&&1E-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height)}});return{TextElement:e}}());pc.extend(pc,{BUTTON_TRANSITION_MODE_TINT:0,BUTTON_TRANSITION_MODE_SPRITE_CHANGE:1});pc.extend(pc,function(){var e={DEFAULT:"_defaultTint",HOVER:"hoverTint",PRESSED:"pressedTint",INACTIVE:"inactiveTint"},a={DEFAULT:"_defaultSpriteAsset",HOVER:"hoverSpriteAsset",PRESSED:"pressedSpriteAsset",INACTIVE:"inactiveSpriteAsset"},b={DEFAULT:"_defaultSpriteFrame",HOVER:"hoverSpriteFrame",PRESSED:"pressedSpriteFrame",INACTIVE:"inactiveSpriteFrame"},c=function(a,b){this._visualState="DEFAULT";this._isPressed=this._isHovering=!1;this._imageEntity=null;this._defaultTint=new pc.Color(1,1,1,1);this._defaultSpriteAsset=
        null;this._defaultSpriteFrame=0;this._toggleLifecycleListeners("on",a)},c=pc.inherits(c,pc.Component);pc.extend(c.prototype,{_toggleLifecycleListeners:function(a,b){this[a]("set_active",this._onSetActive,this);this[a]("set_transitionMode",this._onSetTransitionMode,this);this[a]("set_hoverTint",this._onSetTransitionValue,this);this[a]("set_pressedTint",this._onSetTransitionValue,this);this[a]("set_inactiveTint",this._onSetTransitionValue,this);this[a]("set_hoverSpriteAsset",this._onSetTransitionValue,
        this);this[a]("set_hoverSpriteFrame",this._onSetTransitionValue,this);this[a]("set_pressedSpriteAsset",this._onSetTransitionValue,this);this[a]("set_pressedSpriteFrame",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteAsset",this._onSetTransitionValue,this);this[a]("set_inactiveSpriteFrame",this._onSetTransitionValue,this);this[a]("set_imageEntity",this._onSetImageEntity,this);pc.ComponentSystem[a]("postInitialize",this._onPostInitialize,this);pc.ComponentSystem[a]("update",this._onUpdate,
        this);b.app.systems.element[a]("add",this._onElementComponentAdd,this);b.app.systems.element[a]("beforeremove",this._onElementComponentRemoveOrImageEntityDestroy,this)},_onSetActive:function(a,b,c){b!==c&&this._updateVisualState()},_onSetTransitionMode:function(a,b,c){b!==c&&(this._cancelTween(),this._resetToDefaultVisualState(b),this._forceReapplyVisualState())},_onSetTransitionValue:function(a,b,c){b!==c&&this._forceReapplyVisualState()},_onSetImageEntity:function(a,b,c){b!==c&&this._updateImageEntityReference()},
        _onPostInitialize:function(){this._updateImageEntityReference()},_updateImageEntityReference:function(){var a=this.data.imageEntity;this._imageEntity&&this._imageEntity.getGuid()===a||(this._imageEntity&&this._onBeforeImageEntityChange(),(this._imageEntity=a?this.system.app.root.findByGuid(a):null)&&this._onAfterImageEntityChange())},_onElementComponentRemoveOrImageEntityDestroy:function(a){this._imageEntity===a&&(this._cancelTween(),this._toggleImageListeners("off"),this._imageEntity=null)},_onElementComponentAdd:function(a){this._imageEntity===
        a&&this._onAfterImageEntityChange()},_onBeforeImageEntityChange:function(){this._toggleImageListeners("off");this._resetToDefaultVisualState(this.transitionMode)},_onAfterImageEntityChange:function(){this._toggleImageListeners("on");this._storeDefaultVisualState();this._forceReapplyVisualState()},_toggleImageListeners:function(a){if(this._imageEntity&&this._imageEntity.element){var b="on"===a;b&&this._hasImageListeners||(this._imageEntity[a]("destroy",this._onElementComponentRemoveOrImageEntityDestroy,
            this),this._imageEntity.element[a]("set:color",this._onSetColor,this),this._imageEntity.element[a]("set:opacity",this._onSetOpacity,this),this._imageEntity.element[a]("set:spriteAsset",this._onSetSpriteAsset,this),this._imageEntity.element[a]("set:spriteFrame",this._onSetSpriteFrame,this),this._imageEntity.element[a]("mouseenter",this._onMouseEnter,this),this._imageEntity.element[a]("mouseleave",this._onMouseLeave,this),this._imageEntity.element[a]("mousedown",this._onMouseDown,this),this._imageEntity.element[a]("mouseup",
            this._onMouseUp,this),this._imageEntity.element[a]("touchstart",this._onTouchStart,this),this._imageEntity.element[a]("touchend",this._onTouchEnd,this),this._imageEntity.element[a]("touchleave",this._onTouchLeave,this),this._imageEntity.element[a]("touchcancel",this._onTouchCancel,this),this._imageEntity.element[a]("click",this._onClick,this),this._hasImageListeners=b)}},_storeDefaultVisualState:function(){this._imageEntity&&this._imageEntity.element&&(this._storeDefaultColor(this._imageEntity.element.color),
            this._storeDefaultOpacity(this._imageEntity.element.opacity),this._storeDefaultSpriteAsset(this._imageEntity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageEntity.element.spriteFrame))},_storeDefaultColor:function(a){this._defaultTint.r=a.r;this._defaultTint.g=a.g;this._defaultTint.b=a.b},_storeDefaultOpacity:function(a){this._defaultTint.a=a},_storeDefaultSpriteAsset:function(a){this._defaultSpriteAsset=a},_storeDefaultSpriteFrame:function(a){this._defaultSpriteFrame=a},_onSetColor:function(a){this._isApplyingTint||
        (this._storeDefaultColor(a),this._forceReapplyVisualState())},_onSetOpacity:function(a){this._isApplyingTint||(this._storeDefaultOpacity(a),this._forceReapplyVisualState())},_onSetSpriteAsset:function(a){this._isApplyingSprite||(this._storeDefaultSpriteAsset(a),this._forceReapplyVisualState())},_onSetSpriteFrame:function(a){this._isApplyingSprite||(this._storeDefaultSpriteFrame(a),this._forceReapplyVisualState())},_onMouseEnter:function(a){this._isHovering=!0;this._updateVisualState();this.fire("mouseenter",
            a)},_onMouseLeave:function(a){this._isPressed=this._isHovering=!1;this._updateVisualState();this.fire("mouseleave",a)},_onMouseDown:function(a){this._isPressed=!0;this._updateVisualState();this.fire("mousedown",a)},_onMouseUp:function(a){this._isPressed=!1;this._updateVisualState();this.fire("mouseup",a)},_onTouchStart:function(a){this._isPressed=!0;this._updateVisualState();this.fire("touchstart",a)},_onTouchEnd:function(a){this._isPressed=!1;this._updateVisualState();this.fire("touchend",a)},_onTouchLeave:function(a){this._isPressed=
            !1;this._updateVisualState();this.fire("touchleave",a)},_onTouchCancel:function(a){this._isPressed=!1;this._updateVisualState();this.fire("touchcancel",a)},_onClick:function(a){this.fire("click",a)},_updateVisualState:function(c){var f=this._visualState,g=this._determineVisualState();if((f!==g||c)&&this.enabled)switch(this._visualState=g,this.transitionMode){case pc.BUTTON_TRANSITION_MODE_TINT:this._applyTint(this[e[this._visualState]]);break;case pc.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this[a[this._visualState]],
            this[b[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(a){if(this._imageEntity&&this._imageEntity.element)switch(a){case pc.BUTTON_TRANSITION_MODE_TINT:this._cancelTween();this._applyTintImmediately(this._defaultTint);break;case pc.BUTTON_TRANSITION_MODE_SPRITE_CHANGE:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){if(this.active){if(this._isPressed)return"PRESSED";if(this._isHovering)return"HOVER"}else return"INACTIVE";
            return"DEFAULT"},_applySprite:function(a,b){this._imageEntity&&this._imageEntity.element&&(this._isApplyingSprite=!0,this._imageEntity.element.spriteAsset=a,this._imageEntity.element.spriteFrame=b||0,this._isApplyingSprite=!1)},_applyTint:function(a){this._cancelTween();0===this.fadeDuration?this._applyTintImmediately(a):this._applyTintWithTween(a)},_applyTintImmediately:function(a){this._imageEntity&&this._imageEntity.element&&a&&(this._isApplyingTint=!0,this._imageEntity.element.color=new pc.Color(a.r,
            a.g,a.b),this._imageEntity.element.opacity=a.a,this._isApplyingTint=!1)},_applyTintWithTween:function(a){if(this._imageEntity&&this._imageEntity.element&&a){var b=this._imageEntity.element.color,c=this._imageEntity.element.opacity;this._tweenInfo={startTime:pc.now(),from:new pc.Color(b.r,b.g,b.b,c),to:a.clone(),lerpVec:new pc.Vec4}}},_updateTintTween:function(){var a=pc.now()-this._tweenInfo.startTime,a=0===this.fadeDuration?1:a/this.fadeDuration,a=pc.math.clamp(a,0,1);1E-5<Math.abs(a-1)?(this._tweenInfo.lerpVec.lerp(this._tweenInfo.from,
            this._tweenInfo.to,a),this._applyTintImmediately(new pc.Color(this._tweenInfo.lerpVec.data))):(this._applyTintImmediately(this._tweenInfo.to),this._cancelTween())},_cancelTween:function(){delete this._tweenInfo},_onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._updateImageEntityReference();this._toggleImageListeners("on");this._forceReapplyVisualState()},onDisable:function(){this._toggleImageListeners("off");this._resetToDefaultVisualState(this.transitionMode)},
        onRemove:function(){this._toggleLifecycleListeners("off",this.system);this.onDisable()}});return{ButtonComponent:c}}());pc.extend(pc,function(){var e=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"],a=function(a){this.id="button";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.ButtonComponent;this.DataType=pc.ButtonComponentData;
        this.schema=e;this.on("beforeremove",this._onRemoveComponent,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ButtonComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){a._super.initializeComponentData.call(this,b,c,e)},_onRemoveComponent:function(a,c){c.onRemove()}});return{ButtonComponentSystem:a}}());pc.extend(pc,function(){return{ButtonComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,{ORIENTATION_HORIZONTAL:0,ORIENTATION_VERTICAL:1,FITTING_NONE:0,FITTING_STRETCH:1,FITTING_SHRINK:2,FITTING_BOTH:3});pc.extend(pc,function(){function e(a){return a.element}function a(a){return a.enabled&&a.element&&a.element.enabled}function b(a){var b="_"+a;Object.defineProperty(c.prototype,a,{get:function(){return this[b]},set:function(a){this[b]!==a&&(this[b]=a,this._scheduleReflow())}})}var c=function(a,b){this._orientation=pc.ORIENTATION_HORIZONTAL;this._reverseX=!1;this._reverseY=!0;this._alignment=new pc.Vec2(0,1);this._padding=new pc.Vec4;this._spacing=new pc.Vec2;this._heightFitting=this._widthFitting=
        pc.FITTING_NONE;this._wrap=!1;this._layoutCalculator=new pc.LayoutCalculator;this._listenForReflowEvents(this.entity,"on");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,"on")}.bind(this));this.entity.on("childinsert",this._onChildInsert,this);this.entity.on("childremove",this._onChildRemove,this);a.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this);a.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this);a.app.systems.layoutchild.on("add",
        this._onElementOrLayoutComponentAdd,this);a.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)},c=pc.inherits(c,pc.Component);pc.extend(c.prototype,{_isSelfOrChild:function(a){return a===this.entity||-1!==this.entity.children.indexOf(a)},_listenForReflowEvents:function(a,b){a.element&&(a.element[b]("enableelement",this._scheduleReflow,this),a.element[b]("disableelement",this._scheduleReflow,this),a.element[b]("resize",this._scheduleReflow,this),a.element[b]("set:pivot",
        this._scheduleReflow,this));a.layoutchild&&(a.layoutchild[b]("set_enabled",this._scheduleReflow,this),a.layoutchild[b]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(a){this._isSelfOrChild(a)&&(this._listenForReflowEvents(a,"off"),this._scheduleReflow())},_onChildInsert:function(a){this._listenForReflowEvents(a,"on");this._scheduleReflow()},
        _onChildRemove:function(a){this._listenForReflowEvents(a,"off");this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var b=this.entity.element,c=this.entity.children.filter(a).map(e);b&&0!==c.length&&(b={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,
            heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new pc.Vec2(Math.max(b.calculatedWidth,0),Math.max(b.calculatedHeight,0))},this._isPerformingReflow=!0,this._layoutCalculator.calculateLayout(c,b),this._isPerformingReflow=!1)},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this);this.entity.off("childremove",this._onChildRemove,this);this._listenForReflowEvents(this.entity,"off");this.entity.children.forEach(function(a){this._listenForReflowEvents(a,
            "off")}.bind(this));this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this);this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this);this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}});b("orientation");b("reverseX");b("reverseY");b("alignment");b("padding");b("spacing");b("widthFitting");b("heightFitting");
        b("wrap");return{LayoutGroupComponent:c}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="layoutgroup";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.LayoutGroupComponent;this.DataType=pc.LayoutGroupComponentData;this.schema=e;this._reflowQueue=[];this.on("beforeremove",this._onRemoveComponent,this);pc.ComponentSystem.on("postUpdate",this._onPostUpdate,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.LayoutGroupComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  c,d){void 0!==c.enabled&&(b.enabled=c.enabled);void 0!==c.orientation&&(b.orientation=c.orientation);void 0!==c.reverseX&&(b.reverseX=c.reverseX);void 0!==c.reverseY&&(b.reverseY=c.reverseY);void 0!==c.alignment&&(c.alignment instanceof pc.Vec2?b.alignment.copy(c.alignment):b.alignment.set(c.alignment[0],c.alignment[1]),b.alignment=b.alignment);void 0!==c.padding&&(c.padding instanceof pc.Vec4?b.padding.copy(c.padding):b.padding.set(c.padding[0],c.padding[1],c.padding[2],c.padding[3]),b.padding=b.padding);
        void 0!==c.spacing&&(c.spacing instanceof pc.Vec2?b.spacing.copy(c.spacing):b.spacing.set(c.spacing[0],c.spacing[1]),b.spacing=b.spacing);void 0!==c.widthFitting&&(b.widthFitting=c.widthFitting);void 0!==c.heightFitting&&(b.heightFitting=c.heightFitting);void 0!==c.wrap&&(b.wrap=c.wrap);a._super.initializeComponentData.call(this,b,c,d)},cloneComponent:function(a,c){var d=a.layoutgroup;return this.addComponent(c,{enabled:d.enabled,orientation:d.orientation,reverseX:d.reverseX,reverseY:d.reverseY,alignment:d.alignment,
        padding:d.padding,spacing:d.spacing,widthFitting:d.widthFitting,heightFitting:d.heightFitting,wrap:d.wrap})},scheduleReflow:function(a){-1===this._reflowQueue.indexOf(a)&&this._reflowQueue.push(a)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length){for(this._reflowQueue.sort(function(a,c){return a.entity.graphDepth<c.entity.graphDepth});0<this._reflowQueue.length;)this._reflowQueue.shift().reflow();this._reflowQueue=[]}},_onRemoveComponent:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               c){c.onRemove()}});return{LayoutGroupComponentSystem:a}}());pc.extend(pc,function(){return{LayoutGroupComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){function e(){}function a(a){function e(a,b,c){switch(a){case pc.FITTING_NONE:return f.NONE;case pc.FITTING_STRETCH:return b<c?f.APPLY_STRETCHING:f.NONE;case pc.FITTING_SHRINK:return b>=c?f.APPLY_SHRINKING:f.NONE;case pc.FITTING_BOTH:return b<c?f.APPLY_STRETCHING:b>=c?f.APPLY_SHRINKING:f.NONE;default:throw Error("Unrecognized fitting mode: "+a);}}function g(a,b){return t(a,b.size)+(a.length-1)*A.spacing[b.axis]}function n(a,b,c){var d=y(a,c.maxSize),e=x(a,c.fittingProportion),
        f=v(e,d);b=z[c.axis]-b;for(var g=0;g<a.length;++g){var h=d[g],k=r(h,b,e,f),l=a[h][c.size]+k,m=Math.min(l,a[h][c.maxSize]);a[h][c.size]=m;b-=k-Math.max(l-m,0)}}function h(a,b,c){var d=y(a,c.minSize,!0),e;e=x(a,c.fittingProportion);if(1===e.length)e=[1];else{for(var f=[],g=e.length,h=0;h<g;++h)f.push((1-e[h])/(g-1));e=f}f=v(e,d);b-=z[c.axis];for(g=0;g<a.length;++g){var h=d[g],k=r(h,b,e,f),l=a[h][c.size]-k,m=Math.max(l,a[h][c.minSize]);a[h][c.size]=m;b-=k-Math.max(m-l,0)}}function r(a,b,c,d){c=c[a];
        a=d[a];return 1E-5>Math.abs(c)&&1E-5>Math.abs(a)?b:b*c/a}function p(a){for(var b=[],c=0;c<a.length;++c){var d=a[c],e=Math.max(q(d,"minWidth"),0),f=Math.max(q(d,"minHeight"),0),g=Math.max(q(d,"maxWidth"),e),h=Math.max(q(d,"maxHeight"),f),k;k=q(d,"width");k=Math.min(Math.max(k,e),g);var l;l=q(d,"height");l=Math.min(Math.max(l,f),h);var m=q(d,"fitWidthProportion"),d=q(d,"fitHeightProportion");b.push({minWidth:e,minHeight:f,maxWidth:g,maxHeight:h,width:k,height:l,fitWidthProportion:m,fitHeightProportion:d})}return b}
        function q(a,b){var c=a.entity.layoutchild;return c&&c.enabled&&void 0!==c[b]&&null!==c[b]?c[b]:void 0!==a[b]?a[b]:d[b]}function t(a,b){return a.reduce(function(a,c){return a+c[b]},0)}function x(a,b){var c=t(a,b),d=[],e=a.length,f;if(0===c)for(f=0;f<e;++f)d.push(1/e);else for(f=0;f<e;++f)d.push(a[f][b]/c);return d}function y(a,b,c){a.forEach(w);return a.slice().sort(function(a,d){return c?d[b]-a[b]:a[b]-d[b]}).map(u)}function w(a,b){a.index=b}function u(a){return a.index}function v(a,b){var c=[];
            c[b[a.length-1]]=a[b[a.length-1]];for(var d=a.length-2;0<=d;--d)c[b[d]]=c[b[d+1]]+a[b[d]];return c}var z,A,D=b[a],B=b[c[a]];return function(a,b){A=b;z=new pc.Vec2(A.containerSize.x-A.padding.data[0]-A.padding.data[2],A.containerSize.y-A.padding.data[1]-A.padding.data[3]);for(var c=0;c<a.length;++c){var d=a[c],k=d.anchor.data;if(0!==k[0]||0!==k[1]||0!==k[2]||0!==k[3])d.anchor=[0,0,0,0]}if(A.wrap)for(var c=[[]],d=p(a),k=0,q=A[D.fitting]===pc.FITTING_SHRINK,r=0;r<a.length;++r){0<c[c.length-1].length&&
        (k+=A.spacing[D.axis]);var t=d[r][D.size],k=k+t;!q&&k>z[D.axis]&&0!==c[c.length-1].length&&(k=t,c.push([]));c[c.length-1].push(a[r]);q&&k>z[D.axis]&&r!==a.length-1&&(k=0,c.push([]))}else c=[a];d=A.orientation===pc.ORIENTATION_HORIZONTAL&&A.reverseX||A.orientation===pc.ORIENTATION_VERTICAL&&A.reverseY;k=A.orientation===pc.ORIENTATION_HORIZONTAL&&A.reverseY||A.orientation===pc.ORIENTATION_VERTICAL&&A.reverseX;if(d)for(q=0;q<c.length;++q)d&&c[q].reverse();k&&c.reverse();d=[];for(k=0;k<c.length;++k)q=
            p(c[k]),r=g(q,D),t=e(A[D.fitting],r,z[D.axis]),t===f.APPLY_STRETCHING?n(q,r,D):t===f.APPLY_SHRINKING&&h(q,r,D),d.push(q);for(var x=[],t=[],q=0;q<c.length;++q){r=c[q];r.largestElement=null;r.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY};for(k=0;k<r.length;++k){var u=d[q][k];u[B.size]>r.largestSize[B.size]&&(r.largestElement=r[k],r.largestSize=u)}x.push(r.largestElement);t.push(r.largestSize)}k=g(t,B);q=e(A[B.fitting],k,z[B.axis]);q===f.APPLY_STRETCHING?n(t,k,B):q===f.APPLY_SHRINKING&&
            h(t,k,B);for(q=0;q<c.length;++q)for(r=c[q],k=0;k<r.length;++k)t=d[q][k],x=1===c.length?z[B.axis]:r.largestSize[B.size],u=e(A[B.fitting],t[B.size],x),u===f.APPLY_STRETCHING?t[B.size]=Math.min(x,t[B.maxSize]):u===f.APPLY_SHRINKING&&(t[B.size]=Math.max(x,t[B.minSize]));a:{k={};k[D.axis]=0;k[B.axis]=0;q=[];for(r=0;r<c.length;++r){t=c[r];if(0===t.length){k=void 0;break a}for(var x=[],u=d[r],v=0;v<t.length;++v){var w=t[v],y=u[v];k[B.axis]-=-y[B.size]*w.pivot[B.axis];k[D.axis]-=-y[D.size]*w.pivot[D.axis];
            x[v]={};x[v][D.axis]=k[D.axis];x[v][B.axis]=k[B.axis];k[B.axis]+=-y[B.size]*w.pivot[B.axis];k[D.axis]+=y[D.size]*(1-w.pivot[D.axis])+A.spacing[D.axis]}t[D.size]=k[D.axis]-A.spacing[D.axis];t[B.size]=t.largestSize[B.size];k[D.axis]=0;k[B.axis]+=t[B.size]+A.spacing[B.axis];q.push(x)}c[B.size]=k[B.axis]-A.spacing[B.axis];k=q}q=k;r=A.alignment[D.axis];t=A.alignment[B.axis];x=A.padding[D.axis];u=A.padding[B.axis];for(v=0;v<c.length;++v)for(var w=c[v],y=d[v],S=q[v],X=(z[D.axis]-w[D.size])*r+x,aa=(z[B.axis]-
            c[B.size])*t+u,K=0;K<w.length;++K){var M=(w[B.size]-y[K][B.size])*A.alignment[B.axis];S[K][D.axis]+=X;S[K][B.axis]+=aa+M}for(q=0;q<c.length;++q)for(r=c[q],t=d[q],x=k[q],u=0;u<r.length;++u)v=r[u],v[D.calculatedSize]=t[u][D.size],v[B.calculatedSize]=t[u][B.size],A.orientation===pc.ORIENTATION_HORIZONTAL?v.entity.setLocalPosition(x[u][D.axis],x[u][B.axis],v.entity.getLocalPosition().z):v.entity.setLocalPosition(x[u][B.axis],x[u][D.axis],v.entity.getLocalPosition().z)}}var b={};b[pc.ORIENTATION_HORIZONTAL]=
        {axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"};b[pc.ORIENTATION_VERTICAL]={axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"};var c={};c[pc.ORIENTATION_HORIZONTAL]=pc.ORIENTATION_VERTICAL;c[pc.ORIENTATION_VERTICAL]=pc.ORIENTATION_HORIZONTAL;var d={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,
        maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},f={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},g={};g[pc.ORIENTATION_HORIZONTAL]=a(pc.ORIENTATION_HORIZONTAL);g[pc.ORIENTATION_VERTICAL]=a(pc.ORIENTATION_VERTICAL);e.prototype={calculateLayout:function(a,b){var c=g[b.orientation];if(c)c(a,b);else throw Error("Unrecognized orientation value: "+b.orientation);}};return{LayoutCalculator:e}}());pc.extend(pc,function(){function e(b){var c="_"+b;Object.defineProperty(a.prototype,b,{get:function(){return this[c]},set:function(a){this[c]!==a&&(this[c]=a,this.fire("resize"))}})}var a=function(a,c){this._minHeight=this._minWidth=0;this._maxHeight=this._maxWidth=null;this._fitHeightProportion=this._fitWidthProportion=0},a=pc.inherits(a,pc.Component);e("minWidth");e("minHeight");e("maxWidth");e("maxHeight");e("fitWidthProportion");e("fitHeightProportion");return{LayoutChildComponent:a}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="layoutchild";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.LayoutChildComponent;this.DataType=pc.LayoutChildComponentData;this.schema=e},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.LayoutChildComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(b,c,d){void 0!==c.enabled&&(b.enabled=c.enabled);void 0!==c.minWidth&&(b.minWidth=c.minWidth);void 0!==c.minHeight&&(b.minHeight=
        c.minHeight);void 0!==c.maxWidth&&(b.maxWidth=c.maxWidth);void 0!==c.maxHeight&&(b.maxHeight=c.maxHeight);void 0!==c.fitWidthProportion&&(b.fitWidthProportion=c.fitWidthProportion);void 0!==c.fitHeightProportion&&(b.fitHeightProportion=c.fitHeightProportion);a._super.initializeComponentData.call(this,b,c,d)},cloneComponent:function(a,c){var d=a.layoutchild;return this.addComponent(c,{enabled:d.enabled,minWidth:d.minWidth,minHeight:d.minHeight,maxWidth:d.maxWidth,maxHeight:d.maxHeight,fitWidthProportion:d.fitWidthProportion,
        fitHeightProportion:d.fitHeightProportion})}});return{LayoutChildComponentSystem:a}}());pc.extend(pc,function(){return{LayoutChildComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){pc.FONT_MSDF="msdf";var e=function(a,b){this.type=pc.FONT_MSDF;this.em=1;this.textures=a;this.intensity=0;this._data=null;this.data=b};e.prototype={};Object.defineProperty(e.prototype,"data",{get:function(){return this._data},set:function(a){if(this._data=a)if(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),!this._data.version||2>this._data.version)if(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],
            this._data.chars)for(var b in this._data.chars)this._data.chars[b].map=0}});return{FONT_MSDF:pc.FONT_MSDF,Font:e}}());pc.extend(pc,function(){var e=function(a,b){this._oldState=!0;this._size=new pc.Vec3;this.on("set_enabled",this._onSetEnabled,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onEnable:function(){e._super.onEnable.call(this);this._checkState()},onDisable:function(){e._super.onDisable.call(this);this._checkState()},_onSetEnabled:function(a,b,c){this._checkState()},_checkState:function(){var a=this.enabled&&this.entity.enabled;a!==this._oldState&&(this._oldState=a,this.fire("enable"),this.fire("state",
        this.enabled))},_onBeforeRemove:function(){this.fire("remove")}});Object.defineProperty(e.prototype,"size",{set:function(a){a instanceof pc.Vec3?this._size.copy(a):a instanceof Array&&3<=a.length&&this.size.set(a[0],a[1],a[2])},get:function(){return this._size}});return{ZoneComponent:e}}());pc.extend(pc,function(){var e=["enabled"],a=function(a){this.id="zone";this.app=a;a.systems.add(this.id,this);this.ComponentType=pc.ZoneComponent;this.DataType=pc.ZoneComponentData;this.schema=e;this.on("beforeremove",this._onBeforeRemove,this)},a=pc.inherits(a,pc.ComponentSystem);pc.Component._buildAccessors(pc.ZoneComponent.prototype,e);pc.extend(a.prototype,{initializeComponentData:function(a,c,d){a.enabled=c.hasOwnProperty("enabled")?!!c.enabled:!0;c.size&&(c.size instanceof pc.Vec3?a.size.copy(c.size):
        c.size instanceof Array&&3<=c.size.length&&a.size.set(c.size[0],c.size[1],c.size[2]))},cloneComponent:function(a,c){return this.addComponent(c,{size:a.zone.size})},_onBeforeRemove:function(a,c){c._onBeforeRemove()}});return{ZoneComponentSystem:a}}());pc.extend(pc,function(){return{ZoneComponentData:pc.inherits(function(){this.enabled=!0},pc.ComponentData)}}());pc.extend(pc,function(){function e(a,c,d,f){if(c instanceof pc.Entity){var g=c.c;Object.keys(g).forEach(function(c){var e=g[c];e.system.getPropertiesOfType("entity").forEach(function(g){g=g.name;var h=e[g];a.findByGuid(h)&&((h=f[h])?d.c[c][g]=h:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))})});c=c.children.filter(function(a){return a instanceof pc.Entity});var k=d.children.filter(function(a){return a instanceof pc.Entity});c.forEach(function(c,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       d){e(a,c,k[d],f)})}}var a=function(a,c){a instanceof pc.Application&&(c=a);this._guid=pc.guid.create();this._batchHandle=null;this.c={};this._app=c;c||(this._app=pc.Application.getApplication())||console.error("Couldn't find current application");pc.events.attach(this)},a=pc.inherits(a,pc.GraphNode);a.prototype.addComponent=function(a,c){var d=this._app.systems[a];return!d||this.c[a]?null:d.addComponent(this,c)};a.prototype.removeComponent=function(a){var c=this._app.systems[a];c&&this.c[a]&&c.removeComponent(this)};
        a.prototype.getGuid=function(){return this._guid};a.prototype.setGuid=function(a){this._guid=a};a.prototype._notifyHierarchyStateChanged=function(a,c){var d=!1;a===this&&0===this._app._enableList.length&&(d=!0);a._beingEnabled=!0;a._onHierarchyStateChanged(c);a._onHierarchyStatePostChanged&&this._app._enableList.push(a);var e,g,k=a._children;e=0;for(g=k.length;e<g;e++)k[e]._enabled&&this._notifyHierarchyStateChanged(k[e],c);a._beingEnabled=!1;if(d){e=0;for(g=this._app._enableList.length;e<g;e++)this._app._enableList[e]._onHierarchyStatePostChanged();
            this._app._enableList.length=0}};a.prototype._onHierarchyStateChanged=function(a){pc.Entity._super._onHierarchyStateChanged.call(this,a);var c,d=this.c,e;for(e in d)if(d.hasOwnProperty(e)&&(c=d[e],c.enabled))if(a)c.onEnable();else c.onDisable()};a.prototype._onHierarchyStatePostChanged=function(){var a=this.c,c;for(c in a)if(a.hasOwnProperty(c))a[c].onPostStateChange()};a.prototype.setRequest=function(a){this._request=a};a.prototype.getRequest=function(){return this._request};a.prototype.findByGuid=
            function(a){if(this._guid===a)return this;for(var c=0;c<this._children.length;c++)if(this._children[c].findByGuid){var d=this._children[c].findByGuid(a);if(null!==d)return d}return null};a.prototype.destroy=function(){for(var a in this.c)this.c[a].enabled=!1;for(a in this.c)this.c[a].system.removeComponent(this);this._parent&&this._parent.removeChild(this);a=this._children;for(var c=a.shift();c;)c instanceof pc.Entity&&c.destroy(),c._parent=null,c=a.shift();this.fire("destroy",this);this._callbacks&&
        (this._callbacks=null);this._callbackActive&&(this._callbackActive=null)};a.prototype.clone=function(){var a={},c=this._cloneRecursively(a);a[this.getGuid()]=c.getGuid();e(this,this,c,a);return c};a.prototype._cloneRecursively=function(a){var c,d=new pc.Entity(this._app);pc.Entity._super._cloneInternal.call(this,d);for(c in this.c)this.c[c].system.cloneComponent(this,d);for(c=0;c<this._children.length;c++){var e=this._children[c];if(e instanceof pc.Entity){var g=e._cloneRecursively(a);d.addChild(g);
            a[e.getGuid()]=g.getGuid()}}return d};return{Entity:a}}());pc.extend(pc,function(){var e=function(){this._handlers={};this._requests={};this._cache={}};e.prototype={addHandler:function(a,b){this._handlers[a]=b;b._loader=this},removeHandler:function(a){delete this._handlers[a]},getHandler:function(a){return this._handlers[a]},load:function(a,b,c,d){var e=this._handlers[b];if(e){var g=a+b;void 0!==this._cache[g]?c(null,this._cache[g]):this._requests[g]?this._requests[g].push(c):(this._requests[g]=[c],e.load(a,function(b,c,m){if(this._requests[g]){var n=this._requests[g].length;
        if(b)for(c=0;c<n;c++)this._requests[g][c](b);else for(b=e.open(a,c,d),this._cache[g]=b,c=0;c<n;c++)this._requests[g][c](null,b,m);delete this._requests[g]}}.bind(this),d))}else c("No handler for asset type: "+b)},open:function(a,b){var c=this._handlers[a];return c?c.open(null,b):(console.warn("No resource handler found for: "+a),b)},patch:function(a,b){var c=this._handlers[a.type];c?c.patch&&c.patch(a,b):console.warn("No resource handler found for: "+a.type)},clearCache:function(a,b){delete this._cache[a+
    b]},getFromCache:function(a,b){if(this._cache[a+b])return this._cache[a+b]},destroy:function(){this._handlers={};this._requests={};this._cache={}}};return{ResourceLoader:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading animation resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return this["_parseAnimationV"+b.animation.version](b)},_parseAnimationV3:function(a){a=a.animation;var b=new pc.Animation;b.setName(a.name);b.duration=a.duration;for(var c=0;c<a.nodes.length;c++){var d=new pc.Node,e=a.nodes[c];d._name=e.name;for(var g=0;g<e.keys.length;g++){var k=e.keys[g],l=
        k.time,m=k.pos,n=k.rot,k=k.scale,m=new pc.Vec3(m[0],m[1],m[2]),n=(new pc.Quat).setFromEulerAngles(n[0],n[1],n[2]),k=new pc.Vec3(k[0],k[1],k[2]),l=new pc.Key(l,m,n,k);d._keys.push(l)}b.addNode(d)}return b},_parseAnimationV4:function(a){a=a.animation;var b=new pc.Animation;b.setName(a.name);b.duration=a.duration;for(var c=0;c<a.nodes.length;c++){var d=new pc.Node,e=a.nodes[c];d._name=e.name;for(var g=e.defaults.p,k=e.defaults.r,l=e.defaults.s,m=0;m<e.keys.length;m++){var n=e.keys[m],h=n.t,r=g?g:n.p,
        p=k?k:n.r,n=l?l:n.s,r=new pc.Vec3(r[0],r[1],r[2]),p=(new pc.Quat).setFromEulerAngles(p[0],p[1],p[2]),n=new pc.Vec3(n[0],n[1],n[2]),h=new pc.Key(h,r,p,n);d._keys.push(h)}b.addNode(d)}return b}};return{AnimationHandler:e}}());pc.extend(pc,function(){var e=function(){var a=window.navigator.userAgent,c=a.indexOf("MSIE ");return 0<c?parseInt(a.substring(c+5,a.indexOf(".",c)),10):0<a.indexOf("Trident/")?(c=a.indexOf("rv:"),parseInt(a.substring(c+3,a.indexOf(".",c)),10)):!1}(),a=function(a){this.manager=a};a.prototype={_isSupported:function(a){return{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[pc.path.getExtension(a)]?!0:!1},load:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      c){var d=function(a){c(null,new pc.Sound(a))},e=function(d){d=d||"Error loading audio url: "+a;console.warn(d);c(d)};this._createSound?this._isSupported(a)?this._createSound(a,d,e):e(pc.string.format("Audio format for {0} not supported",a)):e(null)},open:function(a,c){return c}};pc.SoundManager.hasAudioContext()?a.prototype._createSound=function(a,c,d){var e=this.manager;e.context?pc.http.get(a,function(a,b){a?d(a):e.context.decodeAudioData(b,c,d)}):d("Audio manager has no audio context")}:pc.SoundManager.hasAudio()&&
        (a.prototype._createSound=function(a,c,d){var f=null;try{f=new Audio}catch(k){d("No support for Audio element");return}e&&document.body.appendChild(f);var g=function(){f.removeEventListener("canplaythrough",g);e&&document.body.removeChild(f);c(f)};f.onerror=function(){f.onerror=null;e&&document.body.removeChild(f);d()};f.addEventListener("canplaythrough",g);f.src=a});return{AudioHandler:a}}());pc.extend(pc,function(){var e=function(a,b,c){this._device=a;this._assets=b;this._loader=c};e.prototype={load:function(a,b){},open:function(a,b){},patch:function(a,b){var c=this,d=!1;a.resources[0]||(a.resources[0]=new pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,cubemap:!0,mipmaps:!0,fixCubemapSeams:!!a._dds}),d=!0);if(!a.file)delete a._dds;else if(a.file&&!a._dds){var e=a.getFileUrl();b._loader.load(e+"?t="+a.file.hash,"texture",function(d,e){d?(b.fire("error",d,a),b.fire("error:"+
        a.id,d,a),a.fire("error",d,a)):(b._loader.patch({resource:e,type:"texture",data:a.data},b),a._dds=e,c.patch(a,b))})}if((!a.file||!a._dds)&&a.resources[1])a.resources=[a.resources[0]],d=!0;else if(a._dds&&!a.resources[1]){a.resources=[a.resources[0]];a._dds.fixCubemapSeams=!0;a._dds.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a._dds.addressV=pc.ADDRESS_CLAMP_TO_EDGE;d=0;this._device.useTexCubeLod&&(a.resources.push(a._dds),d=1);for(;6>d;d++)e=new pc.Texture(this._device,{cubemap:!0,fixCubemapSeams:!0,mipmaps:!0,
        format:a._dds.format,rgbm:a._dds.rgbm,width:Math.pow(2,7-d),height:Math.pow(2,7-d)}),e._levels[0]=a._dds._levels[d],e.upload(),a.resources.push(e);d=!0}e=a.resource;e.name!==a.name&&(e.name=a.name);var g=!!a.data.rgbm;a.data.hasOwnProperty("rgbm")&&e.rgbm!==g&&(e.rgbm=g);e.fixCubemapSeams=!!a._dds;a.data.hasOwnProperty("minFilter")&&e.minFilter!==a.data.minFilter&&(e.minFilter=a.data.minFilter);a.data.hasOwnProperty("magFilter")&&e.magFilter!==a.data.magFilter&&(e.magFilter=a.data.magFilter);a.data.hasOwnProperty("anisotropy")&&
    e.anisotropy!==a.data.anisotropy&&(e.anisotropy=a.data.anisotropy);e.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(e.addressU=pc.ADDRESS_CLAMP_TO_EDGE);e.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(e.addressV=pc.ADDRESS_CLAMP_TO_EDGE);this._patchTextureFaces(a,b);d&&(b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",a))},_patchTexture:function(){this.registry._loader._handlers.cubemap._patchTextureFaces(this,this.registry)},_patchTextureFaces:function(a,b){if(a.loadFaces||!a.file){var c=a.resource,d=[],e=0,
        g=!1,k=this;a._levelsEvents||(a._levelsEvents=[null,null,null,null,null,null]);a.data.textures.forEach(function(l,m){var n=function(h){e++;d[m]=h&&h.resource.getSource()||null;var l=a._levelsEvents[m];if(l!==h){l&&l.off("load",k._patchTexture,a);if(h)h.on("load",k._patchTexture,a);a._levelsEvents[m]=h||null}d[m]!==c._levels[0][m]&&(g=!0);6===e&&g&&(c.setSource(d),b.fire("load",a),b.fire("load:"+a.id,a),a.fire("load",a))},h=function(a){a.ready(n);b.load(a)},r=b.get(l);r?(r.ready(n),b.load(r)):l?(b.once("load:"+
        l,n),b.once("add:"+l,h)):n(null)})}}};return{CubemapHandler:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading JSON resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{JsonHandler:e}}());pc.extend(pc,function(){var e={ambient:"vec3",ambientTnumber:"boolean",aoMap:"texture",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",occludeSpecular:"boolean",diffuse:"vec3",diffuseMap:"texture",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseMapTnumber:"boolean",specular:"vec3",
        specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMapChannel:"string",specularMapUv:"number",specularMap:"texture",specularTint:"boolean",specularMapTiling:"vec2",specularMapOffset:"vec2",specularMapTnumber:"boolean",specularAntialias:"boolean",useMetalness:"boolean",metalnessMap:"texture",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",metalnessMapTnumber:"boolean",
        metalness:"number",conserveEnergy:"boolean",shininess:"number",glossMap:"texture",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",fresnelModel:"number",fresnelFactor:"float",emissive:"vec3",emissiveMap:"texture",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveTint:"boolean",
        emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpMapFactor:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaTest:"number",opacity:"number",opacityMap:"texture",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",
        refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightMap:"texture",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"number",blendType:"number",shadingModel:"number"},a={},b={aoMap:"white",diffuseMap:"gray",specularMap:"gray",
        metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"},c=function(a,b,c,d){b="cubeMap prefilteredCubeMap128 prefilteredCubeMap64 prefilteredCubeMap32 prefilteredCubeMap16 prefilteredCubeMap8 prefilteredCubeMap4".split(" ");for(c=0;c<b.length;c++)this[b[c]]!==a.resources[c]&&(this[b[c]]=a.resources[c]);this.update()},d=function(a){this._assets=a.assets;this._device=a.graphicsDevice;this._createPlaceholders()};
        d.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b&&b(pc.string.format("Error loading material: {0} [{1}]",a,c)):b&&b(null,d)})},open:function(a,b){var c=new pc.StandardMaterial;b.parameters||this._createParameters(b);c.init(b);c._data=b;return c},_createPlaceholders:function(){var b={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]},c;for(c in b)if(b.hasOwnProperty(c)){for(var d=a[c]=new pc.Texture(this._device,{width:2,height:2,format:pc.PIXELFORMAT_R8_G8_B8_A8}),
                                                                                                                                                                                                                                                                                                                                                                                                                                                           e=d.lock(),m=0;4>m;m++)for(var n=0;4>n;n++)e[4*m+n]=b[c][n];d.unlock()}},_createParameters:function(a){var b=[];a.shadingModel||(a.shadingModel="blinn"===a.shader?pc.SPECULAR_BLINN:pc.SPECULAR_PHONG);var c=a.shader;delete a.shader;for(var d in a)a.hasOwnProperty(d)&&b.push({name:d,type:e[d],data:a[d]});a.shader=c;a.parameters=b},patch:function(a,b){void 0===a.data.shader&&(a.data=a.resource._data,delete a.resource._data);this._updateStandardMaterial(a,a.data,b);a.off("change",this._onAssetChange,
            this);a.on("change",this._onAssetChange,this);a.on("unload",this._onAssetUnload,this)},_onAssetChange:function(a,b,c){"data"===b&&this._updateStandardMaterial(a,c,this._assets)},_onAssetUnload:function(a){delete a.data.parameters;delete a.data.chunks;delete a.data.name},_updateStandardMaterial:function(d,e,k){var l=d.resource,m;d.file&&(m=pc.path.getDirectory(d.getFileUrl()));e.name=d.name;e.parameters||this._createParameters(e);var n="path"===e.mapping_format;e.chunks=d.resource.chunks;e.parameters.forEach(function(h,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      r){var p;if("texture"===h.type){l._assetHandlers||(l._assetHandlers={});var q=l._assetHandlers[h.name];if(!h.data||h.data instanceof pc.Texture)q&&!h.data&&(k.off("load:"+q.id,q.bind),k.off("add:"+q.id,q.add),k.off("remove:"+q.id,q.remove),q.url&&(k.off("add:url:"+q.url,q.add),k.off("remove:url:"+q.url,q.remove)),l._assetHandlers[h.name]=null);else if(n?d=k.getByUrl(pc.path.join(m,h.data)):(p=h.data,d=k.get(h.data)),q&&(k.off("load:"+q.id,q.bind),k.off("add:"+q.id,q.add),k.off("remove:"+q.id,q.remove),
            q.url&&(k.off("add:url:"+q.url,q.add),k.off("remove:url:"+q.url,q.remove)),l._assetHandlers[h.name]=null),q=l._assetHandlers[h.name]={id:p,url:n?pc.path.join(m,h.data):"",bind:function(a){e.parameters[r].data=a.resource;l[e.parameters[r].name]=a.resource;l.update()},add:function(a){k.load(a)},remove:function(a){l[e.parameters[r].name]===a.resource&&(e.parameters[r].data=null,l[e.parameters[r].name]=null,l.update())}},p?(k.on("load:"+p,q.bind),k.on("remove:"+p,q.remove)):n&&(k.on("load:url:"+pc.path.join(m,
                h.data),q.bind),k.on("remove:url:"+pc.path.join(m,h.data),q.remove)),d)d.resource?q.bind(d):b[e.parameters[r].name]&&(p=a[b[e.parameters[r].name]])&&(e.parameters[r].data=p,l[e.parameters[r].name]=p),k.load(d);else if(p)k.once("add:"+p,q.add);else if(n)k.once("add:url:"+q.url,q.add)}else if("cubemap"===h.type&&h.data&&!(h.data instanceof pc.Texture)){n?d=k.getByUrl(pc.path.join(m,h.data)):(p=h.data,d=k.get(h.data));var q=function(a){e.shadingModel===pc.SPECULAR_PHONG&&(a.loadFaces=!0);a.ready(t);
            k.load(a)},t=function(a){h.data=a.resource;1<a.resources.length&&(e.parameters.push({name:"prefilteredCubeMap128",data:a.resources[1]}),e.parameters.push({name:"prefilteredCubeMap64",data:a.resources[2]}),e.parameters.push({name:"prefilteredCubeMap32",data:a.resources[3]}),e.parameters.push({name:"prefilteredCubeMap16",data:a.resources[4]}),e.parameters.push({name:"prefilteredCubeMap8",data:a.resources[5]}),e.parameters.push({name:"prefilteredCubeMap4",data:a.resources[6]}));l.init(e);a.off("load",
            c,l);a.on("load",c,l)};if(d)q(d);else if(p)k.once("add:"+p,q);else if(n)k.once("add:url:"+pc.path.join(m,h.data),function(a){a.ready(function(a){e.parameters[r].data=a.resource;l.init(e);a.off("load",c,l);a.on("load",c,l)});k.load(a)})}});l.init(e)}};return{MaterialHandler:d,getMaterialParamType:function(a){return e[a]}}}());pc.extend(pc,function(){var e=function(a){this._device=a;this._parsers=[];this.addParser(new pc.JsonModelParser(this._device),function(a,c){return".json"===pc.path.getExtension(a)})};e.DEFAULT_MATERIAL=pc.Scene.defaultMaterial;e.prototype={load:function(a,b){pc.http.get(a,function(c,d){b&&(c?b(pc.string.format("Error loading model: {0} [{1}]",a,c)):b(null,d))})},open:function(a,b){for(var c=0;c<this._parsers.length;c++){var d=this._parsers[c];if(d.decider(a,b))return d.parser.parse(b)}logWARNING(pc.string.format("No model parser found for: {0}",
        a));return null},patch:function(a,b){if(a.resource){var c=a.data;a.resource.meshInstances.forEach(function(d,e){if(c.mapping){var g=function(a){a.resource?d.material=a.resource:(a.once("load",g),b.load(a));a.once("remove",function(a){d.material===a.resource&&(d.material=pc.ModelHandler.DEFAULT_MATERIAL)})};if(c.mapping[e]){var k=c.mapping[e].material,l=c.mapping[e].path;if(void 0!==k)if(k)if(l=b.get(k))g(l);else b.once("add:"+k,g);else d.material=pc.ModelHandler.DEFAULT_MATERIAL;else if(l)if(k=a.getFileUrl(),
            k=pc.path.getDirectory(k),k=pc.path.join(k,c.mapping[e].path),l=b.getByUrl(k))g(l);else b.once("add:url:"+k,g)}else d.material=pc.ModelHandler.DEFAULT_MATERIAL}})}},addParser:function(a,b){this._parsers.push({parser:a,decider:b})}};return{ModelHandler:e}}());pc.extend(pc,function(){var e=function(a){this._app=a;this._scripts={};this._cache={}};e._types=[];e._push=function(a){pc.script.legacy&&0<e._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):e._types.push(a)};e.prototype={load:function(a,b){var c=this;pc.script.app=this._app;this._loadScript(a,function(a,f,g){if(a)b(a);else if(pc.script.legacy)a=null,e._types.length&&(a=e._types.pop()),a?this._scripts[f]=a:a=null,b(null,a,g);else{a={};for(var k=0;k<e._types.length;k++)a[e._types[k].name]=
        e._types[k];e._types.length=0;b(null,a,g);delete c._loader._cache[f+"script"]}}.bind(this))},open:function(a,b){return b},patch:function(a,b){},_loadScript:function(a,b){var c=document.head,d=document.createElement("script");this._cache[a]=d;d.async=!1;d.addEventListener("error",function(a){b(pc.string.format("Script: {0} failed to load",a.target.src))},!1);var e=!1;d.onload=d.onreadystatechange=function(){e||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(e=!0,b(null,a,
        d))};d.src=a;c.appendChild(d)}};return{ScriptHandler:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading text resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{TextHandler:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,{responseType:pc.Http.ResponseType.ARRAY_BUFFER},function(c,d){c?b(pc.string.format("Error loading binary resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{BinaryHandler:e}}());pc.extend(pc,function(){var e={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b,e){this._device=a;this._assets=b;this._loader=e;this.crossOrigin=void 0;b.prefix&&(this.crossOrigin="anonymous")};
        b.prototype={load:function(a,b){var e,g=0<=a.indexOf("?")?a.split("?")[0]:a,k=pc.path.getExtension(g).toLowerCase();if(".dds"===k||".crn"===k)pc.http.get(a,{cache:!0,responseType:"arraybuffer"},function(a,c){a?b(a):b(null,c)});else if(".jpg"===k||".jpeg"===k||".gif"===k||".png"===k)e=new Image,void 0!==this.crossOrigin&&pc.ABSOLUTE_URL.test(a)&&(e.crossOrigin=this.crossOrigin),e.onload=function(){b(null,e)},e.onerror=function(e){b(pc.string.format("Error loading Texture from: '{0}'",a))},e.src=a;
        else{var l=g.indexOf("blob:");0<=l?(a=g=g.substr(l),e=new Image,e.onload=function(){b(null,e)},e.onerror=function(e){b(pc.string.format("Error loading Texture from: '{0}'",a))},e.src=a):setTimeout(function(){b(pc.string.format("Error loading Texture: format not supported: '{0}'",k))},0)}},open:function(a,b){if(a){var e,g=pc.path.getExtension(a).toLowerCase(),k=null;if(b instanceof Image||b instanceof HTMLImageElement){var l=b,k=".jpg"===g||".jpeg"===g?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8;
            e=new pc.Texture(this._device,{width:l.width,height:l.height,format:k});e.setSource(l)}else if(b instanceof ArrayBuffer){if(".crn"===g){e=b.byteLength;var l=new Uint8Array(b),g=Module._malloc(e),m=Module.HEAPU8,n,h=g/4,r=e%4,p=new Uint32Array(l.buffer,0,(e-r)/4),q=new Uint32Array(m.buffer);for(n=0;n<p.length;n++)q[h+n]=p[n];for(n=e-r;n<e;n++)m[g+n]=l[n];l=Module._crn_decompress_get_data(g,e);e=Module._crn_decompress_get_size(g,e);b=Module.HEAPU8.buffer.slice(l,l+e)}e=new Uint32Array(b,0,32);var g=
            e[4],l=e[3],m=Math.max(e[7],1),t=e[21],x=e[22];n=65024===e[28];var y=q=p=r=h=!1;if(4===e[20])if(827611204===t)k=pc.PIXELFORMAT_DXT1,h=!0;else if(894720068===t)k=pc.PIXELFORMAT_DXT5,h=!0;else if(116===t)k=pc.PIXELFORMAT_RGBA32F,r=!0;else if(826496069===t)k=pc.PIXELFORMAT_ETC1,p=h=!0;else if(825438800===t||825504336===t)k=825438800===t?pc.PIXELFORMAT_PVRTC_2BPP_RGB_1:pc.PIXELFORMAT_PVRTC_2BPP_RGBA_1,q=h=!0;else{if(825439312===t||825504848===t)k=825439312===t?pc.PIXELFORMAT_PVRTC_4BPP_RGB_1:pc.PIXELFORMAT_PVRTC_4BPP_RGBA_1,
            y=h=!0}else 32===x&&(k=pc.PIXELFORMAT_R8_G8_B8_A8);if(!k)return e=new pc.Texture(this._device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8});e=new pc.Texture(this._device,{width:g,height:l,format:k,cubemap:n});n&&(e.addressU=pc.ADDRESS_CLAMP_TO_EDGE,e.addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(var k=128,x=n?6:1,w,t=827611204===t?8:16,u,v=0;v<x;v++)for(var z=g,A=l,D=0;D<m;D++)h?p?w=Math.floor((z+3)/4)*Math.floor((A+3)/4)*8:q?w=Math.max(z,16)*Math.max(A,8)/4:y?w=Math.max(z,8)*Math.max(A,8)/2:(w=Math.floor((z+
            4-1)/4),u=Math.floor((A+4-1)/4),w*=u,w*=t):w=z*A*4,u=r?new Float32Array(b,k,w):new Uint8Array(b,k,w),n?(e._levels[D]||(e._levels[D]=[]),e._levels[D][v]=u):e._levels[D]=u,k+=r?4*w:w,z=Math.max(.5*z,1),A=Math.max(.5*A,1);e.upload()}return e}},patch:function(b,d){var f=b.resource;if(f){f.name!==b.name&&(f.name=b.name);b.data.hasOwnProperty("minfilter")&&f.minFilter!==a[b.data.minfilter]&&(f.minFilter=a[b.data.minfilter]);b.data.hasOwnProperty("magfilter")&&f.magFilter!==a[b.data.magfilter]&&(f.magFilter=
            a[b.data.magfilter]);b.data.hasOwnProperty("addressu")&&f.addressU!==e[b.data.addressu]&&(f.addressU=e[b.data.addressu]);b.data.hasOwnProperty("addressv")&&f.addressV!==e[b.data.addressv]&&(f.addressV=e[b.data.addressv]);b.data.hasOwnProperty("mipmaps")&&f.mipmaps!==b.data.mipmaps&&(f.mipmaps=b.data.mipmaps);b.data.hasOwnProperty("anisotropy")&&f.anisotropy!==b.data.anisotropy&&(f.anisotropy=b.data.anisotropy);var g=!!b.data.rgbm;b.data.hasOwnProperty("rgbm")&&f.rgbm!==g&&(f.rgbm=g)}}};return{TextureHandler:b}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading html resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{HtmlHandler:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading css resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{CssHandler:e,createStyle:function(a){var b=document.createElement("style");b.type="text/css";b.styleSheet?b.styleSheet.cssText=a:b.appendChild(document.createTextNode(a));return b}}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b(pc.string.format("Error loading shader resource: {0} [{1}]",a,c)):b(null,d)})},open:function(a,b){return b},patch:function(a,b){}};return{ShaderHandler:e}}());pc.extend(pc,function(){var e=function(a){this._app=a};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b("Error requesting scene: "+a):b(null,d)})},open:function(a,b){this._app.systems.script.preloading=!0;var c=(new pc.SceneParser(this._app)).parse(b),d=this._app.scene;d.root=c;this._app.applySceneSettings(b.settings);this._app.systems.script.preloading=!1;return d},patch:function(a,b){}};return{SceneHandler:e}}());pc.extend(pc,function(){var e=function(a){this._app=a};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b("Error requesting scene: "+a):b(null,d)})},open:function(a,b){this._app.systems.script.preloading=!0;var c=(new pc.SceneParser(this._app)).parse(b);this._app.systems.script.preloading=!1;return c}};return{HierarchyHandler:e}}());pc.extend(pc,function(){var e=function(a){this._app=a};e.prototype={load:function(a,b){pc.http.get(a,function(c,d){c?b("Error requesting scene: "+a):b(null,d)})},open:function(a,b){return b.settings}};return{SceneSettingsHandler:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={load:function(a,b){b(null,null)},open:function(a,b){return b}};return{FolderHandler:e}}());pc.extend(pc,function(){var e=function(a){this._loader=a};e.prototype={load:function(a,b,c){var d=this;".json"===pc.path.getExtension(a)?pc.http.get(a,function(c,e){c?b(pc.string.format("Error loading font resource: {0} [{1}]",a,c)):d._loadTextures(a.replace(".json",".png"),e,function(a,c){if(a)return b(a);b(null,{data:e,textures:c})})}):this._loadTextures(a,c&&c.data,b)},_loadTextures:function(a,b,c){var d=1,e=0,g=null;b&&2<=b.version&&(d=b.info.maps.length);var k=Array(d),l=this._loader;b=function(b){var h=
        function(a,h){if(!g){if(a)return g=a,c(a);h.upload();k[b]=h;e++;e===d&&c(null,k)}};0===b?l.load(a,"texture",h):l.load(a.replace(".png",b+".png"),"texture",h)};for(var m=0;m<d;m++)b(m)},open:function(a,b,c){return b.textures?new pc.Font(b.textures,b.data):new pc.Font(b,null)},patch:function(a,b){var c=a.resource;!c.data&&a.data?c.data=a.data:!a.data&&c.data&&(a.data=c.data)}};return{FontHandler:e}}());pc.extend(pc,function(){var e={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=/^data\.frames\.(\d+)$/,c=function(a){this._loader=a};c.prototype={load:function(a,b){var c=this,e=this._loader.getHandler("texture");
        if(".json"===pc.path.getExtension(a))pc.http.get(a,function(e,k){if(e)b(e);else{var n=a.replace(".json",".png");c._loader.load(n,"texture",function(a,c){a?b(a):b(null,{data:k,texture:c})})}});else return e.load(a,b)},open:function(a,b){var c=new pc.TextureAtlas;if(b.texture&&b.data)c.texture=b.texture,c.__data=b.data;else{var e=this._loader.getHandler("texture").open(a,b);if(!e)return null;c.texture=e}return c},patch:function(b,c){b.resource.__data&&(void 0!==b.resource.__data.minfilter&&(b.data.minfilter=
        b.resource.__data.minfilter),void 0!==b.resource.__data.magfilter&&(b.data.magfilter=b.resource.__data.magfilter),void 0!==b.resource.__data.addressu&&(b.data.addressu=b.resource.__data.addressu),void 0!==b.resource.__data.addressv&&(b.data.addressv=b.resource.__data.addressv),void 0!==b.resource.__data.mipmaps&&(b.data.mipmaps=b.resource.__data.mipmaps),void 0!==b.resource.__data.anisotropy&&(b.data.anisotropy=b.resource.__data.anisotropy),void 0!==b.resource.__data.rgbm&&(b.data.rgbm=!!b.resource.__data.rgbm),
        b.data.frames=b.resource.__data.frames,delete b.resource.__data);var g=b.resource.texture;if(g){g.name=b.name;b.data.hasOwnProperty("minfilter")&&g.minFilter!==a[b.data.minfilter]&&(g.minFilter=a[b.data.minfilter]);b.data.hasOwnProperty("magfilter")&&g.magFilter!==a[b.data.magfilter]&&(g.magFilter=a[b.data.magfilter]);b.data.hasOwnProperty("addressu")&&g.addressU!==e[b.data.addressu]&&(g.addressU=e[b.data.addressu]);b.data.hasOwnProperty("addressv")&&g.addressV!==e[b.data.addressv]&&(g.addressV=e[b.data.addressv]);
        b.data.hasOwnProperty("mipmaps")&&g.mipmaps!==b.data.mipmaps&&(g.mipmaps=b.data.mipmaps);b.data.hasOwnProperty("anisotropy")&&g.anisotropy!==b.data.anisotropy&&(g.anisotropy=b.data.anisotropy);var k=!!b.data.rgbm;b.data.hasOwnProperty("rgbm")&&g.rgbm!==k&&(g.rgbm=k)}b.resource.texture=g;var g={},l;for(l in b.data.frames)k=b.data.frames[l],g[l]={rect:new pc.Vec4(k.rect),pivot:new pc.Vec2(k.pivot),border:new pc.Vec4(k.border)};b.resource.frames=g;b.off("change",this._onAssetChange,this);b.on("change",
        this._onAssetChange,this)},_onAssetChange:function(a,c,e){if("data"===c||"data.frames"===c){var k={},l;for(l in e.frames)c=e.frames[l],k[l]={rect:new pc.Vec4(c.rect),pivot:new pc.Vec2(c.pivot),border:new pc.Vec4(c.border)};a.resource.frames=k}else if(c=c.match(b))l=c[1],e?(a.resource.frames[l]?(c=a.resource.frames[l],c.rect.set(e.rect[0],e.rect[1],e.rect[2],e.rect[3]),c.pivot.set(e.pivot[0],e.pivot[1]),c.border.set(e.border[0],e.border[1],e.border[2],e.border[3])):a.resource.frames[l]={rect:new pc.Vec4(e.rect),
        pivot:new pc.Vec2(e.pivot),border:new pc.Vec4(e.border)},a.resource.fire("set:frame",l,a.resource.frames[l])):a.resource.frames[l]&&(delete a.resource.frames[l],a.resource.fire("remove:frame",l))}};return{TextureAtlasHandler:c}}());pc.extend(pc,function(){var e=function(a,b){this._assets=a;this._device=b},a=function(a){this.resource&&(this.resource.atlas=a.resource)},b=function(a){this.registry.load(a)};e.prototype={load:function(a,b){".json"===pc.path.getExtension(a)&&pc.http.get(a,function(a,c){a?b(a):b(null,c)})},open:function(a,b){var e=new pc.Sprite(this._device);b&&(e.__data=b);return e},patch:function(a,b){var e=a.resource;if(e.__data){a.data.pixelsPerUnit=e.__data.pixelsPerUnit;a.data.renderMode=e.__data.renderMode;
        a.data.frameKeys=e.__data.frameKeys;var g=b.getByUrl(e.__data.textureAtlasAsset);g&&(a.data.textureAtlasAsset=g.id);delete e.__data}e.startUpdate();e.renderMode=a.data.renderMode;e.pixelsPerUnit=a.data.pixelsPerUnit;e.frameKeys=a.data.frameKeys;this._updateAtlas(a);e.endUpdate();a.off("change",this._onAssetChange,this);a.on("change",this._onAssetChange,this)},_updateAtlas:function(c){var d=c.resource;if(c.data.textureAtlasAsset){this._assets.off("load:"+c.data.textureAtlasAsset,a,c);this._assets.on("load:"+
        c.data.textureAtlasAsset,a,c);var e=this._assets.get(c.data.textureAtlasAsset);e&&e.resource?d.atlas=e.resource:e?this._assets.load(e):(this._assets.off("add:"+c.data.textureAtlasAsset,b,c),this._assets.on("add:"+c.data.textureAtlasAsset,b,c))}else d.atlas=null},_onAssetChange:function(c,d,e,g){"data"===d&&e&&e.textureAtlasAsset&&g&&e.textureAtlasAsset!==g.textureAtlasAsset&&(this._assets.off("load:"+g.textureAtlasAsset,a,c),this._assets.off("add:"+g.textureAtlasAsset,b,c))}};return{SpriteHandler:e}}());pc.extend(pc,function(){var e={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},a={int8:pc.TYPE_INT8,uint8:pc.TYPE_UINT8,int16:pc.TYPE_INT16,uint16:pc.TYPE_UINT16,int32:pc.TYPE_INT32,uint32:pc.TYPE_UINT32,float32:pc.TYPE_FLOAT32},b=function(a){this._device=a};b.prototype={parse:function(a){var b=a.model;if(!b)return null;if(1>=b.version)return logERROR(pc.string.format("Trying to parse unsupported model format.")),
        null;var b=this._parseNodes(a),e=this._parseSkins(a,b),g=this._parseMorphs(a,b),k=this._parseVertexBuffers(a),l=this._parseIndexBuffers(a,k),l=this._parseMeshes(a,e.skins,g.morphs,k,l.buffer,l.data);this._initMorphs(a,g.morphs,k,l);a=this._parseMeshInstances(a,b,l,e.skins,e.instances,g.morphs,g.instances);k=new pc.Model;k.graph=b[0];k.meshInstances=a;k.skinInstances=e.instances;k.morphInstances=g.instances;k.getGraph().syncHierarchy();return k},_parseNodes:function(a){a=a.model;var b=[],e;for(e=0;e<
    a.nodes.length;e++){var g=a.nodes[e],k=new pc.GraphNode;k.setName(g.name);k.setLocalPosition(g.position[0],g.position[1],g.position[2]);k.setLocalEulerAngles(g.rotation[0],g.rotation[1],g.rotation[2]);k.setLocalScale(g.scale[0],g.scale[1],g.scale[2]);k.scaleCompensation=!!g.scaleCompensation;b.push(k)}for(e=1;e<a.parents.length;e++)b[a.parents[e]].addChild(b[e]);return b},_parseSkins:function(a,b){var e=a.model,g=[],k=[],l,m;!this._device.supportsBoneTextures&&0<e.skins.length&&(l=this._device.getBoneLimit(),
        pc.partitionSkin(e,null,l));for(l=0;l<e.skins.length;l++){var n=e.skins[l],h=[];for(m=0;m<n.inverseBindMatrices.length;m++){var r=n.inverseBindMatrices[m];h[m]=new pc.Mat4(r[0],r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],r[10],r[11],r[12],r[13],r[14],r[15])}n=new pc.Skin(this._device,h,n.boneNames);g.push(n);h=new pc.SkinInstance(n);r=[];for(m=0;m<n.boneNames.length;m++){var p=b[0].findByName(n.boneNames[m]);r.push(p)}h.bones=r;k.push(h)}return{skins:g,instances:k}},_parseMorphs:function(a,b){var e=
        a.model,g=[],k=[],l,m,n,h,r;if(e.morphs)for(l=0;l<e.morphs.length;l++){n=e.morphs[l].targets;r=[];for(m=0;m<n.length;m++){var p=n[m].aabb;h=p.min;p=p.max;h=new pc.BoundingBox(new pc.Vec3(.5*(p[0]+h[0]),.5*(p[1]+h[1]),.5*(p[2]+h[2])),new pc.Vec3(.5*(p[0]-h[0]),.5*(p[1]-h[1]),.5*(p[2]-h[2])));h=new pc.MorphTarget({indices:n[m].indices,deltaPositions:n[m].deltaPositions,deltaNormals:n[m].deltaNormals,name:n[m].name,aabb:h});r.push(h)}m=new pc.Morph(r);g.push(m);m=new pc.MorphInstance(m);k.push(m)}return{morphs:g,
        instances:k}},_calculateTangentsMorphTarget:function(a,b,e,g,k,l,m,n){var h,r,p,q,t,x,y,w,u,v,z,A,D,B,F,J,G,I,C,E;J=g.length/3;for(E=0;E<J;E++)G=g[3*E],I=g[3*E+1],C=g[3*E+2],y=a[3*G],t=a[3*G+1],x=a[3*G+2],q=a[3*I],w=a[3*I+1],u=a[3*I+2],v=a[3*C],z=a[3*C+1],A=a[3*C+2],D=e[2*G],h=e[2*G+1],B=e[2*I],p=e[2*I+1],F=e[2*C],r=e[2*C+1],q-=y,y=v-y,w-=t,t=z-t,u-=x,x=A-x,B-=D,D=F-D,p-=h,A=r-h,h=B*A-D*p,0==h?(h=0,r=1,p=0,q=1,x=t=0):(F=1/h,h=(A*q-p*y)*F,r=(A*w-p*t)*F,p=(A*u-p*x)*F,q=(B*y-D*q)*F,t=(B*t-D*w)*F,x=(B*
        x-D*u)*F),k[3*G+0]+=h,k[3*G+1]+=r,k[3*G+2]+=p,k[3*I+0]+=h,k[3*I+1]+=r,k[3*I+2]+=p,k[3*C+0]+=h,k[3*C+1]+=r,k[3*C+2]+=p,l[3*G+0]+=q,l[3*G+1]+=t,l[3*G+2]+=x,l[3*I+0]+=q,l[3*I+1]+=t,l[3*I+2]+=x,l[3*C+0]+=q,l[3*C+1]+=t,l[3*C+2]+=x;h=m.length;for(C=0;C<h;C++)E=m[C],u=b[3*E],r=b[3*E+1],w=b[3*E+2],a=k[3*E],e=k[3*E+1],g=k[3*E+2],J=l[3*E],G=l[3*E+1],I=l[3*E+2],x=u*a+r*e+w*g,y=u*x,t=r*x,x*=w,q=r*g-e*w,w=w*a-g*u,u=u*e-a*r,a-=y,e-=t,g-=x,x=1/Math.sqrt(a*a+e*e+g*g),a*=x,e*=x,g*=x,n[4*E]=a,n[4*E+1]=e,n[4*E+2]=g,
        n[4*E+3]=0>q*J+w*G+u*I?-1:1;return n},_initMorphs:function(a,b,e,g){a=a.model;var k,l,m,n,h,r,p,q,t,x,y,w,u,v,z,A=[],D=[];for(e=0;e<g.length;e++)if(t=a.meshes[e].vertices,!D[t]&&(l=a.vertices[t],l.tangent)){var B=new Float32Array(l.tangent.data);D[t]=!0;if(l.position&&l.normal&&l.texCoord0){var F=[];for(k=0;k<a.meshes.length;k++)a.meshes[k].vertices===t&&(F=F.concat(a.meshes[k].indices));t=l.position.data;x=l.normal.data;y=l.texCoord0.data;w=t.length/3;u=F.length;var J=new Float32Array(4*w),G=new Float32Array(3*
        w),I=new Float32Array(3*w);v=new Float32Array(3*w);v.set(t);z=new Float32Array(3*w);z.set(x);for(k=0;k<b.length;k++)if(a.meshes[e].morph===k)for(m=0;m<b[k]._targets.length;m++){l=b[k]._targets[m];var C=l.indices,E=C.length;if(0!==E){l.deltaTangents=new Float32Array(4*E);if(!q||q.length<w)q=new Uint8Array(w);else for(n=0;n<w;n++)q[n]=0;for(n=0;n<E;n++)h=C[n],q[h]=1;var H=0;for(n=0;n<u;n+=3)if(h=F[n],r=F[n+1],p=F[n+2],q[h]||q[r]||q[p])A[H]=h,A[H+1]=r,A[H+2]=p,H+=3;A.length=H;r=l.deltaPositions;p=l.deltaNormals;
        for(n=0;n<E;n++)h=C[n],v[3*h]+=r[3*n],v[3*h+1]+=r[3*n+1],v[3*h+2]+=r[3*n+2],z[3*h]+=p[3*n],z[3*h+1]+=p[3*n+1],z[3*h+2]+=p[3*n+2];this._calculateTangentsMorphTarget(v,z,y,A,G,I,C,J);r=l.deltaTangents;for(n=0;n<E;n++)h=C[n],r[4*n]=J[4*n]-B[4*h],r[4*n+1]=J[4*n+1]-B[4*h+1],r[4*n+2]=J[4*n+2]-B[4*h+2],r[4*n+3]=J[4*n+3]-B[4*h+3];if(m!==b[k]._targets.length-1){for(n=0;n<u;n+=3)h=F[n],r=F[n+1],p=F[n+2],G[3*h+0]=0,G[3*h+1]=0,G[3*h+2]=0,G[3*r+0]=0,G[3*r+1]=0,G[3*r+2]=0,G[3*p+0]=0,G[3*p+1]=0,G[3*p+2]=0,I[3*h+
        0]=0,I[3*h+1]=0,I[3*h+2]=0,I[3*r+0]=0,I[3*r+1]=0,I[3*r+2]=0,I[3*p+0]=0,I[3*p+1]=0,I[3*p+2]=0;for(n=0;n<E;n++)h=l.indices[n],v[3*h]=t[3*h],v[3*h+1]=t[3*h+1],v[3*h+2]=t[3*h+2],z[3*h]=x[3*h],z[3*h+1]=x[3*h+1],z[3*h+2]=x[3*h+2]}}}}}},_parseVertexBuffers:function(b){b=b.model;var d=[],e,g,k={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,
        texCoord1:pc.SEMANTIC_TEXCOORD1,texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7},l,m;for(l=0;l<b.vertices.length;l++){var n=b.vertices[l];if(!n.tangent&&n.position&&n.normal&&n.texCoord0){e=[];for(m=0;m<b.meshes.length;m++)b.meshes[m].vertices===l&&(e=e.concat(b.meshes[m].indices));e=pc.calculateTangents(n.position.data,n.normal.data,n.texCoord0.data,e);n.tangent=
        {type:"float32",components:4,data:e}}m=[];for(g in n){e=n[g];var h=e.type;this._device.supportsUnsignedByte||("uint8"===h&&(h="float32"),"int8"===h&&(h="float32"));m.push({semantic:k[g],components:e.components,type:a[h],normalize:k[g]===pc.SEMANTIC_COLOR})}e=new pc.VertexFormat(this._device,m);var h=n.position.data.length/n.position.components,r=new pc.VertexBuffer(this._device,e,h),p=new pc.VertexIterator(r);for(m=0;m<h;m++){for(g in n)switch(e=n[g],e.components){case 1:p.element[k[g]].set(e.data[m]);
        break;case 2:p.element[k[g]].set(e.data[2*m],e.data[2*m+1]);break;case 3:p.element[k[g]].set(e.data[3*m],e.data[3*m+1],e.data[3*m+2]);break;case 4:p.element[k[g]].set(e.data[4*m],e.data[4*m+1],e.data[4*m+2],e.data[4*m+3])}p.next()}p.end();d.push(r)}return d},_parseIndexBuffers:function(a,b){var e=a.model,g=null,k=null,l,m=0;for(l=0;l<e.meshes.length;l++){var n=e.meshes[l];void 0!==n.indices&&(m+=n.indices.length)}for(l=e=0;l<b.length;l++)e=Math.max(e,b[l].numVertices);0<m&&(65535<e&&this._device.extUintElement?
        (g=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT32,m),k=new Uint32Array(g.lock())):(g=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,m),k=new Uint16Array(g.lock())));return{buffer:g,data:k}},_parseMeshes:function(a,b,f,g,k,l){a=a.model;var m=[],n=0,h;for(h=0;h<a.meshes.length;h++){var r=a.meshes[h],p=r.aabb,q=p.min,p=p.max,q=new pc.BoundingBox(new pc.Vec3(.5*(p[0]+q[0]),.5*(p[1]+q[1]),.5*(p[2]+q[2])),new pc.Vec3(.5*(p[0]-q[0]),.5*(p[1]-q[1]),.5*(p[2]-q[2]))),p=void 0!==r.indices,t=new pc.Mesh;
        t.vertexBuffer=g[r.vertices];t.indexBuffer[0]=p?k:null;t.primitive[0].type=e[r.type];t.primitive[0].base=p?r.base+n:r.base;t.primitive[0].count=r.count;t.primitive[0].indexed=p;t.skin=void 0!==r.skin?b[r.skin]:null;t.morph=void 0!==r.morph?f[r.morph]:null;t.aabb=q;p&&(l.set(r.indices,n),n+=r.indices.length);m.push(t)}null!==k&&k.unlock();return m},_parseMeshInstances:function(a,b,e,g,k,l,m){a=a.model;var n=[],h;for(h=0;h<a.meshInstances.length;h++){var r=a.meshInstances[h],p=e[r.mesh],r=new pc.MeshInstance(b[r.node],
        p,pc.ModelHandler.DEFAULT_MATERIAL);if(p.skin){var q=g.indexOf(p.skin);r.skinInstance=k[q]}p.morph&&(p=l.indexOf(p.morph),r.morphInstance=m[p]);n.push(r)}return n}};return{JsonModelParser:b}}());pc.extend(pc,function(){var e=function(a){this._app=a};e.prototype={parse:function(a){var b={},c,d,e=null;for(c in a.entities)b[c]=this._createEntity(a.entities[c]),null===a.entities[c].parent&&(e=b[c]);for(c in a.entities){var g=a.entities[c].children.length;for(d=0;d<g;d++){var k=a.entities[c].children[d];b[k]&&b[c].addChild(b[k])}}this._openComponentData(e,a.entities);return e},_createEntity:function(a){var b=new pc.Entity,c=a.position,d=a.rotation,e=a.scale;b.name=a.name;b._guid=a.resource_id;
        b.setLocalPosition(c[0],c[1],c[2]);b.setLocalEulerAngles(d[0],d[1],d[2]);b.setLocalScale(e[0],e[1],e[2]);b._enabled=void 0!==a.enabled?a.enabled:!0;b._enabledInHierarchy=b._enabled;b.template=a.template;if(a.tags)for(c=0;c<a.tags.length;c++)b.tags.add(a.tags[c]);a.labels&&a.labels.forEach(function(a){b.addLabel(a)});return b},_openComponentData:function(a,b){var c=this._app.systems.list(),d,e=c.length,g=b[a._guid];for(d=0;d<e;d++){var k=g.components[c[d].id];k&&this._app.systems[c[d].id].addComponent(a,
        k)}c=g.children.length;e=a._children;for(d=0;d<c;d++)e[d]=this._openComponentData(e[d],b);return a}};return{SceneParser:e}}());pc.extend(pc,function(){var e=0,a=/^\s*(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\//i,b=function(a,b,f,g){this._id=++e;this.name=a||"";this.type=b;this.tags=new pc.Tags(this);this._preload=!1;this.variants=new pc.AssetVariants(this);this._file=null;this._data=g||{};this._resources=[];this.loading=this.loaded=!1;this.registry=null;pc.events.attach(this);f&&(this.file=f)};b.prototype={getFileUrl:function(){var b=this.getPreferredFile();if(!b||!b.url)return null;var d=b.url;this.registry&&this.registry.prefix&&!a.test(d)&&
    (d=this.registry.prefix+d);if("script"!==this.type&&b.hash)var e=-1!==d.indexOf("?")?"&":"?",d=d+(e+"t="+b.hash);return d},getPreferredFile:function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type){var a=this.registry._loader.getHandler("texture")._device;if(this.variants.pvr&&a.extCompressedTexturePVRTC)return this.variants.pvr;if(this.variants.dxt&&a.extCompressedTextureS3TC)return this.variants.dxt;if(this.variants.etc1&&a.extCompressedTextureETC1)return this.variants.etc1}return this.file},
        ready:function(a,b){b=b||this;if(this.resource)a.call(b,this);else this.once("load",function(e){a.call(b,e)})},reload:function(){this.loaded&&("cubemap"===this.type?this.registry._loader.patch(this,this.registry):(this.loaded=!1,this.registry.load(this)))},unload:function(){if(this.loaded||this.resource)this.fire("unload",this),this.registry.fire("unload:"+this.id,this),this.resource&&this.resource.destroy&&this.resource.destroy(),this.resource=null,this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),
            this.type)}};Object.defineProperty(b.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a;a>e&&(e=a)}});Object.defineProperty(b.prototype,"file",{get:function(){return this._file},set:function(a){var b;if(!!a!==!!this._file||a&&this._file&&a.hash!==this._file)if(a){this._file||(this._file={});this._file.url=a.url;this._file.filename=a.filename;this._file.hash=a.hash;this._file.size=a.size;this._file.variants=this.variants;if(a.hasOwnProperty("variants")&&(this.variants.clear(),
            a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b]);this.fire("change",this,"file",this._file,this._file);this.reload()}else this._file=null,this.variants.clear();else if(a&&this._file&&a.hasOwnProperty("variants")&&(this.variants.clear(),a.variants))for(b in a.variants)a.variants[b]&&(this.variants[b]=a.variants[b])}});Object.defineProperty(b.prototype,"data",{get:function(){return this._data},set:function(a){var b=this._data;this._data=a;a!==b&&(this.fire("change",this,
        "data",a,b),this.loaded&&this.registry._loader.patch(this,this.registry))}});Object.defineProperty(b.prototype,"resource",{get:function(){return this._resources[0]},set:function(a){var b=this._resources[0];this._resources[0]=a;this.fire("change",this,"resource",a,b)}});Object.defineProperty(b.prototype,"resources",{get:function(){return this._resources},set:function(a){var b=this._resources;this._resources=a;this.fire("change",this,"resources",a,b)}});Object.defineProperty(b.prototype,"preload",{get:function(){return this._preload},
        set:function(a){a=!!a;this._preload!==a&&(this._preload=a)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}});return{Asset:b,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SHADER:"shader",ASSET_CSS:"css",ASSET_HTML:"html",ASSET_SCRIPT:"script",ABSOLUTE_URL:a}}());pc.extend(pc,function(){var e=[],a=function(a){this.asset=a},b=function(b){var d="_"+b;e.push(d);Object.defineProperty(a.prototype,b,{get:function(){return this[d]||null},set:function(a){if(!!this[d]!==!!a||this[d]&&a&&this[d].hash!==a.hash)this[d]=a?{url:a.url,filename:a.filename,size:a.size,hash:a.hash,opt:a.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload())}})};b("dxt");b("pvr");b("etc1");a.prototype.clear=function(){for(var a=
        0;a<e.length;a++)this[e[a]]=null};return{AssetVariants:a}}());pc.extend(pc,function(){var e=function(a){this._loader=a;this._assets=[];this._cache={};this._names={};this._tags=new pc.TagsCache("_id");this._urls={};this.prefix=null;pc.extend(this,pc.events)};e.prototype={list:function(a){a=a||{};return this._assets.filter(function(b){var c=!0;void 0!==a.preload&&(c=b.preload===a.preload);return c})},add:function(a){var b=this._assets.push(a)-1,c;this._cache[a.id]=b;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(b);a.file&&(c=a.file.url,
        this._urls[c]=b);a.registry=this;this._tags.addItem(a);a.tags.on("add",this._onTagAdd,this);a.tags.on("remove",this._onTagRemove,this);this.fire("add",a);this.fire("add:"+a.id,a);c&&this.fire("add:url:"+c,a);a.preload&&this.load(a)},remove:function(a){delete this._cache[a.id];delete this._names[a.name];var b=a.file?a.file.url:null;b&&delete this._urls[b];this._tags.removeItem(a);a.tags.off("add",this._onTagAdd,this);a.tags.off("remove",this._onTagRemove,this);a.fire("remove",a);this.fire("remove",
        a);this.fire("remove:"+a.id,a);b&&this.fire("remove:url:"+b,a)},get:function(a){return this._assets[this._cache[a]]},getByUrl:function(a){return this._assets[this._urls[a]]},load:function(a){if(!a.loading){var b=this;if(a.loaded)"cubemap"===a.type&&b._loader.patch(a,this);else{var c=!!a.file,d=a.getPreferredFile(),e=function(){var c=a.getFileUrl();a.loading=!0;b._loader.load(c,a.type,function(c,e,f){a.loaded=!0;a.loading=!1;c?(b.fire("error",c,a),b.fire("error:"+a.id,c,a),a.fire("error",c,a)):(e instanceof
    Array?a.resources=e:a.resource=e,pc.script.legacy||"script"!==a.type||(c=b._loader.getHandler("script"),c._cache[a.id]&&c._cache[a.id].parentNode===document.head&&document.head.removeChild(c._cache[a.id]),c._cache[a.id]=f),b._loader.patch(a,b),b.fire("load",a),b.fire("load:"+a.id,a),d&&d.url&&b.fire("load:url:"+d.url,a),a.fire("load",a))},a)},g=function(){var c=b._loader.open(a.type,a.data);c instanceof Array?a.resources=c:a.resource=c;a.loaded=!0;b._loader.patch(a,b);b.fire("load",a);b.fire("load:"+
        a.id,a);d&&d.url&&b.fire("load:url:"+d.url,a);a.fire("load",a)};if(d&&"cubemap"===a.type){var c=!1,k=a.getFileUrl();this._loader.load(k,"texture",function(c,d){c?(b.fire("error",c,a),b.fire("error:"+a.id,c,a),a.fire("error",c,a)):(b._loader.patch({resource:d,type:"texture",data:a.data},b),a._dds=d,g())})}d?c&&(this.fire("load:start",a),this.fire("load:"+a.id+":start",a),e()):g()}}},loadFromUrl:function(a,b,c){var d=pc.path.getBasename(a),e={url:a},g={};a=this.getByUrl(a);a||(a=new pc.Asset(d,b,e,
        g),this.add(a));"model"===b?this._loadModel(a,c):(a.once("load",function(a){c(null,a)}),a.once("error",function(a){c(a)}),this.load(a))},_loadModel:function(a,b){var c=this,d=a.getFileUrl(),e=pc.path.getDirectory(d),g=pc.path.getBasename(d),k=function(a){a.once("load",function(a){b(null,a)});a.once("error",function(a){b(a)});c.load(a)};".json"===pc.path.getExtension(d)?(d=pc.path.join(e,g.replace(".json",".mapping.json")),this._loader.load(d,"json",function(b,d){b?(a.data={mapping:[]},k(a)):c._loadMaterials(e,
        d,function(b,c){a.data=d;k(a)})})):k(a)},_loadMaterials:function(a,b,c){var d=this,e,g=b.mapping.length,k=[],l=function(a,b){d._loadTextures(b,function(a,d){c(null,b)})};0===g&&c(null,k);var m=function(a,b){k.push(b);g--;0===g&&l(null,k)};for(e=0;e<b.mapping.length;e++){var n=b.mapping[e].path;n?d.loadFromUrl(pc.path.join(a,n),"material",m):g--}},_loadTextures:function(a,b){var c,d,e={},g=[],k=[],l=0;for(c=0;c<a.length;c++)if(a[c].data.parameters){var m=a[c].data.parameters;for(d=0;d<m.length;d++)if("texture"===
        m[d].type){var n=a[c].getFileUrl(),n=pc.path.getDirectory(n),n=pc.path.join(n,m[d].data);e[n]||(e[n]=!0,g.push(n),l++)}}else console.warn("Update material asset loader to support new material format");if(l)for(d=function(a,c){k.push(c);l--;a&&console.error(a);0===l&&b(null,k)},c=0;c<g.length;c++)this.loadFromUrl(g[c],"texture",d);else b(null,k)},findAll:function(a,b){var c=this,d=this._names[a];return d?(d=d.map(function(a){return c._assets[a]}),b?d.filter(function(a){return a.type===b}):d):[]},_onTagAdd:function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               b){this._tags.add(a,b)},_onTagRemove:function(a,b){this._tags.remove(a,b)},findByTag:function(){return this._tags.find(arguments)},filter:function(a){for(var b=[],c=0,d=this._assets.length;c<d;c++)a(this._assets[c])&&b.push(this._assets[c]);return b},find:function(a,b){var c=this.findAll(a,b);return c?c[0]:null},getAssetById:function(a){console.warn("DEPRECATED: getAssetById() use get() instead");return this.get(a)}};return{AssetRegistry:e}}());Function.prototype.extendsFrom=function(e){var a,b,c=function(){};a=this;b=function(){e.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=e.prototype;c.prototype=e.prototype;b.prototype=new c;return b};pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton};
    pc.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"};pc.audio={AudioManager:pc.SoundManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound};
    pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}};
    pc.extend(pc.gfx,{drawQuadWithShader:pc.drawQuadWithShader,precalculatedTangents:pc.precalculatedTangents,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,
        VertexIterator:pc.VertexIterator});pc.extend(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent});pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue};
    pc.extend(pc.scene,{partitionSkin:pc.partitionSkin,procedural:{calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox},BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,
        Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.StandardMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Projection:{ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE},Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance});pc.shape={Aabb:pc.BoundingBox,Sphere:pc.BoundingSphere,Plane:pc.Plane};pc.time={now:pc.now,Timer:pc.Timer};pc.PhongMaterial=pc.StandardMaterial;pc.BoundingSphere.prototype.intersectRay=pc.BoundingSphere.prototype.intersectsRay;
    pc.ELEMENTTYPE_INT8=pc.TYPE_INT8;pc.ELEMENTTYPE_UINT8=pc.TYPE_UINT8;pc.ELEMENTTYPE_INT16=pc.TYPE_INT16;pc.ELEMENTTYPE_UINT16=pc.TYPE_UINT16;pc.ELEMENTTYPE_INT32=pc.TYPE_INT32;pc.ELEMENTTYPE_UINT32=pc.TYPE_UINT32;pc.ELEMENTTYPE_FLOAT32=pc.TYPE_FLOAT32;Object.defineProperty(pc.shaderChunks,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+pc.shaderChunks.transformVS}});pc.extend(pc.Application.prototype,function(){var e=new pc.GraphNode,a=new pc.GraphNode,b=[],c=!1,d=function(a){this.lineVertexFormat=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32},{semantic:pc.SEMANTIC_COLOR,components:4,type:pc.TYPE_UINT8,normalize:!0}]);this.lineBatches=[];this.layers=[];this.layerToBatch={};this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null;this.identityGraphNode=new pc.GraphNode};d.prototype.addLayer=function(a){0>this.layers.indexOf(a)&&
    this.layers.push(a)};d.prototype.getLayerIdx=function(a){return this.layerToBatch[a.id]};d.prototype.addLayerIdx=function(a,b){this.layerToBatch[b.id]=a};var f=function(){this.numLinesAllocated=128;this.mesh=this.vbRam=this.vb=null;this.linesUsed=0;this.layer=this.meshInstance=this.material=null};f.prototype={init:function(b,c,d,e){this.mesh||(this.mesh=new pc.Mesh,this.mesh.primitive[0].type=pc.PRIMITIVE_LINES,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new pc.BasicMaterial,
        this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=pc.BLEND_NORMAL,this.material.update());for(this.layer=d;this.linesUsed+e>this.numLinesAllocated;)this.vb=null,this.numLinesAllocated*=2;this.vertexFormat=c;this.vb||(this.vb=new pc.VertexBuffer(b,c,2*this.numLinesAllocated,pc.BUFFER_DYNAMIC),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(a.worldTransform=pc.Mat4.IDENTITY,a._dirtyWorld=a._dirtyNormal=!1,this.meshInstance=new pc.MeshInstance(a,
        this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(a,b){for(var c=!!b.length,d=2*this.linesUsed*this.vertexFormat.size,e,f=0;f<a.length;f++)this.vbRam.setFloat32(d,a[f].x,!0),d+=4,this.vbRam.setFloat32(d,a[f].y,!0),d+=4,this.vbRam.setFloat32(d,a[f].z,!0),d+=4,e=c?b[f]:b,this.vbRam.setUint8(d,255*e.r),d+=1,this.vbRam.setUint8(d,255*e.g),d+=1,this.vbRam.setUint8(d,255*e.b),d+=1,this.vbRam.setUint8(d,255*e.a),d+=1;this.linesUsed+=a.length/2},finalize:function(){0<this.linesUsed&&
    (this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,b[0]=this.meshInstance,this.layer.addMeshInstances(b,!0),this.linesUsed=0)}};return{renderMeshInstance:function(a,c){c||(c={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});this._initImmediate();this._immediateData.addLayer(c.layer);b[0]=a;c.layer.addMeshInstances(b,!0)},renderMesh:function(a,c,d,f){f||(f={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});this._initImmediate();e.worldTransform=
        d;e._dirtyWorld=e._dirtyNormal=!1;a=new pc.MeshInstance(e,a,c);a.cull=!1;f.mask&&(a.mask=f.mask);this._immediateData.addLayer(f.layer);b[0]=a;f.layer.addMeshInstances(b,!0)},renderLine:function(a,b,d,e,f){var h=d;e instanceof pc.Color?(h=e,"number"===typeof f?(c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),c=!0),e=f===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),
        depthTest:!0}):e=f):"number"===typeof e?(c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),c=!0),h=d,e=e===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):e=e?e:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0};this._addLines([a,b],[d,h],e)},renderLines:function(a,b,d){d?"number"===typeof d&&(c||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),
        c=!0),d=d===pc.LINEBATCH_OVERLAY?{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!1}:{layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0}):d={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE),depthTest:!0};b.length&&a.length!==b.length?pc.log.error("renderLines: position/color arrays have different lengths"):0!==a.length%2?pc.log.error("renderLines: array length is not divisible by 2"):this._addLines(a,b,d)},renderQuad:function(a,c,d){d||(d={layer:this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE)});
        this._initImmediate();if(!this._immediateData.quadMesh){var f=new pc.VertexFormat(this.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.TYPE_FLOAT32}]),f=new pc.VertexBuffer(this.graphicsDevice,f,4),n=new pc.VertexIterator(f);n.element[pc.SEMANTIC_POSITION].set(-.5,-.5,0);n.next();n.element[pc.SEMANTIC_POSITION].set(.5,-.5,0);n.next();n.element[pc.SEMANTIC_POSITION].set(-.5,.5,0);n.next();n.element[pc.SEMANTIC_POSITION].set(.5,.5,0);n.end();this._immediateData.quadMesh=new pc.Mesh;
            this._immediateData.quadMesh.vertexBuffer=f;this._immediateData.quadMesh.primitive[0].type=pc.PRIMITIVE_TRISTRIP;this._immediateData.quadMesh.primitive[0].base=0;this._immediateData.quadMesh.primitive[0].count=4;this._immediateData.quadMesh.primitive[0].indexed=!1}e.worldTransform=a;e._dirtyWorld=e._dirtyNormal=!1;a=new pc.MeshInstance(e,this._immediateData.quadMesh,c);a.cull=!1;b[0]=a;this._immediateData.addLayer(d.layer);d.layer.addMeshInstances(b,!0)},renderWireCube:function(a,b,c){var d;this._initImmediate();
        this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new pc.Vec3(-.5,-.5,-.5),new pc.Vec3(-.5,.5,-.5),new pc.Vec3(.5,.5,-.5),new pc.Vec3(.5,-.5,-.5),new pc.Vec3(-.5,-.5,.5),new pc.Vec3(-.5,.5,.5),new pc.Vec3(.5,.5,.5),new pc.Vec3(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3,new pc.Vec3]);var e=this._immediateData.cubeLocalPos,f=this._immediateData.cubeWorldPos;for(d=0;8>d;d++)a.transformPoint(e[d],
            f[d]);this.renderLines([f[0],f[1],f[1],f[2],f[2],f[3],f[3],f[0],f[4],f[5],f[5],f[6],f[6],f[7],f[7],f[4],f[0],f[4],f[1],f[5],f[2],f[6],f[3],f[7]],b,c)},_addLines:function(a,b,c){void 0===c.layer&&(c.layer=this.scene.layers.getLayerById(pc.LAYERID_IMMEDIATE));void 0===c.depthTest&&(c.depthTest=!0);this._initImmediate();var d=c.layer;this._immediateData.addLayer(d);var e=this._immediateData.getLayerIdx(d);void 0===e?(e=new f,e.init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/
        2),e.material.depthTest=c.depthTest,c.mask&&(e.meshInstance.mask=c.mask),e=this._immediateData.lineBatches.push(e)-1,this._immediateData.addLayerIdx(e,d)):(this._immediateData.lineBatches[e].init(this.graphicsDevice,this._immediateData.lineVertexFormat,d,a.length/2),this._immediateData.lineBatches[e].material.depthTest=c.depthTest,c.mask&&(this._immediateData.lineBatches[e].meshInstance.mask=c.mask));this._immediateData.lineBatches[e].addLines(a,b)},_initImmediate:function(){this._immediateData||
    (this._immediateData=new d(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_preRenderImmediate:function(){for(var a=0;a<this._immediateData.lineBatches.length;a++)this._immediateData.lineBatches[a]&&this._immediateData.lineBatches[a].finalize()},_postRenderImmediate:function(){for(var a=0;a<this._immediateData.layers.length;a++)this._immediateData.layers[a].clearMeshInstances(!0);this._immediateData.layers.length=0}}}());pc.extend(pc,function(){function e(a,b,c,d){if(a.enabled){var f;if(a.model&&a.model.model&&a.model.enabled&&(d&&d.push(a),a.model.data.lightmapped&&b)){var g=!0,k=a.model.model.meshInstances;for(f=0;f<k.length;f++)if(!k[f].mesh.vertexBuffer.format.hasUv1){g=!1;break}if(g){var l,m=[];for(f=0;f<k.length;f++){l=!1;for(g=0;g<k.length;g++)f!==g&&k[f].mesh===k[g].mesh&&(l=!0);l?(b.push(a),c.push([k[f]])):m.push(k[f])}0<m.length&&(b.push(a),c.push(m))}}for(f=0;f<a._children.length;f++)e(a._children[f],b,
        c,d)}}var a=[],b=[],c,d=new pc.Vec3,f=new pc.BoundingBox,g=new pc.BoundingBox,k={},l=["texture_lightMap","texture_dirLightMap"],m=[],n=function(a,b,c,d,e){this.device=a;this.root=b;this.scene=c;this.renderer=d;this.assets=e};n.prototype={calculateLightmapSize:function(a){var b,c=this.scene.lightmapSizeMultiplier||16,e=1,f=1,g=1,k=1;a.model.asset?(b=this.assets.get(a.model.asset).data,b.area&&(e=b.area.x,f=b.area.y,g=b.area.z,k=b.area.uv)):a.model._area&&(b=a.model,b._area&&(e=b._area.x,f=b._area.y,
        g=b._area.z,k=b._area.uv));b=a.model.lightmapSizeMultiplier||1;e*=b;f*=b;g*=b;d.copy(a.localScale);for(a=a._parent;a;)d.mul(a.localScale),a=a._parent;d.x=Math.abs(d.x);d.y=Math.abs(d.y);d.z=Math.abs(d.z);e=e*d.y*d.z+f*d.x*d.z+g*d.x*d.y;e=Math.sqrt(e/k);return Math.min(pc.math.nextPowerOfTwo(e*c),this.scene.lightmapMaxResolution||2048)},bake:function(h,n){var p,q,t=this.device,x=this.scene,y=1;void 0===n&&(n=pc.BAKE_COLORDIR);n===pc.BAKE_COLORDIR&&(y=2);var w,u=[],v=[];if(h){var z;for(p=b.length-1;0<=
    p;p--)for(q=0;q<h.length;q++)if(b[p]===h[q]){for(z=0;z<a[p].length;z++)a[p][z].destroy();a.splice(p,1);b.splice(p,1)}z=[];for(p=0;p<h.length;p++)e(h[p],z,v);h=z;e(this.root,null,null,u)}else{for(p=0;p<a.length;p++)for(q=0;q<a[p].length;q++)a[p][q].destroy();a=[];b=[];h=[];e(this.root,h,v,u)}if(0===h.length)t.fire("lightmapper:end",{timestamp:pc.now(),target:this});else{z=!1;x._needsStaticPrepare&&(x._needsStaticPrepare=!1,z=!0);var A=[],D=[[],[]],B={},F,J;q=new pc.Texture(this.device,{width:4,height:4,
        format:pc.PIXELFORMAT_R8_G8_B8_A8,rgbm:!0});for(p=0;p<h.length;p++){F=this.calculateLightmapSize(h[p]);A.push(F);for(w=0;w<y;w++)J=new pc.Texture(t,{width:F,height:F,format:pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,rgbm:0===w,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),D[w].push(J);if(!B[F]){var G=new pc.Texture(t,{width:F,height:F,format:pc.PIXELFORMAT_R8_G8_B8_A8,mipmaps:!1,rgbm:!0,minFilter:pc.FILTER_NEAREST,magFilter:pc.FILTER_NEAREST}),G=new pc.RenderTarget(t,G,{depth:!1});B[F]=G}}var I=
        x.layers;I._update();A=[];F=[];var G=[],C=[],E=I._lights;for(p=0;p<E.length;p++)E[p]._enabled&&(J=E[p]._mask,0!==(J&4)&&(F.push(J),G.push(E[p].shadowUpdateMode),E[p]._mask=4294967295,E[p].shadowUpdateMode=E[p]._type===pc.LIGHTTYPE_DIRECTIONAL?pc.SHADOWUPDATE_REALTIME:pc.SHADOWUPDATE_THISFRAME,A.push(E[p]),E[p].isStatic=!1)),C.push(E[p]._enabled),E[p].enabled=!1;var H=pc.shaderChunks,W="#define UV1LAYOUT\n"+H.transformVS,R=H.bakeLmEndPS;J=H.createShaderFromCode(t,H.fullscreenQuadVS,H.dilatePS,"lmDilate");
        var Z=t.scope.resolve("source"),T=t.scope.resolve("pixelOffset"),U=t.scope.resolve("bakeDir"),ea=new pc.Vec2,I=I._meshInstances;for(p=0;p<I.length;p++)I[p].node&&I[p].node.getWorldTransform();var I=x.fog,S=x.ambientLight.data[0],X=x.ambientLight.data[1],aa=x.ambientLight.data[2];x.fog=pc.FOG_NONE;x.ambientLight.data[0]=0;x.ambientLight.data[1]=0;x.ambientLight.data[2]=0;c||(c=new pc.Camera,c._node=new pc.GraphNode,c.clearColor[0]=0,c.clearColor[1]=0,c.clearColor[2]=0,c.clearColor[3]=0,c.clearDepth=
            1,c.clearFlags=pc.CLEARFLAG_COLOR,c.clearStencil=null,c.frustumCulling=!1);var K,M,O,P,ba=[];ba.length=b.length;var L;for(K=0;K<u.length;K++){O=u[K].model.model.meshInstances;L=[];for(p=0;p<O.length;p++)L.push(O[p]._shaderDefs),O[p]._shaderDefs&=~(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM);for(p=0;p<b.length;p++)if(b[p]===u[K]){ba[p]=L;break}}L=[];var V=[],N;for(K=0;K<u.length;K++)if(L[K]=u[K].model.castShadows,u[K].model.castShadows=u[K].model.data.castShadowsLightmap,u[K].model.data.castShadowsLightmap)for(N=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           u[K].model.meshInstances,p=0;p<N.length;p++)N[p].visibleThisFrame=!0,V.push(N[p]);this.renderer.updateCpuSkinMatrices(V);this.renderer.gpuUpdate(V);var fa=[],ca=[];N=[[],[]];var da,ga,Q,ha=[];ha.length=h.length;for(w=0;w<y;w++)m[w]||(p=new pc.StandardMaterial,p.chunks.transformVS=W,0===w?(p.chunks.endPS=R,p.ambient=new pc.Color(0,0,0),p.ambientTint=!0,p.lightMap=q):(p.chunks.basePS=H.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",p.chunks.endPS=H.bakeDirLmEndPS),p.chunks.outputAlphaPS=
            "\n",p.chunks.outputAlphaOpaquePS="\n",p.chunks.outputAlphaPremulPS="\n",p.cull=pc.CULLFACE_NONE,p.forceUv1=!0,p.update(),p.updateShader(t,x),p.name="lmMaterial"+w,m[w]=p);for(K=0;K<h.length;K++){O=v[K];ha[K]=0;if(0<O.length)for(f.copy(O[0].aabb),p=0;p<O.length;p++)O[p].node.getWorldTransform(),f.add(O[p].aabb);p=new pc.BoundingBox;p.copy(f);ca.push(p);for(p=0;p<O.length;p++)P=O[p],P._shaderDefs&=~(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM),P.mask=4,P.deleteParameter("texture_lightMap"),P.deleteParameter("texture_dirLightMap"),
            P.setParameter("texture_lightMap",P.material.lightMap?P.material.lightMap:q),P.setParameter("texture_dirLightMap",q);for(w=0;w<y;w++)M=D[w][K],da=new pc.RenderTarget(t,M,{depth:!1}),N[w].push(da)}for(q=0;q<A.length;q++)A[q].enabled=!1;H=[[],[],[]];W=!1;for(p=0;p<A.length;p++){A[p].enabled=!0;R=!1;A[p]._cacheShadowMap=!0;A[p]._type!==pc.LIGHTTYPE_DIRECTIONAL&&(A[p]._node.getWorldTransform(),A[p].getBoundingSphere(k),g.center=k.center,g.halfExtents.x=k.radius,g.halfExtents.y=k.radius,g.halfExtents.z=
            k.radius);A[p]._type===pc.LIGHTTYPE_SPOT&&(q=A[p],Q=this.renderer.getShadowCamera(t,q),Q._node.setPosition(q._node.getPosition()),Q._node.setRotation(q._node.getRotation()),Q._node.rotateLocal(-90,0,0),Q.projection=pc.PROJECTION_PERSPECTIVE,Q.nearClip=q.attenuationEnd/1E3,Q.farClip=q.attenuationEnd,Q.aspectRatio=1,Q.fov=2*q._outerConeAngle,this.renderer.updateCameraFrustum(Q));0<v.length&&this.renderer.updateShaders(v[0]);for(K=0;K<h.length;K++){O=v[K];f=ca[K];if(A[p]._type===pc.LIGHTTYPE_DIRECTIONAL)d.copy(f.center),
            d.y+=f.halfExtents.y,c._node.setPosition(d),c._node.setEulerAngles(-90,0,0),q=Math.max(f.halfExtents.x,f.halfExtents.z),c.projection=pc.PROJECTION_ORTHOGRAPHIC,c.nearClip=0,c.farClip=2*f.halfExtents.y,c.aspectRatio=1,c.orthoHeight=q;else if(!g.intersects(f))continue;if(A[p]._type===pc.LIGHTTYPE_SPOT){w=!1;for(q=0;q<O.length;q++)if(this.renderer._isVisible(Q,O[q])){w=!0;break}if(!w)continue}A[p]._type===pc.LIGHTTYPE_DIRECTIONAL?(H[pc.LIGHTTYPE_DIRECTIONAL][0]=A[p],H[pc.LIGHTTYPE_POINT].length=0,H[pc.LIGHTTYPE_SPOT].length=
            0,!R&&A[p].castShadows&&(this.renderer.cullDirectionalShadowmap(A[p],V,c,0),this.renderer.renderShadows(H[pc.LIGHTTYPE_DIRECTIONAL],0),R=!0)):(H[pc.LIGHTTYPE_DIRECTIONAL].length=0,A[p]._type===pc.LIGHTTYPE_POINT?(H[pc.LIGHTTYPE_POINT][0]=A[p],H[pc.LIGHTTYPE_SPOT].length=0,!R&&A[p].castShadows&&(this.renderer.cullLocalShadowmap(A[p],V),this.renderer.renderShadows(H[pc.LIGHTTYPE_POINT]),R=!0)):(H[pc.LIGHTTYPE_POINT].length=0,H[pc.LIGHTTYPE_SPOT][0]=A[p],!R&&A[p].castShadows&&(this.renderer.cullLocalShadowmap(A[p],
            V),this.renderer.renderShadows(H[pc.LIGHTTYPE_SPOT]),R=!0)));for(q=0;q<O.length;q++)fa[q]=O[q].material;for(w=0;w<y;w++){M=D[w][K];da=N[w][K];P=B[M.width];ga=P.colorBuffer;0===w?W=x.updateShaders:W&&(x.updateShaders=!0);for(q=0;q<O.length;q++)O[q].material=m[w];1<y&&this.renderer.updateShaders(O);this.renderer.setCamera(c,P,!0);1===w&&U.setValue(A[p].bakeDir?1:0);this.renderer._forwardTime=0;this.renderer._shadowMapTime=0;this.renderer.renderForward(c,O,O.length,H,pc.SHADER_FORWARDHDR);D[w][K]=ga;
            N[w][K]=P;B[M.width]=da;for(q=0;q<O.length;q++)P=O[q],P.setParameter(l[w],ga),P._shaderDefs|=pc.SHADERDEF_LM}ha[K]++;for(q=0;q<O.length;q++)O[q].material=fa[q]}A[p].enabled=!1;A[p]._cacheShadowMap=!1;A[p]._isCachedShadowMap&&A[p]._destroyShadowMap()}for(K=0;K<h.length;K++){O=v[K];Q=[];for(w=0;w<y;w++){M=D[w][K];da=N[w][K];P=B[M.width];ga=P.colorBuffer;ea.set(1/M.width,1/M.height);T.setValue(ea.data);for(p=0;4>p;p++)Z.setValue(M),pc.drawQuadWithShader(t,P,J),Z.setValue(ga),pc.drawQuadWithShader(t,
            da,J);for(p=0;p<O.length;p++)P=O[p],P.mask=2,O[p].setParameter(l[w],M),1===w&&(O[p]._shaderDefs|=pc.SHADERDEF_DIRLM);Q[w]=M;w===y-1&&da.destroy()}a.push(Q);b.push(h[K])}for(var ia in B)B.hasOwnProperty(ia)&&(B[ia].colorBuffer.destroy(),B[ia].destroy());for(p=0;p<a.length;p++)for(q=0;q<a[p].length;q++)J=a[p][q],J.minFilter=pc.FILTER_LINEAR,J.magFilter=pc.FILTER_LINEAR;for(K=0;K<u.length;K++)u[K].model.castShadows=L[K];for(p=0;p<ba.length;p++)if(ba[p])for(O=b[p].model.model.meshInstances,q=0;q<O.length;q++)O[q]._shaderDefs|=
            ba[p][q]&(pc.SHADERDEF_LM|pc.SHADERDEF_DIRLM);for(p=0;p<A.length;p++)A[p]._mask=F[p],A[p].shadowUpdateMode=G[p];for(p=0;p<E.length;p++)E[p].enabled=C[p];x.fog=I;x.ambientLight.data[0]=S;x.ambientLight.data[1]=X;x.ambientLight.data[2]=aa;z&&(x._needsStaticPrepare=!0)}}};return{Lightmapper:n}}());pc.extend(pc,function(){function e(a,b){if(a&&!b||!a&&b)return!1;a=a.data;b=b.data;if(a===b)return!0;if(a instanceof Float32Array&&b instanceof Float32Array){if(a.length!==b.length)return!1;for(var e=0;e<a.length;e++)if(a[e]!==b[e])return!1;return!0}return!1}var a=function(a,b,e){this.device=a;this.rootNode=e;this._dirty=!0;this.bones=b;b=b.length;a.supportsBoneTextures?(b=256<b?64:64<b?32:16<b?16:8,this.boneTexture=new pc.Texture(a,{width:b,height:b,format:pc.PIXELFORMAT_RGBA32F,mipmaps:!1,minFilter:pc.FILTER_NEAREST,
        magFilter:pc.FILTER_NEAREST}),this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*b)};a.prototype={updateMatrices:function(){},updateMatrixPalette:function(){for(var a,b=this.matrixPalette,e,g=this.bones.length-1;0<=g;g--)a=this.bones[g].getWorldTransform().data,e=16*g,b[e]=a[0],b[e+1]=a[1],b[e+2]=a[2],b[e+3]=a[3],b[e+4]=a[4],b[e+5]=a[5],b[e+6]=a[6],b[e+7]=a[7],b[e+8]=a[8],b[e+9]=a[9],b[e+10]=a[10],b[e+11]=a[11],b[e+12]=a[12],b[e+13]=a[13],b[e+14]=a[14],b[e+15]=a[15];
        this.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};var b=function(a,b,e){this.device=a;this.rootNode=b;this.scene=e;this._init=!1;this._batchGroups={};this._batchGroupCounter=0;this._batchList=[];this._dirtyGroups=[]};b.prototype.addGroup=function(a,b,e,g,k){void 0===g&&(g=this._batchGroupCounter,this._batchGroupCounter++);if(!this._batchGroups[g])return this._batchGroups[g]=a=new pc.BatchGroup(g,a,b,e,k)};b.prototype.removeGroup=function(a){if(this._batchGroups[a]){for(var b=
        [],e=0;e<this._batchList.length;e++)this._batchList[e].batchGroupId!==a?b.push(this._batchList[e]):(this._batchList[e].refCounter=1,this.destroy(this._batchList[e]));this._batchList=b;this._removeModelsFromBatchGroup(this.rootNode,a);delete this._batchGroups[a]}};b.prototype._removeModelsFromBatchGroup=function(a,b){if(a.enabled){a.model&&a.model.batchGroupId===b&&(a.model.batchGroupId=-1);a.element&&a.element.batchGroupId===b&&(a.element.batchGroupId=-1);a.sprite&&a.sprite.batchGroupId===b&&(a.sprite.batchGroupId=
        -1);for(var e=0;e<a._children.length;e++)this._removeModelsFromBatchGroup(a._children[e],b)}};b.prototype._collectAndRemoveModels=function(a,b,e){if(a.enabled){var g;if(a.model&&0<=a.model.batchGroupId&&a.model.model&&a.model.enabled&&(!e||e&&0<=e.indexOf(a.model.batchGroupId))){(g=b[a.model.batchGroupId])||(g=b[a.model.batchGroupId]=[]);if(a.model.isStatic){var k=this.scene.drawCalls,l=a.model.meshInstances;for(g=0;g<k.length;g++)k[g]._staticSource&&(0>l.indexOf(k[g]._staticSource)||b[a.model.batchGroupId].push(k[g]));
        for(g=0;g<l.length;g++)0<=k.indexOf(l[g])&&b[a.model.batchGroupId].push(l[g])}else b[a.model.batchGroupId]=g.concat(a.model.meshInstances);a.model.removeModelFromLayers(a.model.model)}a.element&&0<=a.element.batchGroupId&&a.element.enabled&&(!e||e&&0<=e.indexOf(a.element.batchGroupId))&&((g=b[a.element.batchGroupId])||(b[a.element.batchGroupId]=[]),a.element._text?(b[a.element.batchGroupId].push(a.element._text._model.meshInstances[0]),a.element.removeModelFromLayers(a.element._text._model)):a.element._image&&
        (b[a.element.batchGroupId].push(a.element._image._model.meshInstances[0]),a.element.removeModelFromLayers(a.element._image._model)));a.sprite&&0<=a.sprite.batchGroupId&&a.sprite.enabled&&(!e||e&&0<=e.indexOf(a.sprite.batchGroupId))&&((g=b[a.sprite.batchGroupId])||(b[a.sprite.batchGroupId]=[]),a.sprite._meshInstance&&(b[a.sprite.batchGroupId].push(a.sprite._meshInstance),this.scene.removeModel(a.sprite._model),a.sprite._batchGroup=this._batchGroups[a.sprite.batchGroupId]));for(g=0;g<a._children.length;g++)this._collectAndRemoveModels(a._children[g],
        b,e)}};b.prototype._markGroupDirty=function(a){0>this._dirtyGroups.indexOf(a)&&this._dirtyGroups.push(a)};b.prototype._registerEntities=function(a,b){for(var e,g=[],k=0;k<b.length;k++){for(e=b[k].node;!e._app&&e._parent;)e=e._parent;e._app&&g.push(e)}this.register(a,g)};b.prototype.generate=function(a){var b,e,g={};if(a){e=[];for(b=0;b<this._batchList.length;b++)0>a.indexOf(this._batchList[b].batchGroupId)?e.push(this._batchList[b]):(this._batchList[b].refCounter=1,this.destroy(this._batchList[b]));
        this._batchList=e;this._collectAndRemoveModels(this.rootNode,g,a);if(a===this._dirtyGroups)this._dirtyGroups.length=0;else{e=[];for(b=0;b<this._dirtyGroups.length;b++)0>a.indexOf(this._dirtyGroups[b])&&e.push(this._dirtyGroups[b]);this._dirtyGroups=e}}else{for(b=0;b<this._batchList.length;b++)this._batchList[b].refCounter=1,this.destroy(this._batchList[b]);this._batchList.length=0;this._collectAndRemoveModels(this.rootNode,g);this._dirtyGroups.length=0}var k,l,m;for(m in g)if(g.hasOwnProperty(m)&&
        (b=g[m],a=this._batchGroups[m]))for(k=this.prepare(b,a.dynamic,a.maxAabbSize),b=0;b<k.length;b++){l=this.create(k[b],a.dynamic,parseInt(m));for(e=0;e<a.layers.length;e++)this.scene.layers.getLayerById(a.layers[e]).addMeshInstances(l.model.meshInstances);this._registerEntities(l,k[b])}};b.prototype.getGroupByName=function(a){var b=this._batchGroups,e;for(e in b)if(b.hasOwnProperty(e)&&b[e].name===a)return b[e];return null};b.prototype.prepare=function(a,b,f){if(0===a.length)return[];void 0===f&&(f=
        Number.POSITIVE_INFINITY);f*=.5;for(var g=this.device.supportsBoneTextures?1024:this.device.boneLimit,k,l,m,n,h,r,p,q,t,x=new pc.BoundingBox,y=new pc.BoundingBox,w=[],u=0,v=a,z,A;0<v.length;){w[u]=[];z=[];k=v[0].material;l=v[0].layer;t=v[0]._shaderDefs;n=v[0].parameters;q=v[0]._staticLightList;m=v[0].mesh.vertexBuffer.getNumVertices();x.copy(v[0].aabb);for(a=0;a<v.length;a++){if(0<a){if(k!==v[a].material){z.push(v[a]);continue}if(l!==v[a].layer){z.push(v[a]);continue}if(t!==v[a]._shaderDefs){z.push(v[a]);
        continue}if(65535<m+v[a].mesh.vertexBuffer.getNumVertices()){z.push(v[a]);continue}y.copy(x);y.add(v[a].aabb);if(y.halfExtents.x>f||y.halfExtents.y>f||y.halfExtents.z>f){z.push(v[a]);continue}h=v[a].parameters;p=!1;for(r in n)if(n.hasOwnProperty(r)&&!e(n[r],h[r])){p=!0;break}if(!p)for(r in h)if(h.hasOwnProperty(r)&&!e(h[r],n[r])){p=!0;break}if(p){z.push(v[a]);continue}h=v[a]._staticLightList;if(q&&!h||!q&&h){z.push(v[a]);continue}if(q&&h){p=!1;for(A=0;A<q.length;A++)if(0>h.indexOf(q[A])){p=!0;break}for(A=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        0;A<h.length;A++)if(0>q.indexOf(h[A])){p=!0;break}if(p){z.push(v[a]);continue}}}x.add(v[a].aabb);m+=v[a].mesh.vertexBuffer.getNumVertices();w[u].push(v[a]);if(b&&w[u].length===g){z=a===v.length?[]:v.slice(a+1);break}}u++;v=z}return w};b.prototype.create=function(b,d,e){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+pc.shaderChunks.transformVS,this.skinTexVS=pc.shaderChunks.skinBatchTexVS,this.skinConstVS=pc.shaderChunks.skinBatchConstVS,this.vertexFormats=
        {},this._init=!0);var g,k;e=new pc.Batch(b,d,e);this._batchList.push(e);var l=null,m,n,h,r,p,q,t,x,y,w=0,u=0;for(g=0;g<b.length;g++){if(!l)l=b[g].material;else if(l!==b[g].material)return;m=b[g].mesh;n=m.vertexBuffer.format.elements;h=m.vertexBuffer.numVertices;w+=h;for(k=0;k<n.length;k++)n[k].name===pc.SEMANTIC_POSITION?r=!0:n[k].name===pc.SEMANTIC_NORMAL?p=!0:n[k].name===pc.SEMANTIC_TEXCOORD0?q=!0:n[k].name===pc.SEMANTIC_TEXCOORD1?t=!0:n[k].name===pc.SEMANTIC_TANGENT?x=!0:n[k].name===pc.SEMANTIC_COLOR&&
        (y=!0);u+=m.primitive[0].count}if(r){var v=3+(p?3:0)+(q?2:0)+(t?2:0)+(x?4:0)+(y?1:0)+(d?1:0),z=p?6:3,A=(p?6:3)+(q?2:0),D=(p?6:3)+(q?2:0)+(t?2:0),B=(p?6:3)+(q?2:0)+(t?2:0)+(x?4:0),F=(p?6:3)+(q?2:0)+(t?2:0)+(x?4:0)+(y?1:0),J=new ArrayBuffer(w*v*4);r=new Float32Array(J);var G=new Uint8Array(J),J=new pc.IndexBuffer(this.device,pc.INDEXFORMAT_UINT16,u,pc.BUFFER_STATIC),I=new Uint16Array(J.lock()),C,E,H,W=0,R=0;H=0;var Z,T,U,ea,S,X,aa,K,M;d||(K=new pc.Vec3,M=K.data);for(g=0;g<b.length;g++){m=b[g].mesh;
        n=m.vertexBuffer.format.elements;h=m.vertexBuffer.numVertices;k=m.vertexBuffer.format.size;C=k/4;for(k=0;k<n.length;k++)n[k].name===pc.SEMANTIC_POSITION?Z=n[k].offset/4:n[k].name===pc.SEMANTIC_NORMAL?T=n[k].offset/4:n[k].name===pc.SEMANTIC_TEXCOORD0?U=n[k].offset/4:n[k].name===pc.SEMANTIC_TEXCOORD1?ea=n[k].offset/4:n[k].name===pc.SEMANTIC_TANGENT?S=n[k].offset/4:n[k].name===pc.SEMANTIC_COLOR&&(X=n[k].offset/4);n=new Float32Array(m.vertexBuffer.storage);E=new Uint8Array(m.vertexBuffer.storage);if(d)for(k=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0;k<h;k++)r[k*v+H]=n[k*C+Z],r[k*v+H+1]=n[k*C+Z+1],r[k*v+H+2]=n[k*C+Z+2],p&&(r[k*v+H+3]=n[k*C+T],r[k*v+H+3+1]=n[k*C+T+1],r[k*v+H+3+2]=n[k*C+T+2]),q&&(r[k*v+H+z]=n[k*C+U],r[k*v+H+z+1]=n[k*C+U+1]),t&&(r[k*v+H+A]=n[k*C+ea],r[k*v+H+A+1]=n[k*C+ea+1]),x&&(r[k*v+H+D]=n[k*C+S],r[k*v+H+D+1]=n[k*C+S+1],r[k*v+H+D+2]=n[k*C+S+2],r[k*v+H+D+3]=n[k*C+S+3]),y&&(G[k*v*4+4*H+4*B]=E[k*C*4+4*X],G[k*v*4+4*H+4*B+1]=E[k*C*4+4*X+1],G[k*v*4+4*H+4*B+2]=E[k*C*4+4*X+2],G[k*v*4+4*H+4*B+3]=E[k*C*4+4*X+3]),r[k*v+F+H]=g;else for(aa=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                b[g].node.getWorldTransform(),k=0;k<h;k++)K.set(n[k*C+Z],n[k*C+Z+1],n[k*C+Z+2]),aa.transformPoint(K,K),r[k*v+H]=M[0],r[k*v+H+1]=M[1],r[k*v+H+2]=M[2],p&&(K.set(n[k*C+T],n[k*C+T+1],n[k*C+T+2]),aa.transformVector(K,K),r[k*v+H+3]=M[0],r[k*v+H+3+1]=M[1],r[k*v+H+3+2]=M[2]),q&&(r[k*v+H+z]=n[k*C+U],r[k*v+H+z+1]=n[k*C+U+1]),t&&(r[k*v+H+A]=n[k*C+ea],r[k*v+H+A+1]=n[k*C+ea+1]),x&&(K.set(n[k*C+S],n[k*C+S+1],n[k*C+S+2]),aa.transformVector(K,K),r[k*v+H+D]=M[0],r[k*v+H+D+1]=M[1],r[k*v+H+D+2]=M[2],r[k*v+H+D+3]=n[k*
        C+S+3]),y&&(G[k*v*4+4*H+4*B]=E[k*C*4+4*X],G[k*v*4+4*H+4*B+1]=E[k*C*4+4*X+1],G[k*v*4+4*H+4*B+2]=E[k*C*4+4*X+2],G[k*v*4+4*H+4*B+3]=E[k*C*4+4*X+3]);H=m.primitive[0].base;C=m.primitive[0].count;m=new Uint16Array(m.indexBuffer[0].storage);for(k=0;k<C;k++)I[k+R]=m[H+k]+W;R+=C;W+=h;H=W*v}b=0;p&&(b|=2);q&&(b|=4);t&&(b|=8);x&&(b|=16);y&&(b|=32);d&&(b|=64);g=this.vertexFormats[b];g||(g=[],g.push({semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32,normalize:!1}),p&&g.push({semantic:pc.SEMANTIC_NORMAL,
        components:3,type:pc.ELEMENTTYPE_FLOAT32,normalize:!1}),q&&g.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,type:pc.ELEMENTTYPE_FLOAT32,normalize:!1}),t&&g.push({semantic:pc.SEMANTIC_TEXCOORD1,components:2,type:pc.ELEMENTTYPE_FLOAT32,normalize:!1}),x&&g.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.ELEMENTTYPE_FLOAT32,normalize:!1}),y&&g.push({semantic:pc.SEMANTIC_COLOR,components:4,type:pc.ELEMENTTYPE_UINT8,normalize:!0}),d&&g.push({semantic:pc.SEMANTIC_BLENDINDICES,components:1,type:pc.ELEMENTTYPE_FLOAT32,
        normalize:!1}),g=this.vertexFormats[b]=new pc.VertexFormat(this.device,g));p=new pc.VertexBuffer(this.device,g,w,pc.BUFFER_STATIC,r.buffer);J.unlock();m=new pc.Mesh;m.vertexBuffer=p;m.indexBuffer[0]=J;m.primitive[0].type=e.origMeshInstances[0].mesh.primitive[0].type;m.primitive[0].base=0;m.primitive[0].count=u;m.primitive[0].indexed=!0;m.cull=!1;d&&(l=l.clone(),l.chunks.transformVS=this.transformVS,l.chunks.skinTexVS=this.skinTexVS,l.chunks.skinConstVS=this.skinConstVS,l.update());l=new pc.MeshInstance(this.rootNode,
        m,l);l.castShadow=e.origMeshInstances[0].castShadow;l.parameters=e.origMeshInstances[0].parameters;l.isStatic=e.origMeshInstances[0].isStatic;l.cull=e.origMeshInstances[0].cull;l.layer=e.origMeshInstances[0].layer;l._staticLightList=e.origMeshInstances[0]._staticLightList;l._shaderDefs=e.origMeshInstances[0]._shaderDefs;if(d){d=[];for(g=0;g<e.origMeshInstances.length;g++)d.push(e.origMeshInstances[g].node);l.skinInstance=new a(this.device,d,this.rootNode)}l._updateAabb=!1;e.meshInstance=l;this.update(e);
        d=new pc.Model;d.meshInstances=[e.meshInstance];d.castShadows=e.origMeshInstances[0].castShadows;e.model=d;return e}};b.prototype.update=function(a){a._aabb.copy(a.origMeshInstances[0].aabb);for(var b=0;b<a.origMeshInstances.length;b++)0<b&&a._aabb.add(a.origMeshInstances[b].aabb);a.meshInstance.aabb=a._aabb;a._aabb._radiusVer=-1;a.meshInstance._aabbVer=0};b.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var a=0;a<this._batchList.length;a++)this._batchList[a].dynamic&&
    this.update(this._batchList[a])};b.prototype.clone=function(b,d){var e=new pc.Batch(d,b.dynamic,b.batchGroupId);this._batchList.push(e);for(var g=[],k=0;k<d.length;k++)g.push(d[k].node);e.meshInstance=new pc.MeshInstance(b.meshInstance.node,b.meshInstance.mesh,b.meshInstance.material);e.meshInstance._updateAabb=!1;e.meshInstance.parameters=d[0].parameters;e.meshInstance.isStatic=d[0].isStatic;e.meshInstance.cull=d[0].cull;e.meshInstance.layer=d[0].layer;e.meshInstance._staticLightList=d[0]._staticLightList;
        b.dynamic&&(e.meshInstance.skinInstance=new a(this.device,g,this.rootNode));e.meshInstance.castShadow=b.meshInstance.castShadow;e.meshInstance._shader=b.meshInstance._shader;g=new pc.Model;g.meshInstances=[e.meshInstance];g.castShadows=b.origMeshInstances[0].castShadows;e.model=g;return e};b.prototype.destroy=function(a){a.refCounter--;if(0===a.refCounter){for(var b=this._batchGroups[a.batchGroupId].layers,e=0;e<b.length;e++)this.scene.layers.getLayerById(b[e]).removeMeshInstances(a.model.meshInstances);
        a.model.destroy()}};b.prototype.register=function(a,b){a.refCounter=b.length;for(var e=this,g=function(){e.destroy(a)},k=0;k<b.length;k++)b[k].once("destroy",g)};return{Batch:function(a,b,e){this.origMeshInstances=a;this._aabb=new pc.BoundingBox;this.model=this.meshInstance=null;this.dynamic=b;this.batchGroupId=e},BatchGroup:function(a,b,e,g,k){this.dynamic=e;this.maxAabbSize=g;this.id=a;this.name=b;this.layers=void 0===k?[pc.LAYERID_WORLD]:k},BatchManager:b}}());
    return pc;
}));
